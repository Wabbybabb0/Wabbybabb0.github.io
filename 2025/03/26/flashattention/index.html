<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="ã€ç†è®ºã€‘FlashAttentionå­¦ä¹ è¿‡ç¨‹, Wabbybabboçš„æ‘¸é±¼åœ£åœ°">
    <meta name="description" content="ä¸Šç­ï¼Ÿä¸‹ç­ï¼">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>ã€ç†è®ºã€‘FlashAttentionå­¦ä¹ è¿‡ç¨‹ | Wabbybabboçš„æ‘¸é±¼åœ£åœ°</title>
    <link rel="icon" type="image/png" href="/grape200x200.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="Wabbybabboçš„æ‘¸é±¼åœ£åœ°" type="application/atom+xml">
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/grape200x200.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Wabbybabboçš„æ‘¸é±¼åœ£åœ°</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-sharp fa-solid fa-fish" style="zoom: 0.6;"></i>
      
      <span>ä¸»é¡µ</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-soild fa-tags" style="zoom: 0.6;"></i>
      
      <span>æ ‡ç­¾</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>åˆ†ç±»</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>æ¡£æ¡ˆ</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>å…³äº</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="" class="waves-effect waves-light">

      
      <i class="fas fa-list" style="zoom: 0.6;"></i>
      
      <span>åˆ†äº«</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/musics">
          
          <i class="fas fa-music" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>éŸ³ä¹</span>
        </a>
      </li>
      
      <li>
        <a href="/movies">
          
          <i class="fas fa-film" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>ç”µå½±</span>
        </a>
      </li>
      
      <li>
        <a href="/books">
          
          <i class="fas fa-book" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>ä¹¦ç±</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="æœç´¢" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/grape200x200.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Wabbybabboçš„æ‘¸é±¼åœ£åœ°</div>
        <div class="logo-desc">
            
            ä¸Šç­ï¼Ÿä¸‹ç­ï¼
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-sharp fa-solid fa-fish"></i>
			
			ä¸»é¡µ
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-soild fa-tags"></i>
			
			æ ‡ç­¾
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			åˆ†ç±»
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			æ¡£æ¡ˆ
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			å…³äº
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-list"></i>
			
			åˆ†äº«
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="/musics " style="margin-left:75px">
				  
				   <i class="fa fas fa-music" style="position: absolute;left:50px" ></i>
			      
		          <span>éŸ³ä¹</span>
                  </a>
                </li>
              
                <li>

                  <a href="/movies " style="margin-left:75px">
				  
				   <i class="fa fas fa-film" style="position: absolute;left:50px" ></i>
			      
		          <span>ç”µå½±</span>
                  </a>
                </li>
              
                <li>

                  <a href="/books " style="margin-left:75px">
				  
				   <i class="fa fas fa-book" style="position: absolute;left:50px" ></i>
			      
		          <span>ä¹¦ç±</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/Wabbybabb0/Wabbybabb0.github.io" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/Wabbybabb0/Wabbybabb0.github.io" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/4.png')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">ã€ç†è®ºã€‘FlashAttentionå­¦ä¹ è¿‡ç¨‹</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- æ–‡ç« å†…å®¹è¯¦æƒ… -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/LLM/">
                                <span class="chip bg-color">LLM</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E9%AB%98%E6%80%A7%E8%83%BD%E8%AE%A1%E7%AE%97/" class="post-category">
                                é«˜æ€§èƒ½è®¡ç®—
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>å‘å¸ƒæ—¥æœŸ:&nbsp;&nbsp;
                    2025-03-26
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>æ›´æ–°æ—¥æœŸ:&nbsp;&nbsp;
                    2025-05-16
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>æ–‡ç« å­—æ•°:&nbsp;&nbsp;
                    7.5k
                </div>
                

                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>é˜…è¯»æ¬¡æ•°:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- æ˜¯å¦åŠ è½½ä½¿ç”¨è‡ªå¸¦çš„ prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="1-FlashAttention"><a href="#1-FlashAttention" class="headerlink" title="1 FlashAttention"></a>1 FlashAttention</h1><p>Transformersçš„æ ¸å¿ƒSelf-attentionçš„æ—¶é—´å’Œå†…å­˜çš„å¤æ‚åº¦éšç€åºåˆ—$N$å¢é•¿å‘ˆ$N^2$å¢é•¿ï¼Œå¾ˆå¤šAttentionæ¨¡å‹çš„ç›®çš„æ˜¯é™ä½è®¡ç®—å’Œå†…å­˜å¤§å°ï¼Œå³å…³æ³¨FLOPSçš„å‡å°‘å¹¶å¿½è§†äº†å†…å­˜è®¿é—®çš„å¼€é”€ã€‚<br>FlashAttentionä½¿ç”¨<strong>tilling</strong>æ¥å‡å°‘åœ¨GPUæ˜¾å­˜HBMå’ŒGPUç‰‡ä¸ŠSRAMä¹‹é—´çš„å†…å­˜è¯»å†™ï¼›åœ¨backward passæ—¶ï¼Œé€šè¿‡å­˜å‚¨forward passæ—¶softmaxå½’ä¸€åŒ–å¸¸æ•°åœ¨ç‰‡ä¸ŠSRAM <strong>recompute</strong> attentionï¼ŒFLOPSå¢åŠ äº†ï¼Œä½†ç¡®å®å®ç°äº†ç”¨<strong>æ›´å°‘çš„å†…å­˜</strong>å’Œ<strong>è¿è¡Œé€Ÿåº¦å˜å¿«</strong>ã€‚ç›¸æ¯”èµ·ä¼ ç»Ÿattentionå‡å°‘äº†<strong>çº¦9å€</strong>çš„<strong>HBMè¯»å†™</strong>ã€‚<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/FlashAttention/Pasted%20image%2020250326211313.png" alt=""></p>
<h1 id="1-1-å†…å­˜ä½“ç³»"><a href="#1-1-å†…å­˜ä½“ç³»" class="headerlink" title="1.1 å†…å­˜ä½“ç³»"></a>1.1 å†…å­˜ä½“ç³»</h1><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/FlashAttention/Pasted%20image%2020250326173705.png" alt="A100 GPU-40GB|325"></p>
<ul>
<li>SRAMï¼šç‰‡ä¸Šå†…å­˜(ç¼“å­˜)ï¼Œåˆ†å¸ƒåœ¨108ä¸ªSMä¸Šï¼Œæ¯ä¸ªSMä¸Šçš„SRAMå¤§å°ä¸º192Kï¼Œå¤§å°ä¸º20MBï¼Œè¯»å†™é€Ÿåº¦19TB/sï¼Œåº”å°½é‡åœ¨SRAMä¸Šå­˜å‚¨è®¡ç®—ä¸­çš„æ•°æ®ã€‚å…±äº«å†…å­˜(Shared Memory)ç”±SRAMå®ç°ã€‚</li>
<li>HBMï¼šç‰‡ä¸‹å†…å­˜(æ˜¾å­˜)ï¼Œä¸»è¦ç”¨äºå…¨å±€å†…å­˜(Global Memory)ï¼Œå¤§å°ä¸º40GBï¼Œè¯»å†™é€Ÿåº¦1.5TB/sã€‚</li>
</ul>
<h1 id="1-2-ç¡¬ä»¶æ€§èƒ½"><a href="#1-2-ç¡¬ä»¶æ€§èƒ½" class="headerlink" title="1.2 ç¡¬ä»¶æ€§èƒ½"></a>1.2 ç¡¬ä»¶æ€§èƒ½</h1><p>GPUé€šè¿‡kernel(æ ¸å‡½æ•°)æ§åˆ¶çº¿ç¨‹å·¥ä½œï¼Œæ¯ä¸ªæ ¸å‡½æ•°ä»HBMåŠ è½½è¾“å…¥çš„æ•°æ®ï¼Œä¼ åˆ°registerså’ŒSRAMï¼Œåœ¨ç‰‡ä¸Šè®¡ç®—å®Œæ¯•åå°†è¾“å‡ºå†™å›HBMã€‚<br>ä½†æ˜¯éšç€è®¡ç®—ç›¸å¯¹äºå†…å­˜é€Ÿåº¦å˜å¾—è¶Šæ¥è¶Šå¿«ï¼Œå†…å­˜é€Ÿåº¦HBM accessesæˆäº†ç“¶é¢ˆã€‚åœ¨FlashAttentionä¸­ï¼Œä¸­é—´å˜é‡éœ€è¦å†™å›HBMä¿å­˜ï¼Œä»¥ä¾¿åœ¨backward passä¸­ä½¿ç”¨ã€‚<br>æ€§èƒ½é™åˆ¶ï¼š</p>
<ul>
<li>Compute-boundï¼šæ ¸å‡½æ•°è¿è¡Œæ—¶é—´ä¸»è¦ç”±ç®—æ•°è¿ç®—æ¬¡æ•°ä¸»å¯¼ï¼Œå¦‚çŸ©é˜µä¹˜æ³•ï¼Œå·ç§¯</li>
<li>Memory-boundï¼šæ ¸å‡½æ•°è¿è¡Œæ—¶é—´ä¸»è¦ç”±å†…å­˜è®¿é—®æ¬¡æ•°ä¸»å¯¼ï¼Œå¦‚é€å…ƒç´ çš„activationã€dropoutå’Œå½’çº¦çš„sumã€softmaxç­‰ç­‰ã€‚</li>
</ul>
<h1 id="1-3-æ ‡å‡†Attentionæœºåˆ¶"><a href="#1-3-æ ‡å‡†Attentionæœºåˆ¶" class="headerlink" title="1.3 æ ‡å‡†Attentionæœºåˆ¶"></a>1.3 æ ‡å‡†Attentionæœºåˆ¶</h1><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/FlashAttention/Pasted%20image%2020250327092119.png" alt=""><br>$N$ï¼šåºåˆ—é•¿åº¦<br>$d$ï¼šæ¯ä¸ªheadçš„å¤§å°<br>$M$ï¼šSRAMçš„å¤§å°ï¼Œæœ‰$d\leq M\leq Nd$</p>
<ul>
<li>è¯»å–$\textbf{Q}$ã€$\textbf{K}$ã€$\textbf{V}$â†’$O(3Nd)$</li>
<li>è¯»å–$\textbf{S}$ã€$\textbf{P}$æ—¶â†’$O(2N^2)$</li>
<li>HBM accessesâ†’$O(Nd+N^2)$</li>
</ul>
<h2 id="1-4-FlashAttention"><a href="#1-4-FlashAttention" class="headerlink" title="1.4 FlashAttention"></a>1.4 FlashAttention</h2><h3 id="1-4-1-Tiling"><a href="#1-4-1-Tiling" class="headerlink" title="1.4.1 Tiling"></a>1.4.1 Tiling</h3><script type="math/tex; mode=display">softxmax(\{x_1,x_2,...,x_N\})=\dfrac{e^{x_i}}{\sum^N_{j=1}e^{x_j}}</script><ul>
<li>å› ä¸ºsoftmaxéœ€è¦åŒä¸€è¡Œçš„æ‰€æœ‰å€¼æ‰èƒ½è®¡ç®—ï¼Œæ‰€ä»¥$QK^T$ã€softmax()ã€ä¹˜$V$åˆ†åˆ«æ˜¯ä¸‰ä¸ªç‹¬ç«‹çš„ç®—å­ï¼Œå¿…é¡»ç­‰å‰ä¸€ç¯èŠ‚å®Œæˆåæ‰èƒ½è¿›è¡Œä¸‹ä¸€ç¯ã€‚é‚£ä¹ˆè¿™å°±æ¶‰åŠä¸‰æ¬¡è®¿å­˜å’Œå†™å›ã€‚</li>
<li>å¯¹äºå¸¸è§„attentionï¼Œå¿½ç•¥softmaxå’Œ$\sqrt{d_k}$ï¼Œ$QK^T$å¾—åˆ°çš„matrixè¦å†™å›ï¼Œç„¶ååˆè¦è¯»å–å‡ºæ¥ä¸$V$è®¡ç®—ï¼ŒåŒæ—¶$N$æ˜¯ä¸ªæ¯”è¾ƒå¤§çš„å€¼ï¼Œç»™é€Ÿåº¦å’Œæ˜¾å­˜å¸¦æ¥ä¸å°çš„å‹åŠ›ã€‚<ul>
<li>åˆ†å—æ€æƒ³ï¼šå¯ä»¥æŠŠ$qk^T$ tilingä¸€å°å—çš„å€¼ç›´æ¥å’Œ$V$è¿›è¡Œè®¡ç®—ï¼Œä¸éœ€è¦è®¿å­˜å’Œå†™å›ï¼Œç„¶åè¿›è¡Œå¯¹åº”ä½ç½®å€¼ç›¸åŠ ï¼Œå®ç°å°è€Œå¿«çš„æ•ˆæœã€‚ä½†æ˜¯åç»­è¿˜æ˜¯è¦è€ƒè™‘åˆ°softmax(æ¯”è¾ƒé‡è¦)å’Œd</li>
</ul>
</li>
</ul>
<p>naiveSoftmaxâ†’safeSoftmaxâ†’onlineSoftmax</p>
<ul>
<li>nSï¼šå¦‚æœ$QK^T$çš„å€¼è¿‡å¤§ï¼ŒMUFU.EX2å€¼å¯èƒ½ä¼šæº¢å‡ºã€‚ä¸€æ¬¡éå†æ±‚å’Œï¼Œä¸€æ¬¡éå†æ±‚Attentionå€¼ã€‚<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/FlashAttention/Pasted%20image%2020250501220555.png" alt="|167"></li>
<li>sSï¼šè§£å†³æº¢å‡ºé—®é¢˜ï¼Œä½†æ˜¯å¤æ‚åº¦å˜é«˜ï¼Œä¸€æ¬¡éå†æ‰¾æœ€å¤§å€¼ï¼Œä¸€æ¬¡éå†æ±‚å’Œï¼Œä¸€æ¬¡éå†ç¼©æ”¾+æ±‚æœ€å¤§å€¼ï¼Œå³ä¸‰æ¬¡è®¿å­˜ä¸‰æ¬¡å†™å›ã€‚<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/FlashAttention/Pasted%20image%2020250501220615.png" alt="|165"></li>
<li>oSï¼šå°†sSæ±‚å’Œå’Œæ±‚æœ€å¤§å€¼éå†æ”¾åœ¨ä¸€èµ·ï¼Œå˜æˆä¸¤æ¬¡éå†ã€‚é‡ç‚¹æ˜¯ç†è§£ç¬¬äº”è¡Œï¼Œä¸€ç›´åœ¨é’ˆå¯¹å˜åŒ–çš„maxå€¼ç¼©æ”¾ã€‚æœ€åéœ€è¦å¯¹æ¯ä¸ªå€¼å•ç‹¬åšsoftmaxï¼Œæœªå®ç°æ˜¾å­˜ä¸Šä¼˜åŒ–ã€‚<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/FlashAttention/Pasted%20image%2020250501220629.png" alt="|375"><br>ç¬¬å…­è¡Œæ”¹ä¸º$O_{j-1}\dfrac{d_{j-1}}{d_j}e^{m_{j-1}-m_j}+\dfrac{e^{x_j-m_j}}{d_j}V_j$ï¼Œå®ç°è¿­ä»£åœ°æ±‚O</li>
</ul>
<p><strong>Safe Softmaxçš„æå‡ºï¼š</strong><br>å¦‚æœFP16çš„æœ€å¤§è¡¨ç¤ºä¸º$2^{16}$ï¼Œå½“$x_i=12$æ—¶ï¼Œ$e^{12}=162754&gt; 2^{16}=65536$ï¼Œå¯¼è‡´æ•°å€¼æº¢å‡ºã€‚Safe Softmaxä»¤åˆ†å­åˆ†æ¯åŒæ—¶ç¼©æ”¾ï¼Œ$e$çš„å¹‚å°äº0ï¼Œè§£å†³æ•°å€¼æº¢å‡ºé—®é¢˜ã€‚<br>1ï¼‰æ‰¾å‡º$x_1~x_N$ä¸­æœ€å¤§å€¼ï¼Œè®°ä¸º$m$ï¼Œå³$m=max(x_i)$<br>2ï¼‰$softmax(\{x_1,x_2,â€¦, x_M\})=\{\dfrac{\dfrac{e^{x_i}}{e^m}}{\sum^N_{j=1}\dfrac{e^{x_j}}{e^m}}\}^N_{i=1}=\{\dfrac{e^{x_i-m}}{\sum^N_{j=1}e^{x_j-m}}\}^N_{i=1}$<br>ä¹Ÿç§°ä¸ºsoftmaxçš„max-shifting step<br><strong>Softmaxçš„Tilingï¼š</strong></p>
<script type="math/tex; mode=display">\textbf{x}=[x_1,x_2,...,x_{2N}]=[\textbf{x}^{(1)},\textbf{x}^{(2)}]\in\mathbb{R}^{2N}</script><script type="math/tex; mode=display">\textbf{x}^{(1)}=[{x_1,...,x_{N}}],\ \ \ \ \ \textbf{x}^{(2)}=[x_{N+1},...,x_{2N}]</script><script type="math/tex; mode=display">m(\textbf{x}^{(1)})=max(\textbf{x}^{(1)}),\ \ \ \ \ m(\textbf{x}^{(2)})=max(\textbf{x}^{(2)})</script><script type="math/tex; mode=display">f(\textbf{x}^{(1)})=[e^{x_1-m(\textbf{x}^{(1)})},...,e^{x_N-m(\textbf{x}^{(1)})}],\ \ \ \ \ f(\textbf{x}^{(2)})=[e^{x_{N+1}-m(\textbf{x}^{(2)})},...,e^{x_{2N}-m(\textbf{x}^{(2)})}]</script><script type="math/tex; mode=display">\ell(\textbf{x}^{(1)})=\sum^N_{i=1}f(\textbf{x}^{(1)})_i,\ \ \ \ \ \ell(\textbf{x}^{(2)})=\sum^{2N}_{i=N+1}f(\textbf{x}^{(2)})_i</script><ul>
<li>åˆå¹¶åï¼š<script type="math/tex; mode=display">m(\textbf{x})=max(m(\textbf{x}^{(1)}),m(\textbf{x}^{(2)}))</script><script type="math/tex; mode=display">f(\textbf{x})=[e^{m(\textbf{x})-m(\textbf{x}^{(1)})}f(\textbf{x}^{(1)}),e^{m(\textbf{x})-m(\textbf{x}^{(2)})}f(\textbf{x}^{(2)})]</script><script type="math/tex; mode=display">\ell(\textbf{x})=[e^{m(\textbf{x})-m(\textbf{x}^{(1)})}\ell(\textbf{x}^{(1)}),e^{m(\textbf{x})-m(\textbf{x}^{(2)})}\ell(\textbf{x}^{(2)})]</script></li>
<li>ç›¸å½“äºæŠŠ(åˆ†å­)$f(\textbf{x}^{(1)})$ã€$f(\textbf{x}^{(2)})$å’Œ(åˆ†æ¯)$\ell(\textbf{x}^{(1)})$ã€$\ell(\textbf{x}^{(2)})$åˆ†åˆ«éƒ½æŒ‰åŒä¸€ä¸ªæ ‡å‡†ç¼©æ”¾ï¼Œç¼©æ”¾å‰å$softmax$ç»“æœä¸å˜<script type="math/tex; mode=display">softmax(\textbf{x})=\dfrac{f(\textbf{x})}{\ell(\textbf{x})}</script>å†å›åˆ°ä¸‹é¢è¿™å¼ å›¾ï¼š<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/FlashAttention/Pasted%20image%2020250327093712.png" alt=""></li>
<li>å˜é‡ï¼š<ul>
<li>$B_c=\lceil\dfrac{M}{4d}\rceil$ï¼ŒSRAMä¸åˆ‡åˆ†$d$ï¼Œ$4$æ˜¯æŒ‡$\textbf{Q}$ã€$\textbf{K}$ã€$\textbf{V}$ã€$\textbf{O}$å››ä»½</li>
<li>$B_r=min(\lceil\dfrac{M}{4d}\rceil,d)$ï¼ŒSRAMåˆ‡åˆ†$N$ï¼Œç”¨$B_r$æ›¿ä»£$N$ï¼ŒåŒæ—¶é™åˆ¶$\textbf{Q}$å’Œ$\textbf{O}$èŒƒå›´åœ¨$\mathbb{R}^{d\times d}$ä¹‹å†…</li>
<li>$\textbf{Q}$ï¼šè¢«åˆ†æˆ$T_r=\lceil\dfrac{N}{B_r}\rceil$ä¸ªblocks$\textbf{Q}_1,â€¦,\textbf{Q}_{T_r}$ï¼Œæ¯ä¸ªblockå¤§å°ä¸º$\mathbb{R}^{B_r\times d}$ï¼Œ$\textbf{O}$åŒç†</li>
<li>$\textbf{K}$ï¼šè¢«åˆ†æˆ$T_c=\lceil\dfrac{N}{B_c}\rceil$ä¸ªblocks$\textbf{K}_1,â€¦,\textbf{K}_{T_c}$ï¼Œæ¯ä¸ªblockå¤§å°ä¸º$\mathbb{R}^{B_c\times d}$ï¼Œ$\textbf{V}$åŒç†</li>
<li>$\ell$ï¼šè¢«åˆ†æˆ$T_r=\lceil\dfrac{N}{B_r}\rceil$ä¸ªblocks$\ell_1,â€¦\ell_{T_r}$ï¼Œæ¯ä¸ªblockå¤§å°ä¸º$\mathbb{R}^{B_r}$ï¼Œ$m$åŒç†</li>
<li>$\textbf{O}$å’Œ$\ell$çš„å…ƒç´ åˆå§‹åŒ–ä¸º0ï¼Œ$m$åˆå§‹åŒ–ä¸º$-\infty$</li>
</ul>
</li>
<li>å¾ªç¯ï¼š<ul>
<li>å¤–å±‚é¡ºåºè®¡ç®—ç‰¹å¾<ul>
<li>ä»HBMåŠ è½½$\textbf{K}_j$å’Œ$\textbf{V}_j$åˆ°SRAM</li>
</ul>
</li>
<li>å†…å±‚é¡ºåºè®¡ç®—åºåˆ—<ul>
<li>ä»HBMåŠ è½½$\textbf{Q}_i$ã€$\textbf{O}_i$ã€$\ell_{i}$ã€$m_i$åˆ°SRAM</li>
<li>åœ¨ç‰‡ä¸Šè®¡ç®—<ul>
<li>$\textbf{S}_{ij}=\textbf{Q}_i\textbf{K}_j^T\in\mathbb{R}^{B_r\times B_c}$</li>
<li>$\tilde{m}_{ij}=rowmax(\textbf{S}_{ij})\in \mathbb{R}^{B_r}$ï¼Œå–æ¯è¡Œçš„æœ€å¤§å€¼</li>
<li>$\tilde{\textbf{P}}_{ij}=exp(\textbf{S}_{ij}-\tilde{m}_{ij})\in \mathbb{R}^{B_r\times B_c}$ï¼Œåˆ†å­å¤„ç†</li>
<li>$\tilde{\ell}_{ij}=rowsum(\tilde{\textbf{P}}_{ij})\in\mathbb{R}^{B_r}$ï¼Œåˆ†å­æ±‚å’Œå¾—åˆ°åˆ†æ¯<ul>
<li>è¿™ä¸€æ­¥</li>
</ul>
</li>
<li>$\tilde{m}_i^{new}=max(m_i,\tilde{m}_{ij})\in \mathbb{R}^{B_r}$ï¼Œ$m_i$æ˜¯ä¸Šä¸€è½®å¤–å±‚ç‰¹å¾å¯¹åº”çš„rowmaxï¼Œä¸å½“å‰çš„å¯¹æ¯”å–æ–°çš„æœ€å¤§å€¼</li>
<li>$\ell^{new}=e^{m_i-\tilde{m}_i^{new}}\ell_i+e^{m_i-\tilde{m}_i^{new}}\tilde{\ell}_{ij}$ï¼Œ$\ell_i$æ˜¯ä¸Šä¸€è½®å¤–å±‚ç‰¹å¾å¯¹åº”çš„rowsumï¼Œæ›´æ–°$\ell$ä¸å½“å‰$\tilde{m}_i^{new}$å¯¹é½</li>
</ul>
</li>
<li>å†™å›HBMçš„å€¼<ul>
<li>$diag(\ell^{new}_i)^{-1}[diag(\ell^i)e^{m_i-\tilde{m}_i^{new}}\textbf{O}_i+e^{\tilde{m}_{ij}-m_i^{new}}\tilde{\textbf{P}}_{ij}\textbf{V}_j]$è¦†ç›–$\textbf{O}_i$<ul>
<li>æ–°$\textbf{O}_i$çš„rowsumï¼š$diag(\ell^{new}_i)^{-1}$</li>
<li>æ–°$\textbf{O}_i$çš„åˆ†å­ï¼šä¹‹å‰çš„$\textbf{O}_i=\dfrac{åˆ†å­}{diag(\ell^i)}$ï¼Œæ‰€ä»¥å…ˆå¾—åˆ°åˆ†å­ï¼Œå†å¯¹åˆ†å­æŒ‰æ–°çš„æ ‡å‡†ç¼©æ”¾ï¼›å½“å‰$\textbf{K}_j$å’Œ$\textbf{V}_j$</li>
</ul>
</li>
<li>$\ell^{new}_i$è¦†ç›–$\ell_i$</li>
<li>$m_i^{new}$è¦†ç›–$m_i$</li>
</ul>
</li>
</ul>
</li>
<li>æœ€åè¿”å›$\textbf{O}$<br>è¿›è¡ŒForward Passéœ€è€ƒè™‘åˆ°</li>
</ul>
</li>
<li>softmax scalingç³»æ•°$\tau$ï¼Œå¸¸ç”¨çš„$\tau=\dfrac{1}{\sqrt{d}}$ï¼Œ$\textbf{S}=\tau\textbf{Q}\textbf{K}^T$</li>
<li>Maskï¼š$\textbf{S}^{masked}=MASK(\textbf{S})\in\mathbb{R}^{N\times N},\textbf{P}=softmax(\textbf{S}^{masked})$</li>
<li>Drop outï¼š$\textbf{P}^{dropped}=dropout(\textbf{P},\rho_{drop}), \textbf{O}=\textbf{P}^{dropped}\textbf{V}\in\mathbb{R}^{N\times d}$<h3 id="1-4-2-Recomputation"><a href="#1-4-2-Recomputation" class="headerlink" title="1.4.2 Recomputation"></a>1.4.2 Recomputation</h3>backward passéœ€è¦$\textbf{S},\textbf{P}\in\mathbb{R}^{N\times N}$æ¥è®¡ç®—æ¢¯åº¦ï¼ŒFlashAttentionçš„ç›®æ ‡æ˜¯ä¸å­˜å‚¨$O(N^2)$çš„ä¸­é—´å˜é‡ï¼Œé‡‡ç”¨å­˜å‚¨$\textbf{O}$å’Œ$(m,\ell)$æ¥é‡æ–°è®¡ç®—$\textbf{S}$å’Œ$\textbf{P}$ï¼Œè™½ç„¶è®¡ç®—é‡å˜å¤šï¼Œä½†æ˜¯å› ä¸ºHBMè®¿é—®ç¡®å®ä¸‹é™äº†ï¼Œæ‰€ä»¥recomputationæ˜¯åŠ å¿«äº†backward passé€Ÿåº¦çš„ã€‚</li>
</ul>
<h3 id="1-4-3-Block-Sparse-FlashAttention"><a href="#1-4-3-Block-Sparse-FlashAttention" class="headerlink" title="1.4.3 Block-Sparse FlashAttention"></a>1.4.3 Block-Sparse FlashAttention</h3><p>å›¾æº<a target="_blank" rel="noopener" href="http://fancyerii.github.io/2023/10/23/flashattention/">æç†çš„åšå®¢</a><br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/FlashAttention/Pasted%20image%2020250328213926.png" alt=""></p>
<script type="math/tex; mode=display">M\in\{0,1\}^{N/B_r \times N/B_c}</script><script type="math/tex; mode=display">\tilde{M}_{r,c}=M_{ij},\ \ \ \ \  r=\lfloor r/B_r\rfloor, c=\lfloor c/B_c\rfloor</script><script type="math/tex; mode=display">\textbf{P}=softmax(\textbf{S}\cdot\mathbb{1}_{\tilde{M}})</script><p>å¦‚æœ$\tilde{M}_{rc}=1$ï¼Œåˆ™$(\textbf{S}\cdot\mathbb{1}_{\tilde{M}})_{rc}=S_{rc}$<br>å¦‚æœ$\tilde{M}_{rc}=0$ï¼Œåˆ™$(\textbf{S}\cdot\mathbb{1}_{\tilde{M}})_{rc}=-\infty$</p>
<h2 id="1-5-FLOPSå’ŒIOå¤æ‚åº¦æ¯”è¾ƒ"><a href="#1-5-FLOPSå’ŒIOå¤æ‚åº¦æ¯”è¾ƒ" class="headerlink" title="1.5 FLOPSå’ŒIOå¤æ‚åº¦æ¯”è¾ƒ"></a>1.5 FLOPSå’ŒIOå¤æ‚åº¦æ¯”è¾ƒ</h2><h3 id="1-5-1-FLOPSå¤æ‚åº¦"><a href="#1-5-1-FLOPSå¤æ‚åº¦" class="headerlink" title="1.5.1 FLOPSå¤æ‚åº¦"></a>1.5.1 FLOPSå¤æ‚åº¦</h3><ol>
<li>Standard Attention<br>$\textbf{S}=\textbf{Q}\textbf{K}^T\in\mathbb{R}^{N\times N}$ï¼Œéœ€è¦$O(N^2d)$FLOPS<br>$\textbf{O}=\textbf{P}\textbf{V}\in\mathbb{R}^{N\times d}$ï¼Œéœ€è¦$O(N^2d)$FLOPS<br>æ€»å…±FLOPSä¸º<script type="math/tex; mode=display">O(N^2d)</script></li>
<li>FlashAttention<br><strong>Theorem1</strong><br>æ•´ä¸ªè¿‡ç¨‹ï¼Œæœ€åå¾—åˆ°$\textbf{O}$æ‰€éœ€çš„<strong>FLOPS</strong>ä¸º$O(N^2d)$ï¼Œè¯æ˜å¦‚ä¸‹ï¼š</li>
</ol>
<ul>
<li>åœ¨å†…å±‚è®¡ç®—ä¸­ï¼Œ$\textbf{S}_{ij}=\textbf{Q}_i\textbf{K}_j^T\in\mathbb{R}^{B_r\times B_c}$ã€$\textbf{O}_i=\tilde{\textbf{P}}_{ij}\textbf{V}_j\in\mathbb{R}^{B_r\times d}$<ul>
<li>$\textbf{Q}_i\in\mathbb{R}^{B_r\times d}$ã€$\textbf{K}_j\in\mathbb{R}^{B_c\times d}$ï¼Œéœ€è¦$O(B_rB_cd)$FLOPS</li>
<li>$\tilde{\textbf{P}}_{ij}\in\mathbb{R}^{B_r\times B_c}$ã€$\textbf{V}_j\in\mathbb{R}^{B_c\times d}$ï¼Œéœ€è¦$O(B_rB_cd)$FLOPS</li>
<li>å†…å±‚å¾ªç¯äº†$T_cT_r=\lceil\dfrac{N}{B_c}\rceil\lceil\dfrac{N}{B_r}\rceil$æ¬¡ï¼Œå› æ­¤æ€»å…±FLOPSä¸º<script type="math/tex; mode=display">O(\dfrac{N^2}{B_cB_r}B_rB_cd)=O(N^2d)</script></li>
</ul>
</li>
</ul>
<h3 id="1-5-2-IOå¤æ‚åº¦"><a href="#1-5-2-IOå¤æ‚åº¦" class="headerlink" title="1.5.2 IOå¤æ‚åº¦"></a>1.5.2 IOå¤æ‚åº¦</h3><p><strong>Theorem2</strong></p>
<ol>
<li>Standard Attention</li>
</ol>
<ul>
<li>ç¬¬ä¸€æ­¥<ul>
<li>ä»HBMè¯»å–$\textbf{Q}$å’Œ$\textbf{K}$ï¼Œå¤§å°éƒ½ä¸º$N\times d$</li>
<li>è®¡ç®—$\textbf{S}=\textbf{Q}\textbf{K}^T\in\mathbb{R}^{N\times N}$å†™åˆ°HBM</li>
<li>æ˜¾å­˜è®¿é—®$\Theta(Nd+N^2)$</li>
</ul>
</li>
<li>ç¬¬äºŒæ­¥<ul>
<li>è®¡ç®—$\textbf{P}=softmax(\textbf{S})$ï¼Œéœ€è¦ä»HBMè¯»å–$\textbf{S}$å¹¶å°†$\textbf{P}$å†™å…¥åˆ°HBM</li>
<li>æ˜¾å­˜è®¿é—®$\Theta(N^2)$<br>æœ€ç»ˆIOå¤æ‚åº¦ä¸º<script type="math/tex; mode=display">\Theta(Nd+N^2)</script></li>
</ul>
</li>
</ul>
<ol>
<li>FlashAttention</li>
</ol>
<ul>
<li>å¤–å¾ªç¯ï¼š$\textbf{K}_j\in\mathbb{R}^{B_c\times d}$ã€$\textbf{V}_j\in\mathbb{R}^{B_c\times d}$ï¼Œæ¯ä¸ªblockåªåŠ è½½ä¸€æ¬¡ä¸”å¤§å°ä¸º$B_c\times d$ï¼Œæ‰€æœ‰blockä¸€å…±åŠ è½½$T_c$æ¬¡ï¼Œéœ€è¦$\Theta(B_cdT_c)$<ul>
<li>$O(B_cT_c)=N$</li>
<li>æ‰€ä»¥$\Theta(B_cdT_c)$ç›¸å½“äº$O=(Nd)$</li>
</ul>
</li>
<li>å†…å¾ªç¯ï¼š$\textbf{Q}_i\in\mathbb{R}^{B_r\times d}$ã€$\textbf{O}_i\in\mathbb{R}^{B_r\times d}$ï¼Œæ¯ä¸ªblockåŠ è½½$T_c$æ¬¡ï¼Œå¤§å°ä¸º$B_r\times d$ï¼Œæ‰€æœ‰blockä¸€å…±åŠ è½½$T_rT_c$æ¬¡ï¼Œéœ€è¦$\Theta(T_rT_cB_rd)$<ul>
<li>$O(B_rT_r)=N$</li>
<li>æ‰€ä»¥$\Theta(T_rT_cB_rd)$ç›¸å½“äº$O(NT_cd)$<br>ç›®å‰IOå¤æ‚åº¦ä¸º$O(NdT_c)$<br>$B_c=\lceil\dfrac{M}{4d}\rceil$ï¼Œ$T_c=\lceil\dfrac{N}{B_c}\rceil=\lceil\dfrac{4Nd}{M}\rceil$<br>æœ€ç»ˆIOå¤æ‚åº¦ä¸º<script type="math/tex; mode=display">O(\dfrac{N^2d^2}{M})</script>è¿™ä¹Ÿæ˜¯FlashAttentionçš„ç›®æ ‡ï¼Œå°†HBMè®¿é—®å‡å°åˆ°sub-quadraticçº§åˆ«ï¼Œå³IOå¤æ‚åº¦çš„å¢é•¿é€Ÿåº¦å°äº$N^2$ï¼Œå¤§äº$N$ã€‚<br>$d$ä¸€èˆ¬ä¸º64æˆ–128ï¼Œ$M$å¤§çº¦åœ¨100KBï¼Œ$M\gt\gt d^2$ï¼Œ$\dfrac{N^2d^2}{M}&lt;N^2$<br>å› æ­¤ï¼š<script type="math/tex; mode=display">\Theta(Nd+N^2)>O(\dfrac{N^2d^2}{M})</script>è¿™é‡Œæ˜¯Forward Passçš„IOå¤æ‚åº¦ï¼ŒBackward Passçš„IOå¤æ‚åº¦ä¸å‰è€…ç›¸åŒã€‚</li>
</ul>
</li>
</ul>
<ol>
<li>Block-sparse FlashAttention<br>å’ŒFlashAttentionçš„IOå¤æ‚åº¦çš„è®¡ç®—è¿‡ç¨‹æ¯”è¾ƒåƒï¼Œä¸åŒçš„åœ°æ–¹æ˜¯ï¼ŒBlock-sparse FlashAttentionåªéœ€è¦åŠ è½½éé›¶çš„blocksï¼Œå‡è®¾éé›¶blocksçš„æ¯”ä¾‹ä¸º$s$ï¼Œé‚£ä¹ˆHBM accesseså°±ä¼šè¢«ç¼©å°åˆ°$s$å€ï¼›â€œHowever, for small values of $s$, we would still need to write the result O âˆˆ R ğ‘ Ã—ğ‘‘ .ï¼Œéœ€è¦å°†ç»“æœ$\textbf{O}\in\mathbb{R}^{N\times d}$å†™åˆ°HBMé‡Œâ€ï¼Œéœ€è¦çš„ç©ºé—´å¤æ‚åº¦ä¸ºï¼š<script type="math/tex; mode=display">\Theta(Nd+\dfrac{N^2d^2}{M}s)</script><h2 id="1-6-é¢å¤–å†…å­˜"><a href="#1-6-é¢å¤–å†…å­˜" class="headerlink" title="1.6 é¢å¤–å†…å­˜"></a>1.6 é¢å¤–å†…å­˜</h2><h3 id="1-6-1-Forward-Pass"><a href="#1-6-1-Forward-Pass" class="headerlink" title="1.6.1 Forward Pass"></a>1.6.1 Forward Pass</h3>ä¸ºäº†ç®€å•èµ·è§ï¼Œçœç•¥äº†softmaxæ—¶çš„max-shiftingæ­¥éª¤<br>åœ¨è®¡ç®—å¾—åˆ°$\textbf{O}\in\mathbb{R}^{N\times d}$æ—¶<script type="math/tex">\textbf{Q},\textbf{K},\textbf{V}\in\mathbb{R}^{N\times d}$$$$\textbf{S}=\textbf{Q}\textbf{K}^T\in\mathbb{R}^{N\times N},\textbf{P}=softmax(\textbf{S})\in\mathbb{R}^{N\times N},\textbf{O}=\textbf{P}\textbf{V}\in\mathbb{R}^{N\times d}</script><br>$S_{ij}=q_ik_j^T$ï¼Œ$q_i$å’Œ$k_j$åˆ†åˆ«æ˜¯$\textbf{Q}$å’Œ$\textbf{K}$çš„ç¬¬$i$è¡Œå’Œç¬¬$j$è¡Œï¼Œå®šä¹‰ä»–ä»¬çš„softmax normalizationå¸¸æ•°ä¸ºï¼š<script type="math/tex; mode=display">L_i=\sum_j^Ne^{q_ik_j^T}</script></li>
</ol>
<ul>
<li>å¯¹äºå…¶ä¸­ä¸€ä¸ª$L_i$æ¥è¯´ï¼Œåªæ¶‰åŠ$N$ä¸ªæ•°æ±‚å’Œï¼Œè®¡ç®—$L_i$æ‰€éœ€è¦çš„é¢å¤–å†…å­˜çš„ç©ºé—´å¤æ‚åº¦ä¸ºï¼š$O(N)$ï¼Œé€šä¿—ç†è§£å°±æ˜¯$1$ä¸ªtokenå¯¹$N$ä¸ªtoken<br>$v_j$æ˜¯$\textbf{V}$çš„ç¬¬$j$è¡Œï¼Œå¯¹äºæ³¨æ„åŠ›çŸ©é˜µç¬¬$i$è¡Œçš„è¾“å‡ºï¼Œæœ‰<script type="math/tex; mode=display">o_i=P_{i:}\textbf{V}=\sum_jP_{ij}v_j=\sum_j\dfrac{e^{q_ik_j^T}}{L_i}v_j</script></li>
<li>$o_i$æ˜¯ç¬¬$i$ä¸ªtokençš„æ³¨æ„åŠ›è¾“å‡ºï¼Œ$P_{i:}\in\mathbb{R}^{1\times N}$æ˜¯ç¬¬$i$ä¸ªtokenå¯¹æ‰€æœ‰å…¶ä»–tokençš„softmaxåçš„å€¼ï¼Œè®¡ç®—$o_i$æ‰€éœ€è¦çš„é¢å¤–å†…å­˜çš„ç©ºé—´å¤æ‚åº¦ä¸ºï¼š$O(d)$ï¼Œé€šä¿—ç†è§£å°±æ˜¯$1$ä¸ªtokençš„å…¨éƒ¨ç‰¹å¾ç»´åº¦$d$<br>æ‰€ä»¥forward passéœ€è¦çš„é¢å¤–å†…å­˜çš„ç©ºé—´å¤æ‚åº¦ä¸ºï¼š<script type="math/tex; mode=display">O(N)</script>é™¤äº†è¾“å…¥è¾“å‡ºä¹‹å¤–ï¼Œè¿˜éœ€è¦$O(N)$å¤§å°çš„ç©ºé—´å­˜å‚¨$(\ell,m)$ã€‚<h3 id="1-6-2-Backward-Pass"><a href="#1-6-2-Backward-Pass" class="headerlink" title="1.6.2 Backward Pass"></a>1.6.2 Backward Pass</h3>B.2ä»å…¬å¼(3)åé¢çš„å…¬å¼å°±å¼€å§‹çœ‹ä¸æ‡‚äº†TvTâ€¦ç­‰ä¹‹åå†æ¥çœ‹çœ‹å§</li>
</ul>
<h2 id="1-7-å…¶ä»–è§‚ç‚¹"><a href="#1-7-å…¶ä»–è§‚ç‚¹" class="headerlink" title="1.7 å…¶ä»–è§‚ç‚¹"></a>1.7 å…¶ä»–è§‚ç‚¹</h2><p><strong>Proposition3</strong><br>ä¸å­˜åœ¨ä¸€ç§ç®—æ³•èƒ½åœ¨æ»¡è¶³$d\leq M\leq Nd$çš„æƒ…å†µä¸‹ï¼Œä»¥$O(N^2d^2M^{-1})$æ¬¡HBM accessesæ¥è®¡ç®—ç²¾ç¡®æ³¨æ„åŠ›ï¼Œè¯æ˜è¿‡ç¨‹å¦‚ä¸‹ï¼š<br>å¦‚æœå­˜åœ¨$O(\dfrac{N^2d^2}{M})$ï¼Œå½“$M=\Theta(Nd)$æ—¶ï¼ŒHBM accessesä¸º$O(\dfrac{N^2d^2}{Nd})=O(Nd)$ï¼Œè€ŒåŠ è½½$\textbf{Q},\textbf{K},\textbf{V},\textbf{O}$æ—¶ï¼Œä»–ä»¬çš„å¤§å°éƒ½æ˜¯$Nd$ï¼Œæ‰€ä»¥å¦‚æœè¦ç²¾ç¡®æ³¨æ„åŠ›çš„HBM accessesï¼Œé‚£ä¹ˆè‡³å°‘éœ€è¦$\Omega(Nd)$HBM accessesï¼Œä¸å‡è®¾ç›¸åã€‚</p>
<h2 id="1-8-å®éªŒç»“æœ"><a href="#1-8-å®éªŒç»“æœ" class="headerlink" title="1.8 å®éªŒç»“æœ"></a>1.8 å®éªŒç»“æœ</h2><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/FlashAttention/Pasted%20image%2020250401155155.png" alt=""></p>
<h1 id="2-FlashAttention2"><a href="#2-FlashAttention2" class="headerlink" title="2 FlashAttention2"></a>2 FlashAttention2</h1><p>å¼•ç”¨<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/17533058076">è¿™é‡Œ</a>ï¼šFlashAttention2æ ¸å¿ƒæ€è·¯æ˜¯å°½å¯èƒ½å‡å°‘è·¨ä¸åŒå­˜å‚¨å±‚çº§ï¼ˆMemory hierarchyï¼‰çš„æ•°æ®è¯»å†™ã€‚ç€é‡äºå‡å°‘GMEM(å¯¹$\textbf{O}$çš„å¤„ç†)å’ŒSMEM(è§2.3)ä¹‹é—´ç›¸äº’ä¼ è¾“çš„æ•°æ®é‡ã€‚<br>FlashAttentionæ¯”æ ‡å‡†attentionçš„æ‰§è¡Œé€Ÿåº¦å¿«äº†2-4å€ï¼Œä½†æ˜¯forward passåªç”¨äº†è®¾å¤‡çš„30%-50%çš„ç†è®ºå³°å€¼FLOPs/s(è§Figure 6)ï¼Œbackward passåªç”¨äº†è®¾å¤‡çš„25%-35%ç†è®ºå³°å€¼FLOPs/s(è§Figure 7)ã€‚<br>ç›¸æ¯”äºFlashAttentionï¼ŒFlashAttention2æœ‰æ›´å¥½çš„å¹¶è¡Œå’Œä»»åŠ¡åˆ†é…æœºåˆ¶ï¼Œé€Ÿåº¦æå‡äº†ä¸¤å€ï¼Œåœ¨forward passå’Œbackward passåˆ†åˆ«è¾¾åˆ°äº†73%å’Œ63%çš„ç†è®ºå³°å€¼ã€‚<br>ç›¸æ¯”äºFasterTransformerï¼ŒFlashAttention2çš„attentionå†…æ ¸å¿«äº†7å€ã€‚<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/FlashAttention/Pasted%20image%2020250401165725.png" alt=""><br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/FlashAttention/Pasted%20image%2020250401170653.png" alt=""><br>ç›¸åº”æ”¹è¿›å¦‚ä¸‹ï¼š</p>
<ul>
<li>è°ƒæ•´ç®—æ³•ï¼Œåœ¨ä¸æ”¹å˜è¾“å‡ºçš„å‰æä¸‹ï¼Œå‡å°‘non-matmul(éçŸ©é˜µä¹˜æ³•) FLOPsã€‚<ul>
<li>è™½ç„¶non-matmulåªå æ€»FLOPsçš„ä¸€å°éƒ¨åˆ†ï¼Œä½†æ˜¯ä»–ä»¬ç›¸æ¯”äºmatmuléœ€è¦æ›´é•¿çš„æ—¶é—´(å› ä¸ºmatmulæœ‰GPUä¸“é—¨çš„è®¡ç®—units)</li>
</ul>
</li>
<li>åœ¨sequence lenghtç»´åº¦å¹¶è¡Œforward passå’Œbackward passï¼Œæé«˜GPUèµ„æºçš„ä½¿ç”¨</li>
<li>å¯¹ä¸€ä¸ªçº¿ç¨‹å—çš„ä¸åŒwarpsè¿›è¡Œåˆ†å·¥ï¼Œå‡å°‘é€šä¿¡å’Œå…±äº«å†…å­˜çš„è¯»å†™ã€‚<h2 id="2-1-ç®—æ³•æ”¹è¿›"><a href="#2-1-ç®—æ³•æ”¹è¿›" class="headerlink" title="2.1 ç®—æ³•æ”¹è¿›"></a>2.1 ç®—æ³•æ”¹è¿›</h2>FlashAttentionä¸­ï¼Œæ¯æ¬¡è¾“å‡ºæ€»æ˜¯éœ€è¦ç”¨$diag(\ell^{(current)})^{(-1)}$æ¥rescaleï¼Œ<script type="math/tex; mode=display">\textbf{O}^{(2)}=diag(\ell^{(1)}/\ell^{(2)})\textbf{O}^{(1)}+diag(\ell^{(2)})^{-1}e^{\textbf{S}^{(2)}-m^{(2)}}\textbf{V}^{(2)}</script>FlashAttention2ä¸­ï¼Œåˆ†åˆ«æ›´æ–°å½“å‰çš„$\ell^{(new)}$(å³softmaxçš„åˆ†æ¯éƒ¨åˆ†)å’Œsoftmaxçš„åˆ†å­éƒ¨åˆ†ä¹˜ä»¥$\textbf{V}^{(current)}$çš„å€¼ï¼š<script type="math/tex; mode=display">\tilde{\textbf{O}}^{(2)}=diag(\ell^{(1)})^{(-1)}\textbf{O}^{(1)}+e^{\textbf{S}^{(2)}-m^{(2)}}\textbf{V}^{(2)}</script>åŒæ—¶ï¼Œå¯¹äºbackward passï¼Œç”¨å­˜å‚¨$L$ä»£æ›¿å­˜å‚¨$m$å’Œ$\ell$<script type="math/tex; mode=display">L_i=m_i^{(T_c)}+\ell^{(T_c)}</script><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/FlashAttention/Pasted%20image%2020250401214948.png" alt="FlashAttentionè®¡ç®—æµç¨‹(åªæœ‰ä¸¤ä¸ªblocks)"><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/FlashAttention/Pasted%20image%2020250401215056.png" alt="FlashAttentionè®¡ç®—æµç¨‹(åªæœ‰ä¸¤ä¸ªblocks)"><br>ï¼ˆFlashAttention2çš„$\tilde{\textbf{P}}^{(2)}=diag(\ell^{(2)})^{-1}e^{\textbf{S}^{(2)}-m^{(2)}}$æœ‰ç‚¹å¥‡æ€ªï¼Œåº”è¯¥æ˜¯$\tilde{\textbf{P}}^{(2)}=e^{\textbf{S}^{(2)}-m^{(2)}}$å§ï¼Œæœ€åå†é™¤ä»¥æœ€æ–°çš„$\ell$ï¼‰<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/FlashAttention/Pasted%20image%2020250401215800.png" alt=""></li>
<li>å˜é‡å°‘äº†$m$å’Œ$\ell$å¹¶æ–°å¢äº†ä¸€ä¸ª$L$<ul>
<li>$L$ï¼šè¢«åˆ†æˆ$T_r=\lceil\dfrac{N}{B_r}\rceil$ä¸ªblocks$\ell_1,â€¦\ell_{T_r}$ï¼Œæ¯ä¸ªblockå¤§å°ä¸º$\mathbb{R}^{B_r}$</li>
<li>$L^{(j)}=m^{(j)}+log(\ell^{(j)})$ï¼Œç”¨äºbackward passä½¿ç”¨</li>
</ul>
</li>
<li>å¾ªç¯ï¼š<ul>
<li>å¤–å±‚é¡ºåºè®¡ç®—åºåˆ—<ul>
<li>ä»HBMåŠ è½½$\textbf{Q}_i$åˆ°SRAM</li>
<li>åœ¨SRAMä¸Šåˆå§‹åŒ–$\textbf{Q}_i$ã€$\ell_i$ã€$m_i$</li>
<li>å†…å±‚é¡ºåºè®¡ç®—ç‰¹å¾<ul>
<li>ä»HBMåŠ è½½$\textbf{K}_j$ã€$\textbf{V}_j$åˆ°SRAMä¸Š</li>
<li>åœ¨ç‰‡ä¸Šè®¡ç®—<ul>
<li>$\textbf{S}_{ij}=\textbf{Q}_i\textbf{K}_j^T\in\mathbb{R}^{B_r\times B_c}$</li>
<li>${m}_i^{(j)}=max(m_i^{(j-1)},rowmax(\textbf{S}_i^{(j)})\in \mathbb{R}^{B_r}$ï¼Œå–å½“å‰åºåˆ—ä¸Šä¸€ä¸ªç‰¹å¾çš„æœ€å¤§å€¼å’Œå½“å‰ç‰¹å¾ä¹‹é—´çš„æœ€å¤§å€¼ä½œä¸ºæœ€å¤§å€¼</li>
<li>$\tilde{\textbf{P}}_i^{(j)}=exp(\textbf{S}_i^{(j)}-\tilde{m}_i^{(j)})\in \mathbb{R}^{B_r\times B_c}$ï¼Œåˆ†å­å¤„ç†<ul>
<li>$\ell_i^{(j)}=e^{m_i^{(j-1)}-m_i^{(j)}}\ell_i^{(j-1)}+rowsum(\tilde{\textbf{P}}_i^{(j)})\in\mathbb{R}^{B_r}$ï¼Œä¿®æ”¹ä¸Šä¸€ä¸ªç‰¹å¾çš„åˆ†å­æ±‚å’Œå€¼å¹¶åŠ ä¸Šå½“å‰ç‰¹å¾çš„æ±‚å’Œå€¼ä½œä¸ºåˆ†æ¯</li>
</ul>
</li>
<li>$\textbf{O}_i^{(j)}=diag(e^{m_i^{(j-1)}-m_i^{(j)}})\textbf{O}_i^{(j-1)}+\tilde{\textbf{P}}_i^{(j)}\textbf{V}_j$ï¼Œè¿™ä¸ªåªæ˜¯å½“å‰åºåˆ—å¯¹å½“å‰åŠä¹‹å‰çš„ã€ç»è¿‡softmaxä½†æ˜¯æœªç»è¿‡å½’ä¸€åŒ–çš„â€attentionâ€å€¼</li>
</ul>
</li>
</ul>
</li>
<li>ï¼ˆå†…å±‚å¾ªç¯å®Œä¹‹åï¼Œä¹Ÿå°±æ˜¯å½“å‰åºåˆ—çš„attentionå·²ç»æœ‰ä¸ªå¤§æ¦‚çš„å€¼äº†ï¼Œä½†æ˜¯ä¸æ˜¯æœ€åçš„å€¼ï¼Œå› ä¸ºè¿˜æ²¡æœ‰å½’ä¸€åŒ–ï¼‰</li>
<li>åœ¨ç‰‡ä¸Šè®¡ç®—$\textbf{O}_i=diag(\ell^{(T_c)})^{(-1)}\textbf{O}_i^{T_c}$ã€$L_i=m_i^{(T_c)}+\ell^{(T_c)}$</li>
<li>å°†$\textbf{O}_i$å’Œ$L_i$å†™å›HBM</li>
</ul>
</li>
<li>æœ€åè¿”å›$\textbf{O}$å’Œ$L$<h3 id="2-1-1-Causal-masking"><a href="#2-1-1-Causal-masking" class="headerlink" title="2.1.1 Causal masking"></a>2.1.1 Causal masking</h3><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/FlashAttention/499eeaa62e60dc4d9f3967c9a054fa1.jpg" alt="åº”ç”¨åœ¨attention matrix **S**ä¸Šçš„casual mask|350"><br>å› ä¸ºåˆ†å—æ€æƒ³ï¼Œ<mark style="background: #BBFABBA6;">å¯¹äºå—å†…æ‰€æœ‰çš„åˆ—ç´¢å¼•éƒ½å¤§äºè¡Œç´¢å¼•çš„ï¼Œå¯ä»¥ç›´æ¥è·³è¿‡è¿™äº›å—çš„attentionè®¡ç®—</mark>ï¼Œ<mark style="background: #ADCCFFA6;">é‚£ä¹ˆæ¯è¡Œ(æŒ‡å—çš„ç´¢å¼•)åªéœ€è¦æœ‰ä¸€ä¸ªå—æ˜¯éœ€è¦åšcasual maskçš„(å‡è®¾æ¯ä¸ªå—éƒ½æ˜¯æ­£æ–¹å½¢)</mark>ã€‚<br>ä¸ºä»€ä¹ˆå¯ä»¥è‚¯å®šå—å†…çš„åˆ—ç´¢å¼•éƒ½å¤§äºè¡Œç´¢å¼•å‘¢ï¼Œå› ä¸º<script type="math/tex; mode=display">B_c=\lceil\dfrac{M}{4d}\rceil,\ \ \ \ \ B_r=min(\lceil\dfrac{M}{4d}\rceil,d)</script>ä»ä¸Šé¢çš„å…¬å¼å¯ä»¥ä¿è¯æ¯ä¸€ä¸ªblockçš„åºåˆ—ä¸ªæ•°å°äºç­‰äºç‰¹å¾ä¸ªæ•°ï¼Œä¹Ÿå°±æ˜¯è¡Œç´¢å¼•å°äºç­‰äºåˆ—ç´¢å¼•ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ç”¨å—çš„ç´¢å¼•æ¥ä»£æ›¿åŸæœ¬çš„ç´¢å¼•ã€‚<h3 id="2-1-2-è®¡ç®—é‡å’Œå†…å­˜"><a href="#2-1-2-è®¡ç®—é‡å’Œå†…å­˜" class="headerlink" title="2.1.2 è®¡ç®—é‡å’Œå†…å­˜"></a>2.1.2 è®¡ç®—é‡å’Œå†…å­˜</h3></li>
</ul>
</li>
<li>å’ŒFlashAttentionä¸€æ ·ï¼Œéœ€è¦$O(N^2d)$FLOPS</li>
<li>é™¤äº†è¾“å…¥è¾“å‡ºä¹‹å¤–ï¼Œéœ€è¦é¢å¤–å†…å­˜çš„ç©ºé—´å¤æ‚åº¦ä¸º$O(N)$æ¥å­˜å‚¨$L$</li>
</ul>
<h2 id="2-2-å¹¶è¡Œ"><a href="#2-2-å¹¶è¡Œ" class="headerlink" title="2.2 å¹¶è¡Œ"></a>2.2 å¹¶è¡Œ</h2><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/FlashAttention/41e11e1bdd91ae13c3bfc3fde26fcfa.jpg" alt="SMå’ŒBlockçš„å…³ç³»|350"><br>ç”¨ä¸€ä¸ªçº¿ç¨‹å—æ¥å¤„ç†ä¸€ä¸ªattention headï¼Œå› æ­¤ä¸€å…±æœ‰<code>batch size Ã— number of heads</code>ä¸ªçº¿ç¨‹å—ï¼Œæ¯ä¸ªçº¿ç¨‹å—è¢«å®‰æ’åœ¨SMä¸Šè¿è¡Œã€‚<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/FlashAttention/Pasted%20image%2020250401225054.png" alt="Forward passå’ŒBackward passä¸­çº¿ç¨‹å—çš„å¹¶è¡Œ"><br>Forward Passï¼šå¹¶è¡Œåºåˆ—é•¿åº¦(å³å¤–å±‚å¾ªç¯)ã€batchç»´åº¦ã€headç»´åº¦</p>
<ul>
<li>å¯¹äºattention matrixï¼Œæ¯ä¸€è¡Œblockä½¿ç”¨åŒä¸€ä¸ªçº¿ç¨‹å—æ¥è®¡ç®—ï¼Œå› ä¸ºæ¯ä¸ªåºåˆ—ä¹‹é—´æœ¬å°±äº’ç›¸ç‹¬ç«‹<br>Backward Passï¼šåªéœ€è¦åœ¨ä¸åŒçš„åˆ—blocksæ›´æ–°$\textbf{dQ}_iâ†\textbf{dQ}_i+\textbf{dS}_i^{(j)}\textbf{K}_j$</li>
<li>å¯¹äºattention matrixï¼Œæ¯ä¸€åˆ—blockä½¿ç”¨åŒä¸€ä¸ªçº¿ç¨‹å—æ¥è®¡ç®—ï¼Œç„¶åå†è¯»ä¸åŒçº¿ç¨‹å—çš„ç»“æœç›¸åŠ æ¥æ›´æ–°$\textbf{dQ}$(è¡Œæ–¹å‘)<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/FlashAttention/Pasted%20image%2020250402161104.png" alt=""><h3 id="2-2-1-Decoding"><a href="#2-2-1-Decoding" class="headerlink" title="2.2.1 Decoding"></a>2.2.1 Decoding</h3></li>
<li>åœ¨è®­ç»ƒæˆ–è€…é¢„å¡«å……æ—¶Attentionçš„ç“¶é¢ˆä¸ºä¸­é—´çŸ©é˜µ($\textbf{Q}\textbf{K}^T$å’Œ$softmax(\textbf{Q}\textbf{K}^T)$)çš„è¯»å†™ã€‚</li>
<li>åœ¨Decodingé˜¶æ®µï¼Œå› ä¸ºæ˜¯å¯¹æ–°çš„tokenè¿›è¡Œattentionï¼Œåªæœ‰å®ƒéœ€è¦ä¸ä¹‹å‰çš„tokensçš„KVéœ€è¦äº’åŠ¨ï¼Œæ‰€ä»¥query lengthå¾ˆçŸ­ï¼Œé€šå¸¸ä¸º1ã€‚äºæ˜¯Attentionçš„ç“¶é¢ˆå˜ä¸ºäº†åŠ è½½KV cacheçš„é€Ÿåº¦ã€‚<ul>
<li>åœ¨ä¸åŒçº¿ç¨‹å—ä¹‹é—´åˆ‡åˆ†KV cacheçš„åŠ è½½æ¥å¢åŠ HBMå®½å¸¦çš„å ç”¨ç‡ï¼Œä½†æ˜¯çº¿ç¨‹å—ä¹‹é—´çš„é€šä¿¡ä¸ç®—å¾ˆå¿«ã€‚</li>
<li>æœ€åé‡‡å–å°†ä¸­é—´ç»“æœå†™å…¥HBMï¼Œç„¶åè°ƒç”¨ä¸€ä¸ªå•ç‹¬çš„kernelæ¥å½’çº¦å¹¶äº§ç”Ÿæœ€ç»ˆè¾“å‡ºã€‚</li>
</ul>
</li>
</ul>
<h2 id="2-3-warpsçš„åˆ†å·¥"><a href="#2-3-warpsçš„åˆ†å·¥" class="headerlink" title="2.3 warpsçš„åˆ†å·¥"></a>2.3 warpsçš„åˆ†å·¥</h2><p>ç»™çº¿ç¨‹å—åˆ†é…4æˆ–8ä¸ªwarps</p>
<p>Forward pass<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/FlashAttention/Pasted%20image%2020250402162614.png" alt="|346"><br>FlashAttentionå°†$\textbf{K}$å’Œ$\textbf{V}$åˆ‡åˆ†åˆ°4ä¸ªwarpsä¸­ï¼ŒåŒæ—¶æ‰€æœ‰warpså¯ä»¥è®¿é—®$\textbf{Q}$ã€‚<br>æ¯ä¸ªwarpè¿›è¡Œè®¡ç®—å¾—åˆ°ä¸€éƒ¨åˆ†$\textbf{Q}\textbf{K}^T$ï¼Œå†ä¹˜å¯¹åº”éƒ¨åˆ†çš„$\textbf{V}$ï¼Œç„¶åå†ç›¸åŠ ã€‚<br>    è¿™ç§â€split-Kâ€æ–¹æ¡ˆæ–¹æ³•éœ€è¦å°†ä¸¤æ¬¡å¾—åˆ°çš„éƒ¨åˆ†ç»“æœéƒ½å†™åˆ°shared memoryé‡Œè®©ä¸åŒçš„warpså…±äº«æ‰èƒ½è¿›è¡Œç›¸åŠ ï¼Œè¿™å¢åŠ çš„è¯»å†™é‡é™ä½äº†forward passçš„é€Ÿåº¦ã€‚ï¼ˆåœ¨2.2â€œSMå’Œçº¿ç¨‹å—çš„å…³ç³»â€ä¸€å›¾ä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹å—çš„shared memoryæ˜¯çº¿ç¨‹å—å†…éƒ¨å…±äº«çš„ï¼‰<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/FlashAttention/Pasted%20image%2020250402163711.png" alt="|325"></p>
<ul>
<li>FlashAttention2å°†å°†$\textbf{Q}$åˆ‡åˆ†åˆ°4ä¸ªwarpsä¸­ï¼ŒåŒæ—¶æ‰€æœ‰warpså¯ä»¥è®¿é—®$\textbf{K}$å’Œ$\textbf{V}$ï¼ŒåŒæ ·çš„ï¼Œæ¯ä¸ªwarpè¿›è¡Œè®¡ç®—å¾—åˆ°ä¸€éƒ¨åˆ†$\textbf{Q}\textbf{K}^T$ï¼Œå†ä¹˜å¯¹åº”éƒ¨åˆ†çš„$\textbf{V}$ï¼Œç„¶åå†ç›¸åŠ ã€‚è¿™é‡Œçš„ä¸­é—´ç»“æœæ˜¯åœ¨å½“å‰warpä¸‹çš„ï¼Œä¸éœ€è¦è¿›è¡Œwarpsä¹‹é—´çš„æ•°æ®ä¼ é€’ï¼Œå› æ­¤ä¸éœ€è¦å…±äº«å†…å­˜è¯»å†™å¹¶èƒ½æå‡é€Ÿåº¦ã€‚</li>
</ul>
<p>Backward pass<br>è¿‡ç¨‹ä¸­ï¼Œå› ä¸º$\textbf{Q}$ã€$\textbf{K}$ã€$\textbf{V}$ã€$\textbf{O}$ã€$\textbf{dQ}$ã€$\textbf{dK}$ã€$\textbf{dV}$ä¹‹é—´æ˜¯å­˜åœ¨ä¾èµ–å…³ç³»çš„ï¼Œéœ€è¦ä¸€äº›åŒæ­¥ï¼Œä¸åƒ$\textbf{Q}_i$ä¹‹é—´äº’ç›¸ç‹¬ç«‹ï¼Œä½†ä¸ä½¿ç”¨â€split-Kâ€è¿˜æ˜¯å¯ä»¥å‡å°‘ä¸€äº›å…±äº«å†…å­˜çš„è¯»å†™å¹¶æå‡é€Ÿåº¦ã€‚</p>
<p>Tuning block sizes<br>çº¿ç¨‹å—å¢å¤§å¯ä»¥å‡å°‘shared memoryçš„è¯»å†™ï¼Œä½†æ˜¯å¢åŠ äº†æ‰€éœ€çš„resigterå’Œæ€»çš„shared memoryã€‚æœ€åFlashAttention2é€‰æ‹©çº¿ç¨‹å—å¤§å°ä¸º$\{64, 128\}\times\{64, 128\}$ï¼Œ(4ç§é€‰æ‹©çš„)æœ€ç»ˆå–å†³äºheadçš„å¤§å°$d$å’Œè®¾å¤‡çš„shared meomoryå¤§å°ã€‚</p>
<h1 id="3-FlashAttention3"><a href="#3-FlashAttention3" class="headerlink" title="3 FlashAttention3"></a>3 FlashAttention3</h1><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/17533058076">Flash Attention 3 æ·±åº¦è§£æ</a>ï¼šä¸å…¶è¯´FA3æ˜¯FA2ç®—æ³•æ”¹è¿›çš„å»¶ç»­ï¼Œä¸å¦‚è¯´<strong>FA3çš„å·¥ç¨‹åˆ›æ–°æ˜¯å¦‚ä½•å……åˆ†å‘æŒ¥Hopperæ¶æ„å¼ºå¤§ç®—åŠ›çš„è¯´æ˜ä¹¦</strong>ã€‚ç†è§£äº†FA3çš„åŸç†ï¼Œå°±ç›¸å½“äºç†è§£äº†Hopperç¡¬ä»¶æ¶æ„çš„ç‰¹æ€§å’Œé’ˆå¯¹æ–°æ¶æ„åšæ€§èƒ½ä¼˜åŒ–çš„ä¸€ç³»åˆ—æ–¹æ¡ˆã€‚<br>åœ¨äº†è§£FlashAttention3ä¹‹å‰ï¼Œæœ€å¥½å…ˆçœ‹ä»¥ä¸‹å†…å®¹ï¼š<br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/12481535419">Nvidia Hopper WGMMAè®¡ç®—åˆ†æ</a><br><a target="_blank" rel="noopener" href="https://deep-learning.feishu.cn/wiki/PnYmw4KcdiPBphkJBFdcqdDxnke">Hopper-100æ¶æ„</a></p>
<p>å›é¡¾ä¸€ä¸‹ï¼ŒFlashAttentionç”¨tilingå’Œrecomputeæ–¹æ³•ï¼Œåœ¨ä¸€ä¸ªå•ç‹¬çš„GPUkernelsä¸Šé€šè¿‡èåˆattentionçš„æ“ä½œï¼Œå‡å°‘ä¼šä½¿GMEMå˜æ…¢çš„ä¸­é—´è¿‡ç¨‹çš„IOè¯»å†™ï¼›FlashAttention2æ›´æ”¹FlashAttentionå¯¹ç‰¹å¾å¹¶è¡Œè®¡ç®—çš„ç®—æ³•ï¼Œæ”¹ä¸ºå¯¹åºåˆ—å¹¶è¡Œè®¡ç®—ï¼Œæ”¹å–„GPUçš„å ç”¨å’Œåˆ†é…é—®é¢˜ã€‚<br>ä½†æ˜¯ï¼ŒFlashAttenion2åœ¨H100çš„GPUåˆ©ç”¨ç‡ä½ï¼Œåªæœ‰35%ï¼Œç›¸æ¯”äºä¼˜åŒ–åçš„GEMM80~90%çš„ä½¿ç”¨ç‡ï¼Œæ˜¾å¾—éå¸¸é€Šè‰²ã€‚åŸå› æ˜¯å®ƒéµå¾ªç®€å•çš„åŒæ­¥æœºåˆ¶ï¼Œæ²¡æœ‰åˆ©ç”¨H100çš„å¼‚æ­¥å’Œä½ç²¾åº¦ç‰¹æ€§ã€‚æ‰€ä»¥FlashAttention3çš„æå‡ºå°±æ˜¯ä¸ºäº†<strong>åˆ©ç”¨H100æ¶æ„çš„DASåŒ–ç‰¹æ€§</strong>ã€‚</p>
<ul>
<li>H100æœ‰å¼‚æ­¥æœºåˆ¶å•å…ƒ<strong>Tensor Cores WGMMA</strong>ï¼Œ<strong>TMA</strong>ï¼Œå¯ä»¥è®©æ•°æ®æ¬è¿å’Œè®¡ç®—é‡å ã€‚<ul>
<li>TMAï¼šTensor Memory Acceleratorï¼Œå†…å­˜æ¬è¿åŠ é€Ÿ</li>
<li>WGMMAï¼šwarpgroup MMAï¼Œçº¿ç¨‹æŸçº§åˆ«MMA</li>
</ul>
</li>
<li>ä½ç²¾åº¦</li>
</ul>
<p>FlashAttention3çš„å‡çº§åœ¨äºæ ¹æ®Hopperæ¶æ„æ¥æ”¹è¿›å…¶ç®—æ³•ã€‚</p>
<ul>
<li>FP16ï¼šåœ¨forward passä¸­ï¼ŒFlashAttention3æ¯”FlashAttention2æå‡äº†1.5-2å€é€Ÿåº¦(è¾¾åˆ°740TFLOPSs/s)ï¼Œbackward passæå‡äº†1.5-1.75å€</li>
<li>FP8ï¼š</li>
</ul>
<p><strong>FlashAtttention3æ–°ç‰¹å¾</strong>ï¼š<br>H100æ–°ç‰¹æ€§ï¼š</p>
<ul>
<li>WGMMAï¼šæ„å‘³ç€æœ‰æ›´é«˜çš„ååï¼Œé€šè¿‡ä¸€ä¸ªwarpgroupæ‰§è¡Œ(å³4ä¸ªè¿ç»­çš„warps)<ul>
<li>ç”¨WGMMAä»£æ›¿MMA</li>
<li><code>mma.sync</code>æ˜¯Aå¡æŒ‡ä»¤ï¼Œåªèƒ½è¾¾åˆ°ååé‡å³°å€¼çš„2/3</li>
</ul>
</li>
<li>TMAï¼šæ„å‘³ç€æ›´å¿«çš„GMEMåˆ°SMEMæ•°æ®ä¼ è¾“ï¼Œå¯ä»¥å¼‚æ­¥æ‰§è¡Œ<ul>
<li>ç›¸æ¯”CPAï¼Œå‡å°‘äº†ä½¿ç”¨å¯„å­˜å™¨è¿›è¡Œåœ°å€è®¡ç®—</li>
<li>FA2ç”¨CPAä»GMEMåŠ è½½tile<br>è¿™ä¸¤ä¸ªæ–°ç‰¹æ€§è‡ªç„¶åœ°é›†æˆåˆ°producer warpå’Œconsumer warpçš„pipelineè®¾è®¡ä¸­</li>
</ul>
</li>
<li><mark style="background: #FFF3A3A6;">Producer-Consumerå¼‚æ­¥æœºåˆ¶</mark>ï¼šå¯¹warpgroupè®¾ç½®ä¸åŒä»»åŠ¡ï¼Œåˆ†ä¸ºproducer warpgroupå’Œconsumer warpgroupï¼Œå¼‚æ­¥æ‰§è¡Œæ•°æ®ç§»æ¬è¿å’ŒTensor Coresè®¡ç®—ï¼Œéšè—å†…å­˜å’ŒæŒ‡ä»¤å»¶è¿Ÿã€‚</li>
<li>åœ¨å¼‚æ­¥blocksçº§åˆ«GEMM(å³WGMMA)ä¸‹<mark style="background: #FFF3A3A6;">éšè—softmax</mark>ï¼šsoftmaxä¸­floatingä¹˜åŠ å’ŒæŒ‡æ•°è®¡ç®—éƒ½æ˜¯<strong>ä½ååçš„non-GEMMæ“ä½œ</strong>ï¼Œè€Œ<strong>GEMMæ“ä½œçš„ååé‡è¾ƒé«˜</strong>ï¼Œé€šè¿‡å¼‚æ­¥æŒ‡ä»¤WGMMAå®ç°è®¡ç®—é‡å ï¼Œå…·ä½“åˆ†ä¸º<strong>inter warpgroup</strong>å’Œ<strong>intra warpgroup</strong>ï¼Œåœ¨FlashAttention2çš„åŸºç¡€ä¸Šåšåˆ°<strong>è§„é¿</strong>softmaxå’ŒGEMMçš„<strong>ä¾èµ–å…³ç³»</strong>ï¼Œéšè—softmaxé€ æˆçš„ä¸€éƒ¨åˆ†å»¶è¿Ÿã€‚</li>
</ul>
<h2 id="3-1-GPUæ¶æ„ç‰¹å¾å’Œæ‰§è¡Œæ¨¡å‹"><a href="#3-1-GPUæ¶æ„ç‰¹å¾å’Œæ‰§è¡Œæ¨¡å‹" class="headerlink" title="3.1 GPUæ¶æ„ç‰¹å¾å’Œæ‰§è¡Œæ¨¡å‹"></a>3.1 GPUæ¶æ„ç‰¹å¾å’Œæ‰§è¡Œæ¨¡å‹</h2><h3 id="3-1-1-å†…å­˜ä½“ç³»å’Œçº¿ç¨‹ä½“ç³»"><a href="#3-1-1-å†…å­˜ä½“ç³»å’Œçº¿ç¨‹ä½“ç³»" class="headerlink" title="3.1.1 å†…å­˜ä½“ç³»å’Œçº¿ç¨‹ä½“ç³»"></a>3.1.1 å†…å­˜ä½“ç³»å’Œçº¿ç¨‹ä½“ç³»</h3><p>H100çš„<br>å†…å­˜ä½“ç³»ï¼š</p>
<ul>
<li>GMEMæ˜¯å¯ä»¥è®¿é—®å…¨éƒ¨SMsçš„ç‰‡ä¸‹DRAMï¼Œå…¶ç‰©ç†å®ç°ä¾é HBM</li>
<li>åœ¨GMEMçš„æ•°æ®ç¼“å­˜åœ¨ç‰‡ä¸Šçš„L2 cacheä¸­</li>
<li>æ¯ä¸ªSMåŒ…å«ä¸€ä¸ªå°å‹ç‰‡ä¸Šå­˜å‚¨ç¼“å­˜SMEM</li>
<li>æ¯ä¸ªSMéƒ½æœ‰å¯„å­˜å™¨å †<br>çº¿ç¨‹ä½“ç³»ï¼š</li>
<li>GPUç¼–ç¨‹æ¨¡å‹æ˜¯åœ¨çº¿ç¨‹ä¸ŠæŒ‰é€»è¾‘ç»„ç»‡è¿è¡Œçš„ï¼Œä»å°åˆ°å¤§çš„çº¿ç¨‹ç»„ç»‡åŒ…æ‹¬ï¼šçº¿ç¨‹threadsã€çº¿ç¨‹æŸwarps(32ä¸ªçº¿ç¨‹)ã€warpsgroups(4ä¸ªè¿ç»­çš„warps)ã€çº¿ç¨‹å—threadblocks(i.e. cooperative thread arrays or CTAs)ã€threadblock clusters(Hopperæ¶æ„çš„)ã€ç½‘æ ¼grids<br>è¿™ä¸¤ç§ä½“ç³»çš„å…³ç³»ï¼š</li>
<li>åŒä¸€threadblocksä¸­çš„threadsè¢«å…±åŒè°ƒåº¦åœ¨åŒä¸€SMä¸Šï¼Œçº¿ç¨‹åªèƒ½è®¿é—®æ‰€å±çº¿ç¨‹å—çš„SMEMï¼Œæ¯ä¸ªthreadsæœ€å¤šæœ‰256ä¸ªRMEM</li>
<li>åŒä¸€threadblock clustersä¸­çš„threadblocksè¢«å…±åŒè°ƒåº¦åœ¨åŒä¸€GPCä¸Šï¼Œçº¿ç¨‹å¯è®¿é—®clusterså†…çš„SMEM<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/FlashAttention/Pasted%20image%2020250417171025.png" alt=""><br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/FlashAttention/Pasted%20image%2020250405221652.png" alt=""><h3 id="3-1-2-å¼‚æ­¥å’Œwarp-specialization"><a href="#3-1-2-å¼‚æ­¥å’Œwarp-specialization" class="headerlink" title="3.1.2 å¼‚æ­¥å’Œwarp-specialization"></a>3.1.2 å¼‚æ­¥å’Œwarp-specialization</h3></li>
<li>warp-specializedçš„å¼‚æ­¥æœºåˆ¶ï¼šåœ¨åŒä¸€ä¸ªthreadblockçš„warpsä¼šè¢«åˆ†ä¸ºproduceræˆ–è€…consumerï¼Œåªè§£å†³æ•°æ®ç§»åŠ¨æˆ–è€…è®¡ç®—ã€‚</li>
<li>æ•°æ®æ¬è¿ï¼šTMAç¡¬ä»¶å•å…ƒæ”¯æŒ<strong>GMEMå’ŒSMEM</strong>ä¹‹é—´<strong>å¼‚æ­¥å†…å­˜æ‹·è´</strong>ï¼Œå°†æ•°æ®ä»GMEMæ¬è¿åˆ°SMEMï¼Œæ¬è¿å®ŒæˆåTMAé€šçŸ¥consumerï¼ŒåŒæ—¶ç­‰å¾…SMEM bufferé‡Šæ”¾ã€‚</li>
<li>è®¡ç®—ï¼šé€šè¿‡WGMMAæŒ‡ä»¤ï¼Œå®ç°Tensor Coreå¼‚æ­¥ï¼Œç›´æ¥ä»<strong>SMEM</strong>ä¸­<strong>è·å–è¾“å…¥</strong>ï¼Œè®¡ç®—GEMMå’Œsoftmaxï¼Œé‡Šæ”¾bufferå¹¶é€šçŸ¥producerã€‚</li>
<li>Hopperæ”¯æŒé€šè¿‡<code>setmaxnreg</code>åŠ¨æ€é‡æ–°åˆ†é…warpgroupsçš„registerï¼Œå› æ­¤åšMMAçš„warps(å³consumerï¼Œç›¸æ¯”äºproducerå·¥ä½œé‡å¤§)å¯ä»¥è·å¾—æ›´å¤§çš„RMEMï¼Œæ•°æ®æ¬è¿çš„RMEMå°±ä¼šå°‘ä¸€äº›<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/FlashAttention/Pasted%20image%2020250418100136.png" alt=""><h3 id="3-1-3-ä½ç²¾åº¦æ ¼å¼"><a href="#3-1-3-ä½ç²¾åº¦æ ¼å¼" class="headerlink" title="3.1.3 ä½ç²¾åº¦æ ¼å¼"></a>3.1.3 ä½ç²¾åº¦æ ¼å¼</h3>è¿™éƒ¨åˆ†<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/17533058076">Flash Attention 3 æ·±åº¦è§£æ</a>è®²è§£å¾—å¾ˆå¥½<br>ä¸¤ä¸ªé—®é¢˜ï¼š</li>
<li>FP8 WGMMAè¦æ±‚å¿…é¡»è¦åœ¨æœ€å†…å±‚ç»´åº¦ä¸Šè¿ç»­(k-major)ï¼Œå³Aè¡Œè¿ç»­ï¼ŒBåˆ—è¿ç»­ï¼Œä¸¤ç§æ€è·¯ï¼š<ul>
<li>QKVéƒ½æ˜¯è¡Œè¿ç»­ï¼ŒPä¹Ÿæ˜¯è¡Œè¿ç»­ï¼Œéœ€è¦Våšè½¬ç½®</li>
<li>QKVé€šå¸¸æ˜¯BHSDï¼Œè€ŒPæ˜¯BHSSï¼Œéœ€è¦åœ¨seq lenç»´åº¦ä¸Šè¿ç»­ï¼Œè€ŒVçš„æœ€åä¸€ä¸ªç»´åº¦æ˜¯head dimï¼Œäºæ˜¯éœ€è¦å¯¹Vçš„Så’ŒDç»´åº¦åštranspose</li>
<li>è§£å†³ï¼šä½¿ç”¨LDSM/STSM</li>
</ul>
</li>
<li>FP32 WGMMA accumulater(å³C)å¯„å­˜å™¨çš„æ’åˆ—å¸ƒå±€ä¸FP8 WGMMA Açš„ä¸åŒ<ul>
<li>åªåœ¨çº¿ç¨‹å†…éƒ¨åšå¯„å­˜å™¨çš„äº¤æ¢<br>â“å¯¹äºâ€çº¿ç¨‹ 0 åœ¨å¯„å­˜å™¨é‡Œæ‹¥æœ‰ d0 [åæ ‡ä¸º(0, 0)]ï¼Œd1(0, 1)ï¼Œd2(8, 0)ï¼Œd3(8, 1)ï¼Œd4(0, 8)ï¼Œd5(0, 9)ï¼Œd6(8, 8)ï¼Œd7(8, 9) ä¸€å…± 8 ä¸ªæ•°æ®ã€‚ä¸ºäº†è¾¾æˆå˜æ¢åå›¾ 10 çš„æƒ…å†µï¼Œçº¿ç¨‹ 0 çš„è¿™ 8 ä¸ªæ•°æ®éœ€è¦åˆ†åˆ«ä» T0d0, T0d1, T1d0, T1d1, T0d2, T0d3, T1d2, T1d3 è·å–ã€‚â€œå…¶å®ä¸ºä»€ä¹ˆè¿™8ä¸ªæ•°æ®éœ€è¦è¿™æ ·è·å–ï¼Ÿdxä¸­çš„xçš„æ•°å­—ä»£è¡¨äº†ä»€ä¹ˆï¼Ÿåªæ˜¯NVçš„è‡ªæˆä¸€ä½“çš„å®šä¹‰å—ï¼Ÿã€‚ã€‚ã€‚<h1 id="3-2-ç®—æ³•"><a href="#3-2-ç®—æ³•" class="headerlink" title="3.2 ç®—æ³•"></a>3.2 ç®—æ³•</h1><h3 id="3-2-1-producer-consumerå¼‚æ­¥æœºåˆ¶"><a href="#3-2-1-producer-consumerå¼‚æ­¥æœºåˆ¶" class="headerlink" title="3.2.1 producer-consumerå¼‚æ­¥æœºåˆ¶"></a>3.2.1 producer-consumerå¼‚æ­¥æœºåˆ¶</h3>è¯¥å¼‚æ­¥æœºåˆ¶ä¾é ä¸¤ç§æ–¹æ³•å®ç°</li>
</ul>
</li>
</ul>
<ol>
<li><strong>warp-specialization</strong><br>FlashAttention3çš„forward passå’ŒFlashAttention2ä¸€æ ·ï¼Œåœ¨batch sizeã€number of headså’Œ$Q$çš„åºåˆ—é•¿åº¦è¿›è¡Œå¹¶è¡Œï¼Œå› æ­¤ä¸€ä¸ªCTA-levelçº§çš„ç®—æ³•æ˜¯å¯ä»¥åº”å¯¹å‰é¢çš„å¹¶è¡Œçš„ï¼Œå…·ä½“åšæ³•æ˜¯å°†$\textbf{Q}$åˆ†å—ã€‚</li>
</ol>
<ul>
<li>ä¸ªäººç†è§£ï¼š$\textbf{Q}$æ˜¯tilingæ€æƒ³ï¼Œthreadblockså…¶å®ä¹Ÿæ˜¯tilingæ€æƒ³ï¼Œå°†çº¿ç¨‹åˆ†å—ã€‚ç„¶åæ¯ä¸ªçº¿ç¨‹åˆ’åˆ†ä¸ºä¸¤ä¸ªçº¿ç¨‹æŸçš„é›†åˆï¼Œå³producer warpgroupå’Œconsumer warpgroupï¼Œä¹Ÿæ˜¯ç»§æ‰¿äº†tilingï¼ŒäºŒè€…æ˜¯å¼‚æ­¥å…³ç³»</li>
<li>CTA-viewï¼š<ul>
<li>producerï¼šå°†æ•°æ®ä»GMEMåŠ è½½åˆ°SMEM</li>
<li>å°±æ˜¯FA2+TMA&amp;WGMMAçš„warp specialization<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/FlashAttention/Pasted%20image%2020250406095916.png" alt=""></li>
</ul>
</li>
<li>åˆå§‹åŒ–ä¸€ä¸ªpipelineå¯¹è±¡ï¼Œç®¡ç†barrier synchronizationä½¿å„ä¸ªçº¿ç¨‹ä¹‹é—´åŒæ­¥åè°ƒï¼Œä½¿ç”¨ä¸€ä¸ªs-stageçš„å¾ªç¯SMEM bufferã€‚</li>
<li>å¦‚æœå½“å‰threadæ‰€åœ¨çš„warpgroupå±äºproducer(å¤„ç†æ•°æ®ç§»åŠ¨)<ul>
<li><mark style="background: #CACFD9A6;">é‡Šæ”¾ä¸€éƒ¨åˆ†registers</mark></li>
<li><mark style="background: #ADCCFFA6;">æŠŠå½“å‰åˆ†å—</mark>$\textbf{Q}_i$<mark style="background: #ADCCFFA6;">ä»HBMåŠ è½½åˆ°SMEM</mark></li>
<li><mark style="background: #ADCCFFA6;">åŠ è½½å®Œæˆåï¼Œé€šçŸ¥å±äºconsumerçš„threadsåŠ è½½</mark>$\textbf{Q}_i$</li>
<li>éå†$T_c$ä¸ª$\textbf{K}$å’Œ$\textbf{V}$çš„åˆ†å—<ul>
<li><mark style="background: #BBFABBA6;"> ç­‰å¾…å½“å‰å¾ªç¯bufferçš„ç¬¬</mark>$j\%s$<mark style="background: #BBFABBA6;">é˜¶æ®µè¢«consumerä½¿ç”¨å®Œ</mark>ï¼Œé˜²æ­¢æ—§æ•°æ®æœªåˆ©ç”¨å®Œå°±åŠ è½½æ–°æ•°æ®å°†æ—§æ•°æ®è¦†ç›–</li>
<li><mark style="background: #ADCCFFA6;">æŠŠå½“å‰åˆ†å—</mark>$\textbf{K}_j$<mark style="background: #ADCCFFA6;">å’Œ</mark>$\textbf{V}_j$<mark style="background: #ADCCFFA6;">ä»HBMåŠ è½½åˆ°SMEM</mark>ï¼Œå¯¹åº”å¾ªç¯bufferçš„ç¬¬$j\%s$é˜¶æ®µ</li>
<li><mark style="background: #ADCCFFA6;">åŠ è½½å®Œæˆåï¼Œé€šçŸ¥å±äºconsumerçš„threadsåŠ è½½</mark>$\textbf{K}_j$<mark style="background: #ADCCFFA6;">å’Œ</mark>$\textbf{V}_j$</li>
</ul>
</li>
</ul>
</li>
<li><p>å¦‚æœå½“å‰threadæ‰€åœ¨çš„warpgroupå±äºconsumer(å¤„ç†è®¡ç®—)</p>
<ul>
<li>æ ¹æ®consumer warpsçš„æ•°é‡é‡æ–°åˆ†é…registers</li>
<li>åœ¨ç‰‡ä¸Šåˆå§‹åŒ–$textbf{Q}_i$ã€$\ell_i$ã€$m_i$</li>
<li><mark style="background: #ADCCFFA6;">ç­‰å¾…</mark>$\textbf{Q}_i$<mark style="background: #ADCCFFA6;">åŠ è½½åˆ°SMEM</mark></li>
<li>éå†$T_c$ä¸ª$\textbf{K}$å’Œ$\textbf{V}$çš„åˆ†å—<ul>
<li><mark style="background: #ADCCFFA6;">ç­‰å¾…</mark>$\textbf{K}_j$<mark style="background: #ADCCFFA6;">åŠ è½½åˆ°SMEM</mark></li>
<li><mark style="background: #FFB86CA6;">SS-GEMM</mark>(æ•°æ®æ¥æºéƒ½æ˜¯SMEM)ï¼šè®¡ç®—$\textbf{S}_i^{(j)}=\textbf{Q}_i\textbf{K}_j^T$</li>
<li>å­˜å‚¨$m_i^{old}=m_i$ï¼Œæ›´æ–°$m_i=max(m_i^{old},rowmax(S_i^{(j)}))$</li>
<li>è®¡ç®—$\tilde{\textbf{P}}_i^{(j)}=exp(\textbf{S}_i^{(j)}-m_i)$å’Œ$\ell_i=exp(m_i^{old}-m_i)\ell_i+rowmsum(\tilde{\textbf{P}}_i^{(j)})$</li>
<li><mark style="background: #ADCCFFA6;">ç­‰å¾…</mark>$\textbf{V}_j$<mark style="background: #ADCCFFA6;">åŠ è½½åˆ°SMEM</mark></li>
<li><mark style="background: #FFB86CA6;">RS-GEMM</mark>($\tilde{\textbf{P}}_i^{(j)}$åœ¨RMEMä¸­ï¼Œ$\textbf{V}_j$åœ¨SMEMä¸­)ï¼šè®¡ç®—$\textbf{O}_i=diag(exp(m_i^{old}-m_i))^{-1}\textbf{O}_i+\tilde{\textbf{P}}_i^{(j)}\textbf{V}_j$</li>
<li><mark style="background: #BBFABBA6;">é‡Šæ”¾ç¬¬</mark>$j\%s$<mark style="background: #BBFABBA6;">é˜¶æ®µçš„bufferç»™producerä½¿ç”¨</mark></li>
</ul>
</li>
<li>æœ€åæ ¹æ®æœ€æ–°çš„$\ell_i$è®¡ç®—$\textbf{O}_i=diag(\ell_i)^{-1}\textbf{O}_i$å’Œ$L_i=m_i+log(\ell_i)$</li>
<li>å°†$\textbf{O}_i$å’Œ$L_i$å†™å›HBMä½œä¸ºç¬¬$i$ä¸ªåˆ†å—çš„$\textbf{O}$å’Œ$L$</li>
</ul>
</li>
<li><p><mark style="background: #CACFD9A6;">setmaxnreg</mark>è´Ÿè´£é‡Šæ”¾register</p>
</li>
<li><mark style="background: #ADCCFFA6;">TMA</mark>è´Ÿè´£åŠ è½½$\textbf{Q}_i$å’Œ$\{\textbf{K},\textbf{V}\}_{0\leq j\leq T_c}$ï¼ŒTMAåŠ è½½æ˜¯å¹¶è¡Œçš„ï¼Œå› ä¸ºå¼‚æ­¥çš„å…³ç³»ï¼Œä¸ä¼šåœ¨å…¶ä»–åŠ è½½å®Œæˆæ—¶äº’ç›¸é˜»å¡ã€‚</li>
<li>ç”¨<mark style="background: #FFB86CA6;">WGMMAæŒ‡ä»¤</mark>åœ¨consumerä¸»å¾ªç¯ä¸­æ‰§è¡ŒGEMMsã€‚</li>
</ul>
<ol>
<li><strong>pingpong scheduling</strong><br>ä¸ºä»€ä¹ˆè¦æŠŠGEMMå’Œsoftmaxçš„è®¡ç®—é‡å ï¼Ÿ</li>
</ol>
<ul>
<li>softmaxçš„è®¡ç®—åŒ…æ‹¬æŒ‡æ•°è®¡ç®—ï¼Œæ˜¯non-matmulè®¡ç®—ï¼Œååé‡æ¯”matmulçš„è¦å°‘å¾—å¤šï¼Œè®¡ç®—non-matmulç”¨æ—¶ä¹Ÿå æ®ä¸å°çš„ä¸€éƒ¨åˆ†</li>
<li>ä¾‹å¦‚ï¼ŒM=128ã€M=128ã€K=192ï¼Œè®¡ç®—$QK^T$æ—¶<ul>
<li>WGMMAè®¡ç®—é‡ä¸º$2\times128\times192\times128=6291456FLOPS$ï¼ŒWGMMAååä¸º$2048FLOPS/cycle$ï¼Œè®¡ç®—å¾—åˆ°å»¶è¿Ÿ$=3072cycles$</li>
<li>MUFU.EX2è®¡ç®—é‡ä¸º$192\times128=24576OPS$ï¼Œexpååä¸º$16OPS/cycle$ï¼Œè®¡ç®—å¾—åˆ°å»¶è¿Ÿ=$1536cycles$</li>
</ul>
</li>
<li>softmaxé‡Œexpçš„ååå’ŒWGMMAçš„ååç›¸å·®å¤ªå¤šï¼Œå»¶è¿Ÿæ˜¯tensor coreçš„ä¸€åŠï¼Œå¦‚æœè®©tensor coreç­‰å¾…expè®¡ç®—ä¼šéå¸¸ä¸åˆ’ç®—ï¼Œäºæ˜¯é‡‡ç”¨è®¡ç®—é‡å çš„æ–¹å¼ï¼Œç”¨ç®—åŠ›é«˜çš„tensor coreä¿æŒbusyçŠ¶æ€æ©ç›–ç®—åŠ›ä½çš„cuda core</li>
<li>FP8çš„æƒ…å†µä¼šç»™ä½ æ›´ç³Ÿç³•ï¼ŒWGMMAå’ŒEX2éƒ½æ˜¯1536cycles</li>
</ul>
<p><strong>Inter warpgroup</strong>â€”â€”Warp-Specialized Persistent <strong>Ping-Pong</strong> kernel design<br>warpSchedulerï¼Œæ¯ä¸ªwarpgroupæœ‰128ä¸ªçº¿ç¨‹ï¼Œè¿™åˆšå¥½æ˜¯åœ¨ä¸€ä¸ªSMä¸Šä¸€ä¸ªçº¿ç¨‹å—çš„å¤§å°</p>
<ul>
<li>synchronization barriesä»¤warpgroup 1çš„GEMMsè¿è¡Œåœ¨warpgroup 2çš„GEMMsä¹‹å‰ã€‚å…¶ä¸­GEMMsåŒ…æ‹¬<mark style="background: #FF5582A6;">GEMM1</mark>å’Œ<mark style="background: #FFB86CA6;">GEMM0</mark>ï¼Œåˆ†åˆ«æ˜¯å½“å‰è½®çš„$\textbf{P}\textbf{V}$å’Œä¸‹ä¸€è½®çš„$\textbf{Q}\textbf{K}^T$</li>
<li>ç„¶åwarpgroup 1æ‰§è¡Œ<mark style="background: #FFB86CA6;">softmax</mark>ï¼Œwarpgroup 2æ‰§è¡ŒGEMMs(<mark style="background: #FF5582A6;">GEMM1</mark>å’Œ<mark style="background: #FFB86CA6;">GEMM0</mark>)</li>
<li>ç„¶åwarpgroup 1æ‰§è¡ŒGEMMs(<mark style="background: #FFB86CA6;">GEMM1</mark>å’Œ<mark style="background: #BBFABBA6;">GEMM0</mark>)ï¼Œwarpgroup 2æ‰§è¡Œ<mark style="background: #FFB86CA6;">softmax</mark><br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/FlashAttention/Pasted%20image%2020250406162226.png" alt=""><br>å®é™…ä¸Šï¼ŒCTA-levelçš„ä»»åŠ¡æ˜¯ç”±tile scheduleråˆ†é…çš„ï¼Œå¯ä»¥å®‰æ’blockæˆ–warpgroupè®¡ç®—æŸä¸ªtileã€‚å½“åœ¨tensor coreæ‰§è¡Œmatmulæ—¶ï¼Œexpçš„è®¡ç®—é€šè¿‡synchronization barries(<code>bar.sync</code>æŒ‡ä»¤)ï¼Œç”±cuda coreå¼‚æ­¥æ‰§è¡Œã€‚åœ¨warpgroup-levelçš„è°ƒåº¦å’Œbarriesçš„å…±åŒæ§åˆ¶ä¸‹ï¼ŒåŒä¸€gemmçš„ä¸åŒoutput tileå¯ä»¥åœ¨ä¸¤ä¸ªwarpgroupä¹‹é—´ä¸æ»‘çš„åˆ‡æ¢ï¼Œå°±å¦‚Ping-Pongå†…æ ¸æµæ°´çº¿ï¼ŒæŒç»­å‘tensor coreè¾“é€æ•°æ®ï¼Œå®ç°æˆ–æ¥è¿‘å…¶æœ€å¤§ç®—åŠ›ã€‚</li>
</ul>
<p>å¯¹äºå…¶ä»–attentionå˜ä½“å¦‚MQAå’ŒGQAï¼Œä»ç„¶é‡‡å–FlashAttention2çš„ç®—æ³•ï¼Œé¿å…åœ¨HBMé‡å¤åŠ è½½$\textbf{K}$å’Œ$\textbf{V}$</p>
<h3 id="3-2-2-warpgroupå†…éƒ¨GEMMså’Œsoftmaxçš„é‡å "><a href="#3-2-2-warpgroupå†…éƒ¨GEMMså’Œsoftmaxçš„é‡å " class="headerlink" title="3.2.2 warpgroupå†…éƒ¨GEMMså’Œsoftmaxçš„é‡å "></a>3.2.2 warpgroupå†…éƒ¨GEMMså’Œsoftmaxçš„é‡å </h3><p><strong>Intra warpgroup</strong><br>GEMM1ï¼š$\textbf{P}\textbf{V}$<br>GEMM0ï¼š$\textbf{Q}\textbf{K}^T$<br>ä¸ºä»€ä¹ˆè¦è€ƒè™‘åˆ°å†…éƒ¨çš„é‡å ï¼Ÿ</p>
<ul>
<li>tensor coreçš„æ‰§è¡Œç²’åº¦æ˜¯gemmï¼Œå¦‚æœè¦è®©tensor coreä¿æŒbusyçŠ¶æ€ï¼Œåœ¨warpgroupå†…éƒ¨ä¹Ÿè¦ç”¨WGMMAæ©ç›–softmaxçš„è®¡ç®—ã€‚æ ¹æ®GEMM1ä¾èµ–softmaxçš„è¾“å‡ºï¼Œsoftmaxä¾èµ–GEMM0çš„è¾“å‡ºçš„å…³ç³»ï¼Œæˆ‘ä»¬å¸Œæœ›å¯ä»¥åšåˆ°åœ¨è¿›è¡ŒGEMM0çš„WGMMA0åç«‹é©¬æ‰§è¡ŒGEMM1çš„WGMMA1</li>
<li>å¦‚æœè¦å®ç°busyçŠ¶æ€ï¼Œå°±ä¸èƒ½å†é¡ºåºåœ°å®Œæ•´æ‰§è¡Œi-th iterationåå†æ‰§è¡Œi+1-thã€‚åˆå› ä¸ºtensor coreçš„å¼‚æ­¥å…³ç³»ï¼Œé€šè¿‡æ»åè®¡ç®—GEMM1è¾¾åˆ°æ©ç›–softmaxè®¡ç®—çš„æ•ˆæœï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè®©i+1-thçš„GEMM0å’Œi-thçš„GEMM1åœ¨i+1-thçš„softmaxæ—¶è¿›è¡Œè¡”æ¥ã€‚<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/FlashAttention/Pasted%20image%2020250418104053.png" alt=""><br>è™½ç„¶è®°å½•i-thçš„ä¸­é—´ç»“æœä¼šå¢åŠ å¯„å­˜å™¨çš„ä½¿ç”¨ï¼Œä½†æ˜¯TFLOPsç¡®å®å¢åŠ äº†</li>
</ul>
<p>è€ƒè™‘intra-warpgroupåçš„ç®—æ³•<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/FlashAttention/2aca7a8646421548df820c062e61240.jpg" alt=""></p>
<ul>
<li>ç¬¬11~13è¡Œå®ç°æ©ç›–softmax</li>
</ul>
<h1 id="éšè®°"><a href="#éšè®°" class="headerlink" title="éšè®°"></a>éšè®°</h1><p>Persistent Kernelï¼š<br>å¯åŠ¨å›ºå®šæ•°é‡çš„CTAsæ¥å ç”¨æ•´ä¸ªGPUï¼Œå¯ä»¥ä¸ºCTAsåˆ†é…å¤šä¸ªå·¥ä½œå—ï¼Œæé«˜SMä½¿ç”¨ç‡</p>
<ul>
<li>æ²¡æœ‰persistent kernelï¼šæ¯ä¸ªCTAå¯¹åº”ä¸€ä¸ªwork tileï¼Œå½“tileå·¥ä½œé‡ä¸å¤ªå‡åŒ€æ—¶ï¼Œä¼šå¯¼è‡´SMsç©ºé—²</li>
<li>æœ‰persistent kernelï¼šåœ¨ H100 SXM5 GPU ä¸Šï¼Œæœ‰132ä¸ªSMsï¼Œæ¯ä¸ªSMè´Ÿè´£ä¸€ä¸ªCTAï¼Œä¸€ä¸ªCTAåŠ¨æ€å¤„ç†work tiles(ä¸€å¯¹å¤š)ã€‚åœ¨causal maskingçš„æ—¶å€™å¯ä»¥åŠ¨æ€è°ƒåº¦work tileã€‚å¯ä»¥åœ¨å‰ä¸€ä¸ªtileçš„æ”¶å°¾é˜¶æ®µé¢„åŠ è½½ä¸‹ä¸€ä¸ªtileï¼Œå®é™…ä¸Šæ©ç›–äº†æ²¡æœ‰persistent kernelæ—¶åŒä¸€ä¸ªSMåœ¨ä¸¤ä¸ªCTAä¹‹é—´åˆ‡æ¢çš„å»¶è¿Ÿã€‚</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/FlashAttention/Pasted%20image%2020250428140437.png" alt="FA3CTA-levelä¸­çš„CUTLASS"><br><code>t0r0</code>ï¼šthread-wise accumulator of attention output<br>tä»£è¡¨thread-levelï¼Œrè¡¨ç¤ºregister</p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        æ–‡ç« ä½œè€…:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">WB</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        æ–‡ç« é“¾æ¥:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://wabbybabb0.github.io/2025/03/26/flashattention/">https://wabbybabb0.github.io/2025/03/26/flashattention/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        ç‰ˆæƒå£°æ˜:
                    </i>
                </span>
                <span class="reprint-info">
                    æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ¥å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥æº
                    <a href="/about" target="_blank">WB</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>å¤åˆ¶æˆåŠŸï¼Œè¯·éµå¾ªæœ¬æ–‡çš„è½¬è½½è§„åˆ™</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">æŸ¥çœ‹</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/LLM/">
                                    <span class="chip bg-color">LLM</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>å¾®ä¿¡æ‰«ä¸€æ‰«å³å¯åˆ†äº«ï¼</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">èµ</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">ç»™WBæ¥åŒ…è¾£æ¡</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">æ”¯ä»˜å®</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">å¾® ä¿¡</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="æ”¯ä»˜å®æ‰“èµäºŒç»´ç ">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="å¾®ä¿¡æ‰“èµäºŒç»´ç ">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    
        <div class="card" data-aos="fade-up">
    <div id="utteranc-container" class="card-content">
        <script src="https://utteranc.es/client.js"
                repo="Wabbybabb0/commit-utterance"
                issue-term="pathname"
                theme="github-light"
                crossorigin="anonymous"
                async>
        </script>
    </div>
</div>
    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;ä¸Šä¸€ç¯‡</div>
            <div class="card">
                <a href="/2025/04/29/flashattention-mini/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/11.png" class="responsive-img" alt="ã€å®è·µã€‘FlashAttentionå­¦ä¹ è¿‡ç¨‹">
                        
                        <span class="card-title">ã€å®è·µã€‘FlashAttentionå­¦ä¹ è¿‡ç¨‹</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            FlashAttentionv1å®æ“è¿‡ç¨‹ï¼Œå·²éªŒè¯ï¼
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2025-04-29
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E9%AB%98%E6%80%A7%E8%83%BD%E8%AE%A1%E7%AE%97/" class="post-category">
                                    é«˜æ€§èƒ½è®¡ç®—
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/LLM/">
                        <span class="chip bg-color">LLM</span>
                    </a>
                    
                    <a href="/tags/CUDA/">
                        <span class="chip bg-color">CUDA</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                ä¸‹ä¸€ç¯‡&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2025/03/19/mla/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/22.jpg" class="responsive-img" alt="Multi-head Latent Attentionæ¨¡å‹ç†è§£">
                        
                        <span class="card-title">Multi-head Latent Attentionæ¨¡å‹ç†è§£</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            ä½œä¸ºFlashMLAçš„æ ¸å¿ƒä¹‹ä¸€ï¼ŒMLAè®¾è®¡äº†åœ¨ä¿æŒæ€§èƒ½çš„åŒæ—¶ç€é‡å‡å°‘KV Cacheçš„attentionæœºåˆ¶ï¼Œååˆ†å€¼å¾—ç»†ç©¶ï¼
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2025-03-19
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E9%AB%98%E6%80%A7%E8%83%BD%E8%AE%A1%E7%AE%97/" class="post-category">
                                    é«˜æ€§èƒ½è®¡ç®—
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/DeepSeek/">
                        <span class="chip bg-color">DeepSeek</span>
                    </a>
                    
                    <a href="/tags/GPU/">
                        <span class="chip bg-color">GPU</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + 'æ¥æº: Wabbybabboçš„æ‘¸é±¼åœ£åœ°<br />'
            + 'æ–‡ç« ä½œè€…: Wabbybabbo<br />'
            + 'æ–‡ç« é“¾æ¥: <a href="' + url + '">' + url + '</a><br />'
            + 'æœ¬æ–‡ç« è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ï¼Œä»»ä½•å½¢å¼çš„è½¬è½½éƒ½è¯·æ³¨æ˜å‡ºå¤„ã€‚';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- ä»£ç å—åŠŸèƒ½ä¾èµ– -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- ä»£ç è¯­è¨€ -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- ä»£ç å—å¤åˆ¶ -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- ä»£ç å—æ”¶ç¼© -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;ç›®å½•</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC æ‚¬æµ®æŒ‰é’®. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* ä¿®å¤æ–‡ç« å¡ç‰‡ div çš„å®½åº¦. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // åˆ‡æ¢TOCç›®å½•å±•å¼€æ”¶ç¼©çš„ç›¸å…³æ“ä½œ.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>


    
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"] ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mathjax@2.7.8/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    




<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.8/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
    MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$', '$'], ['\(', '\)']]}
    });
</script>



    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="8590828427"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2023-2025</span>
            
            <span id="year">2023</span>
            <a href="/about" target="_blank">Wabbybabbo</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;æ€»è®¿é—®é‡:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;æ¬¡
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;æ€»è®¿é—®äººæ•°:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;äºº
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/Wabbybabb0" class="tooltipped" target="_blank" data-tooltip="è®¿é—®æˆ‘çš„GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:Wabbybabb0@outlook.com" class="tooltipped" target="_blank" data-tooltip="é‚®ä»¶è”ç³»æˆ‘" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=497056512" class="tooltipped" target="_blank" data-tooltip="QQè”ç³»æˆ‘: 497056512" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS è®¢é˜…" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- æœç´¢é®ç½©æ¡† -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;æœç´¢</span>
            <input type="search" id="searchInput" name="s" placeholder="è¯·è¾“å…¥æœç´¢çš„å…³é”®å­—"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
