<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>æµ‹è¯•ç”¨</title>
      <link href="/2025/03/19/mla-fu-ben/"/>
      <url>/2025/03/19/mla-fu-ben/</url>
      
        <content type="html"><![CDATA[<p><a href="https://arxiv.org/abs/2405.04434">DeepSeek-V2: A Strong, Economical, and Efficient Mixture-of-Experts Language Model</a></p><p>ç›¸å…³è®ºæ–‡ï¼š<a href="https://arxiv.org/abs/2405.04434">DeepSeek-V2: A Strong, Economical, and Efficient Mixture-of-Experts Language Model</a></p><p>æœ¬æ–‡å†…å®¹å›´ç»•å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶çš„æ¼”å˜è¿‡ç¨‹ï¼Œç€é‡è®°å½•MLAçš„è®¾è®¡åŸç†ï¼Œå¯¹<a href="https://spaces.ac.cn/archives/10091">ç¼“å­˜ä¸æ•ˆæœçš„æé™æ‹‰æ‰¯ï¼šä»MHAã€MQAã€GQAåˆ°MLA</a>ã€<a href="https://www.bilibili.com/video/BV1BYXRYWEMj?spm_id_from=333.1245.0.0">DeepSeek-v2 MLA åŸç†è®²è§£</a>çš„å†…å®¹è¿›è¡Œæ•´åˆä¸åˆ†æï¼Œåœ¨æˆ‘ç†è§£MLAçš„è¿‡ç¨‹ä¸­ï¼Œä»–ä»¬ç»™äºˆäº†å¾ˆå¥½çš„å¯è¿ªï¼</p><p>å‡è®¾æ‰€æœ‰è¾“å…¥éƒ½ä¸ºè¡Œå‘é‡ï¼Œè¾“å…¥åºåˆ—ä¸º$\textbf{x}_1, \textbf{x}_2, â€¦, \textbf{x}_l$ï¼Œå…¶ä¸­$\textbf{x}_i\in \mathbb{R}^{1\times d}$</p><ul><li>$l$ï¼štokenæ•°é‡</li><li>$d$ï¼š<code>embdeding dimension</code></li></ul><h1 id="1-MHA-Multi-Head-Attention"><a href="#1-MHA-Multi-Head-Attention" class="headerlink" title="1 MHA(Multi Head Attention)"></a>1 MHA(Multi Head Attention)</h1><ul><li>$\textbf{o}_t$ï¼šå½“å‰<strong>t</strong>okençš„æ³¨æ„åŠ›è¾“å‡º</li></ul><p>MHAä½¿æ¯ä¸ªHeadéƒ½æœ‰å¯¹åº”çš„$K$å’Œ$V$ï¼Œæ¨¡å‹å¯¹tokençš„ç†è§£æ•ˆæœæ˜¯æ¯”è¾ƒå¥½çš„ï¼Œè€Œé—®é¢˜åœ¨äºï¼Œè™½ç„¶æœ‰KV Cacheï¼Œä½†æ˜¯éšç€å¥å­åºåˆ—å˜é•¿ï¼ŒKeyå’ŒValueçš„ç¼“å­˜çš„æˆæœ¬å’Œæ¨ç†æ—¶é€šä¿¡çš„çŸ­æ¿ä¼šå˜å¤§ï¼Œä¸‹å›¾çš„è§£é‡Šä¼šæ›´è¯¦ç»†ç‚¹ã€‚<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/MLA/Pasted%20image%2020250322123448.png" alt="ã€Šç¼“å­˜ä¸æ•ˆæœçš„æé™æ‹‰æ‰¯ï¼šä»MHAã€MQAã€GQAåˆ°MLAã€‹ä¸€æ–‡ä¸­å¯¹KV Cacheçš„åˆ†æ"></p><h1 id="2-MQA-Multi-Query-Attention"><a href="#2-MQA-Multi-Query-Attention" class="headerlink" title="2 MQA(Multi Query Attention)"></a>2 MQA(Multi Query Attention)</h1><p>$$\textbf{o}_t=[\textbf{o}_t^{(1)}, \textbf{o}_t^{(2)}, â€¦, \textbf{o}<em>t^{(h)}]$$<br>$$\textbf{o}<em>t^{(s)} = Attention(\textbf{q}<em>t^{(s)}, \textbf{k}</em>{i\leq t}, \textbf{v}</em>{i\leq t}) = \sum^t</em>{i=1}softmax(\dfrac{\textbf{q}_t^{(s)}\textbf{k}_i^T}{\sqrt{d_k}})\textbf{v}_i$$<br>$$\textbf{q}_i^{(s)}=\textbf{x}_i\textbf{W}_q^{(s)}\in \mathbb{R}^{1\times d_k},\ \ \ \ \  \textbf{W}_q^{(s)}\in \mathbb{R}^{d\times d_k}$$<br>$$\textbf{k}_i=\textbf{x}_i\textbf{W}_k\in \mathbb{R}^{1\times d_k},\ \ \ \ \  \textbf{W}_k\in \mathbb{R}^{d\times d_k}$$<br>$$$$\textbf{v}_i=\textbf{x}_i \textbf{W}_q\in \mathbb{R}^{1\times d_v},\ \ \ \ \  \textbf{W}_v\in \mathbb{R}^{d\times d_v}$$</p><ul><li>$\textbf{W}_k$ã€$\textbf{W}_v$ï¼šæ‰€æœ‰<code>head</code>å…±äº«çš„keyã€valueæƒé‡çŸ©é˜µ</li></ul><p>ä¸MHAç›¸æ¯”ï¼Œæ¯ä¸ªHeadéƒ½å…±äº«åŒä¸€ç»„$K$å’Œ$V$ï¼Œ</p><ul><li>æ˜¾å­˜ï¼šå…¶KV Cacheä¸ºMHAçš„$\dfrac{1}{h}$ï¼Œæ˜¯ç›®å‰å¾ˆèŠ‚çœçš„æ–¹æ³•ï¼Œ</li><li>æ•ˆæœï¼šæ ¹æ®ã€Š<a href="https://spaces.ac.cn/archives/10091">ç¼“å­˜ä¸æ•ˆæœçš„æé™æ‹‰æ‰¯ï¼šä»MHAã€MQAã€GQAåˆ°MLA</a>ã€‹æåˆ°çš„ï¼ŒæŸå¤±æ˜¯æœ‰é™çš„ï¼Œå‚æ•°é‡é€šè¿‡åŠ å¤§å…¶ä»–æ¨¡å—çš„è§„æ¨¡æ¥è¡¥è¶³ã€‚</li></ul><h1 id="3-GQA-Grouped-Query-Attention"><a href="#3-GQA-Grouped-Query-Attention" class="headerlink" title="3 GQA(Grouped Query Attention)"></a>3 GQA(Grouped Query Attention)</h1><p>$$\textbf{o}_t=[\textbf{o}_t^{(1)}, \textbf{o}_t^{(2)}, â€¦, \textbf{o}<em>t^{(h)}]$$<br>$$\textbf{o}<em>t^{(s)} = Attention(\textbf{q}<em>t^{(s)}, \textbf{k}</em>{i\leq t}^{(\lceil sg/h \rceil)}, \textbf{v}</em>{i\leq t}^{(\lceil sg/h \rceil)}) = \sum^t</em>{i=1}softmax(\dfrac{\textbf{q}_t^{(s)}\textbf{k}_i^{(\lceil sg/h \rceil)}T}{\sqrt{d_k}})\textbf{v}_i^{(\lceil sg/h \rceil)}$$<br>$$\textbf{q}_i^{(s)}=\textbf{x}_i\textbf{W}_q^{(s)}\in \mathbb{R}^{1\times d_k},\ \ \ \ \  \textbf{W}_q^{(s)}\in \mathbb{R}^{d\times d_k}$$<br>$$\textbf{k}_i^{(\lceil sg/h \rceil)}=\textbf{x}_i\textbf{W}_k^{(\lceil sg/h \rceil)}\in \mathbb{R}^{1\times d_k},\ \ \ \ \  \textbf{W}_k^{(\lceil sg/h \rceil)}\in \mathbb{R}^{d\times d_k}$$<br>$$\textbf{v}_i^{(\lceil sg/h \rceil)}=\textbf{x}_i\textbf{W}_q^{(\lceil sg/h \rceil)}\in \mathbb{R}^{1\times d_v},\ \ \ \ \  \textbf{W}_v^{(\lceil sg/h \rceil)}\in \mathbb{R}^{d\times d_v}$$</p><ul><li>$\lceil Â· \rceil$æ˜¯å‘ä¸Šå–æ•´</li><li>$\textbf{W}_q^{(s)}$ã€$\textbf{W}_k^{(s)}$ã€$\textbf{W}_v^{(s)}$ï¼šåˆ†åˆ«ä¸ºç¬¬$s$ä¸ª<code>head</code>çš„queryã€keyã€valueçš„æƒé‡çŸ©é˜µï¼Œ</li><li>$d_k=d_v=d/h$</li></ul><p>ä½œä¸ºæ˜¾å­˜çš„å‹ç¼©å’Œæ•ˆæœéƒ½åœ¨MHAå’ŒMQAä¹‹é—´çš„ç‰ˆæœ¬ï¼ŒGQAå°†<code>head</code>åˆ†ä¸º$g$ä¸ªç»„($g$å¯ä»¥æ•´é™¤$h$)ï¼Œæ¯ç»„å…±äº«åŒä¸€å¯¹$K$ã€$V$ã€‚å½“$g=1$æ—¶å°±æ˜¯MQAï¼Œ$g=h$æ—¶å°±æ˜¯MHAã€‚å½“$1&lt;g&lt;h$æ—¶ï¼Œæ•ˆæœä¸å¦‚MHAï¼Œæ˜¾å­˜å‹ç¼©æ²¡æœ‰MQAé‚£ä¹ˆçŒ›ï¼Œä½†æ˜¯KV Cacheå‹ç¼©åˆ°MHAçš„$g/h$ï¼Œæ•ˆæœæ¯”MQAå¥½ï¼Œæ˜¯ä¸€ä¸ªæŠ˜ä¸­çš„ç‰ˆæœ¬ã€‚</p><h1 id="4-MLA-Multi-head-Latent-Attention"><a href="#4-MLA-Multi-head-Latent-Attention" class="headerlink" title="4 MLA(Multi-head Latent Attention)"></a>4 MLA(Multi-head Latent Attention)</h1><p>å¯¹KV Cacheåšä½ç§©æŠ•å½±ï¼Œé€šè¿‡æŠ•å½±çŸ©é˜µ$\textbf{W}_c$å°†$\textbf{x}_i$æŠ•å½±ä¸º$\textbf{c}_i$<br><a href="https://spaces.ac.cn/archives/10091">ç¼“å­˜ä¸æ•ˆæœçš„æé™æ‹‰æ‰¯ï¼šä»MHAã€MQAã€GQAåˆ°MLA</a>æ–‡ç« ä¸­è®¤ä¸ºâ€DeepSeek-V2çš„æŠ€æœ¯æŠ¥å‘Šé‡Œæ˜¯ä»ä½ç§©æŠ•å½±çš„è§’åº¦å¼•å…¥MLAçš„â€¦â€¦ç„¶è€Œï¼Œç¬”è€…è®¤ä¸ºä½ç§©æŠ•å½±è¿™ä¸ªè§’åº¦å¹¶ä¸è´´è¿‘æœ¬è´¨ï¼Œå› ä¸ºè¦è¯´ä½ç§©æŠ•å½±çš„è¯ï¼Œäº‹å®ä¸Šåªè¦æˆ‘ä»¬å°†GQAçš„æ‰€æœ‰Kã€Vå åœ¨ä¸€èµ·ï¼Œå°±ä¼šå‘ç°GQAä¹Ÿç›¸å½“äºåœ¨åšä½ç§©æŠ•å½±ï¼š<br>$$[\textbf{k}_i^{(1)}, â€¦,\textbf{k}_i^{(g)}, \textbf{v}_i^{(1)},â€¦,\textbf{v}_i^{(g)}] = \textbf{x}_i[\textbf{W}_k^{(1)},â€¦,\textbf{W}_k^{(g)},\textbf{W}_v^{(1)},â€¦,\textbf{W}_v^{(g)}]$$</p><ul><li>$[\textbf{k}_i^{(1)}, â€¦,\textbf{k}_i^{(g)}, \textbf{v}_i^{(1)},â€¦,\textbf{v}_i^{(g)}] = \textbf{c}_i\in \mathbb{R}^{1\times d_c}$ï¼Œå°†æ‰€æœ‰çš„$\textbf{k}_i^{(s)}$ã€$\textbf{v}_i^{(s)}$æ‹¼åœ¨ä¸€èµ·è®°ä¸º$\textbf{c}_i$ï¼Œ</li><li>$[\textbf{W}_k^{(1)},â€¦,\textbf{W}_k^{(g)},\textbf{W}_v^{(1)},â€¦,\textbf{W}_v^{(g)}] = \textbf{W}_c\in \mathbb{R}^{d\times d_c}$ï¼Œå°†ç›¸åº”çš„æŠ•å½±çŸ©é˜µæ‹¼åœ¨ä¸€èµ·è®°ä¸º$\textbf{W}_c$ï¼Œ</li><li>$d_c=g(d_k+d_v)&lt;d=h(d_k+d_v)$ï¼Œæ‰€ä»¥$\textbf{x}_i$åˆ°$\textbf{c}_i$çš„å˜æ¢å°±æ˜¯ä¸€ä¸ªä½ç§©æŠ•å½±ï¼Œ<br><strong>æ‰€ä»¥ï¼ŒMLAçš„æœ¬è´¨æ”¹è¿›ä¸æ˜¯ä½ç§©æŠ•å½±ï¼Œè€Œæ˜¯ä½ç§©æŠ•å½±ä¹‹åçš„å·¥ä½œ</strong>â€œ</li></ul><h2 id="4-1-MLAçš„æœ€åˆæ„æƒ³"><a href="#4-1-MLAçš„æœ€åˆæ„æƒ³" class="headerlink" title="4.1 MLAçš„æœ€åˆæ„æƒ³"></a>4.1 MLAçš„æœ€åˆæ„æƒ³</h2><p>å¾—åˆ°$\textbf{c}_i$åï¼ŒGQAå°†å…¶å¯¹åŠåˆ†ä¸ºKå’ŒVï¼Œå°†å®ƒä»¬åˆ†åˆ«å‡åˆ†ä¸º$g$ä»½ï¼Œæ¯ä¸€ä»½å¤åˆ¶$h/g$æ¬¡ï¼Œå‡‘å¤Ÿ$h$ä»½Kå’ŒVï¼Œç„¶åå°†å…¶æŠ•å…¥åˆ°è®¡ç®—Attentionå’ŒKV Cacheï¼ŒMLAå¯¹$\textbf{c}_i$ä¸æ˜¯ç®€å•çš„åˆ†å‰²å’Œå¤åˆ¶ï¼Œä»–å¯¹$\textbf{c}_i$åˆè¿›è¡Œäº†ä¸€æ¬¡æŠ•å½±ï¼Œâ€œå¢å¼ºäº†æ¨¡å‹çš„èƒ½åŠ›â€ï¼š<br>$$\textbf{u}_t = \textbf{o}_t\textbf{W}_o,\ \ \ \ \ \textbf{W}_o\in \mathbb{R}^{d\times hd_k}$$</p><ul><li>$\textbf{W}_o$æ˜¯è¾“å‡ºæŠ•å½±çŸ©é˜µï¼Œè¿™é‡Œçš„$hd_k\neq d$<br>$$\textbf{o}_t=[\textbf{o}_t^{(1)}, \textbf{o}_t^{(2)}, â€¦, \textbf{o}<em>t^{(h)}] \in \mathbb{R}^{1\times d}$$<br>$$\textbf{o}<em>t^{(s)} = Attention(\textbf{q}<em>t^{(s)}, \textbf{k}</em>{i\leq t}^{(s)}, \textbf{v}</em>{i\leq t}^{(s)}) = \sum^t</em>{i=1}softmax(\dfrac{\textbf{q}_t^{(s)}\textbf{k}_i^{(s)T}}{\sqrt{d_k}})\textbf{v}_i^{(s)}$$<br>$$\textbf{c}_i=\textbf{x}_i\textbf{W}_c\in\mathbb{R}^{1\times d_c}$$<br>$$\textbf{q}_i^{(s)}=\textbf{x}_i\textbf{W}_q^{(s)}\in \mathbb{R}^{1\times d_k},\ \ \ \ \  \textbf{W}_q^{(s)}\in \mathbb{R}^{d\times d_k}$$<br>$$\textbf{k}<em>i^{(s)}=\textbf{c}<em>i\textbf{W}</em>{Uk}^{(s)}\in \mathbb{R}^{1\times d_k},\ \ \ \ \  \textbf{W}</em>{Uk}^{(s)}\in \mathbb{R}^{d_c\times d_k}$$<br>$$\textbf{v}<em>i^{(s)}=\textbf{c}<em>i\textbf{W}</em>{Uv}^{(s)}\in \mathbb{R}^{1\times d_v},\ \ \ \ \  \textbf{W}</em>{Uv}^{(s)}\in \mathbb{R}^{d_c\times d_v}$$</li><li>$\textbf{W}<em>{Uk}^{(s)}$ã€$\textbf{W}</em>{Uv}^{(s)}$ï¼šåˆ†åˆ«ä¸ºç¬¬$s$ä¸ª<code>head</code>çš„keyã€valueçš„å†æŠ•å½±æƒé‡çŸ©é˜µï¼Œä¸ºäº†â€œå¢å¼ºäº†æ¨¡å‹çš„èƒ½åŠ›â€<br>ç„¶è€Œï¼ŒåŸæœ¬å·²ç»ä½ç§©çš„$\textbf{c}<em>i$åœ¨$\textbf{W}</em>{Uk}^{(s)}$å’Œ$\textbf{W}_{Uv}^{(s)}$ä½œç”¨ä¸‹è¢«up-projectionäº†ï¼Œå³$\textbf{k}_i^{(s)}$å’Œ$\textbf{v}_i^{(s)}$åŸæœ¬çš„<code>head</code>åˆ†ç»„ä¸å­˜åœ¨äº†ï¼Œä¸€ç»„<code>head</code>ä¹‹é—´ä¸å†å…±äº«$K$ã€$V$ï¼Œâ€œå‡ºäºèŠ‚çœè®¡ç®—å’Œé€šä¿¡æˆæœ¬çš„è€ƒè™‘ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šç¼“å­˜çš„æ˜¯æŠ•å½±åçš„$\textbf{k}_i$ã€$\textbf{v}_i$çš„è€Œä¸æ˜¯æŠ•å½±å‰çš„$\textbf{c}_i$æˆ–$\textbf{x}_i$â€ï¼Œæ‰€ä»¥ï¼Œæ­¤åšæ³•çš„KV Cacheä¸MHAæ— å¼‚ï¼Œæ²¡æœ‰æ˜¾å­˜èŠ‚çœçš„ä½œç”¨ã€‚</li></ul><p>è™½ç„¶åœ¨è®­ç»ƒé˜¶æ®µMLAçš„ä¼˜åŒ–ç©ºé—´ä¸å¤§ï¼Œä½†æ˜¯åœ¨æ¨ç†é˜¶æ®µä¸­ï¼š<br>$$\textbf{q}_t^{(s)}\textbf{k}_i^{(s)T}=(\textbf{x}_t\textbf{W}_q^{(s)})\cdot (\textbf{c}<em>i\textbf{W}</em>{Uk}^{(s)})^T=\textbf{x}_t(\textbf{W}<em>q^{(s)}\cdot\textbf{W}</em>{Uk}^{(s)T})\textbf{c}_i^T$$<br>$\textbf{W}<em>q^{(s)}\cdot\textbf{W}</em>{Uk}^{(s)T}$ä½œä¸º$Q$çš„æŠ•å½±çŸ©é˜µï¼ŒK Cacheçš„å†…å®¹å¯ä»¥ä»$\textbf{k}_i$å˜ä¸º$\textbf{c}_i$ï¼›æ ¹æ®$\textbf{v}_i^{(s)}=\textbf{c}<em>i\textbf{W}</em>{Uv}^{(s)}$å’Œ$\textbf{u}_t^{(s)} = \textbf{o}_t^{(s)}\textbf{W}_o^{(s)}$ï¼Œè¾“å‡ºçš„è®¡ç®—è¿‡ç¨‹åŒ…å«$\textbf{c}<em>i\textbf{W}</em>{Uv}\textbf{W}<em>O$ï¼Œé‚£ä¹ˆ$\textbf{W}</em>{Uv}\textbf{W}_O$ä½œä¸º$V$çš„æŠ•å½±çŸ©é˜µï¼Œ$\textbf{v}_i$å¯ä»¥ç”¨$\textbf{c}_i$ä»£æ›¿ï¼Œå³V Cacheçš„å†…å®¹ä»$\textbf{v}_i$ä¹Ÿå˜ä¸º$\textbf{c}_i$ã€‚<br>é‚£ä¹ˆKV Cacheçš„å†…å®¹å°±æ˜¯$\textbf{c}_i$ï¼Œå®ƒä¸$(s)$æ— å…³ ï¼Œæ˜¯æ‰€æœ‰<code>head</code>å…±äº«çš„ï¼Œæ§åˆ¶å¥½$g/h$çš„å€¼ï¼Œåœ¨æ¨ç†é˜¶æ®µè¾¾åˆ°GQAæˆ–MQAçš„æ•ˆæœã€‚<br>å®é™…ä¸Šï¼Œå› ä¸ºup-projectionæé«˜äº†æ¨¡å‹çš„æ•ˆæœï¼ŒåŒæ—¶åœ¨æ¨ç†é˜¶æ®µKV Cacheæ•ˆæœä¸GQAç›¸åŒ($1&lt;g&lt;h$)ã€‚åœ¨æ•ˆæœå’Œæ˜¾å­˜çš„å¹³è¡¡ä¸‹ï¼Œâ€œå¦‚æœæˆ‘ä»¬åªéœ€è¦è·ŸGQAç›¸è¿‘çš„èƒ½åŠ›ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯å°±å¯ä»¥å†æ¬¡å‡å°‘KV Cacheäº†ï¼Ÿæ¢è¨€ä¹‹ï¼Œ$d_c$æ²¡å¿…è¦å–$g(dk+dv)$ï¼Œè€Œæ˜¯å–æ›´å°çš„å€¼ï¼Œä»è€Œè¿›ä¸€æ­¥å‹ç¼©KV Cacheï¼Œè¿™å°±æ˜¯MLAçš„æ ¸å¿ƒæ€æƒ³â€ã€‚</p><h2 id="4-2-RoPEçš„å…¼å®¹"><a href="#4-2-RoPEçš„å…¼å®¹" class="headerlink" title="4.2 RoPEçš„å…¼å®¹"></a>4.2 RoPEçš„å…¼å®¹</h2><p>RoPEä¸ç»å¯¹ä½ç½®ç›¸å…³ï¼Œé€šè¿‡ç»å¯¹ä½ç½®è®¡ç®—ä¸¤ä¸ªtokenä¹‹é—´çš„ç›¸å¯¹ä½ç½®ä¿¡æ¯ï¼š<br>$$\textbf{R}_m\textbf{R}<em>n^T=\textbf{R}</em>{m-n}$$<br>MLAåŠ ä¸ŠRoPEä¹‹åï¼š<br>$$\textbf{q}_i^{(s)}=x_iW_q^{(s)}\textbf{R}_i, \ \ \ \ \ \textbf{k}_i^{(s)}=\textbf{c}<em>i\textbf{W}</em>{Uk}^{(s)}\textbf{R}_i$$<br>$$\textbf{q}_t^{(s)}\textbf{k}_i^{(s)T}=(x_tW_q^{(s)}\textbf{R}<em>t)(\textbf{c}<em>i\textbf{W}</em>{Uk}^{(s)}\textbf{R}<em>i)^T=x_tW_q^{(s)}\textbf{R}</em>{t-i}{W}</em>{Uk}^{(s)T}\textbf{c}_i^T$$<br>ä¸èƒ½å›ºå®š$\textbf{W}<em>q^{(s)}\cdot\textbf{W}</em>{Uk}^{(s)T}$å€¼ä½œä¸º$Q$çš„æŠ•å½±çŸ©é˜µã€‚<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/MLA/Pasted%20image%2020250323150831.png" alt="ã€Šç¼“å­˜ä¸æ•ˆæœçš„æé™æ‹‰æ‰¯ï¼šä»MHAã€MQAã€GQAåˆ°MLAã€‹ä¸€æ–‡ä¸­æ¢è®¨çš„å…¶ä»–æ–¹æ³•"><br>åæ¥è§£å†³åŠæ³•ä¸ºæ¯ä¸ª<code>head</code>çš„$\textbf{Q}$å’Œ$\textbf{K}$æ–°å¢$d_r$ä¸ªç»´åº¦æ¥æ·»åŠ RoPEçš„ä¿¡æ¯ï¼Œå…¶ä¸­$\textbf{K}$æ–°å¢çš„ä¿¡æ¯ç”±æ¯ä¸ª<code>head</code>å…±äº«<br>$$\textbf{u}_t = \textbf{o}_t\textbf{W}_o,\ \ \ \ \ \textbf{W}_o\in \mathbb{R}^{d\times hd_k}$$<br>$$\textbf{o}_t=[\textbf{o}_t^{(1)}, \textbf{o}_t^{(2)}, â€¦, \textbf{o}<em>t^{(h)}] \in \mathbb{R}^{1\times d}$$<br>$$\textbf{o}<em>t^{(s)} = Attention(\textbf{q}<em>t^{(s)}, \textbf{k}</em>{i\leq t}^{(s)}, \textbf{v}</em>{i\leq t}^{(s)}) = \sum^t</em>{i=1}softmax(\dfrac{\textbf{q}_t^{(s)}\textbf{k}_i^{(s)T}}{\sqrt{d_k+d_r}})\textbf{v}_i^{(s)}$$</p><ul><li>dot-productçš„scalingå˜æˆäº†$\sqrt{d_k+d_r}$<br>$$RoPE(\textbf{x}<em>i\textbf{W}</em>{qR}^{(s)})=\textbf{x}<em>i\textbf{W}</em>{qR}^{(s)}\textbf{R}<em>i,\ \ \ \ \ \textbf{W}</em>{qR}^{(s)}\in \mathbb{R}^{d\times d_r}$$<br>$$RoPE(\textbf{x}<em>i\textbf{W}</em>{kR})=\textbf{x}<em>i\textbf{W}</em>{kR}\textbf{R}<em>i,\ \ \ \ \ \textbf{W}</em>{kR}\in \mathbb{R}^{d\times d_r}$$<br>$$\textbf{c}_i=\textbf{x}_i\textbf{W}_c\in\mathbb{R}^{1\times d_c}$$<br>$$\textbf{q}_i^{(s)}=[\textbf{x}_i\textbf{W}_q^{(s)}, \textbf{x}<em>i\textbf{W}</em>{qR}^{(s)}\textbf{R}_i]\in \mathbb{R}^{1\times [d_k+d_r]},\ \ \ \ \  \textbf{W}_q^{(s)}\in \mathbb{R}^{d\times d_r}$$<br>$$\textbf{k}<em>i^{(s)}=[\textbf{c}<em>i\textbf{W}</em>{Uk}^{(s)}, \textbf{x}<em>i\textbf{W}</em>{kR}\textbf{R}<em>i]\in \mathbb{R}^{1\times [d_k+d_r]},\ \ \ \ \  \textbf{W}</em>{Uk}^{(s)}\in \mathbb{R}^{d\times d_r}$$<br>$$\textbf{v}<em>i^{(s)}=\textbf{c}<em>i\textbf{W}</em>{Uv}^{(s)}\in \mathbb{R}^{1\times d_v},\ \ \ \ \  \textbf{W}</em>{Uv}^{(s)}\in \mathbb{R}^{d_c\times d_v}$$<br>ğŸ‘‡å¯ä»¥çœ‹åˆ°ä¿ç•™äº†$Q$çš„å›ºå®šæŠ•å½±$\textbf{W}<em>q^{(s)}\cdot\textbf{W}</em>{Uk}^{(s)T}$å’Œç›¸å¯¹ä½ç½®ä¿¡æ¯$\textbf{R}</em>{t-i}$<br>$$\textbf{q}_t^{(s)}\textbf{k}_i^{(s)T}=(\textbf{x}_t\textbf{W}_q^{(s)})(\textbf{c}<em>i\textbf{W}</em>{Uk}^{(s)})^T+(\textbf{x}<em>t\textbf{W}</em>{qR}^{(s)}\textbf{R}_t)(\textbf{x}<em>i\textbf{W}</em>{kR}\textbf{R}_i)^T$$<br>$$=\textbf{x}<em>t(\textbf{W}<em>q^{(s)}\cdot\textbf{W}</em>{Uk}^{(s)T})\textbf{c}<em>i^T+\textbf{x}<em>t\textbf{W}</em>{qR}^{(s)}(\textbf{R}</em>{t-i})\textbf{W}</em>{kR}^T\textbf{x}_i^T$$</li></ul><h2 id="4-3-MLAæœ€ç»ˆç‰ˆæœ¬"><a href="#4-3-MLAæœ€ç»ˆç‰ˆæœ¬" class="headerlink" title="4.3 MLAæœ€ç»ˆç‰ˆæœ¬"></a>4.3 MLAæœ€ç»ˆç‰ˆæœ¬</h2><p>â€œin order to reduce the activation memory during trainingâ€ï¼Œæœ€åMLAåœ¨è®­ç»ƒé˜¶æ®µå¯¹$Q$çš„è¾“å…¥$\textbf{x}_i$ä¹Ÿåšäº†ä½ç§©æŠ•å½±ï¼Œå³$$\textbf{c}<em>iâ€™=\textbf{x}<em>i\textbf{W}</em>{Dq}\in \mathbb{R}^{1\times d_câ€™},\ \ \ \ \ \textbf{W}</em>{Dq}\in \mathbb{R}^{d\times d_câ€™}$$$$\textbf{q}<em>i^{(s)}=[\textbf{c}<em>iâ€™\textbf{W}</em>{Uq}^{(s)}, \textbf{c}<em>iâ€™\textbf{W}</em>{qR}^{(s)}\textbf{R}<em>i]\in \mathbb{R}^{1\times [d_k+d_r]},\ \ \ \ \  \textbf{W}</em>{Uq}^{(s)}\in \mathbb{R}^{d_câ€™\times d_k},\textbf{W}</em>{qR}^{(s)}\in \mathbb{R}^{d_câ€™\times d_k}$$æœ€ç»ˆç‰ˆæœ¬çš„è®­ç»ƒé˜¶æ®µï¼š<br>$$\textbf{u}_t = \textbf{o}_t\textbf{W}_o,\ \ \ \ \ \textbf{W}_o\in \mathbb{R}^{d\times hd_k}$$<br>$$\textbf{o}_t=[\textbf{o}_t^{(1)}, \textbf{o}_t^{(2)}, â€¦, \textbf{o}<em>t^{(h)}] \in \mathbb{R}^{1\times d}$$<br>$$\textbf{o}<em>t^{(s)} = Attention(\textbf{q}<em>t^{(s)}, \textbf{k}</em>{i\leq t}^{(s)}, \textbf{v}</em>{i\leq t}^{(s)}) = \sum^t</em>{i=1}softmax(\dfrac{\textbf{q}_t^{(s)}\textbf{k}_i^{(s)T}}{\sqrt{d_k+d_r}})\textbf{v}_i^{(s)}$$<br>$$\textbf{c}_i=\textbf{x}_i\textbf{W}_c\in\mathbb{R}^{d_c},\ \ \ \ \ \textbf{W}_c\in\mathbb{R}^{d\times d_c}$$<br>$$\textbf{c}<em>iâ€™=\textbf{x}<em>i\textbf{W}</em>{Dq}\in \mathbb{R}^{1\times d_câ€™},\ \ \ \ \ \textbf{W}</em>{Dq}\in \mathbb{R}^{d\times d_câ€™}$$<br>$$\textbf{q}<em>i^{(s)}=[\textbf{c}<em>iâ€™\textbf{W}</em>{Uq}^{(s)}, \textbf{c}<em>iâ€™\textbf{W}</em>{qR}^{(s)}\textbf{R}<em>i]\in \mathbb{R}^{1\times [d_k+d_r]},\ \ \ \ \  \textbf{W}</em>{Uq}^{(s)}\in \mathbb{R}^{d_câ€™\times d_k},\textbf{W}</em>{qR}^{(s)}\in \mathbb{R}^{d_câ€™\times d_k}$$<br>$$\textbf{k}_i^{(s)}=[\textbf{c}<em>i\textbf{W}</em>{Uk}^{(s)}, \textbf{x}<em>i\textbf{W}</em>{kR}\textbf{R}<em>i]\in \mathbb{R}^{1\times [d_k+d_r]},\ \ \ \ \  \textbf{W}</em>{Uk}^{(s)}\in \mathbb{R}^{d_c\times d_k}$$<br>$$\textbf{v}<em>i^{(s)}=\textbf{c}<em>i\textbf{W}</em>{Uv}^{(s)}\in \mathbb{R}^{1\times d_v},\ \ \ \ \  \textbf{W}</em>{Uv}^{(s)}\in \mathbb{R}^{d_c\times d_v}$$<br>$$\textbf{q}_t^{(s)}\textbf{k}_i^{(s)T}=(\textbf{c}â€™<em>t\textbf{W}</em>{Uq}^{(s)})(\textbf{c}<em>i\textbf{W}</em>{Uk}^{(s)})^T+(\textbf{c}<em>t\textbf{W}</em>{qR}^{(s)}\textbf{R}<em>t)(\textbf{x}<em>i\textbf{W}</em>{kR}\textbf{R}<em>i)^T$$<br>$$=\textbf{c}â€™<em>t(\textbf{W}</em>{Uq}^{(s)}\cdot\textbf{W}</em>{Uk}^{(s)T})\textbf{c}<em>i^T+\textbf{c}â€™<em>t\textbf{W}</em>{qR}^{(s)}(\textbf{R}</em>{t-i})\textbf{W}</em>{kR}^T\textbf{x}_i^T$$</p><p>æœ€ç»ˆç‰ˆæœ¬çš„æ¨ç†é˜¶æ®µï¼š<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/MLA/Pasted%20image%2020250323222539.png">$$\textbf{u}_t = [\textbf{o}_t^{(1)}\textbf{W}_o^{â€˜(1)},\textbf{o}_t^{(2)}\textbf{W}_o^{â€˜(2)},â€¦,\textbf{o}_t^{(h)}\textbf{W}_o^{â€˜(h)}]$$<br>$$\textbf{W}â€™_o=[\textbf{W}_o^{â€˜(1)},\textbf{W}_o^{â€˜(2)},â€¦,\textbf{W}_o^{â€˜(h)}],\ \ \ \ \ \textbf{W}â€™_o\in \mathbb{R}^{d\times hd_k}$$</p><ul><li>$\textbf{W}â€™_o$èåˆäº†$\textbf{W}_o$å’Œ$\textbf{W}<em>v^{(g)}$å¾—åˆ°çš„ï¼Œåœ¨æ¨ç†é˜¶æ®µæ˜¯å›ºå®šå€¼<br>$$\textbf{o}<em>t^{(s)} = Attention(\textbf{q}<em>t^{(s)}, \textbf{k}</em>{i\leq t}, \textbf{v}</em>{i\leq t}) = \sum^t</em>{i=1}softmax(\dfrac{\textbf{q}_t\textbf{k}_i^T}{\sqrt{d_k+d_r}})\textbf{v}_i,\ \ \ \ \ \textbf{v}_i=\textbf{c}_i\in \mathbb{R}^{1\times d_c}$$<br>$$\textbf{c}_i=\textbf{x}_i\textbf{W}<em>c\in\mathbb{R}^{d_c},\ \ \ \ \ \textbf{W}<em>c\in\mathbb{R}^{d\times d_c}$$<br>$$\textbf{c}<em>iâ€™=\textbf{x}<em>i\textbf{W}</em>{Dq}\in \mathbb{R}^{1\times d_câ€™},\ \ \ \ \ \textbf{W}</em>{Dq}\in \mathbb{R}^{d\times d_câ€™}$$<br>$$\textbf{q}<em>i^{(s)}=[\textbf{c}<em>iâ€™\textbf{W}</em>{Uq}^{(s)}\textbf{W}</em>{Uk}^{(s)T}, \textbf{c}<em>iâ€™\textbf{W}</em>{qR}^{(s)}\textbf{R}<em>i]\in \mathbb{R}^{1\times [d_c+d_r]},\ \ \ \ \  \textbf{W}</em>{Uq}^{(s)}\in \mathbb{R}^{d_câ€™\times d_k},\textbf{W}</em>{qR}^{(s)}\in \mathbb{R}^{d_câ€™\times d_k},\textbf{W}</em>{Uk}^{(s)}\in \mathbb{R}^{d_c\times d_k}$$</li><li>$\textbf{W}<em>{Uq}^{(s)}\cdot\textbf{W}</em>{Uk}^{(s)T}$ä½œä¸º$Q$çš„æŠ•å½±çŸ©é˜µ<br>$$\textbf{k}_i=[\textbf{c}_i, \textbf{x}<em>i\textbf{W}</em>{kR}\textbf{R}_i]\in \mathbb{R}^{1\times [d_c+d_r]}$$</li><li>$\textbf{k}$åœ¨å­˜å‚¨æ—¶ä¸éœ€è¦è€ƒè™‘ä¸åŒ<code>head</code></li></ul><p>å¯¹äºå•ä¸ªtokenï¼š</p><ul><li>MLAæ¨ç†æ—¶éœ€è¦çš„ç¼“å­˜ï¼š<ul><li>$\textbf{v}_i=\textbf{c}_i\in \mathbb{R}^{1\times d_c}$</li><li>$\textbf{k}_=[\textbf{c}_i, \textbf{x}<em>i\textbf{W}</em>{kR}\textbf{R}_i]\in \mathbb{R}^{1\times [d_c+d_r]}$ï¼Œ$d_c+d_r=512+64=576$</li></ul></li><li>MHAç‰ˆæœ¬çš„ç¼“å­˜ï¼š$2\times d_k\times h=2\times 128\times128=32768$</li></ul><p>ğŸ‘‡å›¾æ€æƒ³æ¥æº<a href="https://www.bilibili.com/video/BV1BYXRYWEMj?spm_id_from=333.1245.0.0">DeepSeek-v2 MLA åŸç†è®²è§£</a><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/MLA/de420aa56bd3f8b22e26f54c9ee1f37.jpg" alt="MLAæŠ•å½±è¿‡ç¨‹(ç²—ç•¥)"><br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/MLA/Pasted%20image%2020250323194944.png" alt="ã€Šç¼“å­˜ä¸æ•ˆæœçš„æé™æ‹‰æ‰¯ï¼šä»MHAã€MQAã€GQAåˆ°MLAã€‹ä¸€æ–‡ä¸­å¯¹MLAè®¡ç®—é‡å¢åŠ å’Œæ•ˆç‡çš„è®¨è®º"></p><ul><li>åœ¨ç¬¬ä¸€ä¸ªtokenç”Ÿæˆé˜¶æ®µéœ€è¦å¹¶è¡Œå¤„ç†è¾“å…¥çš„æ‰€æœ‰tokenï¼Œè™½ç„¶è®¡ç®—é‡å¢åŠ ï¼Œä½†æ˜¯KV Cacheç›¸åº”å‡å°‘ï¼Œæ— åŠŸæ— è¿‡ã€‚</li><li>åœ¨åç»­æ¯ä¸ªtokenç”Ÿæˆé˜¶æ®µï¼Œæ¯æ¬¡åªè¾“å…¥ä¸€ä¸ªï¼Œå¢åŠ çš„è®¡ç®—é‡ä¸ä¼šè¢«æ”¾å¤§ï¼Œæ¯æ¬¡éœ€è¦ä¼ è¾“çš„KVç›¸æ¯”åŸæ¥æ˜¯å‡å°‘çš„ã€‚</li></ul><h1 id="5-å¯¹æ¯”"><a href="#5-å¯¹æ¯”" class="headerlink" title="5 å¯¹æ¯”"></a>5 å¯¹æ¯”</h1><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/MLA/Pasted%20image%2020250323164232.png"></p><ul><li>$d_câ€™=1536$</li><li>$d_h=d_k=d_v=128,h=128,d=d_h\times h$</li><li>$d_c=4d_h=4\times128=512$</li><li>$d_r=\dfrac{d_h}{2}=128\div2=64$</li><li>DeepSeek-V2çš„KV Cache($=576$)ç›¸å½“äºGQAçš„$g=2.25$æ—¶çš„å¤§å°(GQAä¸€ä¸ªç»„çš„å¤§å°$=256$)</li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Multi-head Latent Attentionæ¨¡å‹ç†è§£</title>
      <link href="/2025/03/19/mla/"/>
      <url>/2025/03/19/mla/</url>
      
        <content type="html"><![CDATA[<p><a href="https://arxiv.org/abs/2405.04434">DeepSeek-V2: A Strong, Economical, and Efficient Mixture-of-Experts Language Model</a></p><p>ç›¸å…³è®ºæ–‡ï¼š<a href="https://arxiv.org/abs/2405.04434">DeepSeek-V2: A Strong, Economical, and Efficient Mixture-of-Experts Language Model</a></p><p>æœ¬æ–‡å†…å®¹å›´ç»•å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶çš„æ¼”å˜è¿‡ç¨‹ï¼Œç€é‡è®°å½•MLAçš„è®¾è®¡åŸç†ï¼Œå¯¹<a href="https://spaces.ac.cn/archives/10091">ç¼“å­˜ä¸æ•ˆæœçš„æé™æ‹‰æ‰¯ï¼šä»MHAã€MQAã€GQAåˆ°MLA</a>ã€<a href="https://www.bilibili.com/video/BV1BYXRYWEMj?spm_id_from=333.1245.0.0">DeepSeek-v2 MLA åŸç†è®²è§£</a>çš„å†…å®¹è¿›è¡Œæ•´åˆä¸åˆ†æï¼Œåœ¨æˆ‘ç†è§£MLAçš„è¿‡ç¨‹ä¸­ï¼Œä»–ä»¬ç»™äºˆäº†å¾ˆå¥½çš„å¯è¿ªï¼</p><p>å‡è®¾æ‰€æœ‰è¾“å…¥éƒ½ä¸ºè¡Œå‘é‡ï¼Œè¾“å…¥åºåˆ—ä¸º$\textbf{x}_1, \textbf{x}_2, â€¦, \textbf{x}_l$ï¼Œå…¶ä¸­$\textbf{x}_i\in \mathbb{R}^{1\times d}$</p><ul><li>$l$ï¼štokenæ•°é‡</li><li>$d$ï¼š<code>embdeding dimension</code></li></ul><h1 id="1-MHA-Multi-Head-Attention"><a href="#1-MHA-Multi-Head-Attention" class="headerlink" title="1 MHA(Multi Head Attention)"></a>1 MHA(Multi Head Attention)</h1><p>$$\textbf{o}_t=[\textbf{o}_t^{(1)}, \textbf{o}_t^{(2)}, â€¦, \textbf{o}_t^{(h)}]$$</p><ul><li>$\textbf{o}<em>t$ï¼šå½“å‰<strong>t</strong>okençš„æ³¨æ„åŠ›è¾“å‡º<br>$$\textbf{o}<em>t^{(s)} = Attention(\textbf{q}<em>t^{(s)}, \textbf{k}</em>{i\leq t}^{(s)}, \textbf{v}</em>{i\leq t}^{(s)}) = \sum^t</em>{i=1}softmax(\dfrac{\textbf{q}_t^{(s)}\textbf{k}_i^{(s)T}}{\sqrt{d_k}})\textbf{v}_i^{(s)}$$</li><li>$\textbf{o}_t^{(s)}$ï¼šå½“å‰tokençš„ç¬¬$s$ä¸ª<code>head</code>çš„æ³¨æ„åŠ›è¾“å‡ºï¼Œ$h$ ä¸ª<code>head</code>æ‹¼æ¥å¾—åˆ°$O_t$ï¼Œå…¶ä¸­ï¼š<br>$$\textbf{q}_i^{(s)}=\textbf{x}_i\textbf{W}_q^{(s)}\in \mathbb{R}^{1\times d_k},\ \ \ \ \  \textbf{W}_q^{(s)}\in \mathbb{R}^{d\times d_k}$$<br>$$\textbf{k}_i^{(s)}=\textbf{x}_i\textbf{W}_k^{(s)}\in \mathbb{R}^{1\times d_k},\ \ \ \ \  \textbf{W}_k^{(s)}\in \mathbb{R}^{d\times d_k}$$<br>$$\textbf{v}_i^{(s)}=\textbf{x}_i\textbf{W}_v^{(s)}\in \mathbb{R}^{1\times d_v},\ \ \ \ \  \textbf{W}_v^{(s)}\in \mathbb{R}^{d\times d_v}$$</li><li>$\textbf{W}_q^{(s)}$ã€$\textbf{W}_k^{(s)}$ã€$\textbf{W}_v^{(s)}$ï¼šåˆ†åˆ«ä¸ºç¬¬$s$ä¸ª<code>head</code>çš„queryã€keyã€valueçš„æƒé‡çŸ©é˜µï¼Œ</li><li>$d_k=d_v=d/h$</li></ul><p>MHAä½¿æ¯ä¸ªHeadéƒ½æœ‰å¯¹åº”çš„$K$å’Œ$V$ï¼Œæ¨¡å‹å¯¹tokençš„ç†è§£æ•ˆæœæ˜¯æ¯”è¾ƒå¥½çš„ï¼Œè€Œé—®é¢˜åœ¨äºï¼Œè™½ç„¶æœ‰KV Cacheï¼Œä½†æ˜¯éšç€å¥å­åºåˆ—å˜é•¿ï¼ŒKeyå’ŒValueçš„ç¼“å­˜çš„æˆæœ¬å’Œæ¨ç†æ—¶é€šä¿¡çš„çŸ­æ¿ä¼šå˜å¤§ï¼Œä¸‹å›¾çš„è§£é‡Šä¼šæ›´è¯¦ç»†ç‚¹ã€‚<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/MLA/Pasted%20image%2020250322123448.png" alt="ã€Šç¼“å­˜ä¸æ•ˆæœçš„æé™æ‹‰æ‰¯ï¼šä»MHAã€MQAã€GQAåˆ°MLAã€‹ä¸€æ–‡ä¸­å¯¹KV Cacheçš„åˆ†æ"></p><h1 id="2-MQA-Multi-Query-Attention"><a href="#2-MQA-Multi-Query-Attention" class="headerlink" title="2 MQA(Multi Query Attention)"></a>2 MQA(Multi Query Attention)</h1><p>$$\textbf{o}_t=[\textbf{o}_t^{(1)}, \textbf{o}_t^{(2)}, â€¦, \textbf{o}<em>t^{(h)}]$$<br>$$\textbf{o}<em>t^{(s)} = Attention(\textbf{q}<em>t^{(s)}, \textbf{k}</em>{i\leq t}, \textbf{v}</em>{i\leq t}) = \sum^t</em>{i=1}softmax(\dfrac{\textbf{q}_t^{(s)}\textbf{k}_i^T}{\sqrt{d_k}})\textbf{v}_i$$<br>$$\textbf{q}_i^{(s)}=\textbf{x}_i\textbf{W}_q^{(s)}\in \mathbb{R}^{1\times d_k},\ \ \ \ \  \textbf{W}_q^{(s)}\in \mathbb{R}^{d\times d_k}$$<br>$$\textbf{k}_i=\textbf{x}_i\textbf{W}_k\in \mathbb{R}^{1\times d_k},\ \ \ \ \  \textbf{W}_k\in \mathbb{R}^{d\times d_k}$$<br>$$\textbf{v}_i=\textbf{x}_i\textbf{W}_q\in \mathbb{R}^{1\times d_v},\ \ \ \ \  \textbf{W}_v\in \mathbb{R}^{d\times d_v}$$</p><ul><li>$\textbf{W}_k$ã€$\textbf{W}_v$ï¼šæ‰€æœ‰<code>head</code>å…±äº«çš„keyã€valueæƒé‡çŸ©é˜µ</li></ul><p>ä¸MHAç›¸æ¯”ï¼Œæ¯ä¸ªHeadéƒ½å…±äº«åŒä¸€ç»„$K$å’Œ$V$ï¼Œ</p><ul><li>æ˜¾å­˜ï¼šå…¶KV Cacheä¸ºMHAçš„$\dfrac{1}{h}$ï¼Œæ˜¯ç›®å‰å¾ˆèŠ‚çœçš„æ–¹æ³•ï¼Œ</li><li>æ•ˆæœï¼šæ ¹æ®ã€Š<a href="https://spaces.ac.cn/archives/10091">ç¼“å­˜ä¸æ•ˆæœçš„æé™æ‹‰æ‰¯ï¼šä»MHAã€MQAã€GQAåˆ°MLA</a>ã€‹æåˆ°çš„ï¼ŒæŸå¤±æ˜¯æœ‰é™çš„ï¼Œå‚æ•°é‡é€šè¿‡åŠ å¤§å…¶ä»–æ¨¡å—çš„è§„æ¨¡æ¥è¡¥è¶³ã€‚</li></ul><h1 id="3-GQA-Grouped-Query-Attention"><a href="#3-GQA-Grouped-Query-Attention" class="headerlink" title="3 GQA(Grouped Query Attention)"></a>3 GQA(Grouped Query Attention)</h1><p>$$\textbf{o}_t=[\textbf{o}_t^{(1)}, \textbf{o}_t^{(2)}, â€¦, \textbf{o}<em>t^{(h)}]$$<br>$$\textbf{o}<em>t^{(s)} = Attention(\textbf{q}<em>t^{(s)}, \textbf{k}</em>{i\leq t}^{(\lceil sg/h \rceil)}, \textbf{v}</em>{i\leq t}^{(\lceil sg/h \rceil)}) = \sum^t</em>{i=1}softmax(\dfrac{\textbf{q}_t^{(s)}\textbf{k}_i^{(\lceil sg/h \rceil)}T}{\sqrt{d_k}})\textbf{v}_i^{(\lceil sg/h \rceil)}$$<br>$$\textbf{q}_i^{(s)}=\textbf{x}_i\textbf{W}_q^{(s)}\in \mathbb{R}^{1\times d_k},\ \ \ \ \  \textbf{W}_q^{(s)}\in \mathbb{R}^{d\times d_k}$$<br>$$\textbf{k}_i^{(\lceil sg/h \rceil)}=\textbf{x}_i\textbf{W}_k^{(\lceil sg/h \rceil)}\in \mathbb{R}^{1\times d_k},\ \ \ \ \  \textbf{W}_k^{(\lceil sg/h \rceil)}\in \mathbb{R}^{d\times d_k}$$<br>$$\textbf{v}_i^{(\lceil sg/h \rceil)}=\textbf{x}_i\textbf{W}_q^{(\lceil sg/h \rceil)}\in \mathbb{R}^{1\times d_v},\ \ \ \ \  \textbf{W}_v^{(\lceil sg/h \rceil)}\in \mathbb{R}^{d\times d_v}$$</p><ul><li>$\lceil Â· \rceil$æ˜¯å‘ä¸Šå–æ•´</li><li>$\textbf{W}_q^{(s)}$ã€$\textbf{W}_k^{(s)}$ã€$\textbf{W}_v^{(s)}$ï¼šåˆ†åˆ«ä¸ºç¬¬$s$ä¸ª<code>head</code>çš„queryã€keyã€valueçš„æƒé‡çŸ©é˜µï¼Œ</li><li>$d_k=d_v=d/h$</li></ul><p>ä½œä¸ºæ˜¾å­˜çš„å‹ç¼©å’Œæ•ˆæœéƒ½åœ¨MHAå’ŒMQAä¹‹é—´çš„ç‰ˆæœ¬ï¼ŒGQAå°†<code>head</code>åˆ†ä¸º$g$ä¸ªç»„($g$å¯ä»¥æ•´é™¤$h$)ï¼Œæ¯ç»„å…±äº«åŒä¸€å¯¹$K$ã€$V$ã€‚å½“$g=1$æ—¶å°±æ˜¯MQAï¼Œ$g=h$æ—¶å°±æ˜¯MHAã€‚å½“$1&lt;g&lt;h$æ—¶ï¼Œæ•ˆæœä¸å¦‚MHAï¼Œæ˜¾å­˜å‹ç¼©æ²¡æœ‰MQAé‚£ä¹ˆçŒ›ï¼Œä½†æ˜¯KV Cacheå‹ç¼©åˆ°MHAçš„$g/h$ï¼Œæ•ˆæœæ¯”MQAå¥½ï¼Œæ˜¯ä¸€ä¸ªæŠ˜ä¸­çš„ç‰ˆæœ¬ã€‚</p><h1 id="4-MLA-Multi-head-Latent-Attention"><a href="#4-MLA-Multi-head-Latent-Attention" class="headerlink" title="4 MLA(Multi-head Latent Attention)"></a>4 MLA(Multi-head Latent Attention)</h1><p>å¯¹KV Cacheåšä½ç§©æŠ•å½±ï¼Œé€šè¿‡æŠ•å½±çŸ©é˜µ$\textbf{W}_c$å°†$\textbf{x}_i$æŠ•å½±ä¸º$\textbf{c}_i$<br><a href="https://spaces.ac.cn/archives/10091">ç¼“å­˜ä¸æ•ˆæœçš„æé™æ‹‰æ‰¯ï¼šä»MHAã€MQAã€GQAåˆ°MLA</a>æ–‡ç« ä¸­è®¤ä¸ºâ€DeepSeek-V2çš„æŠ€æœ¯æŠ¥å‘Šé‡Œæ˜¯ä»ä½ç§©æŠ•å½±çš„è§’åº¦å¼•å…¥MLAçš„â€¦â€¦ç„¶è€Œï¼Œç¬”è€…è®¤ä¸ºä½ç§©æŠ•å½±è¿™ä¸ªè§’åº¦å¹¶ä¸è´´è¿‘æœ¬è´¨ï¼Œå› ä¸ºè¦è¯´ä½ç§©æŠ•å½±çš„è¯ï¼Œäº‹å®ä¸Šåªè¦æˆ‘ä»¬å°†GQAçš„æ‰€æœ‰Kã€Vå åœ¨ä¸€èµ·ï¼Œå°±ä¼šå‘ç°GQAä¹Ÿç›¸å½“äºåœ¨åšä½ç§©æŠ•å½±ï¼š<br>$$[\textbf{k}_i^{(1)}, â€¦,\textbf{k}_i^{(g)}, \textbf{v}_i^{(1)},â€¦,\textbf{v}_i^{(g)}] = \textbf{x}_i[\textbf{W}_k^{(1)},â€¦,\textbf{W}_k^{(g)},\textbf{W}_v^{(1)},â€¦,\textbf{W}_v^{(g)}]$$</p><ul><li>$[\textbf{k}_i^{(1)}, â€¦,\textbf{k}_i^{(g)}, \textbf{v}_i^{(1)},â€¦,\textbf{v}_i^{(g)}] = \textbf{c}_i\in \mathbb{R}^{1\times d_c}$ï¼Œå°†æ‰€æœ‰çš„$\textbf{k}_i^{(s)}$ã€$\textbf{v}_i^{(s)}$æ‹¼åœ¨ä¸€èµ·è®°ä¸º$\textbf{c}_i$ï¼Œ</li><li>$[\textbf{W}_k^{(1)},â€¦,\textbf{W}_k^{(g)},\textbf{W}_v^{(1)},â€¦,\textbf{W}_v^{(g)}] = \textbf{W}_c\in \mathbb{R}^{d\times d_c}$ï¼Œå°†ç›¸åº”çš„æŠ•å½±çŸ©é˜µæ‹¼åœ¨ä¸€èµ·è®°ä¸º$\textbf{W}_c$ï¼Œ</li><li>$d_c=g(d_k+d_v)&lt;d=h(d_k+d_v)$ï¼Œæ‰€ä»¥$\textbf{x}_i$åˆ°$\textbf{c}_i$çš„å˜æ¢å°±æ˜¯ä¸€ä¸ªä½ç§©æŠ•å½±ï¼Œ<br><strong>æ‰€ä»¥ï¼ŒMLAçš„æœ¬è´¨æ”¹è¿›ä¸æ˜¯ä½ç§©æŠ•å½±ï¼Œè€Œæ˜¯ä½ç§©æŠ•å½±ä¹‹åçš„å·¥ä½œ</strong>â€œ</li></ul><h2 id="4-1-MLAçš„æœ€åˆæ„æƒ³"><a href="#4-1-MLAçš„æœ€åˆæ„æƒ³" class="headerlink" title="4.1 MLAçš„æœ€åˆæ„æƒ³"></a>4.1 MLAçš„æœ€åˆæ„æƒ³</h2><p>å¾—åˆ°$\textbf{c}_i$åï¼ŒGQAå°†å…¶å¯¹åŠåˆ†ä¸ºKå’ŒVï¼Œå°†å®ƒä»¬åˆ†åˆ«å‡åˆ†ä¸º$g$ä»½ï¼Œæ¯ä¸€ä»½å¤åˆ¶$h/g$æ¬¡ï¼Œå‡‘å¤Ÿ$h$ä»½Kå’ŒVï¼Œç„¶åå°†å…¶æŠ•å…¥åˆ°è®¡ç®—Attentionå’ŒKV Cacheï¼ŒMLAå¯¹$\textbf{c}_i$ä¸æ˜¯ç®€å•çš„åˆ†å‰²å’Œå¤åˆ¶ï¼Œä»–å¯¹$\textbf{c}_i$åˆè¿›è¡Œäº†ä¸€æ¬¡æŠ•å½±ï¼Œâ€œå¢å¼ºäº†æ¨¡å‹çš„èƒ½åŠ›â€ï¼š<br>$$\textbf{u}_t = \textbf{o}_t\textbf{W}_o,\ \ \ \ \ \textbf{W}_o\in \mathbb{R}^{d\times hd_k}$$</p><ul><li>$\textbf{W}_o$æ˜¯è¾“å‡ºæŠ•å½±çŸ©é˜µï¼Œè¿™é‡Œçš„$hd_k\neq d$<br>$$\textbf{o}_t=[\textbf{o}_t^{(1)}, \textbf{o}_t^{(2)}, â€¦, \textbf{o}<em>t^{(h)}] \in \mathbb{R}^{1\times d}$$<br>$$\textbf{o}<em>t^{(s)} = Attention(\textbf{q}<em>t^{(s)}, \textbf{k}</em>{i\leq t}^{(s)}, \textbf{v}</em>{i\leq t}^{(s)}) = \sum^t</em>{i=1}softmax(\dfrac{\textbf{q}_t^{(s)}\textbf{k}_i^{(s)T}}{\sqrt{d_k}})\textbf{v}_i^{(s)}$$<br>$$\textbf{c}_i=\textbf{x}_i\textbf{W}_c\in\mathbb{R}^{1\times d_c}$$<br>$$\textbf{q}_i^{(s)}=\textbf{x}_i\textbf{W}_q^{(s)}\in \mathbb{R}^{1\times d_k},\ \ \ \ \  \textbf{W}_q^{(s)}\in \mathbb{R}^{d\times d_k}$$<br>$$\textbf{k}<em>i^{(s)}=\textbf{c}<em>i\textbf{W}</em>{Uk}^{(s)}\in \mathbb{R}^{1\times d_k},\ \ \ \ \  \textbf{W}</em>{Uk}^{(s)}\in \mathbb{R}^{d_c\times d_k}$$<br>$$\textbf{v}<em>i^{(s)}=\textbf{c}<em>i\textbf{W}</em>{Uv}^{(s)}\in \mathbb{R}^{1\times d_v},\ \ \ \ \  \textbf{W}</em>{Uv}^{(s)}\in \mathbb{R}^{d_c\times d_v}$$</li><li>$\textbf{W}<em>{Uk}^{(s)}$ã€$\textbf{W}</em>{Uv}^{(s)}$ï¼šåˆ†åˆ«ä¸ºç¬¬$s$ä¸ª<code>head</code>çš„keyã€valueçš„å†æŠ•å½±æƒé‡çŸ©é˜µï¼Œä¸ºäº†â€œå¢å¼ºäº†æ¨¡å‹çš„èƒ½åŠ›â€<br>ç„¶è€Œï¼ŒåŸæœ¬å·²ç»ä½ç§©çš„$\textbf{c}<em>i$åœ¨$\textbf{W}</em>{Uk}^{(s)}$å’Œ$\textbf{W}_{Uv}^{(s)}$ä½œç”¨ä¸‹è¢«up-projectionäº†ï¼Œå³$\textbf{k}_i^{(s)}$å’Œ$\textbf{v}_i^{(s)}$åŸæœ¬çš„<code>head</code>åˆ†ç»„ä¸å­˜åœ¨äº†ï¼Œä¸€ç»„<code>head</code>ä¹‹é—´ä¸å†å…±äº«$K$ã€$V$ï¼Œâ€œå‡ºäºèŠ‚çœè®¡ç®—å’Œé€šä¿¡æˆæœ¬çš„è€ƒè™‘ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šç¼“å­˜çš„æ˜¯æŠ•å½±åçš„$\textbf{k}_i$ã€$\textbf{v}_i$çš„è€Œä¸æ˜¯æŠ•å½±å‰çš„$\textbf{c}_i$æˆ–$\textbf{x}_i$â€ï¼Œæ‰€ä»¥ï¼Œæ­¤åšæ³•çš„KV Cacheä¸MHAæ— å¼‚ï¼Œæ²¡æœ‰æ˜¾å­˜èŠ‚çœçš„ä½œç”¨ã€‚</li></ul><p>è™½ç„¶åœ¨è®­ç»ƒé˜¶æ®µMLAçš„ä¼˜åŒ–ç©ºé—´ä¸å¤§ï¼Œä½†æ˜¯åœ¨æ¨ç†é˜¶æ®µä¸­ï¼š<br>$$\textbf{q}_t^{(s)}\textbf{k}_i^{(s)T}=(\textbf{x}_t\textbf{W}_q^{(s)})\cdot (\textbf{c}<em>i\textbf{W}</em>{Uk}^{(s)})^T=\textbf{x}_t(\textbf{W}<em>q^{(s)}\cdot\textbf{W}</em>{Uk}^{(s)T})\textbf{c}_i^T$$<br>$\textbf{W}<em>q^{(s)}\cdot\textbf{W}</em>{Uk}^{(s)T}$ä½œä¸º$Q$çš„æŠ•å½±çŸ©é˜µï¼ŒK Cacheçš„å†…å®¹å¯ä»¥ä»$\textbf{k}_i$å˜ä¸º$\textbf{c}_i$ï¼›æ ¹æ®$\textbf{v}_i^{(s)}=\textbf{c}<em>i\textbf{W}</em>{Uv}^{(s)}$å’Œ$\textbf{u}_t^{(s)} = \textbf{o}_t^{(s)}\textbf{W}_o^{(s)}$ï¼Œè¾“å‡ºçš„è®¡ç®—è¿‡ç¨‹åŒ…å«$\textbf{c}<em>i\textbf{W}</em>{Uv}\textbf{W}<em>O$ï¼Œé‚£ä¹ˆ$\textbf{W}</em>{Uv}\textbf{W}_O$ä½œä¸º$V$çš„æŠ•å½±çŸ©é˜µï¼Œ$\textbf{v}_i$å¯ä»¥ç”¨$\textbf{c}_i$ä»£æ›¿ï¼Œå³V Cacheçš„å†…å®¹ä»$\textbf{v}_i$ä¹Ÿå˜ä¸º$\textbf{c}_i$ã€‚<br>é‚£ä¹ˆKV Cacheçš„å†…å®¹å°±æ˜¯$\textbf{c}_i$ï¼Œå®ƒä¸$(s)$æ— å…³ ï¼Œæ˜¯æ‰€æœ‰<code>head</code>å…±äº«çš„ï¼Œæ§åˆ¶å¥½$g/h$çš„å€¼ï¼Œåœ¨æ¨ç†é˜¶æ®µè¾¾åˆ°GQAæˆ–MQAçš„æ•ˆæœã€‚<br>å®é™…ä¸Šï¼Œå› ä¸ºup-projectionæé«˜äº†æ¨¡å‹çš„æ•ˆæœï¼ŒåŒæ—¶åœ¨æ¨ç†é˜¶æ®µKV Cacheæ•ˆæœä¸GQAç›¸åŒ($1&lt;g&lt;h$)ã€‚åœ¨æ•ˆæœå’Œæ˜¾å­˜çš„å¹³è¡¡ä¸‹ï¼Œâ€œå¦‚æœæˆ‘ä»¬åªéœ€è¦è·ŸGQAç›¸è¿‘çš„èƒ½åŠ›ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯å°±å¯ä»¥å†æ¬¡å‡å°‘KV Cacheäº†ï¼Ÿæ¢è¨€ä¹‹ï¼Œ$d_c$æ²¡å¿…è¦å–$g(dk+dv)$ï¼Œè€Œæ˜¯å–æ›´å°çš„å€¼ï¼Œä»è€Œè¿›ä¸€æ­¥å‹ç¼©KV Cacheï¼Œè¿™å°±æ˜¯MLAçš„æ ¸å¿ƒæ€æƒ³â€ã€‚</p><h2 id="4-2-RoPEçš„å…¼å®¹"><a href="#4-2-RoPEçš„å…¼å®¹" class="headerlink" title="4.2 RoPEçš„å…¼å®¹"></a>4.2 RoPEçš„å…¼å®¹</h2><p>RoPEä¸ç»å¯¹ä½ç½®ç›¸å…³ï¼Œé€šè¿‡ç»å¯¹ä½ç½®è®¡ç®—ä¸¤ä¸ªtokenä¹‹é—´çš„ç›¸å¯¹ä½ç½®ä¿¡æ¯ï¼š<br>$$\textbf{R}_m\textbf{R}<em>n^T=\textbf{R}</em>{m-n}$$<br>MLAåŠ ä¸ŠRoPEä¹‹åï¼š<br>$$\textbf{q}_i^{(s)}=x_iW_q^{(s)}\textbf{R}_i, \ \ \ \ \ \textbf{k}_i^{(s)}=\textbf{c}<em>i\textbf{W}</em>{Uk}^{(s)}\textbf{R}_i$$<br>$$\textbf{q}_t^{(s)}\textbf{k}_i^{(s)T}=(x_tW_q^{(s)}\textbf{R}<em>t)(\textbf{c}<em>i\textbf{W}</em>{Uk}^{(s)}\textbf{R}<em>i)^T=x_tW_q^{(s)}\textbf{R}</em>{t-i}{W}</em>{Uk}^{(s)T}\textbf{c}_i^T$$<br>ä¸èƒ½å›ºå®š$\textbf{W}<em>q^{(s)}\cdot\textbf{W}</em>{Uk}^{(s)T}$å€¼ä½œä¸º$Q$çš„æŠ•å½±çŸ©é˜µã€‚<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/MLA/Pasted%20image%2020250323150831.png" alt="ã€Šç¼“å­˜ä¸æ•ˆæœçš„æé™æ‹‰æ‰¯ï¼šä»MHAã€MQAã€GQAåˆ°MLAã€‹ä¸€æ–‡ä¸­æ¢è®¨çš„å…¶ä»–æ–¹æ³•"><br>åæ¥è§£å†³åŠæ³•ä¸ºæ¯ä¸ª<code>head</code>çš„$\textbf{Q}$å’Œ$\textbf{K}$æ–°å¢$d_r$ä¸ªç»´åº¦æ¥æ·»åŠ RoPEçš„ä¿¡æ¯ï¼Œå…¶ä¸­$\textbf{K}$æ–°å¢çš„ä¿¡æ¯ç”±æ¯ä¸ª<code>head</code>å…±äº«<br>$$\textbf{u}_t = \textbf{o}_t\textbf{W}_o,\ \ \ \ \ \textbf{W}_o\in \mathbb{R}^{d\times hd_k}$$<br>$$\textbf{o}_t=[\textbf{o}_t^{(1)}, \textbf{o}_t^{(2)}, â€¦, \textbf{o}<em>t^{(h)}] \in \mathbb{R}^{1\times d}$$<br>$$\textbf{o}<em>t^{(s)} = Attention(\textbf{q}<em>t^{(s)}, \textbf{k}</em>{i\leq t}^{(s)}, \textbf{v}</em>{i\leq t}^{(s)}) = \sum^t</em>{i=1}softmax(\dfrac{\textbf{q}_t^{(s)}\textbf{k}_i^{(s)T}}{\sqrt{d_k+d_r}})\textbf{v}_i^{(s)}$$</p><ul><li>dot-productçš„scalingå˜æˆäº†$\sqrt{d_k+d_r}$<br>$$RoPE(\textbf{x}<em>i\textbf{W}</em>{qR}^{(s)})=\textbf{x}<em>i\textbf{W}</em>{qR}^{(s)}\textbf{R}<em>i,\ \ \ \ \ \textbf{W}</em>{qR}^{(s)}\in \mathbb{R}^{d\times d_r}$$<br>$$RoPE(\textbf{x}<em>i\textbf{W}</em>{kR})=\textbf{x}<em>i\textbf{W}</em>{kR}\textbf{R}<em>i,\ \ \ \ \ \textbf{W}</em>{kR}\in \mathbb{R}^{d\times d_r}$$<br>$$\textbf{c}_i=\textbf{x}_i\textbf{W}_c\in\mathbb{R}^{1\times d_c}$$<br>$$\textbf{q}_i^{(s)}=[\textbf{x}_i\textbf{W}_q^{(s)}, \textbf{x}<em>i\textbf{W}</em>{qR}^{(s)}\textbf{R}_i]\in \mathbb{R}^{1\times [d_k+d_r]},\ \ \ \ \  \textbf{W}_q^{(s)}\in \mathbb{R}^{d\times d_r}$$<br>$$\textbf{k}<em>i^{(s)}=[\textbf{c}<em>i\textbf{W}</em>{Uk}^{(s)}, \textbf{x}<em>i\textbf{W}</em>{kR}\textbf{R}<em>i]\in \mathbb{R}^{1\times [d_k+d_r]},\ \ \ \ \  \textbf{W}</em>{Uk}^{(s)}\in \mathbb{R}^{d\times d_r}$$<br>$$\textbf{v}<em>i^{(s)}=\textbf{c}<em>i\textbf{W}</em>{Uv}^{(s)}\in \mathbb{R}^{1\times d_v},\ \ \ \ \  \textbf{W}</em>{Uv}^{(s)}\in \mathbb{R}^{d_c\times d_v}$$<br>ğŸ‘‡å¯ä»¥çœ‹åˆ°ä¿ç•™äº†$Q$çš„å›ºå®šæŠ•å½±$\textbf{W}<em>q^{(s)}\cdot\textbf{W}</em>{Uk}^{(s)T}$å’Œç›¸å¯¹ä½ç½®ä¿¡æ¯$\textbf{R}</em>{t-i}$<br>$$\textbf{q}_t^{(s)}\textbf{k}_i^{(s)T}=(\textbf{x}_t\textbf{W}_q^{(s)})(\textbf{c}<em>i\textbf{W}</em>{Uk}^{(s)})^T+(\textbf{x}<em>t\textbf{W}</em>{qR}^{(s)}\textbf{R}_t)(\textbf{x}<em>i\textbf{W}</em>{kR}\textbf{R}_i)^T$$<br>$$=\textbf{x}<em>t(\textbf{W}<em>q^{(s)}\cdot\textbf{W}</em>{Uk}^{(s)T})\textbf{c}<em>i^T+\textbf{x}<em>t\textbf{W}</em>{qR}^{(s)}(\textbf{R}</em>{t-i})\textbf{W}</em>{kR}^T\textbf{x}_i^T$$</li></ul><h2 id="4-3-MLAæœ€ç»ˆç‰ˆæœ¬"><a href="#4-3-MLAæœ€ç»ˆç‰ˆæœ¬" class="headerlink" title="4.3 MLAæœ€ç»ˆç‰ˆæœ¬"></a>4.3 MLAæœ€ç»ˆç‰ˆæœ¬</h2><p>â€œin order to reduce the activation memory during trainingâ€ï¼Œæœ€åMLAåœ¨è®­ç»ƒé˜¶æ®µå¯¹$Q$çš„è¾“å…¥$\textbf{x}_i$ä¹Ÿåšäº†ä½ç§©æŠ•å½±ï¼Œå³$$\textbf{c}<em>iâ€™=\textbf{x}<em>i\textbf{W}</em>{Dq}\in \mathbb{R}^{1\times d_câ€™},\ \ \ \ \ \textbf{W}</em>{Dq}\in \mathbb{R}^{d\times d_câ€™}$$$$\textbf{q}<em>i^{(s)}=[\textbf{c}<em>iâ€™\textbf{W}</em>{Uq}^{(s)}, \textbf{c}<em>iâ€™\textbf{W}</em>{qR}^{(s)}\textbf{R}<em>i]\in \mathbb{R}^{1\times [d_k+d_r]},\ \ \ \ \  \textbf{W}</em>{Uq}^{(s)}\in \mathbb{R}^{d_câ€™\times d_k},\textbf{W}</em>{qR}^{(s)}\in \mathbb{R}^{d_câ€™\times d_k}$$æœ€ç»ˆç‰ˆæœ¬çš„è®­ç»ƒé˜¶æ®µï¼š<br>$$\textbf{u}_t = \textbf{o}_t\textbf{W}_o,\ \ \ \ \ \textbf{W}_o\in \mathbb{R}^{d\times hd_k}$$<br>$$\textbf{o}_t=[\textbf{o}_t^{(1)}, \textbf{o}_t^{(2)}, â€¦, \textbf{o}<em>t^{(h)}] \in \mathbb{R}^{1\times d}$$<br>$$\textbf{o}<em>t^{(s)} = Attention(\textbf{q}<em>t^{(s)}, \textbf{k}</em>{i\leq t}^{(s)}, \textbf{v}</em>{i\leq t}^{(s)}) = \sum^t</em>{i=1}softmax(\dfrac{\textbf{q}_t^{(s)}\textbf{k}_i^{(s)T}}{\sqrt{d_k+d_r}})\textbf{v}_i^{(s)}$$<br>$$\textbf{c}_i=\textbf{x}_i\textbf{W}_c\in\mathbb{R}^{d_c},\ \ \ \ \ \textbf{W}_c\in\mathbb{R}^{d\times d_c}$$<br>$$\textbf{c}<em>iâ€™=\textbf{x}<em>i\textbf{W}</em>{Dq}\in \mathbb{R}^{1\times d_câ€™},\ \ \ \ \ \textbf{W}</em>{Dq}\in \mathbb{R}^{d\times d_câ€™}$$<br>$$\textbf{q}<em>i^{(s)}=[\textbf{c}<em>iâ€™\textbf{W}</em>{Uq}^{(s)}, \textbf{c}<em>iâ€™\textbf{W}</em>{qR}^{(s)}\textbf{R}<em>i]\in \mathbb{R}^{1\times [d_k+d_r]},\ \ \ \ \  \textbf{W}</em>{Uq}^{(s)}\in \mathbb{R}^{d_câ€™\times d_k},\textbf{W}</em>{qR}^{(s)}\in \mathbb{R}^{d_câ€™\times d_k}$$<br>$$\textbf{k}_i^{(s)}=[\textbf{c}<em>i\textbf{W}</em>{Uk}^{(s)}, \textbf{x}<em>i\textbf{W}</em>{kR}\textbf{R}<em>i]\in \mathbb{R}^{1\times [d_k+d_r]},\ \ \ \ \  \textbf{W}</em>{Uk}^{(s)}\in \mathbb{R}^{d_c\times d_k}$$<br>$$\textbf{v}<em>i^{(s)}=\textbf{c}<em>i\textbf{W}</em>{Uv}^{(s)}\in \mathbb{R}^{1\times d_v},\ \ \ \ \  \textbf{W}</em>{Uv}^{(s)}\in \mathbb{R}^{d_c\times d_v}$$<br>$$\textbf{q}_t^{(s)}\textbf{k}_i^{(s)T}=(\textbf{c}â€™<em>t\textbf{W}</em>{Uq}^{(s)})(\textbf{c}<em>i\textbf{W}</em>{Uk}^{(s)})^T+(\textbf{c}<em>t\textbf{W}</em>{qR}^{(s)}\textbf{R}<em>t)(\textbf{x}<em>i\textbf{W}</em>{kR}\textbf{R}<em>i)^T$$<br>$$=\textbf{c}â€™<em>t(\textbf{W}</em>{Uq}^{(s)}\cdot\textbf{W}</em>{Uk}^{(s)T})\textbf{c}<em>i^T+\textbf{c}â€™<em>t\textbf{W}</em>{qR}^{(s)}(\textbf{R}</em>{t-i})\textbf{W}</em>{kR}^T\textbf{x}_i^T$$</p><p>æœ€ç»ˆç‰ˆæœ¬çš„æ¨ç†é˜¶æ®µï¼š<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/MLA/Pasted%20image%2020250323222539.png">$$\textbf{u}_t = [\textbf{o}_t^{(1)}\textbf{W}_o^{â€˜(1)},\textbf{o}_t^{(2)}\textbf{W}_o^{â€˜(2)},â€¦,\textbf{o}_t^{(h)}\textbf{W}_o^{â€˜(h)}]$$<br>$$\textbf{W}â€™_o=[\textbf{W}_o^{â€˜(1)},\textbf{W}_o^{â€˜(2)},â€¦,\textbf{W}_o^{â€˜(h)}],\ \ \ \ \ \textbf{W}â€™_o\in \mathbb{R}^{d\times hd_k}$$</p><ul><li>$\textbf{W}â€™_o$èåˆäº†$\textbf{W}_o$å’Œ$\textbf{W}<em>v^{(g)}$å¾—åˆ°çš„ï¼Œåœ¨æ¨ç†é˜¶æ®µæ˜¯å›ºå®šå€¼<br>$$\textbf{o}<em>t^{(s)} = Attention(\textbf{q}<em>t^{(s)}, \textbf{k}</em>{i\leq t}, \textbf{v}</em>{i\leq t}) = \sum^t</em>{i=1}softmax(\dfrac{\textbf{q}_t\textbf{k}_i^T}{\sqrt{d_k+d_r}})\textbf{v}_i,\ \ \ \ \ \textbf{v}_i=\textbf{c}_i\in \mathbb{R}^{1\times d_c}$$<br>$$\textbf{c}_i=\textbf{x}_i\textbf{W}<em>c\in\mathbb{R}^{d_c},\ \ \ \ \ \textbf{W}<em>c\in\mathbb{R}^{d\times d_c}$$<br>$$\textbf{c}<em>iâ€™=\textbf{x}<em>i\textbf{W}</em>{Dq}\in \mathbb{R}^{1\times d_câ€™},\ \ \ \ \ \textbf{W}</em>{Dq}\in \mathbb{R}^{d\times d_câ€™}$$<br>$$\textbf{q}<em>i^{(s)}=[\textbf{c}<em>iâ€™\textbf{W}</em>{Uq}^{(s)}\textbf{W}</em>{Uk}^{(s)T}, \textbf{c}<em>iâ€™\textbf{W}</em>{qR}^{(s)}\textbf{R}<em>i]\in \mathbb{R}^{1\times [d_c+d_r]},\ \ \ \ \  \textbf{W}</em>{Uq}^{(s)}\in \mathbb{R}^{d_câ€™\times d_k},\textbf{W}</em>{qR}^{(s)}\in \mathbb{R}^{d_câ€™\times d_k},\textbf{W}</em>{Uk}^{(s)}\in \mathbb{R}^{d_c\times d_k}$$</li><li>$\textbf{W}<em>{Uq}^{(s)}\cdot\textbf{W}</em>{Uk}^{(s)T}$ä½œä¸º$Q$çš„æŠ•å½±çŸ©é˜µ<br>$$\textbf{k}_i=[\textbf{c}_i, \textbf{x}<em>i\textbf{W}</em>{kR}\textbf{R}_i]\in \mathbb{R}^{1\times [d_c+d_r]}$$</li><li>$\textbf{k}$åœ¨å­˜å‚¨æ—¶ä¸éœ€è¦è€ƒè™‘ä¸åŒ<code>head</code></li></ul><p>å¯¹äºå•ä¸ªtokenï¼š</p><ul><li>MLAæ¨ç†æ—¶éœ€è¦çš„ç¼“å­˜ï¼š<ul><li>$\textbf{v}_i=\textbf{c}_i\in \mathbb{R}^{1\times d_c}$</li><li>$\textbf{k}_=[\textbf{c}_i, \textbf{x}<em>i\textbf{W}</em>{kR}\textbf{R}_i]\in \mathbb{R}^{1\times [d_c+d_r]}$ï¼Œ$d_c+d_r=512+64=576$</li></ul></li><li>MHAç‰ˆæœ¬çš„ç¼“å­˜ï¼š$2\times d_k\times h=2\times 128\times128=32768$</li></ul><p>ğŸ‘‡å›¾æ€æƒ³æ¥æº<a href="https://www.bilibili.com/video/BV1BYXRYWEMj?spm_id_from=333.1245.0.0">DeepSeek-v2 MLA åŸç†è®²è§£</a><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/MLA/de420aa56bd3f8b22e26f54c9ee1f37.jpg" alt="MLAæŠ•å½±è¿‡ç¨‹(ç²—ç•¥)"><br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/MLA/Pasted%20image%2020250323194944.png" alt="ã€Šç¼“å­˜ä¸æ•ˆæœçš„æé™æ‹‰æ‰¯ï¼šä»MHAã€MQAã€GQAåˆ°MLAã€‹ä¸€æ–‡ä¸­å¯¹MLAè®¡ç®—é‡å¢åŠ å’Œæ•ˆç‡çš„è®¨è®º"></p><ul><li>åœ¨ç¬¬ä¸€ä¸ªtokenç”Ÿæˆé˜¶æ®µéœ€è¦å¹¶è¡Œå¤„ç†è¾“å…¥çš„æ‰€æœ‰tokenï¼Œè™½ç„¶è®¡ç®—é‡å¢åŠ ï¼Œä½†æ˜¯KV Cacheç›¸åº”å‡å°‘ï¼Œæ— åŠŸæ— è¿‡ã€‚</li><li>åœ¨åç»­æ¯ä¸ªtokenç”Ÿæˆé˜¶æ®µï¼Œæ¯æ¬¡åªè¾“å…¥ä¸€ä¸ªï¼Œå¢åŠ çš„è®¡ç®—é‡ä¸ä¼šè¢«æ”¾å¤§ï¼Œæ¯æ¬¡éœ€è¦ä¼ è¾“çš„KVç›¸æ¯”åŸæ¥æ˜¯å‡å°‘çš„ã€‚</li></ul><h1 id="5-å¯¹æ¯”"><a href="#5-å¯¹æ¯”" class="headerlink" title="5 å¯¹æ¯”"></a>5 å¯¹æ¯”</h1><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/MLA/Pasted%20image%2020250323164232.png"></p><ul><li>$d_câ€™=1536$</li><li>$d_h=d_k=d_v=128,h=128,d=d_h\times h$</li><li>$d_c=4d_h=4\times128=512$</li><li>$d_r=\dfrac{d_h}{2}=128\div2=64$</li><li>DeepSeek-V2çš„KV Cache($=576$)ç›¸å½“äºGQAçš„$g=2.25$æ—¶çš„å¤§å°(GQAä¸€ä¸ªç»„çš„å¤§å°$=256$)</li></ul>]]></content>
      
      
      <categories>
          
          <category> é«˜æ€§èƒ½è®¡ç®— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DeepSeek </tag>
            
            <tag> GPU </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LLM2æ¡†æ¶æ­å»ºè¿‡ç¨‹</title>
      <link href="/2024/10/08/llm2-tui-li-yin-qing/"/>
      <url>/2024/10/08/llm2-tui-li-yin-qing/</url>
      
        <content type="html"><![CDATA[<h1 id="Lesson1-æ•´ä½“æ¶æ„"><a href="#Lesson1-æ•´ä½“æ¶æ„" class="headerlink" title="Lesson1 æ•´ä½“æ¶æ„"></a>Lesson1 æ•´ä½“æ¶æ„</h1><p>Llama2ï¼šç”Ÿæˆå¼æ¨¡å‹ä»¥decoder-onlyä¸ºæ¶æ„<br>ç”±ä¸¤ä¸ªDecoderç»„æˆï¼š<br>â‘ Context Decoderï¼Œä½äºprompté˜¶æ®µï¼Œç”¨æ¥ç”Ÿæˆä¸€ä¸ªtokenï¼›å…¨é‡æ¨ç†ï¼šè¾“å…¥æ˜¯ä¸€ä¸ªå¥å­ï¼Œåªéœ€è¦ç”Ÿæˆç¬¬ä¸€ä¸ªtokenï¼›å…·æœ‰å¹¶è¡Œè®¡ç®—çš„ç‰¹ç‚¹</p><p>â‘¡Mask self Decoderï¼Œä½äºgenerateé˜¶æ®µï¼Œç”¨æ¥ç”Ÿæˆç¬¬äºŒä¸ªtokenï¼›å¢é‡æ¨ç†ï¼šè¾“å…¥æ˜¯ä¸€ä¸ªtokenï¼Œåœ¨gptä¸Šçš„è¡¨ç°ä¸ºæ¯æ¬¡åå‡ºä¸ºä¸€ä¸ªtokenï¼›æ¯æ¬¡è¾“å…¥çš„éƒ½æ˜¯ä¸Šä¸€ä¸ªè¾“å‡ºçš„token<br><a href="https://www.jianshu.com/p/c7b40d8526dd">Transformerç³»åˆ—ï¼šæ³¨æ„åŠ›æœºåˆ¶çš„ä¼˜åŒ–ï¼ŒMQAå’ŒGQAåŸç†ç®€è¿° - ç®€ä¹¦</a></p><h1 id="Lesson2-é¡¹ç›®æ­å»º-embedding-kernel"><a href="#Lesson2-é¡¹ç›®æ­å»º-embedding-kernel" class="headerlink" title="Lesson2 é¡¹ç›®æ­å»º&amp;embedding kernel"></a>Lesson2 é¡¹ç›®æ­å»º&amp;embedding kernel</h1><p>è®²è§£äº†ï¼š<br><code>src/utils/tensor.h</code><br><code>src/kernels/input_embedding.cu</code><br><code>src/kernels/input_embedding.h</code><br><code>tests/unittests/test_input_embedding.cu</code></p><pre class="line-numbers language-none"><code class="language-none">-src|-kernels|-|-input_embeding.cu|-utils|-|-tensor.h|-weights<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>LLMengine/src/utils/tensor.h</code></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">Struct Tensor{Device location,DataType dtype,std::vector&lt;int&gt; shape;...virtual int size() const {&nbsp; &nbsp; &nbsp; &nbsp; if (shape.size() == 0) {&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // TODO: add an reminder info&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return 0;&nbsp; &nbsp; &nbsp; &nbsp; }&nbsp; &nbsp; &nbsp; &nbsp; return std::accumulate(shape.begin(), shape.end(), (int)1, std::multiplies&lt;int&gt;());&nbsp; &nbsp; }&nbsp; &nbsp; ...&nbsp; &nbsp; template&lt;typename T&gt;&nbsp; &nbsp; TensorWrapper&lt;T&gt;* as(){&nbsp; &nbsp; &nbsp; &nbsp; return static_cast&lt;TensorWrapper&lt;T&gt;*&gt;(this); // ä¸‹è¡Œè½¬æ¢(æ˜¾å¼)ï¼Œå°†this(Tensorç±»å‹çš„å½“å‰å¯¹è±¡)è½¬æ¢ä¸ºTensorWrapper&lt;T&gt;ç±»å‹çš„æŒ‡é’ˆ&nbsp; &nbsp; }}Class TensorWrap: public Tensor {T * data;...}Struct TensorMap{std::unordered_map(std::string, Tensor*&gt; tensor_map);...}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>std::unorder_map</code>ï¼šæ˜¯ä¸€ä¸ªå…³è”å®¹å™¨ï¼Œç”¨äºå­˜å‚¨é”®å€¼å¯¹ï¼Œé”®æ˜¯è¯¥Tensorçš„åå­—ï¼Œå€¼æ˜¯æŒ‡å‘Tensorç±»å‹å˜é‡çš„æŒ‡é’ˆ</li><li>å…³äºä¸ºä»€ä¹ˆè¦åœ¨<code>TensorWrap</code>ä¸­å…ˆç»§æ‰¿çˆ¶ç±»<code>Tensor</code>å†å®ç°æ¨¡æ¿åŒ–<code>T* data</code>ï¼š<code>Tensor</code>è¦æ”¾åˆ°<code>TensorMap</code>ä¸­ï¼Œè€ŒC++ä½œä¸ºå¼ºç±»å‹è¯­è¨€ï¼Œä¸æ”¯æŒå­—å…¸å­˜æ”¾ä¸åŒç±»å‹çš„tensor(å› ä¸ºç±»å‹å®šä¹‰ä¸º<code>Tensor</code>çš„æŒ‡é’ˆï¼Œå¦‚æœåœ¨<code>Tensor</code>ä¸­åŠ å…¥äº†<code>T*</code>ä½œä¸ºæˆå‘˜ï¼Œå¯èƒ½ä¼šä¹±å¥—äº†)</li><li><code>std::accumulate(shape.begin(), shape.end(), (int)1, std::multiplies&lt;int&gt;());</code>ï¼šåšä¹˜ç§¯ï¼Œåˆå§‹ä¹˜çš„å€¼ä¸º1</li></ul><p>å¦‚æœ<code>.cpp</code>æ–‡ä»¶è°ƒç”¨å¸¦æœ‰cudaè¯­æ³•çš„å‡½æ•°ï¼Œåˆ™å…¶å®šä¹‰ä¸èƒ½å­˜åœ¨<code>.h</code>æ–‡ä»¶é‡Œï¼Œä¾‹å¦‚å«æœ‰<code>&lt;&lt;&lt; &gt;&gt;&gt;</code><br>    ä¾‹å­ï¼šåœ¨<code>src/kernel/input_embedding.cu</code>ä¸­</p><ul><li>å®šä¹‰äº†<code>launchInputEmbedding</code>ğŸ‘‡<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">template&lt;typename T&gt;void launchInputEmbedding(TensorWrapper&lt;int&gt;* input_ids, &nbsp; &nbsp;// INT [token num]&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TensorWrapper&lt;T&gt;* output, &nbsp; &nbsp; &nbsp; // FP32 [token num, hidden_size] = [token num, 4096]&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; EmbeddingWeight&lt;T&gt;* embed_table// FP32 [vocal_size, hidden_size]&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ) {&nbsp; &nbsp; // åˆ†é…çº¿ç¨‹å—ï¼Œæ ¸å‡½æ•°éœ€è¦çš„ç»´åº¦ä¿¡æ¯&nbsp; &nbsp; const int blockSize = 256;&nbsp; &nbsp; const int max_context_token_num = output-&gt;shape[0]; // token num&nbsp; &nbsp; const int hidden_size = output-&gt;shape[1];&nbsp; &nbsp; const int gridSize = 2048;&nbsp; &nbsp; LLM_CHECK_WITH_INFO(max_context_token_num == input_ids-&gt;shape[0], "input ids 1st shape should equal to 1st shape of output");&nbsp; &nbsp; embeddingFunctor&lt;T&gt;&lt;&lt;&lt;gridSize, blockSize&gt;&gt;&gt;(input_ids-&gt;data,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;output-&gt;data,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;embed_table-&gt;data,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;max_context_token_num,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;hidden_size);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>å®ä¾‹åŒ–<ul><li>æ˜¾å¼å®ä¾‹åŒ–æ˜¯å‘Šè¯‰ç¼–è¯‘å™¨ç”Ÿæˆä¸€ä¸ªæ¨¡æ¿å‡½æ•°çš„ç‰¹å®šå®ä¾‹ã€‚åœ¨æ¨¡æ¿å‡½æ•°å®šä¹‰ä¸­ï¼Œåªæ˜¯å®šä¹‰äº†ä¸€ä¸ªé€šç”¨çš„é€»è¾‘ï¼Œä½†æ²¡æœ‰çœŸæ­£ç”Ÿæˆä»£ç ã€‚<strong>åªæœ‰åœ¨æ¨¡æ¿å®ä¾‹åŒ–çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨æ‰ä¼šæ ¹æ®å…·ä½“çš„æ•°æ®ç±»å‹æ¥ç”Ÿæˆç›¸åº”çš„å‡½æ•°ä»£ç ã€‚</strong></li><li>åŸå› ï¼š<ul><li>é¿å…ä»£ç è†¨èƒ€ï¼šå¦‚æœä¸æ˜¾å¼å®ä¾‹åŒ–ï¼Œé‚£ä¹ˆæ¯æ¬¡ä½¿ç”¨ä¸åŒç±»å‹è°ƒç”¨æ¨¡æ¿å‡½æ•°æ—¶ï¼Œç¼–è¯‘å™¨éƒ½ä¼šç”Ÿæˆæ–°çš„ä»£ç </li><li>CUDAç¼–è¯‘é™åˆ¶</li></ul></li><li>åˆ†åˆ«ç”Ÿæˆäº†ğŸ‘‡ä¸¤ç§ç±»å‹çš„å…·ä½“å®ä¾‹<code>T=float</code>ã€<code>T=half</code><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">// æ˜¾å¼å®ä¾‹åŒ–æ¨¡ç‰ˆå‡½æ•°ï¼Œç”±äºcudaçš„è¯­æ³•è§„åˆ™ï¼Œä¸èƒ½å­˜åœ¨.cppæ–‡ä»¶é‡Œï¼Œå› æ­¤åªèƒ½åœ¨æ­¤å®ä¾‹åŒ–template void launchInputEmbedding(TensorWrapper&lt;int&gt;* input_ids, &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;TensorWrapper&lt;float&gt;* output, &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;EmbeddingWeight&lt;float&gt;* embed_table);template void launchInputEmbedding(TensorWrapper&lt;int&gt;* input_ids, &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;TensorWrapper&lt;half&gt;* output, &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;EmbeddingWeight&lt;half&gt;* embed_table);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li></ul><p><code>src/kernels/input_embedding.cu</code></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">__global__ void embeddingFunctor(const int* input_ids,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;T* output,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;const T* embed_table,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;const int max_context_token_num,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;const int hidden_size){&nbsp; &nbsp; int index = blockIdx.x * blockDim.x + threadIdx.x;&nbsp; &nbsp; while (index &lt; max_context_token_num * hidden_size) {&nbsp; &nbsp; &nbsp; &nbsp; int id = input_ids[index / hidden_size];&nbsp; &nbsp; &nbsp; &nbsp; output[index] = embed_table[id * hidden_size + index % hidden_size];&nbsp; &nbsp; &nbsp; &nbsp; index += blockDim.x * gridDim.x;&nbsp; &nbsp; }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/LLM2%E6%8E%A8%E7%90%86%E5%BC%95%E6%93%8E/6382f7e2cd4bf0b302b43f58c93ea08.jpg">indexçš„ç´¢å¼•å¯¹åº”çš„æ˜¯outputçš„è¾“å‡ºçš„æ¯ä¸ªä½ç½®ï¼Ÿ</p><p>è¿™ä¸ªkernelçš„ç”¨å¤„ï¼šå°†åŸæœ¬è¾“å…¥æ ¼å¼çš„[batch size, sequence length]å˜æˆ[batch size, sequence length, hidden size]</p><p>æœ‰<code>.cpp</code>æ–‡ä»¶ã€<code>.cc</code>æ–‡ä»¶ã€<code>.cu</code>æ–‡ä»¶çš„ç›®å½•ä¸‹éœ€è¦æ”¾<code>CMakeLists.txt</code>æ–‡ä»¶</p><h1 id="Lesson3-Calculate-padding-offset-kernel"><a href="#Lesson3-Calculate-padding-offset-kernel" class="headerlink" title="Lesson3 Calculate padding offset kernel"></a>Lesson3 Calculate padding offset kernel</h1><p>è®²è§£äº†ï¼š<br><code>src/kernels/cal_paddingoffset.cu</code><br><code>src/kernels/cal_paddingoffset.h</code><br><code>tests/unittests/test_cal_paddingoffset.cu</code></p><p><a href="https://github.com/bytedance/effective_transformer">Padding Offsetæ€æƒ³æ¥æº</a><br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/LLM2%E6%8E%A8%E7%90%86%E5%BC%95%E6%93%8E/Pasted%20image%2020241011153928.png" alt="|425"></p><p><code>src/lkernels/cal_paddingoffset.h</code></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">void launchCalPaddingoffset(TensorWrapper&lt;int&gt;* padding_offset,TensorWrapper&lt;int&gt;* cum_seqlens,TensorWrapper&lt;int&gt;* input_lengths);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>å‚æ•°ï¼š<br>  <code>padding_offset</code>ï¼š<code>[batch size, max q_seq length]</code>è®°å½•æ¯ä¸ªtokenåœ¨å…¶ä¹‹å‰çš„paddingä¸ªæ•°<br>  <code>cum_seqlens</code>ï¼š<code>[batch size + 1]</code>ç¬¬ä¸€ä¸ªå¥å­ç´¯ç§¯é•¿åº¦æ˜¯å®ƒæœ¬èº«ï¼Œç¬¬äºŒä¸ªå¥å­ç´¯ç§¯é•¿åº¦æ˜¯ç¬¬ä¸€å¥+ç¬¬äºŒå¥é•¿åº¦<br>  <code>input_lengths</code>ï¼š<code>[batch size]</code>æ¯ä¸ªå¥å­çš„è¾“å…¥é•¿åº¦ï¼Œæœ¬èº«çš„<br>  <code>launchCalPaddingoffset</code>å‡½æ•°çš„ç›®çš„æ˜¯è¾“å‡ºpaddingä¸ªæ•°å’Œç´¯ç§¯é•¿åº¦</li><li>ä¾‹å­ï¼š<br>  11100<br>  11000<br>  11111<br>  batch size = 3<br>  seqlen = [3, 2, 5]<br>  max_q_len = 5<br>  padding_offset = [0, 0, 0, 0, 0<br>              2, 2, 2, 2, 2<br>              5, 5, 5, 5, 5]<br>  cum_seqlens = [0, 3, 5, 10]</li></ul><p>ç›¸æ¯”äº<code>Lesson2</code>ä¸­çš„æ¨¡æ¿åŒ–ï¼Œè¿™é‡Œä¸éœ€è¦æ¨¡æ¿åŒ–çš„åŸå› æ˜¯ï¼Œè¯¥å‡½æ•°çš„å‚æ•°éƒ½æ˜¯<code>int</code>ç±»å‹ï¼Œè€Œ<code>Lesson2</code>ä¸­çš„æ˜¯<code>T</code>ç±»å‹ï¼Œéœ€è¦å¯¹å…¶åš<code>FP16</code>å’Œ<code>FP32</code>çš„æ¨¡æ¿åŒ–</p><p><code>src/kernels/cal_paddingoffset.cu</code></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">__global__ void CalPaddingoffset(int* &nbsp; &nbsp; &nbsp; &nbsp; padding_offset,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;int* &nbsp; &nbsp; &nbsp; &nbsp; cum_seqlens,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;const int* &nbsp; input_lengths, //actual input lens&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;const int &nbsp; &nbsp;batch_size,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;const int &nbsp; &nbsp;max_q_len) {&nbsp; &nbsp; // è‡ªå·±æ‰“çš„24-10-11&nbsp; &nbsp; int cum_offset = 0;&nbsp; &nbsp; int ind = 0;&nbsp; &nbsp; int total_seqlen = 0;&nbsp; &nbsp; for(int b = 0; b &lt; batch_size; b++) { // bå¯¹åº”æ¯ä¸ªbatchä¸­çš„ç¬¬b+1ä¸ªseq&nbsp; &nbsp; &nbsp; &nbsp; int seqlen = input_lengths[b]; &nbsp; &nbsp;// è·å–æ¯ä¸ªå¥å­é•¿åº¦&nbsp; &nbsp; &nbsp; &nbsp; cum_seqlens[b] = total_seqlen; &nbsp; &nbsp;// (1)å°†ç´¯ç§¯çš„seqlenå­˜å…¥åˆ°æ¯ä¸ªå¥å­ä¸­ï¼Œcum_seqlens[0] = 0, ..., cum_seqlens[0] = æœ€åä¸€ä¸ªå¥å­çš„å¥å­ç´¯ç§¯é•¿åº¦&nbsp; &nbsp; &nbsp; &nbsp; for( int i =0; i &lt; seqlen; i++) {&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; padding_offset[ind] = cum_offset; // (2)å°†ç´¯ç§¯çš„offsetå­˜å…¥åˆ°æ¯ä¸ªtokenä¸­ï¼Œpadding_offsetçš„ä¸‹æ ‡åº”è¯¥æ˜¯ä¸€ä¸ªç´¯ç§¯çš„å€¼ï¼Œæ‰€ä»¥åº”è¯¥åœ¨forçš„å¤–éƒ¨å®šä¹‰indç„¶åå–å…¶ä¸ºä¸‹æ ‡&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ind++;&nbsp; &nbsp; &nbsp; &nbsp; }&nbsp; &nbsp; &nbsp; &nbsp; cum_offset += max_q_len - seqlen; &nbsp; &nbsp; // è·å–æ¯ä¸ªå¥å­ç´¯ç§¯çš„offset&nbsp; &nbsp; &nbsp; &nbsp; total_seqlen += seqlen; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // è·å–æ¯ä¸ªå¥å­ç´¯ç§¯çš„å¥å­é•¿åº¦&nbsp; &nbsp; }&nbsp; &nbsp; cum_seqlens[batch_size] = total_seqlen;&nbsp; &nbsp; }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>kernel</code>å†™å®Œä¹‹åè¿˜éœ€è¦å†™<code>CMake</code>æ–‡ä»¶<br><code>test/unittest/CMakelist.txt</code>ï¼šå°†testç¼–è¯‘ä¸ºå¯æ‰§è¡Œæ–‡ä»¶</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">add_executable(cal_paddingoffset // â€»test_input_embedding.cu)target_link_libraries(cal_paddingoffset PUBLIC    //è¿™è¦å’Œâ€»å¤„çš„åç§°å¯¹åº”-lcudart-lcudadevrtpaddingoffset               // è¿™é‡Œå¯ä»¥è‡ªå·±èµ·)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>src/kernels/CMakelist.txt</code>(æ³¨æ„å’Œä¸Šé¢çš„åç§°çš„å¯¹åº”)</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">add_library(paddingoffset STATIC cal_paddingoffset.cu)set_property(TARGET paddingoffset PROPERTY CUDA_SEPARABLE_COMPILATION   ON)set_property(TARGET paddingoffset PROPERTY POSITION_INDEPENDENT_CODE ON)set_property(TARGET paddingoffset PROPERTY CUDA_RESOLVE_DEVICE_SYMBOLE ON)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h1 id="Lesson4-RMS-norm"><a href="#Lesson4-RMS-norm" class="headerlink" title="Lesson4 RMS norm"></a>Lesson4 RMS norm</h1><p>è®²è§£äº†ï¼š<br><code>src/kernels/rmsnorm_kernel.cu</code><br><code>src/kernels/rmsnorm_kernel.h</code><br><code>tests/unittests/test_rmsnorm.cu</code><br><code>src/utils/vectorize_utils.h</code><br><code>src/weights/llama/norm_weights.h</code></p><p><code>src/utils/vectorize_utils.h</code></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">template&lt;typename T&gt;struct Vec{&nbsp; &nbsp; using Type = T;&nbsp; &nbsp; static constexpr int size = 0;};// é™¤æ­¤ä¹‹å¤–è¿˜å®šä¹‰äº†float4(size=4)ï¼Œhalf2(size=2)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>static</code>ï¼šè¡¨ç¤ºè¯¥æˆå‘˜<code>size</code>å±äºç±»è€Œä¸æ˜¯æŸä¸ªå®ä¾‹(å¯¹è±¡)<br><code>constexpr</code>ï¼šå®šä¹‰ä¸€ä¸ªé™æ€çš„ç±»æˆå‘˜ï¼Œå¹¶ä¸”è¯¥æˆå‘˜æ˜¯ä¸€ä¸ªç¼–è¯‘æ—¶å¸¸é‡ï¼Œåœ¨ç¼–è¯‘æ—¶å°±ç¡®å®š<br><code>float4</code>å’Œ<code>half2</code>åˆ†åˆ«æ˜¯åŒ…å«4ä¸ª<code>float</code>åˆ†é‡çš„å‘é‡å’ŒåŒ…å«2ä¸ª<code>half</code>åˆ†é‡çš„å‘é‡<br>ä½œç”¨æ˜¯å­˜å‚¨é€šç”¨çš„å‘é‡åŒ–æ•°æ®ç»“æ„</p><p><code>src/weights/llama/norm_weights.h</code></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">template&lt;typename T&gt;  struct LayerNormWeight {      T* gamma; };<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="4-1src-kernel-rmsnorm-kernel-cu"><a href="#4-1src-kernel-rmsnorm-kernel-cu" class="headerlink" title="4.1src/kernel/rmsnorm_kernel.cu"></a>4.1<code>src/kernel/rmsnorm_kernel.cu</code></h2><p>(1)<code>warpReduceSum</code></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">template&lt;typename T&gt;  __device__ T warpReduceSum(T val){      for(int i = 32 / 2; i &gt; 0; i &gt;&gt;= 1){          val += __shfl_xor_sync(0xffffffff, val, i);      }        return val; // æœ€åè¿™ä¸ªwarpçš„ç»“æœä¿å­˜åœ¨ç¬¬ä¸€ä¸ªç¬¬ä¸€ä¸ªçº¿ç¨‹(threadIdx.x=0)}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å°†ä¸€ä¸ªwarpä¸­çš„æ•°æ®åŠ èµ·æ¥</p><p>(2)<code>blockReduceSum</code></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">template&lt;typename T&gt;  __device__ T blockReduceSum(T val){      int tid = threadIdx.x;      it wid = tid / 32;      int laneid = tid % 32;      int warpnum = (blockDim.x + 32 - 1) / 32;      val = warpReduceSum&lt;T&gt;(val);     // valæ˜¯æ¯ä¸ªwarpçš„æ€»å’Œçš„å€¼    static __shared__ T warpsum[64]; // ä¸èƒ½å†™warpnumï¼Œå› ä¸ºç”³è¯·çš„æ˜¯é™æ€çš„ï¼Œéœ€è¦ä¼ å…¥ç¼–è¯‘æœŸå¸¸é‡64    if(landid == 0) // å¦‚æœæ˜¯wrapçš„ç¬¬ä¸€ä¸ªçº¿ç¨‹(å­˜æœ‰è¯¥wrapçš„ç»“æœ)    {     warpsum[wid] = val; // å°†æ¯ä¸ªwarpçš„æ±‚å’Œæ”¾å…¥warpsumä¸­    }        __syncthreads(); // å¤„ç†å®Œå…±äº«å†…å­˜çš„è¯»å†™åè¦åŠ ä¸Š`__syncthreads();!!!    T sum = tid &lt; warpnum ? warpsum[wid] : (T)0;     // å¤„ç†å‰warpnumä¸ªwarpsum[wid]ï¼Œå¹¶ä¸”ç¡®ä¿ä½¿ç”¨çº¿ç¨‹idä¸º0~warpnum-1æ¥å¤„ç†    sum = warpReduceSum&lt;T&gt;(sum);      return sum;}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å°†ä¸€ä¸ªblockçš„æ•°æ®åŠ èµ·æ¥<br>å‚æ•°ï¼š<br>    <code>tid</code>ï¼šå…¨å±€çš„thread idx (0<del>?)<br>    <code>wid</code>ï¼šwrap idxï¼Œæ¯32ä¸ªthreadsä¸ºä¸€ä¸ªwrap (0</del>?)<br>    <code>laneid</code>ï¼šwrapä¸­çš„threadçš„ç¼–å·(0~31)<br>    <code>warpnum</code>ï¼šç”¨åˆ°çš„warpçš„ä¸ªæ•°ï¼Œæœ€å°ä¸º1ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦å‘ä¸Šå–æ•´<br>    <code>warpsum</code>ï¼šå¤§å°ä¸º64çš„ç±»å‹ä¸ºTçš„æ•°ç»„ï¼Œå­˜æ”¾æ¯ä¸ªwarpçš„æ€»å’Œ</p><p>(3)<code>RMSNorm</code><br>è®¡ç®—å…¬å¼ï¼š$\dfrac{x_iÃ—g_i}{\sqrt{\sum^iE(x_i^2)+eps}}$</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">template &lt;typename T&gt;  __global__ void RMSNorm(T* decoder_in,                        T* decoder_residual,                          T* scale, //[q_hidden_units], RMSNorm weights                          float eps, //RMSNorm eps                          int num_tokens,                          int hidden_units) {  }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å‚æ•°ï¼š<br>    <code>decoder_in</code>ï¼šæ˜¯è¾“å…¥åŒæ—¶ä¹Ÿæ˜¯è¾“å‡ºä½ç½®ï¼Œ<code>[num tokens, q_hidden_units]</code><br>    <code>decoder_residual</code>ï¼šæš‚æ—¶ä¸çŸ¥é“è¿™ä¸ªçš„ç”¨å¤„<br>    <code>scale</code>ï¼šå¯å­¦ä¹ çš„å‚æ•°(æƒé‡)ï¼Œ<code>[q_hidden_units]</code><br>    <code>eps</code>ï¼šå¾ˆå°çš„æ­£æ•°<br>    <code>num_tokens</code>ï¼štokençš„ä¸ªæ•°<br>    <code>hidden_units</code>ï¼šéšè—å±‚çš„å•å…ƒçš„æ•°é‡</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">int vec_size = Vec&lt;T&gt;::size;using Vec_t = typename Vec&lt;T&gt;::Type;  Vec_t *dout = reinterpret_cast&lt;Vec_t*&gt;(decoder_in + blockIdx.x * hidden_units); // æ¯ä¸ªçº¿ç¨‹éœ€è¦è¯»çš„æ•°æ®çš„åç§»; blockçš„æ•°é‡æ˜¯tokençš„æ•°é‡  Vec_t *rsd = reinterpret_cast&lt;Vec_t*&gt;(decoder_residual * blockIdx.x * hidden_units);  float thread_sum = 0.0f;  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å‚æ•°ï¼š<br>    <code>vec_size</code>ï¼šè¯»å–vectorçš„å¤§å°ï¼Œæ¯”å¦‚<code>float4</code>çš„å‘é‡ä¸ªæ•°ä¸º4ï¼Œ<code>half2</code>çš„å‘é‡ä¸ªæ•°ä¸º2<br>    <code>Vec_t</code>ï¼šè¯»å–ç±»å‹å¹¶å­˜åˆ°<code>Vec_t</code>ä¸­<br>        ï¼å‰ä¸€å¥æ²¡æœ‰ç”¨<code>typename</code>è€Œåä¸€å¥ç”¨äº†çš„åŸå› æ˜¯ï¼š<br>        â‘ å‰è€…å±äºéä¾èµ–å‹ï¼Œ<code>size</code>çš„å€¼åœ¨ç¼–è¯‘æ—¶å¯ä»¥ç¡®å®šï¼Œä¸<code>T</code>dçš„å…·ä½“ç±»å‹æ— å…³ï¼›<br>        â‘¡åè€…æ—¶ä¾èµ–ç±»å‹ï¼Œ<code>Type</code>æ˜¯ä¸€ä¸ªç±»å‹åˆ«åï¼Œå–å†³äº<code>T</code>ï¼Œå› æ­¤éœ€è¦<code>typename</code>å…³é”®å­—æ¥å‘Šè¯‰ç¼–è¯‘å™¨ä»–æ˜¯ä¸€ä¸ªç±»å‹<br>    <code>dout</code>ï¼šæ ¹æ®çº¿ç¨‹æŒ‡å‘æ¯ä¸€ä¸ªä»¥è¾“å…¥å‘é‡ä¸ºèµ·å§‹çš„<code>block</code>çš„å¼€å¤´ï¼Œæ¯ä¸€ä¸ª<code>block</code>å¯¹åº”ä¸€ä¸ª<code>token</code>ï¼Œæ¯ä¸ª<code>block</code>ä¹‹é—´ç›¸å·®å¤§å°ä¸º<code>hidden units</code>çš„é—´éš”<br>    <code>rsd</code>ï¼šåŒ<code>dout</code><br>    <code>thread_sum</code>ï¼šç”¨äºæ±‚å’Œ</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">for (int idx = threadIdx.x; idx &lt; hidden_units / vec_size; idx += blockDim.x) {          Vec_t vec = dout[idx];        rsd[idx] = vec;          thread_sum += vec.x * vec.x;          thread_sum += vec.y * vec.y;          thread_sum += vec.z * vec.z;          thread_sum += vec.w * vec.w;      }    thread_sum = blockReduceSum&lt;float&gt;(thread_sum);  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç”¨äºæ±‚$\sum^iE(x_i)$ï¼Œæ¯ä¸ªblockå¾—åˆ°ä¸€ä¸ªæ€»å’Œ<br>å‚æ•°ï¼š<br>    <code>vec</code>ï¼šå°†<code>dout[idx]</code>çš„æ•°æ®å­˜åˆ°vecä¸­<br>    <img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/LLM2%E6%8E%A8%E7%90%86%E5%BC%95%E6%93%8E/492e42f3b277fbb6c44c818fa908be8.jpg" alt="|225"><br>    <code>thread_sum</code>ï¼šæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªç§æœ‰çš„å‰¯æœ¬<br>æ³¨æ„ï¼š<br>    <code>idx</code>çš„èŒƒå›´æ˜¯ä»<code>threadIdx.x</code>å¼€å§‹çš„ï¼ŒèŒƒå›´æ˜¯0~`blockDim.x-1<code>     å› æ­¤æ¯ä¸ªforå¾ªç¯å®é™…åªå¤„ç†äº†ä¸€ä¸ªblockçš„æ±‚å’Œï¼Œ</code>idx+=blockDimx.x`ä½¿å¾—å¯ä»¥å¯¹ä¸‹ä¸€ä¸ªblockè¿›è¡Œæ±‚å’Œ<br>    æ‰€ä»¥è¯´è¿™é‡Œçš„æ±‚å’Œæ˜¯blockå±‚é¢çš„ï¼Œä¹Ÿæ˜¯æ¯ä¸ªtokenå±‚é¢çš„</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">__shared__ float inv_mean;  if (threadIdx.x == 0) {      inv_mean = rdqrtf(thread_sum / hidden_units + eps);  }    __syncthreads(); // share memory inv_meanå†™å…¥å®Œæˆåè¦åŠ ä¸Šè¿™å¥è¯  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç”¨äºè®¡ç®—å¹³å‡å€¼$inv_mean\dfrac{1}{\sqrt{\sum^iE(x_i^2)+eps}}$<br>    <code>inv_mean</code>ï¼šå› ä¸ºå‡å€¼æ˜¯<code>block</code>å±‚é¢çš„ï¼Œæ‰€ä»¥æœ€å¥½æŠŠå®ƒè®¾ä¸ºshare memory<br>    share memoryå†™å…¥å®Œæˆåè¦åŠ ä¸Š<code>__syncthreads();</code></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">Vec_t *s = reinterpret_cast&lt;Vec_t *&gt;(scale);      for (int idx = threadIdx.x; idx &lt; hidden_units / vec_size; idx += blockDim.x) {          Vec_t vec = dout[idx];          dout[idx].x = vec.x * inv_mean * s[idx].x; // å› ä¸ºè¾“å…¥è¾“å‡ºéƒ½æ˜¯decoder_inï¼Œæ‰€ä»¥éœ€è¦å®å®åœ¨åœ¨åœ°è¿›dout[idx]è¿™ä¸ªæŒ‡é’ˆæŒ‡å‘çš„bufferï¼Œç­‰å·å·¦è¾¹ä¸èƒ½ç”¨vec          dout[idx].y = vec.y * inv_mean * s[idx].y; // å› ä¸ºvec sizeæ˜¯4ï¼Œæ‰€ä»¥ç´¯åŠ 4æ¬¡          dout[idx].z = vec.z * inv_mean * s[idx].z;          dout[idx].w = vec.w * inv_mean * s[idx].w;      }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç”¨äºè®¡ç®—$inv_mean Ã— x_i Ã—g_i$<br>æ³¨æ„ï¼šéœ€è¦æŠŠç»“æœå†™å›<code>dout</code>ä¸­</p><p>(4)<code>launchRMSNorm</code></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">template&lt;typename T&gt;  void launchRMSNorm( TensorWrapper&lt;T&gt;* decoder_out,                    TensorWrapper&lt;T&gt;* decoder_residual,                    LayerNormWeight&lt;T&gt;&amp; attn_norm_weight,                    bool is_last                     ){      int num_tokens = decoder_out-&gt;shape[0];      int hidden_units = decoder_out-&gt;shape[1];      int vec_size = Vec&lt;T&gt;::size;      int num_threads = hidden_units / 4;    T* rsd = decoder_residual-&gt;data;      dim3 grid(num_tokens);   // num_tokensä¸ªblock    dim3 block(num_threads); // hidden_units / 4ä¸ªblock    RMSNorm&lt;T&gt;&lt;&lt;&lt;grid, block&gt;&gt;&gt;(decoder_out-&gt;data,                              rsd,                              attn_norm_weight.gamma, // scale                            eps,                              num_tokens,                              hidden_units);}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="Lesson5-Casual-Mask"><a href="#Lesson5-Casual-Mask" class="headerlink" title="Lesson5 Casual Mask"></a>Lesson5 Casual Mask</h1><p>è®²è§£äº†ï¼š<br><code>src/kernels/build_casual_mask.cu</code><br><code>src/kernels/build_casual_mask.h</code><br><code>tests/unittests/test_casual_mask.cu</code></p><p><code>src/kernel/build_casual_mask.cu</code></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">template&lt;typename T&gt;  __global__ void BuildCausalMasksConsideringContextPastKV(T* mask,                                                const int* q_lens,                                                const int* k_lens,                                                int max_q_len,                                                 int max_k_len){    int tid = threadIdx.x;      int qlen = q_lens[blockIdx.x];    int klen = k_lens[blockIdx.x];    mask += blockIdx.x * max_k_len * max_q_len; // æ¯ä¸ªblockåªæœ‰256ä¸ªçº¿ç¨‹ï¼Œç›¸åº”çš„ï¼Œmaskä¹Ÿéœ€è¦æœ‰åç§»é‡ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªmaskä¸Šï¼Œä¸blockçš„ç§»åŠ¨åŒæ­¥      while(tid &lt; max_k_len * max_q_len){          int q = tid / max_k_len; // ç›®å‰å¤„äºå“ªä¸€è¡Œ          int k = tid % max_k_len; // ç›®å‰å¤„äºå“ªä¸€åˆ—          bool is_one = q &lt; qlen &amp;&amp; k &lt; klen &amp;&amp; k &lt;= q + (klen - qlen);          mask[tid] =  static_cast&lt;T&gt;(is_one);          tid += blockDim.x;     }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å‚æ•°ï¼š<br>    <code>mask</code>ï¼š<code>[batch_size, max_q_len, max_k_len]</code>æ¯ä¸ª<code>mask</code>æ˜¯ä¸€ä¸ªçŸ©é˜µï¼Œç”¨äºè¡¨ç¤ºå“ªäº›tokenå¯¹äºç›®å‰å¯¹è¯æ˜¯å¯è§çš„(ç½®1)å’Œä¸å¯è§çš„(ç½®0)<br>    <code>q_lens</code>ï¼š<code>[batch_size]</code>ï¼Œä½œä¸ºinput lensï¼Œæˆ‘çš„ç†è§£æ˜¯å½“å‰å¯¹è¯çš„è¾“å…¥<br>    <code>k_lens</code>ï¼š<code>[batch_size]</code>ï¼Œä½œä¸ºcontext lensï¼Œæˆ‘çš„ç†è§£æ˜¯ç»“åˆä¸€å®šç¨‹åº¦çš„ä¸Šä¸‹æ–‡çš„è¾“å…¥<br>    <code>max_q_len</code>&amp;<code>max_k_len</code>ï¼šåˆ†åˆ«æ˜¯<code>q_lens</code>å’Œ<code>k_lens</code>ä¸­æœ€å¤§çš„<br>ç†è§£ï¼š</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">int qlen = q_lens[blockIdx.x];int klen = k_lens[blockIdx.x];<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ğŸ‘†æ¯ä¸ª<code>block</code>å¯¹åº”ä¸€ä¸ªå¯¹è¯ï¼Œ<code>batch_size</code> = å¯¹è¯ä¸ªæ•°ã€‚è¿™é‡Œæ˜¯åˆ†åˆ«å–æ¯ä¸ªå¯¹è¯çš„<code>qlen</code>å’Œ<code>klen</code></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">mask += blockIdx.x * max_k_len * max_q_len;   while(tid &lt; max_k_len * max_q_len){         int q = tid / max_k_len; // ç›®å‰å¤„äºå“ªä¸€è¡Œ         int k = tid % max_k_len; // ç›®å‰å¤„äºå“ªä¸€åˆ—         bool is_one = q &lt; qlen &amp;&amp; k &lt; klen &amp;&amp; k &lt;= q + (klen - qlen);         mask[tid] = static_cast&lt;T&gt;(is_one);         tid += blockDim.x;    }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>ä¸ºäº†ç¡®ä¿<code>mask</code>é‡Œçš„æ¯ä¸ªæ•°éƒ½èƒ½è¢«å¤„ç†åˆ°ï¼ˆç¬¬ä¸‰å¥å¾ˆé‡è¦ï¼‰<ul><li><code>mask[tid] = static_cast&lt;T&gt;(is_one); </code>ï¼š<code>block</code>ä¸­çš„ä¸€ä¸ªçº¿ç¨‹å¯¹åº”<code>mask</code>é‡Œçš„ä¸€ä¸ªæ•°ï¼Œä½†æ˜¯<code>blockDim.x=256</code>ï¼Œæ‰€ä»¥éœ€è¦åŠ ä¸Šç¬¬ä¸‰å¥è¯</li><li>å¾ªç¯æ¡ä»¶<code>tid &lt; max_k_len * max_q_len</code>ï¼šç¡®ä¿æ¯ä¸ªæ•°éƒ½æœ‰å¯¹åº”çº¿ç¨‹å¤„ç†</li><li><code>mask += blockIdx.x * max_k_len * max_q_len;</code>ï¼š</li><li><code>mask</code>çš„å¤§å°ï¼<code>block</code>çš„çº¿ç¨‹æ•°çš„æƒ…å†µğŸ‘‡</li></ul></li></ul><p>é‚£ä¹ˆå°±æ˜¯ä¸€ä¸ª<code>block</code>å¤„ç†ä¸€ä¸ª<code>mask</code>ï¼Œå¦‚æœ<code>block</code>å¤§å°å°äº<code>mask</code>çš„è¯ï¼Œå°±ç»§ç»­ç”¨è¯¥<code>block</code>çš„çº¿ç¨‹å¤„ç†<code>mask</code>å‰©ä½™çš„æ•°</p><h1 id="Lesson6-Linear"><a href="#Lesson6-Linear" class="headerlink" title="Lesson6 Linear"></a>Lesson6 Linear</h1><p>è®²è§£äº†ï¼š<br><code>src/kernels/cublas_utils.h</code>ï¼šå®šä¹‰cublasç±»<br><code>src/kernels/cublas_utils.cc</code>ï¼šå®ç°cublasç±»<br><code>src/kernels/linear.cu</code><br><code>src/kernels/linear.h</code><br><code>tests/unittests/test_linear.cu</code></p><h2 id="6-1-cublasç±»çš„å£°æ˜ä¸å®šä¹‰"><a href="#6-1-cublasç±»çš„å£°æ˜ä¸å®šä¹‰" class="headerlink" title="6.1 cublasç±»çš„å£°æ˜ä¸å®šä¹‰"></a>6.1 cublasç±»çš„å£°æ˜ä¸å®šä¹‰</h2><p><code>src/kernels/cublas_utils.h</code></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">class cublasWrapper {  private:      cublasHandle_t cublas_handle;    cudaDataType_t Atype;    cudaDataType_t Btype;    cudaDataType_t Ctype;    cublasComputeType_t computeType;public:      cublasWrapper(cublasHandle_t cublas_handle);      ~cublasWrapper();    void setFP32GemmConfig();    void setFP16GemmConfig();    void Gemm(cublasOperation_t transa,                cublasOperation_t transb,                const int         m,                const int         n,                const int         k,                const void*       A,                const int         lda,                const void*       B,                const int         ldb,                void*             C,                const int         ldc,                float             alpha,                float             beta);          // for qk*v and q*k        void stridedBatchedGemm(cublasOperation_t transa,                          cublasOperation_t transb,  const int         m,  const int         n,  const int         k,  const void*       A,  const int         lda,  const int64_t     strideA,  const void*       B,  const int         ldb,  const int64_t     strideB,  void*             C,  const int         ldc,  const int64_t     strideC,  const int         batchCount,  float             f_alpha,  float             f_beta);  };<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ğŸ‘†å£°æ˜<code>cublasWrapper</code>ç±»ï¼Œ<code>batchedGemm</code>ç›¸å¯¹äº<code>Gemm</code>å¤šäº†æ­¥é•¿<code>stride</code>å’Œ<code>batchCount</code></p><p>å®šä¹‰éƒ¨åˆ†ï¼š<br>â‘ æ„é€ å‡½æ•°</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">cublasWrapper::cublasWrapper(cublasHandle_t cublas_handle,                               cublasLtHandle_t cublaslt_handle):      cublas_handle(cublas_handle),      cublaslt_handle(cublaslt_handle){  }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>cublasHandle_t</code>æ˜¯cublasåº“ä¸­çš„ä¸€ä¸ªç±»å‹ï¼Œä¸å¥æŸ„æœ‰å…³</li><li>ä¼ å…¥<code>cublas_handle</code>è¿”å›åˆ°ç±»ä¸­çš„<code>cublas_handle_</code></li><li><code>cublasHandle_t</code>å’Œ<code>cublasLtHandle_t</code><ul><li><code>cublasHanle_t</code>ï¼šç”¨äºä¸€èˆ¬çš„çº¿æ€§ä»£æ•°è¿ç®—ï¼ˆå¦‚å‘é‡å’ŒçŸ©é˜µæ“ä½œï¼‰</li><li><code>cublasLtHandle_t</code>ï¼šç”¨äºæ›´é«˜çº§çš„çŸ©é˜µè¿ç®—ï¼Œç‰¹åˆ«æ˜¯è‡ªå®šä¹‰å’Œä¼˜åŒ–çŸ©é˜µä¹˜æ³•ï¼ˆGEMMï¼‰ï¼Œåœ¨éœ€è¦å¤æ‚é…ç½®æˆ–å¤šç§æ•°æ®ç±»å‹æ—¶æœ‰ç”¨å¤„</li></ul></li></ul><p>â‘¡å•ç²¾åº¦ä¸åŠç²¾åº¦çš„é…ç½®</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">void cublasWrapper::setFP32GemmConfig()  {      Atype       = CUDA_R_32F;      Btype       = CUDA_R_32F;      Ctype       = CUDA_R_32F;      computeType = CUBLAS_COMPUTE_32F; // }    void cublasWrapper::setFP16GemmConfig()  {      Atype       = CUDA_R_16F;      Btype       = CUDA_R_16F;      Ctype       = CUDA_R_16F;      computeType = CUBLAS_COMPUTE_16F;  }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>å¯¹äº<code>computeType</code>ï¼Œå½“cuda version&lt;11.0æ—¶ç”¨CUDA_R_32Fï¼Œcuda version&gt;11.0æ—¶ä½¿ç”¨CUBLAS_COMPUTE_32Fï¼ŒåŠç²¾åº¦çš„åŒç†</li></ul><p>â‘¢ä¸º<code>alpha</code>å’Œ<code>beta</code>èµ‹å€¼</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">const void* alpha = is_fp16_computeType ? reinterpret_cast&lt;void*&gt;(&amp;(h_alpha)) : reinterpret_cast&lt;void*&gt;(&amp;f_alpha);  const void* beta  = is_fp16_computeType ? reinterpret_cast&lt;void*&gt;(&amp;(h_beta)) : reinterpret_cast&lt;void*&gt;(&amp;f_beta);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>å¦‚æœ<code>is_fp16_computeTyp</code>ä¸º1ï¼Œåˆ™ä¼ å…¥åŠç²¾åº¦çš„<code>alpha</code>ç»™<code>alpha</code>ï¼Œ<code>beta</code>åŒç†</li></ul><p>â‘£å…³äºbatchedGemmä¸GemmåŒç†</p><h2 id="6-2-Gemm"><a href="#6-2-Gemm" class="headerlink" title="6.2 Gemm"></a>6.2 Gemm</h2><p><code>src/kernels/linear.cu</code></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">template&lt;typename T&gt;  void launchLinearGemm(TensorWrapper&lt;T&gt;* input,                        BaseWeight&lt;T&gt;&amp; weight,     TensorWrapper&lt;T&gt;* output,                        cublasWrapper* cublas_wrapper,                        bool trans_a = false,                        bool trans_b = false){                      {  Bk = input-&gt;shape.size() == 3 ? input-&gt;shape[1] * input-&gt;shape[2] : input-&gt;shpe[1];  Cm = output-&gt;shape.size() == 3 ? output-&gt;shape[1] * output-&gt;shape[2] : output-&gt;shpe[1];    int lda = Am;  int ldb = Bk;  int ldc = Cm;  cublasOperation_t transA = trans_b ? CUBLAS_OP_T : CUBLAS_OP_N; cublasOperation_t transB = trans_a ? CUBLAS_OP_T : CUBLAS_OP_N;// å¯èƒ½ä¼šå‡ºç°è¾“å…¥ä¸º[bs, 1, hiddenunits] * [hiddenunits, hiddenunits]ï¼Œæ‰€ä»¥éœ€è¦æ£€æŸ¥è¾“å…¥çš„ç»´åº¦if(!trans_b &amp;&amp; !trans_a){       LLM_CHECK_WITH_INFO(Ak == Bk, "2nd dim of input MUST = 1st dim of weight!");  }    cublas_wrapper-&gt;Gemm(transA,                       transB,                       trans_b ? Ak : Am,           // m                     Cn,                          // n                     Bk,                          // k                     weight.data,                       lda,                       input-&gt;data,                       ldb,                       output-&gt;data,                       ldc,                       1.0f,                       0.0f);}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>â‘  å…³äºAã€Bã€C<br>(1)ä¸€èˆ¬çš„gemm<br>Aï¼š<code>input shape = [seqlen, hidden_units]</code><br>Bï¼š<code>weight shape = [hidden_units, hidden_units]</code><br><code>A * B = C with trans_b = false</code></p><p>å¯¹äºqkvlinearï¼Œæ˜¯æŒ‡å°†ä¸‰æ¬¡çŸ©é˜µä¹˜æ³•èåˆåˆ°ä¸€æ¬¡<br><code>input=[seqlen, hidden_units]</code><br><code>weight shape = [hidden_units, 3Ã—hidden_units]</code></p><p>(2)å‡ºç°åœ¨samplingçš„<code>LMHead</code><br>Aï¼š<code>input shape = [batch_size, hidden_units]</code><br>Bï¼š<code>weight_shape = [vocabulary_size, hidden_units]</code><br><code>A * B = C with transb = true</code></p><p>â‘¡é‡ç‚¹ä¸éš¾ç‚¹ï¼š</p><ul><li><code>torch.nn.linear</code>çš„è®¡ç®—å…¬å¼æ˜¯$y=xÃ—w^T$ï¼Œä¿®æ”¹ä¹‹å‰æ˜¯$y=xÃ—w$ï¼Œå› æ­¤<code>trans_b=True</code></li><li>cublas APIæ¥å—çš„è¾“å…¥ä»¥åŠè¾“å‡ºçš„å†…å­˜æ’å¸ƒå…¨éƒ¨éƒ½é»˜è®¤ä¸º<strong>åˆ—ä¸»åº(column-major)</strong><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/LLM2%E6%8E%A8%E7%90%86%E5%BC%95%E6%93%8E/Pasted%20image%2020241019161646.png"></li><li>å› æ­¤ï¼Œæˆ‘ä»¬çš„æ€è·¯æ˜¯<ul><li>ä»åŸæœ¬çš„$y=xÃ—w$ï¼Œå› ä¸º<code>nn</code>çš„è®¡ç®—æ–¹å¼</li><li>åŠ ä¸Š<code>trans_b=True</code>åå¯ä»¥å®ç°$y=xÃ—w^T$ï¼Œå› ä¸ºåˆ—ä¸»åº(ä»è¡Œä¸»åºåˆ°åˆ—ä¸»åºéœ€è¦å°†ä¸¤è¾¹åŒæ—¶è½¬ç½®)<ul><li>è¿™é‡Œçš„<code>trans_b</code>å¯¹åº”çš„æ˜¯åŸæœ¬æˆ‘ä»¬ç†è§£çš„$y=xÃ—w$å…¬å¼ï¼Œ<code>trans_b</code>å¯¹åº”$w$</li><li>å˜æˆcolumn majorä¹‹å<code>A</code>å¯¹åº”$w^T$ï¼Œæ‰€ä»¥æ˜¯ç”¨<code>trans_b</code>å†³å®š<code>trans_A</code></li></ul></li><li>å°†$y=xÃ—w^T$å˜æˆ$y^T=wÃ—x^T$åå¯ä»¥å®ç°åˆ—åºåˆ—çš„è¦æ±‚ï¼Œé‚£ä¹ˆå¯¹åº”$y=xÃ—w$å°±åº”è¯¥å˜æˆ$y^T=w^TÃ—x^T$</li><li>å³ä»åŸå§‹çš„$y=xÃ—w$å˜æˆæˆ‘ä»¬éœ€è¦çš„å…¬å¼ï¼Œåªéœ€è¦<ul><li>æ·»åŠ <code>trans_b=True</code></li><li>å…¬å¼$y^T=w^TÃ—x^T$</li></ul></li></ul></li></ul><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">int Am = weight.shape[1];int Ak = weight.shape[0];  int Bk = input-&gt;shape[1];  int Bn = input-&gt;shape[0];  int Cm = output-&gt;shape[1];  int Cn = output-&gt;shape[0];<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="6-3-StrideBatchGemm"><a href="#6-3-StrideBatchGemm" class="headerlink" title="6.3 StrideBatchGemm"></a>6.3 StrideBatchGemm</h2><p>â‘ å…³äºinput1å’Œinput2<br>$qÃ—k$<br>input1ï¼š<code>q shape = [batch_size, head_nums, seqlen(=len_q), hidden_units]</code><br>input2ï¼š<code>k shape = [batch_size, head_nums, seqlen(=len_k), hidden_units]</code><br><code>A * B = C with trans_b = true</code><br>$qkÃ—v$<br>input1ï¼š<code>qk shape = [batch_size, head_nums, seqlen(=len_q), seqlen(=len_k)]</code><br>input2ï¼š<code>v shape = [batch_size, head_nums, seqlen(=len_k), hidden_units]</code><br><code>A * B = C with transb = false</code><br>å®é™…ä¸Šåœ¨<code>src/kernels/linear.cu</code>ä¸­å¤„ç†è¿‡ç¨‹ä¸Gemmå·®ä¸å¤š</p><p>â‘¡StrideBatchGemmå’ŒBatchGemmç›¸æ¯”<br>å‡å¦‚<code>A=[1,2,3,4]</code></p><ul><li>StrideBatchå¤šä¸€ä¸ª<code>Stride</code>å˜é‡ï¼Œç”¨äºä½œåœ°å€åç§»å–å‡ºè¦ç›¸ä¹˜çš„å€¼ï¼Œåç§»é‡ç­‰äº<code>A[i]</code>å’Œ<code>A[i+1]</code>ä¹‹é—´çš„è·ç¦»<ul><li>=3*4</li></ul></li><li>ä¸¤ä¸ªéƒ½æœ‰<code>batchCount</code>å˜é‡<ul><li>å¯¹äºStrideBatchæ˜¯æ¯ä¸ªæ‰¹æ¬¡ä¸­éœ€è¦ç›¸ä¹˜çš„çŸ©é˜µä¸ªæ•° = 1*2</li><li>BatchGemmæ˜¯Aã€Bã€Cä¸­æŒ‡é’ˆä¸ªæ•°ï¼ŒåŠçŸ©é˜µä¸ªæ•°</li></ul></li></ul><h2 id="6-4-å…¶ä»–"><a href="#6-4-å…¶ä»–" class="headerlink" title="6.4 å…¶ä»–"></a>6.4 å…¶ä»–</h2><p><code>cublasHanle_t</code>ç”¨äºå®šä¹‰ä¸€ä¸ªå¥æŸ„ï¼Œç”¨äºç®¡ç†å’Œé…ç½® <code>cuBLAS</code> åº“ä¸­çš„æ‰€æœ‰å‡½æ•°è°ƒç”¨ï¼Œç±»ä¼¼ä¸€ä¸ªæ§åˆ¶å™¨(å¼€/å…³)</p><p>åˆå§‹åŒ–åˆ—è¡¨ä¾‹å­ ï¼š</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">class Person {public:////ä¼ ç»Ÿæ–¹å¼åˆå§‹åŒ–//Person(int a, int b, int c) {//m_A = a;//m_B = b;//m_C = c;//}//åˆå§‹åŒ–åˆ—è¡¨æ–¹å¼åˆå§‹åŒ–Person(int a, int b, int c) :m_A(a), m_B(b), m_C(c) {}void PrintPerson() {cout &lt;&lt; "mA:" &lt;&lt; m_A &lt;&lt; endl;cout &lt;&lt; "mB:" &lt;&lt; m_B &lt;&lt; endl;cout &lt;&lt; "mC:" &lt;&lt; m_C &lt;&lt; endl;...}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>RAII</code>æœºåˆ¶å¯ä»¥è‡ªåŠ¨ææ„æ‰ä¸€äº›ç±»æˆå‘˜å˜é‡</p><p>huggingfaceçš„7b chatä¸­linearçš„weightå…¨æ˜¯è½¬ç½®åçš„ï¼Œæ¯”å¦‚<code>gate</code>çš„æƒé‡åº”è¯¥æ˜¯<code>[q_hidden_units, inter_size]</code>ï¼Œä½†æ˜¯åœ¨huggingfaceé‡Œæ˜¯<code>[inter_size, q_hidden_units]</code>ï¼Œæ‰€ä»¥<code>launchLinearGemm</code>çš„<code>trans_b</code>å¯¹äºæ‰€æœ‰linear weightsæ¥è¯´éƒ½æ˜¯<code>true</code></p><h1 id="Lesson7-Debug-ä¸€"><a href="#Lesson7-Debug-ä¸€" class="headerlink" title="Lesson7 Debug(ä¸€)"></a>Lesson7 Debug(ä¸€)</h1><p><code>src/kernels/rmsnorm_kernel.cu</code></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">dout[idx].x = __float2half(vec.x * inv_mean) * s[idx].x;dout[idx].y = __float2half(vec.y * inv_mean) * s[idx].y;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>å‡ºç°å¦‚ä¸‹æŠ¥é”™ï¼š </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">error: <span class="token function">more</span> than one operator <span class="token string">"*"</span> matches these operands:built-in operator <span class="token string">"arithmetic * arithmetic"</span><span class="token keyword">function</span> <span class="token string">"operator*(const __half &amp;, const __half &amp;)"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>åœ¨ç¼–è¯‘å™¨æ‰§è¡Œä¹˜æ³•è¿ç®—æ—¶ï¼Œå‘ç°æœ‰å¤šä¸ªç¬¦åˆæ¡ä»¶çš„*æ“ä½œç¬¦ä½†æ˜¯ä¸ç¡®å®šåº”è¯¥ä½¿ç”¨å“ªä¸€ä¸ª</p><ul><li><code>built-in operator "arithmetic * arithmetic"</code>ï¼šè¿™æ˜¯CUDAæ”¯æŒçš„åŸºæœ¬ç®—æœ¯ç±»å‹ä¹‹é—´çš„ä¹˜æ³•æ“ä½œï¼ˆå¦‚æ•´æ•°æˆ–æµ®ç‚¹æ•°ï¼‰ã€‚</li><li><code>function "operator*(const __half &amp;, const __half &amp;)"</code>ï¼šè¿™æ˜¯CUDAä¸­é’ˆå¯¹<code>__half</code>ç±»å‹ï¼ˆå³åŠç²¾åº¦æµ®ç‚¹æ•°ï¼‰æä¾›çš„ä¹˜æ³•æ“ä½œç¬¦ã€‚<br>è§£å†³æ–¹æ³•ï¼š<br>å°†ä»£ç æ”¹ä¸º<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">dout[idx].x = s[idx].x * __float2half(__half2float(vec.x) * inv_mean);dout[idx].y = s[idx].y * __float2half(__half2float(vec.y) * inv_mean);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ul><p>ç¼–è¯‘é¡ºåºä»<code>kernels</code>åˆ°<code>tests</code>åŸå› ï¼š</p><ul><li>ç¼–è¯‘<code>tests</code>æ—¶éœ€è¦è°ƒç”¨åˆ°<code>src/kernels</code>çš„cudaå‡½æ•°æˆ–è€…launchå‡½æ•°ï¼Œæ‰€ä»¥éœ€è¦å…ˆç¼–è¯‘<code>kernels</code>æ–‡ä»¶ä¸‹çš„</li><li>åœ¨æ ¹ç›®å½•ä¸‹çš„<code>CMakeList.txt</code>ä¸­æœ‰å…ˆåé¡ºåº<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">add_subdirectory(src)add_subdirectory(tests)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ul><h1 id="Lesson8-RoPE"><a href="#Lesson8-RoPE" class="headerlink" title="Lesson8 RoPE"></a>Lesson8 RoPE</h1><p><a href="https://www.53ai.com/news/qianyanjishu/1291.html">ä¸€æ–‡çœ‹æ‡‚ LLaMA ä¸­çš„æ—‹è½¬å¼ä½ç½®ç¼–ç ï¼ˆRotary Position Embeddingï¼‰</a><br>è®²è§£äº†ï¼š<br><code>src/kernels/qkv_bias_and_RoPE.cu</code><br><code>src/kernels/qkv_bias_and_RoPE.h</code><br><code>src/models/llama/llama_params.h</code><br><code>tests/unittests/test_bias_and_rope.cu</code><br><code>src/utils/vectorize_utils.h</code></p><p>æœ¬èŠ‚èåˆç®—å­çš„ä½œç”¨</p><ul><li>å°†<code>qkv bias</code>åŠ åˆ°<code>QKV</code>ä¸Šï¼Œ<code>QKV = [num tokens, qkv head num, head size]</code><ul><li><code>qkv head num</code> = <code>q head num</code> + <code>k head num</code> + <code>v head num</code></li><li><code>k head num</code> = <code>v head num</code></li></ul></li><li>paddingåï¼Œ<code>QKV</code>ä¼šè¢«åˆ†å‰²æˆä¸‰ä¸ªçŸ©é˜µ<code>q</code>ã€<code>k</code>ã€<code>v</code>ï¼Œ<ul><li>shape(q)=<code>[bs, q head num, max q len, head size]</code></li><li>shape(k/v)=<code>[bs, kv head num, max q len, head size]</code></li></ul></li><li>rope &amp; attention</li><li>å†™å›æ˜¾å­˜(gmem)</li></ul><p>è¾“å…¥ï¼š<br>    <code>QKV</code> shape=<code>[num tokens, qkv head num, head size]</code><br>    <code>qkv bias</code> shape = <code>[qkv head num, head size]</code><br>è¾“å‡ºï¼š<br>    <code>q</code>ï¼š<code>[bs, q head num, max q len, head size]</code><br>    <code>k</code>ï¼š<code>[bs, kv head num ,max q len, head size]</code><br>    <code>v</code>ï¼š<code>[bs, kv head num, max q len, head size]</code><br>    è¿™é‡Œçš„<code>max q len</code>å°±æ˜¯<code>seqlen</code><br>ä¸‹ä¸€èŠ‚ä¼šè®²åˆ°<code>repeat kv</code></p><h2 id="8-1-src-kernels-qkv-bias-and-RoPE-cu"><a href="#8-1-src-kernels-qkv-bias-and-RoPE-cu" class="headerlink" title="8.1 src/kernels/qkv_bias_and_RoPE.cu"></a>8.1 <code>src/kernels/qkv_bias_and_RoPE.cu</code></h2><p>llamaä½¿ç”¨çš„æ˜¯QGA(Grouped-Query Attention)ï¼Œé‡‡ç”¨çš„æ˜¯ä¸€ç»„Q(Nä¸ª)å…±äº«åŒä¸€ä¸ªKV</p><p><code>QKV</code>ç¬¬ä¸€ä¸ªç»´åº¦æ˜¯<code>token_num</code>ï¼Œå› æ­¤ç½‘æ ¼çš„ç¬¬ä¸€ä¸ªç»´åº¦xä¹Ÿæ˜¯<code>token_num</code>ï¼Œç½‘æ ¼çš„ç¬¬äºŒä¸ªç»´åº¦yæ˜¯<code>head_num</code>(<code>q head num</code>)</p><p><code>qkv</code>ç±»å‹æ˜¯<code>BaseWeight&lt;T&gt;</code>ï¼Œåœ¨<code>src/weights/base_weights.h</code>ä¸­</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">template&lt;typename T&gt;struct BaseWeight{std::vector&lt;int&gt; shape;T* data;WeightType type;T* bias; // qkvéœ€è¦è¿™ä¸€é¡¹}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>â‘ <code>GetRoPRfreq()</code>æ˜¯ç”¨æ¥æ±‚$Î¸$å’Œ$m$çš„</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">inline __device__ float2 GetRoPEfreq(int zid, int rot_embed_dim, float base, float t_step) {      float inv_freq = t_step / powf(base, zid / (float)rot_embed_dim); // æ±‚mÎ¸      return{cos(inv_freq), sin(inv_freq)};  }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>å…¬å¼ï¼š$Î˜={Î¸_i=10000^{-2(i-1)/d},i\in[1,2,â€¦,d/2]}$<br>å…¥å‚ï¼š</p><ul><li><code>zid</code>ï¼š<code>2(i-1)</code></li><li><code>rot_embed_dim</code>ï¼š<code>d</code>ï¼Œè¯åµŒå…¥å‘é‡çš„ç»´åº¦</li><li><code>base</code>ï¼šå…¬å¼ä¸­çš„10000</li><li><code>t_step</code>ï¼štime stepï¼Œæ˜¯è¦æ±‚çš„<code>m</code>ï¼Œ<code>m</code>è¡¨ç¤ºç¬¬<code>m</code>ä¸ªtoken<br>å˜é‡ï¼š</li><li><code>inv_freq</code>ï¼šå°±æ˜¯$mÎ¸_i$<ul><li>$mÎ¸_i=m\ Ã·\ 10000^{2(i-1)/d}$</li><li>$10000^{2(i-1)/d}$ = <code>powf(base,zid / (float)d)</code><ul><li><code>base=10000</code></li><li><code>zid=2(i-1)</code></li><li>å› ä¸ºä¼ è¿›æ¥çš„<code>rot_embed_dim</code>æ˜¯<code>int</code>å‹çš„ï¼Œæ‰€ä»¥åŠ äº†ä¸ª<code>float</code></li></ul></li></ul></li><li>è¿”å›çš„æ˜¯$cos(mÎ¸_i)$å’Œ$sin(mÎ¸_i)$</li></ul><p>â‘¡<code>GetRoPEres()</code>æ˜¯ç”¨æ¥å¾—åˆ°RoPEåçš„ç»“æœçš„</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">inline __device__ float2 GetRoPEres(float data, float data_rotate, const float2 coef){      float2 rot_v;    rot_v.x = coef.x * data - coef.y * data_rotate;    rot_v.y = coef.x * data_rotate + coef.y * data;    retern rot_v;  }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…¥å‚ï¼š</p><ul><li><code>data</code>ï¼š<code>head_size</code>ä¸­çš„å‰åŠçš„æ•°æ®</li><li><code>data_rotate</code>ï¼š<code>head_size</code>ä¸­ååŠçš„æ•°æ®</li><li><code>coef</code>ï¼šé€šè¿‡<code>GetRoPRfreq()</code>å¾—åˆ°çš„$cos(mÎ¸_i)$å’Œ$sin(mÎ¸_i)$<br>å˜é‡ï¼š</li><li>(ä¸¾ä¾‹)<code>rot_v.x</code>=$cos(mÎ¸_0)\ <em>\ x_0\ -\ sin(mÎ¸_0)\ </em>\ x_{64}$</li><li>(ä¸¾ä¾‹)<code>rot_v.y</code>=$cos(mÎ¸_0)\ <em>\ x_{64}\ +\ sin(mÎ¸_0)\ </em>\ x_0$</li><li>ä¸Šé¢ä¸¤ä¸ªä¸ºä¸€ç»„<code>rot_v</code>ï¼Œä¸€ç»„æŒ‡çš„æ˜¯ä»–ä»¬å…±äº«$cos(mÎ¸_0)$å’Œ$sin(mÎ¸_0)$<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/LLM2%E6%8E%A8%E7%90%86%E5%BC%95%E6%93%8E/d224a5131c3f2a304c66f0ccf912e90.jpg"></li></ul><p>â‘¢<code>add_fusedQKV_bias_transpose_kernel()</code><br>å®é™…ä¸Šå¹¶æ²¡æœ‰åŠ ä¸Šbiasåç½®é¡¹</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">template &lt;typename T&gt;  __global__ void add_fusedQKV_bias_transpose_kernel(T *q_buf,  T *k_buf,  T *v_buf,  T *QKV,  const int *padding_offset, // created before qkv linear  const int *history_length,  const int *input_length, // actual length of each seq  const int batch_size,  const int seq_len, // max_seq_len to pad to    const int head_num,  const int kv_head_num,  const int head_size,  const int rotary_embedding_dim,  float rotary_embedding_base // default 10000 in llama  )<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>1)é…ç½®blockã€threadå’Œpadding</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">int token_id = blockIdx.x;int head_id = blockIdx.y; int tid = threadIdx.x;int token_padding_offset = padding_offset[token_id];<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><code>token_id</code>å’Œ<code>head_id</code>ç”¨äºè·å¾—æ•°æ®åç§»é‡<br><code>token_padding_offset</code>æ˜¯è¯¥<code>token</code>ä¹‹å‰çš„paddingä¸ªæ•°</p><p>2)ä¸ºå†™åˆ°æ˜¾å­˜é‡Œé¢åšå‡†å¤‡</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">int dst_token_id = token_id + token_padding_offset;int batch_id = dst_token_id / seq_len;int local_token_id = dst_token_id % seq_len;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><code>dst_token_id</code>ï¼šå¯ä»¥ç†è§£ä¸ºå½“å‰<code>token_id</code>åœ¨å…¨éƒ¨<code>token</code>ä¸­çš„ä½ç½®<br>    <code>token_id</code>æ˜¯å½“å‰tokenåœ¨ä¸è€ƒè™‘paddingæ—¶çš„tokenä½ç½®<br>    <code>token_padding_offset</code>æ˜¯å½“å‰tokenä¹‹å‰çš„paddingä¸ªæ•°<br><code>batch_id</code>ï¼šå½“å‰tokenæ‰€åœ¨ä½ç½®çš„å¯¹åº”çš„å¥å­id<br><code>local_token_id</code>ï¼šå½“å‰tokenåœ¨å½“å‰å¥å­çš„ä½ç½®(0~seq_len-1)<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/LLM2%E6%8E%A8%E7%90%86%E5%BC%95%E6%93%8E/8b1b3ff66b49b6249741cc3c0f00791.jpg" alt="|275"><br>ä¸ºäº†å†™åˆ°æ˜¾å­˜é‡Œæ‰åšçš„padding</p><p>3)åŸºäº(ä½œä¸ºè¾“å…¥)QKV bufferçš„ä¸‰ä¸ªç»´åº¦(<code>num tokens, qkv head num, head size</code>)è·å–qã€kã€v</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">int qkv_head_num = head_num + 2 * kv_head_num; int q_id = token_id * qkv_head_num * head_size + head_id * head_size + tid;  int k_id = token_id * qkv_head_num * head_size + head_id * head_size + tid + head_num * head_size;int v_id = token_id * qkv_head_num * head_size + head_id * head_size + tid + head_num * head_size + kv_head_num * head_size;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><code>qkv_head_num</code>ï¼šå…¶ä¸­<code>head_num</code>æ˜¯<code>q_head_num</code><br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/LLM2%E6%8E%A8%E7%90%86%E5%BC%95%E6%93%8E/8d4904053dda536ed4635322867c4fa.jpg" alt="|425"></p><p>4)è®¡ç®—RoPE</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">const int cur_seq_history_len = history_length[batch_id];const int context_length = cur_seq_history_len + input_length[batch_id]  const int timestep = cur_seq_history_len + local_token_id; if(tid &gt;= rotary_embedding_dim / 2){     return;  }  float2 cos_sin = GetRoPEfreq(tid * 2, rotary_embedding_dim, rotary_embedding_base, timestep);  float2 q_rotate = GetRoPEres(QKV[q_id], QKV[q_id + head_size / 2], cos_sin);  float2 k_rotate = GetRoPEres(QKV[k_id], QKV[k_id + head_size / 2], cos_sin);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œçš„é•¿åº¦éƒ½ä»¥tokenä¸ºå•ä½<br><code>cur_seq_history_len</code>ï¼šå½“å‰åºåˆ—çš„å†å²çš„åºåˆ—é•¿åº¦æ€»å’Œ<br><code>context_length</code>ï¼šå½“å‰åºåˆ—é•¿åº¦+å†å²çš„åºåˆ—é•¿åº¦<br><code>timestep</code>ï¼šå†å²åºåˆ—é•¿åº¦+å½“å‰seqä¸­çš„tokenï¼Œå¾—åˆ°å½“å‰tokenåœ¨æ•´ä¸ªåºåˆ—ä¸­çš„ä½ç½®</p><p>llamaçš„æ—‹è½¬ç¼–ç æ˜¯å°†head sizeåˆ‡åˆ†æˆä¸¤åŠï¼Œå·¦ä¸€åŠä¸å³ä¸€åŠå¯¹åº”åšRoPEï¼Œæ‰€ä»¥å½“<code>tid &gt;= rotary_embedding_dim/2</code>æ—¶å°±å¯ä»¥åœæ­¢åšRoPEè®¡ç®—ï¼Œ<code>rotary_embedding_dim</code>æ˜¯è¯åµŒå…¥å‘é‡çš„ç»´åº¦ï¼Œè¿™é‡ŒæŒ‡çš„åº”è¯¥æ˜¯tokençš„ç»´åº¦</p><p>åœ¨<code>q_rotate</code>å’Œ<code>k_rotate</code>çš„è®¡ç®—è¿‡ç¨‹ä¸­ä¹Ÿèƒ½è¯å®<code>data</code>å’Œ<code>data_rotate</code>å¯¹åº”çš„æ˜¯çº¿ç¨‹ï¼Œæ‰€ä»¥åœ¨ä¸Šé¢çš„ifè¯­å¥ä¸­åªéœ€è¦ä¸€åŠçš„çº¿ç¨‹å³å¯</p><p>5)å†™å›gmem</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">int dst_q_id = batch_id * seq_len * head_num * head_size +                 head_id * seq_len * head_size +                 local_token_id * head_size + tid;  int dst_kv_id = batch_id * seq_len * kv_head_num * head_size +                 head_id * seq_len * head_size +                 local_token_id * head_size + tid;  q_buf[dst_q_id] = q_rotate.x;  q_buf[dst_q_id + head_size / 2] = q_rotate.y;  if(head_id &lt; kv_head_num){      // å¯¹äºMQAå’ŒGQA      k_buf[dst_kv_id] = k_rotate.x;      k_buf[dst_kv_id + head_size / 2] = k_rotate.y;  }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸‹é¢ç»™å‡ºäº†<code>dst_q_id</code>çš„ä¾‹å­<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/LLM2%E6%8E%A8%E7%90%86%E5%BC%95%E6%93%8E/f602724b51ab74e9a401426a567845f.jpg" alt="|675"></p><p>â‘£<code>rope_kernel_for_self_decoder()</code></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">template&lt;typename T&gt;  __global__ void rope_kernel_for_self_decoder(T* q,                      T* k,                      const int batch_size,                      const int head_num,                      const int kv_head_num,                      const int head_size,                      const int step,                      int   rotary_embedding_dim,                      float rotary_embedding_base)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œä¸»è¦é’ˆå¯¹self decoder</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">int tid = threadIdx.x;  int q_head_id = blockIdx.x;  int q_batch_id = blockIdx.y;  int kv_head_id = q_head_id / (head_num / kv_head_num); // å°†kv_head_idçš„æ•°é‡è†¨èƒ€åˆ°q_head_idçš„æ•°é‡  int kv_batch_id = q_batch_id;    int batch_stride = head_num * head_size; // seq len=1  int kv_batch_stride = kv_head_num * head_size;int head_stride = head_size;  int q_offset = q_batch_id * batch_stride + q_head_id * head_stride + tid;  int k_offset = kv_batch_id * kv_batch_stride + kv_head_id * head_stride + tid;  if(tid &gt;= rotary_embedding_dim / 2){      return;  }  float2 cos_sin = GetRoPEfreq(tid * 2, rotary_embedding_dim, rotary_embedding_base, step - 1); // è¿™é‡Œé€šè¿‡ä¸hfç›¸æ¯”å‘ç°è¦-1float2 q_rotate = GetRoPEres(q[q_offset], q[q_offset + head_size / 2], cos_sin);  float2 k_rotate = GetRoPEres(k[k_offset], k[k_offset + head_size / 2], cos_sin);    q[q_offset] = q_rotate.x;  q[q_offset + head_size / 2] = q_rotate.y;  k[k_offset] = k_rotate.x;  k[k_offset + head_size / 2] = k_rotate.y;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ€å<code>k[k_offset]</code>ä¸éœ€è¦åˆ¤æ–­<code>head_idx&lt;kv_head_num</code>æ˜¯å› ä¸º<code>int kv_head_id = q_head_id / (head_num / kv_head_num); </code>è¿™é‡Œçš„å¯¹åº”å…³ç³»ä¸ä¼šä»¤k headè¶Šå‡ºè¾¹ç•Œ<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/LLM2%E6%8E%A8%E7%90%86%E5%BC%95%E6%93%8E/7b5bd7706fad306560cabfdbc75cb21.jpg" alt="|475"></p><h2 id="8-2-å…¶ä»–"><a href="#8-2-å…¶ä»–" class="headerlink" title="8.2 å…¶ä»–"></a>8.2 å…¶ä»–</h2><p><code>using Vec_t = Vec&lt;t&gt;::type;</code>å’Œ<code>using Vec_t = typename Vec&lt;t&gt;::type;</code>çš„åŒºåˆ«</p><ul><li>ä½¿ç”¨<code>typename</code>å…³é”®å­—ç”¨æ¥æ˜ç¡®å‘Šè¯‰ç¼–è¯‘å™¨<code>Vec&lt;t&gt;::type</code>æ˜¯ä¸€ä¸ªç±»å‹è€Œä¸æ˜¯ä¸€ä¸ª(é™æ€)æˆå‘˜</li><li>ä¸ä½¿ç”¨<code>typename</code>çš„å‰ææ˜¯ç¼–è¯‘å™¨å·²ç»ç¡®å®šäº†<code>Vec&lt;t&gt;::type</code>æ˜¯ä¸€ä¸ªç±»å‹ï¼Œä¸éœ€è¦<code>typename</code>åšæç¤º<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">// éœ€è¦typenameåšæç¤ºtemplate&lt;typename T&gt;struct Vec{using Type = T;}// ä¸éœ€è¦typenameåšæç¤ºstruct Vec{using Type = int;}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p><code>const_cast</code>ä¸»è¦ç”¨äºç§»é™¤(æˆ–æ·»åŠ )å¯¹è±¡çš„<code>const</code>é™å®šç¬¦ï¼Œå¯ä»¥ä¿®æ”¹é‚£äº›è¢«å£°æ˜ä¸º<code>const</code>çš„å˜é‡</p><h1 id="Lesson9-concat-past-kv-cache"><a href="#Lesson9-concat-past-kv-cache" class="headerlink" title="Lesson9 concat past kv cache"></a>Lesson9 concat past kv cache</h1><p>è®²è§£äº†ï¼š<br><code>src/kernels/concat_past_kv.cu</code><br><code>src/kernels/concat_past_kv.h</code><br><code>tests/unittests/test_concat_kv.cu</code></p><p>llamaä¸­<code>max_q_len</code>(å³<code>seq_len</code>)æ˜¯8192ï¼Œæ˜¯å…³æ³¨å¯¹è±¡ï¼›kå’Œvå†™åˆ°<code>max_q_len</code>éœ€è¦æ ¹æ®<code>history_len</code>æ‰¾åˆ°ç›¸åº”çš„ä½ç½®<br><code>kv cache shape = [num layers, bs, kv_head_num, max_seq_len, head_size]</code><br>â†“å…¶ä¸­ï¼Œmax_seq_lençš„ä½ç½®æ˜¯å†™åˆ°<br><code>[seqlen[history_len:history_len + max_q_len]]</code></p><p>è¿™ä¸€èŠ‚å†…å®¹ä¸å¤šï¼Œä½†æ˜¯æŠ˜ç£¨äº†æˆ‘æŒºé•¿æ—¶é—´çš„T.T<br>    ä¸»è¦æ˜¯<code>max_q_len</code>ã€<code>max_seq_len</code>ã€<code>history_len</code>ã€<code>cur_query_len</code>è¿™å‡ ä¸ªå˜é‡æ²¡å¼„æ˜ç™½(å¯èƒ½æ˜¯è§†é¢‘é»˜è®¤æˆ‘ä¼šå§å“ˆå“ˆ)</p><ul><li><code>max_q_len</code>ï¼šåšå®Œæ—‹è½¬ä¹‹åçš„kã€vçš„å¯¹åº”çš„æ¯ä¸ªbatchçš„é•¿åº¦ï¼Œå³tokençš„ä¸ªæ•°</li><li><code>max_seq_len</code>ï¼šè€ƒè™‘ä¸Šä¸‹æ–‡çš„æ¯ä¸ªbatchçš„é•¿åº¦ï¼Œå³tokençš„é•¿åº¦ï¼Œä»€ä¹ˆå«è€ƒè™‘ä¸Šä¸‹æ–‡å‘¢ï¼Œå°±æ˜¯å…¥å‚çš„æ—¶å€™ä¼šè¾“å…¥<code>history_len</code>çš„å°±æ˜¯ä¸Šæ–‡é•¿åº¦ï¼Œ<code>max_seq_len</code>ä½œä¸ºè¯¥batchçš„æœ€é•¿çš„é•¿åº¦</li><li><code>history_len</code>ï¼šè¿™ä¸ªbatchä¸­çš„ä¸Šæ–‡é•¿åº¦ï¼Œå³tokençš„é•¿åº¦</li><li><code>cur_query_len</code>ï¼šéœ€è¦è¿›è¡ŒæŸ¥è¯¢çš„é•¿åº¦(æ–°ç”Ÿæˆçš„tokençš„é•¿åº¦)<br><code>history_len + cur_query_len &lt;= max_seq_len</code></li></ul><p>éš¾ç‚¹å°±æ˜¯å†™å…¥çš„ä½ç½®çš„åç§»<code>dst_offset</code>ï¼Œå®é™…ä¸Šè¿™ä¸€èŠ‚ä¹Ÿæ˜¯è¦è§£å†³çš„é—®é¢˜å°±æ˜¯kv cacheçš„å†™å…¥ä½ç½®ï¼Œç»“åˆä»£ç çœ‹ä¸‹å›¾å°±å¥½äº†<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/LLM2%E6%8E%A8%E7%90%86%E5%BC%95%E6%93%8E/11adf571dc54da75266cc135ab66c1f.jpg"><br>ğŸ‘†å½“layer=1çš„æƒ…å†µ<br>ğŸ‘‡è¿™é‡Œåªæ”¾keyçš„ï¼Œvalueçš„å’Œä»–å·®ä¸å¤š</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">template &lt;typename T&gt;  __global__ void append_key_cache(T *k_dst, // [num layers, bs, kv head num, max_q_len, head size]                                   const size_t layer_offset,                                   const T *k_src, // [bs, kv_head num, max_q_len, head size]                                   const int kv_head_num,                                   const int head_size,                                   const int *cur_query_length,                                   const int *history_length,// [batch_size]                                   const int max_q_len,                                   const int max_seq_len){      // æ ¹æ®è¿™é‡Œçš„dim3 grid(max_q_len, batch_size, kv_head_num);æ¥å†™ä¸‹é¢çš„ä¸‰è¡Œ      int batch_id = blockIdx.y;      int head_id = blockIdx.z;      int token_id = blockIdx.x;      int tid = threadIdx.x;      T* k_cache_dst = k_dst + layer_offset; // å°†kå†™åˆ°å½“å‰çš„layerä½ç½®ï¼Œç®—æ˜¯ä¸€ä¸ªå®šä½ï¼›k_dstæ˜¯æ‰€æœ‰kçš„èµ·å§‹ä½ç½®      int cumsum_seq_len = history_length[batch_id]; // å½“å‰batchåœ¨å½“å‰layerä¸­ç´¯ç§¯çš„å¥å­é•¿åº¦      int cur_seq_len = cur_query_length[batch_id];      if(token_id &lt; cur_seq_len){          // [bs, kv_head_num, max_q_len, head size] =&gt; [bs, kv_head_num, max_seq_len[cumsum_seq_len:cumsum_seq_len + max_q_len], head_size]          // åœ¨k_srcä¸Šçš„åç§»          int src_offset = batch_id * kv_head_num * max_q_len * head_size        + head_id * max_q_len * head_size                         + token_id * head_size + tid;          // éœ€è¦å†™å…¥çš„ä½ç½®çš„åç§»          int dst_offset = batch_id * kv_head_num * max_seq_len*head_size        + head_id * max_seq_len * head_size        + (cumsum_seq_len + token_id) * head_size + tid;          k_cache_dst[dst_offset] = k_src[src_offset]; // k_srcæ˜¯å½“å‰layerçš„ï¼Œdst_offsetéœ€è¦åŠ ä¸Š      }  }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="Lesson10-RepeatKV-for-MQA-GQA-kernel"><a href="#Lesson10-RepeatKV-for-MQA-GQA-kernel" class="headerlink" title="Lesson10 RepeatKV for MQA&amp;GQA kernel"></a>Lesson10 RepeatKV for MQA&amp;GQA kernel</h1><p>è®²è§£äº†ï¼š<br><code>src/kernels/repeat_kv.cu</code><br><code>src/kernels/repeat_kv.h</code><br><code>test/unittests/test_repeat_kv.cu</code></p><p>å†™è¿™ä¸ªkernelçš„åŠ¨æœºï¼šå°†MHAè½¬æ¢ä¸ºMQAï¼Œç›®çš„æ˜¯å¹³è¡¡æ¨ç†é€Ÿåº¦å’ŒMHAæ‰€èƒ½è¾¾åˆ°çš„ç²¾åº¦ï¼›å› ä¸ºkå’Œvçš„æ•°é‡ä¸å¤´æ•°é‡æˆæ­£æ¯”ï¼Œæ‰€ä»¥è¦å‡å°å¤´çš„æ•°é‡å’Œsizeä»¥å‡å°å¸¦å®½å‹åŠ›ï¼ŒåŒæ—¶å› ä¸ºåé¢è¦åšQKgemmï¼Œå› æ­¤è¦çŸ©é˜µå¯¹é½</p><p>å°ºå¯¸å˜åŒ–ï¼š<br><code>[batch size, kv head num, max seq len, head size]=&gt;</code><br><code>[batch size, q head num, max k len, head size]</code></p><p><code>q_head_per_kv = head_num / kv_head_num</code>ï¼Œå³æ¯ä¸€ç»„k headæˆ–v headå¯¹åº”å¤šå°‘ç»„q headå…±ç”¨</p><p><code>dim3 grid((max_k_len * head_size + blockSize - 1) / blockSize, batch_size, head_num);</code><br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/LLM2%E6%8E%A8%E7%90%86%E5%BC%95%E6%93%8E/6a7c0ad2ea6497df0a680878fb4c32d.jpg"></p><p><code>src/kernels/repeat_kv.cu</code></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">template &lt;typename T&gt;  __global__ void repeat_value_cache(T *v_dst,                                     const T *v_src,                                     const size_t layer_offset,                                     const int head_num,                                     const int q_head_per_kv,                                     const int head_size,                                     const int *context_length,                                     const int max_k_len,                                     const int max_seq_len){      const int batch_id = blockIdx.y;      const int head_id = blockIdx.z;      const int gtid = blockIdx.x * blockDim.x + threadId.x;      const auto val_src = v_src + layer_offset;      const T* val_dst = v_dst;      const int seq_len = context_length[batch_id];      const int v_head_size_id = gtid % head_size;     const int v_seq_len_id = gtid / head_size;      if(v_seq_len_id &lt; seq_len){          const int src_id = batch_id * (head_num / q_head_per_kvï¼‰*       head_size * max_seq_len +                             head_id / q_head_per_kv * head_size *                            max_seq_len +                             v_seq_len_id * head_size +                             v_head_size_id;            const int dst_id = batch_id * head_num * head_size * max_k_len +                            head_id * head_size * max_seq_len +                             v_seq_len_id * head_size +                             v_head_size_id;          val_dst[dst_id] = val_src[src_id];      }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/LLM2%E6%8E%A8%E7%90%86%E5%BC%95%E6%93%8E/ef1ab04ddb1556e1cd39bef5cf2ac47.jpg"><br>å®é™…ä¸Šå°±æ˜¯æŒ‰ç…§<code>q head</code>çš„å¤§å°é‡æ–°æ’å¸ƒäº†<code>k head</code>æˆ–<code>v head</code>ï¼Œä½¿ä»–ä»¬ä¸€ä¸€å¯¹åº”ã€‚(å›¾ä¸­ç»¿è‰²éƒ¨åˆ†ä¸ºå¯¹åº”å…³ç³»ï¼Œæ¯<code>q_head_num/kv_head_num</code>ç»„<code>q hea</code>då…±ç”¨ä¸€ç»„<code>k head</code>æˆ–<code>v head</code>)</p><p>æ€»è§‰å¾—è¿™é‡Œçš„<code>max_k_len</code>æœ‰ç‚¹è¯¯å¯¼äººâ€¦åº”è¯¥ä¸æ˜¯<code>kv head num * max seq len = q head num * max k len</code>ï¼Œåªæ˜¯å•çº¯çš„æ‰©å±•äº†</p><h1 id="Lesson11-Fused-mask-softmax"><a href="#Lesson11-Fused-mask-softmax" class="headerlink" title="Lesson11  Fused mask&amp;softmax"></a>Lesson11  Fused mask&amp;softmax</h1><p>è®²è§£äº†ï¼š<br><code>src/kernels/attn_softmax_kernel.cu</code><br><code>src/kernels/attn_softmax_kernel.h</code></p><p><code>SumOp</code>å’Œ<code>MaxOp</code>çš„å®šä¹‰</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">template &lt;typename T&gt;  struct SumOp  {      __device__ __forceinline__ T operator()(const T &amp;a, const T &amp;b) const { return a + b; }  };    template &lt;typename T&gt;  struct MaxOp  {      __device__ __forceinline__ T operator()(const T &amp;a, const T &amp;b) const { return max(a, b); }  };<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ğŸ‘†è¿™æ ·å†™çš„ç›®çš„æ˜¯æ¨¡æ¿åŒ–</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">template &lt;template &lt;typename&gt; class ReductionOp, typename T&gt;  __inline__ __device__ T warpReduce(T val)  {      for (int mask = 32 / 2; mask &gt; 0; mask /= 2)      {            val = ReductionOp&lt;T&gt;()(val, __shfl_xor_sync(0xffffffff, val, mask));      }        return val;  }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ğŸ‘†ä½¿ç”¨æ¨¡æ¿æ¨¡æ¿å‚æ•°<code>ReductionOp</code>ï¼Œåœ¨è°ƒç”¨<code>warpReduce</code>æ—¶ä¼ å…¥ä¸åŒçš„æ“ä½œç±»å‹<code>SumOp</code>å’Œ<code>MaxOp</code></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">LLM-CHECK_WITH_INFO(k_length % 2 == 0, "K_len should be divided by 2 under half type!");<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>fp32ç±»å‹ä¸‹ä»¥float4åŠ›åº¦è¯»å†™ï¼ˆè¿˜æœªå®ç°ï¼‰ï¼Œfp16ç±»å‹ä¸‹ä»¥half2è¯»å†™ï¼Œè¿™é‡Œæ˜¯åªå¯¹fp16åšå‘é‡åŒ–ä½¿å…¶<code>vec_size=2</code>ï¼Œè€Œfp32å‘é‡åŒ–å<code>vec_size=1</code></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">#define LAUNCH_SOFTMAX(dtype, vec_size)                                \     if (block.x &gt; 2048 &amp;&amp; block.x &lt;= 4096)                             \     {                                                                  \         constexpr int NUMS_PER_THREAD_PER_ROW = 4;                     \         block.x /= 4 * vec_size;                                       \         block.x = (block.x + 32 - 1) / 32 * 32;                        \         assert(block.x &lt; 1024);                                        \         ScaleMaskAndSoftmax_##dtype&lt;dtype, NUMS_PER_THREAD_PER_ROW&gt;    \&lt;&lt;&lt;grid, block&gt;&gt;&gt;((dtype *)attn_score-&gt;data, \                                             (dtype *)qk-&gt;data,         \                (dtype *)mask-&gt;data,       \                                             batch_size,                \                                             head_nums,                 \                                             q_length,                  \                                             k_length,                  \                             scale);                    \      }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>NUMS_PER_THREAD_PER_ROW</code>ä½œä¸ºç¼–è¯‘å™¨å¸¸é‡</li><li>å¦‚æœå½“å‰è¾“å…¥çš„shapeæ¯”è¾ƒå¤§ï¼Œæ¯ä¸ªçº¿ç¨‹åªè®¿é—®4ä¸ªvecï¼Œå³<code>.x</code>ã€<code>.y</code>ã€<code>.z</code>ã€<code>.w</code>è¿™ç§ï¼Œæ‰€ä»¥<code>block.x</code>è¢«åˆ†ä¸º<code>4*vec_size</code>ä»½<ul><li>å…¶ä¸­ï¼Œ<code>vec_size</code>å¯¹äº<code>half</code>æ¥è¯´å–2ï¼Œå¯¹äº<code>float</code>æ¥è¯´å–1</li></ul></li><li>åŒæ—¶blockä¸ªæ•°ä»éœ€å¯¹é½32ï¼Œå‘ä¸Šå–æ•´</li><li>æ•´ä½“çœ‹æ¥å°±æ˜¯ç”¨è¾ƒå°‘çš„çº¿ç¨‹å¤„ç†æ•°æ®ï¼Œå¦‚æœè¾“å…¥shapeå¤ªå¤§å°±é‡‡ç”¨è¾“å…¥å‘é‡åŒ–ï¼ˆç›®å‰åªå®ç°äº†fp16ï¼‰å¹¶ä¸”å‡å°‘çº¿ç¨‹ä½¿ç”¨</li></ul><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">template &lt;typename T, int NUMS_PER_THREAD_PER_ROW&gt;  __global__ void ScaleMaskAndSoftmax_float(T *attn_score,                                            T *qk,                                            T *mask,                                            int batch_size,                                            int head_nums,                                            int q_len,                                            int k_len,                                            float scale){      int batch_id = blockIdx.y;    int head_id = blockIdx.z;     if(threadIdx.x &gt;= k_len){          return;      }        __shared__ float s_max, inv_sum;      for(int row_start = 0; row_start &lt; q_len; row_start++){          int qk_offset = 0;          T qk_data = static_cast&lt;T&gt;(0);          T mask_data = static_cast&lt;T&gt;(0);          T data[NUMS_PER_THREAD_PER_ROW];          T thread_max = FIL_MIN;  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>åœ¨launchä¸­<ul><li>grid=<code>[q_length, batch_size, head_nums]</code></li><li>block=<code>[k_length(ä»¥32çš„å€æ•°å‘ä¸Šå–æ•´)]</code></li></ul></li><li>å¼€å§‹å¤„ç†æ‰€æœ‰è¡Œ</li></ul><p>ä»¥ä¸‹å…¨éƒ½åœ¨ä¸Šä¸€å±‚çš„<code>for</code>çš„å†…éƒ¨ï¼Œä¸ºä¾¿äºçœ‹ä»£ç å› æ­¤å¿½ç•¥éƒ¨åˆ†ç¼©è¿›</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">for (int col_start = 0; col_start &lt; NUMS_PER_THREAD_PER_ROW; col_start++){ // æ¯ä¸ªçº¿ç¨‹åªéœ€è¦å¤„ç†NUMS_PER_THREAD_PER_ROWä¸ªæ•°æ®  qk_offset = batch_id * head_nums * q_len * k_len +     head_id * q_len * k_len + row_start * k_len +     col_start * blockDim.x + threadIdx.x;  qk_data = qk[qk_offset];  mask_offset = batch_id * q_len * k_len + head_id * q_len * k_len   + row_start * k_len + col_start * blockDim.x   + threadIdx.x;      mask_data = mask[mask_offset];        data[col_start] = scale * qk_data + (1 - mask_data) * -1e4f;      thread_max = fmax(data[col_start], thread_max); // ä¸€ä¸ªçº¿ç¨‹å¯¹å¤šä¸ªå…ƒç´ åšå¤„ç†ä¹‹åï¼Œå¤šä¸ªå…ƒç´ çš„æœ€å¤§å€¼  }  T max_val = blockReduce&lt;MaxOp, T&gt;(thread_max); // ä¸€è¡Œçš„æœ€å¤§å€¼  // blockçš„æœ€å¤§å€¼å­˜åœ¨idä¸º0çš„çº¿ç¨‹ä¸­  if(threadIdx.x == 0){      s_max = max_val;  }        __syncthreads();  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>åˆ—è¢«åˆ†ä¸º<code>NUMS_PER_THREAD_PER_ROW</code>ä¸ªæ•°æ®ç”±åŒä¸€ä¸ªçº¿ç¨‹å¤„ç†</li><li>æ¯éå†ä¸€æ¬¡<code>col_start</code>å°±ä¼šæœ‰ç›¸åº”çš„çº¿ç¨‹å¹¶è¡Œï¼Œä¹‹åå†ç”¨<code>blockReduce</code>è¿›è¡Œæœ€åçš„è§„çº¦</li><li><code>mask_data</code>å’Œ<code>qk_data</code>ä¸åŒçš„åœ°æ–¹æ˜¯æ²¡æœ‰<code>head_nums</code>ï¼Œå…¶ä»–éƒ½ä¸€è‡´<ul><li>å¦‚æœ<code>mask_data=1</code>ï¼Œè¯´æ˜ä¸éœ€è¦è¢«maskï¼Œåä¹‹éœ€è¦è¢«mask(åŠ ä¸Š$-10^4$ï¼Œè¿™ä½¿å¾—åœ¨softmaxæ—¶å¾—åˆ°çš„å€¼éå¸¸çš„å°)<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/LLM2%E6%8E%A8%E7%90%86%E5%BC%95%E6%93%8E/8616eaf5c62443e35305f7cfd27a345.jpg"><br>è€ƒè™‘åˆ°æ•°å€¼èŒƒå›´çš„æº¢å‡ºé—®é¢˜ï¼Œä¸€èˆ¬ä¼šåœ¨æŒ‡æ•°éƒ¨åˆ†å‡å»<code>D=max(zi)</code><br>softmaxçš„å…¬å¼ä¸ºï¼š$D=max(z_i),softmax(z_i)=\dfrac{e^{z_i-D}}{\sum^C_{c=1}e^{z_c-D}}$<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">T thread_sum = 0.0f;  for(int col_start = 0; col_start &lt; NUMS_PER_THREAD_PER_ROW; col_start++){      data[col_start] = expf(data[col_start] - s_max);      thread_sum += data[col_start];  }        T sum_val = blockReduce&lt;SumOp, T&gt;(thread_sum);  if(threadIdx.x == 0){      inv_sum = 1 / (sum_val + 1e-6);  }       __syncthreads();  for(int col_start = 0; col_start &lt; NUMS_PER_THREAD_PER_ROWl;col_start++) {  qk_offset = batch_id * head_nums * q_len * k_len + head_id * q_len * k_len + row_start * k_len + col_start * blockDim.x + threadIdx.x;  attn_score[qk_offset] = (data[col_start] * inv_sum);  }  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li></ul><p>å¯¹äºfp16ï¼Œä¸åŒçš„åœ°æ–¹åœ¨äºå‘é‡åŒ–å¤„ç†</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">//scalar_cast_vec: å°†å¸¸é‡è½¬æ¢ä¸º2ä¸ªæˆ–4ä¸ªå‘é‡  Vec_t ONE = scalar_cast_vec&lt;Vec_t&gt;(__float2half(1.0f));  Vec_t NEG_INF = scalar_cast_vec&lt;Vec_t&gt;(__float2half(-10000.0f));  Vec_t scale_vec = scalar_cast_vec&lt;Vec_t&gt;(__float2half(scale));<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>æ ¹æ®<code>src/utils/vectorze_utils.h</code>ï¼šhalf-&gt;half2 ï¼Œfloat-&gt;float4</p><p>åœ¨<code>src/utils/vectorize_utils.h</code></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">template&lt;typename T_OUT, typename T_IN&gt;  inline __decvice__ T_OUT scalar_cast_vec(T_IN val){      return val;  }  // halfè½¬ä¸ºhalf2  template&lt;&gt;  inline __device__ half2 scaler_cast_vec&lt;half2, half&gt;(half val){      return __half2half2(val);  }  // floatè½¬ä¸ºfloat2  template&lt;&gt;  inline __device__ float2 scaler_cast_vec&lt;float2, float&gt;(float val){  return __make_float2(val, val);  }  // floatè½¬ä¸ºfloat4  template&lt;&gt;  inline __device__ float4 scaler_cast_vec&lt;float4, float&gt;(float val){      return __make_float4(val, val, val, val);  }  // floatè½¬ä¸ºhalf2  template&lt;&gt;  inline __device__ float2 scaler_cast_vec&lt;half2, float&gt;(float val){      return __float2half2_rn(val);  }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿˜æœ‰ä¸€éƒ¨åˆ†ç›´æ¥ç”¨åº“ä¸­half2å‡½æ•°è¿›è¡Œè®¡ç®—å¤„ç†</p><h1 id="Lesson12-Fused-transpose-remove-padding"><a href="#Lesson12-Fused-transpose-remove-padding" class="headerlink" title="Lesson12 Fused transpose&amp;remove padding"></a>Lesson12 Fused transpose&amp;remove padding</h1><p>è®²è§£äº†ï¼š<br><code>src/kernels/fused_transpose_and_remv_pad.cu</code><br><code>src/kernels/fused_transpose_and_remv_pad.h</code></p><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/LLM2%E6%8E%A8%E7%90%86%E5%BC%95%E6%93%8E/1ebaf4bf0c8c8e05cdc563c83f71a77.jpg"></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">template &lt;typename T&gt;  __global__ void fused_transpose_reshape_remv_pad(T *src,                                                   T *dst,                                                   const int num_tokens,                                                   const int batch_size,                                                   const int seq_len,                                                   const int head_num,                                                   const int head_size,                                                   const int *padding_offset /*for remove padding*/)  {      int token_id = blockIdx.x; // è¿™é‡Œçš„token_idæ˜¯æŒ‡paddingä¹‹å‰çš„æ¯ä¸ªtokençš„id      int batch_id = token_id + padding_offset[token_id] / seq_len; // è¿™é‡Œçš„batch_idæ˜¯æŒ‡paddingä¹‹åæ¯ä¸ªtokenå¯¹åº”çš„batchçš„id      int seq_id = token_id + padding_offset[token_id] % seq_len;   // æ¯ä¸ªtokenåœ¨å¥å­ä¸­çš„ç¼–å·ï¼ŒèŒƒå›´æ˜¯0~seq_len-1      // transposeå‰åçš„offset      int src_offset = batch_id * head_num * seq_len * head_size + seq_id * head_size; // transposeå‰çš„åç§»ä½ç½®ï¼Œå…·ä½“åˆ°head_sizeçš„åç§»ï¼Œè¿™é‡ŒæŠŠhead_id * seq_len * head_sizeå»æ‰äº†ï¼Œä¼šåœ¨forå¾ªç¯è¡¥ä¸Š      int dst_offset = token_id * head_num * head_size; // è¿™é‡Œçš„åç§»åªå…·ä½“åˆ°token        for(int i = threadIdx.x; i &lt; head_num * head_size; i+=blockDim.x){ // å› ä¸ºæ¯ä¸ªblockå¤„ç†ä¸€ä¸ªtokenï¼Œæ‰€ä»¥i+=blockDim.x          int head_id = i / head_size;          int head_size_id = i % head_size;          dst[dst_offset + i] = src[src_offset + i * seq_len * head_size + head_size_id];      }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä»£ç æ¯”è¾ƒå®¹æ˜“ç†è§£ï¼Œä¸æ‡‚çš„çœ‹æ³¨é‡Šå³å¯</p><h1 id="Lesson13-Fused-addResidualNorm"><a href="#Lesson13-Fused-addResidualNorm" class="headerlink" title="Lesson13 Fused addResidualNorm"></a>Lesson13 Fused addResidualNorm</h1><p>è®²è§£äº†ï¼š<br><code>src/fused_addresidual_norm.cu</code><br><code>src/fused_addresidual_norm.h</code></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">template&lt;typename T&gt;  __global__ void FusedAddBiasResidualRMSNorm( // residual.shape = [num tokens, hidden_units]                      T* residual,    // [num tokens, hidden_units]                      T* decoder_in,  // [num tokens, hidden_units]                      /*optional*/const T* bias,  // [hidden_units]                      const T* scale, // [hidden_units], RMSNorm weights                      float eps,      // RMSNorm eps                      int num_tokens,                       int hidden_units){  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>rmsnorm(decoder_in + residual + bias)</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">// grid:[num_tokens] block:[num_threads]    int vec_size = Vec&lt;T&gt;::size;      using Vec_t = typename Vec&lt;T&gt;::Type;      int batch_id = blockIdx.x; // ä¸€ä¸ªblockè¡¨ç¤ºä¸€ä¸ªbatch      int tid = threadIdx.x;      Vec_t *de_out = reinterpret_cast&lt;Vec_t*&gt;(decoder_in + batch_id * hidden_units);     Vec_t *rsd = reinterpret_cast&lt;Vec_t*&gt;(residual + batch_id * hidden_units);      Vec_t *bia;      if(bias != nullptr){          bia = reinterpret_cast&lt;Vec_t*&gt;(bias);      }    Vec_t tmp;      T thread_sum = static_cast&lt;T&gt;(0.0f);      for (int i = threadIdx.x; i &lt; hidden_units / vec_size; i += blockDim.x) {          if(residual != nullptr){              // ä¸‹é¢å¯¹åº”HFä¸­çš„hidden_states = residual + hidden_states              de_out[i].x += rsd[i].x;              de_out[i].y += rsd[i].y;              de_out[i].z += rsd[i].z;              de_out[i].w += rsd[i].w;              // ä¸‹é¢å¯¹åº”residul = hidden_states                        rsd[i].x = de_out[i].x;              rsd[i].y = de_out[i].y;              rsd[i].z = de_out[i].z;              rsd[i].w = de_out[i].w;          }                if(bias != nullptr){              de_out[i].x += bia[i].x;              de_out[i].y += bia[i].y;              de_out[i].z += bia[i].z;              de_out[i].w += bia[i].w;          }          thread_sum += de_out[i].x * de_out[i].x;          thread_sum += de_out[i].y * de_out[i].y;          thread_sum += de_out[i].z * de_out[i].z;          thread_sum += de_out[i].w * de_out[i].w;      }  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>Vec_t *de_out = reinterpret_cast&lt;Vec_t*&gt;(decoder_in + batch_id * hidden_units)</code>ï¼šæ¯ä¸ªblockè¡¨ç¤ºä¸€ä¸ªtokenï¼Œæ¯ä¸ªtokençš„å¤§å°ä¸ºhidden_unitsï¼Œè¿™é‡Œè¡¨ç¤ºäº†å½“å‰tokençš„åç§»é‡ </li><li>åœ¨HFä¸­çš„é¡ºåº<br><code>hidden_states = residual + hidden_states</code>å¯¹åº”<code>de_out[i].x += rsd[i].x;</code><br><code>residul = hidden_states</code>å¯¹åº”<code>rsd[i].x = de_out[i].x;</code><br><code>hidden_states = self.post_attention_layernorm(hidden_states)</code>å¯¹åº”<code>de_out[idx].x = de_out[idx].x * inv_mean * s[idx].x;</code></li><li>æ ¹æ®å…¬å¼$\dfrac{x_iÃ—g_i}{\sqrt{\sum^iE(x_i^2)+eps}}$<ul><li>$x_i$å¯¹åº”åŠ äº†<code>residual</code>çš„<code>de_out[i]</code></li><li>$g_i$å¯¹åº”<code>s[idx]</code></li></ul></li></ul><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">    // æ±‚åˆ†æ¯ï¼Œä»¥1/xxxè¡¨ç¤º    T block_sum = blockReduceSum&lt;float&gt;(thread_sum);      __shared__ float inv_mean;      if (threadIdx.x == 0) {          inv_mean = rsqrtf(block_sum / hidden_units + eps);      }    __syncthreads();       // rmsnorm      Vec_t *s;      if(scale != nullptr) {          s = reinterpret_cast&lt;Vec_t *&gt;(scale);      }        for (int idx = threadIdx.x; idx &lt; hidden_units / vec_size; idx += blockDim.x) {          de_out[idx].x = de_out[idx].x * inv_mean * s[idx].x;         de_out[idx].y = de_out[idx].y * inv_mean * s[idx].y;         de_out[idx].z = de_out[idx].z * inv_mean * s[idx].z;          de_out[idx].w = de_out[idx].w * inv_mean * s[idx].w;      }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="Lesson-14-Gate-Linear-Up-Linear"><a href="#Lesson-14-Gate-Linear-Up-Linear" class="headerlink" title="Lesson 14 Gate Linear&amp;Up Linear"></a>Lesson 14 Gate Linear&amp;Up Linear</h1><p>è®²è§£äº†ï¼š<br><code>src/kernels/linear</code></p><p>è¾“å…¥ï¼š<br>    ä¸ºcontext decoderæ—¶ï¼Œ<code>[batch_size, q hidden units]</code>ï¼›<br>    ä¸ºself decoderæ—¶ï¼Œ<code>[token nums, q hidden units]</code><br>Gate&amp;Upæƒé‡ï¼š<code>[q hidden units, 2 * inter size]</code><br>è¾“å‡ºï¼š<code>[batch_size(æˆ–token nums), 2 * inter size] = [bs/tn, 2, inter size]</code>ï¼Œå®é™…ä¸Šè¾“å‡ºæ˜¯ä¸‰ç»´</p><h1 id="Lesson-15-SwiGLU"><a href="#Lesson-15-SwiGLU" class="headerlink" title="Lesson 15 SwiGLU"></a>Lesson 15 SwiGLU</h1><p>è®²è§£äº†ï¼š<br><code>src/kernels/act_kernel.h</code><br><code>src/kernels/act_kernel.cu</code></p><p><code>SiLU(Sigmoid Linear Unit)</code>ï¼Œç›¸å¯¹äºReLUï¼ŒSiLUåœ¨å‡½æ•°æ¥è¿‘0æ—¶å…·æœ‰æ›´å¹³æ»‘çš„æ›²çº¿<br>$y=x*sigmoid(\beta x)=\dfrac{1}{1+e^{-\beta x}}$ï¼Œå½“$\beta=1$æ—¶å°±æ˜¯SiLU<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/LLM2%E6%8E%A8%E7%90%86%E5%BC%95%E6%93%8E/Pasted%20image%2020241105112111.png"></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">template&lt;typename T&gt;__device__ __forceinline__ T silu(const T&amp; in){return in / (1.0f * expf(-in));}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><code>grid:[batch_size=input-&gt;shape[0]]</code><br><code>block:[256]</code></p><p><code>Gate Linear</code>å’Œ<code>Up Linear</code>çš„è¾“å‡º(å¯¹äºcontext decoderè€Œè¨€)<code>[bs, 2, inter size]</code>å¯ä»¥è§†ä¸ºä¸¤ä¸ªå¤§å°ä¸º<code>[bs, inter size]</code>çš„éƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†åš<code>SiLU</code>ï¼Œå¾—åˆ°çš„ç»“æœä¸ç¬¬äºŒéƒ¨åˆ†åš<code>mul</code>æœ€ç»ˆå¾—åˆ°æœ€åçš„ç»“æœ</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">template&lt;typename T&gt;  __global__ void silu_and_mul_kernel(T* out, // shape: [bs, intermedia size]  const T* input,  // shape: [bs, 2, intermedia size]                  const int intermedia_size) {      const int batch_idx = blockIdx.x;      for(int idx = threadIdx.x; idx &lt; intermedia_size; idx +=blockDim.x){         const T x = input[batch_idx * 2 * intermedia_size + idx];// ç¬¬ä¸€ä¸ª         const T y = input[batch_idx * 2 * intermedia_size + intermedia_size + idx]; // ç¬¬äºŒä¸ª          out[batch_idx * intermedia_size + idx] = silu&lt;T&gt;(x) * y;      }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="Lesson16-Fused-SelfDecoderAttention-kernel"><a href="#Lesson16-Fused-SelfDecoderAttention-kernel" class="headerlink" title="Lesson16 Fused SelfDecoderAttention kernel"></a>Lesson16 Fused SelfDecoderAttention kernel</h1><p>è®²è§£äº†ï¼š<br><code>src/fused_decoder_self_attention.cu</code></p><p>èåˆéƒ¨åˆ†ï¼š<code>concat kv</code>+<code>repeat kv</code>+<code>qk gemv</code>+<code>softmax</code>+<code>qk*v gemv</code></p><ul><li>å¦‚ä½•fuseï¼šæ•°æ®åœ¨å¯„å­˜å™¨(å¦‚<code>q</code>ã€<code>k</code>å’Œ<code>v</code>)å’Œæ˜¾å­˜(å¦‚<code>q_buf</code>ã€<code>k_buf</code>å’Œ<code>v_buf</code>)éƒ½å‡ºç°ï¼Œå› æ­¤éœ€è¦å¤ç”¨åœ¨å¯„å­˜å™¨å’Œå…±äº«å†…å­˜ä¸­çš„æ•°æ®ï¼Œå› ä¸ºè®¿é—®æ˜¾å­˜ä¼šè€—æ—¶ï¼Œå¹¶ä¸”å¸¦å®½å¾ˆä½</li><li>ä½¿ç”¨åŠ¨æ€å…±äº«å†…å­˜</li><li><code>Q*k Gemv</code>ï¼š<ul><li><code>q.shape=[batch size, head num, 1, head size]</code><ul><li>è¿™é‡Œçš„<code>1</code>è¡¨ç¤ºæ¯æ¬¡é’ˆå¯¹ä¸€ä¸ªç‰¹å®šä½ç½®(å½“å‰token)è®¡ç®—attention</li></ul></li><li><code>k.shape=[batch size, head num, step, head size]</code>ï¼Œ<ul><li>è¿™é‡Œä¸æ˜¯<code>kv head num</code>ï¼Œæ˜¯å› ä¸ºåœ¨<code>repeat kv</code>è¿™ä¸€æ­¥ä¸­å·²ç»æŠŠqå’Œkçš„å¤´å¯¹é½äº†</li><li>è¿™é‡Œçš„<code>step</code>è¡¨ç¤ºæ¯ä¸ªå¥å­åŒ…å«<code>step</code>ä¸ª<code>token</code>ï¼Œæ¯ä¸ª<code>token</code>çš„keyéƒ½ä¸å½“å‰æŸ¥è¯¢å‘é‡<code>q</code>åšç‚¹ç§¯</li></ul></li></ul></li></ul><p>é‡æ¸©ï¼š</p><ul><li>qkvçŸ©é˜µçš„shape<ul><li>q<code>[batch size, q head num, 1, head size]</code></li><li>k<code>[batch size, kv head num, step(/seqlen), head size]</code></li><li>v<code>[batch size, kv head num, step(/seqlen), head size]</code></li></ul></li></ul><p><code>launchDecoderMaskedMHA()</code></p><ul><li><code>qkv_buf</code>ï¼š<code>[batch size, qkv head num, head size]</code>ï¼Œé»˜è®¤<code>head_num</code>æ˜¯qçš„headï¼Œqkvã€kvçš„headä¼šåŠ ä¸Šç›¸åº”çš„å‰ç¼€</li><li>ç”¨<code>getVal</code>çš„å‰ææ˜¯æ•°æ®å¿…é¡»åœ¨CPUä¸Š(<code>LLM_CHECK(location == CPU)</code>)</li><li>gridï¼š<code>[head_num, batch_size]</code></li><li>blockï¼š<code>[head_size]</code></li></ul><p>å…¥å‚ï¼š</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">template&lt;typename T&gt;  void launchDecoderMaskedMHA(TensorWrapper&lt;T&gt;* qkv_buf,                            BaseWeight&lt;T&gt;&amp; qkv,                             TensorWrapper&lt;int&gt;* layer_id,                              TensorWrapper&lt;T&gt;* k_cache,                              TensorWrapper&lt;T&gt;* v_cache,                              TensorWrapper&lt;bool&gt;* finished,                             TensorWrapper&lt;int&gt;* step,                             TensorWrapper&lt;T&gt;* mha_output,                              LLaMAAttentionStaticParams&amp; static_params){ <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>qkv_buf=qkv_linear=[bs, q_hidden_units] * [qhiddenunits, hiddenunits] = [bs, qkv_head_num, head_size]</code><ul><li><code>qhiddenunits</code>ï¼šå°†è¾“å…¥çš„åµŒå…¥å‘é‡(embedding vector)çš„å‘é‡é•¿åº¦ï¼Œ</li><li><code>hiddenunits</code>ï¼š<code>=[qkv_head_num,qiddenunist]=[qkv_head_num,head_size]</code><br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/LLM2%E6%8E%A8%E7%90%86%E5%BC%95%E6%93%8E/22bbf7d7781de208731d147b46c3b5e%201.jpg" alt="|550"></li></ul></li><li>kvçš„cache<ul><li>k_cache<code>[num layers, bs, kv head num, max seq len or step, head size]</code></li><li>v_cache<code>[num layers, bs, kv head num, max seq len or step, head size]</code><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">    const int qkv_head_num = qkv_buf-&gt;shape[1];      const int kv_head_num = k_cache-&gt;shape[2];      const int max_seq_len = k_cache-&gt;shape[3];   int head_num = qkv_head_num - 2 * kv_head_num;      const int head_size = qkv_buf-&gt;shape[2];      const int cur_step = step-&gt;getVal();    const int layer = layer_id-&gt;getVal();      const int layer_offset = layer * max_seq_len * batch_size * kv_head_num * head_size;      size_t smem_size_bytes = head_size * sizeof(T) + cur_step * sizeof(float);      T* qkv_data = qkv_buf-&gt;data;      T* q = qkv_data;    T* k = qkv_data + head_num * head_size;      T* v = qkv_data + (head_num + kv_head_num) * head_size;        int   rotary_embedding_dim = static_params.rotary_embedding_dim;      float rotary_embedding_base = static_params.rotary_embedding_base;      int   max_position_embeddings = static_params.max_position_embeddings;      bool  use_dynamic_ntk = static_params.use_dynamic_ntk;      dim3 grid(head_num, batch_size);      dim3 block(head_size); //vec size = 4 for fp32      masked_MHA_kernel&lt;T&gt;&lt;&lt;&lt;grid, block, smem_size_bytes&gt;&gt;&gt;(  q,  k,  v,  // /*(T*)*/qkv.bias,  k_cache-&gt;data + layer_offset,  v_cache-&gt;data + layer_offset,  mha_output-&gt;data,  batch_size,  head_num,  kv_head_num,  max_seq_len,  head_size,  cur_step,  rotary_embedding_dim,  rotary_embedding_base);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li><li><code>qã€kã€v</code>ï¼š<code>qkv_buf=[bs, qkv_head_num, head_size]</code>ï¼Œ<code>qã€kã€v</code>åˆ†åˆ«åŠ ä¸Šç›¸åº”åç§»é‡</li><li><code>k_cacheã€v_cache</code>ï¼šå®šä½åˆ°æŸä¸€ä¸ª<code>layer</code>ä¸Šï¼Œä¸è€ƒè™‘<code>layer</code>æ—¶çš„<code>shape</code>ä¸º<code>[bs, kv head num, max seq len or step, head size]</code></li><li><code>mha_output-&gt;data</code>ï¼šä½œä¸ºè¾“å‡ºåœ°å€</li><li><code>cur_step</code>ï¼šå½“å‰æ—¶é—´æ­¥ï¼Œå½“å‰ç”Ÿæˆåˆ°ç¬¬å‡ ä¸ªtoken</li><li><code>rotary_embedding_dimã€rotary_embedding_base</code>ï¼šRoPEç”¨</li></ul><p><code>masked_MHA_kernel()</code><br>å…¥å‚ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">template<span class="token operator">&lt;</span>typename T<span class="token operator">&gt;</span>  __global__ <span class="token keyword">void</span> <span class="token function">masked_MHA_kernel</span><span class="token punctuation">(</span><span class="token keyword">const</span> T<span class="token operator">*</span> q<span class="token punctuation">,</span>                      <span class="token keyword">const</span> T<span class="token operator">*</span> k<span class="token punctuation">,</span>                      <span class="token keyword">const</span> T<span class="token operator">*</span> v<span class="token punctuation">,</span>                      T<span class="token operator">*</span> qkv_bias<span class="token punctuation">,</span>                      T<span class="token operator">*</span> k_cache<span class="token punctuation">,</span>                      T<span class="token operator">*</span> v_cache<span class="token punctuation">,</span>                      T<span class="token operator">*</span> mha_output<span class="token punctuation">,</span>                      <span class="token keyword">const</span> <span class="token keyword">int</span> batch_size<span class="token punctuation">,</span>                      <span class="token keyword">const</span> <span class="token keyword">int</span> head_num<span class="token punctuation">,</span>                      <span class="token keyword">const</span> <span class="token keyword">int</span> kv_head_num<span class="token punctuation">,</span>                      <span class="token keyword">const</span> <span class="token keyword">int</span> max_seq_len<span class="token punctuation">,</span>                      <span class="token keyword">const</span> <span class="token keyword">int</span> head_size<span class="token punctuation">,</span>                      <span class="token keyword">const</span> <span class="token keyword">int</span> step<span class="token punctuation">,</span>                      <span class="token keyword">int</span>   rotary_embedding_dim<span class="token punctuation">,</span>                      <span class="token keyword">float</span> rotary_embedding_base<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// rsqrt(dh)  </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>k_offset</code>å’Œ<code>cache_offset</code>åŒºåˆ«ï¼š<ul><li><code>k_offset</code>æ˜¯qkv linearæä¾›ç»™kçš„ï¼Œ(å› ä¸ºæ˜¯self_attentionæ‰€ä»¥)ä¸€ä¸ªbatchåªæœ‰ä¸€ä¸ªtoken</li><li><code>cache_offset</code>æ˜¯kv cacheæä¾›ç»™kçš„ï¼Œæœ‰<code>max seq len</code>ï¼Œä¸€ä¸ªbatchæœ€å¤šæœ‰max seq lenä¸ªtoken(æœ‰è¿™ä¹ˆå¤šæ˜¯å› ä¸ºæ–°ç”Ÿæˆçš„tokençš„kã€vä¹ŸåŠ ä¸Šå»äº†)</li></ul></li><li>ä»¥<code>tid * vec_size &lt; head_size</code>ä½œä¸ºæ˜¯å¦è¶…å‡ºè¾¹ç•Œçš„åˆ¤æ–­<ul><li><code>head_size</code>ä¸€èˆ¬æ˜¯4ã€8ã€16çš„å€æ•°ï¼Œæ‰€ä»¥å½“<code>vec_size</code>ä¸º2æˆ–4æ—¶ä¹Ÿèƒ½æ­£å¸¸åˆ¤æ–­</li><li>(æŠ›å¼€å€æ•°é—®é¢˜ä¼šè§‰å¾—ä¸èƒ½æ­£å¸¸åˆ¤æ–­çš„åŸå› æ˜¯ï¼š<code>head_size=7</code>ï¼Œå½“<code>tid(=1)*vec_size(=4)</code>æ—¶ï¼Œ<code>4&lt;7</code>æ­¤æ—¶åˆ¤æ–­æœªè¶…å‡ºè¾¹ç•Œï¼Œä½†æ˜¯ä¸€å…±æœ‰<code>2Ã—4=8</code>å·²ç»è¶…å‡ºè¾¹ç•Œäº†)</li></ul></li><li>è¾“å‡ºï¼š`mha_output.shape=[batch_size, q_head_num, 1, head_size]</li></ul><p>â‘ ConcatPastKVCache<br><code>input=[bs, kv head num, seqlen, head size]</code><br><code>output=[bs, kv head num, max_seq_len, head size]</code></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">int tid = threadIdx.x;     int q_head_id = blockIdx.x;     int q_batch_id = blockIdx.y;     int kv_head_id = q_head_id / (head_num / kv_head_num);     int kv_batch_id = q_batch_id;        int batch_stride = head_num * head_size;     int kv_batch_stride = kv_head_num * head_size;     int head_stride = head_size;      int q_offset = q_batch_id * batch_size + q_head_id * head_stride + tid;     // k_offsetæ˜¯qkv linearæä¾›ç»™kçš„     int k_offset = kv_batch_id * kv_batch_stride + kv_head_id * head_stride + tid;   // cache_offsetæ˜¯kv cacheæä¾›ç»™kçš„     int cache_offset = kv_batch_id*kv_head_num*max_seq_len*head_size  + kv_head_id * max_seq_len * head_size  + tid * vec_size;//æ²¡æœ‰seq lençš„ç»´åº¦æ˜¯å› ä¸ºseq lenå§‹ç»ˆä¸º1     int step_stride = head_size;      float scale = rsqrt((float)head_size);      int vec_size = Vec&lt;T&gt;::size;     int q_offset_vec = q_batch_id * batch_size + q_head_id * head_stride + tid * vec_size;     int k_offset_vec = kv_batch_id * kv_batch_stride + kv_head_id * head_stride + tid * vec_size;     using Vec_t = typename Vec&lt;T&gt;::Type; <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>â‘¡å£°æ˜åŠ¨æ€å…±äº«å†…å­˜å˜é‡</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">const T* q_mem = q;  const T* k_mem = k;  const T* v_mem = v;  if(tid * vec_size &lt; head_size){      qvec = *reinterpret_cast&lt;Vec_t*&gt;(const_cast&lt;T*&gt;(&amp;q_mem[q_offset_vec]));      kvec = *reinterpret_cast&lt;Vec_t*&gt;(const_cast&lt;T*&gt;(&amp;k_mem[k_offset_vec]));      vvec = *reinterpret_cast&lt;Vec_t*&gt;(const_cast&lt;T*&gt;(&amp;v_mem[v_offset_vec]));  }  extern __shared__ char sqk[]; // å£°æ˜åŠ¨æ€å…±äº«å†…å­˜å˜é‡  // shared memoryçš„åˆ†é…  // å­˜åˆ°shared memoryä¸­çš„æ•°æ®çš„ç‰¹ç‚¹æ˜¯ä½å»¶è¿Ÿã€é«˜å¤ç”¨  // åœ¨è¿™é‡Œå¯¹qç”¨shared memoryè¿›è¡Œå­˜å‚¨æ˜¯å› ä¸ºä¹‹åæœ‰ä¸ªä¼˜åŒ–ï¼Œä½¿ç”¨ä¸€ä¸ªblockå–å¤šè¡Œkè¿›è¡Œqk gemmï¼Œæ­¤æ—¶qçš„å¤ç”¨é¢‘ç‡å˜é«˜ï¼Œä¸éœ€è¦é‡å¤åŠ è½½q  T* sq_scalar = reinterpret_cast&lt;T*&gt;(sqk);  float* logits = reinterpret_cast&lt;float*&gt;(sq_scalar + head_size);  Vec_t *sq = reinterpret_cast&lt;Vec_t*&gt;(sq_scalar);    if(tid * vec_size &lt; head_size){      sq[tid] = qvec;  }    __syncthreads();  float zero = 0.0f;  Vec_t zero_f4 = scalar_cast_vec&lt;Vec_t, T&gt;(zero); // å°†floatè½¬ä¸ºfloat4  float4 scale_f4 = scalar_cast_vec&lt;float4, float&gt;(scale);    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">// q*k gemv  for(int iter = 0; iter &lt; step; iter++){ //ä¸€ä¸ªblockå¾ªç¯è®¡ç®—stepè¡Œ      Vec_t kvec_qk = tid * vec_size &lt; head_size ? *reinterpret_cast&lt;Vec_t*&gt;(&amp;k_cache[iter * step_stride + cache_offset]) : zero_f4; // è¿™é‡Œä¹˜iterç›¸å½“äºä¹˜max seq lenã€‚æˆ‘çš„ç†è§£æ˜¯cache_offsetæ˜¯å¯¹äºtokenè€Œè¨€çš„ï¼Œiter*cache_offsetçš„åç§»ä½¿å®šä½åˆ°å½“å‰step(å½“å‰token)        if(iter == step - 1 &amp;&amp; tid * vec_size &lt; head_size){ // stepçš„æœ€åä¸€ä¸ªä½ç½®å­˜å‚¨RoPEè¾“å‡ºçš„k          *reinterpret_cast&lt;Vec_t*&gt;(&amp;k_cache[iter * step_stride + cache_offset]) = kvec;          kvec_qk = kvec; // è¿™é‡Œçš„kvec_qkæ˜¯ç”¨æ¥åšè®¡ç®—çš„ï¼Œä¸‹é¢çš„vvec_qkcåŒç†      }        Vec_t qk = zero_f4;      qk.x = tid * vec_size &lt; head_size ? sq[tid].x * kvec_qk.x * scale_f4.x : zero;      qk.y = tid * vec_size &lt; head_size ? sq[tid].y * kvec_qk.y * scale_f4.y : zero;      qk.z = tid * vec_size &lt; head_size ? sq[tid].z * kvec_qk.z * scale_f4.z : zero;      qk.w = tid * vec_size &lt; head_size ? sq[tid].w * kvec_qk.w * scale_f4.w : zero;        T qk_acc = qk.x + qk.y + qk.z + qk.w; // ä¸€ä¸ªçº¿ç¨‹æœ‰4ä¸ªå€¼ï¼Œå…ˆåœ¨çº¿ç¨‹å±€éƒ¨æŠŠè¿™å››ä¸ªå€¼åŠ èµ·æ¥ï¼Œå†ç”¨blockReduceSum      T attn_score = blockReduceSum&lt;T&gt;(qk_acc);      if(tid == 0){          logits[iter] = attn_score; // logitsæ˜¯stepÃ—1å¤§å°çš„æ•°ç»„      }      __syncthreads();  }  // softmax    T local_logits = tid &lt; step ? (T)logits[tid] : 0;  __shared__ float row_max, fenmu;  T block_max = blockReduceMax&lt;T&gt;(local_logits);  if(tid == 0){      row_max = block_max;  }    __syncthreads();  T fenzi = tid &lt; step ? expf(logits[tid] - row_max) : 0; // e(x_i - x-max) / sigma(e(x_i, x_max));  T block_fenmu = blockReduceSum&lt;T&gt;(fenzi);  if(tid == 0){      fenmu = block_fenmu + 1e-6;  }    __syncthreads();  if(tid &lt; step){      logits[tid] = (T)(fenzi / fenmu);  }    __syncthreads();    // éšå¼çš„repeat kvï¼Œéƒ½æ˜¯å‘é‡åŒ–ç±»å‹  if(tid * vec_size &lt; head_size){      Vec_t O = scalar_cast_vec&lt;Vec_t, T&gt;(0.0f); // ä¸­é—´å¯„å­˜å™¨      for(int iter = 0; iter &lt; step; iter++){          Vec_t vvec_qkv = *reinterpret_cast&lt;Vec_t*&gt;(&amp;v_cache[iter * step_stride + cache_offset]);            if(iter == step - 1){ // stepçš„æœ€åä¸€ä¸ªä½ç½®å­˜å‚¨RoPEè¾“å‡ºçš„k              *reinterpret_cast&lt;Vec_t*&gt;(&amp;v_cache[iter * step_stride + cache_offset]) = vvec;              vvec_qkv = vvec;          }            __syncthreads();          O.x += vvec_qkv.x * logits[iter]; // vçš„ä¸€æ•´è¡ŒÃ—qkçš„ä¸€ä¸ª          O.y += vvec_qkv.y * logits[iter]; // vçš„ä¸€æ•´è¡ŒÃ—qkçš„ä¸€ä¸ª          O.z += vvec_qkv.z * logits[iter]; // vçš„ä¸€æ•´è¡ŒÃ—qkçš„ä¸€ä¸ª          O.w += vvec_qkv.w * logits[iter]; // vçš„ä¸€æ•´è¡ŒÃ—qkçš„ä¸€ä¸ª      }      *reinterpret_cast&lt;Vec_t*&gt;(&amp;mha_output[q_offset]) = O; // [batch size, q head num, 1, head size]  }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="Lesson17-topK"><a href="#Lesson17-topK" class="headerlink" title="Lesson17 topK"></a>Lesson17 topK</h1><p>è®²è§£äº†ï¼š<br><code>src/kernels/topK.cu</code><br><code>src/kernels/topK.h</code></p><p>è¾“å…¥ï¼š<code>[bs, beam_width, vocab size]</code><br>è¾“å‡ºï¼š<code>[bs, beam_width, K]</code></p><p>topKä¸­çš„Kæ˜¯ä»ä¸€ç»„å€™é€‰ä¸­é€‰å–å¾—åˆ†æœ€é«˜çš„å‰Kä¸ªå€¼<br>beam_widthæ˜¯æŒ‡ä¿ç•™çš„å€™é€‰è·¯å¾„æ•°<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/LLM2%E6%8E%A8%E7%90%86%E5%BC%95%E6%93%8E/Pasted%20image%2020241117225342.png" alt="|450"></p><p>ç›®çš„ï¼šæ¯ä¸ªvocabéœ€è¦é€‰æ‹©Kä¸ªå€¼ä½œä¸ºtopK<br>åšæ³•ï¼šç”±äº<code>vocab_size</code>æ¯”è¾ƒå¤§ï¼Œå› æ­¤åˆ†æˆä¸¤æ¬¡topK</p><ul><li>ç¬¬ä¸€æ¬¡ï¼š<code>[bs, beamwidth, vocab size] =&gt; [bs, beamwidth, BlockPerBeam, K]</code><ul><li>å°†vocabåˆ†ä¸º<code>BlockPerBeam</code>æ®µï¼Œæ¯æ®µåštopKé€‰å‡ºå‰<code>K</code>ä¸ªæœ€å¤§çš„å€¼</li><li>ç¬¬ä¸€æ¬¡topKåæ¯ä¸ªvocabè¿˜æœ‰<code>BlockPerBeam * K</code>ä¸ªå€¼</li><li>gridï¼š<code>[min(batch_size * BlockPerBeam, maxBlockNums)]</code></li><li>blockï¼š<code>[256]</code></li></ul></li><li>ç¬¬äºŒæ¬¡ï¼š<code>[bs, beamwidth, BlockPerBeam, K] =&gt; [bs, beamwidth, K]</code><ul><li>å°†vocabå‰©ä¸‹çš„<code>BlockPerBeam * K</code>ä¸ªå€¼ç›´æ¥åštopKå¾—åˆ°Kä¸ªå€¼</li><li>gridï¼š<code>[min(batch_size, maxBlockNums)]</code></li><li>blockï¼š<code>[256]</code></li></ul></li></ul><p>â‘ topKçš„åšæ³•</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">template&lt;typename T, int K&gt;  struct topK{      // ä¸‹é¢è¿™ä¸¤è¡Œçš„è®¿é—®æƒé™æ˜¯publicï¼Œå› ä¸ºé»˜è®¤å°±æ˜¯publicæ‰€ä»¥ä¸ç”¨æ˜¾å¼åœ°å†™å‡ºæ¥      T val[K];      int id[L];  // åˆå§‹åŒ–topKä¸­idå…¨ä¸º-1ï¼Œvalå…¨ä¸ºæœ€å°å€¼    __device__ void init(){          for(int i = 0; i &lt; K; i++){              id[i] = -1;             val[i] = FLT_MIN;          }        }        // å¦‚æœå½“å‰è¾“å…¥çš„æ•°å­—æ¯”æœ€åä¸€ä¸ªæ•°å­—å¤§ï¼Œåˆ™æ‘’å¼ƒæœ€åä¸€ä¸ªæ•°å­—ï¼Œå°†è¾“å…¥çš„æ•°å­—æ’è¿›æ¥    void insertHeap(T data, int data_id){  if(id[K-1] == -1 || val[K-1] &lt; data){  id[K-1] = data_id;  val[K-1] = data;  }                // åªéœ€è¦å¯¹å½“å‰è¾“å…¥è¿›æ¥çš„åšå†’æ³¡æ’åºï¼Œå› ä¸ºæ¯è¿›æ¥ä¸€ä¸ªéƒ½åšä¸€æ¬¡å†’æ³¡æ’åº        for(int i = K-2; i &gt;= 0; i--){              if(val[i + 1] &gt; val[i]){                  T tmp = val[i];                  val[i] = val[i + 1];                  val[i + 1] = tmp;                  int tmp_id = id[i];                  id[i] = id[i + 1];                  id[i + 1] = tmp_id;              }                }        }};<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>â‘¡å°†ä¸¤ä¸ªtopKåšä¸€æ¬¡reduceè¾“å‡ºä¸ºä¸€ä¸ªtopK</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">template&lt;typename T, int K&gt;  __device__ topK&lt;T, K&gt; reduce_functor(const topK&lt;T, K&gt;&amp; a, const topK&lt;T, K&gt;&amp; b) {      topK&lt;T, K&gt; res = a;      for(int i = 0; i &lt; K; i++){          res.insertHeap(b.val[i], b.id[i]);      }        return res;  }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>â‘¢ç¬¬ä¸€æ¬¡topK</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">template&lt;typename T, int K, int blockSize, int BlockPerBeam&gt;  __global__ void topK_kernel_round1(const T* probs,    const int vocab_size,      int* topK_ids,    T* topK_vals){      int tid = threadIdx.x;      int bid = blockIdx.x;      int row_id = bid / BlockPerBeam;     // å“ªä¸€æ‰¹vocab/å“ªä¸€ä¸ªbatchä¸­      int block_lane = bid % BlockPerBeam; // åŒä¸€æ‰¹vocabä¸­çš„å“ªä¸€ä¸ªæ®µ      topK&lt;T, K&gt; thread_topK; // ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹åˆ†é…ä¸€ä¸ªtopKå¯„å­˜å™¨      thread_topK.init();      // ä¸‹é¢åšthreadå±‚æ¬¡çš„reduce      for(int data_id = tid + block_lane * blockSize; data_id &lt; vocab_size; data_id += BlockPerBeam * blockSize){          int data_offset = data_id + row_id * vocab_size;          T data = probs[data_offset];          thread_topK.insertHeap(data, data_offset);      }            typedef cub::BlockReduce&lt;topK&lt;T, K&gt;, blockSize&gt; blockreduce;     __shared__ typename blockreduce::TempStorage tmp_storage;        topK&lt;T, K&gt; block_topk = blockreduce(tmp_storage).Reduce(thread_topK, reduce_functor&lt;T, K&gt;);        if(tid == 0){          for(int k_offset = 0; k_offset &lt; K; k_offset++){              int dst_offset = row_id * BlockPerBeam * K +              block_lane * K +              k_offset;              topK_vals[dst_offset] = block_topk.val[k_offset];              topK_ids[dst_offset] = block_topk.id;          }        }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…¥å‚ï¼š</p><ul><li><code>probs</code>ï¼šè¾“å…¥çš„æ¦‚ç‡å€¼<code>[bs, beamwidth, vocab size]</code></li><li><code>topK_ids</code>å’Œ<code>topK_vals</code>ï¼šä½œä¸ºè¾“å‡º</li></ul><p>åœ¨æœªéœ€è¦<code>data+=BlockPerBeam*blockSize</code>æ—¶ï¼Œ</p><ul><li>æ¯ä¸ªbatchä¸­ï¼Œ<code>block_lane=0~7</code>ï¼Œ<code>tid=0~255</code></li><li>åœ¨ä¸åŒbatchä¸­ï¼Œ<code>row_id</code>ä¸åŒ</li><li><code>data_id+=BlockPerBeam*blockSize</code>å¯ä»¥ç†è§£ä¸ºå½“<code>data_id</code>æ˜¯0~2047å¹¶ä¸”<code>data_id</code>ä»æœªè¶…å‡º<code>vocab_size</code>æ—¶ï¼Œåœ¨ä¸å˜åŠ¨<code>tid</code>å’Œ<code>bid</code>å‰æä¸‹ï¼Œçº¿ç¨‹å¹¶è¡Œæ‰§è¡Œ<code>data+_id</code>åŠ ä¸Šæ­¥é•¿ä¸º<code>BlockPerBeam*blockSize</code>å¾—åˆ°çš„æ–°çš„<code>data_id</code>çš„è¡Œä¸ºã€‚ç›´åˆ°<code>data_id</code>è¶…è¿‡<code>vocab_size</code>ä¸ºæ­¢</li><li><code>data_id</code>å¯ä»¥ç†è§£ä¸ºåœ¨æŸä¸€vocabä¸­çš„åç§»é‡ï¼ŒåŠ ä¸Š<code>row_id</code>å…³äºbatchçš„åç§»å¾—åˆ°æœ€ç»ˆçš„åç§»é‡<code>data_offset</code></li><li><code>thread_topK</code>ï¼šæ˜¯æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„topK<ul><li><code>bid=0, tid=0</code>ï¼šè´Ÿè´£<code>data_id</code>ä¸º0ã€2048ã€4096çš„topK</li><li><code>bid=7, tid=1</code>ï¼šè´Ÿè´£<code>data_ia</code>ä¸º1793ã€2561ã€4609çš„topK</li></ul></li></ul><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">typedef cub::BlockReduce&lt;topK&lt;T, K&gt;, blockSize&gt; blockreduce;    __shared__ typename blockreduce::TempStorage tmp_storage;       topK&lt;T, K&gt; block_topk = blockreduce(tmp_storage).Reduce(thread_topK, reduce_functor&lt;T, K&gt;);  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li><code>cub::BlockReduce</code>æ˜¯NVIDIAæä¾›çš„CUB(CUDA UnBound)åº“ä¸­çš„ä¸€ä¸ªæ¨¡æ¿ç±»ï¼Œç›®çš„æ˜¯å°†çº¿ç¨‹å—ä¸­çš„æ•°æ®(ç”±æ¯ä¸ªçº¿ç¨‹è´Ÿè´£ä¸€éƒ¨åˆ†)è§„çº¦ä¸ºå•ä¸€ç»“æœ<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">template &lt;typename T, int BLOCK_DIM&gt; class cub::BlockReduce { public: using TempStorage = typename ImplementationDefined; BlockReduce(TempStorage&amp; temp_storage); T Reduce(T input, ReduceOp reduce_op);};<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><code>tmp_storage</code>ï¼šä¾›çº¿ç¨‹å—ä¸­çš„çº¿ç¨‹é€šä¿¡å’Œå½’çº¦ä½¿ç”¨</li><li><code>block_topk</code>ï¼šåˆå¹¶æ¯ä¸ªçº¿ç¨‹å—ä¸­çš„çº¿ç¨‹çš„topKï¼Œå¾—åˆ°æ¯ä¸ªçº¿ç¨‹å—çš„topK</li></ul><p>æœ€åæ¯ä¸ªblockåªä½¿ç”¨ç¬¬ä¸€ä¸ªçº¿ç¨‹åšè½¬ç§»ï¼Œå°†block_topkä¸ªæ•°æ®è½¬ç§»åˆ°topK_valså’ŒtopK_idsä¸­ã€‚<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/LLM2%E6%8E%A8%E7%90%86%E5%BC%95%E6%93%8E/7745326675b006f165b0b23a6397ba1.jpg"><br>â‘£ç¬¬äºŒæ¬¡topK</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">template&lt;typename T, int beam_width, int K, int blockSize, int BlockPerBeam&gt;  __global__ void topK_kernel_round2(const int* topK_ids,    const T* topK_vals,     int* final_topK_ids,    T* final_topK_vals){      int tid = threadIdx.x;      int bid = blockIdx.x;      int row_id = bid; // æ”¹åŠ¨1ï¼šæ¯ä¸ªbatchåªç”¨ä¸€ä¸ªblockè¡¨ç¤ºï¼ŒåŒæ—¶æ²¡æœ‰block_lane    topK&lt;T, K&gt; thread_topK;      thread_topK.init();      // ä¸‹é¢åšthreadå±‚æ¬¡çš„reduce      for(int data_id = tid; data_id &lt; beam_width * BlockPerBeam * K; data_id += blockSize){ // æ”¹åŠ¨2ï¼šdata_idçš„åˆå§‹ä¸ç”¨è€ƒè™‘è¯¥batchçš„ç¬¬å‡ ä¸ªblockï¼Œæ­¥é•¿ä¸ºblockSize        int data_offset = data_id + bid * beam_width * BlockPerBeam * K; // æ”¹åŠ¨3ï¼šbatchå†…çš„åç§»ç¡®å®šåï¼Œdata_offsetåœ¨æ¯ä¸ªbatchä¹‹é—´çš„åç§»å°±æ˜¯beam_width*BlockPerBeam*K thread_topK.insertHeap(topK_vals[data_offset],    topK_ids[data_offset]);      }            typedef cub::BlockReduce&lt;topK&lt;T, K&gt;, blockSize&gt; blockreduce;      __shared__ typename blockreduce::TempStorage tmp_storage;      topK&lt;T, K&gt; block_topk = blockreduce(tmp_storage).Reduce(thread_topK, reduce_functor&lt;T, K&gt;);        if(tid == 0){          int beam_id = (blockDim.x * blockIdx.x + tid) / BlockPerBeam/ K; // æ”¹åŠ¨4ï¼šå†™å…¥æ—¶éœ€è¦è€ƒè™‘beam_idï¼Œæ„Ÿè§‰è¿™æ¡å…¬å¼æœ‰ç‚¹å¥‡æ€ªï¼Ÿ        for(int k_offset = 0; k_offset &lt; K; k_offset++){              int dst_offset = bid * beam_width * K +              beam_id * K +              k_offset; // æ”¹åŠ¨5            final_topK_vals[dst_offset] = block_topk.val[k_offset];              final_topK_ids[dst_offset] = block_topk.id[k_offset];          }        }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/LLM2%E6%8E%A8%E7%90%86%E5%BC%95%E6%93%8E/b25acc5c3bf310a0925e8b3119ca82d.jpg"></p><h1 id="Lesson18-FusedSoftmax-and-Sampling"><a href="#Lesson18-FusedSoftmax-and-Sampling" class="headerlink" title="Lesson18 FusedSoftmax and Sampling"></a>Lesson18 FusedSoftmax and Sampling</h1><p>è®²è§£äº†ï¼š<br><code>src/kernels/sampling.cu</code><br><code>src/kernels/sampling.h</code><br><code>src/utils/params.h</code><br><code>tests/unittests/test_sampling.cu</code></p><p>åœ¨GPUä¸Šç”Ÿæˆéšæœºæ•°ï¼Œ<strong>ä¸»æœºä»…ä¼ ç»™è®¾å¤‡ä¸€ä¸ªä¿¡å·ï¼Œæ˜¯çš„å¤šä¸ªéšæœºæ•°åœ¨deviceç«¯è¢«ç”Ÿæˆ</strong>ï¼š<code>curand_kernel</code></p><p><code>params.h</code></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">using IntDict = std::unordered_map&lt;std::string, int&gt;;using floatDict = std::unordered_map&lt;std::string, float&gt;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>é”®ä¸ºå­—ç¬¦ä¸²ï¼Œå€¼ä¸ºintæˆ–float</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">__device__ void curand_init(unsigned long long seed, unsigned long long subsequence, unsigned long long offset, curandState_t* state)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><code>seed</code>ï¼šæ—¶é—´ç§å­ã€‚<br><code>subsequence</code>ï¼šåºåˆ—å·ï¼ŒåŒºåˆ†ä¸åŒçº¿ç¨‹å—çš„éšæœºæ•°ç”Ÿæˆå™¨ï¼Œç¡®ä¿æ¯ä¸ªå—æœ‰è‡ªå·±çš„éšæœºæ•°ç”Ÿæˆå™¨ã€‚<br><code>offset</code>ï¼šåœ¨æŒ‡å®šåºåˆ—ä¸­çš„åç§»é‡ï¼Œç”¨äºè·³è¿‡åºåˆ—çš„å‰å‡ ä¸ªå€¼ä»¥è·å¾—ä¸åŒçš„éšæœºæ•°ï¼Œè¿™é‡Œè¡¨ç¤ºä»åºåˆ—çš„èµ·ç‚¹å¼€å§‹ç”Ÿæˆéšæœºæ•°ã€‚<br><code>state</code>ï¼šæŒ‡å‘<code>curandState_t</code>çš„æŒ‡é’ˆï¼Œä¿å­˜ç”Ÿæˆå™¨çš„å†…éƒ¨çŠ¶æ€ã€‚</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">__device__ float curand_uniform(curandState_t* state)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¿”å›åœ¨<code>0.0f</code>å’Œ<code>1.0f</code>ä¹‹é—´å‡åŒ€åˆ†å¸ƒçš„æµ®åŠ¨å€¼</p><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/LLM2%E6%8E%A8%E7%90%86%E5%BC%95%E6%93%8E/eeb944a0bce156627540b5e069888b6.jpg" alt="|425"><br>åœ¨ä¸Šå›¾çš„ä¾‹å­ä¸­ï¼Œ<code>thredhold-topk_val[0]&gt;0ï¼Œthredhold-topk_val[0]-topk_val[1]&lt;0</code>ï¼Œå› æ­¤é‡‡æ ·å€¼è½åœ¨<code>topk_val[1]</code>ä¸Š</p><ul><li>gridï¼š<code>[batch_size]</code></li><li>blockï¼š<code>[K]</code></li></ul><h1 id="Lesson19-allocator"><a href="#Lesson19-allocator" class="headerlink" title="Lesson19 allocator"></a>Lesson19 allocator</h1><p>è®²è§£äº†ï¼š<br><code>src/memory/allocator/base_allocator.h</code><br><code>src/memory/allocator/cuda_allocator.h</code><br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/LLM2%E6%8E%A8%E7%90%86%E5%BC%95%E6%93%8E/2f3403abcd9639c30a2c174db5c3798.jpg"><br><code>base_allocator.h</code></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">class BaseAllocator // å…¬å…±çš„çˆ¶ç±»  {  public:      virtual ~BaseAllocator(){};      template&lt;class T&gt;      T* Malloc(T* ptr, size_t size, bool is_host){          return(T*)UnifyMalloc((void*)ptr, size, is_host);     }        virtual void* UnifyMalloc(void* ptr, size_t size, bool is_host = false) = 0;       template&lt;typename T&gt;      void Free(T* ptr, bool is_host = false){          UnifyFree((void*)ptr, is_host);      }        virtual void UnifyFree(void* ptr, bool is_host = false) = 0;  };<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>çˆ¶ç±»çš„ææ„å‡½æ•°è¦å£°æ˜ä¸ºè™šå‡½æ•°ï¼šç¡®ä¿å½“ä½¿ç”¨åŸºç±»æŒ‡é’ˆæŒ‡å‘æ´¾ç”Ÿç±»å¯¹è±¡æ—¶ï¼Œé”€æ¯å¯¹è±¡æ—¶ä¼š<strong>æ­£ç¡®è°ƒç”¨æ´¾ç”Ÿç±»çš„ææ„å‡½æ•°</strong>ã€‚</li><li><code>(void*)ptr</code>ï¼šCPUçš„åˆ†é…å‡½æ•°mallocè¿”å›çš„æ˜¯ä¸€ä¸ªvoidç±»å‹çš„ï¼Œæ‰€ä»¥æŠŠä¼ è¿›å»çš„æŒ‡é’ˆå¼ºè½¬ä¸ºvoid</li><li>å®šä¹‰<code>UnifyMalloc</code>å’Œ<code>UnifyFree</code>ä¸ºè™šå‡½æ•°ï¼Œåœ¨å­ç±»é‡Œä¸€å®šè¦å®ç°è¿™ä¸ªå‡½æ•°</li></ul><p><code>cuda_allocator.h</code><br>â‘ å®šä¹‰ä¸¤ç§å—</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">struct CudaBigBlock {      void *data;      size_t size;      bool is_allocated;      CudaBigBlock() = default; // æ„é€ å‡½æ•°      CudaBigBlock(void* data_, size_t size_, bool is_allocated_): // æ„é€ å‡½æ•°          data(data_), size(size_), is_allocated(is_allocated_){}  };    struct CudaSmallBlock {      void* data;      size_t size;      bool is_allocated;      CudaSmallBlock() = default; // æ„é€ å‡½æ•°      CudaSmallBlock(void* data_, size_t size_, bool is_allocated_): // æ„é€ å‡½æ•°              data(data_), size(size_), is_allocated(is_allocated_){}  };<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¤§å°å—çš„å®šä¹‰ç›¸åŒ</p><ul><li>å¤§å†…å­˜å—ï¼šä¸æ˜“é€ æˆå†…å­˜ç¢ç‰‡</li><li>å°å†…å­˜å—ï¼šç¢ç‰‡åŒ–è¾ƒä¸¥é‡ï¼Œæ„å»ºå°å—çš„å†…å­˜æ± ä¸»è¦ä¸ºäº†æ”¶é›†ç¢ç‰‡å¤§å°å½’è¿˜OS(æœ‰æ—¶ä¸æ˜¯å†…å­˜ä¸å¤Ÿï¼Œè€Œæ˜¯ç¢ç‰‡å¤ªå¤šå¯èƒ½ä¼šæŠ¥out of memoryçš„é”™</li></ul><p>â‘¡å®šä¹‰åˆ†é…å™¨</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">class CudaAllocator: public BaseAllocator {  private:      //{device id: block}    // æ¯ä¸ªè®¾å¤‡éƒ½æœ‰å†…å­˜æ±       std::map&lt;int, std::vector&lt;CudaSmallBlock&gt; &gt; cudaSmallBlockMap;      std::map&lt;int, std::vector&lt;CudaBigBlock&gt; &gt; cudaBigBlockMap;      std::map&lt;int, size_t&gt; FreeSize;      int dev_id;  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å®šä¹‰äº†</p><ul><li>è®¾å¤‡IDä¸ä»¥<code>CudaSmallBlock</code>ä¸ºå¯¹è±¡çš„æ•°ç»„çš„æ˜ å°„(æ¯ä¸ªè®¾å¤‡éƒ½æœ‰ä¸€ä¸ªå¤§ã€å°å†…å­˜æ± )</li><li>è®¾å¤‡IDä¸ä»¥<code>CudaBigBlock</code>ä¸ºå¯¹è±¡çš„æ•°ç»„çš„æ˜ å°„</li><li>è®¾å¤‡IDä¸è¯¥è®¾å¤‡ç©ºé—²å†…å­˜å¤§å°çš„æ˜ å°„</li></ul><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">public:      CudaAllocator() {          cudaGetDevice(&amp;dev_id);      }        ~CudaAllocator() {      }    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸º<code>CudaAllocator</code>å®ç°<code>UnifyMalloc</code></p><p>0ï¼‰å¯¹é½32bytesä»¥å®ç°<code>float4</code></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">void* UnifyMalloc(void* ptr, size_t size, bool is_host) { size = ((size + 31) / 32 ) * 32;  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>1ï¼‰å¦‚æœæ˜¯ä¸»æœºä¸Šç”³è¯·bufferï¼Œç”¨<code>malloc</code>ç”³è¯·</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">if(is_host){      ptr = malloc(size);     memset(ptr, 0, size);    return ptr;  }  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>memset</code>ï¼šåˆå§‹åŒ–ä»<code>ptr</code>æŒ‡å‘å¼€å§‹çš„sizeä¸ªå€¼ï¼Œåˆå§‹åŒ–çš„æ•°å€¼ä¸º0<br>2ï¼‰åœ¨bigblocksä¸­æ‰¾ç©ºé—²çš„å—ï¼Œå³è¢«freeå‡ºæ¥ä½†æ˜¯è¿˜æœªå½’è¿˜åˆ°OSçš„<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">if(size &gt; 1024 * 1024){    auto BigBlocks = cudaBigBlockMap[dev_id];      int blockID = -1;      for(int i = 0; i &lt; BigBlocks.size(); i++){         if(BigBlocks[i].size &gt;= size&amp;&amp;!BigBlocks[i].is_allocated &amp;&amp; BigBlocks[i].size - size &lt; 1024 * 1024){              if(blockID == -1 || BigBlocks[blockID].size &gt; BigBlocks[i].size){                 blockID = i;              }                }        }        if(blockID != -1){          BigBlocks[blockID].is_allocated = true;          return BigBlocks[blockID].data;      }        void* new_buffer;      cudaMalloc(&amp;new_buffer, size);      BigBlocks.push_back(CudaBigBlock(new_buffer, size, false));      return new_buffer;  }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>å¦‚æœ<code>size</code>å¤§äº1024kå°±ç”¨bigblock</li><li><code>if(BigBlocks[i].size &gt;= size &amp;&amp; !BigBlocks[i].is_allocated &amp;&amp; BigBlocks[i].size - size &lt; 1024 * 1024)</code> <ul><li><code>BigBlocks[i].size &gt;= size</code>ï¼šè¯¥å†…å­˜å—çš„å¤§å°è¦å¤§äºç”³è¯·çš„å†…å­˜</li><li><code>!BigBlocks[i].is_allocated</code>ï¼šè¯¥å†…å­˜å—æ²¡æœ‰è¢«åˆ†é…å‡ºå»</li><li><code>BigBlocks[i].size - size &lt; 1024 * 1024</code>ï¼šè¯¥å†…å­˜å—åˆ†é…ä¹‹åå‰©ä½™çš„å†…å­˜ä¸ä¼šè¶…è¿‡1024k(ç¢ç‰‡åŒ–ï¼Ÿ)</li></ul></li><li><code>if(blockID == -1 || BigBlocks[blockID].size &gt; BigBlocks[i].size)</code><ul><li><code>blockID == -1</code>ï¼šå¦‚æœå½“å‰è¿˜æ²¡åˆ†é…å†…å­˜å—</li><li>æˆ–è€…<code>BigBlocks[blockID].size &gt; BigBlocks[i].size</code>ï¼šå·²ç»åˆ†é…ç»™è¯¥å†…å­˜çš„å†…å­˜å—æ¯”å½“å‰çš„å†…å­˜å—è¦å¤§ï¼Œåˆ™æ›¿æ¢å½“å‰å†…å­˜å—æ¥å­˜å‚¨</li></ul></li><li>åˆ†é…å†…å­˜å—ä¹‹åï¼Œè¿”å›ä¸€ä¸ªvoidç±»å‹çš„æŒ‡é’ˆ</li><li>å¦‚æœæœªèƒ½æ‰¾åˆ°åˆé€‚çš„ï¼Œç›´æ¥<code>cudaMalloc</code><br>3ï¼‰åœ¨smallblocksä¸­æ‰¾ç©ºé—²çš„å—ï¼Œå³è¢«freeå‡ºæ¥ä½†æ˜¯è¿˜æœªå½’è¿˜åˆ°OSçš„<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">auto SmallBlocks = cudaSmallBlocksMap[dev_id];  for(int i = 0; i &lt; SmallBlocks.size(); i++){      if(SmallBlocks[i].size &gt;= size&amp;&amp;!SmallBlocks[i].is_allocated &amp;&amp;SmallBlocks[i].size - size &lt; 1024 * 1024){          SmallBlocks[i].is_allocated = true;          FreeSize[dev_id] += SmallBlocks[i].size; // è¿™é‡Œå»æ‰        return SmallBlocks[i].data;      }        }  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>åŒ¹é…ç­–ç•¥ï¼šç®€å•é¦–æ¬¡åŒ¹é…ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªç¬¦åˆè¦æ±‚çš„å†…å­˜å—è€Œä¸å†æ¯”è¾ƒ</li><li><code>FreeSize[dev_id] += SmallBlocks[i].size;</code>ï¼šå°†åˆ†é…å‡ºæ¥çš„å†…å­˜å—å¤§å°åŠ åˆ°å¯¹åº”è®¾å¤‡çš„<code>FreeSize</code>ä¸­ï¼Œä»¥ä¾¿ä¹‹åé‡Šæ”¾å†…å­˜<br>4ï¼‰æ²¡æœ‰æ‰¾åˆ°åˆé€‚å†…å­˜çš„<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">    void* newBuffer = (void*)ptr;      CHECK(cudaMalloc(&amp;newBuffer, size));      CHECK(cudaMemset(newBuffer, 0, size)); // sizeæ˜¯åˆå§‹åŒ–çš„å­—èŠ‚æ•°      SmallBlocks.push_back(CudaSmallBlock(newBuffer, size, false));      return new_buffer;  }  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><code>__host__ cudaError_t cudaMemset(void* devPtr, int value, size_t count)</code><ul><li>Initializes or sets device memory to a value.</li><li>devPtrï¼šPointer to device memory</li><li>valueï¼šValue to set for each byte of specified memory</li><li>countï¼š Size in bytes to set<br>0ï¼‰å¦‚æœæŒ‡é’ˆæŒ‡å‘ä¸»æœºç«¯çš„å†…å­˜ï¼Œç›´æ¥é‡Šæ”¾<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">void UnifyFree(void* ptr, bool is_host) {  if (ptr == nullptr) {  return;  }      if(is_host){             cudaFree(ptr);         } <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>1ï¼‰å½“ç´¯ç§¯çš„å°å†…å­˜å—è¶…è¿‡1Gæ—¶ï¼Œæ¸…ç†æœªåˆ†é…å‡ºå»çš„smallblocksï¼Œå·²åˆ†é…çš„ä¿ç•™åœ¨smallmapä¸­<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">for(auto&amp; it : cudaSmallBlocksMap){      if(FreeSize[it.first]) &gt; 1024 * 1024 * 1024{          auto&amp; cudaBlocks = it.second;          std::vector&lt;CudaSmallBlock&gt; tmp;          for(int i = 0; i &lt; cudaBlocks.size(); ++i){              if(!cudaBlocks[i].is_allocated){                  cudaSetDevice(it.first);                  cudaFree(cudaBlocks[i].data); // æœªåˆ†é…ï¼Œå½’è¿˜OS            } else{                  tmp.push_back(cudaBlocks[i]); // å·²åˆ†é…ï¼Œå­˜å›mapä¸­            }          }                        cudaBlocks.clear();         it.second = tmp;          FreeSize[it.first] = 0;     }        }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li><li><code>for(auto&amp; it : cudaSmallBlocksMap)</code>ï¼š<ul><li><code>&amp;it</code>ï¼šå¯¹å®¹å™¨å…ƒç´ çš„å¼•ç”¨ï¼Œ<code>&amp;</code>è¡¨ç¤ºå¯¹<code>it</code>çš„ä¿®æ”¹ä¼šç›´æ¥ä½œç”¨äºå®¹å™¨ä¸­çš„å…ƒç´ è€Œä¸ä¼šåˆ›å»ºå‰¯æœ¬</li><li><code>it.first</code>å’Œ<code>it.second</code>ï¼šåˆ†åˆ«æ˜¯è®¾å¤‡IDå’Œå†…å­˜å—å‘é‡</li></ul></li><li><code>__host__ cudaError_t cudaSetDevice(int device)</code>ï¼šSet device to be used for GPU executions.</li><li><code>cudaBlocks.clear()</code>ï¼šåœ¨æ›´æ–°cudaBlocksä¹‹å‰å…ˆæ¸…ç©º</li><li><code>FreeSize[it.first] = 0</code>ï¼šå¯¹å½“å‰è®¾å¤‡çš„FreeSizeå½’é›¶<br>3ï¼‰æ‰¾åˆ°å¾…freeçš„å†…å­˜å—çš„ä½ç½®ï¼Œè®¾<code>is_allocated = false</code>ï¼Œå¤§å°blockéƒ½ä¸å½’è¿˜åˆ°OSï¼Œé™¤éæ²¡æœ‰åœ¨å¤§å°blocké‡Œé¢æ‰¾åˆ°å¾…freeçš„æŒ‡é’ˆ<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">        for(auto&amp; it : cudaSmallBlocksMap){              auto&amp; cudaBlocks = it.second;              for(int i = 0; i &lt; cudaBlocks.size(); i++){                  if(cudaBlocks[i].data == ptr){                      cudaBlocks[i].is_allocated = false;                      FreeSize[it.first] += cudaBlocks[i].size;                    return;                  }                        }                        auto&amp; bigBlocks = cudaBigBlocksMap[it.first];              for(int i = 0; i &lt; bigBlocks.size(); i++){                  if(bigBlocks[i].data == ptr){                      bigBlocks[i].is_allocated = false;                      return;                  }                        }                }            cudaFree(ptr);      }};<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p><code>a.size</code>å’Œ<code>a.size()</code></p><ul><li>å½“<code>a</code>æ˜¯æ ‡å‡†å®¹å™¨(<code>std::vecotr</code>ï¼Œ<code>std::map</code>ç­‰ç­‰)æ—¶ï¼Œ<code>size</code>æ˜¯ä¸€ä¸ªæˆå‘˜å‡½æ•°ï¼Œç”¨äºè·å–å®¹å™¨çš„å¤§å°ï¼Œå†™æ³•ä¸º<code>a.size()</code>ï¼Œè°ƒç”¨æˆå‘˜å‡½æ•°</li><li>å½“<code>a</code>æ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„ç±»ï¼Œ<code>public: size_t size;</code>æ—¶ï¼Œ<code>size</code>æ˜¯ä¸€ä¸ªæˆå‘˜å˜é‡ï¼Œå†™æ³•ä¸º<code>a.size</code>ï¼›<code>public: size(){};</code>æ—¶ï¼Œ<code>size</code>æ˜¯æˆå‘˜å‡½æ•°ï¼Œå†™æ³•ä¸º<code>a.size()</code></li></ul><h1 id="Lesson-20-Context-attention"><a href="#Lesson-20-Context-attention" class="headerlink" title="Lesson 20 Context attention"></a>Lesson 20 Context attention</h1><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/LLM2%E6%8E%A8%E7%90%86%E5%BC%95%E6%93%8E/5731d9562b034964b53c0e7d24bd858.jpg"></p><h2 id="20-1src-layers-attention-context-attention-cpp"><a href="#20-1src-layers-attention-context-attention-cpp" class="headerlink" title="20.1src/layers/attention/context_attention.cpp"></a>20.1<code>src/layers/attention/context_attention.cpp</code></h2><h3 id="20-1-1-æ„é€ å‡½æ•°"><a href="#20-1-1-æ„é€ å‡½æ•°" class="headerlink" title="20.1.1 æ„é€ å‡½æ•°"></a>20.1.1 æ„é€ å‡½æ•°</h3><p><code>LLaMAContextAttentionLayer&lt;T&gt;::LLaMAContextAttentionLayer</code>ï¼šæ„é€ å‡½æ•°</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">head_num(head_num),  kv_head_num(kv_head_num),  head_size(head_size),  stream(stream),  cublas_wrapper(cublas_wrapper),  allocator(allocator), hidden_units(head_num * head_size),  attn_static_params(attn_params),   q_head_per_kv(head_num / kv_head_num),  scale(float(1 / sqrt(head_size)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="20-1-2-åˆ†é…å†…å­˜"><a href="#20-1-2-åˆ†é…å†…å­˜" class="headerlink" title="20.1.2 åˆ†é…å†…å­˜"></a>20.1.2 åˆ†é…å†…å­˜</h3><p><code>LLaMAContextAttentionLayer&lt;T&gt;::allocForForward(LLaMAAttentionDynParams&amp; params)</code>ï¼šåˆ†é…forwardæ‰€éœ€è¦çš„buffer</p><ul><li><p><code>LLaMAAttentionDynParams</code>å®šä¹‰æ¥æºï¼š<code>src/models/llama_llama_params.h</code></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">struct LLaMAAttentionDynParams {      int batch_size;      int num_tokens;      int max_q_len;      int max_k_len;  }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>å…ˆå®šä¹‰æŒ‡é’ˆ</p><ul><li><code>new</code>ï¼šå®ƒä»å †ä¸Šåˆ†é…æŒ‡å®šç±»å‹çš„å†…å­˜ï¼Œå¹¶è¿”å›ä¸€ä¸ªæŒ‡å‘è¯¥å†…å­˜å—çš„æŒ‡é’ˆã€‚ä½¿ç”¨ <code>new</code> åˆ†é…çš„å†…å­˜ä¸ä¼šåƒæ ˆä¸Šåˆ†é…çš„å˜é‡é‚£æ ·åœ¨å‡½æ•°ç»“æŸæ—¶è‡ªåŠ¨é‡Šæ”¾ï¼Œéœ€è¦æ‰‹åŠ¨é‡Šæ”¾ã€‚</li><li>å’Œ<code>malloc</code>åŒºåˆ«ï¼š<ul><li><code>new</code>ï¼šä¸ä»…åˆ†é…å†…å­˜ï¼Œè¿˜ä¼šè°ƒç”¨å¯¹è±¡çš„æ„é€ å‡½æ•°ï¼ˆå¦‚æœæ˜¯ç±»å¯¹è±¡çš„è¯ï¼‰</li><li><code>malloc</code>ï¼šåªè´Ÿè´£åˆ†é…å†…å­˜ï¼Œä¸ä¼šè°ƒç”¨æ„é€ å‡½æ•°</li></ul></li></ul></li><li><p>å†åˆ†é…å†…å­˜</p><ul><li><code>allocator-&gt;Malloc</code></li><li>å¯¹<code>k_cache_buf</code>å’Œ<code>v_cache_buf</code>åˆ†é…å†…å­˜æ—¶ï¼Œåœ¨<code>k_cache_buf</code>åˆ†é…ä¸¤å€çš„å†…å­˜ï¼Œå†ä»¤<code>v_cache_buf</code>çš„æ•°æ®æŒ‡é’ˆæŒ‡å‘<code>k_cache_buf</code>åç§»<code>batch_size * head_num * max_k_len * head_size</code>çš„åœ°æ–¹ã€‚è¿™æ ·å¯ä»¥å‡å°‘ä¸€æ¬¡å†…å­˜åˆ†é…<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">k_cache_buf-&gt;data = allocator-&gt;Malloc(k_cache_buf-&gt;data, 2 * sizeof(T) * batch_size * head_num * max_k_len * head_size);v_cache_buf-&gt;data = (T*)k_cache_buf-&gt;data + batch_size * head_num * max_k_len * head_size;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>â‘ <code>fusedQkvGemm</code><br><code>input</code></li></ul></li><li><p><code>input tensor</code><br><code>output</code></p></li><li><p><code>qkv_buf_wo_pad</code>: <code>[num_tokens, qkv_head_num, head_size]</code><br>ä½œç”¨ï¼šåšlinearå°†è¾“å…¥çš„tensorä¹˜ä¸Šqkvæƒé‡ï¼Œå¾—åˆ°qkv<br>â‘¡<code>AddbiasAndPaddingAndRope</code><br><code>output</code></p></li><li><p><code>q_buf_w_pad</code>: <code>[bs, head_num, max_q_len, head_size]</code></p></li><li><p><code>k_buf_w_pad</code>: <code>[bs, kv_head_num, max_q_len, head_size]</code></p></li><li><p><code>v_buf_w_pad</code>: <code>[bs, kv_head_num, max_q_len, head_size]</code><br>ä½œç”¨ï¼šæ·»åŠ åç½®ï¼Œè¿›è¡Œpaddingä½¿åŒä¸€æ‰¹æ¬¡çš„å¥å­é•¿åº¦ç›¸åŒï¼Œè¿›è¡Œä½ç½®æ—‹è½¬ç¼–ç <br>â‘¢<code>ConcatPastKVcache</code><br><code>output</code></p></li><li><p><code>k_cache_buf</code>: <code>[bs, head_num, max_q_len, head_size]</code></p></li><li><p><code>v_cache_buf</code>: <code>[bs, head_num, max_q_len, head_size]</code><br>ä½œç”¨ï¼šå°†æ–°å¾—åˆ°çš„KVå­˜å‚¨åˆ°cacheä¸­<br>â‘£<code>qk gemm</code><br><code>output</code></p></li><li><p><code>qk_buf</code>: <code>[bs, head_num, max_q_len, max_k_len]</code><br>ä½œç”¨ï¼šè¿›è¡Œqkç›¸ä¹˜ï¼Œå¾—åˆ°$QK^T$<br>â‘¤<code>FusedMaskAndScaleSoftmax</code><br><code>output</code></p></li><li><p><code>qk buf</code><br>ä½œç”¨ï¼šåŠ ä¸Šmaskå¹¶è¿›è¡Œscaleå’Œsoftmaxï¼Œå¾—åˆ°$Softmax(\dfrac{QK^T}{\sqrt{d_k}})$<br>â‘¥<code>qk*v gemm</code><br><code>output</code></p></li><li><p><code>qkv_buf_w_pad</code>: <code>[bs, head_num, max_q_len, head_size]</code><br>ä½œç”¨ï¼šå¾—åˆ°$Softmax(\dfrac{QK^T}{\sqrt{d_k}})V$<br>â‘¦<code>RemovingPadding</code><br><code>output</code></p></li><li><p><code>qkv_buf_wo_pad_1</code>: <code>[num_tokens, head_num, head_size]</code><br>ä½œç”¨ï¼šå°†paddingå»æ‰</p></li></ul><h3 id="20-1-3-é‡Šæ”¾å†…å­˜"><a href="#20-1-3-é‡Šæ”¾å†…å­˜" class="headerlink" title="20.1.3 é‡Šæ”¾å†…å­˜"></a>20.1.3 é‡Šæ”¾å†…å­˜</h3><p><code>src/utils/macro.h</code></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">inline void syncAndCheck(const char* const file, int const line){      cudaDeviceSynchronize();      cudaError_t result = cudaGetLastError();      if (result) {          throw std::runtime_error(std::string("[TM][ERROR] CUDA runtime error: ") + (_cudaGetErrorEnum(result)) + " " + file + ":" + std::to_string(line) + " \n");      }}    #define DeviceSyncAndCheckCudaError() syncAndCheck(__FILE__, __LINE__)  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>syncAndCheck</code><ul><li><code>cudaDeviceSynchronize()</code>ï¼šç¡®ä¿å½“å‰æ‰€æœ‰ CUDA æ“ä½œå®Œæˆ</li><li><code>cudaGetLastError()</code>ï¼šæ£€æŸ¥CUDAè¿è¡Œæ—¶çš„æœ€åä¸€ä¸ªé”™è¯¯</li><li>å‚æ•°ï¼š<ul><li><code>file</code>ï¼šè®°å½•å‘ç”Ÿé”™è¯¯çš„æºæ–‡ä»¶åç§°</li><li><code>line</code>ï¼šè®°å½•å‘ç”Ÿé”™è¯¯çš„è¡Œå·</li></ul></li></ul></li><li><code>#define DeviceSyncAndCheckCudaError() syncAndCheck(__FILE__, __LINE__) </code><ul><li>è°ƒç”¨<code>syncAndCheck</code>å‡½æ•°ï¼Œå¹¶è‡ªåŠ¨æ•è·å½“å‰çš„æ–‡ä»¶åå’Œè¡Œå·ï¼Œåœ¨è°ƒç”¨æ—¶ä¸éœ€è¦æ˜¾å¼ä¼ é€’ <code>__FILE__</code> å’Œ <code>__LINE__</code></li></ul></li></ul><p>é‡Šæ”¾<code>qkv_buf_wo_pad</code>ã€<code>q_buf_w_pad</code>ã€<code>k_cache_buf</code>ã€<code>qk_buf</code>ã€<code>qkv_buf_w_pad</code>ã€<code>qkv_buf_wo_pad_1</code>ï¼Œåœ¨æ¯ä¸ª<code>Free</code>çš„åé¢åŠ ä¸Š<code>DeviceSyncAndCheckCudaError()</code>ï¼Œæ£€æŸ¥æ˜¯å¦å‘ç”Ÿé”™è¯¯</p><h3 id="20-1-4-å‰å‘ä¼ æ’­"><a href="#20-1-4-å‰å‘ä¼ æ’­" class="headerlink" title="20.1.4 å‰å‘ä¼ æ’­"></a>20.1.4 å‰å‘ä¼ æ’­</h3><p><code>src/utils/tensor.h</code></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">struct TensorMap{      std::unordered_map&lt;std::string, Tensor*&gt; tensor_map_;        TensorMap() = default;          TensorMap(std::initializer_list&lt;std::pair&lt;std::string, Tensor*&gt;&gt; tensor_map){          for (auto&amp; pair : tensor_map){              if (isValid(pair.second)){                  tensor_map_.insert(pair.first, pair.second);             }              else{                  LLM_CHECK_WITH_INFO(isValid(pair.second),fmtstr("%s is not a valid tensor, skipping insert into TensorMap", pair.first.c_str()));              }                }        }          TensorMap(const std::unordered_map&lt;std::string, Tensor*&gt;&amp; tensor_map) {  for(auto it = tensor_map.begin(); it != tensor_map.end(); it++){            if (isValid(it-&gt;second)) {                  tensor_map_.insert(it-&gt;first, it-&gt;second);              }                        else {                  // TODO: add a reminder info              }          }        };    // ...}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>TensorMap(std::initializer_list&lt;std::pair&lt;std::string, Tensor*&gt;&gt; tensor_map)</code><ul><li>æ¥å—ä¸€ä¸ª <code>std::initializer_list</code> ç±»å‹çš„å‚æ•°ï¼Œå…¶å…ƒç´ æ˜¯é”®å€¼å¯¹ <code>std::pair&lt;std::string, Tensor*&gt;</code>ï¼Œé€‚ç”¨äºåˆå§‹åŒ–å®¹å™¨</li><li>ä¾‹å­ğŸ‘‡<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">Tensor* tensor1 = new Tensor(); Tensor* tensor2 = nullptr; // æ— æ•ˆæŒ‡é’ˆTensorMap tmap = {{"key1", tensor1},  {"key2", tensor2}} // æ— æ•ˆï¼Œä¼šè¢«è·³è¿‡<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li><li><code>TensorMap(const std::unordered_map&lt;std::string, Tensor*&gt;&amp; tensor_map)</code><ul><li>æ¥å—ä¸€ä¸ª <code>std::unordered_map&lt;std::string, Tensor*&gt;</code> ç±»å‹çš„å‚æ•°ï¼Œä½¿ç”¨ç°æœ‰å“ˆå¸Œè¡¨åˆå§‹åŒ–</li><li>ä¾‹å­ğŸ‘‡<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">std::unordered_map&lt;std::string, Tensor*&gt; umap = {{"key1", tensor1}, {"key2", tensor2}}; TensorMap tmap(umap);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li></ul><p>â‘ å…¥å‚</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">template&lt;typename T&gt;  void LLaMAContextAttentionLayer&lt;T&gt;::forward(TensorMap&amp; inputs, TensorMap&amp; outputs, LLaMAattentionWeights&lt;T&gt;&amp; weights,LLaMAAttentionDynParams&amp; params, LLaMAAttentionStaticParams&amp; static_params)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>inputs</code>ï¼šå…ƒç´ å¤§æ¦‚æ˜¯<code>{"attention_input",tensor1},{"padding_offset",tensor2}</code><ul><li>å› ä¸ºå¾ˆå¤šå‡½æ•°éœ€è¦TensorWrapperï¼Œè€Œä¼ è¿›å»çš„æ˜¯Tensorï¼Œå¯¹äºéœ€è¦Tensorå¼ºè½¬ä¸ºTensorWrapperçš„æƒ…å†µï¼Œç”¨åˆ°ğŸ‘‡(<code>src/utils/tensor.h</code>)<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">template&lt;typename T&gt;  TensorWrapper&lt;T&gt;* as(){      return static_cast&lt;TensorWrapper&lt;T&gt;*&gt;(this); // Tensorè½¬å­ç±»TensorWrapperçš„ä¸‹è¡Œè½¬æ¢  }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li><li><code>outputs</code>ï¼šåŒä¸Š</li><li><code>weights</code>ï¼š<code>src/weights/llama/attention_weights.h</code>ä¸­ï¼Œå†…ç½®å±æ€§æœ‰<code>BaseWeight&lt;T&gt; qkv;  BaseWeight&lt;T&gt; output;</code></li><li><code>params</code>ï¼š<code>src/models/llama/llama_params.h</code>ï¼Œå†…ç½®å±æ€§æœ‰<code>int batch_size; int num_tokens; int max_q_len; int max_k_len;</code></li><li><code>static_params</code>ï¼š<code>src/models/llama/llama_params.h</code>ï¼Œæ˜¯å…³äºæ—‹è½¬ç¼–ç çš„å±æ€§<code>int rotary_embedding_dim; float rotary_embedding_base;  int max_position_embeddings; bool use_dynamic_ntk;</code></li></ul><p>â‘¡å‡†å¤‡å†…å­˜<br>ä½¿ç”¨20.1.2ä¸­çš„åˆ†é…å†…å­˜</p><p>â‘¢qkv linear<br><code>src/kernels/linear.h</code></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">launchLinearGemm(attention_input-&gt;as&lt;T&gt;(), weights.qkv, qkv_buf_wo_pad, cublas_wrapper)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¯¹åº”<code>input</code>ã€<code>weight</code>ã€<code>output</code>ã€<code>cublas_wrapper</code>ã€<code>trans_a</code>ã€<code>trans_b</code><br>å®Œæˆ<code>fusedQkvGemm</code></p><p>â‘£qkv bias and rope and padding</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">launchAddFusedQKVBiasTransposeAndRoPE(qkv_buf_w_pad,   k_buf_w_pad,   v_buf_w_pad,   qkv_buf_wo_pad,  weights.qkv,   padding_offset-&gt;as&lt;int&gt;(),   history_length-&gt;as&lt;int&gt;(),   input_length-&gt;as&lt;int&gt;(),  static_params);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ€ååœ¨<code>k_buf_w_pad</code>å’Œ<code>v_buf_w_pad</code>å¾—åˆ°ropeå’Œpaddingçš„ç‰ˆæœ¬</p><p>â‘¤concat past kv cache</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">launchConcatKVCache(k_buf_w_pad, v_buf_w_pad, layer_id-&gt;as&lt;int&gt;(), input_length-&gt;as&lt;int&gt;(), history_length-&gt;as&lt;T&gt;(),                      all_k_cache-&gt;as&lt;T&gt;(),                     all_v_cache-&gt;as&lt;T&gt;());<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ€ååœ¨<code>all_k_cache</code>å’Œ<code>all_v_cache</code>å¾—åˆ°kvcache<br>å› ä¸º<code>layer_id</code>æ˜¯åœ¨CPUä¸Šåˆ†é…çš„<code>int layer = layer_id-&gt;getVal();</code>å› æ­¤éœ€è¦è½¬ä¸ºTensorWrapper</p><p>â‘¥repeat kv</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">launchRepeatKVCache(all_k_cache-&gt;as&lt;T&gt;(), all_v_cache-&gt;as&lt;T&gt;(), context_length-&gt;as&lt;int&gt;(),                      layer_id-&gt;as&lt;int&gt;(),                    k_cache_buf,                     v_cache_buf);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>input</code>:<br>    <code>all_k_cache</code>&amp;<code>all_v_cache</code>: <code>[num_layers, batch_size, kv_head_num, max_seq_len, head_size]</code><br><code>output</code>:<br>    <code>k_cache_buf</code>&amp;<code>v_cache_buf</code>: <code>[bs, head_num, max_k_len, head_size]</code><br>ä½œç”¨æ˜¯å°†kvcacheçš„<code>kv_head_num</code>è¡¥æˆ<code>head_num</code></p><p>â‘¦qk</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">launchLinearStridedBatchGemm(q_buf_w_pad, k_cache_buf, qk_buf, cublas_wrapper, false, true);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><code>input</code>:<br>    <code>q_buf_w_pad</code>: <code>[bs, head_num, max_q_len, head_size]</code><br>    <code>k_cache_buf</code>: <code>[bs, head_num, max_k_len, head_size]</code>(trans_b = true)<br><code>output</code>:<br>    <code>qk_buf</code>: <code>[bs, head_num, max_q_len, max_k_len]</code></p><p>â‘§scale + mask + softmax</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">launchScaleMaskAndSoftmax(qk_buf, attention_mask-&gt;as&lt;T&gt;(), qk_buf, scale);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç»™<code>qk_buf</code>åŠ scaleã€maskã€softmax</p><p>â‘¨qk*v</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">launchLinearStridedBatchGemm(qk_buf, v_cache_buf, qkv_buf_w_pad, cublas_wrapper, false, false);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><code>input</code>:<br>    <code>qk_buf</code>: <code>[bs, head_num, max_q_len, max_k_len]</code><br>    <code>v_cache_buf</code>: <code>[bs, head_num, max_k_len, head_size]</code><br><code>output</code>:<br>    <code>qkv_buf_w_pad</code>: <code>[bs, head_num, max_q_len, head_size]</code></p><p>â‘©transpose + removepadding</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">launchTransposeOutRemovePadding(qkv_buf_w_pad, padding_offset-&gt;as&lt;T&gt;(), qkv_buf_wo_pad_1);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><code>input</code>:<br>    <code>qkv_buf_w_pad</code>: <code>[bs, head_num, max_q_len, head_size]</code><br>    å…ˆtransposeå˜æˆ<code>[bs, max_q_len, head_num, head_size]</code><br><code>output</code>:<br>    <code>qkv_buf_wo_pad_1</code>: <code>[numtokens, hiddenunits]</code></p><p>â‘ output linear</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">launchLinearGemm(qkv_buf_wo_pad_1, weights.output, attention_output, cublas_wrapper, false, true);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä¹˜ä¸Šè¾“å‡ºçš„æƒé‡</p><p>â‘¡freebuf<br>é‡Šæ”¾æ‰€æœ‰çš„ç¼“å­˜</p><h2 id="20-2examples-cpp-attention-context-attn-example-cpp"><a href="#20-2examples-cpp-attention-context-attn-example-cpp" class="headerlink" title="20.2examples/cpp/attention/context_attn_example.cpp"></a>20.2examples/cpp/attention/context_attn_example.cpp</h2><p>å˜é‡ï¼š</p><ul><li>åŸºæœ¬å‚æ•°ï¼š<ul><li><code>head_num</code>&amp;<code>kv_head_num</code>ï¼šå‰è€…æ˜¯qçš„ï¼Œåè€…æ˜¯kå’Œvçš„</li><li><code>head_size</code></li><li><code>num_layers</code></li><li><code>max_seq_len</code>ï¼škv cacheæœ€å¤§çš„ä¸Šä¸‹æ–‡é•¿åº¦</li><li><code>hidden_units</code>&amp;<code>q_hidden_units</code>ï¼šå‰è€…æ˜¯qkvæ€»å’Œçš„ï¼Œåè€…æ˜¯qçš„</li><li>ä½œä¸ºåˆå§‹åŒ–æ¯ä¸ªkernelé‡Œå¤§å°çš„å‚æ•°</li></ul></li><li>é™æ€å‚æ•°ï¼š(å¤šæ•°æ˜¯ä½ç½®ç¼–ç çš„)<ul><li><code>rotary_embedding_dim</code></li><li><code>rotary_embedding_base</code></li><li><code>max_position_embeddings</code></li><li><code>use_dynamic_ntk</code></li></ul></li><li>åŠ¨æ€å‚æ•°ï¼š<ul><li><code>batch_size</code></li><li><code>num_tokens</code></li><li><code>max_q_len</code>&amp;<code>max_k_len</code><ul><li><code>max_q_len</code>ï¼špaddingä¹‹å‰åŒä¸€batchä¸‹çš„æœ€é•¿çš„å¥å­é•¿åº¦</li><li><code>max_k_len</code>ï¼šåŒä¸€ä¸ªbatchä¸­ä¸Šä¸‹æ–‡çš„æœ€å¤§å€¼</li></ul></li></ul></li><li>è¾“å…¥è¾“å‡ºå€¼(ä»ä¸»æœºä¸Šè·å–æ•°æ®ï¼Œå¤åˆ¶åˆ°è®¾å¤‡ä¸Š)<ul><li><code>attention_input</code>ï¼š<code>[num_tokensï¼Œq_hidden_units]</code>ï¼Œæ˜¯æœ€åˆçš„è¾“å…¥</li><li><code>qkv_weights</code>ï¼š<code>[q_hidden_units, hidden_units]</code>ï¼Œåš<code>qkvgemm</code>æ—¶ç”¨åˆ°</li><li><code>mask</code>ï¼š<code>[batch_size, max_q_len, max_k_len]</code>ï¼Œå½“å‰çš„toeknä¸èƒ½è®¿é—®åˆ°å…¶åé¢çš„token</li><li><code>qkv_bias</code>ï¼š<code>[hidden_units]</code>ï¼Œqkvçš„åç½®</li><li><code>all_k_cache</code>ï¼š<code>[num_layers, batch_size, kv_head_num, max_seq_len, head_size]</code></li><li><code>all_v_cache</code>ï¼š<code>[num_layers, batch_size, kv_head_num, max_seq_len, head_size]</code></li><li><code>padding_offset</code>ï¼š<code>[num_tokens]</code>ï¼Œæ¯ä¸ªtokenéƒ½æœ‰ä¸€ä¸ªâ€åœ¨è¯¥tokenä¹‹å‰çš„paddingä¸ªæ•°çš„æ•°å€¼â€œ</li><li><code>history_length</code>ï¼š<code>[batch_size]</code></li><li><code>layer_id</code>ï¼š</li><li><code>ctx_len</code>ï¼š<code>[batch_size]</code>ï¼Œæ¯å¥è¯çš„ä¸Šä¸‹æ–‡é•¿åº¦ï¼Ÿ</li><li><code>attention_output</code>ï¼š<code>[num_tokens, q_hidden_units]</code></li><li><code>output_weights</code>ï¼š<code>[q_hidden_units, q_hidden_units]</code></li></ul></li></ul><h1 id="Lesson21-mask-self-attention-layer"><a href="#Lesson21-mask-self-attention-layer" class="headerlink" title="Lesson21 mask self attention layer"></a>Lesson21 mask self attention layer</h1><p>è¯´æ˜¯å†™çš„GQAéƒ¨åˆ†<br>åŒºåˆ«ä¸context decoder: </p><ul><li>è‡ªå›å½’ç”Ÿæˆæ¨¡å¼ï¼Œå› æ­¤ä¸éœ€è¦maskå’Œpadding(å’Œremove padding)</li></ul><p>layeræ­å»ºé¡ºåºå’Œcontext attentionç±»ä¼¼</p><h2 id="21-1src-layers-attention-masked-self-attentioon-cpp"><a href="#21-1src-layers-attention-masked-self-attentioon-cpp" class="headerlink" title="21.1src/layers/attention/masked_self_attentioon.cpp"></a>21.1src/layers/attention/masked_self_attentioon.cpp</h2><p>â‘ åˆ†é…å†…å­˜</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">allocForForward(params);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>â‘¡qkv linear</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">launchLinearGemm(attention_input-&gt;as&lt;T&gt;(), weights.qkv, qkv_buf, cublas_wrapper);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>åŒæ—¶ï¼Œè¿™é‡Œä¸éœ€è¦åœ¨åé¢åŠ ä¸Š<code>DeviceSyncAndCheckCudaError();</code>å› ä¸º<code>cublasWrapper</code>è‡ªå¸¦äº†<code>CHECK_CUBLAS</code>(å› æ­¤æ¶‰åŠåˆ°cublasçš„éƒ½ä¸éœ€è¦å†è¿›è¡Œæ£€æŸ¥)<br>â‘¢fused decoder self attention</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">launchDecoderMaskedMHA(qkv_buf, weights.qkv,    layer_id-&gt;as&lt;int&gt;(),                         k_cache-&gt;as&lt;T&gt;(),                        v_cache-&gt;as&lt;T&gt;(),                        finished-&gt;as&lt;bool&gt;(),                         step-&gt;as&lt;int&gt;(),                        mha_output-&gt;as&lt;T&gt;(),                        static_params);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ€åä¸€ä¸ªå…¥å‚æ˜¯<code>LLaMAAttentionStaticParams&amp; static_param</code>ï¼Œæ˜¯ä¸€ä¸ªå«æœ‰ä½ç½®ç¼–ç å±æ€§çš„ç»“æ„ä½“</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">struct LLaMAAttentionStaticParams {      int   rotary_embedding_dim;      float rotary_embedding_base;      int   max_position_embeddings;      bool  use_dynamic_ntk; // for dyn scaling rope  };template&lt;typename T&gt;  class LLaMASelfAttentionLayer {private:LLaMAAttentionStaticParams attn_static_params;public:LLaMAAttentionStaticParams&amp; GetAttnStaticParams(){      return attn_static_params;  // è¿™é‡Œçš„è¿”å›å€¼æ˜¯å¼•ç”¨ï¼Œå‡½æ•°çš„è°ƒç”¨ä¸ä¼šå¤åˆ¶attn_static_paramsï¼Œè€Œæ˜¯ç›´æ¥è¿”å›å®ƒçš„å†…å­˜åœ°å€}template&lt;typename T&gt;  void LLaMASelfAttentionLayer&lt;T&gt;::forward(TensorMap&amp; inputs, TensorMap&amp; outputs, LLaMAattentionWeights&lt;T&gt;&amp; weights, LLaMAAttentionDynParams&amp; params){LLaMAAttentionStaticParams static_params = GetAttnStaticParams();}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>ä¸ºä»€ä¹ˆå¯ä»¥ç›´æ¥ä½¿ç”¨<code>LLaMAAttentionStaticParams static_params = GetAttnStaticParams();</code>ï¼š<ul><li>ç¼–è¯‘å™¨å¯¹<strong>å¼•ç”¨</strong>æŒ‡å‘çš„<code>attn_static_params</code>æ‰§è¡Œæ‹·è´æ„é€ ï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„<code>LLaMAAttentionStaticParams</code>å®ä¾‹<ul><li>å±€éƒ¨å˜é‡<code>static_params</code>æ˜¯ä¸€ä¸ª<strong>å€¼ç±»å‹</strong></li><li><code>GetAttnStaticParams()</code>è¿”å›ä¸€ä¸ªæŒ‡å‘ç±»ä¸­æˆå‘˜å˜é‡<code>attn_static_params</code>çš„<strong>å¼•ç”¨</strong></li></ul></li><li>å¦‚æœä¿®æ”¹<code>static_params</code>ï¼Œä¸ä¼šå½±å“<code>attn_static_params</code></li></ul></li><li>å¦‚æœæ˜¯å¦ä¸€ç§æƒ…å†µ<code>LLaMAAttentionStaticParams&amp; static_params = GetAttnStaticParams();</code><ul><li><code>static_params</code>åªæ˜¯<code>attn_static_params</code>çš„ä¸€ä¸ªåˆ«åï¼Œç¼–è¯‘å™¨ä¸ä¼šä¸º<code>static_params</code>åˆ†é…æ–°çš„å†…å­˜ç©ºé—´ï¼Œä»–å’Œ<code>attn_static_params</code>å…±ç”¨ä¸€å—å†…å­˜<ul><li>å±€éƒ¨å˜é‡<code>static_params</code>æ˜¯ä¸€ä¸ª<strong>å¼•ç”¨ç±»å‹</strong></li><li><code>GetAttnStaticParams()</code>è¿”å›ä¸€ä¸ªæŒ‡å‘ç±»ä¸­æˆå‘˜å˜é‡<code>attn_static_params</code>çš„<strong>å¼•ç”¨</strong></li></ul></li></ul></li><li>å¼•ç”¨ä¸æŒ‡é’ˆçš„åŒºåˆ«<ul><li>å¼•ç”¨ï¼šä¸€æ—¦ç»‘å®šåˆ°æŸä¸ªå˜é‡å°±ä¸èƒ½å†ç»‘å®šåˆ°å…¶ä»–å˜é‡ï¼›æœ¬è´¨ä¸Šæ˜¯å˜é‡çš„åˆ«åï¼Œä¸éœ€è¦å ç”¨é¢å¤–çš„å†…å­˜</li><li>æŒ‡é’ˆï¼šå¯ä»¥é‡æ–°æŒ‡å‘å…¶ä»–å˜é‡ï¼›æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å˜é‡ï¼Œéœ€è¦å ç”¨å†…å­˜æ¥å­˜å‚¨åœ°å€</li></ul></li></ul><p>â‘£output</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">launchLinearGemm(mha_output, weights.output, attention_output-&gt;as&lt;T&gt;, cublas_wrapper);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="21-2src-examples-cpp-attention-self-attention-example-cpp"><a href="#21-2src-examples-cpp-attention-self-attention-example-cpp" class="headerlink" title="21.2src/examples/cpp/attention/self_attention_example.cpp"></a>21.2src/examples/cpp/attention/self_attention_example.cpp</h2><p>å˜é‡ï¼š</p><ul><li>åŸºæœ¬å‚æ•°ï¼š<ul><li><code>head_num</code>&amp;<code>kv_head_num</code>ï¼šå‰è€…æ˜¯qçš„ï¼Œåè€…æ˜¯kå’Œvçš„</li><li><code>head_size</code></li><li><code>num_layers</code></li><li><code>max_seq_len</code>ï¼škv cacheæœ€å¤§çš„ä¸Šä¸‹æ–‡é•¿åº¦</li><li><code>hidden_units</code>&amp;<code>q_hidden_units</code>ï¼šå‰è€…æ˜¯qkvæ€»å’Œçš„ï¼Œåè€…æ˜¯qçš„</li><li>ä½œä¸ºåˆå§‹åŒ–æ¯ä¸ªkernelé‡Œå¤§å°çš„å‚æ•°</li></ul></li><li>é™æ€å‚æ•°ï¼š(å¤šæ•°æ˜¯ä½ç½®ç¼–ç çš„)<ul><li><code>rotary_embedding_dim</code></li><li><code>rotary_embedding_base</code></li><li><code>max_position_embeddings</code></li><li><code>use_dynamic_ntk</code></li></ul></li><li>åŠ¨æ€å‚æ•°ï¼š<ul><li><code>batch_size</code></li></ul></li><li>è¾“å…¥è¾“å‡ºå€¼(ä»ä¸»æœºä¸Šè·å–æ•°æ®ï¼Œå¤åˆ¶åˆ°è®¾å¤‡ä¸Š)<ul><li><code>attention_input</code>ï¼š<code>[num_tokensï¼Œq_hidden_units]</code>ï¼Œæ˜¯æœ€åˆçš„è¾“å…¥</li><li><code>all_k_cache</code>ï¼š<code>[num_layers, batch_size, kv_head_num, max_seq_len, head_size]</code></li><li><code>all_v_cache</code>ï¼š`[num_layers, batch_size, kv_head_num, max_seq_len, </li><li><code>layer_id</code></li><li><code>finished</code>ï¼š<code>[batch_size]</code></li><li><code>qkv_weights</code>ï¼š<code>[q_hidden_units, hidden_units]</code>ï¼Œåš<code>qkvgemm</code>æ—¶ç”¨åˆ°</li><li><code>output_weights</code>ï¼š<code>[q_hidden_units, q_hidden_units]</code></li><li><code>qkv_bias</code>ï¼š<code>[hidden_units]</code>ï¼Œqkvçš„åç½®</li><li><code>attention_output</code>ï¼š<code>[num_tokens, q_hidden_units]</code></li></ul></li></ul><h1 id="Lesson22-FFN"><a href="#Lesson22-FFN" class="headerlink" title="Lesson22 FFN"></a>Lesson22 FFN</h1><p><a href="https://www.cnblogs.com/peixu/p/16842247.html" title="å‘å¸ƒäº 2022-10-30 21:04">å…³äºTransformerä¸­feed forward layerç†è§£</a><br><a href="https://juejin.cn/post/7389923941492375579">Transformer è®ºæ–‡é€šä¿—è§£è¯»ï¼šFFN çš„ä½œç”¨</a></p><h2 id="22-1-src-layers-ffn-ffn-h"><a href="#22-1-src-layers-ffn-ffn-h" class="headerlink" title="22.1 src/layers/ffn/ffn.h"></a>22.1 <code>src/layers/ffn/ffn.h</code></h2><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">void allocForForward(LLaMAAttentionDynParams&amp; params);  void allocForForward(int batch_size);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>é‡è½½å‡½æ•°</p><ul><li>context attentionä¸­åœ¨remove paddingåæ•°æ®çš„ç¬¬ä¸€ç»´æ˜¯<code>num_tokens</code>(ä¼ å…¥çš„æ˜¯<code>params.num_tokens</code>)</li><li>self attentionä¸­æ•°æ®çš„ç¬¬ä¸€ç»´ä¸€ç›´æ˜¯<code>batch_size</code>(<code>[batch_size, 1, ...]</code>)</li></ul><h2 id="22-2-src-layers-ffn-ffn-cpp"><a href="#22-2-src-layers-ffn-ffn-cpp" class="headerlink" title="22.2 src/layers/ffn/ffn.cpp"></a>22.2 <code>src/layers/ffn/ffn.cpp</code></h2><p><code>forward()</code><br>â‘ ç¡®å®šä½¿ç”¨å“ªç§forwardçš„å†…å­˜åˆ†é…</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">if (params.num_tokens &gt; 0) {      allocForForward(params);  } else {                      allocForForward(params.batch_size);  }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœå­˜åœ¨num_tokensåˆ™ä¸ºcontext attentionï¼Œå¯¹åº”<code>params</code>ï¼›<br>å¦‚æœä¸å­˜åœ¨åˆ™ä¸ºself attentionï¼Œå¯¹åº”<code>batch_size</code></p><p>â‘¡fusedGateUp projs</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">launchLinearGemm(ffn_input-&gt;as&lt;T&gt;(), weights.gateAndup, SwiGLU_input, cublas_wrapper, false, true);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>è¾“å…¥<code>ffn_input</code>ï¼š<code>[bs(/num_tokens), q_hidden_units]</code></li><li>æƒé‡<code>weights.gateAndup</code>ï¼š<code>[q_hidden_units, 2 * inter_size]</code></li><li>è¾“å‡º<code>SwiGLU_input</code>ï¼š<code>[bs(/num_tokens), 2 * inter_size]</code></li><li>ç»è¿‡Gate Linearå’ŒUp Linearçš„è¾“å…¥éƒ½æ˜¯<code>[bs(/num_tokens), q_hidden_units]</code>ï¼Œå› æ­¤å°†ä»–ä»¬åƒfusedQKVGemmä¸€æ ·è¿›è¡ŒfusedGateUpGemmï¼Œè¾“å‡ºä½¿ç”¨åŒä¸€å—buf</li><li>ä¸ºå•¥è¿™é‡Œtrans_b=trueï¼Ÿ</li></ul><p>â‘¢swiGLU</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">launchAct(SwiGLU_input, down_proj_input);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>è¾“å…¥<code>SwiGLU_input</code>ï¼š<code>[bs(/num_tokens), 2 * inter_size]</code><ul><li>ä¸¤ä¸ªå¤§å°ä¸º<code>[bs(/num_tokens), inter_size]</code>çš„Gateæ•°ç»„å’ŒUpæ•°ç»„çš„ç›¸åŒåç§»é‡çš„æ•°æ®ä¸€èµ·è®¡ç®—ï¼Œå› æ­¤æœ€åçš„è¾“å‡ºçš„ç¬¬äºŒç»´å¤§å°ä¸ºåŸæ¥çš„ä¸€åŠ</li></ul></li><li>è¾“å‡º<code>down_proj_input</code>ï¼š<code>[bs(/num_tokens), inter_size]</code></li></ul><p>â‘£down proj</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">launchLinearGemm(down_proj_input, weights.down, ffn_output-&gt;as&lt;T&gt;(), cublas_wrapper, false, true);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>è¾“å…¥<code>down_proj_input</code>ï¼š<code>[bs(/num_tokens), inter_size]</code></li><li>æƒé‡<code>weights.gateAndup</code>ï¼š<code>[q_hidden_units, inter_size]</code> trans_b=true</li><li>è¾“å‡º<code>SwiGLU_input</code>ï¼š<code>[bs(/num_tokens), q_hidden_units]</code></li></ul><h2 id="22-3examples-cpp-ffn-ffn-example-cpp"><a href="#22-3examples-cpp-ffn-ffn-example-cpp" class="headerlink" title="22.3examples/cpp/ffn/ffn_example.cpp"></a>22.3<code>examples/cpp/ffn/ffn_example.cpp</code></h2><p>å˜é‡ï¼š</p><ul><li>åŸºæœ¬å‚æ•°ï¼š<ul><li>`head_num</li><li><code>head_size</code></li><li><code>inter_size</code></li><li>`hidden_units</li><li>ä½œä¸ºåˆå§‹åŒ–æ¯ä¸ªkernelé‡Œå¤§å°çš„å‚æ•°</li></ul></li><li>åŠ¨æ€å‚æ•°ï¼š<ul><li><code>num_tokens</code></li></ul></li><li>è¾“å…¥è¾“å‡ºå€¼(ä»ä¸»æœºä¸Šè·å–æ•°æ®ï¼Œå¤åˆ¶åˆ°è®¾å¤‡ä¸Š)<ul><li><code>ffn_input</code>ï¼š<code>[hidden_units, num_tokens]</code></li><li><code>gate_up</code>ï¼š<code>[hidden_units, 2 * inter_size]</code></li><li><code>down</code>ï¼š<code>[hidden_units, inter_size]</code></li></ul></li><li>è®¾ç½®ä¸ºè®¾å¤‡å‚æ•°<ul><li><code>ffn_output</code></li></ul></li></ul><h2 id="22-4-å…³äºCMakeList-txt"><a href="#22-4-å…³äºCMakeList-txt" class="headerlink" title="22.4 å…³äºCMakeList.txt"></a>22.4 å…³äºCMakeList.txt</h2><p><code>src/layers/ffn/CMakList.txt</code></p><ul><li>å°†<code>ffn.cpp</code>ç¼–è¯‘åˆ°é™æ€åº“ä¸­å¹¶å‘½åä¸º<code>Llamaffn</code><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">add_library(Llamaffn STATIC ffn.cpp)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li>é“¾æ¥<code>Llamaffn</code>æ‰€ç”¨åˆ°çš„å‡½æ•°(<code>launchLinearGemm</code>,<code>launchAct</code>)å¯¹åº”çš„é™æ€åº“(<code>linear</code>,<code>act</code>)<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">target_link_libraries(Llamaffn PUBLIC                               -lcudart                               -lcudadevrt                               act                               linear)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><code>examples/cpp/ffn/CMakeList.txt</code></li><li>å°†<code>ffn_example.cpp</code>ç¼–è¯‘åˆ°å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ä¸­å¹¶å‘½åä¸º<code>ffnExample</code> <pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">add_executable(ffnExample ffn_example.cpp)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li>é“¾æ¥<code>ffnExample</code>æ‰€ç”¨åˆ°çš„å‡½æ•°(<code>ffn.cpp</code>)å¯¹åº”çš„é™æ€åº“(<code>Llamaffn</code>)</li></ul><h1 id="Lesson23-llama-layer-weight"><a href="#Lesson23-llama-layer-weight" class="headerlink" title="Lesson23 llama layer weight"></a>Lesson23 llama layer weight</h1><p>è®²è§£äº†ï¼š<br><code>src/weights/llama/layer_weights.h</code><br><code>src/weights/llama/layer_weights.cc</code><br><code>src/weights/llama/CMakelists.txt</code><br><code>src/utils/weights_utils.h</code><br><code>src/utils/weights_utils.cu</code><br><code>src/utils/CMakelists.txt</code></p><p>æœ‰weightçš„åœ°æ–¹</p><ul><li>llama weights<ul><li>Embedding</li><li>LMhead(æœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªlinear)</li></ul></li><li>layer weights<ul><li>ç‰¹ç‚¹æ˜¯æœ‰å¾ˆå¤štransformerå †å èµ·æ¥</li><li><code>LayerNormWeight&lt;T&gt; attn_norm_weight;</code><ul><li>RMSNorm</li></ul></li><li><code>LLaMAattentionWeights&lt;T&gt; self_attn_weight;</code><ul><li>QKVgemm</li><li>output linear</li></ul></li><li><code>LayerNormWeight&lt;T&gt; ffn_norm_weight;</code><ul><li>FusedAddbiasResidualAndRMSNorm</li></ul></li><li><code>LLaMAFFNWeights&lt;T&gt; ffn_weight;</code><ul><li>Gate</li><li>Up</li><li>down</li></ul></li></ul></li></ul><p><code>src/utils/weights_utils.cu</code><br>åœ¨æºæ–‡ä»¶ä¸­çš„æ¨¡æ¿ä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œåªæœ‰åœ¨å®ä¾‹åŒ–åæ‰æ˜¯ä¸€ä¸ªå‡½æ•°å¹¶ä¸”å¯ä»¥è¿›è¡Œé“¾æ¥<br>å®ç°äº†<code>GPUMalloc</code>å’Œ<code>GPUFree</code>ï¼Œç›®çš„ï¼šåœ¨åˆ†é…å†…å­˜å’Œé‡Šæ”¾å†…å­˜æ—¶è¿›è¡Œæ£€æŸ¥</p><p><code>src/weights/llama/layer_weights.h</code><br>å®šä¹‰äº†å››ä¸ªå‡½æ•°</p><p><code>src/weights/llama/layer_weights.cc</code><br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/LLM2%E6%8E%A8%E7%90%86%E5%BC%95%E6%93%8E/57edc5cf50e98d36315d8564f2c5111.png"><br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/LLM2%E6%8E%A8%E7%90%86%E5%BC%95%E6%93%8E/39931b88ed57cae22fab8e5d4700e67.jpg"><br>â‘ <code>attn_norm_weight.gamma</code>ï¼šcontext decoderå’Œself decoderå…±ç”¨</p><ul><li>ç±»å‹ä¸ºï¼š<code>LayerNormWeight&lt;T&gt;</code></li><li>æˆå‘˜æœ‰ï¼š<code>T* gamma</code><br>â‘£<code>ffn_norm_weight.gamma</code>ï¼šcontext decoderå’Œself decoderå…±ç”¨<br>åŒä¸Š</li></ul><p>â‘¡<code>self_attn_weight.qkv</code>ï¼šcontext decoderå’Œself decoderå…±ç”¨</p><ul><li>ç±»å‹ä¸ºï¼š<code>BaseWeight&lt;T&gt;</code></li><li>æˆå‘˜æœ‰ï¼š<ul><li><code>std::vector&lt;int&gt; shape;</code></li><li><code>T* data;</code></li><li><code>WeightType type;</code></li><li><code>T* bias;</code>ä¸ä¸€å®šæ¯ä¸ªweightéƒ½æœ‰<br>â‘¢â‘¤â‘¥â‘¦åŒä¸Š<br>â‘¢<code>self_attn_weight.output</code><br>â‘¤<code>ffn_weight.gate</code>ï¼šcontext decoderå’Œself decoderå…±ç”¨<br>â‘¥<code>ffn_weight.up</code>ï¼šcontext decoderå’Œself decoderå…±ç”¨<br>â‘¦<code>ffn_weight.down</code>ï¼šcontext decoderå’Œself decoderå…±ç”¨</li></ul></li></ul><p>åœ¨<code>loadWeights</code>è¿™ä¸€æ­¥ä¸­ï¼Œå¯ä»¥åŠ å…¥å‡çš„æ•°æ®ï¼Œçœå»åŠ è½½æ¨¡å‹è¿™ä¸€æ­¥ï¼Œä¸»è¦ç”¨äºæµ‹è¯•æ€§èƒ½ï¼Œä¸å…³æ³¨ç²¾åº¦</p><ul><li>æµç¨‹ï¼š<code>cudaMalloc</code>å„ç§d_weightså˜é‡ -&gt; <code>malloc</code>å„ç§h_weightså˜é‡ -&gt; h_weightsè½½å…¥å‡æ•°æ® -&gt; é€šè¿‡<code>cudaMemcpy</code>å°†h_weightså¤åˆ¶åˆ°d_weights -&gt; å†å°†d_weightsèµ‹å€¼ç»™</li></ul><p><code>freeWights(BaseWeight&lt;T&gt;&amp; weights)</code>ï¼šå°†<code>bias</code>ä¹Ÿç»™é‡Šæ”¾<br>æœ€åææ„å‡½æ•°ä¸­é‡Šæ”¾æ‰€æœ‰çš„ç¼“å­˜</p><h1 id="Lesson24-AddBiasResidual"><a href="#Lesson24-AddBiasResidual" class="headerlink" title="Lesson24 AddBiasResidual"></a>Lesson24 AddBiasResidual</h1><p>è®²è§£äº†ï¼š<br><code>src/kernels/add_residual.h</code><br><code>src/kernels/add_residual.cu</code><br><code>tests/unittest/test_residual.cu</code></p><p><code>residual</code>æ¥æº<code>FusedAddbiasResidualAndRMSNorm</code>ä¸­<code>FusedAddbiasResidual</code>çš„è¾“å‡º(åŒæ—¶æ˜¯<code>RMSNorm</code>çš„è¾“å…¥)<br><code>decoder_out</code>æ¥æº<code>Down Linear</code></p><p><code>decoder_out</code> += <code>residual</code></p><ul><li><code>decoder_out</code>ï¼š<code>[num_tokens, hidden_units]</code></li><li><code>redisual</code>ï¼š<code>[num_tokens, hidden_units]</code>â†åœ¨context decoderä¸­ï¼Œåœ¨self decoderä¸­ç¬¬ä¸€ç»´æ˜¯batch_size</li><li>ä½œç”¨ï¼šä»£è¡¨äº†åˆæ­¥èåˆåçš„ç‰¹å¾ï¼Œæ˜¯ä¸€ç§åŒ…å«åŸå§‹ä¿¡æ¯ä¸æ–°ç‰¹å¾çš„ä¿¡æ¯æµï¼Œéšåä¼šä¼ é€’åˆ°å½’ä¸€åŒ–æ“ä½œï¼ˆå¦‚ RMSNormï¼‰ä¸­ï¼Œä»¥ä¾¿ä¸ºä¸‹æ¸¸æ¨¡å—æä¾›ç¨³å®šçš„åˆ†å¸ƒã€‚</li></ul><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">Vec_t* dout = reinterpret_cast&lt;Vec_t*&gt;(decoder_out + batch_id * hidden_units);Vec_t* rsd = reinterpret_cast&lt;Vec_t*&gt;(residual + batch_id * hidden_units);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>å°†<code>decoder_out</code>å’Œ<code>residual</code>è½¬åŒ–ä¸ºå‘é‡åŒ–ç±»å‹ï¼Œå¹¶ä¸”æ¯ä¸ª<code>dout</code>/<code>rsd</code>è¡¨ç¤ºæ¯ä¸€ä¸ªtokenæˆ–batchæ¯ä¸€è¡Œçš„æ•°æ®éƒ½èƒ½è¢«è½¬æ¢ä¸ºVec_tç±»å‹çš„æŒ‡é’ˆ</p><p>ä¸€èˆ¬å®ç°(fp32)å’Œç‰¹åŒ–å®ç°(ä¸“ç»™fp16ä½¿ç”¨)çš„åŒºåˆ«</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">for(int i = tid; i &lt; hidden_units/vec_size; i+=blockDim.x){    dout[i].x += rsd[i].x; // doutæ—¢æ˜¯è¾“å…¥ä¹Ÿæ˜¯è¾“å‡º      dout[i].y += rsd[i].y;      dout[i].z += rsd[i].z;      dout[i].w += rsd[i].w;  }for(int i = tid; i &lt; hidden_units/vec_size; i+=blockDim.x){    dout[i] = __hadd2(dout[i], rsd[i]); // ä¸¤ä¸ªhalf2åšåŠ æ³•  }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>for</code>å¾ªç¯ä¿è¯ä¸€ä¸ªblockçš„çº¿ç¨‹èƒ½å¤Ÿéå†å®Œ<code>hidden_units</code>çš„å…ƒç´ </p><p><code>tests/uinttests/test_residual.cu</code><br>åœ¨<code>CPUresidual</code>ä¸­ï¼Œå¯ä»¥é€šè¿‡AVX-512 kernel + openMPè¿›è¡Œæ€§èƒ½æ”¹å–„</p><ul><li><code>AVX-512</code>(Advanced Vector Extensions 512)<ul><li>SIMD</li><li>æ”¯æŒ512ä½å®½çš„å¯„å­˜å™¨å’ŒçŸ¢é‡æ“ä½œ<ul><li>æ¯æ¬¡å¤„ç†å¯ä»¥åŠ è½½16ä¸ªæµ®ç‚¹æ•°</li></ul></li></ul></li><li><code>OpenMP</code>(Open Multi-Processing)<ul><li>å¤šçº¿ç¨‹å¹¶è¡Œç¼–ç¨‹æ¥å£ï¼Œç”¨äºåœ¨å…±äº«å†…å­˜ç¯å¢ƒä¸­é€šè¿‡ä»»åŠ¡åˆ’åˆ†å’Œçº¿ç¨‹æ§åˆ¶å®ç°å¹¶è¡ŒåŠ é€Ÿ</li></ul></li></ul><h1 id="Lesson25-Context-Decoder"><a href="#Lesson25-Context-Decoder" class="headerlink" title="Lesson25 Context Decoder"></a>Lesson25 Context Decoder</h1><p><code>src/layers/decoder</code></p><p><code>Input embedding</code> -&gt; <code>RMSNorm</code> -&gt; <code>Context Attention</code> -&gt; <code>FusedAddbiasResidualAndRMSNorm</code>(å‡¡æ˜¯æ®‹å·®åŠ ï¼Œæ®‹å·®æ¥è‡ªä¸Šä¸€ä¸ª<code>RMSNorm</code>çš„è¾“å…¥) -&gt; <code>FFN</code> -&gt; <code>AddbiasResidual</code></p><p>å››ä¸ªä¸­é—´bufferï¼š</p><ul><li><code>decoder_residual</code>ï¼š(ä¸åŒæ—¶)å­˜å‚¨(ä¸¤ä¸ªåœ°æ–¹çš„)æ®‹å·®</li><li><code>attention_mask</code>ï¼šä¿å­˜ç”Ÿæˆçš„<code>CausalMask</code></li><li><code>padding_offset</code></li><li><code>cum_seqlens</code>ï¼šç´¯ç§¯å¥å­é•¿åº¦ï¼Œå’Œ<code>padding_offset</code>çš„ç”Ÿå‘½å‘¨æœŸä¸€æ ·</li></ul><p><code>src/layers/decoder/context_decoder.cpp</code><br><code>LlamaContextDecoder&lt;T&gt;::forward</code></p><ul><li>å…¥å‚ï¼š<ul><li><code>TensorMap&amp; input_tensors</code></li><li>`const std::vector&lt;LlamaLayerWeight<t>*&gt;&amp; layerWeights</t></li><li><code>TensorMap&amp; output_tensors</code></li><li><code>LLaMAAttentionDynParams&amp; dyn_params</code><br>â‘ å†…å­˜åˆ†é…ï¼šå¯¼å…¥åŠ¨æ€å˜é‡å¹¶åˆ†é…å››ä¸ªä¸­é—´bufferçš„å†…å­˜<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">allocForForward(dyn_params);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>â‘¡è·å¾—åç§»<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">Tensor* seq_lens = input_tensors["input_length"];  launchCalPaddingoffset(padding_offset, cum_seqlens, seq_lens-&gt;as&lt;int&gt;());<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ul></li><li>å…¥å‚ï¼š<ul><li><code>TensorWrapper&lt;int&gt;* padding_offset</code></li><li><code>TensorWrapper&lt;int&gt;* cum_seqlens</code>ï¼Œç´¯ç§¯çš„å¥å­é•¿åº¦ï¼Œæ˜¯æ‰€æœ‰batchçš„ç´¯ç§¯</li><li><code>TensorWrapper&lt;int&gt;* input_lengths</code>ï¼Œæ¯ä¸ªå¥å­çš„è¾“å…¥é•¿åº¦<br>â‘¢è·å–æ©ç é•¿åº¦<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">Tensor* context_length = input_tensors["context_length"];  launchBuildCausalMasks(attention_mask, seq_lens-&gt;as&lt;int&gt;(), context_length-&gt;as&lt;int&gt;());<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ul></li><li>å…¥å‚ï¼š<ul><li><code>TensorWrapper&lt;T&gt;* mask</code></li><li><code>TensorWrapper&lt;int&gt;* q_lens</code>ï¼Œæ¯ä¸ªå¥å­çš„è¾“å…¥é•¿åº¦</li><li><code>TensorWrapper&lt;int&gt;* k_lens</code>ï¼Œæ¯ä¸ªå¥å­çš„ä¸Šä¸‹æ–‡é•¿åº¦<br>â‘£æ­å»º32å±‚context decoder layerå¹¶è¿›è¡Œcontext attention<br>ä¸ºå•¥ï¼šæœâ€œç–‘é—®â€<br>1)ä»å‡½æ•°è¾“å…¥çš„<code>input_tensors</code>å’Œ<code>output_tensors</code>è·å¾—ç›¸åº”é”®å€¼å¯¹å¹¶å–åœ°å€ï¼Œæ£€æŸ¥æ˜¯å¦ä¸ºç©º<br>2)åˆå§‹åŒ–<code>ctx_attn_inputs</code>å’Œ<code>ctx_attn_outpus</code>é”®å€¼å¯¹ï¼Œè¿™é‡ŒæŒ‡çš„æ˜¯æ¯ä¸€å±‚çš„è¾“å…¥å’Œè¾“å‡º<br>3)è¿›è¡Œ32å±‚Layerçš„context attention</li></ul></li><li>ä»forå¾ªç¯çš„å˜é‡è·å–<code>layer_id</code>å¹¶æ›´æ–°åˆ°<code>ctx_attn_inputs[layer_id]</code>ä¸­</li><li>è·å–context attntionçš„è¾“å…¥</li><li>è¿›è¡Œcontext attentionï¼Œè¾“å‡ºä¸º<code>ctx_attn_outputs</code></li><li>è¿›è¡ŒFusedAddBiasResidualRMSNormï¼Œè¾“å‡ºä¸º<code>decoder_output</code>(ctx_attn_outputs[â€œattention_outputâ€]çš„æŒ‡é’ˆ)</li><li>è¿›è¡Œffnï¼Œè¾“å…¥ä¸º<code>decoder_output</code>ï¼Œè¾“å‡ºç›´æ¥å¤ç”¨è¾“å…¥çš„å†…å­˜åŒº</li><li>è¿›è¡ŒAddResidualï¼Œè¯¥kernelåœ¨å®ç°æ—¶ï¼Œæ®‹å·®åŠ çš„ç»“æœæ”¾åœ¨decoder_outä¸Š</li><li>æŠŠå½“å‰Layerçš„è¾“å‡ºä½œä¸ºä¸‹ä¸€å±‚Layerçš„è¾“å…¥ï¼Œç›´æ¥ç”¨å½“å‰Layerçš„è¾“å‡º<code>decoder_output</code>æ›´æ–°åˆ°keyä¸ºâ€attention_inputâ€çš„valueä¸­</li></ul><h1 id="Lesson26-Self-Decoder"><a href="#Lesson26-Self-Decoder" class="headerlink" title="Lesson26 Self Decoder"></a>Lesson26 Self Decoder</h1><p>å¾…è§£å†³ï¼šllama2æ˜¯ä¸åŒ…å«ç¬¬ä¸€ä¸ªaddbiasçš„ï¼Œæ‰€ä»¥åªå‰©ä¸‹RoPEï¼Œå› ä¸ºæ—‹è½¬ç¼–ç çš„æ—‹è½¬å¤§å°æ˜¯64ï¼Œæ‰€ä»¥ä¸èƒ½èåˆåˆ°Fused Masked self Attetioné‡Œï¼Œå¦‚æœæ˜¯2å°±å¯ä»¥</p><ul><li>RoPEæ²¡æœ‰å‡ºç°ï¼<ul><li>æœ‰çš„ï¼Œæ˜¯åœ¨Fused Masked self Attentioné‡Œ</li></ul></li></ul><p>é™¤äº†ä¸€äº›ä¸éœ€è¦çš„å˜é‡ï¼Œæ­¥éª¤æ–¹æ³•å’Œcontext decoderçš„æ­å»ºå·®ä¸å¤š</p><h1 id="Lesson27-llama-weights"><a href="#Lesson27-llama-weights" class="headerlink" title="Lesson27 llama weights"></a>Lesson27 llama weights</h1><p><code>tools/convert_downloaded_llama_weights.py</code><br><code>tools/weights_conver.py</code></p><ul><li>åœ¨pythonä¸­<ul><li>ä¸‹è½½æ¨¡å‹</li><li>è½¬æ¢<ul><li>å°†åŸæœ¬çš„.pthå½¢å¼çš„æƒé‡ï¼Œå¯¹åº”è¾“å‡ºåˆ°æ¯ä¸€å±‚çš„æ¯ä¸€ä¸ªç±»å‹çš„(qkvgemm, gate, down, upç­‰ç­‰çš„)æƒé‡</li><li>åˆå¹¶qkvçš„æƒé‡ï¼Œåˆå¹¶gateå’Œupçš„æƒé‡ï¼ŒæŠŠæ‰€æœ‰æƒé‡æ–‡ä»¶è½¬ä¸º.binæ ¼å¼çš„ï¼Œå³è½¬ä¸ºäºŒè¿›åˆ¶</li></ul></li></ul></li></ul><p><code>src/weights/llama/llama_weights.cc</code><br><code>src/weights/llama/llama_weights.h</code></p><ul><li>è¯»å–ä»pythonæ–‡ä»¶ä¸­å¾—åˆ°çš„æƒé‡ï¼Œå¹¶èµ‹å€¼ç»™å·²åˆ†é…å¥½æ˜¾å­˜çš„æŒ‡é’ˆ</li><li>å››ä¸ªpublicæˆå‘˜(llama weights)<ul><li><code>llama_layer_weight</code>ï¼Œæœ‰<code>num_layer</code>å±‚</li><li><code>out_rmsnorm_weight</code></li><li><code>post_decoder_embedding_weight</code> (samplingçš„LMhead)</li><li><code>pre_decoder_embedding_weight</code></li></ul></li></ul><p><code>src/utils/weights_utils.cc</code><br><code>src/utils/weights_utils.h</code></p><ul><li>å½“pyhtonè½¬æ¢å®Œçš„æƒé‡æ ¼å¼ä¸ç›®æ ‡æ ¼å¼ä¸ä¸€è‡´æ—¶ï¼Œå¦‚halfå’Œfloatï¼Œåˆ™è¿›è¡Œè½¬æ¢å†åŠ è½½äºŒè¿›åˆ¶æ–‡ä»¶</li></ul><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">llama_layer_weight.reserve(num_layer);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>vector.push_backå’Œvector.reserveçš„åŒºåˆ«<ul><li>push_backï¼Œ2-&gt;4-&gt;6-&gt;8-&gt;16-&gt;32-&gt;â€¦ï¼Œå½“å‘é‡ä¸­æœ‰2ä¸ªå…ƒç´ ï¼Œpush_backåˆ°3ä¸ªå…ƒç´ æ—¶ï¼Œvectoråœ°å€è‡ªåŠ¨é‡æ–°åˆ†é…å¹¶ä¸”å®¹é‡å˜ä¸º4ï¼Œåç»­çš„å¢åŠ åŒç†</li><li>reserveï¼ŒæŒ‡å®šå®¹é‡ï¼Œä¸ä¼šè‡ªåŠ¨é‡æ–°åˆ†é…</li></ul></li></ul><h1 id="Lesson28-llamaç±»"><a href="#Lesson28-llamaç±»" class="headerlink" title="Lesson28 llamaç±»"></a>Lesson28 llamaç±»</h1><p>æ›´é«˜å±‚æ¬¡çš„æŠ½è±¡</p><p><code>std::function&lt;è¿”å›å€¼ç±»å‹(å‚æ•°åˆ—è¡¨)&gt;</code>å®šä¹‰äº†ä¸€ä¸ªå¯è°ƒç”¨å¯¹è±¡çš„ç­¾å</p><ul><li>å¯è°ƒç”¨å¯¹è±¡çš„ç­¾ååŒ…æ‹¬è¿”å›å€¼ç±»å‹å’Œå‚æ•°åˆ—è¡¨<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/LLM2%E6%8E%A8%E7%90%86%E5%BC%95%E6%93%8E/Pasted%20image%2020250115113416.png"></li></ul><p><code>src/models/llama/llama.cpp</code><br><code>src/models/llama/llama.h</code></p><p><code>std::string Llama&lt;T&gt;::Response(const std::vector&lt;std::string&gt; &amp;input, CallBack PrintRes)</code></p><ul><li>å…¥å‚<ul><li><code>input</code>ï¼šç”¨æˆ·è¾“å…¥çš„ç±»å‹ä¸ºå­—ç¬¦ä¸²å‘é‡çš„å¥å­</li><li><code>PrintRes</code>ï¼šæ‰“å°ç»“æœ</li></ul></li><li><code>Encode</code><ul><li><code>input</code>ã€<code>history_str</code>ã€<code>total_str</code></li><li>ä¸Šé¢è¿™ä¸‰ä¸ªå’Œ<code>MakeInput</code>å‡½æ•°æœ‰å…³</li><li><code>MakeInput</code>ä¸­çš„<code>ret</code>å°±æ˜¯<code>Response</code>ä¸­çš„<code>input</code><ul><li><code>total_str</code>æ˜¯æ‰€æœ‰è½®æ¬¡çš„inputï¼ŒåŒ…æ‹¬ç°åœ¨å’Œä¹‹å‰çš„</li><li><code>history_str</code>æ˜¯ä¹‹å‰è½®æ¬¡çš„input</li><li><code>input</code>æ˜¯ç°åœ¨è½®æ¬¡çš„input</li></ul></li><li>å¾—åˆ°ä¸‰è€…çš„token indexs</li><li>è¿™ä¸‰è€…çš„é•¿åº¦æ˜¯<code>int_params_first_token</code>å­—å…¸ä¸­çš„å€¼</li></ul></li><li><code>attn_dyn_params</code> llamaç±»æ¨¡å‹é‡ŒåŠ¨æ€æ”¹å˜çš„å˜é‡<ul><li><code>batch_size</code>ï¼šç¡¬å†™ä¸º1</li><li><code>num_tokens</code>ï¼šå½“å‰è¾“å…¥çš„é•¿åº¦</li><li><code>max_q_len</code>ï¼šbatchä¸­qçš„æœ€å¤§é•¿åº¦ï¼Œå› ä¸ºä¸€ä¸ªbatchåªæœ‰ä¸€ä¸ªå¥å­ï¼Œæ‰€ä»¥ç­‰äºnum_tokens</li><li><code>max_k_len</code>ï¼šåŠ¨æ€æœ€å¤§ä¸Šä¸‹æ–‡ï¼Œ<code>step</code>çš„å€¼ä¸å…¶ç›¸åŒ(åœ¨self decoderä¸­ç”¨åˆ°)</li></ul></li><li>è·å¾—æ‰€æœ‰è½®æ¬¡çš„token string<ul><li>è‡ªå®šä¹‰<code>self_token_limit</code></li><li><code>firstTokenGen</code><ul><li>å…¥å‚ï¼š<code>attn_dyn_params</code>ã€<code>int_params_first_token</code></li><li><code>InitializeForContextDecoder</code><ul><li>ä¼ å…¥æ‰€æœ‰è½®æ¬¡ã€ä¹‹å‰è½®æ¬¡å’Œç°åœ¨è½®æ¬¡åˆ°CPUä¸­ï¼Œå†å¤åˆ¶åˆ°GPUä¸­</li></ul></li><li><code>inputEmbedding</code><ul><li>å¾—åˆ°è¾“å…¥çš„å¥å­å¯¹åº”çš„tokenåœ¨embed tableé‡Œçš„è¯å‘é‡</li></ul></li><li>åŒ…è£…<code>decoder_inputs</code>å’Œ<code>decoder_outputs</code>è¿™ä¸¤ä¸ªTensorMap</li><li>è¿›è¡Œæ¨ç†</li><li>è¿›è¡ŒRMSNorm</li><li>è¿›è¡ŒLMHeadå’ŒtopkSample<ul><li>LMHead<ul><li>å¦‚æœæ˜¯context decoder<ul><li>å–è¾“å‡ºé‡Œçš„æœ€åä¸€ä¸ªtokenä½œä¸ºLMHeadçš„è¾“å…¥ï¼Œç»è¿‡çŸ©é˜µç›¸ä¹˜å¾—åˆ°<code>probs</code>ç»´åº¦ä¸ºï¼š<code>[1, vocab_size]</code>ï¼Œå°±çŸ¥é“è¿™å‡ ä¸ªvocabçš„å¯èƒ½æ€§</li></ul></li><li>å¦‚æœæ˜¯self decoder<ul><li><code>decoder_output</code>å°±æ˜¯å”¯ä¸€çš„tokenï¼Œç›´æ¥ä½œä¸ºLMHeadçš„è¾“å…¥</li></ul></li></ul></li><li>topkSample<ul><li></li></ul></li></ul></li></ul></li><li><code>continueTokenGen</code></li></ul></li></ul><h1 id="Lesson29"><a href="#Lesson29" class="headerlink" title="Lesson29"></a>Lesson29</h1><p>æä¾›æ¥å—ç”¨æˆ·è¾“å…¥æˆ–è€…promtçš„æ¥å£<br>å®ç°å¤§å°è£…çš„APIï¼Œåˆ›å»ºC++ç±»</p><p><code>std::unique_ptr</code></p><ul><li>ç‹¬å æ‰€æœ‰æƒï¼Œä¸èƒ½è¢«å…±äº«</li><li>è‡ªåŠ¨é‡Šæ”¾å†…å­˜</li><li>ä¸å¯ä»¥è¢«å¤åˆ¶ï¼Œæ‰€æœ‰æƒå¯ä»¥è½¬è®©ï¼Œè½¬è®©ååŸæ¥çš„å˜ä¸ºç©ºæŒ‡é’ˆ</li></ul><p><code>LLMengine-learn/user_entry.cpp</code></p><ul><li>ä¼ å…¥æ¨¡å‹å’Œtokenizerçš„åœ°å€ï¼Œç›´æ¥è°ƒç”¨Response</li></ul><h1 id="debugæ€è·¯"><a href="#debugæ€è·¯" class="headerlink" title="debugæ€è·¯"></a>debugæ€è·¯</h1><ol><li>æ‰“å°/ä¿å­˜ä¸­é—´æ•°æ®ï¼šå°†è¾“å‡ºå­˜ä¸ºä¸€ä¸ª.binæ–‡ä»¶ï¼Œå†ä½¿ç”¨<code>std::ifstream</code>è¯»å–ï¼Œå¯ä»¥é€ä¸€æ¯”è¾ƒ(ä¸huggingfaceçš„)ç»“æœ</li></ol><ul><li>fp32ä¸¤ä¸ªç»“æœçš„è¯¯å·®å¤§äº$10^{-6}$å°±è¯´æ˜æœ‰è¯¯å·®</li></ul><ol start="2"><li><code>DeviceSynAndCheckCudaError</code></li></ol><ul><li>æ£€æŸ¥æœ‰æ²¡æœ‰è¿è¡Œæ—¶é”™è¯¯</li><li>æœ‰<code>cudaDeviceSynchronize()</code>ï¼šCPUç­‰å¾…GPUä¸Šæ‰€æœ‰ä»»åŠ¡å®Œæˆï¼Œå› æ­¤æœ€å¥½åœ¨ç¡®ä¿é¡¹ç›®æ²¡æœ‰é—®é¢˜æ—¶å…³æ‰</li></ul><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">// CMakeList.txtä¸­option(PERF  "measure the model inference performance"  OFF)if(PERF)add_compile_option(-DPRINT_DATA)endif()// context_attention.cppä¸­#ifndef PERFDeviceSynAndCheckCudaError();#else#endif<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>CMakeé€‰é¡¹å®šä¹‰ï¼š<code>option(é€‰é¡¹åç§° â€œé€‰é¡¹æè¿°â€ é»˜è®¤å€¼)</code></li><li>å¦‚æœ<code>PERF</code>æ˜¯ONï¼Œé‚£ä¹ˆåœ¨ç¼–è¯‘é€‰é¡¹ä¸­æ·»åŠ <code>-DPRINT_DATA</code>ï¼Œå³åœ¨ç¼–è¯‘æ—¶æ·»åŠ ä¸€ä¸ªå®<code>PRINT_DATA</code></li><li><code>cmake .. -DPERF=ON</code>æ—¶æ‰“å¼€ä¸è¿›è¡ŒCheck(å³ä¸æ‰“å¼€â€œæ£€æŸ¥è¿è¡Œæ—¶é”™è¯¯â€œ)</li></ul><ol start="3"><li>PRINT_DATA</li></ol><ul><li>é€šå¸¸åœ¨é¦–å…ˆè¾“å…¥çš„kernelé‡Œéœ€è¦ï¼Œæ£€æŸ¥æ”¾åœ¨lanuché‡Œ</li></ul><h1 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h1><ol><li>emmé…å®Œannacondaä¹‹åå†…å­˜å¿«ç‚¸äº†ï¼ŒæŸ¥çœ‹ä»»åŠ¡ç®¡ç†å™¨å‘ç°æ˜¯vmmemçš„é—®é¢˜ï¼Œæ˜¯è™šæ‹Ÿæœºèµ„æºåˆ†é…çš„é—®é¢˜ï¼Œè¿™ä¸ªé—®é¢˜ä¸Šç½‘æŸ¥è§£å†³æ–¹æ³•ï¼Œä¸å¤æ‚</li></ol><ul><li><code>win+R</code>ï¼Œè¾“å…¥<code>%UserProfile%</code></li><li>å¦‚æœæ²¡æœ‰<code>.wslconfig</code>ç»“å°¾çš„æ–‡ä»¶ï¼Œå¯ä»¥æ–°å»ºä¸€ä¸ªï¼Œå¯ä»¥å«<code>Vmmem.wslconfig</code></li><li>æ·»åŠ ä»¥ä¸‹å†…å®¹<pre class="line-numbers language-none"><code class="language-none">#.wslconfig[wsl2]memory=3GB //åˆ†é…ç»™WSLå†…å­˜ï¼Œå¯ä»¥æ˜¯å†…å­˜çš„1/3æˆ–1/4swap=0     //è®¾ç½®äº¤æ¢åˆ†åŒºlocalhostForwarding=true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>é‡å¯WSLï¼š<code>win+R</code>ï¼Œè¾“å…¥<code>services.msc</code>ï¼Œæ‰¾åˆ°<code>LxssManager</code>ï¼Œé‡æ–°å¯åŠ¨</li></ul><ol start="2"><li>è¿™ä¸ªvmmemå¥½åƒæ˜¯ä¸ªç¡¬éª¨å¤´å•Šï¼<br><a href="https://zhuanlan.zhihu.com/p/166102340">wslå¯¼è‡´vmmemå ç”¨é«˜è§£å†³åŠæ³• - çŸ¥ä¹</a><br>(ğŸ‘†æ–‡ä¸­å€Ÿé‰´<a href="https://github.com/microsoft/WSL/issues/4166">WSL 2 consumes massive amounts of RAM and doesnâ€™t return it - github.com</a>)<br>æŒ‰ç…§è¿™ä¸ªæ–¹æ³•åšåˆ°æœ€åä¸€æ­¥å‘ç°ğŸ‘‡<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/LLM2%E6%8E%A8%E7%90%86%E5%BC%95%E6%93%8E/Pasted%20image%2020241011223651.png" alt="|500"><br>ç„¶åå°±æ‰¾åˆ°äº†è¿™ä¸ªæ–¹æ³•ğŸ‘‡<br><a href="https://bbs.csdn.net/topics/396240104">drop_cashesæ— æ³•æ“ä½œ no such file or directory-CSDNç¤¾åŒº</a></li></ol><ul><li>å…ˆ<code>sudo su</code>è¿›å…¥root</li><li>è¾“å…¥<code>echo 3 &gt; /proc/sys/vm/drop_caches</code></li><li>ç„¶åå†å›å»<code>sudo stat -c '%y' /root/drop_caches_last_run</code>å°±èƒ½çœ‹åˆ°æ¸…é™¤ç¼“å­˜çš„è®°å½•äº†</li></ul><ol start="3"><li>vscodeç–¯ç‹‚çˆ†çº¢ï¼Œè½¬clionå»äº†</li></ol><h2 id="è½¯ä»¶æŠ½è±¡èµ„æºå’Œç¡¬ä»¶èµ„æºçš„å¯¹åº”å…³ç³»"><a href="#è½¯ä»¶æŠ½è±¡èµ„æºå’Œç¡¬ä»¶èµ„æºçš„å¯¹åº”å…³ç³»" class="headerlink" title="è½¯ä»¶æŠ½è±¡èµ„æºå’Œç¡¬ä»¶èµ„æºçš„å¯¹åº”å…³ç³»"></a>è½¯ä»¶æŠ½è±¡èµ„æºå’Œç¡¬ä»¶èµ„æºçš„å¯¹åº”å…³ç³»</h2><p><a href="https://blog.csdn.net/qq_41554005/article/details/119765334">ã€GPUç»“æ„ä¸CUDAç³»åˆ—4ã€‘GPUå­˜å‚¨èµ„æºï¼šå¯„å­˜å™¨ï¼Œæœ¬åœ°å†…å­˜ï¼Œå…±äº«å†…å­˜ï¼Œç¼“å­˜ï¼Œæ˜¾å­˜ç­‰å­˜å‚¨å™¨ç»†èŠ‚_gpuå†…å¯„å­˜å™¨ - CSDN</a></p><h2 id="å¦‚ä½•é«˜æ•ˆè®¿é—®gpuå…¨å±€å†…å­˜"><a href="#å¦‚ä½•é«˜æ•ˆè®¿é—®gpuå…¨å±€å†…å­˜" class="headerlink" title="å¦‚ä½•é«˜æ•ˆè®¿é—®gpuå…¨å±€å†…å­˜"></a>å¦‚ä½•é«˜æ•ˆè®¿é—®gpuå…¨å±€å†…å­˜</h2><p>(è§£ç­”<em>ä¸ºä»€ä¹ˆvæ˜¯æŒ‰è¡Œè¿ç»­åˆ†å¸ƒå’Œä¸ºä»€ä¹ˆè¦é‚£æ ·è®¡ç®—qkvgemm</em>)</p><ul><li><p>è¶Šé è¿‘CPUæ’åºï¼šå¯„å­˜å™¨Register &gt; ç¼“å­˜Cache &gt; å†…å­˜Memory &gt; ç¡¬ç›˜</p></li><li><p>â€œCå’ŒCUDAä¸­çš„å¤šç»´æ•°ç»„å…ƒç´ æ˜¯æ ¹æ®<strong>è¡Œä¼˜å…ˆ</strong>çº¦å®šæ”¾ç½®åœ¨çº¿æ€§å¯»å€çš„å†…å­˜ç©ºé—´ä¸­çš„â€</p><ul><li>éæŒ‰è¡Œæ’åˆ—ï¼š<strong>cublas API</strong>æ¥å—çš„è¾“å…¥ä»¥åŠè¾“å‡ºçš„å†…å­˜æ’å¸ƒå…¨éƒ¨éƒ½é»˜è®¤ä¸º<strong>åˆ—ä¸»åº</strong></li></ul></li><li><p>â€œå½“çº¿ç¨‹è®¿é—®çŸ©é˜µæ•°æ®æ—¶ï¼Œå¦‚æœ<strong>æ•°æ®æ’åˆ—çš„é¡ºåºä¸çº¿ç¨‹è®¿é—®é¡ºåºåŒ¹é…</strong>ï¼Œå†…å­˜å¸¦å®½çš„åˆ©ç”¨ç‡ä¼šæ›´é«˜â€ã€‚è¿™é‡Œåº”è¯¥å’Œwarpæœ‰å…³</p><ul><li>Fused SelfDecoder Attention kernelä¸­ï¼Œ<code>block</code>çš„å¤§å°æ˜¯<code>head_size</code>ï¼Œ<code>grid</code>çš„å¤§å°æ˜¯<code>head_num*batch_size</code><br>ğŸ‘‡æ ¹æ®çº¿ç¨‹è®¿é—®é¡ºåºåŒ¹é…(ä»blockIdxåˆ°threadIdxï¼ŒthreadIdxçš„è·¨åº¦æ˜¯é¡ºåºçš„)<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">cache_offset = blockIdx.y * kv_head_num * max_seq_len * head_size +blockIdx.x/(head_num/kv_head_num)*max_seq_len*head_size+threadIdx.x * vec_size;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/LLM2%E6%8E%A8%E7%90%86%E5%BC%95%E6%93%8E/c22b854c31b08ae192c8e310cb4a8fa%201.jpg"><br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/LLM2%E6%8E%A8%E7%90%86%E5%BC%95%E6%93%8E/8ea8ba5aa4aa7e6763e069de3b29f14.jpg"></li></ul></li><li><p>ä¸€æ¬¡æ•°æ®ä¼ è¾“çš„æ•°æ®é‡é»˜è®¤æƒ…å†µä¸‹æ˜¯32ä¸ªå­—èŠ‚</p></li><li><p>$åˆå¹¶åº¦=\dfrac{çº¿ç¨‹æŸè¯·æ±‚çš„å­—èŠ‚æ•°}{ç”±è¯¥è¯·æ±‚å¯¼è‡´çš„æ‰€æœ‰æ•°æ®ä¼ è¾“å¤„ç†çš„å­—èŠ‚æ•°}$</p></li><li><p>æ•°æ®ä¼ è¾“å¯¹æ•°æ®åœ°å€çš„è¦æ±‚ï¼šåœ¨ä¸€æ¬¡æ•°æ®ä¼ è¾“ä¸­ï¼Œä»å…¨å±€å†…å­˜è½¬ç§»åˆ°L2ç¼“å­˜çš„ä¸€ç‰‡å†…å­˜é¦–åœ°å€ä¸€å®šæ˜¯ä¸€ä¸ªæœ€å°é¢—ç²’åº¦(è¯¥ä¾‹å­æ˜¯32)çš„æ•´æ•°å€ã€‚</p><ul><li>ä¸€æ¬¡ä¼ è¾“åªå–0<del>31ã€32</del>63ã€64~95â€¦â€¦<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/LLM2%E6%8E%A8%E7%90%86%E5%BC%95%E6%93%8E/808198b24f332fb853b67f74add48cd.jpg"><br>ğŸ‘‡å·¦è¡Œå³åˆ—å¯¼è‡´è·¨è¶Šå¼çš„éåˆå¹¶è®¿é—®<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/LLM2%E6%8E%A8%E7%90%86%E5%BC%95%E6%93%8E/7b1158679c6058fdd34cdd461ad7d17.jpg"></li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> é«˜æ€§èƒ½è®¡ç®— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CUDA </tag>
            
            <tag> LLM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CUDAç¼–ç¨‹ï¼šåŸºç¡€ä¸å®è·µå­¦ä¹ ç¬”è®°</title>
      <link href="/2024/08/02/cudac/"/>
      <url>/2024/08/02/cudac/</url>
      
        <content type="html"><![CDATA[<h1 id="ç¬¬äºŒç« -CUDAä¸­çš„çº¿ç¨‹ç»„ç»‡"><a href="#ç¬¬äºŒç« -CUDAä¸­çš„çº¿ç¨‹ç»„ç»‡" class="headerlink" title="ç¬¬äºŒç«  CUDAä¸­çš„çº¿ç¨‹ç»„ç»‡"></a>ç¬¬äºŒç«  CUDAä¸­çš„çº¿ç¨‹ç»„ç»‡</h1><p><code>cudaDeviceSynchronize();</code>ï¼šåŒæ­¥ä¸»æœºå’Œè®¾å¤‡ï¼Œ(å› ä¸ºè°ƒç”¨è¾“å‡ºå‡½æ•°æ—¶ï¼Œè¾“å‡ºæµå…ˆæ”¾åœ¨ç¼“å†²åŒºï¼Œä½†æ˜¯ç¼“å†²åŒºä¸ä¼šè‡ªåŠ¨åˆ·æ–°ï¼Œåªæœ‰é‡åˆ°æŸç§åŒæ­¥æ“ä½œæ—¶æ‰ä¼šåˆ·æ–°)ï¼Œå¦‚æœæ²¡æœ‰è¿™å¥è¯æ˜¯ä¸ä¼šæ‰§è¡Œæ ¸å‡½æ•°çš„å†…å®¹</p><p><code>dim3</code>å’Œ<code>unit3</code>çš„åŒºåˆ«</p><ul><li><code>unit3</code>ï¼šæ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œå…·æœ‰<code>x</code>ã€<code>y</code>ã€<code>z</code>ä¸‰ä¸ªæˆå‘˜ã€‚é€‚ç”¨<code>blockIdx</code>å’Œ<code>threadIdx</code></li><li><code>dim3</code>ï¼šæ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œå’Œ<code>unit3</code>ç±»ä¼¼ï¼Œé€‚ç”¨<code>blockDim</code>å’Œ<code>gridDim</code></li><li>äºŒè€…å…³ç³»ï¼ŒxxxIdx.açš„å–å€¼èŒƒå›´æ˜¯yyyDim.a-1ï¼Œå¦‚ï¼š<code>blockIdx.x</code>çš„å–å€¼èŒƒå›´æ˜¯<code>gridDim.x-1</code></li></ul><h1 id="ç¬¬ä¸‰ç« -ç®€å•CUDAç¨‹åºçš„åŸºæœ¬æ¡†æ¶"><a href="#ç¬¬ä¸‰ç« -ç®€å•CUDAç¨‹åºçš„åŸºæœ¬æ¡†æ¶" class="headerlink" title="ç¬¬ä¸‰ç«  ç®€å•CUDAç¨‹åºçš„åŸºæœ¬æ¡†æ¶"></a>ç¬¬ä¸‰ç«  ç®€å•CUDAç¨‹åºçš„åŸºæœ¬æ¡†æ¶</h1><h3 id="3-2-2-è®¾å¤‡å†…å­˜çš„é‡Šæ”¾ä¸åˆ†é…"><a href="#3-2-2-è®¾å¤‡å†…å­˜çš„é‡Šæ”¾ä¸åˆ†é…" class="headerlink" title="3.2.2 è®¾å¤‡å†…å­˜çš„é‡Šæ”¾ä¸åˆ†é…"></a>3.2.2 è®¾å¤‡å†…å­˜çš„é‡Šæ”¾ä¸åˆ†é…</h3><p><code>cudaMalloc()</code></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">cudaError_t</span> <span class="token function">cudaMalloc</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span>address<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li><code>address</code>ï¼šå¾…åˆ†é…è®¾å¤‡å†…å­˜çš„æŒ‡é’ˆã€‚å› ä¸ºå†…å­˜(åœ°å€)æœ¬èº«å°±æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œæ‰€ä»¥addressæ˜¯æŒ‡é’ˆçš„æŒ‡é’ˆ</li><li><code>size</code>ï¼šå¾…åˆ†é…å†…å­˜çš„å­—èŠ‚æ•°</li><li><code>cudaError_t</code>ï¼šä½œä¸ºè¿”å›å€¼ï¼Œå¦‚æœè°ƒç”¨æˆåŠŸåˆ™è¿”å›<code>cudaSuccess</code></li><li><code>(void **)</code>ï¼šå°†æŸä¸€ç§ç±»å‹çš„åŒé‡æŒ‡é’ˆå˜ä¸ºvoidç±»å‹çš„åŒé‡æŒ‡é’ˆ</li><li>åŠŸèƒ½æ˜¯æ”¹å˜æŒ‡é’ˆd_xæœ¬èº«çš„å€¼ï¼Œå³å°†ä¸€ä¸ªæŒ‡é’ˆèµ‹å€¼ç»™d_xï¼Œå› æ­¤è¦å–d_xçš„åœ°å€ï¼Œå³<code>&amp;d_x</code>ï¼ŒåŒæ—¶è¯¥å‡½æ•°ä¸æ˜¯è¿”å›ä¸€ä¸ªæŒ‡é’ˆ</li><li>é…åˆ<code>cudaFree()</code>å‡½æ•°ä½¿ç”¨</li></ul><h3 id="3-2-3-ä¸»æœºä¸è®¾å¤‡ä¹‹é—´æ•°æ®çš„ä¼ é€’"><a href="#3-2-3-ä¸»æœºä¸è®¾å¤‡ä¹‹é—´æ•°æ®çš„ä¼ é€’" class="headerlink" title="3.2.3 ä¸»æœºä¸è®¾å¤‡ä¹‹é—´æ•°æ®çš„ä¼ é€’"></a>3.2.3 ä¸»æœºä¸è®¾å¤‡ä¹‹é—´æ•°æ®çš„ä¼ é€’</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">cudaError_t</span> <span class="token function">cudaMemcpy</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>dst<span class="token punctuation">,</span>               <span class="token comment">// ç›®æ ‡åœ°å€</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>src<span class="token punctuation">,</span>         <span class="token comment">// æºåœ°å€</span><span class="token class-name">size_t</span> count<span class="token punctuation">,</span>            <span class="token comment">// å¤åˆ¶æ•°æ®çš„å­—èŠ‚æ•°</span><span class="token keyword">enum</span> <span class="token class-name">cudaMemcpyKind</span> kind <span class="token comment">// æ ‡å¿—æ•°æ®ä¼ é€’æ–¹å‘</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>cudaMemcpy + <code>Host</code>/<code>Device</code> + To + <code>Device</code>/<code>Host</code><br>æˆ–è€…<code>cudaMemcpyDefault</code></p><h3 id="3-2-4-æ ¸å‡½æ•°ä¸­æ•°æ®ä¸çº¿ç¨‹çš„å¯¹åº”"><a href="#3-2-4-æ ¸å‡½æ•°ä¸­æ•°æ®ä¸çº¿ç¨‹çš„å¯¹åº”" class="headerlink" title="3.2.4 æ ¸å‡½æ•°ä¸­æ•°æ®ä¸çº¿ç¨‹çš„å¯¹åº”"></a>3.2.4 æ ¸å‡½æ•°ä¸­æ•°æ®ä¸çº¿ç¨‹çš„å¯¹åº”</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> __global__ <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">*</span>x<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">*</span>y<span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token operator">*</span>z<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">const</span> <span class="token keyword">int</span> n <span class="token operator">=</span> blockDim<span class="token punctuation">.</span>x <span class="token operator">*</span> blockIdx<span class="token punctuation">.</span>x <span class="token operator">+</span> threadIdx<span class="token punctuation">.</span>x<span class="token punctuation">;</span>    z<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">+</span> y<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸»æœºä¸­çš„addå‡½æ•°éœ€è¦å¾ªç¯ï¼Œè®¾å¤‡ä¸­çš„ä¸éœ€è¦ï¼Œåªéœ€è¦æ•°ç»„å…ƒç´ æŒ‡æ ‡ä¸çº¿ç¨‹æŒ‡æ ‡ä¸€ä¸€å¯¹åº”å³å¯ï¼Œåœ¨3.3<code>add1.cu</code>ä¸­å°±ç”¨äº†<code>const int n = blockDim.x * blockIdx.x + blockIdx.x</code>æ¥å®ç°å¯¹åº”å…³ç³»(è€Œä¸»æœºä¸­çš„éœ€è¦ç”¨<code>for(int n=0; n&lt;N; n++)</code>)</p><h3 id="3-2-6-æ ¸å‡½æ•°ä¸­ifè¯­å¥çš„å¿…è¦æ€§"><a href="#3-2-6-æ ¸å‡½æ•°ä¸­ifè¯­å¥çš„å¿…è¦æ€§" class="headerlink" title="3.2.6 æ ¸å‡½æ•°ä¸­ifè¯­å¥çš„å¿…è¦æ€§"></a>3.2.6 æ ¸å‡½æ•°ä¸­ifè¯­å¥çš„å¿…è¦æ€§</h3><p><code>N</code>ä¸ºæ•°ç»„å…ƒç´ ï¼Œ$grid_size=\dfrac{N}{block_size}$ï¼Œå¦‚æœæœ‰ä½™æ•°éœ€è¦+1ï¼Œæ­¤æ—¶çº¿ç¨‹æ•°ä¸º<code>N+block_size</code>ï¼Œå› ä¸º<code>grid_size</code>æ¯åŠ ä¸€ï¼Œå°±å¤šä¸€ä¸ª<code>block</code>ï¼Œæ¯ä¸€ä¸ª<code>block</code>æœ‰<code>block_size</code>ä¸ªçº¿ç¨‹ï¼Œæ‰€ä»¥æ­¤æ—¶çº¿ç¨‹æ•°ä¸º<code>N+block_size</code></p><table><thead><tr><th></th><th>åŸæœ¬</th><th>åæ¥</th></tr></thead><tbody><tr><td>N</td><td>$10^8$</td><td>$10^8+1$</td></tr><tr><td>block_size</td><td>128</td><td>128</td></tr><tr><td>grid_size</td><td>$\dfrac{10^8}{128}=781250$</td><td>$\dfrac{10^8}{128}+1=781251$</td></tr><tr><td>å®é™…çš„çº¿ç¨‹æ•°$n=block_size*grid_size$</td><td>$10^8$</td><td>$10^8+128$</td></tr><tr><td>å› æ­¤éœ€è¦åŠ ä¸Š<code>if(n&gt;=N) return;</code>ï¼Œå¦‚æœä¸åŠ ä¸Šè¿™å¥ï¼Œä¼šå‡ºç°éæ³•çš„è®¾å¤‡å†…å­˜æ“ä½œ</td><td></td><td></td></tr></tbody></table><h1 id="ç¬¬å››ç« -CUDAç¨‹åºçš„é”™è¯¯æ£€éªŒ"><a href="#ç¬¬å››ç« -CUDAç¨‹åºçš„é”™è¯¯æ£€éªŒ" class="headerlink" title="ç¬¬å››ç«  CUDAç¨‹åºçš„é”™è¯¯æ£€éªŒ"></a>ç¬¬å››ç«  CUDAç¨‹åºçš„é”™è¯¯æ£€éªŒ</h1><ul><li>åœ¨å®šä¹‰å®æ—¶ï¼Œå¦‚æœä¸€è¡Œå†™ä¸ä¸‹ï¼Œåˆ™éœ€è¦åœ¨æœ«å°¾å†™â€\"ï¼Œè¡¨ç¤ºç»­è¡Œ</li><li>ç”¨è‡ªå®šä¹‰çš„å®å‡½æ•°<code>CHECK</code>æ£€æŸ¥è¿è¡Œæ—¶API<img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240829162039.png"></li><li>ç”¨ä»¥ä¸‹ä¸¤å¥æ£€æŸ¥æ ¸å‡½æ•°<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">CHECK</span><span class="token punctuation">(</span><span class="token function">cudaGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// æ•æ‰ç¬¬äºŒä¸ªè¯­å¥ä¹‹å‰çš„æœ€åä¸€ä¸ªé”™è¯¯</span><span class="token function">CHECK</span><span class="token punctuation">(</span><span class="token function">cudaDeviceSynchronize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ•æ‰æ˜¯å¦æœ‰æ— æ³•åŒæ­¥ä¸»æœºä¸è®¾å¤‡çš„é”™è¯¯ã€‚å› ä¸ºæ ¸å‡½æ•°çš„è°ƒç”¨æ˜¯å¼‚æ­¥çš„ï¼Œå³ä¸»æœºå‘å‡ºè°ƒç”¨æ ¸å‡½æ•°çš„å‘½ä»¤åä¼šæ‰§è¡Œåé¢çš„è¯­å¥ï¼Œä¸ä¼šç­‰å¾…æ ¸å‡½æ•°</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>åªè¦åœ¨æ ¸å‡½æ•°çš„è°ƒç”¨ä¹‹å è¿˜æœ‰å…¶ä»–ä»»ä½•èƒ½<strong>è¿”å›é”™è¯¯å€¼çš„APIå‡½æ•°</strong>è¿›è¡ŒåŒæ­¥è°ƒç”¨ï¼Œéƒ½èƒ½è§¦å‘ä¸»æœºä¸è®¾å¤‡çš„åŒæ­¥å¹¶æ•æ‰åˆ°æ ¸å‡½æ•°è°ƒç”¨ä¸­å¯èƒ½å‘ç”Ÿçš„é”™è¯¯ã€‚</li></ul><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¦‚æœéœ€è¦è·å¾—å‡†ç¡®çš„å‡ºé”™ä½ç½®ï¼Œéœ€è¦æ˜¾å¼åŒæ­¥ã€‚ä¾‹å¦‚è°ƒç”¨<code>cudaDeviceSynchronize()</code>å‡½æ•°ï¼Œæˆ–è€…è®¾ç½®</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">$ export CUDA_LAUNCH_BLOCKING<span class="token operator">=</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è®¾ç½®å®Œæ¯•åï¼Œæ‰€æœ‰æ ¸å‡½æ•°çš„è°ƒç”¨éƒ½æ˜¯åŒæ­¥çš„ï¼Œä½†æ˜¯æœ€å¥½åªç”¨äºè°ƒè¯•ç¨‹åºï¼Œå› ä¸ºè¿™æ ·ä¼šå½±å“ç¨‹åºçš„æ€§èƒ½ã€‚</p><p>â“è¿™ä¸ª<code>cuda-memcheck</code>æ²¡ç»™æˆ‘checkå‡ºæ¥é”™è¯¯<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240829164737.png"></p><h1 id="ç¬¬äº”ç« -è·å¾—GPUåŠ é€Ÿçš„å…³é”®"><a href="#ç¬¬äº”ç« -è·å¾—GPUåŠ é€Ÿçš„å…³é”®" class="headerlink" title="ç¬¬äº”ç«  è·å¾—GPUåŠ é€Ÿçš„å…³é”®"></a>ç¬¬äº”ç«  è·å¾—GPUåŠ é€Ÿçš„å…³é”®</h1><h3 id="5-1-1-ä¸ºC-ç¨‹åºè®¡æ—¶"><a href="#5-1-1-ä¸ºC-ç¨‹åºè®¡æ—¶" class="headerlink" title="5.1.1 ä¸ºC++ç¨‹åºè®¡æ—¶"></a>5.1.1 ä¸ºC++ç¨‹åºè®¡æ—¶</h3><p>é€‰æ‹©æµ®ç‚¹æ•°ç²¾åº¦</p><ul><li>å•ç²¾åº¦æµ®ç‚¹æ•°çš„è¿è¡Œæ—¶é—´ğŸ‘‡<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240829200351.png" alt="å•ç²¾åº¦æµ®ç‚¹æ•°"></li><li>åŒç²¾åº¦æµ®ç‚¹æ•°çš„è¿è¡Œæ—¶é—´ğŸ‘‡<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240829200445.png" alt="åŒç²¾åº¦æµ®ç‚¹æ•°"></li></ul><h3 id="5-1-2-ä¸ºCUDAç¨‹åºè®¡æ—¶"><a href="#5-1-2-ä¸ºCUDAç¨‹åºè®¡æ—¶" class="headerlink" title="5.1.2 ä¸ºCUDAç¨‹åºè®¡æ—¶"></a>5.1.2 ä¸ºCUDAç¨‹åºè®¡æ—¶</h3><ol><li>ä»…æ ¸å‡½æ•°</li></ol><ul><li>å•ç²¾åº¦ğŸ‘‡<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240829201703.png"></li><li>åŒç²¾åº¦ğŸ‘‡<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240829201718.png"></li></ul><ol start="2"><li>æ ¸å‡½æ•°ä¸æ•°æ®å¤åˆ¶</li></ol><ul><li>å•ç²¾åº¦ğŸ‘‡<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240829203507.png"></li><li>åŒç²¾åº¦ğŸ‘‡<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240829203524.png"><br>å¯¹æ¯”æ˜¯å¦åŠ å…¥äº†æ•°æ®å¤åˆ¶çš„ç”¨æ—¶ï¼Œå¯ä»¥å‘ç°ï¼š</li><li>æ ¸å‡½æ•°çš„è¿è¡Œæ—¶é—´æ¯”æ•°æ®å¤åˆ¶æ—¶é—´è¦çŸ­çš„å¤šï¼Œçº¦å 2.5%</li><li>å¦‚æœä¸€ä¸ªç¨‹åºçš„ä»»åŠ¡ä»…ä»…å°†æ¥è‡ªä¸»æœºç«¯çš„ä¸¤ä¸ªæ•°ç»„ç›¸åŠ ï¼Œå†å°†ç»“æœä¼ åˆ°ä¸»æœºç«¯ï¼Œä½¿ç”¨GPUçš„è¯æ•ˆç‡æ›´åŠ ä½ä¸‹ï¼Œ(CUDAç¨‹åºç›¸è¾ƒäºC++ç¨‹åºæ€§èƒ½é™ä½</li></ul><p>å…³äº<code>nvprof</code><br>æ˜¯ä¸€ä¸ªå¯ç”¨äºå¯¹CUDAç¨‹åºè¿›è¡Œæ›´å¤šæ€§èƒ½å‰–æçš„CUDAå·¥å…·ç®±é‡Œçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¦‚æœè®¾å¤‡è®¡ç®—èƒ½åŠ›å¤§äº8.0ä¸å¯ç”¨ï¼Œè¾“å…¥<code>nsys nvprof</code>å¯ç”¨<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240829205829.png"></p><ul><li>ç¬¬ä¸€åˆ—æ˜¯æ¯ç±»æ“ä½œ(ç¬¬ä¸ƒåˆ—Name)å ç”¨æ—¶é—´ç™¾åˆ†æ¯”</li><li>ç¬¬äºŒåˆ—æ—¶æ¯ç±»æ“ä½œæ‰€ç”¨çš„æ—¶é—´</li><li>ç¬¬ä¸‰åˆ—æ˜¯æ¯ç±»æ“ä½œè¢«è°ƒç”¨çš„æ¬¡æ•°</li><li>ç¬¬å››åˆ—æ˜¯æ¯ç±»æ“ä½œå•è¯è°ƒç”¨æ‰€ç”¨æ—¶é—´çš„å¹³å‡å€¼</li><li>ç¬¬äº”åˆ—å’Œç¬¬å…­åˆ—åˆ†åˆ«æ˜¯æ¯ç±»æ“ä½œå•æ¬¡è°ƒç”¨æ‰€ç”¨æ—¶é—´çš„æœ€å°å€¼å’Œæœ€å¤§å€¼</li></ul><h3 id="5-2-1-æ•°æ®ä¼ è¾“çš„æ¯”ä¾‹"><a href="#5-2-1-æ•°æ®ä¼ è¾“çš„æ¯”ä¾‹" class="headerlink" title="5.2.1 æ•°æ®ä¼ è¾“çš„æ¯”ä¾‹"></a>5.2.1 æ•°æ®ä¼ è¾“çš„æ¯”ä¾‹</h3><p>é¿å…è¿‡å¤šçš„æ•°æ®ç»ç”±(è¿æ¥GPUå’ŒCPU)PCIeä¼ é€’ï¼Œå¿…é¡»å°½é‡ç¼©å‡æ•°æ®ä¼ è¾“æ‰€èŠ±æ—¶é—´çš„æ¯”ä¾‹(æ•°æ®åœ¨GPUå’ŒCPUä¸Šä¼ è¾“çš„æ—¶é—´æ¯”è®¡ç®—æœ¬èº«è¦å¤šçš„è¯å°±å¾—ä¸å¿å¤±äº†)ã€‚ç†è®ºä¸ŠGPUçš„æ˜¾å­˜å¸¦å®½ä¸ºå‡ ç™¾å…†å­—èŠ‚ï¼Œå¸¸ç”¨çš„PCIeä»…æœ‰16GB/sçš„å¸¦å®½ã€‚</p><p><code>nvcc -O3</code>ä¸­çš„<code>-O3</code>æ˜¯å‘Šè¯‰ç¼–è¯‘å™¨å°½å¯èƒ½å¤šåœ°è¿›è¡Œä¼˜åŒ–</p><h3 id="5-2-2-ç®—æ•°å¼ºåº¦"><a href="#5-2-2-ç®—æ•°å¼ºåº¦" class="headerlink" title="5.2.2 ç®—æ•°å¼ºåº¦"></a>5.2.2 ç®—æ•°å¼ºåº¦</h3><p>è¿›è¡Œè¾ƒå¤æ‚çš„æµ®ç‚¹è¿ç®—ï¼Œå¯èƒ½ä¼šå¾—åˆ°æ›´é«˜çš„åŠ é€Ÿæ¯”ï¼Œäºæ˜¯å°†ä¹‹å‰çš„æ•°ç»„ç›¸åŠ å‡½æ•°è¿›è¡Œæ›´æ”¹ä¸ºğŸ‘‡</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">arithmetic</span><span class="token punctuation">(</span>real <span class="token operator">*</span>x<span class="token punctuation">,</span> <span class="token keyword">const</span> real x0<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> N<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> n<span class="token operator">&lt;</span>N<span class="token punctuation">;</span> <span class="token operator">++</span>n<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        real x_tmp <span class="token operator">=</span> x<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">sqrt</span><span class="token punctuation">(</span>x_tmp<span class="token punctuation">)</span> <span class="token operator">&lt;</span> x0<span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token operator">++</span>x_tmp<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        x<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">=</span> x_tmp<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li>CPU</li></ol><ul><li>å•ç²¾åº¦ğŸ‘‡<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240830164803.png"></li><li>åŒç²¾åº¦ğŸ‘‡<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240830164907.png"></li></ul><ol start="2"><li>GPU<br>åŸæœ¬æ‰§è¡Œç¨‹åºæ˜¯<code>.\arithmetic2gpu</code>ï¼Œå› ä¸ºæœ‰<code>const int N = atoi(argv[1]);</code>ï¼Œæ‰€ä»¥å˜æˆ<code>.\arithmetic2gpu N</code>ï¼ŒNå¯ä»¥æ˜¯ä»»ä½•æ•°å­—ï¼Œåœ¨å‘½ä»¤è¡Œä¸­æ‰‹åŠ¨è¾“å…¥ï¼Œå°†ä¼šè¢«è¯»å–åˆ°ç¨‹åºä¸­çš„N</li></ol><ul><li>å•ç²¾åº¦ğŸ‘‡<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240830210914.png"></li><li>åŒç²¾åº¦ğŸ‘‡<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240830211004.png"></li></ul><h3 id="5-2-3-å¹¶è¡Œè§„æ¨¡"><a href="#5-2-3-å¹¶è¡Œè§„æ¨¡" class="headerlink" title="5.2.3 å¹¶è¡Œè§„æ¨¡"></a>5.2.3 å¹¶è¡Œè§„æ¨¡</h3><p>å¹¶è¡Œè§„æ¨¡å¯ç”¨GPUä¸­æ€»çš„çº¿ç¨‹æ•°ç›®æ¥è¡¡é‡<br>å°ç»“ï¼š</p><ul><li>æ•°æ®ä¼ è¾“æ¯”ä¾‹å°â€”â€”å‡å°‘ä¸»æœºä¸è®¾å¤‡ä¹‹é—´çš„æ•°æ®ä¼ è¾“</li><li>æ ¸å‡½æ•°çš„ç®—æœ¯å¼ºåº¦è¾ƒé«˜â€”â€”æé«˜æ ¸å‡½æ•°çš„ç®—æœ¯å¼ºåº¦</li><li>æ ¸å‡½æ•°ä¸­å®šä¹‰çš„çº¿ç¨‹æ•°ç›®è¾ƒå¤šâ€”â€”å¢å¤§æ ¸å‡½æ•°çš„å¹¶è¡Œè§„æ¨¡</li></ul><h1 id="ç¬¬å…­ç« -CPUçš„ç»„ç»‡å†…å­˜"><a href="#ç¬¬å…­ç« -CPUçš„ç»„ç»‡å†…å­˜" class="headerlink" title="ç¬¬å…­ç«  CPUçš„ç»„ç»‡å†…å­˜"></a>ç¬¬å…­ç«  CPUçš„ç»„ç»‡å†…å­˜</h1><h3 id="6-2-1-å…¨å±€å†…å­˜"><a href="#6-2-1-å…¨å±€å†…å­˜" class="headerlink" title="6.2.1 å…¨å±€å†…å­˜"></a>6.2.1 å…¨å±€å†…å­˜</h3><ol><li><p>åœ¨æ ¸å‡½æ•°ä¸­ï¼Œå¯ç›´æ¥å¯¹é™æ€å…¨å±€å†…å­˜å˜é‡è¿›è¡Œè®¿é—®ï¼Œå¹¶ä¸éœ€è¦å°†å®ƒä»¬ä»¥å‚æ•°çš„å½¢å¼ä¼ ç»™æ ¸å‡½æ•°ï¼Œå³ï¼š<br>ç›´æ¥è®¿é—®é™æ€å…¨å±€å†…æ‘å˜é‡(d_xå’Œd_y[])ğŸ‘‡</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">__device__ <span class="token keyword">int</span> d_x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>__device__ <span class="token keyword">int</span> d_y<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>__global__ <span class="token keyword">void</span> <span class="token function">my_kernel</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    d_y<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+=</span> d_x<span class="token punctuation">;</span> <span class="token comment">// ç›´æ¥è®¿é—®</span>    d_y<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+=</span> d_x<span class="token punctuation">;</span> <span class="token comment">// ç›´æ¥è®¿é—®</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"d_x = %d\t d_y[0] = %d\t d_y[1] = %d\n"</span><span class="token punctuation">,</span> d_x<span class="token punctuation">,</span> d_y<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> d_y<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    my_kernel<span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ— éœ€ä¼ å‚</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>(d_dataå’Œvalue)ä½œä¸ºå‚æ•°ä¼ ç»™æ ¸å‡½æ•°</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">__global__ <span class="token keyword">void</span> <span class="token function">myKernel</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> idx <span class="token operator">=</span> threadIdx<span class="token punctuation">.</span>x<span class="token punctuation">;</span>    data<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> <span class="token operator">*</span>d_data<span class="token punctuation">;</span>    <span class="token keyword">int</span> value <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>    <span class="token function">cudaMalloc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d_data<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">*</span> N<span class="token punctuation">)</span><span class="token punctuation">;</span>    myKernel<span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span><span class="token number">1</span><span class="token punctuation">,</span> N<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>d_data<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// éœ€è¦ä¼ å‚(d_dataå’Œvalue)</span>    <span class="token function">cudaFree</span><span class="token punctuation">(</span>d_data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>ä¸å¯åœ¨ä¸»æœºå‡½æ•°ä¸­ç›´æ¥è®¿é—®é™æ€å…¨å±€å†…å­˜å˜é‡ï¼Œä½†å¯ä»¥ç”¨<code>cudaMemcpyToSymbol()</code>å’Œ<code>cudaMemcpyFromSymbol()</code>å‡½æ•°åœ¨é™æ€å…¨å±€å†…å­˜ä¸ä¸»æœºå†…å­˜ä¹‹é—´ä¼ è¾“æ•°æ®ï¼Œè¿™ä¸¤ä¸ªCUDAè¿è¡Œæ—¶APIå‡½æ•°å¦‚ä¸‹(symbolæŒ‡çš„æ˜¯é™æ€å…¨å±€å†…å­˜å˜é‡)</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">cudaError_t</span> <span class="token function">cudaMemcpyToSymbol</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> symbol<span class="token punctuation">,</span> <span class="token comment">// é™æ€å…¨å±€å†…å­˜å˜é‡å</span><span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> src<span class="token punctuation">,</span>    <span class="token comment">// ä¸»æœºå†…å­˜ç¼“å†²åŒºæŒ‡é’ˆ</span><span class="token class-name">size_t</span> count<span class="token punctuation">,</span>       <span class="token comment">// å¤åˆ¶çš„å­—èŠ‚æ•°</span><span class="token class-name">size_t</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token comment">// ä»symbolå¯¹åº”è®¾å¤‡åœ°å€å¼€å§‹åç§»çš„å­—èŠ‚æ•°</span>cudaMemcpyKind kind <span class="token operator">=</span> cudaMemcpyHostToDevice <span class="token comment">// å¯é€‰å‚æ•°</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">cudaError_t</span> <span class="token function">cudaMemcpyFromSymbol</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>dst<span class="token punctuation">,</span>          <span class="token comment">// ä¸»æœºå†…å­˜ç¼“å†²åŒºæŒ‡é’ˆ</span><span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> symbol<span class="token punctuation">,</span> <span class="token comment">// é™æ€å…¨å±€å†…å­˜å˜é‡</span><span class="token class-name">size_t</span> count<span class="token punctuation">,</span>       <span class="token comment">// å¤åˆ¶çš„å­—èŠ‚æ•°</span><span class="token class-name">size_t</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token comment">// ä»symbolå¯¹åº”è®¾å¤‡åœ°å€å¼€å§‹åç§»çš„å­—èŠ‚æ•°</span>cudaMemcpyKind kind <span class="token operator">=</span> cudaMemcpyDeviceToHost <span class="token comment">// å¯é€‰å‚æ•°</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>ç‰¹ç‚¹</p></li></ol><ul><li>æ‰€æœ‰çº¿ç¨‹éƒ½èƒ½è®¿é—®ï¼Œå…¨å±€å†…å­˜å¯¹æ•´ä¸ªç½‘æ ¼çš„æ‰€æœ‰çº¿ç¨‹å¯è§</li><li>æ²¡æœ‰æ”¾åœ¨GPUèŠ¯ç‰‡ä¸Šï¼Œå…·æœ‰è¾ƒé«˜å»¶è¿Ÿå’Œè¾ƒä½çš„è®¿é—®é€Ÿåº¦ï¼›æ˜¯æ‰€æœ‰è®¾å¤‡ä¸­å†…å­˜æœ€å¤§çš„ï¼Œå®¹é‡åŸºæœ¬ä¸Šå°±æ˜¯æ˜¾å­˜å®¹é‡</li><li>å¯è¯»å¯å†™</li><li>ç”Ÿå‘½å‘¨æœŸï¼šä»ä¸»æœºç«¯ç”¨<code>cudaMalloc()</code>å¯¹ä»–ä»¬åˆ†é…å¼€å§‹ï¼Œåˆ°ä¸»æœºç«¯ç”¨<code>cudaFree()</code>é‡Šæ”¾ä»–ä»¬çš„å†…å­˜ç»“æŸ</li></ul><h3 id="6-2-2-å¸¸é‡å†…å­˜"><a href="#6-2-2-å¸¸é‡å†…å­˜" class="headerlink" title="6.2.2 å¸¸é‡å†…å­˜"></a>6.2.2 å¸¸é‡å†…å­˜</h3><ul><li>æ˜¯æœ‰å¸¸é‡ç¼“å­˜çš„å…¨å±€å†…å­˜ï¼Œä»…æœ‰64KB</li><li>å¯è¯»ä¸å¯å†™</li><li>(å› ä¸ºæœ‰ç¼“å­˜)è®¿é—®é€Ÿåº¦æ¯”å…¨å±€å†…å­˜é«˜ï¼Œé€Ÿåº¦é«˜çš„å‰ææ˜¯ä¸€ä¸ªçº¿ç¨‹æŸä¸­çš„çº¿ç¨‹(ä¸€ä¸ªçº¿ç¨‹å—ä¸­ç›¸é‚»çš„32ä¸ªçº¿ç¨‹)è¦è¯»å–ç›¸åŒçš„å¸¸é‡å†…å­˜æ•°æ®</li><li>ä½¿ç”¨ä¾‹å­ï¼šç”¨<code>__constant__</code>å®šä¹‰å˜é‡ã€<code>const int N</code>(è¿™æ˜¯åœ¨ä¸»æœºç«¯å®šä¹‰çš„å˜é‡ï¼Œé€šè¿‡ä¼ å€¼çš„æ–¹å¼ä¼ é€ç»™æ ¸å‡½æ•°ä¸­çš„çº¿ç¨‹ä½¿ç”¨)ï¼Œæ ¸å‡½æ•°å¯¹å¸¸é‡å†…å­˜çš„è®¿é—®æ¯”å¯¹å…¨å±€å†…å­˜çš„è®¿é—®è¦å¿«</li><li>ç»™æ ¸å‡½æ•°ä¼ é€’çš„å‚æ•°å­˜æ”¾åœ¨å¸¸é‡å†…å­˜ä¸­ï¼Œæœ€å¤šåªèƒ½ç”¨4KBå¸¸é‡å†…å­˜</li></ul><h3 id="6-2-4-å¯„å­˜å™¨"><a href="#6-2-4-å¯„å­˜å™¨" class="headerlink" title="6.2.4 å¯„å­˜å™¨"></a>6.2.4 å¯„å­˜å™¨</h3><p>æ ¸å‡½æ•°ä¸­å®šä¹‰çš„ä¸”å­˜æ”¾åœ¨å¯„å­˜å™¨çš„æœ‰ï¼š</p><ul><li>ä¸åŠ ä»»ä½•é™å®šç¬¦çš„å˜é‡</li><li>ä¸åŠ ä»»ä½•é™å®šç¬¦çš„æ•°ç»„(ä¹Ÿæœ‰å¯èƒ½åœ¨å±€éƒ¨å†…å­˜ä¸­)</li><li>å†…å»ºå˜é‡(å¦‚<code>gridDim</code>ã€<code>blockDim</code>ã€<code>blockIdx</code>ã€<code>threadIdx</code>ã€<code>warpSize</code>ç­‰ç­‰)<br>å¯„å­˜å™¨å¯è¯»å¯å†™ï¼š</li><li>å†™å…¥ï¼š<code>const int n = blockDim.x * blockIdx.x + threadIdx.x</code>ä¸­çš„<code>n</code>å°±æ˜¯ä¸€ä¸ªå¯„å­˜å™¨å˜é‡</li><li>è¯»å‡ºï¼š<code>z[n] = x[n] + y[n]</code><br>å¯„å­˜å™¨å˜é‡ä»…è¢«ä¸€ä¸ªçº¿ç¨‹å¯è§(ä»¥å¯è¯»å¯å†™å¤„ä»£ç ä¸ºä¾‹)ï¼š</li><li>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªå˜é‡<code>n</code>çš„å‰¯æœ¬ï¼Œè™½ç„¶éƒ½æ˜¯åŒä¸€ä¸ªå˜é‡å<code>n</code>ï¼Œä½†æ˜¯ä¸åŒçº¿ç¨‹ä¸­è¯¥å¯„å­˜å™¨å˜é‡çš„å€¼å¯ä»¥ä¸åŒã€‚è€Œä¸”æ¯ä¸ªçº¿ç¨‹åªèƒ½å¯¹å®ƒçš„å‰¯æœ¬è¿›è¡Œè¯»å†™</li><li>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨ä¸»æœºå‡½æ•°ä¸­éœ€è¦ç”¨åˆ°<code>for</code>å¾ªç¯å†™å…¥å’Œè¯»å‡º<code>n</code>(<code>for int n=0; n&lt;N; N++</code>å’Œ<code>z[n]=x[n]+y[n]</code>)ï¼Œè€Œæ ¸å‡½æ•°åªéœ€è¦<code>const int n = blockDim.x * blockIdx. + threadIdx.x</code>å³å¯å®šä½åˆ°ä¸åŒçš„<code>n</code>ï¼Œå› ä¸ºéƒ½æ˜¯å‰¯æœ¬</li></ul><h3 id="6-2-5-å±€éƒ¨å†…å­˜"><a href="#6-2-5-å±€éƒ¨å†…å­˜" class="headerlink" title="6.2.5 å±€éƒ¨å†…å­˜"></a>6.2.5 å±€éƒ¨å†…å­˜</h3><p>å¯„å­˜å™¨ä¸­æ”¾ä¸ä¸‹çš„å˜é‡ã€ç´¢å¼•å€¼ä¸èƒ½åœ¨ç¼–è¯‘æ—¶å°±ç¡®å®šçš„æ•°ç»„éƒ½æœ‰å¯èƒ½æ”¾åœ¨å±€éƒ¨å†…å­˜ä¸­</p><h3 id="6-2-6-å…±äº«å†…å­˜"><a href="#6-2-6-å…±äº«å†…å­˜" class="headerlink" title="6.2.6 å…±äº«å†…å­˜"></a>6.2.6 å…±äº«å†…å­˜</h3><ul><li>å’Œå¯„å­˜å™¨ç±»ä¼¼ï¼Œé€Ÿåº¦ä»…æ¬¡äºå¯„å­˜å™¨çš„è¯»å†™é€Ÿåº¦</li><li>å…±äº«å†…å­˜å¯¹æ•´ä¸ª<strong>çº¿ç¨‹å—</strong>å¯è§ï¼Œæ¯ä¸ªçº¿ç¨‹å—æ‹¥æœ‰ä¸€ä¸ªå…±äº«å†…å­˜å˜é‡çš„å‰¯æœ¬ï¼Œå…±äº«å†…å­˜å˜é‡çš„å€¼åœ¨ä¸åŒçš„çº¿ç¨‹å—ä¸­å¯ä»¥ä¸åŒã€‚ä¸€ä¸ªçº¿ç¨‹å—ä¸­çš„æ‰€æœ‰çº¿ç¨‹éƒ½å¯ä»¥è®¿é—®è¯¥çº¿ç¨‹å—çš„å…±äº«å˜é‡å‰¯æœ¬ï¼Œä½†æ˜¯ä¸èƒ½è®¿é—®å…¶ä»–çº¿ç¨‹å—çš„å…±äº«å†…å­˜å˜é‡å‰¯æœ¬</li><li>ä¸»è¦ä½œç”¨æ˜¯å‡å°‘å¯¹å…¨å±€å†…å­˜çš„è®¿é—®</li></ul><h2 id="6-4-ç”¨CUDAè¿è¡Œæ—¶APIå‡½æ•°æŸ¥è¯¢è®¾å¤‡"><a href="#6-4-ç”¨CUDAè¿è¡Œæ—¶APIå‡½æ•°æŸ¥è¯¢è®¾å¤‡" class="headerlink" title="6.4 ç”¨CUDAè¿è¡Œæ—¶APIå‡½æ•°æŸ¥è¯¢è®¾å¤‡"></a>6.4 ç”¨CUDAè¿è¡Œæ—¶APIå‡½æ•°æŸ¥è¯¢è®¾å¤‡</h2><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240831195051.png"></p><h1 id="ç¬¬ä¸ƒç« -å…¨å±€å†…å­˜çš„åˆç†ä½¿ç”¨"><a href="#ç¬¬ä¸ƒç« -å…¨å±€å†…å­˜çš„åˆç†ä½¿ç”¨" class="headerlink" title="ç¬¬ä¸ƒç«  å…¨å±€å†…å­˜çš„åˆç†ä½¿ç”¨"></a>ç¬¬ä¸ƒç«  å…¨å±€å†…å­˜çš„åˆç†ä½¿ç”¨</h1><h2 id="7-1-å…¨å±€å†…å­˜çš„åˆå¹¶ä¸éåˆå¹¶è®¿é—®"><a href="#7-1-å…¨å±€å†…å­˜çš„åˆå¹¶ä¸éåˆå¹¶è®¿é—®" class="headerlink" title="7.1 å…¨å±€å†…å­˜çš„åˆå¹¶ä¸éåˆå¹¶è®¿é—®"></a>7.1 å…¨å±€å†…å­˜çš„åˆå¹¶ä¸éåˆå¹¶è®¿é—®</h2><p>$åˆå¹¶åº¦=\dfrac{çº¿ç¨‹æŸè¯·æ±‚çš„å­—èŠ‚æ•°}{ç”±è¯¥è¯·æ±‚å¯¼è‡´çš„æ‰€æœ‰æ•°æ®ä¼ è¾“å¤„ç†çš„å­—èŠ‚æ•°}$<br><strong>æ•°æ®ä¼ è¾“å¯¹æ•°æ®åœ°å€çš„è¦æ±‚ï¼šåœ¨ä¸€æ¬¡æ•°æ®ä¼ è¾“ä¸­ï¼Œä»å…¨å±€å†…å­˜è½¬ç§»åˆ°L2ç¼“å­˜çš„ä¸€ç‰‡å†…å­˜é¦–åœ°å€ä¸€å®šæ˜¯ä¸€ä¸ªæœ€å°é¢—ç²’åº¦(æœ¬ä¾‹æ˜¯32)çš„æ•´æ•°å€ã€‚</strong></p><ol><li>é¡ºåºçš„åˆå¹¶è®¿é—®<pre class="line-numbers language-c" data-language="c"><code class="language-c">__global__ <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">float</span> <span class="token operator">*</span>x<span class="token punctuation">,</span> <span class="token keyword">float</span> <span class="token operator">*</span>y<span class="token punctuation">,</span> <span class="token keyword">float</span> <span class="token operator">*</span>z<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">int</span> n <span class="token operator">=</span> threadIdx<span class="token punctuation">.</span>x <span class="token operator">+</span> blockIdx<span class="token punctuation">.</span>x <span class="token operator">*</span> blcokDim<span class="token punctuation">.</span>x<span class="token punctuation">;</span>    z<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">+</span> y<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><ul><li>ç¬¬ä¸€ä¸ªçº¿ç¨‹å—(blockIdx.x=0)ä¸­çš„çº¿ç¨‹æŸå°†è®¿é—®æ•°ç»„<code>x</code>ä¸­ç¬¬0~31ä¸ªå…ƒç´ (æ¯ä¸ªå…ƒç´ ç±»å‹ä¸ºfloatï¼Œå å››ä¸ªå­—èŠ‚)ï¼Œåˆ™å¯¹åº”32Ã—4=128å­—èŠ‚çš„è¿ç»­å†…å­˜</li><li>é¦–åœ°å€ä¸€å®šæ˜¯256å­—èŠ‚çš„æ•´æ•°å€(ä½¿ç”¨CUDAè¿è¡Œæ—¶APIå¦‚<code>cudaMalloc</code>åˆ†é…çš„å†…å­˜çš„é¦–åœ°å€è‡³å°‘æ˜¯256å­—èŠ‚çš„æ•´æ•°å€)</li><li>è¿™æ ·åªéœ€è¦è®¿é—®4æ¬¡æ•°æ®ä¼ è¾“å³å¯å®Œæˆ(è¦æ±‚ï¼šä¸€æ¬¡æ•°æ®ä¼ è¾“åªèƒ½ä»å…¨å±€å†…å­˜è¯»å–åœ°å€ä¸º0<del>31å­—èŠ‚ã€32</del>63å­—èŠ‚ç­‰ç‰‡æ®µçš„æ•°æ®ã€‚å¦‚æœçº¿ç¨‹æŸè¯·æ±‚çš„å…¨å±€å†…å­˜æ•°æ®çš„åœ°å€åˆšå¥½ä¸º0<del>127å­—èŠ‚æˆ–è€…128</del>256å­—èŠ‚ï¼Œå°±èƒ½ä¸<strong>4æ¬¡æ•°æ®ä¼ è¾“</strong>(0<del>31ã€32</del>63ã€64<del>95ã€96</del>127å››æ¬¡)æ‰€å¤„ç†çš„æ•°æ®å®Œå…¨å»åˆ)</li><li>åˆå¹¶åº¦ä¸º100%</li></ul><ol start="2"><li>ä¹±åºçš„åˆå¹¶è®¿é—®<pre class="line-numbers language-c" data-language="c"><code class="language-c">__global__ <span class="token keyword">void</span> <span class="token function">add_permuted</span><span class="token punctuation">(</span><span class="token keyword">float</span> <span class="token operator">*</span>x<span class="token punctuation">,</span> <span class="token keyword">float</span> <span class="token operator">*</span>y<span class="token punctuation">,</span> <span class="token keyword">float</span> <span class="token operator">*</span>z<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">int</span> tid_permuted <span class="token operator">=</span> threadIdx<span class="token punctuation">.</span>x <span class="token operator">^</span> <span class="token number">0x1</span><span class="token punctuation">;</span><span class="token keyword">int</span> n <span class="token operator">=</span> tid_permuted <span class="token operator">+</span> blockIdx<span class="token punctuation">.</span>x <span class="token operator">*</span> blcokDim<span class="token punctuation">.</span>x<span class="token punctuation">;</span>    z<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">+</span> y<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><ul><li><code>threadIdx.x ^ 0x1</code>å¼‚æˆ–ï¼Œå°†<code>threadIdx.x</code>æœ€åä¸€ä½ç¿»è½¬</li><li>ä»…æŠŠçº¿ç¨‹å—ä¸­å¥‡å¶æ¬¡åºè°ƒè½¬ã€‚å¦‚ç¬¬ä¸€ä¸ªçº¿ç¨‹å—ä¸­ï¼ŒåŸæœ¬nçš„é¡ºåºä¸º0ã€1ã€2ã€3â€¦ã€‚å˜ä¸º1ã€0ã€3ã€2â€¦ï¼Œå³åªä¸è¿‡çº¿ç¨‹å·ä¸æ•°ç»„å…ƒç´ æŒ‡æ ‡ä¸å®Œå…¨ä¸€è‡´</li><li>åˆå¹¶åº¦ä¸º100%</li></ul><ol start="3"><li>ä¸å¯¹é½çš„éåˆå¹¶è®¿é—®<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> __global__ <span class="token function">add_offset</span><span class="token punctuation">(</span><span class="token keyword">float</span> <span class="token operator">*</span>x<span class="token punctuation">,</span> <span class="token keyword">float</span> <span class="token operator">*</span>y<span class="token punctuation">,</span> <span class="token keyword">float</span> <span class="token operator">*</span>z<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> n <span class="token operator">=</span> threadIdx<span class="token punctuation">.</span>x <span class="token operator">+</span> blockIdx<span class="token punctuation">.</span>x <span class="token operator">*</span> blcokDim<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>    z<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">+</span> y<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span>add_permuted<span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><ul><li>ä»¥ç¬¬ä¸€ä¸ªçº¿ç¨‹å—ä¸ºä¾‹ï¼Œç¬¬ä¸€ä¸ªçº¿ç¨‹å—ä¸­çš„çº¿ç¨‹æŸå°†è®¿é—®æ•°ç»„xä¸­ç¬¬1~32ä¸ªå…ƒç´ ã€‚</li><li>å‡å¦‚æ•°ç»„xçš„é¦–åœ°å€ä¸º256ï¼Œé‚£ä¹ˆ<code>x[0]</code>ä¸º256<del>259ï¼Œ<code>x[1]</code>ä¸º260</del>263ï¼Œ<code>x[32]</code>ä¸º382~387</li><li>è¿™å°†è§¦å‘5æ¬¡æ•°æ®ä¼ è¾“ï¼Œå¯¹åº”çš„å†…å­˜åœ°å€ä¸º256<del>287å­—èŠ‚ã€288</del>319å­—èŠ‚ã€320<del>351å­—èŠ‚ã€352</del>383å­—èŠ‚å’Œ384~415å­—èŠ‚</li><li>åˆå¹¶åº¦ä¸º$\dfrac{4}{5}Ã—100=80%$</li></ul><ol start="4"><li>è·¨è¶Šå¼çš„éåˆå¹¶è®¿é—®<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> __global__ <span class="token function">add_stride</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token operator">*</span> x<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> y<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> z<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> n <span class="token operator">=</span> blockIdx<span class="token punctuation">.</span>x <span class="token operator">+</span> threadIdx<span class="token punctuation">.</span>x <span class="token operator">*</span> gridDim<span class="token punctuation">.</span>x<span class="token punctuation">;</span>    z<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">+</span> y<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span>add_stride<span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><ul><li>ç¬¬ä¸€ä¸ªçº¿ç¨‹å—ä¸­çš„çº¿ç¨‹æŸå°†è®¿é—®æ•°ç»„xä¸­æŒ‡æ ‡ä¸º<code>0 + threadIdx.x * gridDim.x=1*128ã€2*128ã€3*128...</code>çš„å…ƒç´ </li><li>æ¯ä¸€å¯¹æ•°æ®éƒ½ä¸åœ¨ä¸€ä¸ªè¿ç»­çš„32å­—èŠ‚çš„å†…å­˜ç‰‡æ®µï¼Œå› æ­¤è¯¥çº¿ç¨‹æŸçš„è®¿é—®å°†è§¦å‘32æ¬¡æ•°æ®ä¼ è¾“</li><li>åˆå¹¶åº¦ä¸º$\dfrac{4}{32}Ã—100%=12.5%$</li></ul><ol start="5"><li>å¹¿æ’­å¼çš„éåˆå¹¶è®¿é—®<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> __global__ <span class="token function">add_broadcast</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token operator">*</span> x<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> y<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> z<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> n <span class="token operator">=</span> blockIdx<span class="token punctuation">.</span>x <span class="token operator">+</span> threadIdx<span class="token punctuation">.</span>x <span class="token operator">*</span> gridDim<span class="token punctuation">.</span>x<span class="token punctuation">;</span>    z<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> y<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span>add_stride<span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><ul><li>ç¬¬ä¸€ä¸ªçº¿ç¨‹å—ä¸­çš„çº¿ç¨‹æŸå°†ä¸€è‡´åœ°è®¿é—®æ•°ç»„xä¸­çš„ç¬¬0ä¸ªå…ƒç´ ã€‚è¿™å®é™…ä¸Šåªéœ€è¦ä¸€æ¬¡æ•°æ®ä¼ è¾“(å¤„ç†32å­—èŠ‚çš„æ•°æ®)ï¼Œä½†æ•´ä¸ªçº¿ç¨‹æŸéƒ½åœ¨è®¿é—®åŒä¸€ä¸ªå†…å­˜åœ°å€<code>x[0]</code>ï¼Œåªä½¿ç”¨äº†4å­—èŠ‚çš„æ•°æ®</li><li>åˆå¹¶åº¦ä¸º$\dfrac{4}{32}Ã—100%=12.5%$</li></ul><h2 id="7-2-ä¾‹å­ï¼šçŸ©é˜µè½¬ç½®"><a href="#7-2-ä¾‹å­ï¼šçŸ©é˜µè½¬ç½®" class="headerlink" title="7.2 ä¾‹å­ï¼šçŸ©é˜µè½¬ç½®"></a>7.2 ä¾‹å­ï¼šçŸ©é˜µè½¬ç½®</h2><p><code>transpose1()</code>ï¼šå¯¹çŸ©é˜µAä¸­æ•°æ®çš„è®¿é—®(è¯»å–)æ˜¯é¡ºåºçš„(/åˆå¹¶çš„)ï¼Œå¯¹çŸ©é˜µBä¸­æ•°æ®çš„è®¿é—®(å†™å…¥)ä¸æ˜¯é¡ºåºçš„(/éåˆå¹¶çš„)</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span><span class="token punctuation">(</span>nx <span class="token operator">&lt;</span> N <span class="token operator">&amp;&amp;</span> ny <span class="token operator">&lt;</span> N<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        B<span class="token punctuation">[</span>nx <span class="token operator">*</span> N <span class="token operator">+</span> ny<span class="token punctuation">]</span> <span class="token operator">=</span> A<span class="token punctuation">[</span>ny <span class="token operator">*</span> N <span class="token operator">+</span> nx<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240902095334.png" alt="|277"><br><code>transpose2()</code>ï¼šå¯¹çŸ©é˜µAä¸­æ•°æ®çš„è®¿é—®(è¯»å–)ä¸æ˜¯é¡ºåºçš„(/éåˆå¹¶çš„)ï¼Œå¯¹çŸ©é˜µBä¸­æ•°æ®çš„è®¿é—®(å†™å…¥)æ˜¯é¡ºåºçš„(/åˆå¹¶çš„)</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span><span class="token punctuation">(</span>nx <span class="token operator">&lt;</span> N <span class="token operator">&amp;&amp;</span> ny <span class="token operator">&lt;</span> N<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        B<span class="token punctuation">[</span>ny <span class="token operator">*</span> N <span class="token operator">+</span> nx<span class="token punctuation">]</span> <span class="token operator">=</span> A<span class="token punctuation">[</span>nx <span class="token operator">*</span> N <span class="token operator">+</span> ny<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240902095353.png" alt="|277"><br>å¯ä»¥å‘ç°<code>transpose2()</code>çš„ç”¨æ—¶æ¯”<code>transpose1()</code>çš„æ›´ä¹…ï¼Ÿ<br>ä¹¦ä¸ŠåŸè¯ï¼š</p><ul><li>åœ¨ä¸èƒ½æ»¡è¶³è¯»å–å’Œå†™å…¥éƒ½æ˜¯åˆå¹¶çš„æƒ…å†µä¸‹ï¼Œä¸€èˆ¬æ¥è¯´åº”å½“å°½é‡åšåˆ°åˆå¹¶åœ°å†™å…¥</li><li>ä¹¦ä¸Šçš„ç»“æœæ˜¯2æ¯”1ç”¨æ—¶æ›´çŸ­ï¼Œå› ä¸ºç¼–è¯‘å™¨èƒ½å¤Ÿåˆ¤æ–­ä¸€ä¸ªå…¨å±€å†…å­˜å˜é‡<strong>åœ¨æ•´ä¸ªæ ¸å‡½æ•°çš„èŒƒå›´éƒ½åªå¯è¯»</strong>ï¼Œåˆ™ä¼šè‡ªåŠ¨ç”¨å‡½æ•°<code>__ldg()</code>è¯»å–å…¨å±€å†…å­˜ï¼Œä»è€Œå¯¹æ•°æ®çš„è¯»å–è¿›è¡Œ<strong>ç¼“å­˜</strong>ï¼Œç¼“è§£éåˆå¹¶è®¿é—®å¸¦æ¥çš„å½±å“ã€‚è€Œå¯¹äºå…¨å±€å†…å­˜çš„å†™å…¥åˆ™æ²¡æœ‰ç±»ä¼¼çš„å‡½æ•°å¯ç”¨<br>ğŸ‘‡ç”¨äº†åˆ«äººçš„ä»£ç å<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240902100134.png"></li></ul><h1 id="ç¬¬å…«ç« -å…±äº«å†…å­˜çš„åˆç†ä½¿ç”¨"><a href="#ç¬¬å…«ç« -å…±äº«å†…å­˜çš„åˆç†ä½¿ç”¨" class="headerlink" title="ç¬¬å…«ç«  å…±äº«å†…å­˜çš„åˆç†ä½¿ç”¨"></a>ç¬¬å…«ç«  å…±äº«å†…å­˜çš„åˆç†ä½¿ç”¨</h1><h2 id="8-1-ä¾‹å­ï¼šæ•°ç»„å½’çº¦è®¡ç®—"><a href="#8-1-ä¾‹å­ï¼šæ•°ç»„å½’çº¦è®¡ç®—" class="headerlink" title="8.1 ä¾‹å­ï¼šæ•°ç»„å½’çº¦è®¡ç®—"></a>8.1 ä¾‹å­ï¼šæ•°ç»„å½’çº¦è®¡ç®—</h2><ul><li>C++å®ç°è®¡ç®—é•¿åº¦è¾ƒå¤§çš„ç´¯åŠ è®¡ç®—æ—¶ï¼Œä¼šå‡ºç°â€å¤§æ•°åƒå°æ•°â€œçš„ç°è±¡</li><li>CUDAå®ç°æ¯”C++å®ç°ä¸Šè¿°å†…å®¹æ—¶è¦ç¨³å¥å¾—å¤š<br>å•ç²¾åº¦ğŸ‘‡<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240911215856.png" alt="|325"><br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240911220431.png" alt="325"><br>ä¸Šé¢ä¸¤ä¸ªå‡ºç°å¤§æ•°åƒå°æ•°çš„æƒ…å†µ</li></ul><table><thead><tr><th>ç²¾åº¦</th><th>reduce_global</th><th>reduce_shared</th><th>reduce_dynamic</th><th>ç»“æœ</th></tr></thead><tbody><tr><td>float</td><td>6~7ms</td><td>7~8ms</td><td>7~9ms</td><td>123633392.000000.</td></tr><tr><td>double</td><td>9~11ms</td><td>15~17ms</td><td>15~18ms</td><td>122999999.998770.</td></tr></tbody></table><p>å•ç²¾åº¦çš„ç»“æœæ²¡æœ‰é‚£ä¹ˆç¦»è°±ï¼Œä½†æ˜¯ç¦»æ­£ç¡®ç­”æ¡ˆè¿˜æœ‰ä¸€æ®µè·ç¦»</p><h3 id="8-1-1-ä»…ä½¿ç”¨å…¨å±€å†…å­˜"><a href="#8-1-1-ä»…ä½¿ç”¨å…¨å±€å†…å­˜" class="headerlink" title="8.1.1 ä»…ä½¿ç”¨å…¨å±€å†…å­˜"></a>8.1.1 ä»…ä½¿ç”¨å…¨å±€å†…å­˜</h3><ul><li>è®¿é—®é¢‘ç¹</li><li>ä½¿ç”¨æŠ˜åŠå½’çº¦æ³•</li><li>å‡è®¾æ ¸å‡½æ•°çš„ç½‘æ ¼å¤§å°å’Œçº¿ç¨‹å—å¤§å°çš„ä¹˜ç§¯ä¸º<code>N</code></li><li>å¯¹äºå¤šçº¿ç¨‹çš„ç¨‹åºï¼Œä¸¤ä¸ªä¸åŒçº¿ç¨‹ä¸­æŒ‡ä»¤çš„æ‰§è¡Œæ¬¡åºå¯èƒ½å’Œä»£ç ä¸­å±•ç°çš„æ¬¡åºä¸åŒ</li><li>ä¾‹(å¾ªç¯çš„å‰ä¸¤æ¬¡)ï¼š<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// å¾ªç¯çš„ç¬¬ä¸€æ¬¡</span><span class="token keyword">if</span><span class="token punctuation">(</span>n <span class="token operator">&lt;</span> N<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>d_x<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">+=</span> d_x<span class="token punctuation">[</span>n <span class="token operator">+</span> N<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token comment">// åœ¨è¿™æ¬¡æ“ä½œä¸­å¯èƒ½ä¼šæœ‰å‘æ•°ç»„d_x[N/4]å†™å…¥æ•°æ®çš„æ“ä½œï¼›</span><span class="token comment">// å¾ªç¯çš„ç¬¬äºŒæ¬¡</span><span class="token keyword">if</span><span class="token punctuation">(</span>n <span class="token operator">&lt;</span> N<span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">{</span>d_x<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">+=</span> d_x<span class="token punctuation">[</span>n <span class="token operator">+</span> N<span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token comment">// æœ‰å¯èƒ½åœ¨çº¿ç¨‹n=0å¼€å§‹æ‰§è¡Œè¿™å¥æ—¶ï¼Œn=N/4è¿˜æ²¡æ‰§è¡Œå®Œä¸Šä¸€è¡Œ</span><span class="token punctuation">[</span><span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span> <span class="token number">5</span> <span class="token number">6</span> <span class="token number">7</span> <span class="token number">8</span><span class="token punctuation">]</span>N <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">,</span> N<span class="token operator">/</span><span class="token number">2</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span> ç¬¬ä¸€æ¬¡n<span class="token operator">=</span><span class="token number">0</span><span class="token operator">~</span><span class="token number">3</span><span class="token punctuation">,</span> d_x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+=</span> d<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> ç­‰ä»·äº d_x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token number">1</span><span class="token operator">+</span><span class="token number">5</span> <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">[</span><span class="token number">6</span> <span class="token number">8</span> <span class="token number">10</span> <span class="token number">12</span><span class="token punctuation">]</span>N<span class="token operator">/</span><span class="token number">4</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> ç¬¬äºŒæ¬¡n<span class="token operator">=</span><span class="token number">0</span><span class="token operator">~</span><span class="token number">1</span><span class="token punctuation">,</span> å¯èƒ½ä¼šå‡ºç°ä¸Šé¢è¿˜æ²¡åŠ å®Œï¼Œå°±æ‰§è¡Œè¿™é‡Œçš„æƒ…å†µ <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>è§£å†³æ–¹æ³•ï¼šè¦ä¿è¯æ ¸å‡½æ•°ä¸­è¯­å¥çš„æ‰§è¡Œé¡ºåºä¸å‡ºç°é¡ºåºä¸€è‡´ï¼Œç”¨åŒæ­¥å‡½æ•°<code>__syncthreads()</code><ul><li>åªé’ˆå¯¹ä¸€ä¸ªçº¿ç¨‹å—ä¸­çš„çº¿ç¨‹(å³åªèƒ½å¤ŸåŒæ­¥å•ä¸ªçº¿ç¨‹å—ä¸­çš„çº¿ç¨‹)<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> __global__ <span class="token function">reduce_global</span><span class="token punctuation">(</span>real<span class="token operator">*</span> d_x<span class="token punctuation">,</span> real<span class="token operator">*</span> d_y<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">const</span> <span class="token keyword">int</span> tid <span class="token operator">=</span> threadIdx<span class="token punctuation">.</span>x<span class="token punctuation">;</span>real<span class="token operator">*</span> x <span class="token operator">=</span> d_x <span class="token operator">+</span> blockDim<span class="token punctuation">.</span>x <span class="token operator">*</span> blockIdx<span class="token punctuation">.</span>x<span class="token punctuation">;</span><span class="token comment">// ä¸åŒçš„çº¿ç¨‹å—æŒ‡å‘å…¨å±€å†…å­˜ä¸­çš„ä¸åŒåœ°å€</span><span class="token comment">// ä¸Šé¢ä¹Ÿå¯ä»¥å†™æˆ real* x = &amp;d_x[blockDim.x * blockIdx.x];</span><span class="token comment">// d_xæ˜¯åŠ¨æ€æ•°ç»„ï¼Œæ•°ç»„åå°±æ˜¯æ•°ç»„é¦–åœ°å€</span><span class="token comment">// å–d_x[blockDim.x + blockIdx.x]çš„åœ°å€ç­‰ä»·äºé¦–åœ°å€+åç§»é‡(bDimx.x+bIdx.x)</span><span class="token comment">// å®šä¹‰çš„xåœ¨ä¸åŒçš„çº¿ç¨‹å—ä¸­æŒ‡å‘å…¨å±€å†…å­˜ä¸­çš„ä¸åŒåœ°å€ï¼</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> offset <span class="token operator">=</span> blockDim<span class="token punctuation">.</span>x <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span> offset <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> offset <span class="token operator">&gt;&gt;=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span>tid <span class="token operator">&lt;</span> offset<span class="token punctuation">)</span><span class="token punctuation">{</span>x<span class="token punctuation">[</span>tid<span class="token punctuation">]</span> <span class="token operator">+=</span> x<span class="token punctuation">[</span>tid<span class="token operator">+</span>offset<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">__syncthreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ä¿è¯åŒä¸€ä¸ªçº¿ç¨‹å—å†…åœ°çº¿ç¨‹æŒ‰ç…§ä»£ç å‡ºç°åœ°é¡ºåºæ‰§è¡Œå‘½ä»¤</span><span class="token punctuation">}</span><span class="token comment">// ä¸Šè¿°forå¾ªç¯ä¿è¯å„ä¸ªçº¿ç¨‹å—å†…å¯¹å…¶ä¸­çš„æ•°æ®ç‹¬ç«‹åœ°è¿›è¡Œå½’çº¦</span><span class="token keyword">if</span><span class="token punctuation">(</span>tid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>d_y<span class="token punctuation">[</span>blockIdx<span class="token punctuation">.</span>x<span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c">real<span class="token operator">*</span> x <span class="token operator">=</span> d_x <span class="token operator">+</span> blockDim<span class="token punctuation">.</span>x <span class="token operator">*</span> blockIdx<span class="token punctuation">.</span>x<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>==xåœ¨ä¸åŒçš„çº¿ç¨‹å—ä¸­æŒ‡å‘å…¨å±€å†…å­˜ä¸­çš„ä¸åŒåœ°å€==ï¼Œå¯ä»¥ç†è§£ä¸ºä¸Šé¢æ¯ä¸€ä¸ªå°æ•°ç»„(ä¹¦ä¸Šçš„ä¾‹å­çš„å°æ•°ç»„é•¿åº¦ä¸º$10^8$)ä¸ºä¸€ä¸ª<code>d_x</code>ï¼Œä¸åŒçš„çº¿ç¨‹å—å¯¹<code>d_x</code>ä¸­ä¸åŒçš„éƒ¨åˆ†è¿›è¡Œå½’çº¦ï¼Œ(åŒä¸€ä¸ªçº¿ç¨‹å—ä¸­çš„çº¿ç¨‹çš„å¤„ç†é€Ÿåº¦ä¸ä¸€è‡´ï¼Ÿ</li><li>è¯¥æ ¸å‡½æ•°ä»…å°†ä¸€ä¸ªé•¿åº¦ä¸º$10^8$çš„æ•°ç»„<code>d_x</code>å½’çº¦åˆ°ä¸€ä¸ªé•¿åº¦ä¸º$\dfrac{10^8}{128}$çš„æ•°ç»„<code>d_y</code>(ä¹¦ä¸Šçš„æ“ä½œæ˜¯æŠŠ<code>d_y</code>ä»è®¾å¤‡å¤åˆ¶åˆ°ä¸»æœºé‡Œå¹¶åœ¨ä¸»æœºç»§ç»­å¯¹<code>d_y</code>è¿›è¡Œå½’çº¦å¾—åˆ°æœ€ç»ˆçš„ç»“æœï¼Œå®é™…ä¸Šè¿™æ ·ä¸æ˜¯å¾ˆé«˜æ•ˆ)</li><li>åˆ©ç”¨ä½æ“ä½œï¼Œå°†<code>blockDim.x/2</code>å’Œ<code>offset/=2</code>åˆ†åˆ«å†™æˆäº†<code>blockDim.x&gt;&gt;1</code>å’Œ<code>offset&gt;&gt;=1</code>ï¼Œåœ¨æ ¸å‡½æ•°ä¸­ï¼Œ<strong>ä½æ“ä½œæ¯”å¯¹åº”çš„æ•´æ•°æ“ä½œé«˜æ•ˆ</strong>ã€‚å½“æ‰€æ¶‰åŠçš„å˜é‡åœ¨ç¼–è¯‘æœŸé—´å°±çŸ¥é“å…¶å¯èƒ½çš„å–å€¼ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ç”¨ä¼ªæ“ä½œå–ä»£ç›¸åº”çš„æ•´æ•°æ“ä½œ</li></ul><h3 id="8-1-2-ä½¿ç”¨å…±äº«å†…å­˜"><a href="#8-1-2-ä½¿ç”¨å…±äº«å†…å­˜" class="headerlink" title="8.1.2 ä½¿ç”¨å…±äº«å†…å­˜"></a>8.1.2 ä½¿ç”¨å…±äº«å†…å­˜</h3><p>å…±äº«å†…å­˜çš„ä¸»è¦ä½œç”¨ï¼šâ‘ å‡å°‘æ ¸å‡½æ•°ä¸­å¯¹å…¨å±€å†…å­˜çš„è®¿é—®æ¬¡æ•°â‘¡æé«˜å…¨å±€è®¿é—®çš„åˆå¹¶åº¦<br>å…±äº«å†…å­˜çš„ç‰¹ç‚¹ï¼šå¯¹æ•´ä¸ªçº¿ç¨‹å—å¯è§ï¼Œæ¯ä¸ªçº¿ç¨‹å—éƒ½æœ‰ä¸€ä¸ªå…±äº«å†…å­˜å˜é‡çš„å‰¯æœ¬<br>å®šä¹‰å…±äº«å†…å­˜å˜é‡<code>__shared__</code></p><ul><li>åœ¨ä¸€ä¸ªæ ¸å‡½æ•°ä¸­å®šä¹‰ä¸€ä¸ªå…±äº«å†…å­˜å˜é‡ï¼Œå°±ç›¸å½“äºåœ¨<strong>æ¯ä¸ªçº¿ç¨‹å—ä¸­æœ‰ä¸€ä¸ªè¯¥å˜é‡çš„å‰¯æœ¬</strong>ï¼Œè™½ç„¶æ¯ä¸ªå‰¯æœ¬å…±ç”¨ä¸€ä¸ªå˜é‡åï¼Œä½†æ˜¯æ¯ä¸ªå‰¯æœ¬éƒ½ä¸ä¸€æ ·</li><li>æ ¸å‡½æ•°ä¸­ï¼Œå¯¹å…±äº«å†…å­˜å˜é‡çš„æ“ä½œéƒ½æ˜¯<strong>åŒæ—¶ä½œç”¨åœ¨æ‰€æœ‰çš„å‰¯æœ¬ä¸Š</strong>çš„<pre class="line-numbers language-c" data-language="c"><code class="language-c">__global__ <span class="token keyword">void</span> <span class="token function">reduce_shared</span><span class="token punctuation">(</span>real <span class="token operator">*</span>d_x<span class="token punctuation">,</span> real <span class="token operator">*</span>d_y<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">const</span> <span class="token keyword">int</span> tid <span class="token operator">=</span> threadIdx<span class="token punctuation">.</span>x<span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">int</span> bid <span class="token operator">=</span> blockIdx<span class="token punctuation">.</span>x<span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">int</span> n <span class="token operator">=</span> bid<span class="token operator">*</span>blockDimx<span class="token punctuation">.</span>x <span class="token operator">+</span> tid<span class="token punctuation">;</span>__shared__ real s_y<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// å…±äº«å†…å­˜çš„æ•°ç»„é•¿åº¦ä¸æ ¸å‡½æ•°çš„æ‰§è¡Œé…ç½®å‚æ•°blockDim.xä¸€æ ·ï¼Œå¦‚æœè¿™é‡Œå†™é”™äº†ï¼Œä¼šå¼•èµ·é”™è¯¯æˆ–é™ä½æ ¸å‡½æ•°æ€§èƒ½</span>s_y<span class="token punctuation">[</span>tid<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>n<span class="token operator">&lt;</span>N<span class="token punctuation">)</span> <span class="token operator">?</span> d_x<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token number">0.0</span><span class="token punctuation">;</span> <span class="token comment">// å°†å…¨å±€å†…å­˜ä¸­çš„æ•°æ®å¤åˆ¶åˆ°å…±äº«å†…å­˜ä¸­</span><span class="token function">__syncthreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> offset <span class="token operator">=</span> blockDim<span class="token punctuation">.</span>x <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span>tid <span class="token operator">&lt;</span> offset<span class="token punctuation">)</span><span class="token punctuation">{</span>s_y<span class="token punctuation">[</span>tid<span class="token punctuation">]</span> <span class="token operator">+=</span> s_y<span class="token punctuation">[</span>tid <span class="token operator">+</span> offset<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">__syncthreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span>tid<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>d_y<span class="token punctuation">[</span>tid<span class="token punctuation">]</span> <span class="token operator">=</span> s_y<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/345a4268a6a5f1d9ad0e183fb311f40.jpg"></li><li>ä¸€èˆ¬æ¥è¯´ï¼Œåœ¨æ ¸å‡½æ•°ä¸­å¯¹å…±äº«å†…å­˜è®¿é—®çš„æ¬¡æ•°è¶Šå¤šï¼Œåˆ™ç”±äºä½¿ç”¨å…±äº«å†…å­˜å¸¦æ¥çš„åŠ é€Ÿæ•ˆæœè¶Šæ˜æ˜¾</li><li>å› ä¸ºæœ‰<code>n&lt;N</code>çš„åˆ¤æ–­ï¼Œè¯¥å‡½æ•°èƒ½å¤Ÿå¤„ç†<code>N</code>ä¸æ˜¯çº¿ç¨‹å—å¤§å°çš„æ•´æ•°å€çš„æƒ…å½¢</li></ul><h3 id="8-1-3-ä½¿ç”¨åŠ¨æ€å…±äº«å†…å­˜"><a href="#8-1-3-ä½¿ç”¨åŠ¨æ€å…±äº«å†…å­˜" class="headerlink" title="8.1.3 ä½¿ç”¨åŠ¨æ€å…±äº«å†…å­˜"></a>8.1.3 ä½¿ç”¨åŠ¨æ€å…±äº«å†…å­˜</h3><p>ä½¿ç”¨åŠ¨æ€å…±äº«å†…å­˜å¯ä»¥å‡å°‘8.1.2ä¸­â€œ<strong>å…±äº«å†…å­˜çš„æ•°ç»„é•¿åº¦</strong>ä¸æ ¸å‡½æ•°çš„æ‰§è¡Œé…ç½®å‚æ•°éœ€ä¸<strong>blockDim.x</strong>ä¸€æ ·ï¼Œå¦‚æœè¿™é‡Œå†™é”™äº†ï¼Œä¼šå¼•èµ·é”™è¯¯æˆ–é™ä½æ ¸å‡½æ•°æ€§èƒ½â€é”™è¯¯å‘ç”Ÿçš„æ¦‚ç‡</p><p>å°†é™æ€å†…å­˜æ”¹ä¸ºåŠ¨æ€å†…å­˜çš„ä¿®æ”¹ï¼š</p><ul><li><code>&lt;&lt;&lt;grid_size, block_size, sizeof(real) * block_size&gt;&gt;&gt;</code>ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°å°±æ˜¯æ ¸å‡½æ•°ä¸­æ¯ä¸ªçº¿ç¨‹å—éœ€è¦å®šä¹‰çš„åŠ¨æ€å…±äº«å†…å­˜çš„å­—èŠ‚æ•°</li><li>æ”¹å˜æ ¸å‡½æ•°ä¸­å…±äº«å†…å­˜å˜é‡çš„å£°æ˜æ–¹å¼<ul><li>é™æ€ï¼š<code>__shared__ real s_y[128];</code></li><li>åŠ¨æ€ï¼š`extern <strong>shared</strong> real s_y[];</li></ul></li></ul><p>å•ç²¾åº¦ğŸ‘‡<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240919200305.png" alt="|375"><br>åŒç²¾åº¦ğŸ‘‡<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240919200331.png" alt="375"></p><h2 id="8-2-ä½¿ç”¨å…±äº«å†…å­˜è¿›è¡ŒçŸ©é˜µè½¬ç½®"><a href="#8-2-ä½¿ç”¨å…±äº«å†…å­˜è¿›è¡ŒçŸ©é˜µè½¬ç½®" class="headerlink" title="8.2 ä½¿ç”¨å…±äº«å†…å­˜è¿›è¡ŒçŸ©é˜µè½¬ç½®"></a>8.2 ä½¿ç”¨å…±äº«å†…å­˜è¿›è¡ŒçŸ©é˜µè½¬ç½®</h2><p>åˆ©ç”¨å…±äº«å†…å­˜å¯ä»¥æ”¹å–„å…¨å±€å†…å­˜çš„è®¿é—®æ¨¡å¼ï¼Œä½¿å¾—å¯¹å…¨å±€å†…å­˜çš„è¯»å’Œå†™éƒ½æ˜¯åˆå¹¶çš„</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">__gobal__ <span class="token keyword">void</span> <span class="token function">transpose1</span><span class="token punctuation">(</span><span class="token keyword">const</span> real <span class="token operator">*</span>A<span class="token punctuation">,</span> real <span class="token operator">*</span>B<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> N<span class="token punctuation">)</span><span class="token punctuation">{</span>__shared__ real S<span class="token punctuation">[</span>TILE_DIM<span class="token punctuation">]</span><span class="token punctuation">[</span>TILE_DIM<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// ç”¨ä¸€ä¸ªçº¿ç¨‹å—å¤„ç†ä¸€ç‰‡32x32çš„çŸ©é˜µ</span><span class="token keyword">int</span> bx <span class="token operator">=</span> blockIdx<span class="token punctuation">.</span>x <span class="token operator">*</span> TILE_DIM<span class="token punctuation">;</span><span class="token keyword">int</span> by <span class="token operator">=</span> blockIdx<span class="token punctuation">.</span>y <span class="token operator">*</span> TILE_DIM<span class="token punctuation">;</span><span class="token keyword">int</span> nx1 <span class="token operator">=</span> bx <span class="token operator">+</span> threadIdx<span class="token punctuation">.</span>x<span class="token punctuation">;</span><span class="token keyword">int</span> ny1 <span class="token operator">=</span> by <span class="token operator">+</span> threadIdx<span class="token punctuation">.</span>y<span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>nx1 <span class="token operator">&lt;</span> N <span class="token operator">&amp;&amp;</span> ny1 <span class="token operator">&lt;</span> N<span class="token punctuation">)</span><span class="token punctuation">{</span>S<span class="token punctuation">[</span>threadIdx<span class="token punctuation">.</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>threadIdx<span class="token punctuation">.</span>x<span class="token punctuation">]</span> <span class="token operator">=</span> A<span class="token punctuation">[</span>ny1 <span class="token operator">*</span> N <span class="token operator">+</span> nx1<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// å› ä¸ºç›¸é‚»çš„threadIdx.xä¸å…¨å±€å†…å­˜ä¸­ç›¸é‚»çš„æ•°æ®å¯¹åº”ï¼Œæ‰€ä»¥è¿™é‡Œå¯¹å…¨å±€å†…å­˜çš„è®¿é—®æ˜¯åˆå¹¶çš„</span><span class="token punctuation">}</span><span class="token function">__syncthreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> nx2 <span class="token operator">=</span> bx <span class="token operator">+</span> threadIdx<span class="token punctuation">.</span>y<span class="token punctuation">;</span><span class="token keyword">int</span> ny2 <span class="token operator">=</span> by <span class="token operator">+</span> threadIdx<span class="token punctuation">.</span>x<span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>nx2 <span class="token operator">&lt;</span> N <span class="token operator">&amp;&amp;</span> ny2 <span class="token operator">&lt;</span> N<span class="token punctuation">)</span><span class="token punctuation">{</span>B<span class="token punctuation">[</span>nx2 <span class="token operator">*</span> N <span class="token operator">+</span> ny2<span class="token punctuation">]</span> <span class="token operator">=</span> S<span class="token punctuation">[</span>threadIdx<span class="token punctuation">.</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>threadIdx<span class="token punctuation">.</span>y<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šè¿°ä»£ç çš„èŠ‚é€‰éƒ¨åˆ†ğŸ‘‡</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> nx2 <span class="token operator">=</span> bx <span class="token operator">+</span> threadIdx<span class="token punctuation">.</span>y<span class="token punctuation">;</span><span class="token keyword">int</span> ny2 <span class="token operator">=</span> by <span class="token operator">+</span> threadIdx<span class="token punctuation">.</span>x<span class="token punctuation">;</span><span class="token comment">// ä¸Šé¢è¿™ä¸¤è¡Œæ”¹å˜äº†å¯¹å…¨å±€å†…å­˜çš„è®¿é—®æ–¹å¼</span><span class="token comment">// è¿™é‡Œçš„bxå’Œbyæ ¹æ®blockIdx.xå’ŒblockIdx.yçš„å˜åŒ–è€Œå˜åŒ–ã€‚å¯ä»¥è§†ä¸ºæŸä¸ªçº¿ç¨‹å—åœ¨å…¨å±€ä¸­çš„åç§»é‡</span><span class="token keyword">if</span><span class="token punctuation">(</span>nx2 <span class="token operator">&lt;</span> N <span class="token operator">&amp;&amp;</span> ny2 <span class="token operator">&lt;</span> N<span class="token punctuation">)</span><span class="token punctuation">{</span>B<span class="token punctuation">[</span>nx2 <span class="token operator">*</span> N <span class="token operator">+</span> ny2<span class="token punctuation">]</span> <span class="token operator">=</span> S<span class="token punctuation">[</span>threadIdx<span class="token punctuation">.</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>threadIdx<span class="token punctuation">.</span>y<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// ç›¸é‚»çš„threadIdx.xä¸å…¨å±€å†…å­˜ä¸­çš„æ•°ç»„Bä¸­çš„ç›¸é‚»çš„æ•°æ®å¯¹åº”</span><span class="token comment">//Bçš„ç›¸é‚»æ˜¯ny2ï¼Œny2åˆå’ŒthreadIdx.xä¸€è‡´ç›¸é‚»</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç¬¬ä¸ƒç« <code>transpose1()</code>ç›¸å…³éƒ¨åˆ†ğŸ‘‡</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">__global__ <span class="token keyword">void</span> <span class="token function">transpose1</span><span class="token punctuation">(</span><span class="token keyword">const</span> real<span class="token operator">*</span> A<span class="token punctuation">,</span> real<span class="token operator">*</span> B<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> N<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">const</span> <span class="token keyword">int</span> nx <span class="token operator">=</span> blockIdx<span class="token punctuation">.</span>x <span class="token operator">*</span> blockDim<span class="token punctuation">.</span>x <span class="token operator">+</span> threadIdx<span class="token punctuation">.</span>x<span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token keyword">int</span> ny <span class="token operator">=</span> blockIdx<span class="token punctuation">.</span>y <span class="token operator">*</span> blockDim<span class="token punctuation">.</span>y <span class="token operator">+</span> threadIdx<span class="token punctuation">.</span>y<span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>nx <span class="token operator">&lt;</span> N <span class="token operator">&amp;&amp;</span> ny <span class="token operator">&lt;</span> N<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        B<span class="token punctuation">[</span>nx <span class="token operator">*</span> N <span class="token operator">+</span> ny<span class="token punctuation">]</span> <span class="token operator">=</span> A<span class="token punctuation">[</span>ny <span class="token operator">*</span> N <span class="token operator">+</span> nx<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è·Ÿä¸Šé¢ä»£ç ä¸€æ ·çš„å†™æ³•ğŸ‘‡</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> nx2 <span class="token operator">=</span> bx <span class="token operator">+</span> threadIdx<span class="token punctuation">.</span>x<span class="token punctuation">;</span><span class="token keyword">int</span> ny2 <span class="token operator">=</span> by <span class="token operator">+</span> threadIdx<span class="token punctuation">.</span>y<span class="token punctuation">;</span><span class="token comment">// è¿™æ ·å­å®šä¹‰nx2å’Œny2çš„è¯å’Œä¸Šé¢å…¨å±€å†…å­˜çš„è®¿é—®æ–¹å¼ä¸€æ ·</span><span class="token keyword">if</span><span class="token punctuation">(</span>nx2 <span class="token operator">&lt;</span> N <span class="token operator">&amp;&amp;</span> ny2 <span class="token operator">&lt;</span> N<span class="token punctuation">)</span><span class="token punctuation">{</span>B<span class="token punctuation">[</span>nx2 <span class="token operator">*</span> N <span class="token operator">+</span> ny2<span class="token punctuation">]</span> <span class="token operator">=</span> S<span class="token punctuation">[</span>threadIdx<span class="token punctuation">.</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>threadIdx<span class="token punctuation">.</span>x<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="8-3-é¿å…å…±äº«å†…å­˜çš„bankå†²çª"><a href="#8-3-é¿å…å…±äº«å†…å­˜çš„bankå†²çª" class="headerlink" title="8.3 é¿å…å…±äº«å†…å­˜çš„bankå†²çª"></a>8.3 é¿å…å…±äº«å†…å­˜çš„bankå†²çª</h2><p>ä¸ºäº†è·å¾—é«˜çš„å†…å­˜å¸¦å®½ï¼Œå…±äº«å†…å­˜åœ¨ç‰©ç†ä¸Šè¢«åˆ†ä¸º32ä¸ª(åˆšå¥½ç­‰äºä¸€ä¸ªçº¿ç¨‹æŸä¸­çš„çº¿ç¨‹æ•°ç›®32)åŒæ ·å®½åº¦çš„ã€èƒ½è¢«åŒæ—¶è®¿é—®çš„å†…å­˜bank</p><ul><li>å•ç²¾åº¦ğŸ‘‡<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240913182434.png" alt="|350"></li><li>åŒç²¾åº¦ğŸ‘‡<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240913182530.png" alt="|350"><br><code>bank</code>å®½åº¦ä¸º4å­—èŠ‚çš„æ¶æ„ï¼Œ$\dfrac{128å­—èŠ‚(å®šä¹‰çš„å…±äº«å†…å­˜æ•°ç»„çš„å¤§å°)}{32bank(å¤§å°å’Œä¸€ä¸ªçº¿ç¨‹æŸä¸­çš„çº¿ç¨‹æ•°ç›®ç›¸åŒ)}=4å­—èŠ‚/bank$</li><li>åªè¦åŒä¸€ä¸ªçº¿ç¨‹æŸå†…çš„å¤šä¸ªçº¿ç¨‹<strong>ä¸åŒæ—¶</strong>è®¿é—®åŒä¸€ä¸ª<code>bank</code>ä¸­ä¸åŒå±‚çš„æ•°æ®ï¼Œè¯¥çº¿ç¨‹æŸå¯¹å…±äº«å†…å­˜çš„è®¿é—®å°±åªéœ€è¦<strong>ä¸€æ¬¡</strong>å†…å­˜äº‹åŠ¡</li><li>å½“åŒä¸€çº¿ç¨‹çš„å¤šä¸ªçº¿ç¨‹æ•°è¯•å›¾è®¿é—®åŒä¸€ä¸ª<code>bank</code>ä¸­ä¸åŒå±‚(nå±‚)çš„æ•°æ®(å°†å¯¼è‡´næ¬¡å†…å­˜äº‹åŠ¡)ï¼Œä¼šå‘ç”Ÿbankå†²çª(nè·¯bankå†²çª)</li><li>ä¸Šé¢çš„<code>transpose with shared memory bank conflit</code>æ˜¯å‘ç”Ÿäº†32è·¯bankå†²çª<ul><li><code>B[nx2 * N + ny2] = S[threadIdx.x][threadIdx.y]</code></li><li>åŒä¸€ä¸ªçº¿ç¨‹æŸçš„32ä¸ªçº¿ç¨‹(è¿ç»­çš„32ä¸ª<code>threadIdx.x</code>å€¼)å¯¹åº”<code>S</code>ä¸­è·¨åº¦ä¸º32çš„æ•°æ®(<code>[threadIdx.y]</code>)</li></ul></li><li>äºæ˜¯å°†<code>__shared__ real S[TILE_DIM][TILE_DIM]</code>æ”¹ä¸º<code>__shared__ real S[TILE_DIM][TILE_DIM + 1]</code><ul><li>åŒä¸€ä¸ªçº¿ç¨‹æŸçš„32ä¸ªçº¿ç¨‹(è¿ç»­çš„32ä¸ª<code>threadIdx.x</code>)å¯¹åº”<code>S</code>ä¸­è·¨åº¦ä¸º33çš„æ•°æ®</li><li>å¦‚æœç¬¬ä¸€ä¸ªçº¿ç¨‹è®¿é—®ç¬¬ä¸€ä¸ª<code>bank</code>çš„ç¬¬ä¸€å±‚ï¼Œç¬¬äºŒä¸ªçº¿ç¨‹åˆ™ä¼šè®¿é—®ç¬¬äºŒä¸ª<code>bank</code>çš„ç¬¬äºŒå±‚ï¼Œè€Œä¸æ˜¯ç¬¬ä¸€ä¸ª<code>bank</code>çš„ç¬¬äºŒå±‚ï¼Œä»¥æ­¤ç±»æ¨ï¼Œæ²¡æœ‰<code>bank</code>å†²çª<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E6%A1%A3_1.jpg"><br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E6%A1%A3_2.jpg"><br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E6%A1%A3_3.jpg"><br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E6%A1%A3_4.jpg"><br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E6%A1%A3_5.jpg"></li></ul></li></ul><h1 id="ç¬¬ä¹ç« -åŸå­å‡½æ•°çš„åˆç†ä½¿ç”¨"><a href="#ç¬¬ä¹ç« -åŸå­å‡½æ•°çš„åˆç†ä½¿ç”¨" class="headerlink" title="ç¬¬ä¹ç«  åŸå­å‡½æ•°çš„åˆç†ä½¿ç”¨"></a>ç¬¬ä¹ç«  åŸå­å‡½æ•°çš„åˆç†ä½¿ç”¨</h1><h2 id="9-1-å®Œå…¨åœ¨GPUä¸­è¿›è¡Œå½’çº¦"><a href="#9-1-å®Œå…¨åœ¨GPUä¸­è¿›è¡Œå½’çº¦" class="headerlink" title="9.1 å®Œå…¨åœ¨GPUä¸­è¿›è¡Œå½’çº¦"></a>9.1 å®Œå…¨åœ¨GPUä¸­è¿›è¡Œå½’çº¦</h2><ul><li>æœ¬ä¹¦ä½¿ç”¨åœ¨å…ˆå‰çš„æ ¸å‡½æ•°çš„æœ«å°¾åˆ©ç”¨<strong>åŸå­å‡½æ•°</strong>è¿›è¡Œå½’çº¦ç›´æ¥å¾—åˆ°æœ€ç»ˆçš„ç»“æœçš„æ–¹æ³•</li><li>ä¸èƒ½ä½¿ç”¨ğŸ‘‡çš„åŸå› ï¼šä¸ç®¡æ¯ä¸ªçº¿ç¨‹å—ç¬¬0å·çº¿ç¨‹çš„æ‰§è¡Œæ¬¡åºå¦‚ä½•ï¼Œåªæœ‰å½“ä¸€ä¸ªçº¿ç¨‹çš„â€œè¯»-å†™â€æ“ä½œä¸è¢«å…¶ä»–çº¿ç¨‹å¹²æ‰°æ—¶ï¼Œæ‰èƒ½å¾—åˆ°æ­£ç¡®ç»“æœ<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span><span class="token punctuation">(</span>tid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>d_y<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+=</span> s_y<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>å¦‚æœå­˜åœ¨ä¸¤ä¸ªçº¿ç¨‹å—ç¬¬0å·çº¿ç¨‹åŒæ—¶è¯»å–d_y[0]çš„å€¼ï¼Œé‚£ç»“æœå°±æ˜¯é”™è¯¯çš„</li><li>åŸå­å‡½æ•°<code>atomicAdd(address, val)</code>ï¼š<ul><li>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¾…ç´¯åŠ çš„å˜é‡çš„åœ°å€</li><li>ç¬¬äºŒä¸ªå‚æ•°æ˜¯ç´¯åŠ çš„å€¼</li><li>â€œåœ¨è°ƒç”¨è¯¥ç‰ˆæœ¬çš„æ ¸å‡½æ•°ä¹‹å‰ï¼Œå¿…é¡»å°†<code>d_y[0]</code>çš„å€¼åˆå§‹åŒ–ä¸º0â€</li><li>ğŸ‘‡<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span><span class="token punctuation">(</span>tid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// threadIdx.x = 0ï¼Œä¿è¯æ¯ä¸ªçº¿ç¨‹å—çš„s_y[0]åªç´¯åŠ ä¸€æ¬¡</span><span class="token punctuation">{</span><span class="token function">atomicAdd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d_y<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> s_y<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//&amp;d_y[0]å¯ä»¥å†™æˆd_y(æ•°ç»„åæ˜¯æ•°ç»„é¦–ä¸ªå…ƒç´ çš„åœ°å€)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>ä»£ç ä¸­ï¼š<br><code>d_x</code>æ˜¯é•¿åº¦ä¸º<code>M</code>çš„æ•°ç»„ã€<code>N</code>ä¸ºå…ƒç´ ä¸ªæ•°</li></ul></li><li>åˆå§‹åŒ–<code>h_x</code>ï¼Œå¤åˆ¶ç»™<code>d_x</code></li><li><strong><code>timing(d_x)</code>ï¼š</strong><ul><li>é‡å¤<code>NUM_REPEATS</code>æ¬¡</li><li>åˆ›å»ºäº‹ä»¶ã€è®¡æ—¶ã€æŸ¥è¯¢</li><li><strong><code>reduce(d_x)</code>ã€</strong><ul><li>å®šä¹‰ç½‘æ ¼å¤§å°</li><li><code>h_y[1]</code>ä½œç”¨æ˜¯ä¼ ä¸€ä¸ªåˆå§‹å€¼ä¸º0çš„å€¼ç»™<code>d_y</code>ï¼Œæ»¡è¶³<code>d_y[0]</code>çš„å€¼åˆå§‹åŒ–ä¸º0çš„è¦æ±‚<ul><li><strong><code>reduce(d_x, d_y, N)</code>ï¼šåŠ¨æ€å†…å­˜<code>&lt;&lt;&lt;grid_size, block_size, sizeof(real) * block_size&gt;&gt;&gt;</code></strong><ul><li>ä½¿ç”¨åŠ¨æ€å†…å­˜è¿›è¡ŒæŠ˜åŠç›¸åŠ </li><li>ä½¿ç”¨<code>atomicAdd</code>å¯¹æ¯ä¸ªçº¿ç¨‹å—çš„é¦–ä¸ªå…ƒç´ ç›¸åŠ å¾—åˆ°æœ€ç»ˆç»“æœ</li></ul></li></ul></li><li>å°†ç»“æœä»<code>d_y</code>å¤åˆ¶å›<code>h_y</code>ä¸­</li><li>é‡Šæ”¾å†…å­˜</li></ul></li><li>ç»“æŸè®¡æ—¶ï¼Œæ‰“å°è®¡æ—¶ç»“æœå’Œæœ€åä¸€æ¬¡çš„æ±‚å’Œç»“æœ</li></ul></li><li>é‡Šæ”¾<code>d_x</code>å’Œ<code>h_x</code>çš„å†…å­˜</li></ul><p>å•ç²¾åº¦ğŸ‘‡<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240919200542.png" alt="375"><br>åŒç²¾åº¦ğŸ‘‡<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240919200554.png" alt="375"><br>ç¡®å®æ˜¯æ¯”å…ˆå‰çš„æå‡çº¦2ms</p><h2 id="9-3-ä¾‹å­ï¼šé‚»å±…åˆ—è¡¨çš„å»ºç«‹"><a href="#9-3-ä¾‹å­ï¼šé‚»å±…åˆ—è¡¨çš„å»ºç«‹" class="headerlink" title="9.3 ä¾‹å­ï¼šé‚»å±…åˆ—è¡¨çš„å»ºç«‹"></a>9.3 ä¾‹å­ï¼šé‚»å±…åˆ—è¡¨çš„å»ºç«‹</h2><p><code>MN</code>æ˜¯æ¯ä¸ªåŸå­çš„æœ€å¤šé‚»å±…åŸå­æ•°<br><code>NN[n]</code>æ˜¯ç¬¬nä¸ªç²’å­çš„é‚»å±…ä¸ªæ•°<br><code>NL[n * MN + k]</code>æ˜¯ç¬¬nä¸ªç²’å­çš„ç¬¬kä¸ªé‚»å±…çš„æŒ‡æ ‡</p><h3 id="9-3-1-C-ç‰ˆæœ¬çš„å¼€å‘"><a href="#9-3-1-C-ç‰ˆæœ¬çš„å¼€å‘" class="headerlink" title="9.3.1 C++ç‰ˆæœ¬çš„å¼€å‘"></a>9.3.1 C++ç‰ˆæœ¬çš„å¼€å‘</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">find_neighbor</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>NN<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>NL<span class="token punctuation">,</span> <span class="token keyword">const</span> real<span class="token operator">*</span> x<span class="token punctuation">,</span> <span class="token keyword">const</span> real<span class="token operator">*</span> y<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> n<span class="token operator">++</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        NN<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token comment">// n1å’Œn2ä»£è¡¨ä¸¤ä¸ªå¯èƒ½äº’ä¸ºé‚»å±…çš„åŸå­</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> n1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> n1 <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> <span class="token operator">++</span>n1<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        real x1 <span class="token operator">=</span> x<span class="token punctuation">[</span>n1<span class="token punctuation">]</span><span class="token punctuation">;</span>        real y1 <span class="token operator">=</span> y<span class="token punctuation">[</span>n1<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> n2 <span class="token operator">=</span> n1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> n2 <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> <span class="token operator">++</span>n2<span class="token punctuation">)</span> <span class="token comment">// å› ä¸ºn1å’Œn2äº’ä¸ºé‚»å±…ï¼Œæ‰€ä»¥åªè€ƒè™‘n2&gt;n1çš„æƒ…å½¢</span>        <span class="token punctuation">{</span>            real x12 <span class="token operator">=</span> x<span class="token punctuation">[</span>n2<span class="token punctuation">]</span> <span class="token operator">-</span> x1<span class="token punctuation">;</span>            real y12 <span class="token operator">=</span> y<span class="token punctuation">[</span>n2<span class="token punctuation">]</span> <span class="token operator">-</span> y1<span class="token punctuation">;</span>            real distance_square <span class="token operator">=</span> x12 <span class="token operator">*</span> x12 <span class="token operator">+</span> y12 <span class="token operator">*</span> y12<span class="token punctuation">;</span> <span class="token comment">// </span>            <span class="token keyword">if</span><span class="token punctuation">(</span>distance_square <span class="token operator">&lt;</span> cutoff_square<span class="token punctuation">)</span>            <span class="token punctuation">{</span>                NL<span class="token punctuation">[</span>n1 <span class="token operator">*</span> MN <span class="token operator">+</span> NN<span class="token punctuation">[</span>n1<span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> n2<span class="token punctuation">;</span> <span class="token comment">// å…ˆæ·»åŠ é‚»å±…ä¿¡æ¯ï¼Œå†å¯¹é‚»å±…ä¸ªæ•°++</span>                NL<span class="token punctuation">[</span>n2 <span class="token operator">*</span> MN <span class="token operator">+</span> NN<span class="token punctuation">[</span>n2<span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> n1<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="9-3-2-åˆ©ç”¨åŸå­æ“ä½œçš„CUDAç‰ˆæœ¬"><a href="#9-3-2-åˆ©ç”¨åŸå­æ“ä½œçš„CUDAç‰ˆæœ¬" class="headerlink" title="9.3.2 åˆ©ç”¨åŸå­æ“ä½œçš„CUDAç‰ˆæœ¬"></a>9.3.2 åˆ©ç”¨åŸå­æ“ä½œçš„CUDAç‰ˆæœ¬</h3><p>å¦‚æœä»ç„¶ä½¿ç”¨9.3.1ä¸­çš„<code>find_neighbor</code>å‡½æ•°ï¼Œä¼šå¯¼è‡´â€œ<strong>å¹¶å‘å†™å…¥å†²çª</strong>â€<br>ä¸€ä¸ªçº¿ç¨‹ä¸ä¸€ä¸ªåŸå­å¯¹åº”</p><ul><li>ä¸n1å¯¹åº”çš„çº¿ç¨‹ğŸ‘‡<pre class="line-numbers language-c" data-language="c"><code class="language-c">d_NL<span class="token punctuation">[</span>n1 <span class="token operator">*</span> MN <span class="token operator">+</span> NN<span class="token punctuation">[</span>n1<span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> n2<span class="token punctuation">;</span> d_NL<span class="token punctuation">[</span>n2 <span class="token operator">*</span> MN <span class="token operator">+</span> NN<span class="token punctuation">[</span>n2<span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> n1<span class="token punctuation">;</span> <span class="token comment">// ç¬¬äºŒæ¡è¯­å¥</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li>ä¸n2å¯¹åº”çš„çº¿ç¨‹ğŸ‘‡<pre class="line-numbers language-c" data-language="c"><code class="language-c">d_NL<span class="token punctuation">[</span>n2 <span class="token operator">*</span> MN <span class="token operator">+</span> NN<span class="token punctuation">[</span>n2<span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> n1<span class="token punctuation">;</span> <span class="token comment">// ç¬¬ä¸€æ¡è¯­å¥</span>d_NL<span class="token punctuation">[</span>n1 <span class="token operator">*</span> MN <span class="token operator">+</span> NN<span class="token punctuation">[</span>n1<span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> n2<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>ä¹¦ä¸ŠåŸè¯â€œåœ¨ä¸<code>n1</code>å¯¹åº”çš„çº¿ç¨‹ä¸­ï¼Œç¬¬äºŒæ¡è¯­å¥ä»£è¡¨æˆ‘ä»¬è¯•å›¾å¯¹<code>d_NN[n2]</code>è¿›è¡Œç´¯åŠ æ“ä½œã€‚ä½†æ˜¯ï¼Œåœ¨ä¸<code>n2</code>å¯¹åº”çš„çº¿ç¨‹ä¸­ï¼Œç¬¬ä¸€æ¡è¯­å¥ä»£è¡¨æˆ‘ä»¬ä¹Ÿè¯•å›¾å¯¹<code>d_NN[n2]</code>è¿›è¡Œç´¯åŠ æ“ä½œâ€<br>éœ€è¦ç”¨åŸå­å‡½æ•°ï¼š<pre class="line-numbers language-c" data-language="c"><code class="language-c">d_NL<span class="token punctuation">[</span>n1 <span class="token operator">*</span> MN <span class="token operator">+</span> d_NN<span class="token punctuation">[</span>n1<span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> n2<span class="token punctuation">;</span>d_NL<span class="token punctuation">[</span>n2 <span class="token operator">*</span> MN <span class="token operator">+</span> d_NN<span class="token punctuation">[</span>n2<span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> n1<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ul><p>åˆç†åˆ©ç”¨è¿”å›å€¼ï¼š<br>å¯ä»¥å°†ğŸ‘‡ä»£ç </p><pre class="line-numbers language-c" data-language="c"><code class="language-c">NL<span class="token punctuation">[</span>n1 <span class="token operator">*</span> MN <span class="token operator">+</span> NN<span class="token punctuation">[</span>n1<span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> n2<span class="token punctuation">;</span>NL<span class="token punctuation">[</span>n2 <span class="token operator">*</span> MN <span class="token operator">+</span> NN<span class="token punctuation">[</span>n2<span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> n1<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>æ”¹å†™ä¸ºğŸ‘‡</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">NL<span class="token punctuation">[</span>n1 <span class="token operator">*</span> MN <span class="token operator">+</span> NN<span class="token punctuation">[</span>n1<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> n2<span class="token punctuation">;</span>NN<span class="token punctuation">[</span>n1<span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">;</span>NL<span class="token punctuation">[</span>n2 <span class="token operator">*</span> MN <span class="token operator">+</span> NN<span class="token punctuation">[</span>n2<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> n1<span class="token punctuation">;</span>NN<span class="token punctuation">[</span>n2<span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>ä½†å¦‚æœç±»ä¼¼åœ°æ”¹å†™åŸå­å‡½æ•°çš„ä»£ç ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">d_NL<span class="token punctuation">[</span>n1 <span class="token operator">*</span> MN <span class="token operator">+</span> <span class="token function">atomicAdd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d_NN<span class="token punctuation">[</span>n1<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> n2<span class="token punctuation">;</span>d_NL<span class="token punctuation">[</span>n2 <span class="token operator">*</span> MN <span class="token operator">+</span> <span class="token function">atomicAdd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d_NN<span class="token punctuation">[</span>n2<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> n1<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ğŸ‘†æ”¹å†™ä¸ºğŸ‘‡</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">d_NL<span class="token punctuation">[</span>n1 <span class="token operator">*</span> MN <span class="token operator">+</span> d_NN<span class="token punctuation">[</span>n1<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> n2<span class="token punctuation">;</span><span class="token function">atomicAdd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d_NN<span class="token punctuation">[</span>n1<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>d_NL<span class="token punctuation">[</span>n2 <span class="token operator">*</span> MN <span class="token operator">+</span> d_NN<span class="token punctuation">[</span>n2<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> n1<span class="token punctuation">;</span><span class="token function">atomicAdd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d_NN<span class="token punctuation">[</span>n2<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>åŸå­å‡½æ•°çš„æ“ä½œæœ¬èº«æ˜¯ç«‹å³ç”Ÿæ•ˆçš„ï¼Œä¸”åœ¨åŸå­æ“ä½œçš„æ‰§è¡Œè¿‡ç¨‹ä¸­å…¶ä»–çº¿ç¨‹æ— æ³•åŒæ—¶ä¿®æ”¹è¯¥å˜é‡</li><li>ä¸åŒçš„çº¿ç¨‹å¯èƒ½ä¼šåŒæ—¶è®¿é—®<code>d_NN[n1]</code>å’Œ<code>d_NN[n2]</code>ï¼Œå¦‚æœä¸¤ä¸ªçº¿ç¨‹å‡ ä¹åŒæ—¶æ‰§è¡Œå¯¹ <code>d_NN[n1]</code> çš„ <code>atomicAdd</code> æ“ä½œï¼Œé‚£ä¹ˆå°½ç®¡æ“ä½œæœ¬èº«æ˜¯åŸå­çš„ï¼Œå®ƒä»¬çš„æ‰§è¡Œé¡ºåºå´æ˜¯ä¸ç¡®å®šçš„ï¼Œä¸€ä¸ªçº¿ç¨‹å¯èƒ½åœ¨å¦ä¸€ä¸ªçº¿ç¨‹æ›´æ–°<code>d_NN[n1]</code>ä¹‹å‰å°±è¯»åˆ°äº†è¯¥å€¼<br>æ­£ç¡®å†™æ³•ğŸ‘‡<pre class="line-numbers language-none"><code class="language-none">int tmp1 = atomicAdd(&amp;d_NN[n1], 1);d_NL[n1 * MN + tmp1] = n2;int tmp2 = atomicAdd(&amp;d_NN[n2], 1);d_NL[n2 * MN + tmp1] = n1;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>ä½¿ç”¨ä¸´æ—¶å˜é‡<code>tmp1</code>å’Œ<code>tmp2</code>ä¿å­˜<code>d_NN[n1]</code>å’Œ<code>d_NN[n2]</code>çš„æ—§å€¼</li></ul><p>å•ç²¾åº¦ğŸ‘‡<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240921115244.png" alt="375"><br>åŒç²¾åº¦ğŸ‘‡<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240921115308.png" alt="375"></p><p>åœ¨æ ¸å‡½æ•°<code>find_neighbor_no_atomic</code>ä¸­ï¼Œ<br>â‘ å°†<code>d_NL[n1 * MN + count++]</code>æ”¹ä¸º<code>d_NL[(count++) * N + n1]</code><br>â‘¡<code>const int n1 = blockIdx.x * blockDim.x + threadIdx.x;</code></p><ul><li>å‰è€…çš„ç´¢å¼•ä¸­ï¼šæ¯ä¸ªçº¿ç¨‹çš„åœ°å€è·¨åº¦ä¸º<code>MN</code></li><li>åè€…çš„ç´¢å¼•ä¸­ï¼šæ¯ä¸ªçº¿ç¨‹åœ¨æ¯æ¬¡å¾ªç¯æ—¶è®¿é—®ç›¸é‚»çš„å†…å­˜ä½ç½®</li></ul><p>å¯¹äº<code>find_neighbor_not_atomic</code><br>â‘ å°†<code>if((distance_square) &lt; cutoff_square &amp;&amp; (n2 != n1))</code><br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240921115244.png" alt="375"><br>æ”¹ä¸º<code>if((n2 != n1) &amp;&amp; (distance_square) &lt; cutoff_square)</code>ï¼Œç”¨æ—¶å˜å¤š<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240921170942.png" alt="375"></p><p>å¯¹æ¯”ä½¿ç”¨å¯„å­˜å™¨å˜é‡ä¸ä¸ä½¿ç”¨å¯„å­˜å™¨å˜é‡<br>ä½¿ç”¨ğŸ‘‡<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240921115244.png" alt="375"><br>ä¸ä½¿ç”¨ğŸ‘‡ï¼Œç”¨æ—¶å˜å¤š<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240921171012.png" alt="375"></p><h1 id="ç¬¬åç« -çº¿ç¨‹æŸåŸºæœ¬å‡½æ•°ä¸åä½œç»„"><a href="#ç¬¬åç« -çº¿ç¨‹æŸåŸºæœ¬å‡½æ•°ä¸åä½œç»„" class="headerlink" title="ç¬¬åç«  çº¿ç¨‹æŸåŸºæœ¬å‡½æ•°ä¸åä½œç»„"></a>ç¬¬åç«  çº¿ç¨‹æŸåŸºæœ¬å‡½æ•°ä¸åä½œç»„</h1><h2 id="10-1-å•æŒ‡ä»¤-å¤šçº¿ç¨‹æ‰§è¡Œæ¨¡å¼"><a href="#10-1-å•æŒ‡ä»¤-å¤šçº¿ç¨‹æ‰§è¡Œæ¨¡å¼" class="headerlink" title="10.1 å•æŒ‡ä»¤-å¤šçº¿ç¨‹æ‰§è¡Œæ¨¡å¼"></a>10.1 å•æŒ‡ä»¤-å¤šçº¿ç¨‹æ‰§è¡Œæ¨¡å¼</h2><p>å¹¶å‘å’ŒåŒæ­¥ï¼š</p><ul><li>å¹¶å‘ï¼šä¾§é‡ä»»åŠ¡çš„(é€»è¾‘)åŒæ—¶è¿›è¡Œï¼Œåœ¨åŒä¸€æ®µæ—¶é—´å†…<strong>å¤šä¸ªä»»åŠ¡äº¤æ›¿è¿›è¡Œ</strong></li><li>åŒæ­¥ï¼šä¾§é‡æ§åˆ¶äººç‰©çš„æ‰§è¡Œé¡ºåºï¼Œä¿è¯å®ƒä»¬åœ¨åˆé€‚çš„æ—¶åˆ»è®¿é—®å…±äº«èµ„æº</li></ul><p>å•æŒ‡ä»¤-å¤šçº¿ç¨‹ï¼šåŒä¸€æ—¶åˆ»ï¼Œä¸€ä¸ªçº¿ç¨‹æŸä¸­çš„çº¿ç¨‹åªèƒ½æ‰§è¡Œä¸€ä¸ªå…±åŒçš„æŒ‡ä»¤æˆ–è€…é—²ç½®<br>åˆ†æ²»å‘æ•£ï¼šä¸€ä¸ªçº¿ç¨‹æŸä¸­çš„çº¿ç¨‹é¡ºåºåœ°æ‰§è¡Œåˆ¤æ–­è¯­å¥ä¸­çš„ä¸åŒåˆ†æ”¯(åˆ†æ”¯æ˜¯ä¾æ¬¡æ‰§è¡Œçš„)</p><p>ä¸€ä¸ªSMå¯ä»¥å¤„ç†ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹å—ï¼Œä¸€ä¸ªçº¿ç¨‹å—ä¸ä¼šè¢«åˆ†é…åˆ°ä¸åŒçš„SMä¸­<br>ä¸€ä¸ªçº¿ç¨‹å—å¯ä»¥æ°›å›´è‹¥å¹²çº¿ç¨‹æŸ</p><h2 id="10-3-æ›´å¤šçº¿ç¨‹æŸå†…çš„åŸºæœ¬å‡½æ•°"><a href="#10-3-æ›´å¤šçº¿ç¨‹æŸå†…çš„åŸºæœ¬å‡½æ•°" class="headerlink" title="10.3 æ›´å¤šçº¿ç¨‹æŸå†…çš„åŸºæœ¬å‡½æ•°"></a>10.3 æ›´å¤šçº¿ç¨‹æŸå†…çš„åŸºæœ¬å‡½æ•°</h2><p><code>mask</code>ä¸ºæ©ç ï¼Œæ˜¯ä¸€ä¸ª32ä½çš„æ— ç¬¦å·æ•´æ•°ï¼Œç”¨äºæŒ‡å®šè¦å‚ä¸è®¡ç®—çš„çº¿ç¨‹ï¼Œæ©ç ä¸­çš„ä¸€ä¸ªäºŒè¿›åˆ¶ä½ä¸º0/1ä»£è¡¨å¯¹åº”çš„çº¿ç¨‹å‚ä¸/ä¸å‚ä¸è®¡ç®—<br>â‘ <code>__ballot_sync(mask, predicate)</code>ï¼šè¿”å›ä¸€ä¸ªæ–°çš„æ©ç </p><ul><li><code>mask</code>å…ˆå†³å®šçº¿ç¨‹æŸå†…ç¬¬n(n=1~32)ä¸ªçº¿ç¨‹æ˜¯å¦å‚ä¸è®¡ç®—(0/1)</li><li><code>predicate</code>ç”¨äºåˆ¤æ–­å‚ä¸è®¡ç®—çš„çº¿ç¨‹æ˜¯å¦æ»¡è¶³æ¡ä»¶ï¼Œå¦‚æœæ»¡è¶³åˆ™è¯¥çº¿ç¨‹å¯¹åº”çš„<code>predicate</code>ä¸º1ï¼Œå¯¹åº”çš„<code>mask</code>å–1çš„æ¯”ç‰¹ä½ï¼Œå¦åˆ™å¯¹åº”çš„<code>predicate</code>ä¸º0ï¼Œå¯¹åº”çš„<code>mask</code>å–0</li></ul><p>â‘¡<code>__all_sync(mask, predicate)</code>ï¼šè¿”å›0/1</p><ul><li>çº¿ç¨‹æŸå†…æ‰€æœ‰å‚ä¸çš„çº¿ç¨‹å¯¹åº”çš„<code>predicate</code>å€¼éƒ½ä¸ä¸º0æ‰è¿”å›1ï¼Œå¦åˆ™è¿”å›0</li><li>ç±»ä¼¼äºé€‰ä¸¾æ“ä½œï¼Œæ‰€æœ‰å‚é€‰äººéƒ½åŒæ„æ—¶é€šè¿‡<ul><li>ä¾‹ï¼š<code>int result = __all_sync(FULL_MASK, tid);</code>å¦‚æœæ‰€æœ‰çº¿ç¨‹çš„ <code>tid</code> éƒ½ä¸ºçœŸï¼ˆéé›¶ï¼‰ï¼Œå‡½æ•°è¿”å› 1ï¼Œè¡¨ç¤ºæ¡ä»¶å¯¹æ‰€æœ‰çº¿ç¨‹éƒ½æ»¡è¶³ï¼›å¦åˆ™è¿”å› 0ï¼Œè¡¨ç¤ºè‡³å°‘æœ‰ä¸€ä¸ªçº¿ç¨‹çš„ <code>tid</code> ä¸ºé›¶ã€‚</li></ul></li></ul><p>â‘¢<code>__any_sync(mask, predicate)</code>ï¼šè¿”å›0/1</p><ul><li>çº¿ç¨‹æŸå†…æ‰€æœ‰å‚ä¸çš„çº¿ç¨‹å¯¹åº”çš„<code>predicate</code>å€¼åªè¦æœ‰ä¸€ä¸ªä¸ä¸º0å°±è¿”å›1ï¼Œå¦‚æœå…¨æ˜¯0æ‰è¿”å›0</li><li>ç±»ä¼¼é€‰ä¸¾æ“ä½œï¼Œåªè¦æœ‰ä¸€ä¸ªå‚é€‰äººåŒæ„å°±é€šè¿‡</li></ul><p>â‘£<code>__shfl_sync(mask, var, srcLane, width);</code>æ¯ä¸ªå­ç»„ä¸­å‚ä¸çš„çº¿ç¨‹è·å–<code>land_id</code>ä¸º<code>srcLane</code>çš„çº¿ç¨‹ä¸­çš„å˜é‡</p><ul><li><code>land_id = threadIdx.x % w; = threadIdx.x &amp; (w - 1);</code></li><li><code>mask</code>ï¼šè¡¨ç¤ºçº¿ç¨‹æŸå†…å‚ä¸çš„çº¿ç¨‹</li><li><code>var</code>ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹çš„å˜é‡</li><li><code>srcLane</code>ï¼šè¡¨ç¤ºä»å“ªä¸ªçº¿ç¨‹ç´¢å¼•è¯»å–<code>v</code>çš„å€¼</li><li><code>width</code>ï¼šè¡¨ç¤ºå‚ä¸è¿™ä¸ª<code>shuffle</code>æ“ä½œçš„<code>warp</code>çš„å®½åº¦<ul><li>ä¾‹ï¼š<code>__shfl_sync(FULL_MASK, tid, 2, 8)</code><ul><li><code>8</code>è¡¨ç¤º<code>__shfl_sync()</code>æ“ä½œåªåœ¨8ä¸ªçº¿ç¨‹çš„å°ç»„ä¸­è¿›è¡Œï¼Œå¯¹äº32çº¿ç¨‹çš„<code>wrap</code>ï¼Œçº¿ç¨‹è¢«åˆ†ä¸º4ç»„æœ‰8ä¸ªçº¿ç¨‹çš„å­ç»„(0-7, 8-15, 16-23, 24-31)</li><li><code>2</code>è¡¨ç¤ºæºçº¿ç¨‹ç´¢å¼•ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šè¯»å–ç¬¬2å·çº¿ç¨‹çš„<code>tid</code>å€¼å¹¶å­˜åˆ°<code>value</code>å˜é‡ä¸­</li><li><code>tid</code>è¡¨ç¤ºæ¯ä¸ªçº¿ç¨‹çš„å±€éƒ¨å˜é‡</li></ul></li></ul></li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c">__global__ <span class="token keyword">void</span> <span class="token function">shuffleExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> tid <span class="token operator">=</span> threadIdx<span class="token punctuation">.</span>x <span class="token operator">%</span> <span class="token number">32</span><span class="token punctuation">;</span>  <span class="token comment">// å‡è®¾æ¯ä¸ªçº¿ç¨‹çš„tidæ˜¯çº¿ç¨‹ç´¢å¼•ï¼ˆ0~31ï¼‰</span>    <span class="token keyword">int</span> value <span class="token operator">=</span> <span class="token function">__shfl_sync</span><span class="token punctuation">(</span><span class="token number">0xFFFFFFFF</span><span class="token punctuation">,</span> tid<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Thread %d got value %d\n"</span><span class="token punctuation">,</span> tid<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">//æ‰“å°ç»“æœğŸ‘‡</span>Thread <span class="token number">0</span> got value <span class="token number">2</span>Thread <span class="token number">1</span> got value <span class="token number">2</span>Thread <span class="token number">2</span> got value <span class="token number">2</span>Thread <span class="token number">3</span> got value <span class="token number">2</span>Thread <span class="token number">4</span> got value <span class="token number">2</span>Thread <span class="token number">5</span> got value <span class="token number">2</span>Thread <span class="token number">6</span> got value <span class="token number">2</span>Thread <span class="token number">7</span> got value <span class="token number">2</span>Thread <span class="token number">8</span> got value <span class="token number">10</span>Thread <span class="token number">9</span> got value <span class="token number">10</span>Thread <span class="token number">10</span> got value <span class="token number">10</span>Thread <span class="token number">11</span> got value <span class="token number">10</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>Thread <span class="token number">30</span> got value <span class="token number">26</span>Thread <span class="token number">31</span> got value <span class="token number">26</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>å°†ä¸€ä¸ªçº¿ç¨‹ä¸­çš„æ•°æ®å¹¿æ’­åˆ°æ‰€æœ‰(åŒ…æ‹¬è‡ªå·±)çº¿ç¨‹</li></ul><p>â‘¤<code>__shfl_up_sync(mask, var, delta, width);</code></p><ul><li><code>delta</code>ï¼šè¡¨ç¤ºæ¯ä¸ªçº¿ç¨‹ä»å‰é¢å¤šå°‘ä¸ªçº¿ç¨‹å¤„è·å–æ•°æ®</li><li><code>width</code>ï¼šå†³å®šäº†<code>warp</code>å†…çš„åˆ†ç»„èŒƒå›´ï¼Œé€šä¿¡åªåœ¨æŒ‡å®šå¤§å°çš„ç»„å†…è¿›è¡Œ<ul><li>ä¾‹ï¼š<code>__shfl_up_sync(mask, var, 1, 8);</code></li></ul></li><li><code>vat</code>ï¼šå†³å®šè·å–çš„æ•°æ®æ¥æº</li></ul><table><thead><tr><th>çº¿ç¨‹ID</th><th>tid</th><th>æ‰§è¡Œåçš„tid</th></tr></thead><tbody><tr><td>0</td><td>0</td><td>0</td></tr><tr><td>1</td><td>1</td><td>0</td></tr><tr><td>2</td><td>2</td><td>1</td></tr><tr><td>3</td><td>3</td><td>2</td></tr></tbody></table><ul><li>æ˜¯ä¸€ç§å°†æ•°æ®å‘ä¸Šå¹³ç§»çš„æ“ä½œ</li></ul><p>â‘¥<code>__shfl_down_sync(mask, var, delta, width);</code></p><ul><li>æ˜¯ä¸€ç§å°†æ•°æ®å‘ä¸‹å¹³ç§»çš„æ“ä½œ</li></ul><p>â‘¦<code>__shfl_xor_sync(mask, var, landMask, width);</code><br>çº¿ç¨‹<code>i</code>ä¸çº¿ç¨‹<code>i ^ landMask</code>(è¿™é‡Œè¡¨ç¤ºå¼‚æˆ–)äº¤æ¢æ•°æ®<br>ä¾‹å­ï¼š<code>landMask=1</code>ã€<code>width=8</code></p><table><thead><tr><th>çº¿ç¨‹ID</th><th>tid</th><th>æ‰§è¡Œåçš„tid</th></tr></thead><tbody><tr><td>0</td><td>0</td><td>1</td></tr><tr><td>1</td><td>1</td><td>0</td></tr><tr><td>2</td><td>2</td><td>3</td></tr><tr><td>3</td><td>3</td><td>2</td></tr><tr><td>4</td><td>4</td><td>5</td></tr><tr><td>5</td><td>5</td><td>4</td></tr><tr><td>6</td><td>6</td><td>7</td></tr><tr><td>7</td><td>7</td><td>6</td></tr><tr><td>8</td><td>8</td><td>9</td></tr><tr><td>9</td><td>9</td><td>8</td></tr><tr><td>10</td><td>10</td><td>11</td></tr><tr><td>11</td><td>11</td><td>10</td></tr><tr><td>12</td><td>12</td><td>13</td></tr><tr><td>13</td><td>13</td><td>12</td></tr><tr><td>14</td><td>14</td><td>15</td></tr><tr><td>15</td><td>15</td><td>14</td></tr><tr><td>ä»¥<code>__shlf</code>å¼€å¤´çš„å‡½æ•°ä¸ºæ´—ç‰Œå‡½æ•°ï¼Œå¥½å¤„æ˜¯<strong>ä½¿å¾—çº¿ç¨‹æŸä¸­çš„çº¿ç¨‹å½¼æ­¤ä¹‹é—´å¯ä»¥ç›´æ¥äº¤æ¢æ•°æ®ï¼Œè€Œä¸æ˜¯é€šè¿‡å…±äº«å†…å­˜æˆ–å…¨å±€å†…å­˜æ¥è¿›è¡Œçš„</strong>ã€‚æ´—ç‰ŒæŒ‡ä»¤æ¯”å…±äº«å†…å­˜æœ‰æ›´ä½çš„å»¶è¿Ÿï¼Œå¹¶ä¸”è¯¥æŒ‡ä»¤åœ¨æ‰§è¡Œæ•°æ®äº¤æ¢æ—¶ä¸æ¶ˆè€—é¢å¤–çš„å†…å­˜</td><td></td><td></td></tr></tbody></table><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240922162221.png"></p><ul><li><code>all_sync(FULL_MASK):0</code>ï¼Œçº¿ç¨‹0çš„<code>tid</code>ä¸º0ï¼Œä¸æ˜¯å…¨éƒ¨å‚ä¸çš„çº¿ç¨‹çš„<code>predicate</code>å€¼éƒ½ä¸º1ï¼Œæ‰€ä»¥ä¸º0</li><li><code>all_sync(mask1):1</code>ï¼Œçº¿ç¨‹0æ²¡æœ‰å‚ä¸ï¼Œå…¨éƒ¨å‚ä¸çš„çº¿ç¨‹çš„<code>predicate</code>å€¼éƒ½ä¸º1ï¼Œæ‰€ä»¥ä¸º1</li><li><code>any_sync(FULL_MASK):1</code>ï¼Œçº¿ç¨‹0çš„<code>tid</code>ä¸º0ï¼Œåªè¦å‚ä¸çš„çº¿ç¨‹çš„<code>predicate</code>å€¼è‡³å°‘æœ‰ä¸€ä¸ªä¸º1åˆ™ä¸º1ï¼Œæ‰€ä»¥ä¸º1</li><li><code>any_sync(mask2):1</code>ï¼Œçº¿ç¨‹0çš„<code>tid</code>ä¸º0ï¼Œå‚ä¸çš„çº¿ç¨‹çš„åªæœ‰çº¿ç¨‹0ï¼Œ<code>predicate</code>å€¼åªæœ‰0ï¼Œæ‰€ä»¥ä¸º0</li></ul><h3 id="10-3-2-åˆ©ç”¨çº¿ç¨‹æŸæ´—ç‰Œå‡½æ•°è¿›è¡Œè§„çº¦è®¡ç®—"><a href="#10-3-2-åˆ©ç”¨çº¿ç¨‹æŸæ´—ç‰Œå‡½æ•°è¿›è¡Œè§„çº¦è®¡ç®—" class="headerlink" title="10.3.2 åˆ©ç”¨çº¿ç¨‹æŸæ´—ç‰Œå‡½æ•°è¿›è¡Œè§„çº¦è®¡ç®—"></a>10.3.2 åˆ©ç”¨çº¿ç¨‹æŸæ´—ç‰Œå‡½æ•°è¿›è¡Œè§„çº¦è®¡ç®—</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">real y <span class="token operator">=</span> s_y<span class="token punctuation">[</span>tid<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// å°†å…±äº«å†…å­˜ä¸­çš„æ•°æ®å¤åˆ¶åˆ°å¯„å­˜å™¨ï¼Œåœ¨çº¿ç¨‹æŸå†…ä½¿ç”¨æ´—ç‰Œå‡½æ•°è¿›è¡Œå½’çº¦æ—¶ï¼Œä¸éœ€è¦æ˜æ˜¾åœ°ä½¿ç”¨å…±äº«å†…å­˜</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> offset <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span> offset <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> offset <span class="token operator">&gt;&gt;=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>y <span class="token operator">+=</span> <span class="token function">__shfl_down_sync</span><span class="token punctuation">(</span>FULL_MASK<span class="token punctuation">,</span> y<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// yæ˜¯è¯»å–çš„å€¼ï¼Œoffsetæ˜¯å‘åç§»çš„ä¸ªæ•°</span><span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span>tid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">atomicAdd</span><span class="token punctuation">(</span>d_y<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ğŸ‘†ç†è§£ï¼š</p><ul><li>å°†å…±äº«å†…å­˜ä¸­çš„æ•°æ®å¤åˆ¶åˆ°å¯„å­˜å™¨ï¼Œåœ¨çº¿ç¨‹æŸå†…ä½¿ç”¨æ´—ç‰Œå‡½æ•°è¿›è¡Œå½’çº¦æ—¶ï¼Œä¸éœ€è¦æ˜æ˜¾åœ°ä½¿ç”¨å…±äº«å†…å­˜</li><li>æ´—ç‰Œå‡½æ•°å…ˆè¯»å–å„ä¸ªçº¿ç¨‹ä¸­yçš„å€¼ï¼Œå†å°†æ´—ç‰Œæ“ä½œçš„ç»“æœå†™å…¥å„ä¸ªçº¿ç¨‹çš„yä¸­<ul><li>å‡è®¾<code>y(tid = n) = n</code><ul><li>`offset=16<ul><li><code>y(tid=0) += __shfl_down_sync(FULL_MASK, y(tid=0), offset);</code><ul><li><code>y(tid=0) = 0</code></li><li><code>__shfl_down_sync() -&gt; y(tid=0)' = y(tid=16) = 16</code>ï¼Œ<code>'</code>è¡¨ç¤ºåæ¥çš„</li><li><code>y(tid=0) = y(tid=0) + y(tid=0)' = 0 + 16 = 16</code></li></ul></li><li><code>y(tid=1) = 1 + 17 = 18</code></li><li>â€¦</li><li><code>y(tid=15) = 15 + 31 = 46</code></li></ul></li><li><code>offset=8</code><ul><li><code>y(tid=0) = y(tid=0) + y(tid=7)</code></li><li>â€¦</li></ul></li><li><code>offset=1</code><ul><li><code>y(tid=0) = y(tid=0) + y(tid=1)</code></li></ul></li></ul></li></ul></li></ul><h2 id="10-4-åä½œç»„"><a href="#10-4-åä½œç»„" class="headerlink" title="10.4 åä½œç»„"></a>10.4 åä½œç»„</h2><p>åä½œç»„ï¼šçœ‹ä½œçº¿ç¨‹å—å’Œçº¿ç¨‹æŸåŒæ­¥æœºåˆ¶çš„æ¨å¹¿</p><ul><li>ä½¿ç”¨åä½œç»„çš„åŠŸèƒ½æ—¶éœ€è¦åœ¨ç›¸å…³æºæ–‡ä»¶åŒ…å«å¦‚ä¸‹å¤´æ–‡ä»¶ï¼š<br><code>#include&lt;cooperative_groups.h&gt;</code></li><li>å¯¼å…¥å‘½åç©ºé—´<code>cooprtative_groups</code>ä¸­çš„å†…å®¹ï¼š<br><code>using namespace cooperative_groups;</code></li></ul><p>å®šä¹‰å¹¶åˆå§‹åŒ–ä¸€ä¸ª<code>thread_block</code>å¯¹è±¡ï¼š<br><code>thread_block g = this_thread_block();</code>ï¼Œ<code>g</code>å°±ä»£è¡¨äº†çº¿ç¨‹å—</p><ul><li>ç­‰ä»·å…³ç³»ï¼š</li><li><code>g.sync()</code>â†”<code>__syncthreads()</code></li><li><code>g.group_index()</code>â†”<code>blockIdx</code></li><li><code>g.thread_index()</code>â†”<code>threadIdx</code></li></ul><p><code>tiled_partition()</code>å°†ä¸€ä¸ªçº¿ç¨‹å—åˆ†ä¸ºè‹¥å¹²ç‰‡(<code>tile</code>)ï¼Œæ¯ä¸€ç‰‡æ„æˆä¸€ä¸ªæ–°çš„çº¿ç¨‹ç»„ï¼Œå¤§å°åªèƒ½æ˜¯2ã€4ã€8ã€16ã€32</p><ul><li>æ¨¡æ¿åŒ–ï¼š<br><code>thread_block_tile&lt;32&gt; g32 = tiled_partition&lt;32&gt;(this_thread_block());</code><br><code>thread_block_tile&lt;4&gt; g4 = tiled_partition&lt;4&gt;(this_thread_block());</code><br>è¿™æ ·å®šä¹‰çš„çº¿ç¨‹ç»„ç§°ä¸º<strong>çº¿ç¨‹å—ç‰‡</strong>ï¼Œçº¿ç¨‹å—ç‰‡å‡½æ•°ä¸åŒçš„åœ°æ–¹ï¼š</li><li>çº¿ç¨‹ç»„å†…çš„æ‰€æœ‰çº¿ç¨‹éƒ½å¿…é¡»å‚ä¸ç›¸å…³å‡½æ•°çš„è¿ç®—</li><li>å®½åº¦å°±æ˜¯çº¿ç¨‹å—ç‰‡çš„å¤§å°</li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c">real y <span class="token operator">=</span> s_y<span class="token punctuation">[</span>tid<span class="token punctuation">]</span><span class="token punctuation">;</span>thread_block_tile<span class="token operator">&lt;</span><span class="token number">32</span><span class="token operator">&gt;</span> g <span class="token operator">=</span> tiled_partition<span class="token operator">&lt;</span><span class="token number">32</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function">this_thread_block</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> g<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&gt;&gt;=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    y <span class="token operator">+=</span> g<span class="token punctuation">.</span><span class="token function">shfl_down</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span>tid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">atomicAdd</span><span class="token punctuation">(</span>d_y<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æŠŠçº¿ç¨‹åˆ’åˆ†32ä¸ªçº¿ç¨‹ä¸€ç»„çš„ï¼Œå…¶ä»–çš„ä¸æ´—ç‰Œå‡½æ•°çš„æ­¥éª¤å·®ä¸å¤šï¼Œåªæ˜¯ä½¿ç”¨çš„æ–¹æ³•ä¸ä¸€æ ·ï¼Œæ‰€ä»¥ä»–ä»¬ä¸¤ç§æ–¹æ³•çš„ç”¨æ—¶ä¹Ÿå·®ä¸å¤š</p><p>å•ç²¾åº¦ğŸ‘‡<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240922220201.png" alt="275"><br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240922220210.png" alt="275"><br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240922220219.png" alt="275"><br>åŒç²¾åº¦ğŸ‘‡<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240922220240.png" alt="275"><br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240922220254.png" alt="275"><br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240922220302.png" alt="275"></p><h2 id="10-5-æ•°ç»„è§„çº¦ç¨‹åºçš„è¿›ä¸€æ­¥ä¼˜åŒ–"><a href="#10-5-æ•°ç»„è§„çº¦ç¨‹åºçš„è¿›ä¸€æ­¥ä¼˜åŒ–" class="headerlink" title="10.5 æ•°ç»„è§„çº¦ç¨‹åºçš„è¿›ä¸€æ­¥ä¼˜åŒ–"></a>10.5 æ•°ç»„è§„çº¦ç¨‹åºçš„è¿›ä¸€æ­¥ä¼˜åŒ–</h2><h3 id="10-5-1-æé«˜çº¿ç¨‹åˆ©ç”¨ç‡"><a href="#10-5-1-æé«˜çº¿ç¨‹åˆ©ç”¨ç‡" class="headerlink" title="10.5.1 æé«˜çº¿ç¨‹åˆ©ç”¨ç‡"></a>10.5.1 æé«˜çº¿ç¨‹åˆ©ç”¨ç‡</h3><p>â€œå¦‚æœèƒ½å¤Ÿæé«˜å½’çº¦ä¹‹å‰æ‰€åšè®¡ç®—çš„æ¯”ä¾‹ï¼Œåˆ™åº”è¯¥å¯ä»¥ä»æ•´ä½“ä¸Šå‡å¯¹çº¿ç¨‹çš„åˆ©ç”¨ç‡â€¦ï¼Œå¯ä»¥åœ¨å½’çº¦ä¹‹å‰å°†å¤šä¸ªå…¨å±€å†…å­˜æ•°ç»„çš„æ•°æ®ç´¯åŠ åˆ°ä¸€ä¸ªå…±äº«å†…å­˜æ•°ç»„çš„ä¸€ä¸ªå…ƒç´ ä¸­â€</p><p>â€œä¸è¦è®©ä¸€ä¸ªçº¿ç¨‹å¤„ç†ç›¸é‚»çš„è‹¥å¹²æ•°æ®ï¼Œå› ä¸ºè¿™å¿…ç„¶å¯¼è‡´å…¨å±€å†…å­˜çš„éåˆå¹¶è®¿é—®â€ï¼Œå¦‚ä½•ç†è§£è¿™å¥è¯(è¿™å¥è¯æœ¬äººè¯»äº†å¥½ä¸€ä¼šæ‰ç†æ˜ç™½)ï¼š</p><ul><li>ä»€ä¹ˆæ˜¯åˆå¹¶è®¿é—®ï¼Ÿ<ul><li>$åˆå¹¶åº¦=\dfrac{çº¿ç¨‹æŸè¯·æ±‚çš„å­—èŠ‚æ•°}{ç”±è¯¥è¯·æ±‚å¯¼è‡´çš„æ‰€æœ‰æ•°æ®ä¼ è¾“å¤„ç†çš„å­—èŠ‚æ•°}$</li><li>åˆå¹¶è®¿é—®å°±æ˜¯åˆå¹¶åº¦100%çš„æƒ…å†µï¼Œæ³¨æ„ï¼šçº¿ç¨‹çš„ç»„ç»‡æƒ…å†µæ˜¯ä»¥çº¿ç¨‹æŸä¸ºå•ä½</li></ul></li><li>ä¸ºä»€ä¹ˆä¸€ä¸ªçº¿ç¨‹å¤„ç†ä¼šå¯¼è‡´éåˆå¹¶<ul><li>(ä»¥ä¸‹æ˜¯å¸¦æœ‰ä¸»è§‚çš„è§£é‡Š)ä¸€ä¸ªçº¿ç¨‹å¤„ç†ç›¸é‚»çš„æ•°æ®ï¼Œå¦‚</li><li><code>tid=0 -&gt; è®¿é—® d_x[0], d_x[1], d_x[2], d_x[3]</code></li><li><code>tid=1 -&gt; è®¿é—® d_x[4], d_x[5], d_x[6], d_x[7]</code></li><li>åœ¨ä¸€ä¸ªçº¿ç¨‹æŸå†…ï¼Œæ¯ä¸€æ—¶åˆ»æ¯ä¸ªçº¿ç¨‹è®¿é—®çš„æ•°æ®ä¸æ˜¯è¿ç»­çš„(<code>d_x[tid * 4]</code>)ï¼Œæ•°æ®çš„ä¼ è¾“çš„é¦–åœ°å€æŸä¸ªæœ€å°é¢—ç²’åº¦çš„å€æ•°</li><li>å‡è®¾éœ€è¦è¯·æ±‚çš„æ•°æ®ä¸º<code>d_x[0]~d_x[31]</code>ï¼Œæ¯ä¸ªå…ƒç´ å¤§å°ä¸º4å­—èŠ‚ï¼ŒæŸä¸ªæœ€å°é¢—ç²’åº¦ä¸º32</li><li>åœ¨ç¬¬ä¸€ä¸ªæ—¶åˆ»ä¸­ï¼Œ<code>tid = 0 -&gt; 0 ... tid = 7 -&gt; 28</code></li><li>åœ¨ç¬¬äºŒä¸ªæ—¶åˆ»ä¸­ï¼Œ<code>tid = 0 -&gt; 1 ... tid = 7 -&gt; 29</code></li><li>åœ¨ç¬¬ä¸‰ä¸ªæ—¶åˆ»ä¸­ï¼Œ<code>tid = 0 -&gt; 2 ... tid = 7 -&gt; 30</code></li><li>åœ¨ç¬¬å››ä¸ªæ—¶åˆ»ä¸­ï¼Œ<code>tid = 0 -&gt; 3 ... tid = 7 -&gt; 31</code></li><li>$åˆå¹¶åº¦=\dfrac{çº¿ç¨‹æŸè¯·æ±‚çš„å­—èŠ‚æ•°}{ç”±è¯¥è¯·æ±‚å¯¼è‡´çš„æ‰€æœ‰æ•°æ®ä¼ è¾“å¤„ç†çš„å­—èŠ‚æ•°}=\dfrac{128}{128*4}=\dfrac{1}{4}$ï¼Œ4æ˜¯ä»£è¡¨è¿›è¡Œäº†4æ¬¡ä»0<del>128å­—èŠ‚çš„è®¿é—®(å³`d_x[0]</del>d_x[31]`)</li></ul></li><li>æ€ä¹ˆæ ·è®¿é—®æ‰æ˜¯åˆå¹¶çš„ï¼Ÿ<ul><li>ç›¸é‚»çº¿ç¨‹è®¿é—®è¿ç»­çš„åœ°å€ï¼Œä¾‹å­è§ç¬¬ä¸ƒç« ç¬¬ä¸€èŠ‚çš„é¡ºåºçš„åˆå¹¶è®¿é—®</li></ul></li></ul><p>å•ç²¾åº¦ğŸ‘‡<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240924211910.png" alt="375"><br>åŒç²¾åº¦ğŸ‘‡<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240924211937.png" alt="375"><br>å¯ä»¥å‘ç°ä¼˜åŒ–ååœ¨æ—¶é—´å’Œç²¾åº¦ä¸Šéƒ½æœ‰æ‰€æå‡ï¼</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">reduce_cp<span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span>GRID_SIZE<span class="token punctuation">,</span> BLOCK_SIZE<span class="token punctuation">,</span> smem<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>d_x<span class="token punctuation">,</span> d_y<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">;</span>reduce_cp<span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>real<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>d_y<span class="token punctuation">,</span> d_y<span class="token punctuation">,</span> GRID_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æœ‰GRID_SIZEä¸ªå—éœ€è¦å½’çº¦</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>ç”¨<code>d_y[bid] = y;</code>ä»£æ›¿äº†<code>atomicAdd(d_y, y)</code></li><li>ä½¿ç”¨ä¸¤ä¸ªæ ¸å‡½æ•°å¯ä»¥è·å¾—æ›´åŠ ç²¾ç¡®çš„ç»“æœï¼Œè¿™æ˜¯å› ä¸ºä½¿ç”¨ä¸¤ä¸ªæ ¸å‡½æ•°æ—¶ï¼Œå°†æ•°ç»„<code>d_y</code>å½’çº¦åˆ°æœ€ç»ˆç»“æœçš„è®¡ç®—ä½¿ç”¨äº†æŠ˜åŠæ±‚å’Œï¼Œæ¯”ç›´æ¥ç´¯åŠ (ä½¿ç”¨åŸå­å‡½æ•°æˆ–å¤åˆ¶åˆ°ä¸»æœºå†ç´¯åŠ çš„æƒ…å†µ)æ›´ç¨³å¥</li></ul><h3 id="10-5-2-é¿å…åå¤åˆ†é…ä¸é‡Šæ”¾è®¾å¤‡å†…å­˜"><a href="#10-5-2-é¿å…åå¤åˆ†é…ä¸é‡Šæ”¾è®¾å¤‡å†…å­˜" class="headerlink" title="10.5.2 é¿å…åå¤åˆ†é…ä¸é‡Šæ”¾è®¾å¤‡å†…å­˜"></a>10.5.2 é¿å…åå¤åˆ†é…ä¸é‡Šæ”¾è®¾å¤‡å†…å­˜</h3><p>åœ¨10.5.1çš„<code>reduce()</code>å‡½æ•°ä¸­ï¼Œéœ€è¦ä¸ºæ•°ç»„<code>d_y</code>åˆ†é…ä¸é‡Šæ”¾è®¾å¤‡å†…å­˜ã€‚å®é™…ä¸Šï¼Œ<strong>è®¾å¤‡å†…å­˜çš„åˆ†é…ä¸é‡Šæ”¾æ˜¯æ¯”è¾ƒè€—æ—¶çš„</strong></p><pre class="line-numbers language-c" data-language="c"><code class="language-c">real <span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">const</span> real<span class="token operator">*</span> d_x<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">const</span> <span class="token keyword">int</span> ymem <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>real<span class="token punctuation">)</span> <span class="token operator">*</span> GRID_SIZE<span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">CHECK</span><span class="token punctuation">(</span><span class="token function">cudaMalloc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d_y<span class="token punctuation">,</span> ymem<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// åˆ†é…å†…å­˜</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">CHECK</span><span class="token punctuation">(</span><span class="token function">cudaFree</span><span class="token punctuation">(</span>d_y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é‡Šæ”¾å†…å­˜</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è§£å†³æ–¹æ³•ï¼šä½¿ç”¨é™æ€å…¨å±€å†…å­˜ä»£æ›¿åŠ¨æ€å…¨å±€å†…å­˜ï¼Œå› ä¸ºé™æ€å†…å­˜åœ¨ç¼–è¯‘æœŸé—´å°±ä¼šåˆ†é…å¥½</p><ul><li>å®šä¹‰é™æ€å…¨å±€å†…å­˜å˜é‡ï¼š<code>__device__ real static_y[GRID_SIZE];</code></li><li>åœ¨ä¸æ”¹å˜æ ¸å‡½æ•°ä»£ç çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ç”¨<code>cudaGetSymbolAddress()</code>è·å¾—ä¸€ä¸ªæŒ‡å‘è¯¥é™æ€å…¨å±€å†…å­˜çš„æŒ‡é’ˆ<pre class="line-numbers language-c" data-language="c"><code class="language-c">__device__ real static_y<span class="token punctuation">[</span>GRID_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>real <span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">const</span> real<span class="token operator">*</span> d_x<span class="token punctuation">)</span><span class="token punctuation">{</span>    real<span class="token operator">*</span> d_y<span class="token punctuation">;</span>    <span class="token function">CHECK</span><span class="token punctuation">(</span><span class="token function">cudaGetSymbolAddress</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>d_y<span class="token punctuation">,</span> static_y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//å°†æŒ‡å‘d_yçš„æŒ‡é’ˆæŒ‡å‘static_y</span>    <span class="token keyword">const</span> <span class="token keyword">int</span> smem <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>real<span class="token punctuation">)</span> <span class="token operator">*</span> BLOCK_SIZE<span class="token punctuation">;</span>    reduce_cp<span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span>GRID_SIZE<span class="token punctuation">,</span> BLOCK_SIZE<span class="token punctuation">,</span> smem<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>d_x<span class="token punctuation">,</span> d_y<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">;</span>    reduce_cp<span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>real<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>d_y<span class="token punctuation">,</span> d_y<span class="token punctuation">,</span> GRID_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>      real h_y<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token function">CHECK</span><span class="token punctuation">(</span><span class="token function">cudaMemcpy</span><span class="token punctuation">(</span>h_y<span class="token punctuation">,</span> d_y<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>real<span class="token punctuation">)</span><span class="token punctuation">,</span> cudaMemcpyDeviceToHost<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> h_y<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><code>cudaGetSymbolAddress(void** devPtr, const char* symbol);</code></li><li><code>void*8 devPtr</code>ï¼šæ˜¯ä¸€ä¸ªæŒ‡å‘æŒ‡é’ˆçš„æŒ‡é’ˆï¼Œå‡½æ•°ä¼šä¿®æ”¹è¿™ä¸ªæŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘<strong>æŒ‡å®šç¬¦å·</strong>åœ¨è®¾å¤‡ä¸Šçš„åœ°å€</li><li><code>const char* symbol</code>ï¼šæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºä½ æƒ³è¦è·å–åœ°å€çš„ç¬¦å·åç§°(é€šå¸¸æ˜¯å…¨å±€å˜é‡æˆ–å¸¸é‡å˜é‡çš„åç§°ï¼Œéœ€è¦ä»¥<code>__device__</code>æˆ–<code>__constant__</code>å­˜å‚¨ç±»å®šä¹‰)</li><li>ä½¿ç”¨åœºæ™¯ï¼šåœ¨è®¾å¤‡ä¸­å®šä¹‰äº†ä¸€ä¸ªå…¨å±€å˜é‡æˆ–å¸¸é‡ï¼Œå¹¶å¸Œæœ›åœ¨å†…æ ¸æˆ–å…¶ä»–CUDAå‡½æ•°ä¸­ä½¿ç”¨</li><li>ç¤ºä¾‹ğŸ‘‡<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// å®šä¹‰</span>__device__ <span class="token keyword">float</span> static_y<span class="token punctuation">;</span><span class="token comment">// è·å–static_yçš„åœ°å€</span><span class="token keyword">float</span> <span class="token operator">*</span>d_y<span class="token punctuation">;</span><span class="token function">cudaGetSymbolAddress</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>d_y<span class="token punctuation">,</span> <span class="token string">"static_y"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p>å•ç²¾åº¦ğŸ‘‡<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240926190202.png" alt="375"><br>åŒç²¾åº¦ğŸ‘‡<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240926190218.png" alt="375"><br>ç”¨æ—¶æ¯”ä½¿ç”¨åŠ¨æ€å…¨å±€å†…å­˜æ›´çŸ­ï¼</p><h1 id="ç¬¬åä¸€ç« -CUDAæµ"><a href="#ç¬¬åä¸€ç« -CUDAæµ" class="headerlink" title="ç¬¬åä¸€ç«  CUDAæµ"></a>ç¬¬åä¸€ç«  CUDAæµ</h1><p>æ ¸å‡½æ•°å¤–éƒ¨çš„å¹¶è¡Œä¸»è¦æŒ‡ï¼š</p><ul><li>æ ¸å‡½æ•°è®¡ç®—ä¸æ•°æ®ä¼ è¾“ä¹‹é—´çš„å¹¶è¡Œ</li><li>ä¸»æœºè®¡ç®—ä¸æ•°æ®ä¼ è¾“ä¹‹é—´çš„å¹¶è¡Œ</li><li>ä¸åŒçš„æ•°æ®ä¼ è¾“ä¹‹é—´çš„å¹¶è¡Œ(cudaMemcpyå‡½æ•°ä¸­çš„ç¬¬å››ä¸ªå‚æ•°)</li><li>æ ¸å‡½æ•°è®¡ç®—ä¸ä¸»æœºè®¡ç®—ä¹‹é—´çš„å¹¶è¡Œ</li><li>ä¸åŒæ ¸å‡½æ•°ä¹‹é—´çš„å¹¶è¡Œ</li></ul><p>ä¸€èˆ¬æ¥è¯´ï¼Œè¦è·å¾—è¾ƒé«˜çš„åŠ é€Ÿæ¯”ï¼Œå¦‚è¦<strong>å‡å°‘ä¸»æœºä¸è®¾å¤‡ä¹‹é—´çš„æ•°æ®ä¼ è¾“åŠä¸»æœºä¸­çš„è®¡ç®—</strong>ï¼Œ<strong>å°½é‡åœ¨è®¾å¤‡ä¸­å®Œæˆæ‰€æœ‰è®¡ç®—</strong></p><h2 id="11-1-CUDAæµæ¦‚è¿°"><a href="#11-1-CUDAæµæ¦‚è¿°" class="headerlink" title="11.1 CUDAæµæ¦‚è¿°"></a>11.1 CUDAæµæ¦‚è¿°</h2><p><strong>ä¸€ä¸ªCUDAæµæŒ‡çš„æ˜¯ç”±ä¸»æœºå‘å‡ºçš„åœ¨ä¸€ä¸ªè®¾å¤‡ä¸­æ‰§è¡Œçš„CUDAæ“ä½œ</strong>(å³å’ŒCUDAæœ‰å…³çš„æ“ä½œï¼Œå¦‚ä¸»æœº-è®¾å¤‡æ•°æ®ä¼ è¾“å’Œæ ¸å‡½æ•°æ‰§è¡Œ)<strong>åºåˆ—</strong></p><p>CUDAæµï¼š</p><ul><li>é»˜è®¤æµ(ç©ºæµ)</li><li>éé»˜è®¤æµ(éç©ºæµ)<ul><li>åœ¨ä¸»æœºç«¯äº§ç”Ÿå’Œé”€æ¯</li><li>ä¸€ä¸ªCUDAæµç”±ç±»å‹ä¸º<code>cudaStream_t</code>çš„å˜é‡è¡¨ç¤º</li><li>äº§ç”Ÿï¼š<code>cudaStreamCreate(cudaStream_t*)</code>ï¼Œè¾“å…¥å‚æ•°æ˜¯<code>cudaStream_t</code>ç±»å‹çš„æŒ‡é’ˆ</li><li>é”€æ¯ï¼š<code>cudaStreamDestroy(cudaStream_t*)</code>ï¼Œè¾“å…¥å‚æ•°<code>cudaStream_t</code>ç±»å‹çš„å˜é‡</li><li>æ£€æŸ¥ä¸€ä¸ªCUDAæµä¸­çš„æ‰€æœ‰æ“ä½œæ˜¯å¦éƒ½åœ¨è®¾å¤‡ä¸­æ‰§è¡Œå®Œæ¯•ï¼š<ul><li><code>cudaStreamSynchronize(cudaStream_t stream)</code>ï¼Œ<code>cudaStreamSynchronize()</code>ä¼šå¼ºåˆ¶é˜»å¡ä¸»æœºï¼Œç›´åˆ°CUDAæµstreamä¸­çš„æ‰€æœ‰æ“ä½œéƒ½è¢«æ‰§è¡Œå®Œæ¯•</li><li><code>cudaStreamQuery(cudaStream_t stream)</code>ï¼Œ<code>cudaStreamQuery()</code>ä¸ä¼šé˜»å¡ä¸»æœºï¼Œåªæ˜¯æ£€æŸ¥CUDAæµstreamä¸­çš„æ‰€æœ‰æ“ä½œæ˜¯å¦éƒ½æ‰§è¡Œå®Œæ¯•</li></ul></li></ul></li></ul><h2 id="11-2-åœ¨é»˜è®¤æµä¸­é‡å ä¸»æœºå’Œè®¾å¤‡è®¡ç®—"><a href="#11-2-åœ¨é»˜è®¤æµä¸­é‡å ä¸»æœºå’Œè®¾å¤‡è®¡ç®—" class="headerlink" title="11.2 åœ¨é»˜è®¤æµä¸­é‡å ä¸»æœºå’Œè®¾å¤‡è®¡ç®—"></a>11.2 åœ¨é»˜è®¤æµä¸­é‡å ä¸»æœºå’Œè®¾å¤‡è®¡ç®—</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">cudaMemcpy</span><span class="token punctuation">(</span>d_x<span class="token punctuation">,</span> h_x<span class="token punctuation">,</span> M<span class="token punctuation">,</span> cudaMemcpyHostToDevice<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ä¸»æœºå‘å‡ºå‘½ä»¤åï¼Œéœ€ç­‰å¾…å‘½ä»¤æ‰§è¡Œå®Œæ¯•æ‰æ‰§è¡Œä¸‹ä¸€æ­¥ï¼Œåœ¨ç­‰å¾…çš„è¿‡ç¨‹ä¸­ä¸»æœºé—²ç½®</span><span class="token function">cudaMemcpy</span><span class="token punctuation">(</span>d_y<span class="token punctuation">,</span> h_y<span class="token punctuation">,</span> M<span class="token punctuation">,</span> cudaMemcpyHostToDevice<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ä¸»æœºå‘å‡ºå‘½ä»¤åï¼Œéœ€ç­‰å¾…å‘½ä»¤æ‰§è¡Œå®Œæ¯•æ‰æ‰§è¡Œä¸‹ä¸€æ­¥ï¼Œåœ¨ç­‰å¾…çš„è¿‡ç¨‹ä¸­ä¸»æœºé—²ç½®</span>sum<span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span>grid_size<span class="token punctuation">,</span> block_size<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>d_x<span class="token punctuation">,</span> d_y<span class="token punctuation">,</span> d_z<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ä¸»æœºå‘å‡ºå‘½ä»¤åï¼Œä¸ä¼šç­‰å¾…è¯¥å‘½ä»¤æ‰§è¡Œå®Œæ¯•ï¼Œä¸»æœºç´§æ¥ç€ä¼šå‘å‡ºä¸‹ä¸€æ¡æŒ‡ä»¤</span><span class="token function">cudaMemcpy</span><span class="token punctuation">(</span>h_z<span class="token punctuation">,</span> d_z<span class="token punctuation">,</span> M<span class="token punctuation">,</span> cudaMemcpyDeviceToHost<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å› ä¸ºè¿™æ˜¯é»˜è®¤æµä¸­çš„CUDAæ“ä½œï¼Œå¿…é¡»ç­‰å¾…å‰ä¸€ä¸ªCUDAæ“ä½œæ‰§è¡Œå®Œæ¯•æ‰ä¼šæ‰§è¡Œè¿™æ¡å‘½ä»¤</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>ğŸ‘†CUDAæ“ä½œä¾‹å­(æ³¨é‡Šæ˜¯ä¸»æœºè§’åº¦)<br>ä»è®¾å¤‡è§’åº¦çœ‹ï¼šä¸Šé¢4ä¸ªCUDAæ“ä½œåœ¨é»˜è®¤çš„CUDAæµä¸­<strong>æŒ‰ä»£ç å‡ºç°çš„é¡ºåºä¾æ¬¡æ‰§è¡Œ</strong><br>ä»ä¸»æœºè§’åº¦çœ‹ï¼š<br>â‘ ä¸»æœºåœ¨å‘å‡ºæ ¸å‡½æ•°å‘½ä»¤çš„è°ƒç”¨åä¼šç«‹åˆ»å‘å‡ºä¸‹ä¸€ä¸ªå‘½ä»¤<br>â‘¡(1)å¦‚æœä¸‹ä¸€ä¸ªå‘½ä»¤æ˜¯æ•°æ®ä¼ è¾“ï¼Œä»è®¾å¤‡è§’åº¦çœ‹å¿…é¡»ç­‰å¾…æ ¸å‡½æ•°æ‰§è¡Œå®Œæ¯•(å®é™…ä¸Šä¸»æœºä¹Ÿåœ¨ç­‰æ‰§è¡Œå®Œæ¯•)<br>â‘¡(2)å¦‚æœä¸‹ä¸€ä¸ªå‘½ä»¤æ˜¯ä¸»æœºä¸­çš„æŸä¸ªè®¡ç®—ä»»åŠ¡ï¼Œé‚£ä¹ˆä¸»æœºä¼šåœ¨è®¾å¤‡æ‰§è¡Œæ ¸å‡½æ•°æ—¶åŒæ—¶è¿›è¡Œä¸€äº›è®¡ç®—ï¼Œè¿™æ ·ä¸»æœºå’Œè®¾å¤‡å°±å¯ä»¥åŒæ—¶è¿›è¡Œ(<strong>è®¾å¤‡å®Œå…¨ä¸çŸ¥é“åœ¨å®ƒæ‰§è¡Œæ ¸å‡½æ•°æ—¶ï¼Œä¸»æœºå·å·åœ°åšäº†äº›è®¡ç®—</strong>)</p><p>å®è·µ(ç»“æœå’Œä¹¦ä¸Šçš„ä¸ç¬¦åˆ)ï¼š</p><ul><li>é‡‡ç”¨å•ç²¾åº¦æµ®ç‚¹æ•°ï¼Œåœ¨æ•°æ®é‡ä¸€æ ·æ—¶ï¼Œ<strong>æ ¸å‡½æ•°<code>gpu_sum</code>æ¯”ä¸»æœºç«¯å‡½æ•°<code>cpu_sum</code>çº¦å¿«10å€</strong>ï¼Œå› æ­¤è®¾ç½®$ratio=\dfrac{è®¾å¤‡ç«¯å‡½æ•°æ‰€å¤„ç†çš„æ•°æ®é‡}{ä¸»æœºç«¯å‡½æ•°æ‰€å¤„ç†çš„æ•°æ®é‡}$ï¼Œä½¿å¾—<code>gpu_sum</code>å’Œ<code>cpu_sum</code>æ‰§è¡Œæ—¶é—´å·®ä¸å¤š</li><li>è¿™é‡Œçš„ç»“æœå’Œä¹¦ä¸Šçš„ä¸å¤ªç¬¦åˆ(æ€è€ƒ.jpg)</li></ul><p>ç»“æœ(ä¹¦ä¸Šçš„)ï¼š</p><ul><li>å½“ä¸»æœºå‡½æ•°å’Œè®¾å¤‡å‡½æ•°çš„è®¡ç®—é‡ç›¸å½“æ—¶ï¼Œå°†<strong>ä¸»æœºå‡½æ•°æ”¾åœ¨è®¾å¤‡å‡½æ•°ä¹‹å</strong>(GPU -&gt; CPU)å¯ä»¥è¾¾åˆ°ä¸»æœºå‡½æ•°ä¸è®¾å¤‡å‡½æ•°å¹¶å‘æ‰§è¡Œçš„æ•ˆæœï¼Œä»è€Œæœ‰æ•ˆåœ°éšè—ä¸»æœºå‡½æ•°çš„æ‰§è¡Œè¿‡ç¨‹</li><li>å¦‚æœä¸»æœºå‡½æ•°å’Œè®¾å¤‡å‡½æ•°è®¡ç®—æ—¶é—´å·®å¾ˆå¤šï¼ŒåŠ é€Ÿæ•ˆæœä¸æ˜¾è‘—</li></ul><h2 id="11-3-ç”¨éé»˜è®¤CUDAæµé‡å å¤šä¸ªæ ¸å‡½æ•°çš„æ‰§è¡Œ"><a href="#11-3-ç”¨éé»˜è®¤CUDAæµé‡å å¤šä¸ªæ ¸å‡½æ•°çš„æ‰§è¡Œ" class="headerlink" title="11.3 ç”¨éé»˜è®¤CUDAæµé‡å å¤šä¸ªæ ¸å‡½æ•°çš„æ‰§è¡Œ"></a>11.3 ç”¨éé»˜è®¤CUDAæµé‡å å¤šä¸ªæ ¸å‡½æ•°çš„æ‰§è¡Œ</h2><p>åŒä¸€ä¸ªCUDAæµä¸­çš„<strong>CUDAæ“ä½œåœ¨è®¾å¤‡ä¸­æ˜¯é¡ºåºæ‰§è¡Œçš„</strong>(éå¹¶è¡Œ)ï¼Œé‚£ä¹ˆåŒä¸€ä¸ªCUDAæµä¸­çš„<strong>æ ¸å‡½æ•°</strong>ä¹Ÿå¿…é¡»åœ¨è®¾å¤‡ä¸­<strong>é¡ºåºæ‰§è¡Œ</strong>ï¼Œå¦‚æœè¦å®ç°<strong>å¤šä¸ªæ ¸å‡½æ•°ä¹‹é—´çš„å¹¶è¡Œ</strong>å¿…é¡»ä½¿ç”¨<strong>å¤šä¸ªCUDAæµ</strong></p><p>æ ¸å‡½æ•°çš„è°ƒåº¦æ–¹å¼<br><code>my_kernel&lt;&lt;&lt;N_grid, N_block&gt;&gt;&gt;();</code> -&gt; åœ¨é»˜è®¤æµæ‰§è¡Œ<br><code>my_kernel&lt;&lt;&lt;N_grid, N_block, N_shared&gt;&gt;&gt;();</code> -&gt; åœ¨é»˜è®¤æµæ‰§è¡Œ<br><code>my_kernel&lt;&lt;&lt;N_grid, N_block, N_shared, stream_id&gt;&gt;&gt;();</code> -&gt; éç©ºæµæ‰§è¡Œ</p><ul><li><code>N_grid</code>æ˜¯ç½‘æ ¼å¤§å°</li><li><code>N_block</code>æ˜¯çº¿ç¨‹å—å¤§å°</li><li><code>N_shared</code>æ˜¯æ ¸å‡½æ•°ä¸­ä½¿ç”¨çš„<strong>åŠ¨æ€å…±äº«å†…å­˜</strong>çš„<strong>å­—èŠ‚æ•°</strong></li><li><code>stream_id</code>æ˜¯CUDAæµçš„ç¼–å·</li></ul><p>å¯èƒ½æ˜¯è®¾å¤‡ä¸åŒçš„é—®é¢˜ï¼Œå’Œä¹¦ä¸Šçš„ç»“æœä¸å¤ªä¸€æ ·<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/Pasted%20image%2020240928191804.png" alt="500"><br>ç»“æœ(ä¹¦ä¸Šçš„)ï¼š<br>CUDAæµå¹¶å‘å¤šä¸ªæ ¸å‡½æ•°å¯ä»¥æå‡GPUç¡¬ä»¶çš„åˆ©ç”¨ç‡ï¼Œå‡å°‘é—²ç½®çš„SMï¼Œä»è€Œä»æ•´ä½“ä¸Šè·å¾—æ€§èƒ½æå‡</p><h2 id="11-4-ç”¨éé»˜è®¤CUDAæµé‡å æ ¸å‡½æ•°çš„æ‰§è¡Œä¸æ•°æ®ä¼ é€’"><a href="#11-4-ç”¨éé»˜è®¤CUDAæµé‡å æ ¸å‡½æ•°çš„æ‰§è¡Œä¸æ•°æ®ä¼ é€’" class="headerlink" title="11.4 ç”¨éé»˜è®¤CUDAæµé‡å æ ¸å‡½æ•°çš„æ‰§è¡Œä¸æ•°æ®ä¼ é€’"></a>11.4 ç”¨éé»˜è®¤CUDAæµé‡å æ ¸å‡½æ•°çš„æ‰§è¡Œä¸æ•°æ®ä¼ é€’</h2><p>è‹¥éœ€è¦å®ç°æ ¸å‡½æ•°æ‰§è¡Œä¸æ•°æ®ä¼ è¾“çš„å¹¶å‘(é‡å )</p><ul><li>å¿…é¡»è®©è¿™ä¸¤ä¸ªæ“ä½œå¤„äºä¸åŒçš„éé»˜è®¤æµ</li><li>æ•°æ®ä¼ è¾“éœ€è¦ä½¿ç”¨å¼‚æ­¥ç‰ˆæœ¬<code>cudaMemcpyAsync()</code>å‡½æ•°<ul><li>å¼‚æ­¥ä¼ è¾“ç”±GPUä¸­çš„DMA(direct memory access)ç›´æ¥å­˜å‚¨è®¿é—®å™¨ï¼Œä¸éœ€è¦ä¸»æœºå‚ä¸<ul><li>DMAæä¾›åœ¨<strong>å¤–è®¾å’Œå­˜å‚¨å™¨ä¹‹é—´</strong>æˆ–è€…<strong>å­˜å‚¨å™¨å’Œå­˜å‚¨å™¨ä¹‹é—´</strong>çš„é«˜é€Ÿæ•°æ®ä¼ è¾“</li><li>æ•°æ®çš„å¤åˆ¶å’Œå­˜å‚¨æ•°æ®å¯¹äºCPUæ¥è¯´æ²¡é‚£ä¹ˆé‡è¦ï¼Œå¯ä»¥äº¤ç»™DMAï¼Œè§£å†³å¤§é‡æ•°æ®è½¬ç§»è¿‡åº¦æ¶ˆè€—CPUèµ„æºçš„é—®é¢˜</li></ul></li><li>å¦‚æœç”¨åŒæ­¥çš„æ•°æ®ä¼ è¾“å‡½æ•°<code>cudaMemcpy()</code>ï¼Œä¸»æœºå‘ä¸€ä¸ªæµå‘å‡ºæ•°æ®ä¼ è¾“çš„å‘½ä»¤å<strong>æ— æ³•ç«‹åˆ»è·å¾—æ§åˆ¶æƒ</strong>ï¼Œå¿…é¡»ç­‰å¾…æ•°æ®ä¼ è¾“å®Œæ¯•ï¼Œå³ä¸»æœºæ— æ³•åŒæ—¶å‘å¦ä¸€ä¸ªæµè°ƒç”¨æ ¸å‡½æ•°ï¼Œä¹Ÿå°±ä¸èƒ½å®ç°æ ¸å‡½æ•°ä¸æ•°æ®ä¼ è¾“çš„é‡å </li><li><code>cudaMemcpyAsync(void *dst, const void *src, size_t count, enum cudaMemcpyKind kind, cudaStream_t stream)</code>æ¯”<code>cudaMemcpy()</code>å¤šä¸€ä¸ªå‚æ•°ï¼Œæ˜¯æ‰€<strong>åœ¨æµçš„å˜é‡</strong></li><li>åœ¨ä½¿ç”¨å¼‚æ­¥çš„æ•°æ®ä¼ è¾“æ—¶ï¼Œéœ€è¦å°†ä¸»æœºå†…å­˜å®šä¹‰ä¸ºä¸å¯åˆ†é¡µå†…å­˜æˆ–è€…å›ºå®šå†…å­˜<ul><li>ä¸å¯åˆ†é¡µå†…å­˜ï¼šè‹¥å°†ä¸»æœºå†…å­˜å£°æ˜ä¸ºä¸å¯åˆ†é¡µå†…å­˜ï¼Œåˆ™åœ¨ç¨‹åºè¿è¡ŒæœŸé—´å…¶ç‰©ç†åœ°å€<strong>ä¿æŒä¸å˜</strong></li><li>ç³»ç»Ÿæ“ä½œæœ‰æƒåœ¨ä¸€ä¸ªç¨‹åºè¿è¡ŒæœŸé—´æ”¹å˜ç¨‹åºä¸­ä½¿ç”¨çš„<strong>å¯åˆ†é¡µä¸»æœºå†…å­˜</strong>çš„ç‰©ç†åœ°å€</li></ul></li></ul></li></ul><p>ä¸å¯åˆ†é¡µ<strong>ä¸»æœºå†…å­˜</strong>çš„åˆ†é…å‡½æ•°</p><ul><li><code>cudaMallocHost(void **ptr, size_t size);</code></li><li><code>cudaHostAlloc(void **ptr, size_t size, size_t flags);</code>ï¼Œå¦‚æœç¬¬ä¸‰ä¸ªå‚æ•°å–é»˜è®¤å€¼<code>cudaHostAlllocDefault</code>ï¼Œåˆ™å’Œä¸Šé¢çš„å‡½æ•°ç­‰ä»·<br>ä¸å¯åˆ†é¡µ<strong>ä¸»æœºå†…å­˜</strong>çš„é‡Šæ”¾å‡½æ•°</li><li><code>cudaFreeHost(void *ptr);</code></li></ul><p>è¿™é‡Œçš„æ—¶é—´æ˜¯æŠŠå‰å‡ æ¬¡REPEATæ¬¡æ•°çš„æ—¶é—´ä¹ŸåŠ ä¸Šäº†</p><table><thead><tr><th></th><th>CUDAæµ=1</th><th>2</th><th>4</th><th>8</th><th>16</th><th>32</th><th>64</th></tr></thead><tbody><tr><td>REPEATæ¬¡æ•°=1</td><td>0.727245</td><td>0.813056</td><td>0.671984</td><td>0.633242</td><td>0.640717</td><td>0.732979</td><td>0.711456</td></tr><tr><td>2</td><td>1.48132</td><td>1.6044</td><td>1.29539</td><td>1.25809</td><td>1.2987</td><td>1.37727</td><td>1.40511</td></tr><tr><td>3</td><td>2.15654</td><td>2.40559</td><td>1.94911</td><td>1.89739</td><td>1.98509</td><td>2.0228</td><td>2.10539</td></tr><tr><td>4</td><td>2.90161</td><td>3.17943</td><td>2.62284</td><td>2.54855</td><td>2.64568</td><td>2.66245</td><td>2.8182</td></tr><tr><td>5</td><td>3.5848</td><td>3.97385</td><td>3.29006</td><td>3.16776</td><td>3.29783</td><td>3.32314</td><td>3.53272</td></tr><tr><td>6</td><td>4.2719</td><td>4.79479</td><td>3.97973</td><td>3.8308</td><td>3.96661</td><td>4.00003</td><td>4.19064</td></tr><tr><td>7</td><td>5.04011</td><td>5.60569</td><td>4.61964</td><td>4.49671</td><td>4.65433</td><td>4.62836</td><td>4.84917</td></tr><tr><td>8</td><td>5.90314</td><td>6.3983</td><td>5.27192</td><td>5.15115</td><td>5.28048</td><td>5.26508</td><td>5.52204</td></tr><tr><td>9</td><td>6.73892</td><td>7.15903</td><td>5.94195</td><td>5.7894</td><td>5.90922</td><td>5.90743</td><td>6.19399</td></tr><tr><td>10</td><td>7.55339</td><td>8.02287</td><td>6.58859</td><td>6.41499</td><td>6.53621</td><td>6.56247</td><td>6.8724</td></tr></tbody></table><p>çœ‹èµ·æ¥å¹¶è¡Œæ•ˆæœæ˜¯è¿˜ä¸é”™çš„ã€‚</p><h1 id="ç¬¬åå››ç« -CUDAæ ‡å‡†åº“çš„ä½¿ç”¨"><a href="#ç¬¬åå››ç« -CUDAæ ‡å‡†åº“çš„ä½¿ç”¨" class="headerlink" title="ç¬¬åå››ç«  CUDAæ ‡å‡†åº“çš„ä½¿ç”¨"></a>ç¬¬åå››ç«  CUDAæ ‡å‡†åº“çš„ä½¿ç”¨</h1><h2 id="14-2-Thruståº“"><a href="#14-2-Thruståº“" class="headerlink" title="14.2 Thruståº“"></a>14.2 Thruståº“</h2><ul><li>Thruståº“æ˜¯ä¸€ä¸ªå®ç°äº†<strong>ä¼—å¤šåŸºæœ¬å¹¶è¡Œç®—æ³•</strong>çš„C++æ¨¡æ¿åº“</li><li>è¯¥åº“ä¸­çš„æ‰€æœ‰ç±»å‹ä¸å‡½æ•°éƒ½åœ¨å‘½åç©ºé—´thrustä¸­å®šä¹‰ï¼Œæ‰€ä»¥ç”¨åˆ°<code>thrust::</code>å¼€å¤´</li><li>Thrustä¸­æœ‰ä¸¤ç§çŸ¢é‡ï¼š<ul><li><code>thrust::host_vector&lt;typename&gt;</code>ï¼Œå­˜å‚¨äºä¸»æœºä¸­</li><li><code>thrust::device_vector&lt;typename&gt;</code>ï¼Œå­˜å‚¨äºè®¾å¤‡ä¸­<ul><li><code>thrust::devive_vectot&lt;double&gt; x(10, 0);</code>ï¼Œå…ƒç´ ç±»å‹ä¸ºåŒç²¾åº¦æµ®ç‚¹æ•°(å…¨éƒ¨åˆå§‹åŒ–ä¸º0)ï¼Œé•¿åº¦ä¸º10</li></ul></li></ul></li><li>é™¤äº†<code>thrust::copy</code>ï¼ŒThrustç®—æ³•çš„å‚æ•°å¿…é¡»<strong>éƒ½</strong>æ¥è‡ªäºä¸»æœºçŸ¢é‡æˆ–<strong>éƒ½</strong>æ¥è‡ªäºè®¾å¤‡çŸ¢é‡ï¼Œå¦åˆ™ç¼–è¯‘å™¨ä¼šæŠ¥é”™</li></ul><h3 id="14-2-4-ä¾‹å­ï¼šå‰ç¼€å’Œ"><a href="#14-2-4-ä¾‹å­ï¼šå‰ç¼€å’Œ" class="headerlink" title="14.2.4 ä¾‹å­ï¼šå‰ç¼€å’Œ"></a>14.2.4 ä¾‹å­ï¼šå‰ç¼€å’Œ</h3><ol><li>ä½¿ç”¨<code>device_vector</code>æ¥å®ç°<pre class="line-numbers language-c" data-language="c"><code class="language-c">thrust<span class="token operator">::</span><span class="token function">device_vector</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token function">x</span><span class="token punctuation">(</span>N<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>thrust<span class="token operator">::</span><span class="token function">device_vector</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token function">y</span><span class="token punctuation">(</span>N<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ol><ul><li>æ‰«ææ“ä½œ<pre class="line-numbers language-c" data-language="c"><code class="language-c">thrust<span class="token operator">::</span><span class="token function">inclusive_scan</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> y<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><code>thrust::inclusive_scan(InputIterator begin, InputIterator end, OutputIterator result);</code><br>  <code>InputIterator begin</code> è¾“å…¥èŒƒå›´çš„èµ·å§‹è¿­ä»£å™¨ã€‚<br>  <code>InputIterator end</code>: è¾“å…¥èŒƒå›´çš„ç»“æŸè¿­ä»£å™¨ã€‚<br>  <code>OutputIterator result</code>: ç”¨äºå­˜å‚¨ç»“æœçš„è¾“å‡ºèŒƒå›´èµ·å§‹è¿­ä»£å™¨ã€‚<br>  è¿™é‡Œçš„è¿­ä»£å™¨å¯ä»¥ç†è§£ä¸ºæŒ‡é’ˆçš„æ¨å¹¿<br>ä¾‹å­ä¸­ä½¿ç”¨äº†<code>thrust::inclusive_scan(x.begin(), x.end(), y.begin());</code></li><li>è¾“å‡º<br><code>y</code>æ˜¯è®¾å¤‡çŸ¢é‡ï¼Œ<code>y[i]</code>ä¸æ˜¯æ™®é€šæ•´å‹çš„å˜é‡ï¼Œéœ€è¦å¼ºåˆ¶è½¬åŒ–ä¸ºæ•´å‹åæ‰èƒ½ç”¨<code>printf()</code>å‡½æ•°è¾“å‡ºã€‚ç”¨C++çš„è¾“å…¥/è¾“å‡ºæµå¯ä»¥ç›´æ¥è¾“å‡º<code>y[i]</code>è€Œä¸éœ€è¦å…ˆåšå¼ºåˆ¶ç±»å‹è½¬æ¢</li></ul><ol start="2"><li>ç›´æ¥ç”¨è®¾å¤‡ä¸­çš„æ•°ç»„(æŒ‡é’ˆ)å®ç°</li></ol><ul><li><p>å®šä¹‰</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">cudaMalloc</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>x<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">*</span> N<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">cudaMalloc</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>y<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">*</span> N<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>æ‰«ææ“ä½œ</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">thrust<span class="token operator">::</span><span class="token function">inclusive_scan</span><span class="token punctuation">(</span>thrust<span class="token operator">::</span>device<span class="token punctuation">,</span> x<span class="token punctuation">,</span> x <span class="token operator">+</span> N<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¯¹äºä½¿ç”¨è®¾å¤‡çŸ¢é‡çš„ç‰ˆæœ¬ï¼Œè¯¥å‡½æ•°ç”¨äº†ä¸€ä¸ªé¢å¤–çš„<strong>è¡¨ç¤ºæ‰§è¡Œç­–ç•¥çš„å‚æ•°</strong><code>thrust::device</code>ï¼Œéœ€è¦åŒ…å«å¤´æ–‡ä»¶<code>&lt;thrust/execution_policy.h&gt;</code></p></li><li><p>å¦‚æœå¤§é‡ä½¿ç”¨Thruståº“æä¾›çš„åŠŸèƒ½ï¼Œä½¿ç”¨è®¾å¤‡çŸ¢é‡</p></li><li><p>å¦‚æœå¶å°”ä½¿ç”¨Thruståº“æä¾›çš„åŠŸèƒ½ï¼Œä½¿ç”¨è®¾å¤‡æŒ‡é’ˆ</p></li></ul><h2 id="14-3-cuBLASåº“"><a href="#14-3-cuBLASåº“" class="headerlink" title="14.3 cuBLASåº“"></a>14.3 cuBLASåº“</h2><p>è¡Œä¸»åºå’Œåˆ—ä¸»åºï¼Œå‰è€…è¦æ±‚çŸ©é˜µçš„æ¯ä¸€è¡Œå…ƒç´ åœ¨å†…å­˜ä¸­æ˜¯è¿ç»­çš„ï¼Œåè€…ä»¥æ­¤ç±»æ¨</p><p>cuBLASåº“åŒ…å«3ä¸ªAPIï¼Œå…¶ä¸­ä¸€ä¸ªä¸º<code>cuBLAS API</code>ï¼Œå¯ä»¥å®ç°BLASä¸‰ä¸ªå±‚çº§çš„å‡½æ•°</p><ul><li>ç¬¬ä¸€å±‚å‡½æ•°å¤„ç†çŸ¢é‡ä¹‹é—´çš„è¿ç®—</li><li>ç¬¬äºŒå±‚å‡½æ•°å¤„ç†çŸ©é˜µå’ŒçŸ¢é‡ä¹‹é—´çš„è¿ç®—</li><li>ç¬¬ä¸‰å±‚å‡½æ•°å¤„ç†çŸ©é˜µä¹‹é—´çš„è¿ç®—</li></ul><h3 id="14-3-2-ä¾‹å­ï¼šçŸ©é˜µä¹˜æ³•"><a href="#14-3-2-ä¾‹å­ï¼šçŸ©é˜µä¹˜æ³•" class="headerlink" title="14.3.2 ä¾‹å­ï¼šçŸ©é˜µä¹˜æ³•"></a>14.3.2 ä¾‹å­ï¼šçŸ©é˜µä¹˜æ³•</h3><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/refs/heads/main/CUDAC/249b3070465d0ba1c51fff0da2c2ac6.jpg" alt="|400"><br>ä½¿ç”¨<code>cuBLAS</code>æ—¶ä½¿ç”¨<code>&lt;cublas_v2.h&gt;</code>ä½œä¸ºå¤´æ–‡ä»¶<br>åœ¨åˆå§‹åŒ–<code>h_A</code>ã€<code>h_B</code>ã€<code>h_C</code>æ—¶ç”¨ä¸€ç»´çŸ¢é‡æ¥è¡¨ç¤ºçŸ©é˜µ</p><ol><li>ä¸»æœºæ•°ç»„å’Œè®¾å¤‡æ•°ç»„çš„å¤åˆ¶</li></ol><ul><li>ä»ä¸»æœºæ•°ç»„å¤åˆ¶åˆ°è®¾å¤‡æ•°ç»„<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">cublasStatus_t</span> <span class="token function">cublasSetVector</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">,</span><span class="token keyword">int</span> elemSize<span class="token punctuation">,</span>cosnt <span class="token keyword">void</span> <span class="token operator">*</span>x<span class="token punctuation">,</span><span class="token keyword">int</span> incx<span class="token punctuation">,</span><span class="token keyword">void</span> <span class="token operator">*</span>y<span class="token punctuation">,</span><span class="token keyword">int</span> incy<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><code>n</code>ï¼šå¤åˆ¶çš„å…ƒç´ ä¸ªæ•°<br><code>elemSize</code>ï¼šæ¯ä¸ªå…ƒç´ çš„å­—èŠ‚æ•°<br><code>incx</code>/<code>incy</code>ï¼šè¡¨ç¤ºå¯¹æ•°ç»„x/yè¿›è¡Œè®¿é—®æ—¶æ¯incx/incyä¸ªæ•°æ®ä¸­å–ä¸€ä¸ª<br><code>x</code>ï¼šä¸»æœºæ•°ç»„<br><code>y</code>ï¼šè®¾å¤‡æ•°ç»„<br>ä¾‹ï¼š<code>cublasSetVector(MK, sizeof(double), h_A, 1, g_A, 1);</code></li><li>ä»è®¾å¤‡æ•°ç»„å¤åˆ¶åˆ°ä¸»æœºæ•°ç»„<br><code>cublasGetVector()</code>å…¶ä¸­å‚æ•°ç›¸åŒï¼Œé¡ºåºä¸åŒ<br>ä¾‹ï¼š<code>cublasGetVector(MK, sizeof(double), g_A, 1, h_A, 1);</code></li></ul><ol start="2"><li>çŸ©é˜µä¹˜æ³•è®¡ç®—</li></ol><ul><li>å®šä¹‰ä¸€ä¸ª<code>cublasHandle</code>ç±»å‹çš„å˜é‡å¹¶ç”¨<code>cublasCreate()</code>å‡½æ•°åˆå§‹åŒ–</li><li>è°ƒç”¨<code>cublasDgemm()</code>å‡½æ•°åšçŸ©é˜µç›¸ä¹˜çš„è®¡ç®—<ul><li>æ˜¯ç¬¬ä¸‰å±‚çš„<code>cuBLAS</code>å‡½æ•°ä¹‹ä¸€</li><li><code>D</code>ï¼šdouble</li><li><code>gemm</code>ï¼šGEneral Matrix-Matrix multiplication</li><li>æ‰§è¡Œå¦‚ä¸‹è®¡ç®—<code>C = alpha * transa(A) * transb(B) + beta * C</code><ul><li><code>transa(A)</code>æ˜¯å¯¹çŸ©é˜µ<code>A</code>åšä¸€ä¸ªå˜æ¢ä¹‹åå¾—åˆ°çš„çŸ©é˜µï¼Œç»´åº¦æ˜¯<code>m Ã— k</code></li><li><code>transb(B)</code>æ˜¯å¯¹çŸ©é˜µ<code>B</code>åšä¸€ä¸ªå˜æ¢ä¹‹åå¾—åˆ°çš„çŸ©é˜µï¼Œç»´åº¦æ˜¯<code>k Ã— n</code></li><li><code>C</code>çš„ç»´åº¦æ˜¯<code>m Ã— n</code></li></ul></li></ul></li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">cublasDgemm</span><span class="token punctuation">(</span><span class="token class-name">cublasHandle_t</span> handle<span class="token punctuation">,</span><span class="token class-name">cublasOperation_t</span> transa<span class="token punctuation">,</span><span class="token class-name">cublasOperation_t</span> transb<span class="token punctuation">,</span><span class="token keyword">int</span> m<span class="token punctuation">,</span><span class="token keyword">int</span> n<span class="token punctuation">,</span><span class="token keyword">int</span> k<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">*</span>alpha<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">*</span>A<span class="token punctuation">,</span><span class="token keyword">int</span> lda<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">*</span>B<span class="token punctuation">,</span><span class="token keyword">int</span> ldb<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">*</span>beta<span class="token punctuation">,</span><span class="token keyword">double</span> <span class="token operator">*</span>C<span class="token punctuation">,</span><span class="token keyword">int</span> ldc<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>cublasOperation_t transa</code>ä¸­<code>transa</code>ä¸ºï¼š</p><ul><li><code>cuBLAS_OP_N</code>ï¼Œ<code>transa(A)</code>ç­‰äº<code>A</code></li><li><code>cuBLAS_OP_T</code>ï¼Œ<code>transa(A)</code>ç­‰äº<code>A</code>çš„è½¬ç½®</li><li><code>cuBLAS_OP_C</code>ï¼Œ<code>transa(A)</code>ç­‰äº<code>A</code>çš„å…±è½­è½¬ç½®<br><code>lda</code>ã€<code>ldb</code>å’Œ<code>ldc</code>åˆ†åˆ«æ˜¯<code>transa(A)</code>ã€<code>transa(B)</code>å’Œ<code>C</code>çš„ä¸»ç»´åº¦ï¼Œä»–ä»¬éƒ½æ˜¯åˆ—ä¸»åºï¼Œæ‰€ä»¥ä»–ä»¬çš„ä¸»ç»´åº¦æ˜¯çŸ©é˜µçš„è¡Œæ•°</li></ul><p>æœ€åçš„ç»“æœ<code>h_C</code>æ˜¯åˆ—ä¸»åºçš„(10 13 28 40)ï¼Œæ‰“å°æ—¶éœ€è¦æ³¨æ„</p><h1 id="è¡¥å……Event"><a href="#è¡¥å……Event" class="headerlink" title="è¡¥å……Event"></a>è¡¥å……Event</h1><ul><li><strong>åˆ›å»ºäº‹ä»¶</strong>ï¼šé¦–å…ˆä½¿ç”¨ <code>cudaEventCreate()</code> åˆ›å»ºäº‹ä»¶å¯¹è±¡ã€‚</li><li><strong>è®°å½•äº‹ä»¶</strong>ï¼šåœ¨éœ€è¦è®°å½•çš„æ—¶é—´ç‚¹è°ƒç”¨ <code>cudaEventRecord(event, stream)</code>ã€‚</li><li><strong>è®¡ç®—æ—¶é—´</strong>ï¼šé€šè¿‡ <code>cudaEventElapsedTime()</code> è®¡ç®—ä¸¤ä¸ªäº‹ä»¶ä¹‹é—´çš„æ—¶é—´å·®ã€‚</li><li><strong>é”€æ¯äº‹ä»¶</strong>ï¼šæœ€åä½¿ç”¨ <code>cudaEventDestroy()</code> é”€æ¯äº‹ä»¶å¯¹è±¡ä»¥é‡Šæ”¾èµ„æºã€‚</li><li><strong>åŒæ­¥</strong>ï¼š<code>cudaEventSynchronize(stop)</code> ä¼šé˜»å¡ CPUï¼Œç›´åˆ° GPU ç¡®ä¿ä» <code>start</code> åˆ° <code>stop</code> ä¹‹é—´çš„æ‰€æœ‰æ“ä½œéƒ½å®Œæˆäº†ã€‚è¿™å¯¹äºæµ‹é‡å†…æ ¸å‡½æ•°æ‰§è¡Œæ—¶é—´æˆ–åœ¨ CPU ä¾§è¿›è¡ŒåŒæ­¥éå¸¸é‡è¦ã€‚</li><li><strong>æ£€æŸ¥äº‹ä»¶æ˜¯å¦å®Œæˆ</strong>ï¼š<code>cudaEventQuery(start)</code>å®ƒçš„ä¸»è¦åŠŸèƒ½æ˜¯<strong>æ£€æŸ¥æŒ‡å®šçš„ CUDA äº‹ä»¶æ˜¯å¦å·²ç»å®Œæˆ</strong>ï¼Œè€Œä¸éœ€è¦é˜»å¡ä¸»æœºçº¿ç¨‹ã€‚<code>cudaEventQuery</code> å¸¸ç”¨äºéœ€è¦é¢‘ç¹æ£€æŸ¥äº‹ä»¶çŠ¶æ€çš„åœºæ™¯ã€‚å’Œ <code>cudaEventSynchronize</code> ä¸åŒï¼Œ<code>cudaEventQuery</code> æ˜¯éé˜»å¡çš„ï¼Œä¸ä¼šè®© CPU ç­‰å¾… GPU ä»»åŠ¡å®Œæˆï¼Œè€Œåªæ˜¯æ£€æŸ¥ GPU çš„æ‰§è¡ŒçŠ¶æ€ã€‚å¦‚æœäº‹ä»¶è¿˜æœªå®Œæˆï¼Œå®ƒä¼šç«‹å³è¿”å› <code>cudaErrorNotReady</code>ï¼Œè®©ç¨‹åºå¯ä»¥ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡ã€‚</li></ul><h1 id="è¡¥å……è¿è¡Œ"><a href="#è¡¥å……è¿è¡Œ" class="headerlink" title="è¡¥å……è¿è¡Œ"></a>è¡¥å……è¿è¡Œ</h1><p><code>$nvcc -arch=_75 add1.cu -o add1</code>ï¼Œé€‰æ‹©çœŸå®æ¶æ„è®¡ç®—èƒ½åŠ›<br><code>$nvcc -O3 -arch=_75 add1.cu -o add1</code>ï¼Œé€‰æ‹©æœ€æ¿€è¿›çš„ä¼˜åŒ–ï¼Œç”Ÿæˆæœ€å¿«çš„ä»£ç ï¼Œä½†å¯èƒ½ä¼šå¢åŠ ç¼–è¯‘æ—¶é—´å’ŒäºŒè¿›åˆ¶æ–‡ä»¶å¤§å°ã€‚(C++ç¨‹åºçš„æ€§èƒ½æ˜¾è‘—åœ°ä¾èµ–äºä¼˜åŒ–é€‰é¡¹)<br><code>$nvcc -O3 -arch=sm_75 -DUSE_DP add1.cu -o add1</code>ä½¿ç”¨<code>if</code>çš„é€‰é¡¹ï¼Œä¸å†™<code>-DUSE_DP</code>çš„è¯ä½¿ç”¨<code>else</code>çš„é€‰é¡¹</p><h1 id="è¡¥å……C-è¯­æ³•"><a href="#è¡¥å……C-è¯­æ³•" class="headerlink" title="è¡¥å……C++è¯­æ³•"></a>è¡¥å……C++è¯­æ³•</h1><p><code>void read_xy(std::vector&lt;real&gt;&amp; x, std::vector&lt;real&gt; y);</code>ï¼š</p><ul><li><code>std::vector</code>ï¼šC++çš„åŠ¨æ€æ•°ç»„ï¼Œå¤§å°æ˜¯åŠ¨æ€çš„</li><li><code>std::vector&lt;real&gt;&amp; x</code>ï¼šå¯¹äº<code>x</code>æ˜¯å¼•ç”¨ä¼ é€’ï¼Œåœ¨<code>read_xy</code>å‡½æ•°å†…éƒ¨å¯¹<code>x</code>çš„ä»»ä½•ä¿®æ”¹ï¼Œéƒ½ä¼šç›´æ¥å½±å“åˆ°ä»–ä»¬æœ¬èº«(è€Œä¸æ˜¯å‰¯æœ¬)ï¼Œå¯¹å¤–éƒ¨çš„<code>x</code>ä¹Ÿä¼šæœ‰å½±å“</li></ul><p><code>std::ifstream infile("xy.txt");</code></p><ul><li><code>std::ifstream</code>ï¼šè¡¨ç¤ºè¾“å…¥æ–‡ä»¶æµï¼Œç”¨äºä»æ–‡ä»¶è¯»å–æ•°æ®</li><li><code>infile</code>ï¼šç”¨æ¥æ‰“å¼€æ–‡ä»¶å¹¶è¯»å–å†…å®¹</li></ul><p><code>std::ofstream outfile("neighbor.txt");</code></p><ul><li><code>std::ofstream</code>ï¼šè¡¨ç¤ºè¾“å‡ºæ–‡ä»¶æµï¼Œå°†æ•°æ®å†™å…¥åˆ°æ–‡ä»¶ä¸­</li></ul><p><code>std::istringstream words(line);</code></p><ul><li><code>std::istringstream</code>ï¼šè¡¨ç¤ºè¾“å…¥å­—ç¬¦ä¸²æµï¼Œå¯ä»¥ä»ä¸€ä¸ªå­—ç¬¦ä¸²ä¸­é€ä¸ªæå–æ•°æ®</li><li><code>words</code>ï¼šä»å­—ç¬¦ä¸²ä¸­æå–æ•°æ®</li><li>è¿™æ®µä»£ç ä½œç”¨ï¼šä½¿ç”¨<code>words</code>æ¥é€ä¸ªè¯»å–<code>line</code>ä¸­çš„å•è¯æˆ–æ•°æ®</li></ul>]]></content>
      
      
      <categories>
          
          <category> é«˜æ€§èƒ½è®¡ç®— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> GPU </tag>
            
            <tag> CUDA </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mlc-llm é¦™æ©™æ´¾éƒ¨ç½²è¿‡ç¨‹</title>
      <link href="/2024/01/27/mlc-llm-orangepi-bu-shu-guo-cheng/"/>
      <url>/2024/01/27/mlc-llm-orangepi-bu-shu-guo-cheng/</url>
      
        <content type="html"><![CDATA[<p>å‚è€ƒç½‘ç«™ï¼š<a href="https://blog.mlc.ai/2023/08/09/GPU-Accelerated-LLM-on-Orange-Pi">GPU-Accelerated LLM on a $100 Orange Pi</a>ã€<a href="https://llm.mlc.ai/docs/install/gpu.html#orange-pi-5-rk3588-based-sbc">Orange Pi 5 (RK3588 based SBC)Â¶</a></p><p>èµ„æ–™æ¥æºï¼š<a href="https://github.com/mlc-ai/mlc-llm">Githubâ€”â€”mlc-llm</a></p><p>ç›¸å…³è®ºå›ï¼š<a href="https://www.reddit.com/r/MachineLearning/comments/15r1vy5/project_gpuaccelerated_llm_on_a_100_orange_pi/?rdt=33752&amp;onetap_auto=true">Redditâ€”â€”GPU-Accelerated LLM on a $100 Orange Pi</a></p><h1 id="1-Prepare"><a href="#1-Prepare" class="headerlink" title="1 Prepare"></a>1 Prepare</h1><h2 id="1-1-Installation"><a href="#1-1-Installation" class="headerlink" title="1.1 Installation"></a>1.1 Installation</h2><p><strong>- Download and istall the Ubuntu 22.04 for your board from <a href="https://github.com/Joshua-Riek/ubuntu-rockchip/releases/tag/v1.22">here</a></strong>(pick â€œOrange Pi 5 Plusâ€)<br>(:ps åœ¨è¿™ä¸ªç‰ˆæœ¬é‡Œï¼Œæˆ‘æ— æ³•ä½¿ç”¨ä¸²å£ï¼Œapt updateä¼šå‡ºç°æ— æ³•è§£æåŸŸåç­‰é—®é¢˜ï¼Œäºæ˜¯æœ€åç”¨äº†<a href="https://pan.baidu.com/s/1cQR1pcca0P-xuQbTrnGXAw?pwd=pjhv#list/path=%2Fsharelink1077680202-1101560075650855%2FUbuntu&amp;parentPath=%2Fsharelink1077680202-1101560075650855">é¦™æ©™æ´¾å®˜æ–¹çš„ç³»ç»Ÿâ€”â€”1.0.8_ubuntu_jammy_desktop_xfce_linux5.10.150</a><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LLM%E9%83%A8%E7%BD%B2%E5%9B%BE%E7%89%87/Pasted%20image%2020240127153142.png"></p><ol><li>åœ¨çƒ§å½•å‰ï¼Œéœ€è¦å‡†å¤‡ä¸€å¼ SDå¡(æˆ‘ç”¨çš„32G)ï¼Œå‡†å¤‡<a href="https://etcher.balena.io/#download-etcher">çƒ§å½•è½¯ä»¶balenaEtcher</a></li><li>å¦‚ä½•çŸ¥é“è‡ªå·±æ˜¯å¦çƒ§å½•æˆåŠŸï¼Ÿ<ul><li>ä½¿ç”¨ä¸²å£<a href="https://blog.csdn.net/itt21044ZCY/article/details/132742245#:~:text=%E9%A6%99%E6%A9%99%E6%B4%BE%E4%B8%B2%E5%8F%A3%E8%BF%9E%E6%8E%A5%E7%94%B5%E8%84%91%20%E4%B8%B2%E5%8F%A3%E8%BF%9E%E6%8E%A5%EF%BC%9AGND%E6%8E%A5GND%EF%BC%8CTX%E6%8E%A5RX%EF%BC%8CRX%E6%8E%A5TX%20%E4%B8%B2%E5%8F%A3%E7%9A%84%20TX%20%E5%92%8C%20RX%20%E6%98%AF%E9%9C%80%E8%A6%81%E4%BA%A4%E5%8F%89%E8%BF%9E%E6%8E%A5%E7%9A%84%EF%BC%8C%E5%A6%82%E6%9E%9C%E4%B8%8D%E6%83%B3%E4%BB%94%E7%BB%86%E5%8C%BA%E5%88%86%20TX%E5%92%8C,TX%20%E5%92%8C%20RX%20%E5%85%88%E9%9A%8F%E4%BE%BF%E6%8E%A5%E4%B8%8A%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%B5%8B%E8%AF%95%E4%B8%B2%E5%8F%A3%E6%B2%A1%E6%9C%89%E8%BE%93%E5%87%BA%E5%86%8D%E4%BA%A4%E6%8D%A2%E4%B8%8B%20TX%20%E5%92%8C%20RX%20%E7%9A%84%E9%A1%BA%E5%BA%8F%EF%BC%8C%E8%BF%99%E6%A0%B7%E5%B0%B1%E6%80%BB%E6%9C%89%E4%B8%80%E7%A7%8D%E9%A1%BA%E5%BA%8F%E6%98%AF%E5%AF%B9%E7%9A%84">CSDNâ€”â€”ä½¿ç”¨é¦™æ©™æ´¾è¿æ¥ç”µè„‘ï¼Œä¸²å£å’ŒSSH</a></li><li>ä½¿ç”¨å¦ä¸€ä¸ªæ˜¾ç¤ºå±æŸ¥çœ‹</li></ul></li><li>çƒ§å½•æˆåŠŸåï¼Œé€šè¿‡ä¸Šé¢ä¸¤ç§åŠæ³•çŸ¥é“é¦™æ©™æ´¾çš„ipåœ°å€(å¦‚æœæ˜¯ç”¨æ˜¾ç¤ºå±çš„ï¼Œåœ¨å®˜æ–¹æ–‡æ¡£é‡ŒæŸ¥é˜…â€œè®¾ç½®é™æ€IPåœ°å€çš„æ–¹æ³•â€)ï¼Œæˆ‘è‡ªå·±çš„ä¿®æ”¹ä¸ºäº†192.168.1.201ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œç”¨è‡ªå·±çš„ç”µè„‘pingä¸€ä¸‹é¦™æ©™æ´¾<img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LLM%E9%83%A8%E7%BD%B2%E5%9B%BE%E7%89%87/Pasted%20image%2020240126214418.png"></li><li>ä½¿ç”¨vscodeè¿æ¥é¦™æ©™æ´¾<a href="https://blog.csdn.net/mjmmm/article/details/133981063#:~:text=%E7%82%B9%E5%87%BB%E6%89%93%E5%BC%80%E6%96%87%E4%BB%B6%E5%A4%B9%EF%BC%9A%20%E4%B8%AD%E9%97%B4%E4%B8%8A%E6%96%B9%E9%80%89%E6%8B%A9%E2%80%9Csmart_bin%E2%80%9D%EF%BC%9A,%E7%82%B9%E5%87%BB%E2%80%9C%E7%A1%AE%E5%AE%9A%E2%80%9D%EF%BC%9A%20%E5%86%8D%E6%AC%A1%E9%80%89%E6%8B%A9%E2%80%9CLinux%E2%80%9D%EF%BC%8C%E5%B9%B6%E8%BE%93%E5%85%A5%E9%A6%99%E6%A9%99%E6%B4%BE%E5%AF%86%E7%A0%81%EF%BC%9A%20%E6%AD%A4%E6%97%B6%EF%BC%8C%E5%B0%B1%E6%88%90%E5%8A%9F%E8%BF%9E%E6%8E%A5%E4%B8%8A%E4%BA%86smart_bin%E6%96%87%E4%BB%B6%E5%A4%B9%EF%BC%8C%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8VSCODE%E5%AF%B9%E4%BA%8E%E4%BB%A3%E7%A0%81%E8%BF%9B%E8%A1%8C%E7%BC%96%E8%BE%91%E6%93%8D%E4%BD%9C%E4%BA%86%EF%BC%81">CSDNâ€”â€”ä½¿ç”¨Visual Studio Codeè¿œç¨‹è¿æ¥é¦™æ©™æ´¾</a><ul><li>è¸©å‘ç‚¹ï¼šæ³¨æ„Ubuntuä¸Šæ˜¯å¦å¼€å¯äº†ssh</li><li>æ›´æ–°è½¯ä»¶åŒ…<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> update<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li>ä¸‹è½½<code>open ssh</code><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> openssh-server<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li>ä¸‹è½½å®ŒæˆåæŸ¥çœ‹<code>ssh</code>æ˜¯å¦æ‰“å¼€<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">ps</span> <span class="token parameter variable">-e</span> <span class="token operator">|</span><span class="token function">grep</span> <span class="token function">ssh</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>è¿æ¥æˆåŠŸåä¼šå‡ºç°ä¸‹é¢çš„å›¾<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LLM%E9%83%A8%E7%BD%B2%E5%9B%BE%E7%89%87/Pasted%20image%2020240126222152.png"></li></ul></li></ol><p><strong>- Download and install&nbsp;<code>libmali-g610.so</code></strong></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /usr/lib <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token function">wget</span> https://github.com/JeffyCN/mirrors/raw/libmali/lib/aarch64-linux-gnu/libmali-valhall-g610-g6p0-x11-wayland-gbm.so<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol><li>æˆ‘çš„é¦™æ©™æ´¾æ— æ³•è®¿é—®githubï¼Œäºæ˜¯é‡‡ç”¨ä¸»æœºä¸‹è½½æ–‡ä»¶åç”¨FileZillaä¼ è¾“æ–‡ä»¶åˆ°è™šæ‹Ÿæœºä¸Šï¼Œç”¨äº†ä¹‹å‰æ–¹æ³•ä½†æ˜¯æ˜¾ç¤ºæ— æ³•è¿æ¥<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LLM%E9%83%A8%E7%BD%B2%E5%9B%BE%E7%89%87/Pasted%20image%2020240127093218.png"></li><li>æ›´æ”¹åè®®åè¿æ¥æˆåŠŸï¼Œåè®®å¦‚ä¸‹å›¾æ‰€ç¤º<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LLM%E9%83%A8%E7%BD%B2%E5%9B%BE%E7%89%87/Pasted%20image%2020240127094737.png"></li><li>åœ¨ä¸»æœºä¸Šç‚¹å‡»<a href="https://github.com/JeffyCN/mirrors/tree/libmali/lib/aarch64-linux-gnu">ç½‘ç«™</a>æ‰¾åˆ°libmali-valhall-g610-g6p0-x11-wayland-gbm.soå¹¶ä¸‹è½½</li><li>FileZillaå‡ºç°â€œæ— æ³•å¯åŠ¨ä¼ è¾“â€å­—æ · <img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LLM%E9%83%A8%E7%BD%B2%E5%9B%BE%E7%89%87/Pasted%20image%2020240127100058.png"><ul><li>åŸå› ï¼šæ–‡ä»¶æƒé™ä¸è¶³</li><li>è§£å†³ï¼šä¿®æ”¹è¿œç¨‹ç«™ç‚¹æ–‡ä»¶çš„æƒé™<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">chmod</span> <span class="token parameter variable">-R</span> <span class="token number">777</span> æ–‡ä»¶å<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LLM%E9%83%A8%E7%BD%B2%E5%9B%BE%E7%89%87/Pasted%20image%2020240127100350.png"><br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LLM%E9%83%A8%E7%BD%B2%E5%9B%BE%E7%89%87/Pasted%20image%2020240127100646.png"></li></ul></li></ol><p><strong>- Check if file&nbsp;<code>mali_csffw.bin</code>&nbsp;exist under path&nbsp;<code>/lib/firmware</code>, if not download it with command:</strong></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /lib/firmware <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token function">wget</span> https://github.com/JeffyCN/mirrors/raw/libmali/firmware/g610/mali_csffw.bin<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æˆ‘æ‰¾åˆ°äº†è¿™ä¸ªæ–‡ä»¶æ‰€ä»¥å°±ä¸ç”¨ä¸‹è½½äº†ï¼Œ<a href="https://github.com/JeffyCN/mirrors/tree/libmali/firmware/g610">æ–‡ä»¶ä¸‹è½½å¤„</a><br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LLM%E9%83%A8%E7%BD%B2%E5%9B%BE%E7%89%87/Pasted%20image%2020240127101202.png"></p><p><strong>- Download OpenCL ICD loader and manually add libmali to ICD</strong></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> update<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> mesa-opencl-icd<span class="token function">sudo</span> <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/OpenCL/vendors<span class="token builtin class-name">echo</span> <span class="token string">"/usr/lib/libmali-valhall-g610-g6p0-x11-wayland-gbm.so"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/OpenCL/vendors/mali.icd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="1-2-Validata-Installation"><a href="#1-2-Validata-Installation" class="headerlink" title="1.2 Validata Installation"></a>1.2 Validata Installation</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">clinfo<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="1-3-Prepare"><a href="#1-3-Prepare" class="headerlink" title="1.3 Prepare"></a>1.3 Prepare</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># clone mlc-llm from GitHub</span><span class="token function">git</span> clone <span class="token parameter variable">--recursive</span> https://github.com/mlc-ai/mlc-llm.git <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> mlc-llm<span class="token comment"># Download prebuilt weights and libs</span><span class="token function">git</span> lfs <span class="token function">install</span><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> dist/prebuilt <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> dist/prebuilt<span class="token function">git</span> clone https://github.com/mlc-ai/binary-mlc-llm-libs.git lib<span class="token function">git</span> clone https://huggingface.co/mlc-ai/mlc-chat-RedPajama-INCITE-Chat-3B-v1-q4f16_1<span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>/<span class="token punctuation">..</span>/<span class="token punctuation">..</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘é‡‡ç”¨åœ¨æœ¬åœ°æ‹‰å–åå†ä¼ è¾“åˆ°é¦™æ©™æ´¾ä¸Šï¼Œå»ºè®®æ˜¯å…ˆå‹ç¼©å†ä¼ è¾“ï¼Œå†åœ¨é¦™æ©™æ´¾ä¸Šè§£å‹(.zip)</p><p>åœ¨ç¬¬ä¸€æ­¥<code>git clone --recursive https://github.com/mlc-ai/mlc-llm.git &amp;&amp; cd mlc-llm</code>å¦‚æœé‡åˆ°è¿™ä¸ª443é—®é¢˜ï¼Œç‚¹å‡»<a href="https://blog.csdn.net/qq_40296909/article/details/134285451">é“¾æ¥</a><br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LLM%E9%83%A8%E7%BD%B2%E5%9B%BE%E7%89%87/Pasted%20image%2020240127140733.png"></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> config <span class="token parameter variable">--global</span> http.proxy <span class="token number">127.0</span>.0.1:7890<span class="token function">git</span> config <span class="token parameter variable">--global</span> https.proxy <span class="token number">127.0</span>.0.1:7890<span class="token comment"># æ³¨æ„7890è¦æ”¹æˆè‡ªå·±çš„ç”µè„‘ä¸Šçš„</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone <span class="token parameter variable">--recursive</span> https://github.com/mlc-ai/mlc-llm.git <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> mlc-llm<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> lfs <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>åœ¨è¿™ä¸€æ­¥ä¹‹å‰å…ˆinstall<code>git-lfs</code></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> git-lfs<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ğŸ‘‡åœ¨å®¿ä¸»æœºä¸­åˆ›å»ºæ–‡ä»¶å¹¶è¿›å…¥æ–‡ä»¶<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LLM%E9%83%A8%E7%BD%B2%E5%9B%BE%E7%89%87/Pasted%20image%2020240127143842.png"><br>ğŸ‘‡ä¼šç›´æ¥åœ¨ä½ (ä¸»æœº)é€‰ä¸­çš„ç›®å½•ä¸‹(æˆ‘è¿™é‡Œçš„æ˜¯mlc-llm)ä¸‹æœ‰ä¸€ä¸ªlibæ–‡ä»¶<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LLM%E9%83%A8%E7%BD%B2%E5%9B%BE%E7%89%87/Pasted%20image%2020240127144257.png"><br>å°†ä¸»æœºä¸­çš„libå‹ç¼©åæ‹–è¿›å®¿ä¸»æœºçš„libæ–‡ä»¶ä¸‹<br>ğŸ‘‡åœ¨å®¿ä¸»æœºä¸­cdåˆ°libå¹¶å°†åˆšæ‰çš„å‹ç¼©åŒ…è§£å‹ç¼©</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">unzip</span> FileName.zip <span class="token comment"># è§£å‹</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LLM%E9%83%A8%E7%BD%B2%E5%9B%BE%E7%89%87/Pasted%20image%2020240127152142.png"></p><p>RedPajama-INCITE-Chat-3B-v1-q4f16_1:<a href="https://huggingface.co/togethercomputer/RedPajama-INCITE-Chat-3B-v1">https://huggingface.co/togethercomputer/RedPajama-INCITE-Chat-3B-v1</a></p><p>Llama-2-7b-chat-hf-q4f16_1:<a href="https://huggingface.co/mlc-ai/mlc-chat-Llama-2-7b-chat-hf-q4f16_1">https://huggingface.co/mlc-ai/mlc-chat-Llama-2-7b-chat-hf-q4f16_1</a></p><p>Llama-2-13b-chat-hf-q4f16_1:<a href="https://huggingface.co/mlc-ai/mlc-chat-Llama-2-13b-chat-hf-q4f16_1">https://huggingface.co/mlc-ai/mlc-chat-Llama-2-13b-chat-hf-q4f16_1</a></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone https://huggingface.co/mlc-ai/mlc-chat-Llama-2-13b-chat-hf-q4f16_1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ğŸ‘†åœ¨ä¸»æœºä¸Šä¸‹è½½(æ³¨æ„è¿™ä¸ªç½‘å€å–å†³äºä½ ç”¨ä»€ä¹ˆæ¥ä½œä¸ºæ¨¡å‹)ï¼Œä¸‹è½½å®Œæ¯•åé‡‡ç”¨ğŸ‘‡å‘½ä»¤ä¼ è¾“åˆ°é¦™æ©™æ´¾ä¸Šï¼Œå¥½å¤„æ˜¯å¯ä»¥çœ‹åˆ°ä¼ è¾“çš„è¿‡ç¨‹(è¿™ä¸ªæ–‡ä»¶æœ‰13å¤šä¸ªG)<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LLM%E9%83%A8%E7%BD%B2%E5%9B%BE%E7%89%87/Pasted%20image%2020240127151212.png"></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">scp</span> <span class="token parameter variable">-r</span> ./mlc-chat-Llama-2-13b-chat-hf-q4f16_1 orangepi@192.168.1.202:/home/orangepi/Project/MLC-LLM/dist/prebuit<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">scp</span> <span class="token parameter variable">-r</span> ç›¸å¯¹è·¯å¾„ä¸‹éœ€è¦ä¼ è¾“çš„æ–‡ä»¶ ä¸»æœºå@ip:è¢«ä¼ è¾“æ–‡ä»¶çš„ç›®çš„æ–‡ä»¶<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h1 id="2-Try-out-the-CLI"><a href="#2-Try-out-the-CLI" class="headerlink" title="2 Try out the CLI"></a>2 Try out the CLI</h1><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> mlc-llm/<span class="token comment"># create build directory</span><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> build <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> build<span class="token comment"># generate build configuration</span>python3 <span class="token punctuation">..</span>/cmake/gen_cmake_config.py<span class="token comment"># build `mlc_chat_cli`</span>cmake <span class="token punctuation">..</span> <span class="token operator">&amp;&amp;</span> cmake <span class="token parameter variable">--build</span> <span class="token builtin class-name">.</span> <span class="token parameter variable">--parallel</span> <span class="token variable"><span class="token variable">$(</span>nproc<span class="token variable">)</span></span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> <span class="token punctuation">..</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">python3 <span class="token punctuation">..</span>/cmake/gen_cmake_config.py<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ğŸ‘†è¿™ä¸€æ­¥ä¸­ï¼Œ<code>CUDA</code>ã€<code>Vulkan</code>ã€<code>ROCm</code>ã€<code>Metal</code>å…¨é€‰<code>n</code>ï¼Œå…¶ä½™é€‰<code>y</code></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">cmake <span class="token punctuation">..</span> <span class="token operator">&amp;&amp;</span> cmake <span class="token parameter variable">--build</span> <span class="token builtin class-name">.</span> <span class="token parameter variable">--parallel</span> <span class="token variable"><span class="token variable">$(</span>nproc<span class="token variable">)</span></span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> <span class="token punctuation">..</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ğŸ‘†åœ¨è¿™ä¸€æ­¥å¯èƒ½ä¼šæŠ¥ä¸¤æ¬¡é”™<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LLM%E9%83%A8%E7%BD%B2%E5%9B%BE%E7%89%87/Pasted%20image%2020240127155002.png"></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> cmake<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¿˜æœ‰ä¸€ä¸ªæŠ¥é”™æ²¡æ‰¾åˆ°å›¾ï¼Œå¤§æ¦‚æ„æ€æ˜¯æ‰¾ä¸åˆ°cargoï¼Œinstallä¸€ä¸ªå°±å¥½ğŸ‘‡</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> <span class="token function">cargo</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LLM%E9%83%A8%E7%BD%B2%E5%9B%BE%E7%89%87/Pasted%20image%2020240127155902.png"><br>è§£å†³æ–¹æ³•<a href="https://blog.csdn.net/iamzhoujunjia/article/details/113835347">æ›´æ¢Cargoè½¯ä»¶æº</a></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> <span class="token environment constant">$HOME</span>/.cargo/config<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ğŸ‘†æˆ‘çš„æ˜¯æ–°å»ºçš„ä¸€ä¸ªæ–‡ä»¶</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># ä¸­ç§‘å¤§</span><span class="token punctuation">[</span>source.crates-io<span class="token punctuation">]</span>registry <span class="token operator">=</span> <span class="token string">"https://github.com/rust-lang/crates.io-index"</span>replace-with <span class="token operator">=</span> <span class="token string">'ustc'</span><span class="token punctuation">[</span>source.ustc<span class="token punctuation">]</span>registry <span class="token operator">=</span> <span class="token string">"git://mirrors.ustc.edu.cn/crates.io-index"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å†æ¬¡æ‰§è¡ŒğŸ‘‡å¯ä»¥çœ‹åˆ°æœ‰åç»­çš„è¿›åº¦</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">cmake <span class="token punctuation">..</span> <span class="token operator">&amp;&amp;</span> cmake <span class="token parameter variable">--build</span> <span class="token builtin class-name">.</span> <span class="token parameter variable">--parallel</span> <span class="token variable"><span class="token variable">$(</span>nproc<span class="token variable">)</span></span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> <span class="token punctuation">..</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LLM%E9%83%A8%E7%BD%B2%E5%9B%BE%E7%89%87/Pasted%20image%2020240127161834.png"><br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LLM%E9%83%A8%E7%BD%B2%E5%9B%BE%E7%89%87/Pasted%20image%2020240127162004.png"></p><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LLM%E9%83%A8%E7%BD%B2%E5%9B%BE%E7%89%87/Pasted%20image%2020240127162200.png"></p><p>ğŸ‘†è¿™ä¸€æ­¥æ˜¯è®©æˆ‘ä»¬çœ‹æ˜¯å¦æœ‰ä¸‰ä¸ªæ–‡ä»¶ï¼Œåˆ†åˆ«å¯¹åº”å³å›¾ä¸­ç»¿è‰²çš„ä¸‰ä¸ª</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./build/mlc_chat_cli <span class="token parameter variable">--model</span> Llama-2-13b-chat-hf-q4f16_1 â€“device mali<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æŠ¥é”™ï¼šæ‰¾ä¸åˆ°<code>mlc-chat-config.json</code><br>è§£å†³é—®é¢˜<a href="https://github.com/mlc-ai/mlc-llm/issues/730">Githubâ€”â€”Cannot find â€œmlc-chat-config.jsonâ€ in path â€œâ€distâ€/RedPajama-INCITE-Chat-3B-v1-q4f16_1</a>ï¼š<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LLM%E9%83%A8%E7%BD%B2%E5%9B%BE%E7%89%87/Pasted%20image%2020240127164042.png"><br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LLM%E9%83%A8%E7%BD%B2%E5%9B%BE%E7%89%87/Pasted%20image%2020240127164305.png"><br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LLM%E9%83%A8%E7%BD%B2%E5%9B%BE%E7%89%87/Pasted%20image%2020240127164020.png"><br>åŸå› ï¼š<code>mlc-chat-config.json</code>åœ¨<code>mlc-llm</code>çš„ä¸Šä¸€çº§æ–‡ä»¶é‡Œçš„<code>mlc-chat-Llama-2-13b-chat-hf-q4f16_1</code>æ–‡ä»¶ä¸­ï¼Œä¸€å¼€å§‹æ˜¯åœ¨<code>mlc-llm</code>ä¸­<code>bulid</code>ä¸­è¿è¡Œï¼Œå› ä¸ºæ— æ³•è°ƒç”¨/è®¿é—®<code>mlc-llm</code>çš„åŒçº§æ–‡ä»¶æ‰€ä»¥æŠ¥é”™ã€‚æ‰€ä»¥æ¢æˆ<code>MLC-LLM</code>æ¥è°ƒç”¨<code>mlc_chat_cli</code>ï¼Œå³<code>dist</code>çš„ä¸Šä¸€çº§</p><p><strong>å¤§åŠŸå‘Šæˆï¼</strong><br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LLM%E9%83%A8%E7%BD%B2%E5%9B%BE%E7%89%87/Pasted%20image%2020240127170657.png"></p>]]></content>
      
      
      <categories>
          
          <category> äººå·¥æ™ºèƒ½ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> äººå·¥æ™ºèƒ½ </tag>
            
            <tag> NLP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç›®æ ‡æ£€æµ‹(ç¯å¢ƒé…ç½®)</title>
      <link href="/2023/12/04/mu-biao-jian-ce/"/>
      <url>/2023/12/04/mu-biao-jian-ce/</url>
      
        <content type="html"><![CDATA[<p>é™„æœ¬èœé¸¡åœ¨windowsä¸Šè¿è¡ŒæˆåŠŸçš„(é€šè¿‡ç”µè„‘æ‘„åƒå¤´çš„)yolo<a href="https://github.com/Wabbybabb0/yolov5-5.0_hat_person">ç›®æ ‡æ£€æµ‹</a></p><p><strong>é…ç½®ç¯å¢ƒçš„æ—¶å€™æƒ³æ¸…æ¥šæ”¾åœ¨å“ªä¸ªç›˜ï¼Œç‰¹åˆ«æ˜¯è™šæ‹Ÿæœºï¼Œæ”¾Cç›˜å¾ˆå¯èƒ½ä¼šg</strong></p><p>ç›®å‰å› ä¸ºèŠ¯ç‰‡é—®é¢˜å¡ä½äº†ï¼Œè¿˜ä¼šæŒç»­æ›´æ–°çš„â€¦.(ä¹Ÿè®¸æ˜¯24å¹´ï¼Ÿ)</p><h1 id="1-é¡¹ç›®ä»£ç ç»“æ„æ•´"><a href="#1-é¡¹ç›®ä»£ç ç»“æ„æ•´" class="headerlink" title="1 é¡¹ç›®ä»£ç ç»“æ„æ•´"></a>1 é¡¹ç›®ä»£ç ç»“æ„æ•´</h1><ul><li>dataï¼šä¸»è¦æ˜¯å­˜æ”¾ä¸€äº›è¶…å‚æ•°çš„é…ç½®æ–‡ä»¶ï¼ˆè¿™äº›æ–‡ä»¶ï¼ˆyamlæ–‡ä»¶ï¼‰æ˜¯ç”¨æ¥é…ç½®è®­ç»ƒé›†å’Œæµ‹è¯•é›†è¿˜æœ‰éªŒè¯é›†çš„è·¯å¾„çš„ï¼Œå…¶ä¸­è¿˜åŒ…æ‹¬ç›®æ ‡æ£€æµ‹çš„ç§ç±»æ•°å’Œç§ç±»çš„åç§°ï¼‰ï¼›è¿˜æœ‰ä¸€äº›å®˜æ–¹æä¾›æµ‹è¯•çš„å›¾ç‰‡ã€‚å¦‚æœæ˜¯è®­ç»ƒè‡ªå·±çš„æ•°æ®é›†çš„è¯ï¼Œé‚£ä¹ˆå°±éœ€è¦ä¿®æ”¹å…¶ä¸­çš„yamlæ–‡ä»¶ã€‚ä½†æ˜¯è‡ªå·±çš„æ•°æ®é›†ä¸å»ºè®®æ”¾åœ¨è¿™ä¸ªè·¯å¾„ä¸‹é¢ï¼Œè€Œæ˜¯å»ºè®®æŠŠæ•°æ®é›†æ”¾åˆ°yolov5é¡¹ç›®çš„åŒçº§ç›®å½•ä¸‹é¢ã€‚</li><li>modelsï¼šé‡Œé¢ä¸»è¦æ˜¯ä¸€äº›ç½‘ç»œæ„å»ºçš„é…ç½®æ–‡ä»¶å’Œå‡½æ•°ï¼Œå…¶ä¸­åŒ…å«äº†è¯¥é¡¹ç›®çš„å››ä¸ªä¸åŒçš„ç‰ˆæœ¬ï¼Œåˆ†åˆ«ä¸ºæ˜¯sã€mã€lã€xã€‚ä»åå­—å°±å¯ä»¥çœ‹å‡ºï¼Œè¿™å‡ ä¸ªç‰ˆæœ¬çš„å¤§å°ã€‚ä»–ä»¬çš„æ£€æµ‹æµ‹åº¦åˆ†åˆ«éƒ½æ˜¯ä»å¿«åˆ°æ…¢ï¼Œä½†æ˜¯ç²¾ç¡®åº¦åˆ†åˆ«æ˜¯ä»ä½åˆ°é«˜ã€‚è¿™å°±æ˜¯æ‰€è°“çš„é±¼å’Œç†ŠæŒä¸å¯å…¼å¾—ã€‚å¦‚æœè®­ç»ƒè‡ªå·±çš„æ•°æ®é›†çš„è¯ï¼Œå°±éœ€è¦ä¿®æ”¹è¿™é‡Œé¢ç›¸å¯¹åº”çš„yamlæ–‡ä»¶æ¥è®­ç»ƒè‡ªå·±æ¨¡å‹ã€‚</li><li>utilsï¼šå­˜æ”¾çš„æ˜¯å·¥å…·ç±»çš„å‡½æ•°ï¼Œé‡Œé¢æœ‰losså‡½æ•°ï¼Œmetricså‡½æ•°ï¼Œplotså‡½æ•°ç­‰ç­‰ã€‚</li><li>weightsï¼šæ”¾ç½®è®­ç»ƒå¥½çš„æƒé‡å‚æ•°ã€‚</li><li>detect.pyï¼šåˆ©ç”¨è®­ç»ƒå¥½çš„æƒé‡å‚æ•°è¿›è¡Œç›®æ ‡æ£€æµ‹ï¼Œå¯ä»¥è¿›è¡Œå›¾åƒã€è§†é¢‘å’Œæ‘„åƒå¤´çš„æ£€æµ‹ã€‚</li><li>train.pyï¼šè®­ç»ƒè‡ªå·±çš„æ•°æ®é›†çš„å‡½æ•°ã€‚</li><li>test.pyï¼šæµ‹è¯•è®­ç»ƒçš„ç»“æœçš„å‡½æ•°ã€‚</li><li>requirements.txtï¼šè¿™æ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œé‡Œé¢å†™ç€ä½¿ç”¨yolov5é¡¹ç›®çš„ç¯å¢ƒä¾èµ–åŒ…çš„ä¸€äº›ç‰ˆæœ¬ï¼Œå¯ä»¥åˆ©ç”¨è¯¥æ–‡æœ¬å¯¼å…¥ç›¸åº”ç‰ˆæœ¬çš„åŒ…ã€‚</li></ul><h1 id="2-ä»githubä¸Šæ‹‰å–çš„åŒ…"><a href="#2-ä»githubä¸Šæ‹‰å–çš„åŒ…" class="headerlink" title="2 ä»githubä¸Šæ‹‰å–çš„åŒ…"></a>2 ä»githubä¸Šæ‹‰å–çš„åŒ…</h1><h2 id="2-1-æœ€å¥½åˆ›å»ºä¸€ä¸ªæ–°çš„è™šæ‹Ÿç¯å¢ƒï¼Œå› ä¸ºyoloå¯¹ä¸€äº›åº“æœ‰ç‰ˆæœ¬è¦æ±‚"><a href="#2-1-æœ€å¥½åˆ›å»ºä¸€ä¸ªæ–°çš„è™šæ‹Ÿç¯å¢ƒï¼Œå› ä¸ºyoloå¯¹ä¸€äº›åº“æœ‰ç‰ˆæœ¬è¦æ±‚" class="headerlink" title="2.1 æœ€å¥½åˆ›å»ºä¸€ä¸ªæ–°çš„è™šæ‹Ÿç¯å¢ƒï¼Œå› ä¸ºyoloå¯¹ä¸€äº›åº“æœ‰ç‰ˆæœ¬è¦æ±‚"></a>2.1 æœ€å¥½åˆ›å»ºä¸€ä¸ªæ–°çš„è™šæ‹Ÿç¯å¢ƒï¼Œå› ä¸º<code>yolo</code>å¯¹ä¸€äº›åº“æœ‰ç‰ˆæœ¬è¦æ±‚</h2><p><a href="https://www.bilibili.com/video/BV1cD4y1H7Tk/?spm_id_from=333.337.search-card.all.click&amp;vd_source=1e1c4d48c6129699686897a835e568ea">åˆ›å»ºè™šæ‹Ÿç¯å¢ƒâ€“bç«™è§†é¢‘æ•™ç¨‹</a>ï¼Œè§†é¢‘è¯„è®ºåŒºç½®é¡¶å¤„ä¸‹æœ‰pdfè®²ä¹‰ï¼Œå¯ä¸‹è½½ã€‚ä¸æƒ³çœ‹è§†é¢‘çš„å¯ä»¥ç›´æ¥ç‚¹<a href="https://pan.baidu.com/s/1Xnhv-NSmtggYqKlg3uAlMg#list/path=%2F">è®²ä¹‰é“¾æ¥</a><br>å…¶ä¸­ï¼š</p><ul><li>æ³¨æ„<code>NVIDA</code>ã€<code>CUDA</code>ã€<code>pytorch</code>çš„å‹å·æ˜¯å¦äº’ç›¸å…¼å®¹</li><li>æ³¨æ„ç½‘ç»œé—®é¢˜ï¼Œæœ‰æ—¶å€™å…³æ‰æ¢¯å­ä¼šå¥½ç‚¹</li><li>æºçš„é—®é¢˜ï¼Œæ‰¾åˆ°ä¸€ä¸ªé˜¿é‡Œäº‘æ¯”è¾ƒå¥½ç”¨çš„ï¼š<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip config <span class="token builtin class-name">set</span> global.index-url https://mirrors.aliyun.com/pypi/simple pip config <span class="token builtin class-name">set</span> install.trusted-host mirrors.aliyun.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li>è®°å½•é€”ä¸­ç”¨åˆ°çš„<code>whl</code>è·¯å¾„<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip <span class="token function">install</span> D:<span class="token punctuation">\</span>whl<span class="token punctuation">\</span>torch-1.12.0+cu116-cp39-cp39-win_amd64.whlpip <span class="token function">install</span> D:<span class="token punctuation">\</span>whl<span class="token punctuation">\</span>torchvision-0.13.0+cu116-cp39-cp39-win_amd64.whlpip <span class="token function">install</span> D:<span class="token punctuation">\</span>whl<span class="token punctuation">\</span>torchaudio-0.12.0+cu116-cp39-cp39-win_amd64.whl<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="2-2-ä¿®æ”¹ä»£ç æ—¶çš„ä¸€äº›æ³¨æ„äº‹é¡¹"><a href="#2-2-ä¿®æ”¹ä»£ç æ—¶çš„ä¸€äº›æ³¨æ„äº‹é¡¹" class="headerlink" title="2.2 ä¿®æ”¹ä»£ç æ—¶çš„ä¸€äº›æ³¨æ„äº‹é¡¹"></a>2.2 ä¿®æ”¹ä»£ç æ—¶çš„ä¸€äº›æ³¨æ„äº‹é¡¹</h2><ol><li><code>train.py</code>ã€<code>dectect.py</code>å¯ä»¥é¢å‘CSDNç¼–ç¨‹</li></ol><ul><li>e.g.æŠ¥é”™No module named â€˜yamlâ€˜  ï¼Œåœ¨ç»ˆç«¯è¾“å…¥å¦‚ä¸‹æŒ‡ä»¤<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip <span class="token function">install</span> pyyaml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li>æ³¨æ„æ˜¯åœ¨ç»ˆç«¯å¤„ä¸‹è½½è¿˜æ˜¯åœ¨<code>Anaconda Prompt</code>å¤„ä¸‹è½½</li><li>æ³¨æ„<code>conda install</code>è¿˜æ˜¯<code>pip install</code>ï¼Œæ³¨æ„å…ˆæ¿€æ´»è™šæ‹Ÿç¯å¢ƒå†å®‰è£…åŒ…<code>conda activate xxx</code></li></ul><ol start="2"><li>æ³¨æ„è·¯å¾„é—®é¢˜ï¼š<ol><li>ç»å¯¹è·¯å¾„ï¼šåœ¨<code>train.py</code>ä¸­çš„ä¸‰è¡Œä»£ç é‡Œæœ€å¥½ä½¿ç”¨ç»å¯¹è·¯å¾„<img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/yolo_picture/Pasted%20image%2020231205120324.png"></li><li>ç›¸å¯¹è·¯å¾„ï¼šåœ¨<code>detect.py</code>ä¸­çš„<code>weights</code>ï¼Œåœ¨æˆ‘ä½¿ç”¨ç»å¯¹è·¯å¾„çš„æ—¶å€™æ˜¯æ— æ³•å®ç°æƒ³è¦çš„æ•ˆæœçš„ï¼Œä½†æ˜¯æ›´æ”¹ä¸º<code>weights/best.pt</code>(ä½¿ç”¨æœ€ä½³æ¨¡å‹åšæµ‹è¯•)æ—¶å¯ä»¥æ­£å¸¸è¿è¡Œ</li></ol></li></ol><h1 id="3-é…ç½®VMwareå’ŒUbuntu"><a href="#3-é…ç½®VMwareå’ŒUbuntu" class="headerlink" title="3 é…ç½®VMwareå’ŒUbuntu"></a>3 é…ç½®VMwareå’ŒUbuntu</h1><p>ä¸‹é¢æ˜¯ä¸¤ä¸ªå®‰è£…æ•™ç¨‹ï¼Œå¯ä»¥ç»“åˆé£Ÿç”¨ï¼š</p><h2 id="3-1VMwareè™šæ‹Ÿæœºå®‰è£…Linuxæ•™ç¨‹ï¼š"><a href="#3-1VMwareè™šæ‹Ÿæœºå®‰è£…Linuxæ•™ç¨‹ï¼š" class="headerlink" title="3.1VMwareè™šæ‹Ÿæœºå®‰è£…Linuxæ•™ç¨‹ï¼š"></a>3.1<a href="https://blog.csdn.net/weixin_52799373/article/details/124324077">VMwareè™šæ‹Ÿæœºå®‰è£…Linuxæ•™ç¨‹</a>ï¼š</h2><p>(ä»¥ä¸‹æ˜¯è¯¥æ•™ç¨‹çš„è™šæ‹Ÿæœºå’Œisoé€‰æ‹©ï¼Œå¯æ ¹æ®ä¸ªäººéœ€è¦è¿›è¡Œæ›´æ”¹ï¼Œä½†æ˜¯é…ç½®è¿‡ç¨‹å¤§å·®ä¸å·®)</p><ol><li>è™šæ‹Ÿæœºï¼šVMware16 pro</li><li>Linuxç³»ç»Ÿisoé•œåƒï¼šCentOS-7.5-x86_64</li></ol><h2 id="3-2-VMwareè™šæ‹Ÿæœºå®‰è£…Ubuntu20-04è¯¦ç»†å›¾æ–‡æ•™ç¨‹"><a href="#3-2-VMwareè™šæ‹Ÿæœºå®‰è£…Ubuntu20-04è¯¦ç»†å›¾æ–‡æ•™ç¨‹" class="headerlink" title="3.2 VMwareè™šæ‹Ÿæœºå®‰è£…Ubuntu20.04è¯¦ç»†å›¾æ–‡æ•™ç¨‹"></a>3.2 <a href="https://blog.csdn.net/weixin_41805734/article/details/120698714">VMwareè™šæ‹Ÿæœºå®‰è£…Ubuntu20.04è¯¦ç»†å›¾æ–‡æ•™ç¨‹</a></h2><p>(ä»¥ä¸‹æ˜¯è¯¥æ•™ç¨‹çš„è™šæ‹Ÿæœºå’Œisoé€‰æ‹©ï¼Œå¯æ ¹æ®ä¸ªäººéœ€è¦è¿›è¡Œæ›´æ”¹ï¼Œä½†æ˜¯é…ç½®è¿‡ç¨‹å¤§å·®ä¸å·®)</p><ol><li>è™šæ‹Ÿæœºï¼šVMware16</li><li>Linuxç³»ç»Ÿisoé•œåƒï¼šUbuntu20.04</li></ol><h2 id="3-3-ä¸€äº›è¯´æ˜"><a href="#3-3-ä¸€äº›è¯´æ˜" class="headerlink" title="3.3 ä¸€äº›è¯´æ˜"></a>3.3 ä¸€äº›è¯´æ˜</h2><p>æ­£å¦‚ä¸Šé¢ä¸€ä½åšä¸»æ‰€è¯´â€œä¸å¿…åˆ»æ„ç”¨æ—§ç‰ˆâ€</p><ol><li><p>å…³äºè™šæ‹Ÿæœºï¼šå¯é€‰æ‹©VMware 17ï¼Œ<a href="https://www.vmware.com/cn/products/workstation-player/workstation-player-evaluation.html">VMwareå®˜æ–¹ç½‘ç«™</a></p></li><li><p>å…³äºisoé•œåƒï¼šæ–°æ‰‹æ¨èä¸‹Ubuntuï¼Œå¯ä»¥å»<a href="https://ubuntu.com/download/desktop">Ubuntuå®˜æ–¹ç½‘ç«™</a><br> è¿™é‡Œé™„ä¸Š<a href="http://mirrors.aliyun.com/ubuntu-releases/20.04/">Ubuntu20.04</a>çš„é“¾æ¥(æ˜¯å›½å†…é•œåƒæºï¼Œä¸‹è½½ä¼šå¿«äº›)!<img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/yolo_picture/1701762736537.png"></p></li><li><p>è®¾ç½®å†…æ ¸å’Œå†…å­˜æ—¶å¯ä»¥æœ€å¥½è®¾ç½®å¥½ä¹‹åå°±ä¸æ”¹äº†ï¼Œå› ä¸ºä¿®æ”¹å†…å­˜æˆ–ç¡¬ç›˜å¤§å°ä¹‹åé‡å¯å¯èƒ½ä¼šbæºƒï¼Œæœ¬äººåœ¨ä¸‹å›¾ä¿®æ”¹ç¡¬ç›˜å¤§å°ä¹‹åæ— æ³•å†æ‰“å¼€è™šæ‹Ÿæœº<img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/yolo_picture/Pasted%20image%2020231205155730.png"></p></li></ol><h2 id="3-4-å®¿ä¸»æœºä¸è™šæ‹Ÿæœºäº’ä¼ æ–‡ä»¶"><a href="#3-4-å®¿ä¸»æœºä¸è™šæ‹Ÿæœºäº’ä¼ æ–‡ä»¶" class="headerlink" title="3.4 å®¿ä¸»æœºä¸è™šæ‹Ÿæœºäº’ä¼ æ–‡ä»¶"></a>3.4 å®¿ä¸»æœºä¸è™šæ‹Ÿæœºäº’ä¼ æ–‡ä»¶</h2><p><a href="https://blog.51cto.com/u_15309736/5424668">windowsä¸»æœºå’Œubuntuäº’ä¼ æ–‡ä»¶çš„4ç§æ–¹æ³•</a><br>æœ¬äººé€‰æ‹©ç¬¬äºŒä¸ªæ–¹æ³•ï¼š</p><ol><li>ubuntuå®‰è£…FTPæœåŠ¡<br> åœ¨ubuntuç»ˆç«¯è¾“å…¥å¦‚ä¸‹å‘½ä»¤<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> vsftpd<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li>å®‰è£…å®Œåæ£€æŸ¥<code>/etc /vsftpd.conf</code>é…ç½®æ–‡ä»¶<br>è¾“å…¥å¦‚ä¸‹å‘½ä»¤æ‰“å¼€é…ç½®æ–‡ä»¶ï¼šï¼ˆæ³¨æ„æ­¤å¤„åœ¨ç½‘å€ä¸Šè¾“å…¥çš„æ˜¯<code>sudo vi</code>ï¼Œä½†æ˜¯æœ¬äººä¸å¤ªä¼šä½¿ç”¨<code>vi</code>ç¼–è¾‘å™¨ï¼Œä¹Ÿæ‰¾ä¸åˆ°<code>vi</code>ç¼–è¾‘å™¨çš„ä½¿ç”¨æ–¹æ³•ï¼Œå› æ­¤ä½¿ç”¨äº†<code>vim</code>ï¼Œ<code>vim</code>ç¼–è¾‘å™¨çš„çš„æŒ‡ä»¤åœ¨ä¸‹æ–‡4.9æœ‰æåˆ°ï¼‰<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">vim</span> /etc/bsftpd.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li>windowså®‰è£…å’Œé…ç½®FIleZilla<br>ç‚¹å‡»<a href="https://www.filezilla.cn/download">FileZillaä¸‹è½½ä¸­å¿ƒ</a>ä¸‹è½½å®¢æˆ·ç«¯</li><li>FileZillaè½¯ä»¶é…ç½®ï¼š<br>æ‰“å¼€FileZillaè½¯ä»¶ï¼Œé€‰æ‹©ï¼šæ–‡ä»¶-&gt;ç«™ç‚¹ç®¡ç†å™¨-&gt;ç‚¹å‡»æ–°å¢ç«™ç‚¹ï¼Œç„¶åé…ç½®è¿æ¥å‚æ•°ï¼Œå¦‚ä¸‹å›¾ï¼š<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/yolo_picture/1701834260705.png"><br>ä¸»æœºå¤„è¾“å…¥çš„æ˜¯ubuntuçš„IPv4åœ°å€ï¼ŒæŸ¥æ‰¾æ–¹å¼å¦‚ä¸‹ï¼š</li></ol><ul><li>ç‚¹å‡»è®¾ç½®<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/yolo_picture/1701834357072.png"></li><li><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/yolo_picture/1701834466524.png"></li><li><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/yolo_picture/1701834503573.png"></li></ul><ol start="5"><li>å¯ä»¥çœ‹åˆ°ubuntuä¸‹çš„æ–‡ä»¶(å³è¾¹)<br>![](<a href="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/yolo_picture/Pasted">https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/yolo_picture/Pasted</a> image 20231206114943.png)</li></ol><h1 id="4-Ubuntu22-04é…ç½®anaconda"><a href="#4-Ubuntu22-04é…ç½®anaconda" class="headerlink" title="4 Ubuntu22.04é…ç½®anaconda"></a>4 Ubuntu22.04é…ç½®anaconda</h1><h2 id="4-1-é…ç½®è¿‡ç¨‹"><a href="#4-1-é…ç½®è¿‡ç¨‹" class="headerlink" title="4.1 é…ç½®è¿‡ç¨‹"></a>4.1 é…ç½®è¿‡ç¨‹</h2><p><a href="https://www.xtuos.com/6527.html">å‚è€ƒæ¥æº</a></p><ol><li><p>é¦–å…ˆï¼Œé€šè¿‡åœ¨ç»ˆç«¯ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œç¡®ä¿æ‰€æœ‰ç³»ç»ŸåŒ…éƒ½æ˜¯æœ€æ–°çš„ã€‚</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> update<span class="token function">sudo</span> <span class="token function">apt</span> upgrade<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> <span class="token function">wget</span> apt-transport-https gnupg2 software-properties-common<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>åœ¨ Ubuntu 22.04 ä¸Šå®‰è£… Anaconda Pythonã€‚<br>é»˜è®¤æƒ…å†µä¸‹ï¼ŒAnaconda åœ¨ Ubuntu 22.04 åŸºç¡€å­˜å‚¨åº“ä¸­ä¸å¯ç”¨ã€‚ç°åœ¨è¿è¡Œä»¥ä¸‹å‘½ä»¤å°† Anaconda çš„æœ€æ–°ç¨³å®šç‰ˆæœ¬ä¸‹è½½åˆ°æ‚¨çš„ Ubuntu ç³»ç»Ÿï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> https://repo.anaconda.com/archive/Anaconda3-2022.05-Linux-x86_64.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/yolo_picture/Pasted%20image%2020231205114818.png"><br>ä¸‹è½½Anacondaå®‰è£…ç¨‹åºåï¼Œç°åœ¨ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿è¡Œè„šæœ¬ï¼š</p></li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">bash</span> Anaconda3-2022.05-Linux-x86_64.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æŒ‰ç…§å‘å¯¼è¯´æ˜å®Œæˆ Anaconda å®‰è£…è¿‡ç¨‹(å¯ä»¥ä¸€è·¯æŒ‰â€Enterâ€)</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Welcome to Anaconda3 <span class="token number">2022.05</span>In order to <span class="token builtin class-name">continue</span> the installation process, please review the licenseagreement.Please, press ENTER to <span class="token builtin class-name">continue</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸‹ä¸€æ­¥æ˜¯æŒ‡æ˜å®‰è£…è·¯å¾„ï¼Œé»˜è®¤æŒ‡å‘æ ¹ç›®å½•ã€‚å¦‚æœæ‚¨å…·æœ‰ root è®¿é—®æƒé™ï¼Œåˆ™å¯ä»¥å°†å…¶ä¿ç•™åœ¨é‚£é‡Œï¼Œä½†æ‚¨ä¹Ÿå¯ä»¥å°†å…¶å®‰è£…åœ¨æ‚¨å¸æˆ·çš„ HOME ç›®å½•ä¸­ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Anaconda3 will now be installed into this location:/root/anaconda3- Press ENTER to confirm the location- Press CTRL-C to abort the installation- Or specify a different location below<span class="token punctuation">[</span>/root/anaconda3<span class="token punctuation">]</span> <span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ³¨æ„åœ°å€æ˜¯ï¼š<code>/home/wabbybabbo(ä½ è‡ªå·±çš„ç”¨æˆ·å)/anaconda3</code><br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/yolo_picture/Pasted%20image%2020231205201819.png"></p><ol start="3"><li><p>å®‰è£… Anaconda åï¼Œä¸‹ä¸€æ­¥æ˜¯é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥ä½¿ç”¨â€œ â€æ–‡ä»¶ä¸­æ·»åŠ çš„ç¯å¢ƒè®¾ç½®ï¼š<code>.bashrc</code></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">source</span> ~/.bashrc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>éªŒè¯Anacondaå®‰è£…ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">conda list<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>å¦‚æœè¦æ›´æ–°è¿è¡Œçš„æ•´ä¸ªç¯å¢ƒ(éå¿…è¦)</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">conda update-all<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>æŸ¥çœ‹è™šæ‹Ÿæœºä¸Šçš„è™šæ‹Ÿç¯å¢ƒæœ‰å“ªäº›</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">conda info <span class="token parameter variable">--envs</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¯ä»¥çœ‹åˆ°è¿™æ—¶å€™æœ‰ä¸€ä¸ªåä¸º<code>base</code>çš„è™šæ‹Ÿç¯å¢ƒ<img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/yolo_picture/Pasted%20image%2020231205155441.png"></p></li></ol><h2 id="4-2-å…¶ä»–æŒ‡ä»¤"><a href="#4-2-å…¶ä»–æŒ‡ä»¤" class="headerlink" title="4.2 å…¶ä»–æŒ‡ä»¤"></a>4.2 å…¶ä»–æŒ‡ä»¤</h2><h3 id="4-2-1-unbutuä¸€äº›æŒ‡ä»¤"><a href="#4-2-1-unbutuä¸€äº›æŒ‡ä»¤" class="headerlink" title="4.2.1 unbutuä¸€äº›æŒ‡ä»¤"></a>4.2.1 unbutuä¸€äº›æŒ‡ä»¤</h3><p><a href="https://blog.csdn.net/zjc910997316/article/details/82983251">æ¥æº</a></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> www  <span class="token comment"># åˆ°wwwç›®å½•ï¼›  </span><span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>   <span class="token comment"># åˆ°ä¸Šä¸€çº§ç›®å½•ï¼›  </span><span class="token builtin class-name">cd</span> -    <span class="token comment"># è¿”å›åˆ°ä¸Šæ¬¡çš„ç›®å½•ï¼Œç±»ä¼¼windowsè¿”å› ï¼›  </span><span class="token builtin class-name">cd</span> /    <span class="token comment"># å›åˆ°æ ¹ç›®å½•ã€‚</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-2-2-Linux-vimç¼–è¾‘å™¨çš„æŒ‡ä»¤"><a href="#4-2-2-Linux-vimç¼–è¾‘å™¨çš„æŒ‡ä»¤" class="headerlink" title="4.2.2 Linux vimç¼–è¾‘å™¨çš„æŒ‡ä»¤"></a>4.2.2 Linux vimç¼–è¾‘å™¨çš„æŒ‡ä»¤</h3><p><a href="https://blog.csdn.net/xie_xiansheng/article/details/78134626">æ¥æº</a></p><ul><li>ç¼–å†™ï¼šæŒ‰<code>a</code></li><li>é€€å‡ºï¼šå…ˆæŒ‰<code>ESC</code>é”®ï¼Œè·³åˆ°å‘½ä»¤æ¨¡å¼ï¼Œå†æ ¹æ®é€‰æ‹©è¾“å…¥ä¸‹é¢çš„(è®°å¾—è¾“å…¥å†’å·)<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">:w      <span class="token comment"># ä¿å­˜æ–‡ä»¶ä½†ä¸é€€å‡ºvi</span>:w <span class="token function">file</span> <span class="token comment"># å°†ä¿®æ”¹å¦å¤–ä¿å­˜åˆ°fileä¸­ï¼Œä¸é€€å‡ºvi</span>:w<span class="token operator">!</span>     <span class="token comment"># å¼ºåˆ¶ä¿å­˜ï¼Œä¸æ¨å‡ºvi</span>:wq     <span class="token comment"># ä¿å­˜æ–‡ä»¶å¹¶é€€å‡ºvi</span>:wq<span class="token operator">!</span>    <span class="token comment"># å¼ºåˆ¶ä¿å­˜æ–‡ä»¶ï¼Œå¹¶é€€å‡ºvi</span>:q      <span class="token comment"># ä¸ä¿å­˜æ–‡ä»¶ï¼Œé€€å‡ºvi</span>:q<span class="token operator">!</span>     <span class="token comment"># ä¸ä¿å­˜æ–‡ä»¶ï¼Œå¼ºåˆ¶é€€å‡ºvi</span>:e<span class="token operator">!</span>     <span class="token comment"># æ”¾å¼ƒæ‰€æœ‰ä¿®æ”¹ï¼Œä»ä¸Šæ¬¡ä¿å­˜æ–‡ä»¶å¼€å§‹å†ç¼–è¾‘</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="4-2-3-è¿›å…¥å’Œé€€å‡ºconda-baseç¯å¢ƒ"><a href="#4-2-3-è¿›å…¥å’Œé€€å‡ºconda-baseç¯å¢ƒ" class="headerlink" title="4.2.3 è¿›å…¥å’Œé€€å‡ºconda baseç¯å¢ƒ"></a>4.2.3 è¿›å…¥å’Œé€€å‡º<code>conda base</code>ç¯å¢ƒ</h3><p>è¿›å…¥<code>conda base</code>ç¯å¢ƒï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">source</span> ~/anaconda3/bin/activate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>é€€å‡º<code>conda base</code>ç¯å¢ƒï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">conda deactivate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/yolo_picture/Pasted%20image%2020231205205557.png"></p><h1 id="5-yoloæ¨¡å‹éƒ¨ç½²åˆ°orangepi-3"><a href="#5-yoloæ¨¡å‹éƒ¨ç½²åˆ°orangepi-3" class="headerlink" title="5 yoloæ¨¡å‹éƒ¨ç½²åˆ°orangepi 3"></a>5 yoloæ¨¡å‹éƒ¨ç½²åˆ°orangepi 3</h1><p>é™„ä¸Šä¸¤ä¸ªå‚è€ƒç½‘ç«™ï¼š<a href="https://blog.csdn.net/m0_55217834/article/details/130583886"># é¦™æ©™æ´¾5 RK3588 yolov5æ¨¡å‹è½¬æ¢rknnåŠéƒ¨ç½²è¸©å‘å…¨è®°å½• orangepi 5</a>ã€<a href="http://years.love/yolov5.html">linuxæ¿ä¸Šè¿è¡Œyolov5 ç›®æ ‡æ£€æµ‹</a></p><h2 id="5-1-æ‰€è°“çš„yolov5ç›®å½•"><a href="#5-1-æ‰€è°“çš„yolov5ç›®å½•" class="headerlink" title="5.1 æ‰€è°“çš„yolov5ç›®å½•"></a>5.1 æ‰€è°“çš„yolov5ç›®å½•</h2><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/yolo_picture/Pasted%20image%2020231205161134.png"><br> è¿™ä¸ª<strong>yolov5ç›®å½•</strong>åœ¨æœ¬äººçš„ç”µè„‘ä¸Šï¼Œè¿™ä¸ªæ–‡ä»¶æ˜¯è¿™æ ·çš„<img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/yolo_picture/Pasted%20image%2020231205161233.png"></p><h2 id="5-2-è·¯å¾„é—®é¢˜"><a href="#5-2-è·¯å¾„é—®é¢˜" class="headerlink" title="5.2 è·¯å¾„é—®é¢˜"></a>5.2 è·¯å¾„é—®é¢˜</h2><p> <code>weight</code>å’Œ<code>data/coco128</code>æ”¹æˆè‡ªå·±çš„weightå’Œdataçš„è·¯å¾„</p><h2 id="5-3-ç”Ÿæˆçš„-onnxæ–‡ä»¶"><a href="#5-3-ç”Ÿæˆçš„-onnxæ–‡ä»¶" class="headerlink" title="5.3 ç”Ÿæˆçš„.onnxæ–‡ä»¶"></a>5.3 ç”Ÿæˆçš„<code>.onnx</code>æ–‡ä»¶</h2><p> ç”Ÿæˆçš„yolov5n.onnxæ–‡ä»¶åœ¨æœ¬äººç”µè„‘ä¸Šçš„ä½ç½®åœ¨è¿™é‡Œï¼Œåä¸º<code>best.onnx</code><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/yolo_picture/Pasted%20image%2020231205161724.png"></p><h2 id="5-4-åœ¨Ubuntuåˆ›å»ºè™šæ‹Ÿç¯å¢ƒ"><a href="#5-4-åœ¨Ubuntuåˆ›å»ºè™šæ‹Ÿç¯å¢ƒ" class="headerlink" title="5.4 åœ¨Ubuntuåˆ›å»ºè™šæ‹Ÿç¯å¢ƒ"></a>5.4 åœ¨Ubuntuåˆ›å»ºè™šæ‹Ÿç¯å¢ƒ</h2><ol start="4"><li>åˆ›å»ºåä¸º<code>rknn</code>çš„è™šæ‹Ÿç¯å¢ƒæ—¶è¾“å…¥<code>conda create -name rknn python=3.9</code>æŠ¥é”™äº†ï¼Œä½†æ˜¯è¾“å…¥<code>conda create -n rknn python=3.9</code>å°±ä¸ä¼šï¼Œå¾ˆå¥‡æ€ª</li></ol><h2 id="5-5-Ubuntuè§£å‹ç¼©"><a href="#5-5-Ubuntuè§£å‹ç¼©" class="headerlink" title="5.5 Ubuntuè§£å‹ç¼©"></a>5.5 Ubuntuè§£å‹ç¼©</h2><p><a href="https://blog.csdn.net/songbinxu/article/details/80435665">å‚è€ƒç½‘å€</a><br>æœ¬äººç”¨åˆ°çš„æ˜¯</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">unzip</span> FileName.zip <span class="token comment"># è§£å‹</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å†ä¹‹åçš„è·Ÿç€ä¸Šé¢çš„ä¸¤ä¸ªåšå®¢èµ°ï¼ŒåŸºæœ¬ä¸Šæ²¡ä»€ä¹ˆå‘äº†</p><h1 id="6-é‡åˆ°çš„å…¶ä»–é—®é¢˜"><a href="#6-é‡åˆ°çš„å…¶ä»–é—®é¢˜" class="headerlink" title="6 é‡åˆ°çš„å…¶ä»–é—®é¢˜"></a>6 é‡åˆ°çš„å…¶ä»–é—®é¢˜</h1><p>åœ¨å¼€æœºæ—¶é»‘å±ä¸”é‡åˆ°äº†ï¼š<br><a href="https://blog.csdn.net/qq_38132831/article/details/77932173">SMbus Host Controller not enabled</a></p>]]></content>
      
      
      <categories>
          
          <category> äººå·¥æ™ºèƒ½ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> äººå·¥æ™ºèƒ½ </tag>
            
            <tag> Linux </tag>
            
            <tag> Ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AlexNetæ¨¡å‹å¤ç°</title>
      <link href="/2023/11/28/alexnet-mo-xing-fu-xian/"/>
      <url>/2023/11/28/alexnet-mo-xing-fu-xian/</url>
      
        <content type="html"><![CDATA[<h1 id="1-åˆ›å»ºnet"><a href="#1-åˆ›å»ºnet" class="headerlink" title="1 åˆ›å»ºnet"></a>1 åˆ›å»ºnet</h1><h2 id="1-1-torch-nn-Module"><a href="#1-1-torch-nn-Module" class="headerlink" title="1.1 torch.nn.Module()"></a>1.1 torch.nn.Module()</h2><p><strong>Base class for all neural network modules</strong></p><h3 id="1-1-1-Variables"><a href="#1-1-1-Variables" class="headerlink" title="1.1.1 Variables"></a>1.1.1 Variables</h3><ol><li><code>cuda(device=None)</code><br>Moves all model parameters and buffers to the GPU<br>å°†æ‰€æœ‰æ¨¡å‹å‚æ•°å’Œç¼“å†²åŒºç§»è‡³ GPU</li><li><code>eval()</code><br>Sets the module in evaluation mode<br>å°†æ¨¡å—è®¾ç½®ä¸ºè¯„ä¼°æ¨¡å¼ ^eval</li><li><code>forward()</code><br>Defines the computation performed at every call.<br>å®šä¹‰æ¯æ¬¡è°ƒç”¨æ—¶æ‰§è¡Œçš„è®¡ç®— ^forward</li></ol><h2 id="1-2-é˜…è¯»è®ºæ–‡åå¾—åˆ°netçš„å‚æ•°"><a href="#1-2-é˜…è¯»è®ºæ–‡åå¾—åˆ°netçš„å‚æ•°" class="headerlink" title="1.2 é˜…è¯»è®ºæ–‡åå¾—åˆ°netçš„å‚æ•°"></a>1.2 é˜…è¯»è®ºæ–‡åå¾—åˆ°netçš„å‚æ•°</h2><p>å…³æ³¨$C_{in}$ã€$C_{out}$ã€$kernel_size$ã€$padding$ã€$stride$<br>å…¶ä¸­ï¼Œ$stride$éœ€è¦æ ¹æ®å…¬å¼è®¡ç®—å¾—å‡º<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/a0dda904b7f38e1eea5ebad874024a7.jpg">)</p><h2 id="1-3-ç¼–å†™init"><a href="#1-3-ç¼–å†™init" class="headerlink" title="1.3 ç¼–å†™init"></a>1.3 ç¼–å†™init</h2><p>å®šä¹‰æ¯ä¸ªæ­¥éª¤çš„å…·ä½“æ‰§è¡Œè¿‡ç¨‹<br>e.g.</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">self<span class="token punctuation">.</span>c1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> out_channels<span class="token operator">=</span><span class="token number">48</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">11</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¿™é‡Œè§„å®š<code>c1</code>çš„æ‰§è¡Œè¿‡ç¨‹æ˜¯æ¥æ”¶è¾“å…¥é€šé“ä¸º$3$çš„å›¾åƒï¼Œç”¨<code>size</code>ä¸º$11$çš„<code>kernel</code>â€¦æœ€åä»¥è¾“å‡ºé€šé“ä¸º$48$ä½œä¸ºè¾“å‡º</p><h2 id="1-4-ç¼–å†™forward"><a href="#1-4-ç¼–å†™forward" class="headerlink" title="1.4 ç¼–å†™forward"></a>1.4 ç¼–å†™forward</h2><p>[[#^forward]]<br>æŒ‰ç…§å·ç§¯çš„é¡ºåºè¿›è¡Œxçš„æ›´è¿­</p><h2 id="1-5-æµ‹è¯•"><a href="#1-5-æµ‹è¯•" class="headerlink" title="1.5 æµ‹è¯•"></a>1.5 æµ‹è¯•</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>å½“è¿™æ®µä»£ç åªåœ¨ç›´æ¥è¿è¡Œå½“å‰è„šæœ¬æ—¶æ‰ä¼šæ‰§è¡Œï¼Œå¦‚æœå½“å‰è„šæœ¬è¢«å…¶ä»–è„šæœ¬å¼•å…¥ä½œä¸ºæ¨¡å—ä½¿ç”¨ï¼Œåˆ™è¿™éƒ¨åˆ†ä»£ç ä¸ä¼šæ‰§è¡Œã€‚<br>é€šå¸¸ä¼šå¯¹<code>x</code>å’Œ<code>y</code>èµ‹äºˆç®€å•çš„æ•°å­—å¯¹<code>net</code>è¿›è¡Œæµ‹è¯•</p><h1 id="2-åˆ’åˆ†æ•°æ®é›†"><a href="#2-åˆ’åˆ†æ•°æ®é›†" class="headerlink" title="2 åˆ’åˆ†æ•°æ®é›†"></a>2 åˆ’åˆ†æ•°æ®é›†</h1><h2 id="2-1-åˆ›å»ºæ–‡ä»¶"><a href="#2-1-åˆ›å»ºæ–‡ä»¶" class="headerlink" title="2.1 åˆ›å»ºæ–‡ä»¶"></a>2.1 åˆ›å»ºæ–‡ä»¶</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºæ–‡ä»¶  </span><span class="token keyword">def</span> <span class="token function">mkfile</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span><span class="token punctuation">:</span>      <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span><span class="token punctuation">:</span>          os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>cla = [Cat, Dog]</li><li><code>data/train/</code>+<code>cla</code><ul><li><code>data/train/Cat</code></li><li><code>data/train/Dog</code></li><li><code>data/val/Cat</code></li><li><code>dara/val/Dog</code></li></ul></li></ul><h2 id="2-2-éå†ä¸åˆ’åˆ†"><a href="#2-2-éå†ä¸åˆ’åˆ†" class="headerlink" title="2.2 éå†ä¸åˆ’åˆ†"></a>2.2 éå†ä¸åˆ’åˆ†</h2><ol><li>éå†æ‰€æœ‰ç±»åˆ«çš„å›¾åƒ<br><code>images</code>å­˜å‚¨äº†åŸå§‹dataä¸‹<code>cla</code>åˆ†åˆ«ä¸º<code>Cat</code>å’Œ<code>Dog</code>çš„å›¾åƒåç§°</li><li>æŒ‰æ¯”ä¾‹åˆ’åˆ†ä¸ºè®­ç»ƒé›†å’Œæµ‹è¯•é›†<br><code>eval_index</code>æ˜¯<code>images</code>ä¸­çš„éšæœºæŠ½å–çš„$\dfrac{2}{10}$çš„å›¾åƒåç§°çš„é›†åˆ</li></ol><p>éšåå†æ¬¡éå†<code>images</code></p><ul><li>å¦‚æœå›¾åƒçš„åå­—åœ¨<code>eval_index</code>ä¸­å­˜åœ¨ï¼Œåˆ™å°†è¿™ä¸ªå›¾åƒå¤åˆ¶åˆ°æ–°è·¯å¾„<code>data/val/+cla</code>(<code>val</code>ä¸­<code>Cat</code>æˆ–<code>Dog</code>çš„æ–‡ä»¶ä¸‹)</li><li>å¦‚æœä¸åœ¨<code>eval_index</code>ä¸­å­˜åœ¨ï¼Œåˆ™å¤åˆ¶åˆ°<code>data/train/+cla</code>ä¸­</li></ul><h1 id="3-ç¼–å†™train-py"><a href="#3-ç¼–å†™train-py" class="headerlink" title="3 ç¼–å†™train.py"></a>3 ç¼–å†™train.py</h1><h2 id="3-1-ç”¨åˆ°çš„åº“"><a href="#3-1-ç”¨åˆ°çš„åº“" class="headerlink" title="3.1 ç”¨åˆ°çš„åº“"></a>3.1 ç”¨åˆ°çš„åº“</h2><h3 id="3-1-1-torchvision-transforms"><a href="#3-1-1-torchvision-transforms" class="headerlink" title="3.1.1 torchvision.transforms"></a>3.1.1 torchvision.transforms</h3><ol><li><p>.Normalize(<em>mean, std, inplace=False</em>)<br>ps: Itâ€™s scriptable transforms, which canâ€™t use [[#^Compose]]    :)<br>å½’ä¸€åŒ–å¤„ç†<br>output[channel] = (input[channel] - mean[channel] / std[channel])<br>^normalize</p></li><li><p>.Compose(<em>transforms</em>)<br>Composes several transforms together.This transform does not support torchscript.<br>^Compose</p></li></ol><h2 id="3-1-å¯¹å›¾åƒåƒç´ å½’ä¸€åŒ–å¤„ç†"><a href="#3-1-å¯¹å›¾åƒåƒç´ å½’ä¸€åŒ–å¤„ç†" class="headerlink" title="3.1 å¯¹å›¾åƒåƒç´ å½’ä¸€åŒ–å¤„ç†"></a>3.1 å¯¹å›¾åƒåƒç´ å½’ä¸€åŒ–å¤„ç†</h2><p>[[#^normalize]]</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">normalize <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># å‡0.5å†é™¤0.5æœ€åå½’ä¸€åŒ–åˆ°[-1, 1]ä¹‹é—´</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="3-2-è®­ç»ƒé›†å’ŒéªŒè¯é›†é¢„å¤„ç†"><a href="#3-2-è®­ç»ƒé›†å’ŒéªŒè¯é›†é¢„å¤„ç†" class="headerlink" title="3.2 è®­ç»ƒé›†å’ŒéªŒè¯é›†é¢„å¤„ç†"></a>3.2 è®­ç»ƒé›†å’ŒéªŒè¯é›†é¢„å¤„ç†</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># è®­ç»ƒé›†é¢„å¤„ç†  </span>train_transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>      transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># Resize the input image to the given size.å› æ­¤å°†å‚æ•°è®¾ç½®ä¸ºè®ºæ–‡ä¸­ç½‘ç»œè¾“å…¥çš„å‚æ•°å¤§å°  </span>    transforms<span class="token punctuation">.</span>RandomVerticalFlip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># éšæœºå‚ç›´æ—‹è½¬ï¼Œä½¿æ•°æ®é›†æ›´å¤š  </span>    transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># è½¬æ¢ä¸ºå¼ é‡  </span>    normalize  <span class="token comment"># å½’ä¸€åŒ–  </span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token comment">#éªŒè¯é›†é¢„å¤„ç†  </span>val_transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>      transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      normalize  <span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>[[#^Compose]]<br>åˆ›å»ºæ•°æ®é›†ğŸ‘‡</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">train_dataset <span class="token operator">=</span> ImageFolder<span class="token punctuation">(</span>ROOT_TRAIN<span class="token punctuation">,</span> transform<span class="token operator">=</span>train_transform<span class="token punctuation">)</span>  val_dataset <span class="token operator">=</span> ImageFolder<span class="token punctuation">(</span>ROOT_TEST<span class="token punctuation">,</span> transform<span class="token operator">=</span>val_transform<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><code>ImageFolder</code>ç”¨äºåˆ›å»ºä¸€ä¸ªæ•°æ®é›†ï¼Œè¯¥æ•°æ®é›†åŒ…å«äº†å›¾åƒæ•°æ®å’Œç›¸åº”çš„æ ‡ç­¾</p><p>ğŸ‘‡è®¾ç½®æ‰¹é‡åŠ è½½</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">train_dataloader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>train_dataset<span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  val_dataloader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>val_dataset<span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><code>DataLoader</code>ç”¨äºä»æ•°æ®é›†ä¸­åŠ è½½æ‰¹é‡æ•°æ®çš„å·¥å…·<br>æ¯æ‰¹æ•°æ®æœ‰32ä¸ªæ ·æœ¬<br><code>shuffle=True</code>è¡¨ç¤ºæ¯ä¸ª<code>epoch</code>å¼€å§‹å‰å¯¹æ•°æ®ç»§ç»­éšæœºæ’åº</p><h2 id="3-4-ä½¿ç”¨GPUåŠ è½½æ•°æ®"><a href="#3-4-ä½¿ç”¨GPUåŠ è½½æ•°æ®" class="headerlink" title="3.4 ä½¿ç”¨GPUåŠ è½½æ•°æ®"></a>3.4 ä½¿ç”¨GPUåŠ è½½æ•°æ®</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python">device <span class="token operator">=</span> <span class="token string">'cuda'</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">'cpu'</span>  <span class="token keyword">print</span><span class="token punctuation">(</span>device<span class="token punctuation">)</span>  model <span class="token operator">=</span> MyAlexNet<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>  <span class="token comment"># å°†'MyAlexNet'å®ä¾‹åŒ–å¯¹è±¡ç§»åŠ¨åˆ°'device'ä¸Š</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="3-5-å®šä¹‰æŸå¤±å‡½æ•°å’Œä¼˜åŒ–å™¨å¹¶è®¾ç½®å­¦ä¹ ç‡"><a href="#3-5-å®šä¹‰æŸå¤±å‡½æ•°å’Œä¼˜åŒ–å™¨å¹¶è®¾ç½®å­¦ä¹ ç‡" class="headerlink" title="3.5 å®šä¹‰æŸå¤±å‡½æ•°å’Œä¼˜åŒ–å™¨å¹¶è®¾ç½®å­¦ä¹ ç‡"></a>3.5 å®šä¹‰æŸå¤±å‡½æ•°å’Œä¼˜åŒ–å™¨å¹¶è®¾ç½®å­¦ä¹ ç‡</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># å®šä¹‰ä¸€ä¸ªæŸå¤±å‡½æ•°  </span>loss_fn <span class="token operator">=</span> nn<span class="token punctuation">.</span>CrossEntropyLoss<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># å®šä¹‰ä¸€ä¸ªä¼˜åŒ–å™¨  </span>optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>SGD<span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">,</span> momentum<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">)</span>  <span class="token comment"># å°†æ¨¡å‹å‚æ•°ä¼ ç»™ä¼˜åŒ–å™¨  </span><span class="token comment"># å­¦ä¹ ç‡æ¯éš”10è½®å˜ä¸ºåŸæ¥çš„0.5  </span>lr_scheduler <span class="token operator">=</span> lr_scheduler<span class="token punctuation">.</span>StepLR<span class="token punctuation">(</span>optimizer<span class="token punctuation">,</span> step_size<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> gamma<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token comment"># å¸®åŠ©ä¼˜åŒ–å™¨å†è®­ç»ƒè¿‡ç¨‹ä¸­é€æ­¥å‡å°å­¦ä¹ ç‡</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-6-å®šä¹‰è®­ç»ƒå‡½æ•°å’ŒæŸå¤±å‡½æ•°"><a href="#3-6-å®šä¹‰è®­ç»ƒå‡½æ•°å’ŒæŸå¤±å‡½æ•°" class="headerlink" title="3.6 å®šä¹‰è®­ç»ƒå‡½æ•°å’ŒæŸå¤±å‡½æ•°"></a>3.6 å®šä¹‰è®­ç»ƒå‡½æ•°å’ŒæŸå¤±å‡½æ•°</h2><p>â‘ ä»<code>dataloader</code>ä¸­å–å‡ºå›¾åƒæ•°æ®å’Œå¯¹åº”çš„æ ‡ç­¾<br>â‘¡è®¡ç®—<code>cur_loss</code>å’Œ<code>cur_acc</code>^train</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>dataloader<span class="token punctuation">,</span> model<span class="token punctuation">,</span> loss_fn<span class="token punctuation">,</span> optimizer<span class="token punctuation">)</span><span class="token punctuation">:</span>loss<span class="token punctuation">,</span> current<span class="token punctuation">,</span> n <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0</span>  <span class="token keyword">for</span> batch<span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>dataloader<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># å°†æ•°æ®å–å‡ºæ¥è®­ç»ƒ  </span>    image<span class="token punctuation">,</span> y <span class="token operator">=</span> x<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">,</span> y<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>      output <span class="token operator">=</span> model<span class="token punctuation">(</span>image<span class="token punctuation">)</span>      cur_loss <span class="token operator">=</span> loss_fn<span class="token punctuation">(</span>output<span class="token punctuation">,</span> y<span class="token punctuation">)</span>      _<span class="token punctuation">,</span> pred <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>output<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>      cur_acc <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>y<span class="token operator">==</span>pred<span class="token punctuation">)</span><span class="token operator">/</span>output<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>â‘¢åå‘ä¼ æ’­</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># åå‘ä¼ æ’­  </span>optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>  cur_loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>  optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>â‘£è®¡ç®—$\dfrac{æ‰€æœ‰æŸå¤±å€¼}{ä¸ªæ•°}$å’Œ$\dfrac{æ‰€æœ‰æ­£ç¡®å€¼}{ä¸ªæ•°}$</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">loss <span class="token operator">+=</span> cur_loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>  current <span class="token operator">+=</span> cur_acc<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>  n <span class="token operator">=</span> n<span class="token operator">+</span><span class="token number">1</span>train_loss <span class="token operator">=</span> loss <span class="token operator">/</span> n  train_acc <span class="token operator">=</span> current <span class="token operator">/</span> n  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'train_loss'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>train_loss<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'train_acc'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>train_acc<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token keyword">return</span> train_loss<span class="token punctuation">,</span> train_acc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æŸå¤±å‡½æ•°é™¤äº†ä¸éœ€è¦åå‘ä¼ æ’­ï¼Œå…¶ä»–éƒ½å’Œè®­ç»ƒå‡½æ•°ç±»ä¼¼</p><h2 id="3-7-å®šä¹‰ç”»å›¾å‡½æ•°"><a href="#3-7-å®šä¹‰ç”»å›¾å‡½æ•°" class="headerlink" title="3.7 å®šä¹‰ç”»å›¾å‡½æ•°"></a>3.7 å®šä¹‰ç”»å›¾å‡½æ•°</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># å®šä¹‰ä¸€ä¸ªç”»å›¾å‡½æ•°  </span><span class="token keyword">def</span> <span class="token function">matplot_loss</span><span class="token punctuation">(</span>train_loss<span class="token punctuation">,</span> val_loss<span class="token punctuation">)</span><span class="token punctuation">:</span>      plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>train_loss<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'train_loss'</span><span class="token punctuation">)</span>      plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>val_loss<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'val_loss'</span><span class="token punctuation">)</span>      plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span>loc<span class="token operator">=</span><span class="token string">'best'</span><span class="token punctuation">)</span>      plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'loss'</span><span class="token punctuation">)</span>      plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'epoch'</span><span class="token punctuation">)</span>      plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"è®­ç»ƒé›†å’ŒéªŒè¯é›†losså€¼å¯¹æ¯”å›¾"</span><span class="token punctuation">)</span>      plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">matplot_acc</span><span class="token punctuation">(</span>train_acc<span class="token punctuation">,</span> val_acc<span class="token punctuation">)</span><span class="token punctuation">:</span>      plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>train_acc<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'train_acc'</span><span class="token punctuation">)</span>      plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>val_acc<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'val_acc'</span><span class="token punctuation">)</span>      plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span>loc<span class="token operator">=</span><span class="token string">'best'</span><span class="token punctuation">)</span>      plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'acc'</span><span class="token punctuation">)</span>      plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'epoch'</span><span class="token punctuation">)</span>      plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"è®­ç»ƒé›†å’ŒéªŒè¯é›†accå€¼å¯¹æ¯”å›¾"</span><span class="token punctuation">)</span>      plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-8-å¼€å§‹è®­ç»ƒ"><a href="#3-8-å¼€å§‹è®­ç»ƒ" class="headerlink" title="3.8 å¼€å§‹è®­ç»ƒ"></a>3.8 å¼€å§‹è®­ç»ƒ</h2><p>â‘ åˆå§‹åŒ–å››ä¸ª<code>list</code>ï¼Œå®šä¹‰<code>epoch</code>å’Œ<code>min_acc</code></p><pre class="line-numbers language-python" data-language="python"><code class="language-python">loss_train <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  acc_train <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  loss_val <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  acc_val <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>epoch <span class="token operator">=</span> <span class="token number">20</span>  min_acc <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment"># æœ€å°ç²¾ç¡®åº¦ï¼Œæ‰¾å‡ºæœ€å¥½çš„æ¨¡å‹</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>â‘¡è°ƒç”¨<code>train</code>å’Œ<code>val</code>å‡½æ•°è¿›è¡Œè®­ç»ƒ<br>[[#^train]]</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">for</span> t <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>epoch<span class="token punctuation">)</span><span class="token punctuation">:</span>      lr_scheduler<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"epoch</span><span class="token interpolation"><span class="token punctuation">{</span>t<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">\n-------"</span></span><span class="token punctuation">)</span>      train_loss<span class="token punctuation">,</span> train_acc <span class="token operator">=</span> train<span class="token punctuation">(</span>train_dataloader<span class="token punctuation">,</span> model<span class="token punctuation">,</span> loss_fn<span class="token punctuation">,</span> optimizer<span class="token punctuation">)</span>      val_loss<span class="token punctuation">,</span> val_acc <span class="token operator">=</span> val<span class="token punctuation">(</span>val_dataloader<span class="token punctuation">,</span> model<span class="token punctuation">,</span> loss_fn<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>â‘¢è®¡ç®—å¾—åˆ°çš„<code>train_loss</code>ã€<code>train_acc</code>ã€<code>val_loss</code>ã€<code>val_acc</code>åˆ†åˆ«æ”¾å…¥åˆ°åˆå§‹åŒ–çš„å››ä¸ª<code>list</code>ä¸­</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># åˆ—è¡¨  </span>loss_train<span class="token punctuation">.</span>append<span class="token punctuation">(</span>train_loss<span class="token punctuation">)</span>  acc_train<span class="token punctuation">.</span>append<span class="token punctuation">(</span>train_acc<span class="token punctuation">)</span>  loss_val<span class="token punctuation">.</span>append<span class="token punctuation">(</span>val_loss<span class="token punctuation">)</span>  acc_val<span class="token punctuation">.</span>append<span class="token punctuation">(</span>val_acc<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>â‘£ä¿å­˜æœ€å¥½çš„æƒé‡å’Œæœ€åä¸€è½®çš„æƒé‡</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># ä¿å­˜æœ€å¥½çš„æƒé‡  </span><span class="token keyword">if</span> val_acc <span class="token operator">&gt;</span> min_acc<span class="token punctuation">:</span>      folder <span class="token operator">=</span> <span class="token string">'save_model'</span>      <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>folder<span class="token punctuation">)</span><span class="token punctuation">:</span>          os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span><span class="token string">'save_model'</span><span class="token punctuation">)</span>      min_acc <span class="token operator">=</span> val_acc      <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"save best model, ç¬¬</span><span class="token interpolation"><span class="token punctuation">{</span>t<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">è½®"</span></span><span class="token punctuation">)</span>      torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'save_model/best_model.pth'</span><span class="token punctuation">)</span>  <span class="token comment"># ä¿å­˜æœ€åä¸€è½®çš„æƒé‡æ–‡ä»¶  </span><span class="token keyword">if</span> t <span class="token operator">==</span> epoch<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>      torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'save_model/last_model.pth'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœæœ‰<code>val_acc</code>(æŸä¸€ä¸ªè½®æ¬¡è®­ç»ƒå¾—åˆ°çš„)å¤§äº<code>min_acc</code>ï¼Œåˆ™è¯´æ˜è¯¥æ¬¡çš„è®­ç»ƒæ•ˆæœæš‚æ—¶æ˜¯ç›®å‰æœ€å¥½çš„ï¼Œä¿å­˜åˆ°<code>.save_model/best_model.pth</code>ä¸­</p><h2 id="3-9-ç”»å›¾"><a href="#3-9-ç”»å›¾" class="headerlink" title="3.9 ç”»å›¾"></a>3.9 ç”»å›¾</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python">matplot_loss<span class="token punctuation">(</span>loss_train<span class="token punctuation">,</span> loss_val<span class="token punctuation">)</span>  matplot_acc<span class="token punctuation">(</span>acc_train<span class="token punctuation">,</span> acc_val<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h1 id="4-ç¼–å†™test-py"><a href="#4-ç¼–å†™test-py" class="headerlink" title="4 ç¼–å†™test.py"></a>4 ç¼–å†™test.py</h1><h2 id="4-1-è®­ç»ƒé›†å’ŒéªŒè¯é›†é¢„å¤„ç†ã€è°ƒç”¨GPU"><a href="#4-1-è®­ç»ƒé›†å’ŒéªŒè¯é›†é¢„å¤„ç†ã€è°ƒç”¨GPU" class="headerlink" title="4.1 è®­ç»ƒé›†å’ŒéªŒè¯é›†é¢„å¤„ç†ã€è°ƒç”¨GPU"></a>4.1 è®­ç»ƒé›†å’ŒéªŒè¯é›†é¢„å¤„ç†ã€è°ƒç”¨GPU</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python">train_transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>      transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># Resize the input image to the given size.å› æ­¤å°†å‚æ•°è®¾ç½®ä¸ºè®ºæ–‡ä¸­ç½‘ç»œè¾“å…¥çš„å‚æ•°å¤§å°  </span>    transforms<span class="token punctuation">.</span>RandomVerticalFlip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># éšæœºå‚ç›´æ—‹è½¬ï¼Œä½¿æ•°æ®é›†æ›´å¤š  </span>    transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># è½¬æ¢ä¸ºå¼ é‡  </span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token comment">#éªŒè¯é›†é¢„å¤„ç†  </span>val_transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>      transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      normalize  <span class="token punctuation">]</span><span class="token punctuation">)</span>train_dataset <span class="token operator">=</span> ImageFolder<span class="token punctuation">(</span>ROOT_TRAIN<span class="token punctuation">,</span> transform<span class="token operator">=</span>train_transform<span class="token punctuation">)</span>  val_dataset <span class="token operator">=</span> ImageFolder<span class="token punctuation">(</span>ROOT_TEST<span class="token punctuation">,</span> transform<span class="token operator">=</span>val_transform<span class="token punctuation">)</span>    train_dataloader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>train_dataset<span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  val_dataloader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>val_dataset<span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    device <span class="token operator">=</span> <span class="token string">'cuda'</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">'cpu'</span>  <span class="token keyword">print</span><span class="token punctuation">(</span>device<span class="token punctuation">)</span>  model <span class="token operator">=</span> MyAlexNet<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>  <span class="token comment"># å°†'MyAlexNet'å®ä¾‹åŒ–å¯¹è±¡ç§»åŠ¨åˆ°'device'ä¸Š</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="4-2-åŠ è½½æ¨¡å‹"><a href="#4-2-åŠ è½½æ¨¡å‹" class="headerlink" title="4.2 åŠ è½½æ¨¡å‹"></a>4.2 åŠ è½½æ¨¡å‹</h2><p>åŠ è½½<code>best_model.pth</code></p><pre class="line-numbers language-python" data-language="python"><code class="language-python">model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">"E:/Project/Cat_and_Dog_Classification/save_model/best_model.pth"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="4-3-éªŒè¯é˜¶æ®µ"><a href="#4-3-éªŒè¯é˜¶æ®µ" class="headerlink" title="4.3 éªŒè¯é˜¶æ®µ"></a>4.3 éªŒè¯é˜¶æ®µ</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python">model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token number">3010</span><span class="token punctuation">)</span><span class="token punctuation">:</span>      x<span class="token punctuation">,</span> y <span class="token operator">=</span> val_dataset<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val_dataset<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment"># xä¸ºç¬¬iå¼ ç…§ç‰‡çš„çš„å›¾ç‰‡ï¼Œyä¸ºç¬¬iå¼ å›¾ç‰‡çš„æ ‡ç­¾  </span>    show<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>      x <span class="token operator">=</span> Variable<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span>x<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requires_grad<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>      x <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>model.eval()</code><br>[[#^eval]]<br><code>torch.unsqueeze(x, dim=0)</code>å°†<code>x</code>åœ¨ç»´åº¦0ä¸Šæ·»åŠ ä¸€ä¸ªç»´åº¦ï¼Œå¤§å°ä¸º1(æ‰¹æ¬¡ç»´åº¦)</p><p>åœ¨ç¦æ­¢æ¢¯åº¦è®¡ç®—çš„æƒ…å†µä¸‹å¾—åˆ°<code>predicted</code>å’Œ<code>actual</code></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>      pred <span class="token operator">=</span> model<span class="token punctuation">(</span>x<span class="token punctuation">)</span>      predicted<span class="token punctuation">,</span> actual <span class="token operator">=</span> classes<span class="token punctuation">[</span>torch<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>pred<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> classes<span class="token punctuation">[</span>y<span class="token punctuation">]</span>      <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'predicted:"</span><span class="token interpolation"><span class="token punctuation">{</span>predicted<span class="token punctuation">}</span></span><span class="token string">", Actual:"</span><span class="token interpolation"><span class="token punctuation">{</span>actual<span class="token punctuation">}</span></span><span class="token string">"'</span></span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><code>pred</code>ï¼š<code>tensor([[-2.1302,  2.3210]], device='cuda:0')</code><br><code>y</code>ï¼š<code>0</code>(Cat)æˆ–è€…<code>1</code>(Dog)</p>]]></content>
      
      
      <categories>
          
          <category> äººå·¥æ™ºèƒ½ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> äººå·¥æ™ºèƒ½ </tag>
            
            <tag> å·ç§¯ç¥ç»ç½‘ç»œ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RNN(æå®æ¯…)</title>
      <link href="/2023/11/06/rnn-li-hong-yi/"/>
      <url>/2023/11/06/rnn-li-hong-yi/</url>
      
        <content type="html"><![CDATA[<h1 id="1-Example-Application"><a href="#1-Example-Application" class="headerlink" title="1 Example Application"></a>1 Example Application</h1><h2 id="1-1-Slot-Filling"><a href="#1-1-Slot-Filling" class="headerlink" title="1.1 Slot Filling"></a>1.1 Slot Filling</h2><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231106133700.png"><br>ğŸ‘†å¥å­ä¸­åªæœ‰<strong>Taipei</strong>å’Œ<strong>November</strong> $2^{nd}$ å±äºä¸¤ä¸ªslotä¸­ï¼Œå…¶ä½™è¯æ±‡ä¸å±äºä»»ä½•slot</p><h2 id="1-2é€šè¿‡feedforward-networkå®ç°slot-filling"><a href="#1-2é€šè¿‡feedforward-networkå®ç°slot-filling" class="headerlink" title="1.2é€šè¿‡feedforward networkå®ç°slot filling"></a>1.2é€šè¿‡feedforward networkå®ç°slot filling</h2><p>Input : a word<br>(Each word is represented as a vector):</p><ol><li>1-of-N encoding</li><li>beyond 1-of-N encoding<ol><li>dimension for â€œotherâ€ï¼šåœ¨1-of-N encodingå¤šåŠ ä¸€ä¸ªdimensionï¼Œè¿™ä¸ªdimensionä»£è¡¨other(æ²¡è§è¿‡çš„è¯æ±‡)<br> <img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231107222413.png"><br> 2.word hashing<br> <img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231106134607.png"></li></ol></li></ol><p>Outputï¼šprobability distribution that the input word belonging to the slots</p><h2 id="1-3Problem"><a href="#1-3Problem" class="headerlink" title="1.3Problem"></a>1.3Problem</h2><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231106135520.png"><br>input Taipeiè¿™ä¸ªè¯æ±‡ï¼Œè¦ä¹ˆéƒ½æ˜¯destinationå‡ ç‡æœ€é«˜ï¼Œè¦ä¹ˆéƒ½æ˜¯place of departureå‡ ç‡æœ€é«˜ğŸ‘‰æˆ‘ä»¬å¸Œæœ›nerual networkæ˜¯æœ‰è®°å¿†åŠ›çš„ğŸ‘‰å¦‚æœä»–èƒ½è®°ä½arriveå’Œleaveé‚£ä»–çš„outputå°±å¯ä»¥ä¸åŒ</p><h2 id="1-4-Solution"><a href="#1-4-Solution" class="headerlink" title="1.4 Solution"></a>1.4 Solution</h2><p>ä½¿ç”¨Recurrent Neural Networkæ—¶ï¼Œè¦å…ˆç»™memoryçš„èµ·å§‹å€¼<img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231106140426.png"><br>ğŸ‘†åˆå§‹å€¼ä¸º0ï¼Œè¾“å…¥ä¸º1ï¼Œç»¿è‰²neuronæ¥æ”¶1ã€1å’Œ0ã€0<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231106140717.png"><br>ğŸ‘†$y_1=4$ã€$y_2=4$<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231106140826.png"><br>ğŸ‘†ç»¿è‰²neuroné‡Œmemoryçš„å€¼å˜æˆ2<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231106140937.png"><br>ğŸ‘†ç¬¬äºŒæ¬¡è¾“å…¥[1,1]<br>å¦‚æœinputçš„é¡ºåºä¸ä¸€æ ·ï¼Œoutputçš„å†…å®¹ä¹Ÿä¼šä¸ä¸€æ ·</p><p>æ€»å†µï¼š<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231106141627.png"><br>åœ¨memoryä¸­storeä¸åŒçš„valuesä½¿å¾—Taipeiçš„slotä¸åŒï¼Œä¸€ä¸ªæ˜¯destinationä¸€ä¸ªæ˜¯place of departure</p><h1 id="2-Deep-hidden-layer-RNN"><a href="#2-Deep-hidden-layer-RNN" class="headerlink" title="2 Deep hidden layer RNN"></a>2 Deep hidden layer RNN</h1><p>ğŸ‘‡æ¯ä¸€ä¸ªç»¿è‰²æ¡†æ˜¯ä¸€ä¸ªhidden layerï¼Œè“è‰²ç®­å¤´æ˜¯hidden layerçš„å€¼memory<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231106144457.png"></p><h2 id="2-1-Elman-Network"><a href="#2-1-Elman-Network" class="headerlink" title="2.1 Elman Network"></a>2.1 Elman Network</h2><p>ğŸ‘‡hidden layerçš„å€¼å…ˆå­˜èµ·æ¥ï¼Œä¸‹ä¸€ä¸ªæ—¶é—´ç‚¹å†è¯»å‡ºæ¥<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231106144650.png"></p><h2 id="2-2-Jordan-Network"><a href="#2-2-Jordan-Network" class="headerlink" title="2.2 Jordan Network"></a>2.2 Jordan Network</h2><p>ğŸ‘‡æŠŠoutputçš„å€¼å…ˆå­˜åœ¨memoryé‡Œé¢ï¼Œä¸‹ä¸€ä¸ªæ—¶é—´ç‚¹å†è¯»å‡ºæ¥<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231106144747.png"></p><h2 id="2-3-Bidirectional-RNN"><a href="#2-3-Bidirectional-RNN" class="headerlink" title="2.3 Bidirectional RNN"></a>2.3 Bidirectional RNN</h2><p>ğŸ‘‡åŒæ—¶trainæ­£å‘å’Œé€†å‘çš„RNNï¼ŒæŠŠæ­£å‘å’Œé€†å‘çš„outputéƒ½ä¸¢åˆ°output layeräº§ç”Ÿ$y^t$<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231106150157.png"><br>ç›¸å½“äºçœ‹äº†æ•´ä¸ªsequence</p><h1 id="3-Long-Short-term-Memory"><a href="#3-Long-Short-term-Memory" class="headerlink" title="3 Long Short-term Memory"></a>3 Long Short-term Memory</h1><p>4 input:â‘ æƒ³è¦å­˜åˆ°memoryä¸­çš„å€¼ â‘¡æ“æ§Input Gateçš„ä¿¡å· â‘¢æ“æ§Output Gateçš„ä¿¡å· â‘£æ“æ§Forget Gateçš„ä¿¡å·<img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231106151107.png"></p><p>$f(z_i)$å†³å®š$g(z)$èƒ½å¦è¾“å…¥<br>Forget Gateè¢«å…³é—­ï¼Œå³$f(z_f)$æ•°å€¼ä¸º0æ—¶ä»£è¡¨é—å¿˜ï¼Œåä¹‹ä¸ºè®°å¿†<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231106210058.png"></p><h2 id="3-1-LSTM-Example"><a href="#3-1-LSTM-Example" class="headerlink" title="3.1 LSTM - Example"></a>3.1 LSTM - Example</h2><p>tæ—¶åˆ»å¯¹memoryçš„å½±å“ä¼šåœ¨t+1æ—¶åˆ»ä½“ç°<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231106211702.png"></p><p>weight å’Œ biasç”¨training dataé€šè¿‡gradient descentå¾—åˆ°çš„<br>LSTM vs original network: 4 times of parameter</p><ul><li>*$x^t$ä¹˜ä¸Šä¸€ä¸ªtransformå¾—åˆ°vector$z$ï¼Œvector$z$çš„æ¯ä¸€ä¸ªdimensionæ“æ§æ¯ä¸€ä¸ªLSTMçš„inputï¼Œ$z$çš„dimensionæ•°ç›®=LSTM memory cellçš„æ•°ç›®ï¼Œ$z^i$ã€$z^o$ã€$z^f$åŒç†</li><li>*$z^i$ã€$z^o$ã€$z^f$ã€$z$ä¸¢åˆ°cellé‡Œçš„å€¼åªæ˜¯ä»–ä»¬å…¶ä¸­çš„ä¸€ä¸ªdimension</li><li>$c^{t-1}$ã€$h^{t-1}$ã€$x^t$ä¸€èµ·ä¹˜transformç„¶åä½œä¸ºè¾“å…¥<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231106223442.png"></li></ul><h2 id="3-2-Learning-Target"><a href="#3-2-Learning-Target" class="headerlink" title="3.2 Learning Target"></a>3.2 Learning Target</h2><p>æœ‰ä¸€ä¸ªtraining sentenceï¼Œè¦ç»™sentenceé‡Œçš„æ¯ä¸€ä¸ªwordä¸€ä¸ªlabel<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231107165449.png"><br>ğŸ‘‡è¾“å…¥arriveå¾—åˆ°ä¸€ä¸ªvetorï¼Œvetorä¸­dimension<code>other</code>çš„å€¼ä¸º1ï¼Œå…¶ä½™ä¸º0ã€‚åœ¨ä¸¢$x^2$ä¹‹å‰è¦å…ˆä¸¢$x^1$<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231107165849.png"><br>reference vector(çº¢è‰²é‚£æ¡)çš„é•¿åº¦å°±æ˜¯slotçš„æ•°ç›®</p><p>ğŸ‘‡RNNå¯ä»¥ç”¨gradient descent trainå‡ºæ¥<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231107170120.png"></p><h2 id="3-3-Problem"><a href="#3-3-Problem" class="headerlink" title="3.3 Problem"></a>3.3 Problem</h2><p>ğŸ‘‡RNN-based network is not always easy to learn<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231107171122.png"><br>ğŸ‘‡ä»æœ€å³è¾¹çš„æ©™è‰²ç‚¹updateåˆ°ä¸­é—´çš„å†updateåˆ°å·¦è¾¹çš„æ©™è‰²ç‚¹ï¼ŒTotal Lossçªç„¶æš´å¢<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231107171305.png"><br>ğŸ‘‡Error Surface æœ€å·¦è¾¹æ©™è‰²çš„ç‚¹çš„ä½ç½®çš„gradientå¾ˆå¤§ï¼Œä¸€å¼€å§‹çš„gradientå¾ˆå°ï¼Œlearning rateæœ‰å¯èƒ½è®¾ç½®å¾—å¾ˆé«˜ï¼Œå¯¼è‡´$gradient$ x $learning$ $rate$ä¼šå¾ˆå¤§ï¼Œå°±åƒå¼€é£æœºä¸€æ ·<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231107194049.png"><br>ğŸ‘†è§£å†³åŠæ³•ï¼šè®¾ç½®threshold valueï¼Œå½“gradientå¤§äºæŸå€¼æ—¶å°†gradientè®¾ç½®ä¸ºæŸå€¼</p><p>RNNçš„é—®é¢˜åœ¨äºtime sequenceçš„weighåœ¨ä¸åŒçš„æ—¶é—´ç‚¹ä¼šè¢«åå¤ä½¿ç”¨<br>ğŸ‘‡$w$ç­‰äº$1$ã€$1.01$ã€$0.99$ã€$0.01$æ—¶ï¼Œ$y$çš„å–å€¼å˜åŒ–éƒ½ä¼šå¾ˆå¤§<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231107200606.png"></p><h2 id="3-4-Solution"><a href="#3-4-Solution" class="headerlink" title="3.4 Solution"></a>3.4 Solution</h2><p><strong>LSTM</strong></p><ol><li>Can deal with gradient vanishing(not gradient explode) ä¸ä¼šå‡ºç°error surfaceå¾ˆå¹³å¦çš„åœ°æ–¹ï¼Œå¯ä»¥è§£å†³æ¢¯åº¦æ¶ˆå¤±çš„é—®é¢˜ğŸ‘‰æ‰€ä»¥learning rateå¯ä»¥è®¾ç½®å¾—å°ä¸€ç‚¹</li><li>RNN vs LSTM<ol><li>RNNä¸­æ¯ä¸ªæ—¶é—´$t$ memoryçš„å€¼ä¼šè¢«è¦†ç›–æ‰</li><li>LSTMä¸­<ol><li>æ¯ä¸ªæ—¶é—´$t$ menory and input are <strong>added</strong>ğŸ‘‰è§£å†³æ¢¯åº¦æ¶ˆå¤±</li><li>The influence never disappears unless forget gate is closedï¼Œåªæœ‰foget gateå…³ä¸Šæ‰æœ‰å¯èƒ½å¯¼è‡´LSTMä¸æ–­æ›´æ–°inputå’Œmemoryçš„å€¼</li><li>No gradient vanishing(If forget gate is opened)</li></ol></li></ol></li></ol><h1 id="4-More-Applications"><a href="#4-More-Applications" class="headerlink" title="4 More Applications"></a>4 More Applications</h1><h2 id="4-1-Sequence-to-sequence"><a href="#4-1-Sequence-to-sequence" class="headerlink" title="4.1 Sequence-to-sequence"></a>4.1 Sequence-to-sequence</h2><ol><li>Input is a vector sequence, but output is only one vector(Many to  One)<ol><li>Sentiment Analysis</li><li>Key Term Extraction</li></ol></li><li>Both input and output are both sequences, but the output is shorter(Many to Many)<ol><li>Speech Recognition</li><li>Connectionist Temporal Classification(CTC)<ol><li><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231107205719.png"></li><li>æŠŠå³è¾¹ä¸‰ç§ç»“æœéƒ½è§†ä¸ºæ­£ç¡®ä¸¢åˆ°training dataä¸­ <img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231107205955.png"></li><li>æœºå™¨ä¸éœ€è¦è®¤è¯†æŸä¸ªè¯æ±‡<img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231107210143.png"></li></ol></li><li>Sequence to sequence learning(Many to Many(No Limitation))<ol><li>RNNçš„inputå’Œoutputéƒ½æ˜¯sequenceï¼Œinputå’Œoutputçš„é•¿åº¦ä¸ç¡®å®šã€‚é™¤æ­¤ä¹‹å¤–ï¼Œåœ¨æœ€åä¸€ä¸ªæ—¶é—´ç‚¹ï¼Œmemoryé‡Œå­˜äº†æ‰€æœ‰input sequenceçš„informationï¼Œç„¶åå°±è®©machineå¼€å§‹åcharacterï¼Œå†å°†ä¹‹å‰çš„outputçš„characterä½œä¸ºinputï¼Œå†è¯»å–ä¸Šä¸€ä¸ªmemoryçš„å€¼ï¼Œç»§ç»­output</li><li>Problem:Donâ€™t know when to stop<img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231107222413.png"></li><li>Solution:Add a symbol â€œ===â€œæ–­<img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231107222616.png"></li></ol></li></ol></li><li>Sequence-to-sequence Auto-encoder<img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231108102135.png"><br>ğŸ‘†RNN Encoderå’ŒRNN Decoderæ˜¯ä¸€èµ·trainçš„ï¼Œç›®çš„æ˜¯è®©trainå‡ºæ¥çš„$y_1$ã€$y_2$ã€$y_3$ã€$y_4$ä¸$x_1$ã€$x_2$ã€$x_3$ã€$x_4$ç›¸è¿‘</li></ol><h2 id="4-2-Attention-based-Model"><a href="#4-2-Attention-based-Model" class="headerlink" title="4.2 Attention-based Model"></a>4.2 Attention-based Model</h2><p>ğŸ‘‡ä¸­å¤®å¤„ç†å™¨DNN/RNNæ“æ§Reading Head Controllerã€è¯»å†™å¤´å†³å®šReading Headæ”¾çš„ä½ç½®<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231108102942.png"><br>ğŸ‘‡ç‰ˆæœ¬â…¡ Neural Turing Machine(2014)<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231108103018.png"></p>]]></content>
      
      
      <categories>
          
          <category> äººå·¥æ™ºèƒ½ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> äººå·¥æ™ºèƒ½ </tag>
            
            <tag> å¾ªç¯ç¥ç»ç½‘ç»œ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CNN(æå®æ¯…)</title>
      <link href="/2023/11/04/cnn-li-hong-yi/"/>
      <url>/2023/11/04/cnn-li-hong-yi/</url>
      
        <content type="html"><![CDATA[<h1 id="1-Image-Classification"><a href="#1-Image-Classification" class="headerlink" title="1 Image Classification"></a>1 Image Classification</h1><p>ä¸€å¼ 100x100pixelsçš„å›¾ç‰‡å…¶å®æ˜¯ä¸€ä¸ª3D-tensorï¼š<br>â‘ å›¾ç‰‡çš„é«˜<code>100</code>â‘¡å›¾ç‰‡çš„å®½<code>100</code>â‘¢3 channels<code>RGB</code><br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231104203002.png"><br>æ¯ä¸€ä¸ªæ•°å€¼ä»£è¡¨æŸä¸€ä¸ªé¢œè‰²æŸä¸€ä¸ªpixelçš„å¼ºåº¦</p><h1 id="2-Image-Feature-Observation"><a href="#2-Image-Feature-Observation" class="headerlink" title="2 Image Feature Observation"></a>2 Image Feature Observation</h1><h2 id="2-1-Observation-1"><a href="#2-1-Observation-1" class="headerlink" title="2.1 Observation 1"></a>2.1 Observation 1</h2><ol><li><p>Identifying some critical patterns<br> æ¯”å¦‚è¯´ä¸€åªé¸Ÿï¼Œåªç”¨çœ‹é¸Ÿå˜´ã€çœ¼ç›å’Œè„šä¹Ÿèƒ½å¤§è‡´è¾¨è®¤å‡ºæ¥<br> A neuron does not have to see the whole image</p></li><li><p>Simplification<br> è®¾å®šä¸€ä¸ªåŒºåŸŸä¸ºReceptive fieldï¼Œæ¯ä¸€ä¸ªneuronåªå…³å¿ƒè‡ªå·±çš„Receptive fieldã€‚<br> Receptive field can be overlapped<br> neuron can have the same receptive field<br> <img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231104204207.png"></p></li><li><p>Simplification 1-Typical Setting</p></li><li><p>ä¼šçœ‹all channelsï¼Œä¸ç”¨ææ·±åº¦ï¼Œé«˜å’Œå®½åˆèµ·æ¥å«kernel size</p></li><li><p>Each receptive field has a set of neurons</p></li><li><p>å¹³ç§»receptive fieldï¼Œæ­¥é•¿ä¸ºstrideï¼Œreceprive fieldæœ‰é‡å ï¼Œé˜²æ­¢äº¤ç•Œå¤„æœ‰patternæ²¡è¢«neuronä¾¦æµ‹åˆ°</p></li><li><p>å¹³ç§»æ—¶è¶…å‡ºèŒƒå›´äº†ï¼Œç”¨å¡«è¡¥0ä»£æ›¿è¶…å‡ºçš„èŒƒå›´(æ–¹æ³•ä¸å”¯ä¸€)</p></li></ol><h2 id="2-2-Observation-2"><a href="#2-2-Observation-2" class="headerlink" title="2.2 Observation 2"></a>2.2 Observation 2</h2><ol><li>The same patterns appear in different regions<br> ğŸ‘‡solution: parameter sharing<br> çº¿æ¡ä»£è¡¨weightï¼Œç›¸åŒé¢œè‰²ä»£è¡¨weightä¸€æ ·ï¼Œå®ˆå¤‡çš„receptive fieldä¸ä¸€æ ·ï¼Œå‚æ•°ä¸€æ ·ï¼Œå› ä¸ºè¾“å…¥ä¸ä¸€æ ·ï¼Œæ‰€ä»¥è¾“å‡ºä¹Ÿä¸ä¸€æ ·<br> <img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231104215341.png"></li><li>Simplification 2-Typical Setting<ol><li>æ¯ä¸€ä¸ªreceptive fieldéƒ½æœ‰ä¸€ç»„neurons</li><li>ç›¸åŒé¢œè‰²çš„åœ†åœˆä»£è¡¨å…±äº«ä¸€æ ·çš„å‚æ•°çš„neurons</li><li>æ¯ä¸€ä¸ªreceptive fieldéƒ½åªæœ‰ä¸€ç»„å‚æ•°ï¼Œè¿™äº›å‚æ•°å«filter x<br> <img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231104215840.png"></li></ol></li></ol><h2 id="2-3-Obeservation-3"><a href="#2-3-Obeservation-3" class="headerlink" title="2.3 Obeservation 3"></a>2.3 Obeservation 3</h2><p>Subsampling the pixels will not change the object<br>e.g.æ‹¿æ‰imageå¥‡æ•°è¡Œå’Œå¶æ•°åˆ—çš„pixelsï¼Œå›¾ç‰‡å˜æˆåŸæ¥çš„$\frac{1}{4}$å¤§å°</p><h1 id="3-Benefit-of-Convolutional-Layer"><a href="#3-Benefit-of-Convolutional-Layer" class="headerlink" title="3 Benefit of Convolutional Layer"></a>3 Benefit of Convolutional Layer</h1><ul><li><code>Fully Connected Layer</code>ä¸éœ€è¦çœ‹æ•´ä¸ªå›¾ç‰‡ï¼Œåªéœ€è¦é‡è¦çš„patternğŸ‘‰<code>receptive field</code>æŸä¸€äº›neuronsä¸€å®šè¦ä¸€æ‘¸ä¸€æ ·ğŸ‘‰<code>parameter sharing</code></li><li><code>receptive field</code>+<code>parameter sharing</code>=<code>convolutional layer</code>ï¼Œè™½ç„¶ä¼šæœ‰è¾ƒå¤§çš„model biasï¼Œä½†æ˜¯convolutional layeræ˜¯ä¸“é—¨ä¸ºå½±åƒè®¾è®¡çš„ï¼Œæ‰€ä»¥ç”¨åœ¨imageä¸Šåå·®ä¸ä¼šå¾ˆå¤§</li><li>ç”¨<code>convolutional layer</code>çš„networkå«åš<code>CNN</code></li></ul><h1 id="4-Multiple-Convolutional-Layers"><a href="#4-Multiple-Convolutional-Layers" class="headerlink" title="4 Multiple Convolutional Layers"></a>4 Multiple Convolutional Layers</h1><ul><li>nä¸ªfilterså¯å½¢æˆfeature map with n channels</li><li><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231104223016.png"><ol><li>å…ˆæ˜¯å°†<code>RGB</code>å›¾ç‰‡æ”¾å…¥convolutioné‡Œï¼Œå‡è®¾æœ‰64ä¸ªfilter(æ¯ä¸ªfilteréƒ½æ˜¯3x3x3)ï¼Œé‚£ä¹ˆå°±ä¼šå¾—åˆ°ä¸€ä¸ª feature map(å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªæ–°çš„å›¾ç‰‡ï¼Œåªæ˜¯ä»–çš„channelsæœ‰64ä¸ª) </li><li>å†æŠŠfeature mapæ”¾å…¥convolutioné‡Œï¼Œfilterçš„å¤§å°ä¸ºï¼š3x3x<strong>64</strong>(filterçš„é«˜åº¦å°±æ˜¯å®ƒè¦å¤„ç†çš„imageçš„channel)</li></ol></li><li>filteræ¯”è¾ƒå°çš„æƒ…å†µä¸‹ä¹Ÿèƒ½è®©networkçœ‹æ¯”è¾ƒå¤§èŒƒå›´çš„pattern<br>   <img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231104224407.png"><br>   å³ä¸‹è§’è“è‰²åœ†åœˆçš„æ˜¯å…¶ä¸­ä¸€ä¸ªfilterï¼Œå³ä¸Šè§’æ˜¯imageï¼Œimageå·¦ä¸Šè§’çº¢è‰²æ¡†å¯¹åº”filterå·¦ä¸Šè§’çº¢è‰²æ¡†ï¼Œimageå³ä¸‹è§’çº¢è‰²æ¡†å¯¹åº”filterå³ä¸‹è§’çº¢è‰²æ¡†ã€‚feature mapçš„3x3å¯¹åº”imageçš„5x5<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231104225301.png"></li></ul><h1 id="5-Pooling-Max-Pooling"><a href="#5-Pooling-Max-Pooling" class="headerlink" title="5 Pooling - Max Pooling"></a>5 Pooling - Max Pooling</h1><p>åœ¨feature mapä¸­ï¼Œn x nä¸ªæ•°å­—ä¸€ç»„<br><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231104225853.png">ğŸ‘‰<img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231104225920.png"><br>max poolingå°±æ˜¯é€‰ä¸€ç»„é‡Œæœ€å¤§çš„é‚£ä¸ªæ•°<br>åšå®Œconvolutionä¹‹åé€šå¸¸ä¼šæ­é…poolingï¼Œpoolingä¸æ”¹å˜channelsï¼Œä½†æ˜¯æ”¹å˜é•¿å®½</p><h1 id="6-The-whole-CNN"><a href="#6-The-whole-CNN" class="headerlink" title="6 The whole CNN"></a>6 The whole CNN</h1><p>Flattenï¼šå°†poolingçš„outputæœ¬æ¥çŸ©é˜µçš„æ ·å­æ‹‰ç›´</p><h1 id="7-Application-Playing-Go"><a href="#7-Application-Playing-Go" class="headerlink" title="7 Application: Playing Go"></a>7 Application: Playing Go</h1><ul><li>Alpha Go uses 5x5 for first layerï¼Œå¯èƒ½æ˜¯5x5çš„èŒƒå›´æ¯”è¾ƒé‡è¦</li><li>åŒæ ·å¯èƒ½å­˜åœ¨ç›¸åŒçš„pattersåœ¨ä¸åŒçš„regionsé‡Œ</li><li>ä¸ç”¨pooling</li></ul><h1 id="8-å®æ“"><a href="#8-å®æ“" class="headerlink" title="8 å®æ“"></a>8 å®æ“</h1><h2 id="8-1-Code"><a href="#8-1-Code" class="headerlink" title="8.1 Code"></a>8.1 Code</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> torchvision<span class="token punctuation">.</span>transforms <span class="token keyword">as</span> transformsimage_data <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token comment"># Your image data here</span><span class="token comment"># Applying the transformations</span>transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>    transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0.1307</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0.3081</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>transformed_data <span class="token operator">=</span> transform<span class="token punctuation">(</span>image_data<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="8-2-åŸç†"><a href="#8-2-åŸç†" class="headerlink" title="8.2 åŸç†"></a>8.2 åŸç†</h2><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231113221316.png"></p><h1 id="9-Advanced-CNN"><a href="#9-Advanced-CNN" class="headerlink" title="9 Advanced CNN"></a>9 Advanced CNN</h1><ul><li>å½“è®­ç»ƒæ¬¡æ•°è¿‡å¤šæ—¶ä¼šå‘ç”Ÿè¿‡æ‹Ÿåˆï¼Œå› æ­¤å¹¶ä¸æ˜¯è®­ç»ƒæ¬¡æ•°è¶Šå¤šæ¨¡å‹å‡†ç¡®åº¦è¶Šé«˜</li><li>è§£å†³æ¢¯åº¦æ¶ˆå¤±(è¿‡æ‹Ÿåˆ)ï¼Œä½¿ç”¨<strong>Residual net</strong></li></ul><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/DL%26ML_picture/Pasted%20image%2020231119135500.png"><br>$z=H(x)$<br>$\dfrac{\partial z}{x}=\dfrac{\partial F(x)}{\partial x} + \dfrac{\partial x}{\partial x}=\dfrac{\partial F(x)}{\partial x}+1$<br>æ¢¯åº¦=$\dfrac{\partial L}{\partial z}\times\dfrac{\partial z}{\partial x}$<br>å½“$\dfrac{\partial F}{\partial x}$å¾ˆå°çš„æ—¶å€™ï¼Œ$\dfrac{\partial z}{\partial x}$ä¸ä¼šåœ¨0çš„é™„è¿‘</p>]]></content>
      
      
      <categories>
          
          <category> äººå·¥æ™ºèƒ½ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> äººå·¥æ™ºèƒ½ </tag>
            
            <tag> å·ç§¯ç¥ç»ç½‘ç»œ </tag>
            
            <tag> æ·±åº¦å­¦ä¹  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>éšå«è¿ªåˆ©å…‹é›·æ¨¡å‹LDA</title>
      <link href="/2023/05/21/lda-mo-xing/"/>
      <url>/2023/05/21/lda-mo-xing/</url>
      
        <content type="html"><![CDATA[<p><a href="https://blog.csdn.net/v_JULY_v/article/details/41209515?spm=1001.2101.3001.6650.1&amp;utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-1.no_search_link&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-1.no_search_link&amp;utm_relevant_index=2">å‚è€ƒåšå®¢</a></p><p><a href="https://oa7vrw2neqh.feishu.cn/docx/CB0WdZbkioi90JxOFTVczXfmngd">é£ä¹¦ç‰ˆç¬”è®°(å¸¦pdf)</a></p><h1 id="1-æ•´ä½“æŠŠæ¡"><a href="#1-æ•´ä½“æŠŠæ¡" class="headerlink" title="1.æ•´ä½“æŠŠæ¡"></a>1.æ•´ä½“æŠŠæ¡</h1><p>LDAæ˜¯ä¸€ç§<strong>ä¸»é¢˜æ¨¡å‹</strong>ï¼Œå¯ä»¥å°†æ–‡æ¡£é›†ä¸­æ¯ç¯‡æ–‡æ¡£çš„ä¸»é¢˜ä»¥<strong>æ¦‚ç‡åˆ†å¸ƒ</strong>çš„å½¢å¼ç»™å‡ºï¼Œæ ¹æ®ç»™å®šçš„ä¸€ç¯‡æ–‡ç« ï¼Œåæ¨å…¶ä¸»é¢˜åˆ†å¸ƒ</p><p>ä¸€ç¯‡æ–‡æ¡£å¯ä»¥åŒ…å«å¤šä¸ªä¸»é¢˜ï¼Œæ–‡æ¡£ä¸­æ¯ä¸€ä¸ªè¯éƒ½ç”±å…¶ä¸­çš„ä¸€ä¸ªä¸»é¢˜ç”Ÿæˆ</p><h2 id="1-1LDAçš„å›¾æ¨¡å‹ç»“æ„"><a href="#1-1LDAçš„å›¾æ¨¡å‹ç»“æ„" class="headerlink" title="1.1LDAçš„å›¾æ¨¡å‹ç»“æ„"></a>1.1LDAçš„å›¾æ¨¡å‹ç»“æ„</h2><p>  ç±»ä¼¼è´å¶æ–¯ç½‘ç»œç»“æ„</p><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LDA/1702178138892.jpg"></p><h3 id="1-1-1è´å¶æ–¯çš„å®šä¹‰"><a href="#1-1-1è´å¶æ–¯çš„å®šä¹‰" class="headerlink" title="1.1.1è´å¶æ–¯çš„å®šä¹‰"></a>1.1.1è´å¶æ–¯çš„å®šä¹‰</h3><p>  èŠ‚ç‚¹è¡¨ç¤ºéšæœºå˜é‡${X_1,X_2,â€¦,X_n}$ï¼Œè®¤ä¸ºæœ‰<strong>å› æœå…³ç³»</strong>(æˆ–éæ¡ä»¶ç‹¬ç«‹)çš„å˜é‡æˆ–å‘½é¢˜ç”¨ç®­å¤´æ¥è¿æ¥ã€‚å¦‚æœç”¨ä¸€ä¸ªå•ç®­å¤´æ¥è¿æ¥ï¼Œè¡¨ç¤ºå…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹æ˜¯â€œå› (parents)â€ï¼Œå¦ä¸€ä¸ªæ˜¯â€œæœ(children)â€ï¼Œä¸¤èŠ‚ç‚¹å°±ä¼šäº§ç”Ÿä¸€ä¸ªæ¡ä»¶æ¦‚ç‡å€¼</p><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LDA/1702177828629.jpg"></p><p>  ğŸ‘†åœˆè¡¨ç¤ºéšæœºå˜é‡(random variables)ï¼Œç”¨ç®­å¤´è¡¨ç¤ºæ¡ä»¶ä¾èµ–(conditional dependencies)</p><p>  ä»¤$G = (I,E)$è¡¨ç¤ºä¸€ä¸ªæœ‰å‘æ— ç¯å›¾(DAG)ï¼Œå…¶ä¸­Iä»£è¡¨å›¾å½¢ä¸­æ‰€æœ‰çš„èŠ‚ç‚¹çš„é›†åˆï¼Œè€ŒEä»£è¡¨æœ‰å‘è¿æ¥çº¿æ®µçš„é›†åˆï¼Œä¸”ä»¤$X = (X_i),i âˆˆ I$ä¸ºå…¶æœ‰å‘æ— ç¯å›¾ä¸­çš„æŸä¸€èŠ‚ç‚¹iæ‰€ä»£è¡¨çš„éšæœºå˜é‡ï¼Œè‹¥èŠ‚ç‚¹Xçš„è”åˆæ¦‚ç‡å¯ä»¥è¡¨ç¤ºæˆ$p(x)=\prod\limits_{i\in I}p(x_i|x_{pa(i)})$ï¼Œåˆ™ç§°$X$ä¸ºç›¸å¯¹äºä¸€æœ‰å‘æ— ç¯å›¾G çš„è´å¶æ–¯ç½‘ç»œï¼Œå…¶ä¸­ï¼Œ$pa(i)$è¡¨ç¤ºèŠ‚ç‚¹iä¹‹â€œå› â€ï¼Œæˆ–ç§°$pa(i)$æ˜¯$i$çš„parentsï¼ˆçˆ¶æ¯ï¼‰ã€‚</p><p>  è”åˆæ¦‚ç‡ï¼šäº‹ä»¶Aå’Œäº‹ä»¶BåŒæ—¶å‘ç”Ÿçš„æ¦‚ç‡ï¼Œè®°ä¸º$P(AB)$æˆ–$P(A,B)$æˆ–$P(Aâˆ©B)$</p><p>  å¯¹äºä»»æ„çš„éšæœºå˜é‡ï¼Œå…¶è”åˆæ¦‚ç‡å¯ç”±å„è‡ªçš„å±€éƒ¨æ¡ä»¶æ¦‚ç‡åˆ†å¸ƒç›¸ä¹˜å¾—å‡ºï¼š</p><p>  $p(x_1,â€¦.,x_K)=p(x_K|x_1,â€¦.,x_{K-1})â€¦p(x_2|x_1)p(x_1)$</p><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LDA/1702177836358.jpg"></p><p>  ğŸ‘†ä¸€ä¸ªç®€å•çš„è´å¶æ–¯ç½‘ç»œ(aå¯¼è‡´bï¼Œaå’Œbå¯¼è‡´c)</p><p>  $p(a,b,c)=p(c|a.b)p(b|a)p(a)$</p><h2 id="1-2äºŒé¡¹å¼åˆ†å¸ƒ"><a href="#1-2äºŒé¡¹å¼åˆ†å¸ƒ" class="headerlink" title="1.2äºŒé¡¹å¼åˆ†å¸ƒ"></a>1.2äºŒé¡¹å¼åˆ†å¸ƒ</h2><p>éšæœºå˜é‡åªæœ‰ä¸¤ä¸ª(éæ­£å³è´Ÿ)ï¼Œå³é‡å¤næ¬¡çš„ä¼¯åŠªåˆ©å®éªŒï¼Œè®°ä¸º$X\sim b(n,p)$</p><p>äºŒé¡¹åˆ†å¸ƒçš„æ¦‚ç‡å¯†åº¦å‡½æ•°ä¸ºï¼š</p><p>$P(K=k)=(n,k)p^k(1-p)^{n-k}$</p><p> å¯¹äºk = 0, 1, 2, â€¦, nï¼Œå…¶ä¸­çš„</p><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LDA/1702177851194(1).jpg"></p><p>æ˜¯äºŒé¡¹å¼ç³»æ•°ï¼ˆè¿™å°±æ˜¯äºŒé¡¹åˆ†å¸ƒçš„åç§°çš„ç”±æ¥ï¼‰ï¼Œåˆè®°ä¸º$\dfrac{n!}{k!(n-k)!}$</p><h2 id="1-3å¤šé¡¹å¼åˆ†å¸ƒ"><a href="#1-3å¤šé¡¹å¼åˆ†å¸ƒ" class="headerlink" title="1.3å¤šé¡¹å¼åˆ†å¸ƒ"></a>1.3å¤šé¡¹å¼åˆ†å¸ƒ</h2><p>ç”±äºŒé¡¹åˆ†å¸ƒæ‰©å±•åˆ°å¤šç»´çš„æƒ…å†µ</p><p>éšæœºå˜é‡å–å€¼ä¸æ˜¯0-1ï¼Œè€Œæ˜¯æœ‰å¤šç§ç¦»æ•£å€¼çš„å¯èƒ½(1,2,3,â€¦,k)</p><p>å‡è®¾æœ‰$i$ä¸ªç¦»æ•£å€¼ï¼Œé‚£ä¹ˆæœ‰$\sum_{i=1}^kp_i=1,p_i&gt;0$</p><p>å¤šé¡¹å¼åˆ†å¸ƒçš„æ¦‚ç‡å¯†åº¦å‡½æ•°ä¸ºï¼š$P(x_1,x_2,â€¦,x_k;n,p_1,p_2,â€¦,p_k)=\dfrac{n!}{x_1!â€¦x_k!}p^{x_1}â€¦p^{x_k}$</p><h2 id="1-4Gammaåˆ†å¸ƒ"><a href="#1-4Gammaåˆ†å¸ƒ" class="headerlink" title="1.4Gammaåˆ†å¸ƒ"></a>1.4Gammaåˆ†å¸ƒ</h2><p><a href="https://zhuanlan.zhihu.com/p/69606875">Betaå‡½æ•°å’ŒGammaå‡½æ•°çš„å…³ç³»</a></p><p>Gammaå‡½æ•°å®é™…æ„ä¹‰ï¼šé˜¶ä¹˜ä¸€èˆ¬åŒ–ï¼Œå°†é˜¶ä¹˜æ¨å¹¿åˆ°å®æ•°åŸŸ</p><p>This content is only supported in a Feishu Docs</p><h1 id="2-Betaåˆ†å¸ƒ"><a href="#2-Betaåˆ†å¸ƒ" class="headerlink" title="2.Betaåˆ†å¸ƒ"></a>2.Betaåˆ†å¸ƒ</h1><p>This content is only supported in a Feishu Docs</p><h2 id="2-1Betaåˆ†å¸ƒ"><a href="#2-1Betaåˆ†å¸ƒ" class="headerlink" title="2.1Betaåˆ†å¸ƒ"></a>2.1Betaåˆ†å¸ƒ</h2><p>betaæ˜¯æŒ‡ä¸€ç»„å®šä¹‰åœ¨$(0,1)$åŒºé—´çš„è¿ç»­æ¦‚ç‡åˆ†å¸ƒï¼Œæœ‰ä¸¤ä¸ªå‚æ•°$\alpha$å’Œ$\beta$ï¼Œä¸”$\alpha,\beta&gt;0$</p><p>äºŒé¡¹åˆ†å¸ƒçš„å…±è½­å…ˆéªŒåˆ†å¸ƒ</p><p>ç»™å®šå‚æ•°$\alpha&gt;0$å’Œ$\beta&gt;0$ï¼Œå–å€¼èŒƒå›´ä¸º[0,1]çš„éšæœºå˜é‡ x çš„æ¦‚ç‡å¯†åº¦å‡½æ•°ï¼š$f(x;\alpha,\beta)=\dfrac{1}{B(\alpha,\beta)}x^{\alpha-1}(1-x)^{\beta-1}$</p><p>å…¶ä¸­$\dfrac{1}{B(\alpha,\beta)}=\dfrac{\Gamma(\alpha+\beta)}{\Gamma(\alpha)\Gamma(\beta)},\Gamma(z)=\int_0^\infty t^{z-1}e^{-t}dt$</p><p>è§pdf</p><h2 id="2-2Beta-Binomialå…±è½­"><a href="#2-2Beta-Binomialå…±è½­" class="headerlink" title="2.2Beta-Binomialå…±è½­"></a>2.2Beta-Binomialå…±è½­</h2><ul><li>é—®é¢˜å¼•å…¥ï¼š<ul><li><strong>é—®é¢˜1</strong>ï¼šéšæœºå˜é‡$X_1,X_2,â€¦,X_n\sim^{idd}Uniform(0,1)$ï¼ŒæŠŠè¿™nä¸ªéšæœºå˜é‡æ’åºåå¾—åˆ°é¡ºåºç»Ÿè®¡é‡$X_{(1)},X_{(2)},â€¦,X_{(n)}$ï¼Œé—®$X_{(k)}$çš„åˆ†å¸ƒæ˜¯ä»€ä¹ˆ</li><li><strong>é—®é¢˜2</strong>ï¼š$X_{(k)}$çš„åˆ†å¸ƒæ˜¯ä»€ä¹ˆ &lt;==&gt; çŒœæµ‹$p=X_{(k)}$ï¼Œ<ul><li>$Y_1,Y_2,â€¦,Y_n\sim^{idd}Uniform(0,1)$,$Y_i$ä¸­æœ‰$m_1$ä¸ªæ¯”$p$å°ï¼Œ$m_2$ä¸ªæ¯”$p$å¤§ï¼Œé—®$P(p|Y_1,Y_2,â€¦Y_m)$çš„åˆ†å¸ƒæ˜¯ä»€ä¹ˆ</li></ul></li></ul></li><li>åˆ†æï¼š<ul><li>æ¢è¨€ä¹‹ï¼Œ$Y_i$ä¸­æœ‰$m_1$ä¸ªæ¯”$X_{(k)}$å°ï¼Œæœ‰$m_2$ä¸ªæ¯”$X_{(k)}$å¤§ï¼Œæ‰€ä»¥$X_{(k)}$æ˜¯$X_1,X_2,â€¦,X_n,Y_1,Y_2,â€¦,Y_n\sim^{idd}Uniform(0,1)$ä¸­ç¬¬$k+m_1$å¤§çš„æ•°</li><li>äº‹ä»¶æœä»Betaåˆ†å¸ƒ</li><li>å¯çŸ¥$p=X_{(k)}$çš„å¯†åº¦æ¦‚ç‡å‡½æ•°ä¸ºï¼š$Beta(p|k+m_1,n-k+1+m_2)$</li></ul></li><li>ä¸è´å¶æ–¯ç»“åˆè¿‡ç¨‹<ul><li><p>è´å¶æ–¯æ´¾æ€è€ƒé—®é¢˜çš„å›ºå®šæ¨¡å¼ï¼š</p></li><li><p><strong>å…ˆéªŒåˆ†å¸ƒ</strong>$\pi(\theta)$<strong>+ æ ·æœ¬ä¿¡æ¯</strong>$X$$\rightarrow$<strong>åéªŒåˆ†å¸ƒ</strong>$\pi(\theta|x)$</p></li><li><p>åœ¨å¾—åˆ°æ–°çš„æ ·æœ¬ä¿¡æ¯ä¹‹å‰ï¼Œäººä»¬å¯¹$\theta$çš„è®¤çŸ¥æ˜¯å…ˆéªŒåˆ†å¸ƒ$\pi(\theta)$ï¼Œåœ¨å¾—åˆ°æ–°çš„æ ·æœ¬ä¿¡æ¯</p><p>$X$åï¼Œäººä»¬å¯¹$\theta$çš„è®¤çŸ¥ä¸º$\pi(\theta|x)$</p></li><li><p>è¿‡ç¨‹</p><ul><li>ä¸ºäº†çŒœæµ‹$p=X_{(k)}$ï¼Œåœ¨è·å¾—ä¸€å®šçš„è§‚æµ‹æ•°æ®å‰ï¼Œæˆ‘ä»¬å¯¹$p$çš„è®¤çŸ¥æ˜¯ï¼š$f(p)=Beta(p|k,n-k+1)$ï¼Œæ­¤ç§°ä¸º$p$çš„å…ˆéªŒåˆ†å¸ƒ</li><li>ä¸ºäº†è·å¾—ç»“æœ$Y_i$ä¸­æœ‰$m_1$ä¸ªæ¯”$p$å°ï¼Œ$m_2$ä¸ªæ¯”$p$å¤§ï¼Œé’ˆå¯¹$Y_i$åšäº†$m$æ¬¡ä¼¯åŠªåˆ©å®éªŒï¼Œæ‰€ä»¥$m_1$æœä»äºŒé¡¹åˆ†å¸ƒ$B(m,p)$</li><li>åœ¨å¾—åˆ°$(m_1,m_2)$çš„æ•°æ®åï¼Œ$p$çš„åéªŒåˆ†å¸ƒä¸º$f(p|m_1,m_2)=Beta(p|k+m_1,n-k+1+m_2)$</li></ul></li><li><p>ç»“åˆè´å¶æ–¯</p><ul><li>$Beta(p|k,n-k+1)+Count(m_1,m_2)=Beta(p|k+m_1,n-k+1+m_2)$</li><li>æ›´ä¸€èˆ¬çš„ï¼Œå¯¹äºéè´Ÿå®æ•°$\alpha$å’Œ$\beta$ï¼šæœ‰å¦‚ä¸‹å…³ç³»$Beta(p|\alpha,\beta)+Count(m_1,m_2)=Beta(p|\alpha+m_1,\beta+m_2)$ï¼Œå…¶ä¸­$Count(m_1,m_2)$å¯¹åº”$B(m,p)$</li><li>é’ˆå¯¹è¿™ç§è§‚æµ‹åˆ°çš„æ•°æ®ç¬¦åˆä»¥ä¸‹æ¡ä»¶çš„ï¼Œå°±æ˜¯Beta-Binomialå…±è½­ï¼Œæ¢è¨€ä¹‹ï¼ŒBetaåˆ†å¸ƒæ˜¯äºŒé¡¹å¼åˆ†å¸ƒçš„å…±è½­å…ˆéªŒæ¦‚ç‡åˆ†å¸ƒ<ul><li>æ¡ä»¶ä¸€ï¼šäºŒé¡¹åˆ†å¸ƒ</li><li>æ¡ä»¶äºŒï¼šå‚æ•°çš„å…ˆéªŒåˆ†å¸ƒå’ŒåéªŒåˆ†å¸ƒéƒ½æ˜¯Betaåˆ†å¸ƒ</li><li>å…±è½­å…ˆéªŒåˆ†å¸ƒâ†’2.3</li></ul></li><li>äºŒé¡¹åˆ†å¸ƒå’ŒBetaåˆ†å¸ƒæ˜¯å…±è½­åˆ†å¸ƒæ„å‘³ç€ï¼Œå¦‚æœæˆ‘ä»¬ä¸ºäºŒé¡¹åˆ†å¸ƒçš„å‚æ•°pé€‰å–çš„å…ˆéªŒåˆ†å¸ƒæ˜¯Betaåˆ†å¸ƒï¼Œé‚£ä¹ˆä»¥pä¸ºå‚æ•°çš„äºŒé¡¹åˆ†å¸ƒç”¨è´å¶æ–¯ä¼°è®¡å¾—åˆ°çš„åéªŒåˆ†å¸ƒä»ç„¶æœä»Betaåˆ†å¸ƒ</li></ul></li><li><p>$\alpha$å’Œ$\beta$å¯ä»¥è®¤ä¸ºæ˜¯å½¢çŠ¶å‚æ•°</p></li></ul></li></ul><h2 id="2-3å…±è½­å…ˆéªŒåˆ†å¸ƒ"><a href="#2-3å…±è½­å…ˆéªŒåˆ†å¸ƒ" class="headerlink" title="2.3å…±è½­å…ˆéªŒåˆ†å¸ƒ"></a>2.3å…±è½­å…ˆéªŒåˆ†å¸ƒ</h2><p>å¦‚æœåéªŒæ¦‚ç‡å’Œå…ˆéªŒæ¦‚ç‡æ»¡è¶³åŒæ ·çš„åˆ†å¸ƒå¾‹ï¼Œé‚£ä¹ˆå…ˆéªŒåˆ†å¸ƒå’ŒåéªŒåˆ†å¸ƒè¢«å«åšå…±è½­åˆ†å¸ƒï¼ŒåŒæ—¶ï¼Œå…ˆéªŒåˆ†å¸ƒå«åšä¼¼ç„¶å‡½æ•°çš„å…±è½­å…ˆéªŒåˆ†å¸ƒã€‚</p><p>  æ¯”å¦‚ï¼ŒæŸè§‚æµ‹æ•°æ®æœä»æ¦‚ç‡åˆ†å¸ƒP(Î¸)(å…ˆéªŒ)æ—¶ï¼Œå½“è§‚æµ‹åˆ°æ–°çš„Xæ•°æ®(æ ·æœ¬ä¿¡æ¯)æ—¶ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šé‡åˆ°å¦‚ä¸‹é—®é¢˜ï¼š</p><ul><li>å¯å¦æ ¹æ®æ–°è§‚æµ‹æ•°æ®Xï¼Œæ›´æ–°å‚æ•°Î¸ï¼Ÿ</li><li>æ ¹æ®æ–°è§‚æµ‹æ•°æ®å¯ä»¥åœ¨å¤šå¤§ç¨‹åº¦ä¸Šæ”¹å˜å‚æ•°Î¸ï¼Œå³$\theta \leftarrow \theta + \triangle \theta$</li><li>å½“é‡æ–°ä¼°è®¡Î¸çš„æ—¶å€™ï¼Œç»™å‡ºæ–°å‚æ•°å€¼Î¸çš„æ–°æ¦‚ç‡åˆ†å¸ƒï¼Œå³P(Î¸|x)ã€‚</li></ul><h2 id="2-4ä»Betaåˆ†å¸ƒæ¨å¹¿åˆ°Dirichletåˆ†å¸ƒ"><a href="#2-4ä»Betaåˆ†å¸ƒæ¨å¹¿åˆ°Dirichletåˆ†å¸ƒ" class="headerlink" title="2.4ä»Betaåˆ†å¸ƒæ¨å¹¿åˆ°Dirichletåˆ†å¸ƒ"></a>2.4ä»Betaåˆ†å¸ƒæ¨å¹¿åˆ°Dirichletåˆ†å¸ƒ</h2><p>è§pdf</p><p>ç»“è®ºæ˜¯ï¼šå¯¹äºBetaåˆ†å¸ƒçš„éšæœºå˜é‡ï¼Œå…¶å‡å€¼(æœŸæœ›)å¯ä»¥ç”¨$\dfrac{\alpha}{\alpha+\beta}$æ¥ä¼°è®¡</p><p>ç±»æ¯”åˆ°Dirichletåˆ†å¸ƒï¼šå¦‚æœ$\mathop{p}\limits^{\rightarrow}\sim Dir(\mathop{t}\limits^{\rightarrow}|\mathop{\alpha}\limits^{\rightarrow})$ï¼Œé‚£ä¹ˆæœ‰$E(\mathop{p}\limits^{\rightarrow})=(\dfrac{\alpha_1}{\sum^K_{i=1}\alpha_i},\dfrac{\alpha_2}{\sum^K_{i=1}\alpha_i},â€¦,\dfrac{\alpha_3}{\sum^K_{i=1}\alpha_i})$</p><h1 id="3-Dirichletåˆ†å¸ƒ"><a href="#3-Dirichletåˆ†å¸ƒ" class="headerlink" title="3.Dirichletåˆ†å¸ƒ"></a>3.Dirichletåˆ†å¸ƒ</h1><p>æ˜¯betaåˆ†å¸ƒåœ¨é«˜çº¬åº¦ä¸Šçš„æ¨å¹¿</p><p>$f(x_1,x_2,â€¦,x_k;\alpha_1,\alpha_1,â€¦,\alpha_k)=\dfrac{1}{B(\alpha)}\prod_{i=1}^kx_{i}^{a^i-1}$</p><p>å…¶ä¸­$B(\alpha)=\dfrac{\prod_{i=1}^k\Gamma(a^i)}{\Gamma(\sum_{i=1}^k)a^i},\sum x_i=1$</p><h2 id="3-1Dirichletåˆ†å¸ƒ"><a href="#3-1Dirichletåˆ†å¸ƒ" class="headerlink" title="3.1Dirichletåˆ†å¸ƒ"></a>3.1Dirichletåˆ†å¸ƒ</h2><p>This content is only supported in a Feishu Docs</p><h2 id="3-2Dirichlet-Multinomialå…±è½­"><a href="#3-2Dirichlet-Multinomialå…±è½­" class="headerlink" title="3.2Dirichlet-Multinomialå…±è½­"></a>3.2Dirichlet-Multinomialå…±è½­</h2><ul><li>é—®é¢˜å¼•å…¥ï¼šåœ¨2.2çš„é—®é¢˜2çš„åŸºç¡€ä¸Šç»§ç»­æ·±å…¥<ul><li><strong>é—®é¢˜3</strong>ï¼šéšæœºå˜é‡$X_1,X_2,â€¦,X_n\sim^{idd}Uniform(0,1)$ï¼ŒæŠŠè¿™nä¸ªéšæœºå˜é‡æ’åºåå¾—åˆ°é¡ºåºç»Ÿè®¡é‡$X_{(1)},X_{(2)},â€¦,X_{(n)}$ï¼Œé—®$(X_{(k_1)},X_{k_1+k_2})$çš„è”åˆåˆ†å¸ƒæ˜¯ä»€ä¹ˆ<ul><li>è®¡ç®—è§pdf</li></ul></li><li>ä¸ºè®ºè¯Dirichletåˆ†å¸ƒæ˜¯å¤šé¡¹å¼åˆ†å¸ƒçš„å…±è½­å…ˆéªŒæ¦‚ç‡åˆ†å¸ƒï¼Œåœ¨é—®é¢˜3çš„åŸºç¡€ä¸Šç»§ç»­æ·±å…¥<ul><li>é—®é¢˜4ï¼š<ul><li>éšæœºå˜é‡$X_1,X_2,â€¦,X_n\sim^{idd}Uniform(0,1)$ï¼ŒæŠŠè¿™nä¸ªéšæœºå˜é‡æ’åºåå¾—åˆ°é¡ºåºç»Ÿè®¡é‡$X_{(1)},X_{(2)},â€¦,X_{(n)}$</li><li>ä»¤$p_1=X_{k_1},p_2=X(k_1+k_2),p_3=1-p_1-p_2$ï¼Œç°åœ¨è¦çŒœæµ‹$\mathop{p}\limits^{\rightarrow}=(p_1,p_2,p_3)$</li><li>$Y_1,Y_2,â€¦,Y_m\sim^{idd}Uniform(0,1)$ï¼Œ$Y_i$ä¸­è½åˆ°$(0,p_1],[p_1,p_2),[p_2,1]$ä¸‰ä¸ªåŒºé—´çš„ä¸ªæ•°åˆ†åˆ«ä¸º$m_1,m_2,m_3$ï¼Œ$m=m_1+m_2+m_3$</li><li>é—®åéªŒåˆ†å¸ƒ$P(\mathop{p}\limits^{\rightarrow}|Y_1,Y_2,â€¦Y_m)$çš„åˆ†å¸ƒæ˜¯ä»€ä¹ˆ</li><li>è®¨è®ºè§pdf</li></ul></li></ul></li></ul></li><li>ä¸è´å¶æ–¯ç»“åˆæ¨ç†ï¼š<ul><li>è¦çŒœæµ‹å‚æ•°$\mathop{p}\limits^{\rightarrow}=(p_1,p_2,p_3)$ï¼Œå…¶å…ˆéªŒåˆ†å¸ƒä¸º$Dir(\mathop{p}\limits^{\rightarrow}|\mathop{k}\limits^{\rightarrow})$</li><li>$Y_1,Y_2,â€¦,Y_m\sim^{idd}Uniform(0,1)$ï¼Œ$Y_i$ä¸­è½åˆ°$(0,p_1],[p_1,p_2),[p_2,1]$ä¸‰ä¸ªåŒºé—´çš„ä¸ªæ•°åˆ†åˆ«ä¸º$m_1,m_2,m_3$ï¼Œæ‰€ä»¥$\mathop{m}\limits^{\rightarrow}=(m_1,m_2,m_3)$æœä»å¤šé¡¹åˆ†å¸ƒ$Mult(\mathop{m}\limits^{\rightarrow}|\mathop{p}\limits^{\rightarrow})$</li><li>ç»™å®šäº†æ¥è‡ªæ•°æ®æä¾›çš„$\mathop{m}\limits^{\rightarrow}$åï¼Œ$\mathop{p}\limits^{\rightarrow}$çš„åéªŒåˆ†å¸ƒå˜ä¸º$Dir(\mathop{p}\limits^{\rightarrow}|\mathop{k}\limits^{\rightarrow}+\mathop{m}\limits^{\rightarrow})$</li><li>ç›´è§‚è¡¨è¿°ï¼š<ol><li>$Dir(\mathop{p}\limits^{\rightarrow}|\mathop{k}\limits^{\rightarrow})+MultCount(\mathop{m}\limits^{\rightarrow})=Dir(\mathop{p}\limits^{\rightarrow}|\mathop{k}\limits^{\rightarrow}+\mathop{m}\limits^{\rightarrow})$</li><li>ä»¤$\mathop{\alpha}\limits^{\rightarrow}=\mathop{k}\limits^{\rightarrow}ï¼Œå¯ä»¥æŠŠ$\mathop{\alpha}\limits^{\rightarrow}$ä»æ•´æ•°é›†åˆå»¶æ‹“åˆ°å®æ•°é›†åˆï¼Œä»è€Œå¾—åˆ°æ›´ä¸€èˆ¬çš„è¡¨è¾¾ï¼š</li><li>$Dir(\mathop{p}\limits^{\rightarrow}|\mathop{\alpha}\limits^{\rightarrow})+MultCount(\mathop{m}\limits^{\rightarrow})=Dir(\mathop{p}\limits^{\rightarrow}|\mathop{\alpha}\limits^{\rightarrow}+\mathop{m}\limits^{\rightarrow})$</li></ol></li></ul></li><li>ç»“è®ºï¼š<ul><li>è§‚æµ‹åˆ°çš„æ•°æ®ç¬¦åˆå¤šé¡¹åˆ†å¸ƒ</li><li>å‚æ•°çš„å…ˆéªŒåˆ†å¸ƒå’ŒåéªŒåˆ†å¸ƒéƒ½æ˜¯Dirichletåˆ†å¸ƒ</li><li>å°±æ˜¯Dirichlet-Multinomialå…±è½­</li><li>ä¸€èˆ¬å½¢å¼çš„Dirichletåˆ†å¸ƒå®šä¹‰å’Œå¯¹äºç»™å®šçš„$\mathop{p}\limits^{\rightarrow}$å’Œ$N$ï¼Œå…¶å¤šé¡¹å¼åˆ†å¸ƒè§pdf</li><li>Dirichletåˆ†å¸ƒ$Dir(\mathop{p}\limits^{\rightarrow}|\mathop{\alpha}\limits^{\rightarrow})$å’Œå¤šé¡¹åˆ†å¸ƒ$MultCount(\mathop{n}\limits^{\rightarrow}|\mathop{p}\limits^{\rightarrow},N)$æ˜¯å…±è½­å…³ç³»</li></ul></li></ul><h1 id="4-LDAæ¨¡å‹"><a href="#4-LDAæ¨¡å‹" class="headerlink" title="4.LDAæ¨¡å‹"></a>4.LDAæ¨¡å‹</h1><p><strong>å®šä¹‰çš„å˜é‡</strong></p><ul><li>$w$è¡¨ç¤ºè¯ï¼Œ$V$è¡¨ç¤ºæ‰€æœ‰å•è¯çš„ä¸ªæ•°ï¼ˆå›ºå®šå€¼ï¼‰</li><li>$z$è¡¨ç¤ºä¸»é¢˜ï¼Œæ˜¯ä¸»é¢˜çš„ä¸ªæ•°ï¼ˆé¢„å…ˆç»™å®šï¼Œå›ºå®šå€¼ï¼‰</li><li>$D(w_1,â€¦,w_M)$è¡¨ç¤ºè¯­æ–™åº“ï¼Œå…¶ä¸­çš„$M$æ˜¯è¯­æ–™åº“ä¸­çš„æ–‡æ¡£æ•°ï¼ˆå›ºå®šå€¼ï¼‰</li><li>$\mathbf{w}=(w_1,w_2,â€¦,w_N)$è¡¨ç¤ºæ–‡æ¡£ï¼Œå…¶ä¸­çš„$N$è¡¨ç¤ºä¸€ä¸ªæ–‡æ¡£ä¸­çš„è¯æ•°ï¼ˆéšæœºå˜é‡ï¼‰</li></ul><h2 id="4-1å„ä¸ªæ¨¡å‹åŸºç¡€"><a href="#4-1å„ä¸ªæ¨¡å‹åŸºç¡€" class="headerlink" title="4.1å„ä¸ªæ¨¡å‹åŸºç¡€"></a>4.1å„ä¸ªæ¨¡å‹åŸºç¡€</h2><h3 id="4-1-1Unigram-model"><a href="#4-1-1Unigram-model" class="headerlink" title="4.1.1Unigram model"></a>4.1.1Unigram model</h3><p>å¯¹äºæ–‡æ¡£$\mathbf{w}=(w_1,w_2,â€¦,w_N)$ï¼Œç”¨$p(w_n)$è¡¨ç¤ºè¯$w_n$çš„å…ˆéªŒæ¦‚ç‡ï¼Œç”Ÿæˆæ–‡æ¡£$\mathbf{w}$çš„æ¦‚ç‡ä¸ºï¼š$p(\mathbf{w})=\sum^N_{n=1}p(w_n)$</p><p>å›¾æ¨¡å‹ä¸º</p><ul><li><p>å›¾æ¨¡å‹ä¸€</p><ul><li>(å›¾ä¸­è¢«æ¶‚è‰²çš„w(word)è¡¨ç¤ºå¯è§‚æµ‹å˜é‡ï¼ŒNè¡¨ç¤ºä¸€ç¯‡æ–‡æ¡£ä¸­æ€»å…±Nä¸ªå•è¯ï¼ŒMè¡¨ç¤ºMç¯‡æ–‡æ¡£)</li><li><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LDA/1702177856933.jpg"></li></ul></li><li><p>å›¾æ¨¡å‹äºŒ</p><ul><li><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LDA/1702177862768.jpg"></li><li>nigram modelå‡è®¾æ–‡æœ¬ä¸­çš„è¯æœä»Multinomialåˆ†å¸ƒï¼Œè€Œæˆ‘ä»¬å·²ç»çŸ¥é“Multinomialåˆ†å¸ƒçš„å…ˆéªŒåˆ†å¸ƒä¸ºDirichletåˆ†å¸ƒã€‚ä¸Šå›¾ä¸­çš„$w_n$è¡¨ç¤ºåœ¨æ–‡æœ¬ä¸­è§‚å¯Ÿåˆ°çš„ç¬¬nä¸ªè¯ï¼Œ$n\in[1,N]$è¡¨ç¤ºè¯¥æ–‡æœ¬ä¸­ä¸€å…±æœ‰$N$ä¸ªå•è¯ã€‚åŠ ä¸Šæ–¹æ¡†è¡¨ç¤ºé‡å¤ï¼Œå³ä¸€å…±æœ‰$N$ä¸ªè¿™æ ·çš„éšæœºå˜é‡$w_n$ã€‚å…¶ä¸­ï¼Œ$p$å’Œ$\alpha$æ˜¯éšå«æœªçŸ¥å˜é‡ï¼š</li><li>$p$æ˜¯è¯æœä»çš„Multinomialåˆ†å¸ƒçš„å‚æ•°</li><li>$\alpha$æ˜¯Dirichletåˆ†å¸ƒ(å³Multinomialåˆ†å¸ƒçš„å…ˆéªŒåˆ†å¸ƒ)çš„å‚æ•°</li><li>ä¸€èˆ¬$\alpha$ç”±ç»éªŒäº‹å…ˆç»™å®š(å…ˆéªŒ)ï¼Œ$p$ç”±è§‚å¯Ÿåˆ°çš„æ–‡æœ¬ä¸­å‡ºç°çš„è¯å­¦ä¹ å¾—åˆ°(æ ·æœ¬)ï¼Œè¡¨ç¤ºæ–‡æœ¬ä¸­å‡ºç°æ¯ä¸ªè¯çš„æ¦‚ç‡</li></ul></li></ul><h3 id="4-1-2Mixture-of-unigrams-model"><a href="#4-1-2Mixture-of-unigrams-model" class="headerlink" title="4.1.2Mixture of unigrams model"></a>4.1.2Mixture of unigrams model</h3><p>è¯¥æ¨¡å‹çš„ç”Ÿæˆè¿‡ç¨‹æ˜¯ï¼šç»™æŸä¸ªæ–‡æ¡£å…ˆé€‰æ‹©ä¸€ä¸ªä¸»é¢˜$z$ï¼Œå†æ ¹æ®è¯¥ä¸»é¢˜ç”Ÿæˆæ–‡æ¡£ï¼Œè¯¥æ–‡æ¡£ä¸­çš„æ‰€æœ‰è¯éƒ½æ¥è‡ªä¸€ä¸ªä¸»é¢˜ã€‚å‡è®¾ä¸»é¢˜æœ‰$z_1,â€¦z_k$ï¼Œç”Ÿæˆæ–‡æ¡£$\mathbf{w}$çš„æ¦‚ç‡ä¸ºï¼š</p><p>$p(\mathbf{w})=p(z_1)\prod^N_{n=1}p(w_n|z_1)+â€¦+p(z_k)\prod^N_{n=1}p(w_n|z_k)=\sum_zp(z)\prod^N_{n=1}p(w_n|z)$</p><p>å›¾æ¨¡å‹ä¸ºï¼š(å›¾ä¸­è¢«æ¶‚è‰²çš„wè¡¨ç¤ºå¯è§‚æµ‹å˜é‡ï¼Œæœªè¢«æ¶‚è‰²çš„zè¡¨ç¤ºæœªçŸ¥çš„éšå˜é‡ï¼ŒNè¡¨ç¤ºä¸€ç¯‡æ–‡æ¡£ä¸­æ€»å…±Nä¸ªå•è¯ï¼ŒMè¡¨ç¤ºMç¯‡æ–‡æ¡£)</p><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LDA/1702177867686(1).jpg"></p><h2 id="4-2PLSAæ¨¡å‹"><a href="#4-2PLSAæ¨¡å‹" class="headerlink" title="4.2PLSAæ¨¡å‹"></a>4.2PLSAæ¨¡å‹</h2><p>å»ºè®®ç›´æ¥<a href="https://blog.csdn.net/v_JULY_v/article/details/41209515?spm=1001.2101.3001.6650.1&amp;utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-1.no_search_link&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-1.no_search_link&amp;utm_relevant_index=2">çœ‹è¿™ä¸ª</a></p><h3 id="4-2-1pLSAæ¨¡å‹ä¸‹ç”Ÿæˆæ–‡æ¡£"><a href="#4-2-1pLSAæ¨¡å‹ä¸‹ç”Ÿæˆæ–‡æ¡£" class="headerlink" title="4.2.1pLSAæ¨¡å‹ä¸‹ç”Ÿæˆæ–‡æ¡£"></a>4.2.1pLSAæ¨¡å‹ä¸‹ç”Ÿæˆæ–‡æ¡£</h3><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LDA/1702177872673.jpg"></p><h3 id="4-2-2æ ¹æ®æ–‡æ¡£åæ¨å…¶ä¸»é¢˜åˆ†å¸ƒ"><a href="#4-2-2æ ¹æ®æ–‡æ¡£åæ¨å…¶ä¸»é¢˜åˆ†å¸ƒ" class="headerlink" title="4.2.2æ ¹æ®æ–‡æ¡£åæ¨å…¶ä¸»é¢˜åˆ†å¸ƒ"></a>4.2.2æ ¹æ®æ–‡æ¡£åæ¨å…¶ä¸»é¢˜åˆ†å¸ƒ</h3><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LDA/1702177893244.jpg"></p><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LDA/1702177906171.jpg"></p><h3 id="4-2-3EMç®—æ³•"><a href="#4-2-3EMç®—æ³•" class="headerlink" title="4.2.3EMç®—æ³•"></a>4.2.3EMç®—æ³•</h3><p>This content is only supported in a Feishu Docs</p><h4 id="4-2-3-1EMç®—æ³•çš„ç®€å•ä»‹ç»"><a href="#4-2-3-1EMç®—æ³•çš„ç®€å•ä»‹ç»" class="headerlink" title="4.2.3.1EMç®—æ³•çš„ç®€å•ä»‹ç»"></a>4.2.3.1EMç®—æ³•çš„ç®€å•ä»‹ç»</h4><p><a href="https://zhuanlan.zhihu.com/p/78311644">EMç®—æ³•</a></p><p>éšå˜é‡$Z=(z_1,z_2,z_3,z_4,z_5)$ä»£è¡¨æ¯ä¸€è½®æ‰€ä½¿ç”¨çš„ç¡¬å¸</p><p>æ‰€ä»¥ç¬¬ä¸€æ­¥å…ˆä¼°ç®—$Z$ï¼Œè¿™æ­¥åŒæ—¶æ˜¯E-step</p><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LDA/1702177911648.jpg"></p><p>ğŸ‘†æµç¨‹ï¼š</p><ol><li>éšæœºåˆå§‹åŒ–$\theta_A=0.6$å’Œ$\theta_B=0.5$(E-step)</li><li>Hä»£è¡¨æ­£é¢ï¼ŒTä»£è¡¨åé¢ï¼›å¯¹äºç¬¬ä¸€è½®æ¥è¯´ï¼Œå®é™…çš„æƒ…å†µæ˜¯5ä¸ªæ­£çš„5ä¸ªåçš„ï¼Œè¿›è¡Œå¦‚ä¸‹è®¡ç®—<ol><li>$P_A=\dfrac{0.6^5<em>0.4^5}{(0.6^5</em>0.4^5)+(0.5^5+0.5^5)}=0.45$</li><li>$P_B=\dfrac{(0.5^5+0.5^5)}{(0.6^5*0.4^5)+(0.5^5+0.5^5)}=0.55$<ul><li>â€‹    å¯¹äºç¬¬ä¸€è½®æŠ›æ·ï¼Œè¯¥æšç¡¬å¸æ˜¯ç¡¬å¸Açš„æ¦‚ç‡ä¸º0.45ï¼Œæ˜¯ç¡¬å¸Bçš„æ¦‚ç‡ä¸º0.55ï¼Œå…¶ä»–è½®åŒç†ï¼Œè¿™ä¸€æ­¥å¾—åˆ°äº†Zçš„æ¦‚ç‡åˆ†å¸ƒ</li><li><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LDA/1702177916936.jpg"></li></ul></li></ol></li><li>åˆ©ç”¨æœŸæœ›æ±‚ç¡¬å¸Aå’Œç¡¬å¸Bçš„è´¡çŒ®ï¼Œå¯¹äºç¬¬ä¸€è½®æ¥è¯´<ol><li>Hï¼š0.45*5=2.25</li><li>Tï¼š0.55*5=2.75</li><li>å…¶ä»–è½®åŒç†</li><li><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LDA/1702177922766.jpg"></li><li>ç”¨æå¤§ä¼¼ç„¶ä¼°è®¡æ¥ä¼°è®¡æ–°çš„$\theta_A$å’Œ$\theta_B$ï¼Œè¿™æ­¥å°±æ˜¯M-Step<ul><li>$\theta_A=\dfrac{21.3}{21.3+8.6}=0.71$</li><li>$\theta_B=\dfrac{11.7}{11.7+8.4}=0.58$</li></ul></li></ol></li><li>å¦‚æ­¤åå¤è¿­ä»£ï¼Œå¯ä»¥ç®—å‡ºæœ€ç»ˆçš„å‚æ•°å€¼</li><li>$L(\theta)$ä¸$J(z,Q)$çš„å…³ç³»<ol><li>è¿™å¼ å›¾çš„æ„æ€æ˜¯</li><li>å…ˆå›ºå®š$\theta$ï¼Œè°ƒæ•´$Q(z)$ä½¿ä¸‹ç•Œ$J(z,Q)$ä¸Šå‡è‡³ä¸$L(\theta)$åœ¨è¯¥$\theta$å€¼ä¸‹ç›¸åŒ(ç”±ç»¿çº¿åˆ°è“çº¿)</li><li>ç„¶åå›ºå®š$Q(z)$ï¼Œè°ƒæ•´$\theta$ä½¿ä¸‹ç•Œ$J(z,Q)$è¾¾åˆ°æœ€å¤§å€¼</li><li>å†å›ºå®š$\theta$â€¦</li><li>ç›´åˆ°æ”¶æ•›åˆ°ä¼¼ç„¶å‡½æ•°$L(\theta)$çš„æœ€å¤§å€¼æ—¶ï¼Œå¾—åˆ°è¯¥å¤„çš„$\theta^{*}$</li><li><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LDA/1702177927472.jpg"></li></ol></li><li>EMç®—æ³•çš„æ•´ä½“æ¡†æ¶</li></ol><p>Repeat until convergence{</p><p>  (E-step) For each </p><p>$i$</p><p>,set</p><p>â€‹    $Q_i(z):=p(z^{(i)}|x^{(i)};\theta)$                                   æ‰¾éšå˜é‡çš„åˆ†å¸ƒ(ç›´çº¿å¾€ä¸Šç§»)</p><p>â€‹     (M-step) Set</p><p>â€‹    $\theta:=arg max_{\theta}\sum_i\sum_{z^{(i)}}log\dfrac{p(x^{(i)},z^{(i)};\theta)}{Q_i(z^{(i)})}$   æ‰¾æ–°çš„$\theta$(ç‚¹ä½å¾€å·¦å³ç§»)</p><p>}</p><h4 id="4-2-3-2EMç®—æ³•ä¼°è®¡pLSAçš„ä¸¤ä¸ªæœªçŸ¥å‚æ•°"><a href="#4-2-3-2EMç®—æ³•ä¼°è®¡pLSAçš„ä¸¤ä¸ªæœªçŸ¥å‚æ•°" class="headerlink" title="4.2.3.2EMç®—æ³•ä¼°è®¡pLSAçš„ä¸¤ä¸ªæœªçŸ¥å‚æ•°"></a>4.2.3.2EMç®—æ³•ä¼°è®¡pLSAçš„ä¸¤ä¸ªæœªçŸ¥å‚æ•°</h4><p>ä»<strong>çŸ©é˜µè§’åº¦</strong>æè¿°å¸¦ä¼°è®¡çš„ä¸¤ä¸ªæœªçŸ¥å˜é‡$P(w_j|z_k)$å’Œ$P(z_k|d_i)$</p><p>è¯è¡¨$V$æœ‰$j$ä¸ªè¯é¡¹ï¼›æ‰€æœ‰ä¸»é¢˜$Z$æœ‰$k$ä¸ªä¸»é¢˜ï¼›æœ‰$i$ç¯‡æ–‡ç« </p><ul><li>å‡å®šç”¨$\phi_k$è¡¨ç¤ºè¯è¡¨$V$åœ¨ä¸»é¢˜$z_k$ä¸Šçš„ä¸€ä¸ªå¤šé¡¹åˆ†å¸ƒï¼Œåˆ™$\phi_k$å¯ä»¥è¡¨ç¤ºæˆä¸€ä¸ªå‘é‡ï¼Œæ¯ä¸ªå…ƒç´ $\phi_{k,j}$è¡¨ç¤ºè¯é¡¹$w_j$å‡ºç°åœ¨ä¸»é¢˜$z_k$ä¸­çš„æ¦‚ç‡ï¼Œå³ï¼š<ul><li>$P(w_j|z_k)=\phi_{k,j}$ï¼Œ$\sum_{w_j\in V}\phi_{k,j}=1$</li></ul></li><li>å‡å®šç”¨$\theta_i$è¡¨ç¤ºæ‰€æœ‰ä¸»é¢˜$K$åœ¨æ–‡æ¡£$d_i$ä¸Šçš„ä¸€ä¸ªå¤šé¡¹åˆ†å¸ƒï¼Œåˆ™$\theta_i$å¯ä»¥è¡¨ç¤ºæˆä¸€ä¸ªå‘é‡ï¼Œæ¯ä¸ªå…ƒç´ $\theta_{i,k}$è¡¨ç¤ºä¸»é¢˜$z_k$å‡ºç°åœ¨æ–‡æ¡£$d_i$ä¸­çš„æ¦‚ç‡ï¼Œå³ï¼š<ul><li>$P(z_k|d_i)=\theta_{i,k}$ï¼Œ$\sum_{z_k\in K}\theta_{i,k}=1$</li></ul></li></ul><p>$P(w_j|z_k)$å’Œ$P(z_k|d_i)$è½¬æ¢æˆäº†ä¸¤ä¸ªçŸ©é˜µï¼Œæ¢è¨€ä¹‹ï¼Œæˆ‘ä»¬è¦æ±‚è§£çš„å‚æ•°å°±æ˜¯è¿™ä¸¤ä¸ªçŸ©é˜µï¼š</p><ul><li>$\Phi=[\phi_1,â€¦\phi_K], z_k\in Z$</li><li>$\Theta=[\theta_i,â€¦,\theta_M],d_i\in D$</li></ul><p>è¯å’Œè¯ä¹‹é—´æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œæ•´ç¯‡æ–‡æ¡£$N$ä¸ªè¯çš„åˆ†å¸ƒä¸ºï¼š</p><ul><li>$P(W|d_i)=\prod_{j=1}^NP(d_i,w_j)^{n(d_i,w_j)}$</li></ul><p>æ–‡æ¡£å’Œæ–‡æ¡£ä¹‹é—´ä¹Ÿæ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œæ•´ä¸ªè¯­æ–™åº“($M$ç¯‡æ–‡æ¡£,æ¯ç¯‡æ–‡æ¡£$N$ä¸ªè¯)ä¸­è¯çš„åˆ†å¸ƒä¸º</p><ul><li>$P(W|D)=\prod_{i=1}^M\prod_{j=1}^NP(d_i,w_j)^{n(d_i,w_j)}$</li></ul><p>å…¶ä¸­ï¼Œ</p><p>$n(d_i,w_j)$è¡¨ç¤ºè¯é¡¹$w_j$åœ¨æ–‡æ¡£$d_i$ä¸­çš„è¯é¢‘</p><p>$n(d_i)$è¡¨ç¤ºæ–‡æ¡£$d_i$ä¸­æ–‡æ¡£è¯çš„æ€»æ•°</p><p>æ˜¾ç„¶æœ‰$n(d_i)=\sum_{w_j\in V}n(d_i,w_j)$ï¼Œä¸€ç¯‡æ–‡æ¡£ä¸­è¯çš„æ€»æ•°ç­‰äºè¯è¡¨ä¸­æ¯ä¸ªè¯å‡ºç°çš„æ¬¡æ•°ä¹‹å’Œ</p><p>æ•´ä¸ªè¯­æ–™åº“çš„è¯åˆ†å¸ƒçš„å¯¹æ•°ä¼¼ç„¶å‡½æ•°ï¼š</p><p>$\begin{align} l(\Phi,\Theta)&amp;=\sum_{i=1}^{M}\sum_{j=1}^Nn(d_i,w_j)logP(d_i,w_j)\ &amp;=\sum_{i=1}^Mn(d_i)\left(logP(d_i)+\sum_{j=1}^N\dfrac{n(d_i,w_j)}{n(d_i)}log\sum_{k=1}^KP(w_j|z_k)P(z_k|d_i)\right)\ &amp;=\sum_{i=1}^Mn(d_i)\left(logP(d_i)+\sum_{j=1}^N\dfrac{n(d_i,w_j)}{n(d_i)}log\sum_{k=1}^K\phi_{k,j}\theta_{i,k}\right) \end{align}$</p><ul><li>(1)å¯¹åº”çš„æ˜¯$L(\theta)\geq\sum_{i=1}^n\sum_z^ZQ_i(z)log\dfrac{P(x_i,z;\theta)}{Q_i(z)}$ï¼Œå…¶ä¸­$Q_i(z)$è¡¨ç¤ºçš„æ˜¯æ ·æœ¬$i$éšå«å˜é‡$z$çš„æŸç§åˆ†å¸ƒï¼›$log\dfrac{P(x_i,z;\theta)}{Q_i(z)}$è¡¨ç¤ºçš„æ˜¯å¯¹æ•°ä¼¼ç„¶å‡½æ•°</li><li>(2)åˆ†åˆ«æ±‚æ–‡æœ¬çš„å¯¹æ•°ä¼¼ç„¶å‡½æ•°å’Œè¯çš„å¯¹æ•°ä¼¼ç„¶å‡½æ•°ï¼Œè§pdf</li><li>(3)å°±æ˜¯ä¸Šé¢å¾—åˆ°çš„ä»¥çŸ©é˜µçš„å½¢å¼è¡¨è¾¾å¤šé¡¹å¼åˆ†å¸ƒ</li></ul><p>å¤šå…ƒå‡½æ•°åœ¨æœ‰çº¦æŸæ¡ä»¶$\sum_{j=1}^{M}\theta_{k,j}=1$å’Œ$\sum_{k=1}^K\phi_{i,k}=1$ä¸‹æ±‚æå€¼ï¼Œç”¨æ‹‰æ ¼æœ—æ—¥ä¹˜æ•°æ³•(å³é€šè¿‡å¼•å…¥æ‹‰æ ¼æœ—æ—¥ä¹˜å­å°†çº¦æŸæ¡ä»¶å’Œå¤šå…ƒ(ç›®æ ‡)å‡½æ•°èåˆåˆ°ä¸€èµ·ï¼Œè½¬åŒ–ä¸ºæ— çº¦æŸæ¡ä»¶çš„æå€¼é—®é¢˜)è§pdf</p><p>æ€»ç»“ï¼š</p><ol><li>ä¸ºæ±‚å¾—$P(w_j|z_k)$å’Œ$P(z_k|d_i)$ï¼Œå› æ­¤ç”¨EMç®—æ³•å»ä¼°è®¡$\theta=(P(w_j|z_k),z_k|d_i)$è¿™ä¸ªå‚æ•°</li><li>$\phi_{k,j}$è¡¨ç¤ºè¯é¡¹$w_j$å‡ºç°åœ¨ä¸»é¢˜$z_k$ä¸­çš„é¢‘ç‡ï¼Œå³$P(w_j|z_k)=\phi_{k,j}$ï¼Œä»è€ŒæŠŠ$P(w_j|z_k)$è½¬æ¢æˆçŸ©é˜µ$\Phi$</li><li>$\theta_{i,k}$è¡¨ç¤ºä¸»é¢˜$z_k$å‡ºç°åœ¨æ–‡æ¡£$d_i$ä¸­çš„é¢‘ç‡ï¼Œå³$P(z_k|d_i)=\theta_{k,i}$ï¼Œä»è€ŒæŠŠ$P(z_k|d_i)$è½¬æ¢æˆçŸ©é˜µ$\Theta$</li><li>æœ€åé€šè¿‡EMç®—æ³•æ±‚å‡ºä¸¤ä¸ªçŸ©é˜µ</li></ol><h5 id="4-2-3-2-1æ‹‰æ ¼æœ—æ—¥ä¹˜æ•°æ³•"><a href="#4-2-3-2-1æ‹‰æ ¼æœ—æ—¥ä¹˜æ•°æ³•" class="headerlink" title="4.2.3.2.1æ‹‰æ ¼æœ—æ—¥ä¹˜æ•°æ³•"></a>4.2.3.2.1æ‹‰æ ¼æœ—æ—¥ä¹˜æ•°æ³•</h5><ol><li>æ²¡æœ‰çº¦æŸæ¡ä»¶</li></ol><p>ç›®æ ‡å‡½æ•°$f(x,y)$æ˜¯ä¸€åº§å±±çš„é«˜åº¦ï¼Œçº¦æŸ$g(x,y)$æ˜¯é•¶åµŒåœ¨å±±ä¸Šçš„ä¸€æ¡æ›²çº¿ï¼Œå¦‚ä¸‹å›¾</p><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LDA/1702177933575.jpg"></p><p>çº¢çº¿æ˜¯çº¦æŸæ›²çº¿</p><p>ç›®çš„ï¼šæ‰¾çº¢çº¿ä¸Šçš„æœ€ä½ç‚¹</p><p>æ­¥éª¤ï¼š</p><ul><li>ä»ç¬¬0æ¡çº¿å¼€å§‹å¾€ä¸Šæ•°ï¼Œæ•°åˆ°ç¬¬ä¸‰æ¡ï¼Œä¸çº¦æŸæ›²çº¿æœ‰äº¤ç‚¹ï¼Œæ¯”ç¬¬ä¸‰æ¡ä½çš„åœ°æ–¹éƒ½ä¸åœ¨çº¦æŸèŒƒå›´å†…ï¼Œæ‰€ä»¥è¿™æ˜¯çº¦æŸæ›²çº¿çš„æœ€ä½ç‚¹</li><li>çº¦æŸæ›²çº¿ä¸ä¼šå’Œç­‰é«˜çº¿ç›¸äº¤ï¼Œä¸€å®šæ˜¯ç›¸åˆ‡ï¼Œå¦‚æœæ˜¯ç›¸äº¤çš„è¯ï¼Œçº¦æŸæ›²çº¿æœ‰ä¸€éƒ¨åˆ†åœ¨æœ€ä½ç‚¹çš„æ›²çº¿çš„ä¸‹ç«¯(å³ç›®æ ‡æ›²çº¿å¹¶ä¸èƒ½åŒ…æ‹¬çº¦æŸæ›²çº¿çš„æœ€ä½ç‚¹)ï¼Œå¦‚ä¸‹å›¾ä¸­çº¦æŸæ›²çº¿æœ‰ä¸€éƒ¨åˆ†åœ¨BåŒºåŸŸï¼Œä½†æ˜¯BåŒºåŸŸæ¯”ç­‰é«˜çº¿ä½<ul><li><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LDA/1702177938067.jpg"></li></ul></li><li>é‚£ä¹ˆä¸¤æ¡çº¿åªèƒ½ç›¸åˆ‡ï¼Œæ„å‘³ä»–ä»¬çš„æ³•çº¿å¹³è¡Œ&lt;==&gt;æ³•å‘é‡åªå·®ä¸€ä¸ªä»»æ„çš„å¸¸æ•°ä¹˜å­(å–-$\lambda$)ï¼š<ul><li>âˆ‡$f(x,y)=-\lambda$âˆ‡$g(x,y)$</li><li>âˆ‡$f(x,y)+\lambda$âˆ‡$g(x,y)=0$</li></ul></li></ul><ol><li><a href="https://zhuanlan.zhihu.com/p/55532322">æœ‰çº¦æŸæ¡ä»¶</a></li></ol><p>è§pdf</p><h2 id="4-3LDAæ¨¡å‹"><a href="#4-3LDAæ¨¡å‹" class="headerlink" title="4.3LDAæ¨¡å‹"></a>4.3LDAæ¨¡å‹</h2><h3 id="4-3-1pLSAå’ŒLDAçš„å¯¹æ¯”ï¼šç”Ÿæˆæ–‡æ¡£ä¸å‚æ•°ä¼°è®¡"><a href="#4-3-1pLSAå’ŒLDAçš„å¯¹æ¯”ï¼šç”Ÿæˆæ–‡æ¡£ä¸å‚æ•°ä¼°è®¡" class="headerlink" title="4.3.1pLSAå’ŒLDAçš„å¯¹æ¯”ï¼šç”Ÿæˆæ–‡æ¡£ä¸å‚æ•°ä¼°è®¡"></a>4.3.1pLSAå’ŒLDAçš„å¯¹æ¯”ï¼šç”Ÿæˆæ–‡æ¡£ä¸å‚æ•°ä¼°è®¡</h3><p>ğŸ‘‡é¢‘ç‡æ´¾vsè´å¶æ–¯æ´¾</p><p>This content is only supported in a Feishu Docs</p><p><strong>LDA</strong>æ¨¡å‹ä¸­ä¸€ç¯‡æ–‡æ¡£ç”Ÿæˆçš„æ–¹å¼ï¼š</p><ol><li>æŒ‰ç…§å…ˆéªŒåˆ†å¸ƒ$P(d_i)$é€‰æ‹©ä¸€ç¯‡æ–‡æ¡£$d_i$</li><li>ä»Dirichletåˆ†å¸ƒ$\alpha$ä¸­å–æ ·ç”Ÿæˆæ–‡æ¡£$d_i$çš„ä¸»é¢˜åˆ†å¸ƒ$\theta_i$ï¼Œå³ä¸»é¢˜åˆ†å¸ƒ$\theta_i$ç”±è¶…å‚æ•°ä¸º$\alpha$çš„Dirichletåˆ†å¸ƒç”Ÿæˆâ‘ </li><li>ä»ä¸»é¢˜çš„å¤šé¡¹å¼åˆ†å¸ƒ$\theta_i$ä¸­å–æ ·ç”Ÿæˆæ–‡æ¡£$d_i$ç¬¬$j$ä¸ªè¯çš„ä¸»é¢˜$z_{i,j}$</li><li>ä»Dirichletåˆ†å¸ƒ$\beta$ä¸­å–æ ·ç”Ÿæˆä¸»é¢˜$z_{i,j}$å¯¹åº”çš„è¯è¯­åˆ†å¸ƒ$\phi_{z_i,j}$ï¼Œå³è¯è¯­åˆ†å¸ƒ$\phi_{z_i,j}$ç”±å‚æ•°ä¸º$\beta$çš„Dirichletåˆ†å¸ƒç”Ÿæˆâ‘¡</li><li>ä»è¯è¯­çš„å¤šé¡¹å¼åˆ†$\phi_{z_i,j}$ä¸­é‡‡æ ·æœ€ç»ˆç”Ÿæˆè¯è¯­$w_{i,j}$</li></ol><p>ğŸ‘‡LDAå’ŒpLSAçš„åŒºåˆ«ï¼š</p><ul><li>LDAæ˜¯pLSAçš„è´å¶æ–¯ç‰ˆæœ¬ï¼Œä¸»é¢˜åˆ†å¸ƒå’Œè¯åˆ†å¸ƒæœ¬èº«éƒ½ç”±å…ˆéªŒçŸ¥è¯†éšæœºç»™å®š</li><li>â‘ â‘¡LDAåœ¨pLSAçš„åŸºç¡€ä¸Šä¸ºä¸»é¢˜åˆ†å¸ƒå’Œè¯åˆ†å¸ƒåŠ äº†ä¸¤ä¸ªDirichletå…ˆéªŒåˆ†å¸ƒ$\alpha$å’Œ$\beta$</li><li><strong>pLSA</strong>ä¸­ä¸»é¢˜åˆ†å¸ƒå’Œè¯åˆ†å¸ƒæ˜¯å”¯ä¸€ç¡®å®šçš„ï¼Œä½†æ˜¯<strong>LDA</strong>ä¸­ä¸»é¢˜åˆ†å¸ƒå’Œè¯åˆ†å¸ƒä¸å†å”¯ä¸€ç¡®å®šä¸å˜ï¼Œå³æ— æ³•ç¡®åˆ‡ç»™å‡ºï¼Œä½†æ˜¯å†æ€ä¹ˆå˜åŒ–ä¹Ÿä¾ç„¶æœä»ä¸€å®šçš„åˆ†å¸ƒï¼Œå³ä¸»é¢˜åˆ†å¸ƒå’Œè¯åˆ†å¸ƒç”±Dirichletå…ˆéªŒéšæœºç¡®å®š</li><li>æ–‡æœ¬ç”Ÿæˆåï¼Œä¸¤è€…éƒ½è¦æ ¹æ®æ–‡æ¡£å»æ¨æ–­ä¸»é¢˜åˆ†å¸ƒå’Œè¯åˆ†å¸ƒï¼Œåªæ˜¯ç”¨çš„å‚æ•°æ¨æ–­æ–¹æ³•ä¸åŒ<ul><li>pLSAä¸­ç”¨æå¤§ä¼¼ç„¶ä¼°è®¡çš„æ€æƒ³</li><li>LDAä¸­æŠŠä¸¤ä¸ªå‚æ•°è§†ä¸ºéšæœºå˜é‡ï¼ŒåŠ å…¥Dirichletå…ˆéªŒ</li></ul></li><li>pLSAå±äºé¢‘ç‡æ´¾æ€æƒ³ï¼Œæ ·æœ¬éšæœºï¼Œå‚æ•°($\theta_{k,j}$å’Œ$\phi_{i,j}$)è™½æœªçŸ¥ä½†å›ºå®šï¼›LDAå±äºè´å¶æ–¯æ´¾æ€æƒ³ï¼Œæ ·æœ¬å›ºå®šï¼Œå‚æ•°($\theta_i$å’Œ$\phi_{z_i,j}$)æœªçŸ¥ä½†ä¸å›ºå®šï¼Œæ˜¯ä¸ªéšæœºå˜é‡ï¼Œæœä»ä¸€å®šçš„åˆ†å¸ƒ(Dirichletåˆ†å¸ƒ)<ul><li><strong>pLSAä¸­</strong><ul><li>ä¸»é¢˜åˆ†å¸ƒå’Œè¯åˆ†å¸ƒç¡®å®šåï¼Œä»¥ä¸€å®šæ¦‚ç‡$\left(P(z_k|d_i),P(w_j|z_k)\right)$åˆ†åˆ«é€‰å–å…·ä½“çš„ä¸»é¢˜å’Œè¯é¡¹ï¼Œç”Ÿæˆå¥½æ–‡æ¡£</li><li>ç„¶åæ ¹æ®ç”Ÿæˆå¥½çš„æ–‡æ¡£åæ¨å…¶ä¸»é¢˜åˆ†å¸ƒã€è¯åˆ†å¸ƒ</li><li>æœ€ç»ˆç”¨EMç®—æ³•æ±‚è§£å‡ºä¸¤ä¸ªæœªçŸ¥ä½†å›ºå®šçš„å‚æ•°çš„å€¼ï¼š<ul><li>$\phi_{k,j}$(ç”±$P(w_j|z_k)$è½¬æ¢è€Œæ¥)</li><li>$\theta_{i,k}$(ç”±$P(z_k|d_i)$è½¬æ¢è€Œæ¥)</li><li><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LDA/1702177942549.jpg"></li></ul></li></ul></li><li><strong>LDA****ä¸­</strong><ul><li>ä¸»é¢˜åˆ†å¸ƒå’Œè¯åˆ†å¸ƒæ˜¯éšæœºå˜é‡(å³æ–‡æ¡£$d_i$äº§ç”Ÿä¸»é¢˜$z_k$å’Œä¸»é¢˜$z_k$äº§ç”Ÿè¯é¡¹$w_j$çš„æ¦‚ç‡éƒ½æ˜¯éšæœºå˜é‡)</li><li>Dirichletå…ˆéªŒä¸ºæ–‡æ¡£$d_i$ç”Ÿæˆä¸»é¢˜åˆ†å¸ƒ$\Theta$ï¼Œç„¶åæ ¹æ®ä¸»é¢˜åˆ†å¸ƒ$\Theta$äº§ç”Ÿä¸»é¢˜$z_k$</li><li>ä»æ— ç©·å¤šä¸ªä¸»é¢˜åˆ†å¸ƒä¸­æŒ‰ç…§Dirichletå…ˆéªŒéšæœºæŠ½å–å‡ºæŸä¸ªä¸»é¢˜åˆ†å¸ƒå‡ºæ¥</li><li><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LDA/1702177951260.jpg"></li></ul></li></ul></li><li>ä¾‹å­<ul><li>å¥½æ¯”ï¼Œå»ä¸€æœ‹å‹å®¶ï¼š<ul><li>æŒ‰ç…§<strong>é¢‘ç‡æ´¾</strong>çš„æ€æƒ³ï¼Œæˆ‘ä¼°è®¡ä»–åœ¨å®¶çš„æ¦‚ç‡æ˜¯1/2ï¼Œä¸åœ¨å®¶çš„æ¦‚ç‡ä¹Ÿæ˜¯1/2ï¼Œæ˜¯ä¸ª<strong>å®šå€¼</strong>ã€‚</li><li>è€ŒæŒ‰ç…§è´å¶æ–¯æ´¾çš„æ€æƒ³ï¼Œä»–åœ¨å®¶ä¸åœ¨å®¶çš„æ¦‚ç‡ä¸å†è®¤ä¸ºæ˜¯ä¸ªå®šå€¼1/2ï¼Œè€Œæ˜¯éšæœºå˜é‡ã€‚æ¯”å¦‚æŒ‰ç…§æˆ‘ä»¬çš„ç»éªŒï¼ˆæ¯”å¦‚å½“å¤©å‘¨æœ«ï¼‰ï¼ŒçŒœæµ‹ä»–åœ¨å®¶çš„æ¦‚ç‡æ˜¯0.6ï¼Œä½†è¿™ä¸ª0.6ä¸æ˜¯è¯´å°±æ˜¯å®Œå…¨ç¡®å®šçš„ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯0.7ã€‚å¦‚æ­¤ï¼Œè´å¶æ–¯æ´¾æ²¡æ³•ç¡®åˆ‡ç»™å‡ºå‚æ•°çš„ç¡®å®šå€¼ï¼ˆ0.3,0.4ï¼Œ0.6,0.7ï¼Œ0.8,0.9éƒ½æœ‰å¯èƒ½ï¼‰ï¼Œä½†è‡³å°‘æ˜ç™½åœ¨å“ªä¸ªèŒƒå›´æˆ–å“ªäº›å–å€¼ï¼ˆ0.6,0.7ï¼Œ0.8,0.9ï¼‰æ›´æœ‰å¯èƒ½ï¼Œå“ªä¸ªèŒƒå›´æˆ–å“ªäº›å–å€¼ï¼ˆ0.3,0.4ï¼‰ ä¸å¤ªå¯èƒ½ã€‚è¿›ä¸€æ­¥ï¼Œè´å¶æ–¯ä¼°è®¡ä¸­ï¼Œå‚æ•°çš„å¤šä¸ªä¼°è®¡å€¼æœä»ä¸€å®šçš„å…ˆéªŒåˆ†å¸ƒï¼Œè€Œåæ ¹æ®å®è·µè·å¾—çš„æ•°æ®ï¼ˆä¾‹å¦‚å‘¨æœ«ä¸æ–­è·‘ä»–å®¶ï¼‰ï¼Œä¸æ–­ä¿®æ­£ä¹‹å‰çš„å‚æ•°ä¼°è®¡ï¼Œä»å…ˆéªŒåˆ†å¸ƒæ…¢æ…¢è¿‡æ¸¡åˆ°åéªŒåˆ†å¸ƒã€‚</li></ul></li></ul></li></ul><h3 id="4-3-2LDAç”Ÿæˆæ–‡æ¡£â€“ä¸‰ç»´åæ ‡ç³»"><a href="#4-3-2LDAç”Ÿæˆæ–‡æ¡£â€“ä¸‰ç»´åæ ‡ç³»" class="headerlink" title="4.3.2LDAç”Ÿæˆæ–‡æ¡£â€“ä¸‰ç»´åæ ‡ç³»"></a>4.3.2LDAç”Ÿæˆæ–‡æ¡£â€“ä¸‰ç»´åæ ‡ç³»</h3><p><a href="https://blog.csdn.net/v_JULY_v/article/details/41209515?spm=1001.2101.3001.6650.1&amp;utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-1.no_search_link&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-1.no_search_link&amp;utm_relevant_index=2">çœ‹</a></p><h3 id="4-3-3pLSAå’ŒLDAæ¦‚ç‡å›¾å¯¹æ¯”"><a href="#4-3-3pLSAå’ŒLDAæ¦‚ç‡å›¾å¯¹æ¯”" class="headerlink" title="4.3.3pLSAå’ŒLDAæ¦‚ç‡å›¾å¯¹æ¯”"></a>4.3.3pLSAå’ŒLDAæ¦‚ç‡å›¾å¯¹æ¯”</h3><p>zè·Ÿwéƒ½å¾—æ˜¯å°å†™ï¼Œé˜´å½±åœ†åœˆè¡¨ç¤ºå¯è§‚æµ‹çš„å˜é‡ï¼Œéé˜´å½±åœ†åœˆè¡¨ç¤ºéšå˜é‡æˆ–å‚æ•°ï¼Œç®­å¤´è¡¨ç¤ºä¸¤å˜é‡é—´çš„æ¡ä»¶ä¾èµ–æ€§ï¼Œæ–¹æ¡†è¡¨ç¤ºé‡å¤æŠ½æ ·ï¼Œæ–¹æ¡†å³ä¸‹è§’çš„æ•°å­—ä»£è¡¨é‡å¤æŠ½æ ·çš„æ¬¡æ•°</p><ul><li>pLSA<ul><li><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LDA/1702177955942.jpg"></li></ul></li><li>LDA <ul><li><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LDA/1702177960834(1).jpg"></li><li>å‡å®šè¯­æ–™åº“ä¸­å…±æœ‰Mç¯‡æ–‡ç« ï¼Œæ¯ç¯‡æ–‡ç« ä¸‹çš„Topicçš„ä¸»é¢˜åˆ†å¸ƒæ˜¯ä¸€ä¸ªä»å‚æ•°ä¸º$\alpha$çš„Dirichletå…ˆéªŒåˆ†å¸ƒä¸­é‡‡æ ·å¾—åˆ°çš„Multinomialåˆ†å¸ƒï¼Œæ¯ä¸ªTopicä¸‹çš„è¯åˆ†å¸ƒæ˜¯ä¸€ä¸ªä»å‚æ•°$\beta$ä¸ºçš„Dirichletå…ˆéªŒåˆ†å¸ƒä¸­é‡‡æ ·å¾—åˆ°çš„Multinomialåˆ†å¸ƒã€‚</li><li>å¯¹äºæŸç¯‡æ–‡ç« ä¸­çš„ç¬¬nä¸ªè¯ï¼Œé¦–å…ˆä»è¯¥æ–‡ç« ä¸­å‡ºç°çš„æ¯ä¸ªä¸»é¢˜çš„Multinomialåˆ†å¸ƒä¸­é€‰æ‹©æˆ–é‡‡æ ·ä¸€ä¸ªä¸»é¢˜ï¼Œç„¶åå†åœ¨è¿™ä¸ªä¸»é¢˜å¯¹åº”çš„è¯çš„Multinomialåˆ†å¸ƒä¸­é€‰æ‹©æˆ–é‡‡æ ·ä¸€ä¸ªè¯ã€‚ä¸æ–­é‡å¤è¿™ä¸ªéšæœºç”Ÿæˆè¿‡ç¨‹ï¼Œç›´åˆ°Mç¯‡æ–‡ç« å…¨éƒ¨ç”Ÿæˆå®Œæˆã€‚</li><li>M ç¯‡æ–‡æ¡£ä¼šå¯¹åº”äº M ä¸ªç‹¬ç«‹çš„ Dirichlet-Multinomial å…±è½­ç»“æ„ï¼ŒK ä¸ª topic ä¼šå¯¹åº”äº K ä¸ªç‹¬ç«‹çš„ Dirichlet-Multinomial å…±è½­ç»“æ„<ul><li>$\alpha\rightarrow\theta\rightarrow z$è¡¨ç¤ºç”Ÿæˆæ–‡æ¡£ä¸­çš„æ‰€æœ‰è¯å¯¹åº”çš„ä¸»é¢˜<ul><li>$\alpha\rightarrow\theta$å¯¹åº”çš„æ˜¯Dirichletåˆ†å¸ƒ</li><li>$\theta\rightarrow z$å¯¹åº”çš„æ˜¯Multinomialåˆ†å¸ƒ</li><li>â€‹      å› æ­¤æ•´ä½“æ˜¯ä¸€ä¸ªDirichlet-Multinomialå…±è½­ç»“æ„</li></ul></li><li>$\beta\rightarrow\theta\rightarrow w$è¡¨ç¤ºæŸä¸ªä¸»é¢˜å¯¹åº”çš„è¯<ul><li>åŒä¸Š</li></ul></li></ul></li></ul></li></ul><h3 id="4-3-4pLSAå’ŒLDAå‚æ•°ä¼°è®¡æ–¹æ³•çš„å¯¹æ¯”"><a href="#4-3-4pLSAå’ŒLDAå‚æ•°ä¼°è®¡æ–¹æ³•çš„å¯¹æ¯”" class="headerlink" title="4.3.4pLSAå’ŒLDAå‚æ•°ä¼°è®¡æ–¹æ³•çš„å¯¹æ¯”"></a>4.3.4pLSAå’ŒLDAå‚æ•°ä¼°è®¡æ–¹æ³•çš„å¯¹æ¯”</h3><ul><li>pLSA<ul><li>ä½¿ç”¨EMç®—æ³•ä¼°è®¡$\Phi$å’Œ$\Theta$ï¼Œä½¿ç”¨çš„æ€æƒ³æ˜¯æå¤§ä¼¼ç„¶ä¼°è®¡</li></ul></li><li>LDA<ul><li>ä¼°è®¡$\Phi$å’Œ$\Theta$å¯ç”¨å˜åˆ†(Variational inference)-EMç®—æ³•<strong>ï¼Œ</strong>ä¹Ÿå¯ä»¥ç”¨gibbsé‡‡æ ·<strong>ï¼Œ</strong>å‰è€…çš„æ€æƒ³æ˜¯æœ€å¤§åéªŒä¼°è®¡MAPï¼ˆMAPä¸MLEç±»ä¼¼ï¼Œéƒ½æŠŠæœªçŸ¥å‚æ•°å½“ä½œå›ºå®šçš„å€¼ï¼‰ï¼Œåè€…çš„æ€æƒ³æ˜¯è´å¶æ–¯ä¼°è®¡</li></ul></li></ul><h3 id="4-3-5Gibbsé‡‡æ ·"><a href="#4-3-5Gibbsé‡‡æ ·" class="headerlink" title="4.3.5Gibbsé‡‡æ ·"></a>4.3.5Gibbsé‡‡æ ·</h3><p>GibbsæŠ½æ ·æ˜¯é©¬å°”å¯å¤«é“¾è’™ç‰¹å¡å°”ç†è®ºï¼ˆMCMCï¼‰ä¸­ç”¨æ¥è·å–ä¸€ç³»åˆ—è¿‘ä¼¼ç­‰äºæŒ‡å®šå¤šç»´æ¦‚ç‡åˆ†å¸ƒï¼ˆæ¯”å¦‚2ä¸ªæˆ–è€…å¤šä¸ªéšæœºå˜é‡çš„è”åˆæ¦‚ç‡åˆ†å¸ƒï¼‰è§‚å¯Ÿæ ·æœ¬çš„ç®—æ³•ã€‚</p><h1 id="5-ä»£ç å®ç°"><a href="#5-ä»£ç å®ç°" class="headerlink" title="5.ä»£ç å®ç°"></a>5.ä»£ç å®ç°</h1><p>This content is only supported in a Feishu Docs</p><h2 id="5-1corpora-Dictionary-texts"><a href="#5-1corpora-Dictionary-texts" class="headerlink" title="5.1corpora.Dictionary(texts):"></a>5.1<strong>corpora.Dictionary(texts)</strong>:</h2><p>ä¸ºæ¯ä¸ªå‡ºç°åœ¨è¯­æ–™åº“ä¸­çš„å•è¯åˆ†é…äº†ä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„ç¼–å·id</p><h2 id="5-2dictionary-doc2bow"><a href="#5-2dictionary-doc2bow" class="headerlink" title="5.2dictionary.doc2bow():"></a>5.2<strong>dictionary.doc2bow()</strong>:</h2><p>æŠŠæ–‡æ¡£å˜æˆä¸€ä¸ªç¨€ç–å‘é‡ï¼Œ[(0,1), (1,1)]ï¼Œè¡¨æ˜idä¸º0ï¼Œ1çš„è¯æ±‡å‡ºç°äº†ä¸€æ¬¡ï¼Œè€Œå…¶ä»–è¯æ±‡æ²¡æœ‰å‡ºç°</p><h2 id="5-3models-Ldamodel"><a href="#5-3models-Ldamodel" class="headerlink" title="5.3models.Ldamodel:"></a>5.3<strong>models.Ldamodel</strong>:</h2><p><strong>å‚æ•°ï¼š</strong></p><p>corpusï¼šä¸€ç»„æ–‡æ¡£çš„è¯­æ–™åº“ï¼Œæ˜¯list of list of tupleçš„å½¢å¼ï¼Œæ¯ä¸ªlistå†…çš„å…ƒç´ æ˜¯(word_id, count)ï¼Œè¡¨ç¤ºä¸€ä¸ªæ–‡æ¡£ä¸­æ¯ä¸ªè¯å‡ºç°çš„æ¬¡æ•°</p><p>num_topicsï¼šä¸»é¢˜æ•°é‡</p><p>id2wordï¼šå°†æ¯ä¸ªè¯çš„idæ˜ å°„åˆ°è¯¥è¯çš„å­—ç¬¦ä¸²è¡¨ç¤º</p><p>passesï¼šåœ¨æ‹Ÿåˆæ¨¡å‹ä¸­è¦æ‰§è¡Œçš„è¿­ä»£æ¬¡æ•°</p><p>random_stateï¼šéšæœºæ•°ç”Ÿæˆå™¨çš„ç§å­</p><h2 id="5-4ldamodel-show-topics"><a href="#5-4ldamodel-show-topics" class="headerlink" title="5.4ldamodel.show_topics"></a>5.4ldamodel.show_topics</h2><p>ç”¨äºå±•ç¤ºLDAæ¨¡å‹çš„ä¸»é¢˜å‡½æ•°</p><h3 id="5-4-1x"><a href="#5-4-1x" class="headerlink" title="5.4.1x"></a>5.4.1x</h3><p>æ ¼å¼ï¼š</p><p>[</p><p>(ä¸»é¢˜1ï¼Œ[(å…³é”®è¯1.1ï¼Œæ¦‚ç‡1.1),(å…³é”®è¯1.2ï¼Œæ¦‚ç‡1.2)â€¦])ï¼Œ</p><p>(ä¸»é¢˜2ï¼Œ[(å…³é”®è¯2.1ï¼Œæ¦‚ç‡2.1),(å…³é”®è¯2.2ï¼Œæ¦‚ç‡2.2)â€¦])ï¼Œ</p><p>()ï¼Œ</p><p>â€¦.]</p><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LDA/1702177965964(1).jpg"></p><h3 id="5-4-2tp"><a href="#5-4-2tp" class="headerlink" title="5.4.2tp"></a>5.4.2tp</h3><p>tp[0]â€“&gt;ä¸»é¢˜</p><p>tp[1]â€“&gt;[(å…³é”®è¯1ï¼Œæ¦‚ç‡1),(å…³é”®è¯2ï¼Œæ¦‚ç‡2)â€¦]</p><h3 id="5-4-3æ‰“å°æ¯ä¸ªä¸»é¢˜ä¸‹æ¯ä¸ªå•è¯çš„æ¦‚ç‡"><a href="#5-4-3æ‰“å°æ¯ä¸ªä¸»é¢˜ä¸‹æ¯ä¸ªå•è¯çš„æ¦‚ç‡" class="headerlink" title="5.4.3æ‰“å°æ¯ä¸ªä¸»é¢˜ä¸‹æ¯ä¸ªå•è¯çš„æ¦‚ç‡"></a>5.4.3æ‰“å°æ¯ä¸ªä¸»é¢˜ä¸‹æ¯ä¸ªå•è¯çš„æ¦‚ç‡</h3><p>This content is only supported in a Feishu Docs</p><p>ğŸ‘‡ç”¨.split()å‡½æ•°</p><ul><li>å…ˆæŒ‰ç…§â€+â€å·è¿›è¡Œæ‹†åˆ†</li><li>ç„¶åå¯¹äºä»¥â€+â€å·æ‹†åˆ†å‡ºæ¥çš„ä¸œè¥¿ï¼Œå†ä»¥â€*â€å·è¿›è¡Œæ‹†åˆ†</li><li>æ‰“å°æ ¼å¼ï¼šâ€å•è¯â€(å•è¯å‡ºç°çš„æ¦‚ç‡)</li></ul><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LDA/1702177971365.jpg"></p><h3 id="5-4-4è®¡ç®—ä¸€è‡´æ€§"><a href="#5-4-4è®¡ç®—ä¸€è‡´æ€§" class="headerlink" title="5.4.4è®¡ç®—ä¸€è‡´æ€§"></a>5.4.4è®¡ç®—ä¸€è‡´æ€§</h3><p><strong>CoherenceModel(model, texts, dictionary, coherence)</strong></p><p>modelï¼šæŒ‡å®šç”¨äºè®¡ç®—ä¸€è‡´æ€§çš„ä¸»é¢˜æ¨¡å‹å¯¹è±¡(ldamodel)</p><p>textï¼šæŒ‡å®šä¸€ä¸ªæ–‡æœ¬åˆ—è¡¨</p><p>dictionaryï¼šæŒ‡å®šä¸€ä¸ªè¯å…¸å¯¹è±¡</p><p>coherenceï¼šæŒ‡å®šè¦è®¡ç®—çš„ä¸€è‡´æ€§æŒ‡æ ‡</p><ul><li>C_Vï¼šè¡¡é‡ä¸»é¢˜å†…éƒ¨çš„ä¸€è‡´æ€§å’Œä¸»é¢˜ä¹‹é—´çš„äº’å¼‚æ€§</li></ul><p>è¿”å›çš„æ˜¯ä¸€è‡´æ€§è¯„åˆ†ï¼Œåˆ†æ•°è¶Šé«˜ï¼Œè¡¨ç¤ºä¸»é¢˜æ¨¡å‹çš„ä¸»é¢˜æ›´å…·æœ‰ä¸€è‡´æ€§ï¼Œä¸€è‡´æ€§è¯„åˆ†ä»…ç”¨äºæ¯”è¾ƒä¸åŒä¸»é¢˜æ¨¡å‹ä¹‹é—´çš„ä¸€è‡´æ€§</p><p>This content is only supported in a Feishu Docs</p><p>å‘ç°ï¼Œå½“ä¸»é¢˜æ•°ç›®ä¸º10çš„æ—¶å€™ï¼Œåä¸ªä¸åŒçš„ä¸»é¢˜ä¹‹é—´çš„coherenceå€¼è¾ƒå¤§ï¼Œä¸€è‡´æ€§è¾ƒé«˜ã€‚è¿™å››ä¸ªä¸»é¢˜ä¸‹çš„å…³é”®è¯èƒ½å¤Ÿå¾ˆå¥½åœ°æ¦‚æ‹¬æ‰€æœ‰æ–‡æ¡£çš„å…³é”®è¯</p><h1 id="6-æ²¡æ‡‚çš„åœ°æ–¹"><a href="#6-æ²¡æ‡‚çš„åœ°æ–¹" class="headerlink" title="6.æ²¡æ‡‚çš„åœ°æ–¹"></a>6.æ²¡æ‡‚çš„åœ°æ–¹</h1><ol><li>ç¬¬å››è¡Œåˆ°ç¬¬äº”è¡Œ</li></ol><p><img src="https://raw.githubusercontent.com/Wabbybabb0/Blog_picture/main/LDA/1702177981781.jpg"></p>]]></content>
      
      
      <categories>
          
          <category> äººå·¥æ™ºèƒ½ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> äººå·¥æ™ºèƒ½ </tag>
            
            <tag> DMIRè€ƒæ ¸ </tag>
            
            <tag> NLP </tag>
            
            <tag> LDA </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è¯»å†™æ–‡ä»¶</title>
      <link href="/2023/02/10/wen-jian/"/>
      <url>/2023/02/10/wen-jian/</url>
      
        <content type="html"><![CDATA[<h3 id="ä¸€-æ–‡ä»¶çš„å½“å‰ä½ç½®æŒ‡é’ˆ"><a href="#ä¸€-æ–‡ä»¶çš„å½“å‰ä½ç½®æŒ‡é’ˆ" class="headerlink" title="ä¸€.æ–‡ä»¶çš„å½“å‰ä½ç½®æŒ‡é’ˆ"></a>ä¸€.æ–‡ä»¶çš„å½“å‰ä½ç½®æŒ‡é’ˆ</h3><p>æ–‡ä»¶ç»“æ„ç±»å‹<strong>FILE</strong></p><p>å…¶ä¸­FILE(ç»“æ„ä½“)åŒ…å«</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">char</span> <span class="token operator">*</span>_ptr<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>ptr</strong>è¡¨ç¤ºå½“å‰çš„ä½ç½®æŒ‡é’ˆï¼ŒæŒ‡å‘å½“å‰çš„è¯»å†™ä½ç½®</p><h3 id="äºŒ-è·Ÿè¸ªæ–‡ä»¶çš„å½“å‰ä½ç½®æŒ‡é’ˆ"><a href="#äºŒ-è·Ÿè¸ªæ–‡ä»¶çš„å½“å‰ä½ç½®æŒ‡é’ˆ" class="headerlink" title="äºŒ.è·Ÿè¸ªæ–‡ä»¶çš„å½“å‰ä½ç½®æŒ‡é’ˆ"></a>äºŒ.è·Ÿè¸ªæ–‡ä»¶çš„å½“å‰ä½ç½®æŒ‡é’ˆ</h3><h4 id="ftellå‡½æ•°"><a href="#ftellå‡½æ•°" class="headerlink" title="ftellå‡½æ•°"></a>ftellå‡½æ•°</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">long</span> <span class="token function">ftell</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>filepointer<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¦‚æœæ“ä½œæˆåŠŸï¼Œè¿”å›filepointeræ–‡ä»¶åœ°å½“å‰ä½ç½®æŒ‡é’ˆï¼Œ<code>å³ç›¸å¯¹äºæ–‡ä»¶å¼€å¤´çš„ä½ç§»é‡(å­—èŠ‚æ•°)</code></p><p>å¦åˆ™è¿”å›-1L</p><h4 id="feofå‡½æ•°"><a href="#feofå‡½æ•°" class="headerlink" title="feofå‡½æ•°"></a>feofå‡½æ•°</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">feof</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>filepointer<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æµ‹è¯•filepointeræ–‡ä»¶åœ°ä½ç½®æŒ‡é’ˆæ˜¯å¦æŒ‡å‘æ–‡ä»¶çš„æœ«å°¾</p><p>å¦‚æœfilepointeræ–‡ä»¶çš„ä½ç½®æŒ‡é’ˆå·²æŒ‡å‘æ–‡ä»¶çš„æœ«å°¾ï¼Œåˆ™è¿”å›é€»è¾‘çœŸï¼Œå¦åˆ™è¿”å›é€»è¾‘å‡</p><h3 id="ä¸‰-å®šä½æ–‡ä»¶çš„å½“å‰ä½ç½®æŒ‡é’ˆ"><a href="#ä¸‰-å®šä½æ–‡ä»¶çš„å½“å‰ä½ç½®æŒ‡é’ˆ" class="headerlink" title="ä¸‰.å®šä½æ–‡ä»¶çš„å½“å‰ä½ç½®æŒ‡é’ˆ"></a>ä¸‰.å®šä½æ–‡ä»¶çš„å½“å‰ä½ç½®æŒ‡é’ˆ</h3><h4 id="rewindå‡½æ•°"><a href="#rewindå‡½æ•°" class="headerlink" title="rewindå‡½æ•°"></a>rewindå‡½æ•°</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">rewind</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>filepointer<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>rewindå‡½æ•°å°†filepointeræ–‡ä»¶çš„å½“å‰ä½ç½®æŒ‡é’ˆå¼ºè¡Œå®šä½åˆ°æ–‡ä»¶çš„å¼€å¤´</p><h4 id="fseekå‡½æ•°"><a href="#fseekå‡½æ•°" class="headerlink" title="fseekå‡½æ•°"></a>fseekå‡½æ•°</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">fseek</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>filepointer<span class="token punctuation">,</span> <span class="token keyword">long</span> offest<span class="token punctuation">,</span> <span class="token keyword">int</span> origin<span class="token punctuation">)</span><span class="token comment">//filepointeræ˜¯æ–‡ä»¶æŒ‡é’ˆ</span><span class="token comment">/***offsetæ˜¯åç§»é‡ï¼Œç±»å‹ä¸ºlong intæ–‡ä»¶å¼€å¤´------SEEK_SET--0æ–‡ä»¶å½“å‰ä½ç½®---SEEK_CUR--1æ–‡ä»¶æœ«å°¾------SEEK_END--2//originæ˜¯èµ·å§‹ä½ç½®ï¼Œç±»å‹ä¸ºint</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>fseekå°†filepointeræ–‡ä»¶çš„å½“å‰ä½ç½®æŒ‡é’ˆç§»åŠ¨åˆ°<code>è·ç¦»originçš„offsetä½ç½®å¤„</code></p><p>offset&gt;0ï¼Œè¡¨ç¤ºæ–°ä½ç½®åœ¨originåï¼Œåä¹‹äº¦ç„¶</p><p>è‹¥æ“ä½œæˆåŠŸåˆ™è¿”å›0ï¼Œå¦åˆ™è¿”å›é0</p><h3 id="å››-æ–‡ä»¶çš„æ‰“å¼€ä¸å…³é—­"><a href="#å››-æ–‡ä»¶çš„æ‰“å¼€ä¸å…³é—­" class="headerlink" title="å››.æ–‡ä»¶çš„æ‰“å¼€ä¸å…³é—­"></a>å››.æ–‡ä»¶çš„æ‰“å¼€ä¸å…³é—­</h3><h4 id="fopen-å‡½æ•°"><a href="#fopen-å‡½æ•°" class="headerlink" title="fopen()å‡½æ•°"></a>fopen()å‡½æ•°</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c">FILE <span class="token operator">*</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>mode<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//filenameæ˜¯è¦æ‰“å¼€çš„æ–‡ä»¶åï¼Œæ–‡ä»¶åå‰å¯ä»¥å¸¦è·¯å¾„</span><span class="token comment">//modeæ˜¯æ‰“å¼€æ–¹å¼</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>å¦‚æœæ–‡ä»¶æ‰“å¼€æˆåŠŸï¼Œåˆ™è¿”å›æŒ‡å‘è¯¥æ–‡ä»¶çš„æŒ‡é’ˆ</p><p>å¦‚æœæ–‡ä»¶æ‰“å¼€å¤±è´¥ï¼Œåˆ™è¿”å›ç©ºæŒ‡é’ˆNULL</p><p>e.g.</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">FILE <span class="token operator">*</span>fp<span class="token punctuation">;</span>fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"f1.txt"</span><span class="token punctuation">,</span><span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ¨èå†™æ³•</span><span class="token comment">//r:æ–‡ä»¶ä¸€å®šè¦å·²å­˜åœ¨</span>fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"c:\\aaa\\f1.txt"</span><span class="token punctuation">,</span> <span class="token string">"w+"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä¸æ¨èå†™æ³•</span><span class="token comment">//w+:è‹¥æ–‡ä»¶ä¸å­˜åœ¨åˆ™åˆ›å»ºæ–‡ä»¶ï¼Œå¯è¯»å¯å†™</span><span class="token keyword">char</span> filename<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"file\\f1.txt"</span><span class="token punctuation">;</span><span class="token comment">//å­˜å‚¨åˆ°å½“å‰ç›®å½•çš„fileå­ç›®å½•ä¸‹</span>fp <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">"a+"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//a+:è‹¥æ–‡ä»¶ä¸å­˜åœ¨åˆ™åˆ›å»ºæ–‡ä»¶ï¼Œå¯è¯»å¯å†™</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="fclose-å‡½æ•°"><a href="#fclose-å‡½æ•°" class="headerlink" title="fclose()å‡½æ•°"></a>fclose()å‡½æ•°</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">fclose</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>filepointer<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¦‚æœæ­£å¸¸å…³é—­ï¼Œè¿”å›0ï¼Œå¦åˆ™è¿”å›é0</p><h3 id="äº”-æ–‡ä»¶è¯»å†™"><a href="#äº”-æ–‡ä»¶è¯»å†™" class="headerlink" title="äº”.æ–‡ä»¶è¯»å†™"></a>äº”.æ–‡ä»¶è¯»å†™</h3><h4 id="fgetcå‡½æ•°â€”å­—ç¬¦æ–¹å¼æ–‡ä»¶è¯»å†™"><a href="#fgetcå‡½æ•°â€”å­—ç¬¦æ–¹å¼æ–‡ä»¶è¯»å†™" class="headerlink" title="fgetcå‡½æ•°â€”å­—ç¬¦æ–¹å¼æ–‡ä»¶è¯»å†™"></a>fgetcå‡½æ•°â€”å­—ç¬¦æ–¹å¼æ–‡ä»¶è¯»å†™</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">fgetc</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>filepointer<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>fgetcä»filepointeræ–‡ä»¶çš„<code>å½“å‰ä½ç½®</code>è¯»å‡ºä¸€ä¸ªå­—ç¬¦ï¼ŒåŒæ—¶å°†æ–‡ä»¶çš„<code>ä½ç½®æŒ‡é’ˆ_ptr</code>åç§»ä¸€ä¸ªå­—èŠ‚ã€‚è¯»å‡ºçš„å­—èŠ‚ä¸€èˆ¬è¦ä¿å­˜åˆ°ä¸€ä¸ªå­—ç¬¦å‹å˜é‡ä¸­</p><p>å¦‚æœè¯»å–æˆåŠŸï¼Œè¿”å›<strong>è¯»å–çš„å­—èŠ‚å€¼</strong>ï¼›</p><p>å¦‚æœè¯»åˆ°æ–‡ä»¶å°¾æˆ–å‡ºé”™ï¼Œè¿”å›<strong>EOF</strong></p><h4 id="fgetså‡½æ•°â€”å­—ç¬¦ä¸²æ–¹å¼æ–‡ä»¶è¯»å†™"><a href="#fgetså‡½æ•°â€”å­—ç¬¦ä¸²æ–¹å¼æ–‡ä»¶è¯»å†™" class="headerlink" title="fgetså‡½æ•°â€”å­—ç¬¦ä¸²æ–¹å¼æ–‡ä»¶è¯»å†™"></a>fgetså‡½æ•°â€”å­—ç¬¦ä¸²æ–¹å¼æ–‡ä»¶è¯»å†™</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">fgets</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>str<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span> FILE <span class="token operator">*</span>filepointer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//*stræ˜¯è¯»å‡ºçš„å­—ç¬¦ä¸²è¦å­˜æ”¾çš„åœ°æ–¹</span><span class="token comment">//n:è¯»å–é•¿åº¦ä¸ºn-1ï¼Œåœ¨æœ«å°¾åŠ ä¸Š'\0'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>è¯»å–æˆåŠŸï¼Œè¿”å›æŒ‡å‘å­—ç¬¦ä¸²çš„æŒ‡é’ˆ</p><p>å¤±è´¥æˆ–å‡ºé”™ï¼Œè¿”å›NULL</p><h4 id="fprintfå‡½æ•°å’Œfscanfå‡½æ•°â€”æ ¼å¼åŒ–è¯»å–"><a href="#fprintfå‡½æ•°å’Œfscanfå‡½æ•°â€”æ ¼å¼åŒ–è¯»å–" class="headerlink" title="fprintfå‡½æ•°å’Œfscanfå‡½æ•°â€”æ ¼å¼åŒ–è¯»å–"></a>fprintfå‡½æ•°å’Œfscanfå‡½æ•°â€”æ ¼å¼åŒ–è¯»å–</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">fscanf</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>filepointer<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>format<span class="token punctuation">[</span><span class="token punctuation">,</span>adress<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">fprintf</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>filepointer<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>format<span class="token punctuation">[</span><span class="token punctuation">,</span>adress<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>e.g.</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> x<span class="token punctuation">;</span><span class="token keyword">char</span> <span class="token operator">*</span>str<span class="token punctuation">;</span><span class="token function">fscanf</span><span class="token punctuation">(</span>fp<span class="token punctuation">,</span><span class="token string">"%d%s"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>x<span class="token punctuation">,</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä»æ–‡ä»¶ä¸­è¯»å–</span><span class="token keyword">int</span> y<span class="token punctuation">;</span><span class="token keyword">float</span> y <span class="token operator">=</span><span class="token number">5.8</span><span class="token punctuation">;</span><span class="token function">fprintf</span><span class="token punctuation">(</span>fp<span class="token punctuation">,</span><span class="token string">"%d,%6.2f"</span><span class="token punctuation">,</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å†™å…¥æ–‡ä»¶ä¸­</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¤±è´¥è¿”å›EOF</p><h4 id="fwriteå‡½æ•°å’Œfreadå‡½æ•°â€”äºŒè¿›åˆ¶æ–¹å¼æ–‡ä»¶è¯»å†™"><a href="#fwriteå‡½æ•°å’Œfreadå‡½æ•°â€”äºŒè¿›åˆ¶æ–¹å¼æ–‡ä»¶è¯»å†™" class="headerlink" title="fwriteå‡½æ•°å’Œfreadå‡½æ•°â€”äºŒè¿›åˆ¶æ–¹å¼æ–‡ä»¶è¯»å†™"></a>fwriteå‡½æ•°å’Œfreadå‡½æ•°â€”äºŒè¿›åˆ¶æ–¹å¼æ–‡ä»¶è¯»å†™</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span><span class="token keyword">unsigned</span> size<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> n<span class="token punctuation">,</span> FILE <span class="token operator">*</span>filepointer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ptr:æ•°æ®å­˜å‚¨ä½ç½®</span><span class="token comment">//size:æ•°æ®æ‰€å å­—èŠ‚æ•°</span><span class="token comment">//n:å†™å…¥nä¸ªæ•°æ®</span><span class="token comment">//filepointer:å‘è¿™ä¸ªæ–‡ä»¶å†™</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>freadåŒç†</p>]]></content>
      
      
      <categories>
          
          <category> Cè¯­è¨€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Cè¯­è¨€ </tag>
            
            <tag> é—²ç€æ²¡äº‹å¹² </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä¸‡å¹´å†</title>
      <link href="/2023/02/08/wan-nian-li/"/>
      <url>/2023/02/08/wan-nian-li/</url>
      
        <content type="html"><![CDATA[<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_CRT_SECURE_NO_WARNINGS</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdbool.h&gt;</span></span><span class="token keyword">void</span> <span class="token function">printMonth</span><span class="token punctuation">(</span><span class="token keyword">int</span> year<span class="token punctuation">,</span> <span class="token keyword">int</span> month<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">printMonthBody</span><span class="token punctuation">(</span><span class="token keyword">int</span> year<span class="token punctuation">,</span> <span class="token keyword">int</span> month<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">getStartDay</span><span class="token punctuation">(</span><span class="token keyword">int</span> year<span class="token punctuation">,</span> <span class="token keyword">int</span> month<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">getTotalNumOfDays</span><span class="token punctuation">(</span><span class="token keyword">int</span> year<span class="token punctuation">,</span> <span class="token keyword">int</span> month<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">getNumOfDaysInMonth</span><span class="token punctuation">(</span><span class="token keyword">int</span> year<span class="token punctuation">,</span> <span class="token keyword">int</span> month<span class="token punctuation">)</span><span class="token punctuation">;</span>bool <span class="token function">isLeapYear</span><span class="token punctuation">(</span><span class="token keyword">int</span> year<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">int</span> year<span class="token punctuation">,</span> month<span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"è¯·è¾“å…¥è¦æŸ¥è¯¢çš„å¹´ä»½ï¼š\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">scanf_s</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>year<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"è¯·è¾“å…¥è¦æŸ¥è¯¢çš„æœˆä»½ï¼š\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">scanf_s</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>month<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printMonth</span><span class="token punctuation">(</span>year<span class="token punctuation">,</span> month<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">printMonth</span><span class="token punctuation">(</span><span class="token keyword">int</span> year<span class="token punctuation">,</span><span class="token keyword">int</span> month<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%då¹´%dæœˆä»½çš„æ—¥å†\n"</span><span class="token punctuation">,</span>year<span class="token punctuation">,</span>month<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"--------------------------------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"æ—¥\tä¸€\täºŒ\tä¸‰\tå››\täº”\tå…­\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printMonthBody</span><span class="token punctuation">(</span>year<span class="token punctuation">,</span> month<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">printMonthBody</span><span class="token punctuation">(</span><span class="token keyword">int</span> year<span class="token punctuation">,</span><span class="token keyword">int</span> month<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">int</span> week <span class="token operator">=</span> <span class="token function">getStartDay</span><span class="token punctuation">(</span>year<span class="token punctuation">,</span> month<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> days <span class="token operator">=</span> <span class="token function">getNumOfDaysInMonth</span><span class="token punctuation">(</span>year<span class="token punctuation">,</span> month<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> i<span class="token punctuation">;</span><span class="token keyword">int</span> date <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">int</span> circulation <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//ç¬¬ä¸€è¡Œçš„æ—¥æœŸ</span><span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> week <span class="token operator">%</span> <span class="token number">7</span><span class="token punctuation">;</span> i <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"  \t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> week<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">7</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\t"</span><span class="token punctuation">,</span> date<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä»ç¬¬äºŒè¡Œå¼€å§‹çš„æ—¥æœŸ</span><span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> date<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> days<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span> <span class="token punctuation">(</span>circulation <span class="token operator">==</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>circulation <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\t"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>circulation<span class="token operator">++</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">getStartDay</span><span class="token punctuation">(</span><span class="token keyword">int</span> year<span class="token punctuation">,</span><span class="token keyword">int</span> month<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">int</span> week<span class="token punctuation">;</span>week <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">getTotalNumOfDays</span><span class="token punctuation">(</span>year<span class="token punctuation">,</span> month<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">7</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>week <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">7</span><span class="token punctuation">;</span><span class="token keyword">else</span><span class="token keyword">return</span> week<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">getTotalNumOfDays</span><span class="token punctuation">(</span><span class="token keyword">int</span> year<span class="token punctuation">,</span><span class="token keyword">int</span> month<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">int</span> i<span class="token punctuation">;</span><span class="token keyword">int</span> yearChange <span class="token operator">=</span> year<span class="token punctuation">;</span><span class="token keyword">int</span> sum1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> sum2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> daysOfYear<span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> year <span class="token operator">-</span> <span class="token number">1800</span><span class="token punctuation">;</span> i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isLeapYear</span><span class="token punctuation">(</span>yearChange<span class="token punctuation">)</span><span class="token punctuation">)</span>daysOfYear <span class="token operator">=</span> <span class="token number">366</span><span class="token punctuation">;</span><span class="token keyword">else</span>daysOfYear <span class="token operator">=</span> <span class="token number">365</span><span class="token punctuation">;</span>sum1 <span class="token operator">+=</span> daysOfYear<span class="token punctuation">;</span>yearChange<span class="token operator">--</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> month <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span>sum2 <span class="token operator">+=</span> <span class="token function">getNumOfDaysInMonth</span><span class="token punctuation">(</span>year<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>sum <span class="token operator">=</span> sum1 <span class="token operator">+</span> sum2<span class="token punctuation">;</span><span class="token keyword">return</span> sum<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">getNumOfDaysInMonth</span><span class="token punctuation">(</span><span class="token keyword">int</span> year<span class="token punctuation">,</span><span class="token keyword">int</span> month<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span> <span class="token punctuation">(</span>month <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">||</span> month <span class="token operator">==</span> <span class="token number">3</span> <span class="token operator">||</span> month <span class="token operator">==</span> <span class="token number">5</span> <span class="token operator">||</span> month <span class="token operator">==</span> <span class="token number">7</span> <span class="token operator">||</span> month <span class="token operator">==</span> <span class="token number">8</span> <span class="token operator">||</span> month <span class="token operator">==</span> <span class="token number">10</span> <span class="token operator">||</span> month <span class="token operator">==</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">31</span><span class="token punctuation">;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>month <span class="token operator">==</span> <span class="token number">4</span> <span class="token operator">||</span> month <span class="token operator">==</span> <span class="token number">6</span> <span class="token operator">||</span> month <span class="token operator">==</span> <span class="token number">9</span> <span class="token operator">||</span> month <span class="token operator">==</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">31</span><span class="token punctuation">;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>month <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isLeapYear</span><span class="token punctuation">(</span>year<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">29</span><span class="token punctuation">;</span><span class="token keyword">else</span><span class="token keyword">return</span> <span class="token number">28</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>bool <span class="token function">isLeapYear</span><span class="token punctuation">(</span><span class="token keyword">int</span> year<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span> <span class="token punctuation">(</span>year <span class="token operator">%</span> <span class="token number">4</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> true<span class="token punctuation">;</span><span class="token keyword">else</span><span class="token keyword">return</span> false<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Cè¯­è¨€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Cè¯­è¨€ </tag>
            
            <tag> é—²ç€æ²¡äº‹å¹² </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ’åºç®—æ³•</title>
      <link href="/2023/02/07/pai-xu/"/>
      <url>/2023/02/07/pai-xu/</url>
      
        <content type="html"><![CDATA[<h1 id="æ’åº"><a href="#æ’åº" class="headerlink" title="æ’åº"></a>æ’åº</h1><h3 id="ä¸€-å†’æ³¡æ’åºbubbleSort"><a href="#ä¸€-å†’æ³¡æ’åºbubbleSort" class="headerlink" title="ä¸€.å†’æ³¡æ’åºbubbleSort"></a>ä¸€.å†’æ³¡æ’åºbubbleSort</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">int</span> a<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> size <span class="token operator">-</span> i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&gt;</span> a<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">int</span> temp <span class="token operator">=</span> a<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>a<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>a<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d "</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="äºŒ-é€‰æ‹©æ’åº"><a href="#äºŒ-é€‰æ‹©æ’åº" class="headerlink" title="äºŒ.é€‰æ‹©æ’åº"></a>äºŒ.é€‰æ‹©æ’åº</h3><p>æ¯æ¬¡æŠŠæœ€å°çš„æ‰¾å‡ºæ¥è·Ÿç¬¬ä¸€ä¸ªæ•°å€¼æ¢ä½ç½®</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">int</span> a<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">9</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">6</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> temp<span class="token punctuation">;</span><span class="token keyword">int</span> min<span class="token punctuation">;</span><span class="token keyword">int</span> length <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>min <span class="token operator">=</span> i<span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span>min<span class="token punctuation">]</span> <span class="token operator">&gt;</span> a<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span>min <span class="token operator">=</span> j<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span> <span class="token punctuation">(</span>min <span class="token operator">!=</span> i<span class="token punctuation">)</span><span class="token punctuation">{</span>temp <span class="token operator">=</span> a<span class="token punctuation">[</span>min<span class="token punctuation">]</span><span class="token punctuation">;</span>a<span class="token punctuation">[</span>min<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ä¸‰-å¿«é€Ÿæ’åº"><a href="#ä¸‰-å¿«é€Ÿæ’åº" class="headerlink" title="ä¸‰.å¿«é€Ÿæ’åº"></a>ä¸‰.å¿«é€Ÿæ’åº</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">void</span> <span class="token function">quickSort</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> low<span class="token punctuation">,</span> <span class="token keyword">int</span> high<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">findPos</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> low<span class="token punctuation">,</span> <span class="token keyword">int</span> high<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">int</span> a<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">int</span> i<span class="token punctuation">;</span><span class="token function">quickSort</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">quickSort</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> low<span class="token punctuation">,</span> <span class="token keyword">int</span> high<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">int</span> pos<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>low <span class="token operator">&lt;</span> high<span class="token punctuation">)</span><span class="token punctuation">{</span>pos <span class="token operator">=</span> <span class="token function">findPos</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> low <span class="token punctuation">,</span>high<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">quickSort</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> low<span class="token punctuation">,</span> pos <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">quickSort</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> pos <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> high<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">findPos</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> low<span class="token punctuation">,</span> <span class="token keyword">int</span> high<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">int</span> val <span class="token operator">=</span> a<span class="token punctuation">[</span>low<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span>low <span class="token operator">&lt;</span> high<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">while</span> <span class="token punctuation">(</span>low <span class="token operator">&lt;</span> high <span class="token operator">&amp;&amp;</span> a<span class="token punctuation">[</span>high<span class="token punctuation">]</span> <span class="token operator">&gt;=</span> val<span class="token punctuation">)</span><span class="token operator">--</span>high<span class="token punctuation">;</span>a<span class="token punctuation">[</span>low<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>high<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span>low <span class="token operator">&lt;</span> high <span class="token operator">&amp;&amp;</span> a<span class="token punctuation">[</span>low<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> val<span class="token punctuation">)</span><span class="token operator">++</span>low<span class="token punctuation">;</span>a<span class="token punctuation">[</span>high<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>low<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span>a<span class="token punctuation">[</span>low<span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span><span class="token keyword">return</span> low<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å››-æ’å…¥æ’åº-äºŒåˆ†æ³•"><a href="#å››-æ’å…¥æ’åº-äºŒåˆ†æ³•" class="headerlink" title="å››.æ’å…¥æ’åº+äºŒåˆ†æ³•"></a>å››.æ’å…¥æ’åº+äºŒåˆ†æ³•</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">int</span> a<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">7</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> temp<span class="token punctuation">;</span><span class="token keyword">int</span> low<span class="token punctuation">,</span> high<span class="token punctuation">,</span>mid<span class="token punctuation">;</span><span class="token keyword">int</span> l <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>temp <span class="token operator">=</span> a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>low <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>high <span class="token operator">=</span> i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>mid <span class="token operator">=</span> <span class="token punctuation">(</span>high <span class="token operator">+</span> low<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span>mid<span class="token punctuation">]</span> <span class="token operator">!=</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> high <span class="token operator">!=</span> low<span class="token punctuation">)</span><span class="token punctuation">{</span>mid <span class="token operator">=</span> <span class="token punctuation">(</span>high <span class="token operator">+</span> low<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span>mid<span class="token punctuation">]</span> <span class="token operator">&gt;</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>high <span class="token operator">=</span> mid <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span>mid<span class="token punctuation">]</span> <span class="token operator">&lt;</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>low <span class="token operator">=</span> mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span>mid<span class="token punctuation">]</span> <span class="token operator">==</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> i<span class="token punctuation">;</span> j <span class="token operator">&gt;=</span> mid <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span> j<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">{</span>temp <span class="token operator">=</span> a<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>a<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>a<span class="token punctuation">[</span>j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span><span class="token punctuation">}</span>a<span class="token punctuation">[</span>mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>high <span class="token operator">==</span> low<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span>low<span class="token punctuation">]</span> <span class="token operator">&lt;</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> i<span class="token punctuation">;</span> j <span class="token operator">&gt;</span> low<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> j<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">{</span>temp <span class="token operator">=</span> a<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>a<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>a<span class="token punctuation">[</span>j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span><span class="token punctuation">}</span>a<span class="token punctuation">[</span>low <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span>high<span class="token punctuation">]</span> <span class="token operator">&gt;</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> i<span class="token punctuation">;</span> j <span class="token operator">&gt;=</span> high <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> j<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">{</span>temp <span class="token operator">=</span> a<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>a<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>a<span class="token punctuation">[</span>j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span><span class="token punctuation">}</span>a<span class="token punctuation">[</span>high<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Cè¯­è¨€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Cè¯­è¨€ </tag>
            
            <tag> é—²ç€æ²¡äº‹å¹² </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FirstGameç¬”è®°</title>
      <link href="/2023/01/21/firtgame/"/>
      <url>/2023/01/21/firtgame/</url>
      
        <content type="html"><![CDATA[<p>è·Ÿç€éº¦æ‰£è€å¸ˆåšçš„<a href="https://github.com/Wabbybabb0/My-First-Game-Demo">å°ç‹ç‹¸demo</a></p><h4 id="Input-GetAxis"><a href="#Input-GetAxis" class="headerlink" title="Input.GetAxis"></a>Input.GetAxis</h4><p>GetAxis()ä¸¤ç§ï¼š</p><ul><li><p>Vertical:è·å¾—å‚ç›´æ–¹å‘</p></li><li><p>Horizontal:è·å¾—æ°´å¹³æ–¹å‘</p></li></ul><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">horizontalmove = Input.GetAxis("Horizontal");//æ£€æµ‹æ°´å¹³æ–¹å‘é”®verticalmove = Input.GetAxis("Vertical"); //æ£€æµ‹å‚ç›´æ–¹å‘é”®<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="/../../../../medias/blog_picture/Unity/1.png"></p><p>ğŸ‘†Edit-&gt;Project Settings-&gt;Input Manager-&gt;Axes-&gt;Horizontal</p><p>ä»ä¸Šå›¾å¯çŸ¥<code>Negative Button</code> <code>-1</code>å¯¹åº”<code>left</code>å’Œ<code>a</code>ï¼›<code>Positive Button</code>å¯¹åº”<code>1</code>å’Œ<code>right</code></p><p>æ‰€ä»¥åœ¨ç¨‹åºä¸­åˆ†åˆ«è®¾ç½®ä¸¤ä¸ªå˜é‡æ¥æ”¶<code>-1</code>æˆ–è€…<code>1</code>æ¥åˆ¤æ–­æ˜¯æŒ‰äº†<code>a</code> <code>left</code>è¿˜æ˜¯<code>d</code> <code>right</code></p><h4 id="Input-GetAxisRaw"><a href="#Input-GetAxisRaw" class="headerlink" title="Input.GetAxisRaw"></a>Input.GetAxisRaw</h4><p><strong>~ vs Input.GetAxis</strong>ğŸ‘‡</p><p>å‰è€…è·å¾—çš„æ•°æ®åªæœ‰<code>-1</code> <code>0</code> <code>1</code></p><p>åè€…è·å¾—çš„æ•°æ®æ˜¯<code>-1~0</code> <code>0~1</code></p><h4 id="Time-deltaTime"><a href="#Time-deltaTime" class="headerlink" title="Time.deltaTime"></a>Time.deltaTime</h4><p><img src="/../../../../medias/blog_picture/Unity/2.png"></p><p><img src="/../../../../medias/blog_picture/Unity/3.png"></p><h4 id="Mathf-Abs"><a href="#Mathf-Abs" class="headerlink" title="Mathf.Abs()"></a>Mathf.Abs()</h4><p>å–ç»å¯¹å€¼</p><h4 id="transform-Transform"><a href="#transform-Transform" class="headerlink" title="transform&amp;Transform"></a>transform&amp;Transform</h4><ul><li>Transformåšå‡½æ•°</li><li>transformæ‰æ˜¯å½“å‰çœŸæ­£éœ€è¦æ“ä½œçš„</li></ul><h4 id="é•œå¤´è®¾ç½®çš„ä¸¤ç§æ–¹æ³•"><a href="#é•œå¤´è®¾ç½®çš„ä¸¤ç§æ–¹æ³•" class="headerlink" title="é•œå¤´è®¾ç½®çš„ä¸¤ç§æ–¹æ³•"></a>é•œå¤´è®¾ç½®çš„ä¸¤ç§æ–¹æ³•</h4><h5 id="1-åœ¨Main-Cameraä¸­åŠ new-script"><a href="#1-åœ¨Main-Cameraä¸­åŠ new-script" class="headerlink" title="1.åœ¨Main Cameraä¸­åŠ new script"></a>1.åœ¨Main Cameraä¸­åŠ new script</h5><p>ğŸ‘‡Scriptä»£ç </p><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">public class CameraControl : MonoBehaviour{//â‘ è®¾ç½®ä¸€ä¸ªå«"player"çš„Transformç±»å‹çš„å˜é‡    public Transform player;    // Update is called once per frame    void Update()    {    //â‘¡æŠŠMain Cameraä¸­çš„transformæ ç›®ä¸­çš„positionæ”¹ä¸ºä¸€ä¸ªå®ä¾‹ï¼Œè¯¥å®ä¾‹æ˜¯3Dçš„ï¼Œxyzå„è‡ªå¯¹åº”        transform.position = new Vector3(player.position.x, 0, -10f);      }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ğŸ‘‡æœ€åæŠŠè¦ç»™é•œå¤´çš„å¯¹è±¡ç§»åŠ¨åˆ°Playerå¤„å³å¯</p><p><img src="/../../../../medias/blog_picture/Unity/4.png"></p><h5 id="2-cinimachine"><a href="#2-cinimachine" class="headerlink" title="2.cinimachine"></a>2.cinimachine</h5><p>GameObject-&gt;Cinimachine-&gt;2D Cinima-&gt;å¾—åˆ°ä¸‹å›¾æ‰€ç¤ºçš„é€‰é¡¹</p><p><img src="/../../../../medias/blog_picture/Unity/5.png"></p><p><img src="/../../../../medias/blog_picture/Unity/6.png"></p><ul><li><p>Followå¤„æ‹‰æ‹½ä¸Šéœ€è¦è·Ÿè¸ªé•œå¤´çš„å¯¹è±¡</p></li><li><p>ç„¶ååœ¨Lenså¤„è°ƒæ•´é•œå¤´è·ç¦»ç­‰å‚æ•°</p></li></ul><p><img src="/../../../../medias/blog_picture/Unity/7.png"></p><ul><li><p>Dead Zone</p><ul><li>å¯ä»¥æ‹‰æ‹½èŒƒå›´ï¼Œå¦‚æœè¶…å‡ºèŒƒå›´åˆ™é•œå¤´ç§»åŠ¨ï¼Œæœªè¶…å‡ºåˆ™ä¸ç§»åŠ¨</li></ul></li><li><p>ä¸ç¦»å¼€èƒŒæ™¯å›¾</p><ul><li>CM vcam1-&gt;Body-&gt;Add Extension-&gt;Cinimachine Confiner-&gt;</li><li><img src="/../../../../medias/blog_picture/Unity/8.png"></li></ul></li><li><p>å›åˆ°Backgroundå›¾å±‚æ‹‰æ‹½èŒƒå›´</p></li></ul><h4 id="è™šå‡½æ•°ä¸ç±»çš„ä½¿ç”¨"><a href="#è™šå‡½æ•°ä¸ç±»çš„ä½¿ç”¨" class="headerlink" title="è™šå‡½æ•°ä¸ç±»çš„ä½¿ç”¨"></a>è™šå‡½æ•°ä¸ç±»çš„ä½¿ç”¨</h4><p><strong>çˆ¶çº§</strong></p><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">public class Enemy : MonoBehaviour{    protected Animator Anim;    //ğŸ‘†æ‰€æœ‰Enemyéƒ½éœ€è¦æœ‰â€œè¢«å‡»æ€â€çš„åŠ¨ç”»ï¼Œå› æ­¤å…ˆåˆ›å»ºä¸€ä¸ªåä¸º"Anim"çš„Animatorå˜é‡    //"protected"â†’1.1    protected virtual void Start()    //"virtual"çˆ¶çº§çš„"Start"æ˜¯å¯ä»¥è¢«å­çº§é‡æ–°ç¼–å†™çš„(å› ä¸ºå­çº§åœ¨"Start"ä¸­æœ‰ä¸€äº›æœ¬ä½“çš„å±æ€§)    {        Anim = GetComponent&lt;Animator&gt;();    }    public void Death()    {        Destroy(gameObject);    }    public void JumpOn()    {        Anim.SetTrigger("death");    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>å­çº§</strong></p><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">public class Enemy_Frog : Enemy//éš¶å±äºEnemyçš„å­çº§ï¼Œç¡®å®šçˆ¶å­å…³ç³»{protected override void Start()//ğŸ‘†override å‘¼åº”virtual{     base.Start();//è°ƒç”¨çˆ¶çº§çš„Start}}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>Player</strong></p><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">Enemy enemy = collision.gameObject.GetComponent&lt;Enemy&gt;();//å¯ä»¥è°ƒç”¨åä¸º"Enemy"çš„ç±»çš„çˆ¶å­çº§<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h5 id="1-1protected"><a href="#1-1protected" class="headerlink" title="1.1protected"></a>1.1protected</h5><ul><li><p>è‡ªèº«ç±»å’Œæ´¾ç”Ÿç±»å¯ä»¥è®¿é—®ç›¸å½“äºè‡ªèº«çš„privateå‹æˆå‘˜ <code>åˆ›å»ºçš„å‡½æ•°æˆ–è€…å˜é‡åœ¨å­çˆ¶çº§ä¸­éƒ½å¯ä»¥ä½¿ç”¨</code></p></li><li><p>å¯ä»¥è¢«<code>1.è¯¥ç±»ä¸­çš„å‡½æ•°</code>ã€<code>2.å­ç±»çš„å‡½æ•°</code>ã€ä»¥åŠ<code>3.å…¶å‹å…ƒå‡½æ•°</code>è®¿é—®ã€‚ä½†ä¸èƒ½è¢«è¯¥ç±»çš„å¯¹è±¡è®¿é—®</p></li><li><p>ä½¿ç”¨protectedç»§æ‰¿ï¼Œçˆ¶ç±»çš„protectedå’Œpublicå±æ€§åœ¨å­ç±»ä¸­å˜ä¸ºprotected</p></li></ul><h4 id="åœºæ™¯è½¬æ¢"><a href="#åœºæ™¯è½¬æ¢" class="headerlink" title="åœºæ™¯è½¬æ¢"></a>åœºæ™¯è½¬æ¢</h4><p>ä»ç¬¬ä¸€å…³è¿›å…¥ç¬¬äºŒå…³</p><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">using UnityEngine.SceneManagement;//.//.if(Input.GetKeyDown(KeyCode.E)){    SceneManager.LoadScene(SceneManager.GetActiveScene().bulidIndex + 1);}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>æ“ä½œç¬¦</title>
      <link href="/2023/01/13/cao-zuo-fu/"/>
      <url>/2023/01/13/cao-zuo-fu/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€-æ“ä½œç¬¦"><a href="#ä¸€-æ“ä½œç¬¦" class="headerlink" title="ä¸€.æ“ä½œç¬¦"></a>ä¸€.æ“ä½œç¬¦</h2><p><strong>æ“ä½œç¬¦å‡½æ•°æ˜¯æ–¹æ³•å‡½æ•°çš„ç®€è®°æ³•</strong></p><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">namespace CreatOperator{    class Program    {        static void Main(string[] args)        {            Person person1 = new Person();            Person person2 = new Person();            person1.Name = "Deer";            person2.Name = "Deer's wife";            List&lt;Person&gt; nation = Person.GetMarry(person1,person2);            //ä¸Šé¢è¿™è¡Œæ”¹æˆ            //List&lt;Person&gt; nation = person1 + person2;            foreach (var p in nation)            {                Console.WriteLine(p.Name);            }        }    }        class Person    {        public string Name;        public static List&lt;Person&gt;GetMarry(Person p1,Person p2)        //ä¸Šé¢è¿™è¡Œæ”¹æˆ public static List&lt;Person&gt; operator+(Person p1,Person p2)        {            List&lt;Person&gt; people = new List&lt;Person&gt;();            people.Add(p1);            people.Add(p2);            for (int i = 0; i &lt; 11; i++)            {                Person child = new Person();                child.Name = p1.Name + "&amp;" + p2.Name + "s child";                people.Add(child);            }            return people;        }    }}//ä¸¤ç§æ–¹æ³•çš„ç»“æœä¸€æ ·<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åªæœ‰åœ†æ‹¬å·æ¥æé«˜ä¼˜å…ˆçº§</p><h4 id="æ•°ç»„"><a href="#æ•°ç»„" class="headerlink" title="æ•°ç»„"></a>æ•°ç»„</h4><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">int[] myIntArray = new int[]{};//[]å¡«æ•°ç»„å¤§å°ï¼Œ{}(åˆå§‹åŒ–å™¨)å¡«å…·ä½“æ•°å€¼<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="typeof"><a href="#typeof" class="headerlink" title="typeof"></a>typeof</h4><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">Type t = typeof(int);Console.WriteLine(t.Namespace);Console.WriteLine(t.FullName);Console.WriteLine(t.Name);/**SystemSystem.Int32Int32*/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="default"><a href="#default" class="headerlink" title="default"></a>default</h4><p>è·å–ä¸€ä¸ªç±»å‹çš„é»˜è®¤å€¼</p><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">int x = default(int);Console.WriteLine(x);//0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">Form myForm = default(Form);Console.WriteLine(myForm==null);//true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">class Program{static void Main(string[] args)    {        Level level = default(Level);        Console.WriteLine(level);    }}//â‘ enum Level{Low,Mid,High}//Low//â‘¡enum Level{Mid,Low,High}//Mid//â‘¢enum Level{Mid = 1,Low = 0,High = 2}//Low//â‘£enum Level{Low = 1,Mid = 2,High = 3}//0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="var"><a href="#var" class="headerlink" title="var"></a>var</h4><p>å£°æ˜éšå¼ç±»å‹å˜é‡</p><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">int x = 100;//æ˜¾å¼var y = 100;//éšå¼æ ¹æ®èµ‹çš„å€¼â€œ100â€æ¥ç»™yåˆ¤æ–­ç±»å‹Console.WriteLine(y.GetType().Name);//Int32<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="new"><a href="#new" class="headerlink" title="new"></a>new</h4><ul><li>è°ƒç”¨å®ä¾‹æ„é€ å™¨</li></ul><p>å¸®åŠ©æˆ‘ä»¬åœ¨å†…å­˜å½“ä¸­<code>åˆ›å»ºç±»å‹çš„å®ä¾‹</code></p><p>æœ‰<code>()</code>æ—¶è¡¨ç¤º<code>è°ƒç”¨å®ƒçš„å®ä¾‹æ„é€ å™¨</code></p><p>å¦‚æœåœ¨newæ“ä½œç¬¦<code>å·¦è¾¹æœ‰èµ‹å€¼ç¬¦å·</code>çš„è¯ï¼Œé‚£ä¹ˆnewæ“ä½œç¬¦ä¼šæŠŠè‡ªå·±æ‹¿åˆ°çš„è¿™ä¸ª<code>å®ä¾‹çš„å†…å­˜åœ°å€</code>é€šè¿‡<code>èµ‹å€¼æ“ä½œç¬¦</code>äº¤ç»™è´Ÿè´£è®¿é—®è¿™ä¸ªå®ä¾‹çš„<code>å˜é‡</code></p><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">Form myForm = new Form();//myFormä¸ºè¯¥å®ä¾‹çš„å˜é‡<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>è°ƒç”¨å®ä¾‹çš„åˆå§‹åŒ–å™¨</li></ul><p>èŠ±æ‹¬å·<code>{}</code>å†…å¯ä»¥ä¸ºè¿™ä¸ªå®ä¾‹çš„å±æ€§è®¾ç½®å®ƒçš„å€¼ï¼Œå¯ä»¥é€šè¿‡<code>,</code>æ¥åŒæ—¶è®¾ç½®å¤šä¸ªå±</p><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">Form myForm = new Form(){Text."Hello"};<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ğŸ‘†ğŸ‘‡</p><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">Form myForm = new Form();myForm.Text = "Hello"; <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>ä¸€æ¬¡æ€§è®¿é—®ï¼Œæ²¡å¿…è¦åˆ›å»ºå˜é‡è®¿é—®å®ä¾‹</li></ul><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">new Form(){Text = "Hello"}.ShowDialog();<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ğŸ‘†ğŸ‘‡</p><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">Form myForm = new Form();myForm.Text = "Hello";myForm.ShowDialog();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>åŒ¿åç±»å‹åˆ›å»ºå¯¹è±¡</li></ul><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">var person = new{Name = "Mr.Okay", Age = 18};//è‡ªåŠ¨åˆ¤æ–­ç±»å‹Console.WriteLine(person.Age);Console.WriteLine(person.Name);Console.WriteLine(person.GetType().Name);//Mr.Okay//18//&lt;&gt;f__AnonymousType0`2//ç±»å‹çš„è§£é‡Šï¼š//&lt;&gt;f__AnonymousTypeæ˜¯çº¦å®šçš„ä¸€ä¸ªå‰ç¼€//0æŒ‡çš„æ˜¯åœ¨ç¨‹åºä¸­åˆ›å»ºçš„ç¬¬ä¸€ä¸ª//`2æŒ‡çš„æ˜¯è¿™ä¸ªç±»å‹æ˜¯ä¸€ä¸ªæ³›å‹ç±»ï¼Œæ„æˆè¿™ä¸ªç±»å‹æ—¶éœ€è¦ä¸¤ä¸ªç±»å‹æ¥æ„æˆå®ƒï¼Œä¸€ä¸ªæ˜¯stringï¼Œä¸€ä¸ªæ˜¯int<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>å­ç±»éšè—çˆ¶ç±»(å…³é”®å­—)(äº†è§£å³å¯)</li></ul><h4 id="checked-unchecked"><a href="#checked-unchecked" class="headerlink" title="checked&amp;unchecked"></a>checked&amp;unchecked</h4><p>æ£€æŸ¥æ˜¯å¦å¼‚å¸¸</p><h4 id="å–éæ“ä½œç¬¦"><a href="#å–éæ“ä½œç¬¦" class="headerlink" title="!å–éæ“ä½œç¬¦"></a>!å–éæ“ä½œç¬¦</h4><p>å®é™…åº”ç”¨ï¼Œæ£€æŸ¥</p><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">namespace CreatOperator{    class Program    {        static void Main(string[] args)        {            Student stu = new Student(null);            Console.WriteLine(stu.Name);        }    }    class Student    {        public string Name;        public Student(string initName)        {            if(!string.IsNullOrEmpty(initName))            {                this.Name = initName;            }            else             {                throw new ArgumentException("initName cannot be null or empty");            }        }    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="T-xå¼ºåˆ¶è½¬æ¢ç±»å‹æ“ä½œç¬¦"><a href="#T-xå¼ºåˆ¶è½¬æ¢ç±»å‹æ“ä½œç¬¦" class="headerlink" title="(T)xå¼ºåˆ¶è½¬æ¢ç±»å‹æ“ä½œç¬¦"></a>(T)xå¼ºåˆ¶è½¬æ¢ç±»å‹æ“ä½œç¬¦</h4><h2 id="äºŒ-æ•°æ®ç±»å‹è½¬æ¢"><a href="#äºŒ-æ•°æ®ç±»å‹è½¬æ¢" class="headerlink" title="äºŒ.æ•°æ®ç±»å‹è½¬æ¢"></a>äºŒ.æ•°æ®ç±»å‹è½¬æ¢</h2><h4 id="convert"><a href="#convert" class="headerlink" title="convert"></a>convert</h4><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">string str1 = Console.ReadLine();string str2 = Console.ReadLine();int x = Convert.ToInt32(str1);int y = Convert.ToInt32(str2);Console.WriteLine(str1 + str2);Console.WriteLine(x + y);//12//34//1234//46s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="éšå¼ç±»å‹è½¬æ¢"><a href="#éšå¼ç±»å‹è½¬æ¢" class="headerlink" title="éšå¼ç±»å‹è½¬æ¢"></a>éšå¼ç±»å‹è½¬æ¢</h4><ul><li>ä¸ä¸¢å¤±ç²¾åº¦çš„è½¬æ¢</li></ul><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">int x = int.MaxValue;long y = x;Console.WriteLine(y);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>C#è¯­è¨€æ•°æ®æ–‡æ¡£6.1.2æœ‰éšå¼æ•°å€¼è½¬æ¢</p><p><img src="/../../../../medias/blog_picture/C#/5.png"></p><ul><li>å­ç±»å‘çˆ¶ç±»çš„è½¬æ¢</li></ul><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">namespace CreatOperator{    class Program    {        static void Main(string[] args)        {            Teacher t = new Teacher();            Human h = t;//hä»åªæœ‰Eatå’ŒAnimal            Animal a = h;//è®¿é—®çš„æ˜¯Animalï¼Œå¼•ç”¨ä¸äº†å®ä¾‹hï¼Œåªæœ‰Eat            a.Eat();        }    }//çˆ¶ç±»    class Animal    {        public void Eat()        {            Console.WriteLine("Eating");        }    }//å­ç±»    class Human:Animal    {        public void Think()        {            Console.WriteLine("Who am I?");        }    }//å­ç±»çš„å­ç±»    class Teacher : Human    {        public void Teach()        {            Console.WriteLine("I teach programming.");        }    }}//Eating<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>è£…ç®±</li></ul><h4 id="æ˜¾å¼ç±»å‹è½¬æ¢"><a href="#æ˜¾å¼ç±»å‹è½¬æ¢" class="headerlink" title="æ˜¾å¼ç±»å‹è½¬æ¢"></a>æ˜¾å¼ç±»å‹è½¬æ¢</h4><ul><li>æœ‰å¯èƒ½ä¸¢å¤±ç²¾åº¦çš„è½¬æ¢<strong>cast</strong>(é“¸é€ )</li></ul><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">Console.WriteLine(ushort.MaxValue);uint x = 65536;ushort y = (ushort)x;//å¼ºåˆ¶æŠŠè¾ƒå¤§çš„å€¼è£…åˆ°å°çš„ç©ºé—´é‡ŒConsole.WriteLine(y);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>æ‹†ç®±</li><li>convert<ul><li>æ•°å€¼ç±»å‹å¾€å­—ç¬¦ä¸²ç±»å‹è½¬æ¢</li></ul></li></ul><h4 id="ç±»å‹è½¬æ¢æ“ä½œç¬¦"><a href="#ç±»å‹è½¬æ¢æ“ä½œç¬¦" class="headerlink" title="ç±»å‹è½¬æ¢æ“ä½œç¬¦"></a>ç±»å‹è½¬æ¢æ“ä½œç¬¦</h4><p>æ˜¾å¼ç±»å‹è½¬æ¢æ˜¯ä¸€ä¸ªç›®æ ‡ç±»å‹çš„å®ä¾‹çš„æ„é€ å™¨ï¼Œå†™åœ¨è¢«è½¬æ¢çš„è¿™ä¸ªæ•°æ®ç±»å‹é‡Œ</p><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">namespace CreatOperator{    class Program    {        static void Main(string[] args)        {            Stone stone = new Stone();            stone.Age = 5000;            Monkey wukongSun = (Monkey)stone;            //ç›®æ ‡æ˜¯æŠŠä¸€ä¸ªStoneç±»å‹çš„è½¬å˜ä¸ºMonkeyç±»å‹çš„            Console.WriteLine(wukongSun.Age);        }    }    class Stone    {        public int Age;        //æ˜¾å¼ç±»å‹è½¬æ¢æ˜¯ä¸€ä¸ªç›®æ ‡ç±»å‹çš„å®ä¾‹çš„æ„é€ å™¨ï¼Œå†™åœ¨è¢«è½¬æ¢çš„è¿™ä¸ªæ•°æ®ç±»å‹é‡Œ        //Monkey(Stone stone)å°±æ˜¯ä¸€ä¸ªæ„é€ å™¨        public static explicit operator Monkey(Stone stone)        {            Monkey m = new Monkey();            m.Age = stone.Age / 500;//æ„å»ºMonkeyå’ŒStoneçš„å…³ç³»            return m;        }    }    class Monkey    {        public int Age;    }}//10<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯¹æ¯”éšå¼ç±»å‹è½¬æ¢</p><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">namespace CreatOperator{    class Program    {        static void Main(string[] args)        {            Stone stone = new Stone();            stone.Age = 5000;            Monkey wukongSun = stone;//æ­¤å¤„å»æ‰äº†(Monkey)stoneçš„(Monkey)            Console.WriteLine(wukongSun.Age);        }    }    class Stone    {        public int Age;        public static implicit operator Monkey(Stone stone)//æ­¤å¤„å°†"explicit"æ”¹ä¸º"implicit"        {            Monkey m = new Monkey();            m.Age = stone.Age / 500;            return m;        }    }    class Monkey    {        public int Age;    }}//10<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="is"><a href="#is" class="headerlink" title="is"></a>is</h4><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">Stone stone = new Stone();var result = stone is Stone;//æ£€éªŒçš„æ˜¯å˜é‡æ‰€å¼•ç”¨çš„å®ä¾‹Console.WriteLine(result.GetType().FullName);Console.WriteLine(result);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h4 id="Nullableå¯ç©ºç±»å‹"><a href="#Nullableå¯ç©ºç±»å‹" class="headerlink" title="Nullable<>å¯ç©ºç±»å‹"></a>Nullable&lt;&gt;å¯ç©ºç±»å‹</h4><p>ä¾‹å­ï¼šä¸€ä¸ªåŒå­¦æ²¡äº¤ä½œä¸šï¼Œä½†æ˜¯ä¸æ˜¯é‚£ç§åšçš„æå·®çš„0åˆ†ï¼Œæƒ³ç»™ä»–ç©ºç€</p><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">Nullable&lt;int&gt; x = null;//æ²¡äº¤ä½œä¸šx = 100;//äº¤äº†ä½œä¸š<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ğŸ‘†ğŸ‘‡</p><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">int?x = null;x = 100;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ä½†æ˜¯å¦‚æœè¿™ä¸ªåŒå­¦ä¸€ç›´æ²¡äº¤ä½œä¸šï¼ŒæœŸæœ«éœ€è¦å½•å…¥æˆç»©æ—¶ç»™0åˆ†</p><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">int?x = null;int y = x??0;//èµ‹0åˆ†<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="ifelseçš„ç®€å†™"><a href="#ifelseçš„ç®€å†™" class="headerlink" title="?:(ifelseçš„ç®€å†™)"></a>?:(ifelseçš„ç®€å†™)</h4><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">int x = 80;string str = string.Empty;str = (x &gt;= 60)?"Pass":"Failed";<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ğŸ‘†ğŸ‘‡</p><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">int x = 80;string str;if(x&gt;60){    str = "Pass";}else{    str = "Failed";}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> é—²ç€æ²¡äº‹å¹² </tag>
            
            <tag> C# </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºæœ¬å…ƒç´ å’Œç±»å‹</title>
      <link href="/2023/01/11/ji-ben-yuan-su-he-shu-ju-lei-xing/"/>
      <url>/2023/01/11/ji-ben-yuan-su-he-shu-ju-lei-xing/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€-åŸºæœ¬å…ƒç´ "><a href="#ä¸€-åŸºæœ¬å…ƒç´ " class="headerlink" title="ä¸€.åŸºæœ¬å…ƒç´ "></a>ä¸€.åŸºæœ¬å…ƒç´ </h2><ul><li>æ ‡è®°Tokenï¼šå¯¹ç¼–è¯‘å™¨æœ‰æ„ä¹‰çš„ç¬¦å·<ul><li>å…³é”®å­—Keyword</li><li>æ“ä½œç¬¦Operator</li><li>æ ‡è¯†ç¬¦Identifier<ul><li>å…è®¸â€œ@â€å­—ç¬¦ä½œä¸ºå‰ç¼€ä»¥ä½¿å…³é”®å­—èƒ½å¤Ÿç”¨ä½œæ ‡è¯†ç¬¦</li></ul></li><li>æ ‡ç‚¹ç¬¦å·</li><li>æ–‡æœ¬(å­—é¢å€¼)</li></ul></li><li>æ³¨é‡Šä¸ç©ºç™½<ul><li>CTRL+K CTRL+CğŸ‘‰æ³¨é‡Š</li><li>CTRL+K CTRL+UğŸ‘‰å–æ¶ˆæ³¨é‡Š</li><li>CTRL+K CTRL+DğŸ‘‰è®¾ç½®æ–‡æ¡£æ ¼å¼(è‡ªåŠ¨å¯¹é½)</li></ul></li></ul><h2 id="äºŒ-æ•°æ®ç±»å‹"><a href="#äºŒ-æ•°æ®ç±»å‹" class="headerlink" title="äºŒ.æ•°æ®ç±»å‹"></a>äºŒ.æ•°æ®ç±»å‹</h2><ul><li><p>å€¼ç±»å‹</p><ul><li>ç»“æ„ä½“Structures</li><li>æšä¸¾Enumerations<ul><li>åªèƒ½ä»ä¸€ä¸ªé›†åˆä¸­é€‰å–æœ‰æ•ˆå€¼</li></ul></li></ul></li><li><p>å¼•ç”¨ç±»å‹</p><ul><li><p>ç±»Classes</p></li><li><p>æ¥å£Interfaces</p></li><li><p>å§”æ‰˜Delegates</p></li></ul></li></ul><h2 id="ä¸‰-å˜é‡"><a href="#ä¸‰-å˜é‡" class="headerlink" title="ä¸‰.å˜é‡"></a>ä¸‰.å˜é‡</h2><p>ğŸ‘‡ä»è¡¨é¢çœ‹ï¼Œå˜é‡æ˜¯ç”¨æ¥<strong>å­˜å‚¨æ•°æ®</strong>çš„</p><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">int x;x = 100;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>å®é™…ä¸Šï¼Œ<strong>å˜é‡è¡¨ç¤ºäº†å­˜å‚¨ä½ç½®ï¼Œå¹¶ä¸”æ¯ä¸ªå˜é‡éƒ½æœ‰ä¸€ä¸ªç±»å‹ï¼Œä»¥å†³å®šä»€ä¹ˆæ ·çš„å€¼èƒ½å¤Ÿå­˜å…¥å˜é‡</strong></p><p>ğŸ‘†äº†è§£ä¸ºï¼Œxæ˜¯ä¸€ä¸ª<code>æ ‡ç­¾</code>ï¼Œå¯¹åº”ç€å†…å­˜ä¸­çš„ä¸€ä¸ªåœ°å€ï¼Œ100è¿™ä¸ªå€¼å°±å­˜åœ¨è¯¥åœ°å€</p><p><strong>å˜é‡ = <code>ä»¥å˜é‡åæ‰€å¯¹åº”çš„å†…å­˜åœ°å€ä¸ºèµ·ç‚¹</code>ã€<code>ä»¥å…¶æ•°æ®ç±»å‹æ‰€è¦æ±‚çš„å­˜å‚¨ç©ºé—´ä¸ºé•¿åº¦</code>çš„ä¸€å—å†…å­˜åŒºåŸŸ</strong></p><p><img src="/../../../../medias/blog_picture/C#/2.png" alt="å †ï¼Œæ ˆï¼Œåœ°å€çš„ç†è§£"></p><p>å¼•ç”¨å˜é‡å­˜çš„æ˜¯å®ä¾‹çš„åœ°å€</p><h4 id="è£…ç®±å’Œæ‹†ç®±"><a href="#è£…ç®±å’Œæ‹†ç®±" class="headerlink" title="è£…ç®±å’Œæ‹†ç®±"></a>è£…ç®±å’Œæ‹†ç®±</h4><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">//è£…ç®±int x = 100;object obj;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>å½“å‘ç°objå¼•ç”¨çš„å®ä¾‹åœ¨å †ä¸Šè€Œä¸åœ¨æ ˆä¸Šæ—¶ï¼ŒæŠŠè¯¥å®ä¾‹å¯¹åº”çš„å€¼çš„å†…å­˜å¤§å°åœ¨æ ˆä¸Šæ‰¾ä¸€å—ç©ºé—´ï¼Œå†æŠŠè¿™ä¸ªåœ°å€å­˜å‚¨å›objçš„å†…å­˜ç©ºé—´</p><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">//æ‹†ç®±int y = (int)obj;Console.WriteLine(y);//100<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/../../../../medias/blog_picture/C#/3.png" alt="è£…ç®±å’Œæ‹†ç®±"></p><h2 id="å››-æ–¹æ³•"><a href="#å››-æ–¹æ³•" class="headerlink" title="å››.æ–¹æ³•"></a>å››.æ–¹æ³•</h2><p>æ–¹æ³•æ˜¯ç±»æˆ–ç»“æ„ä½“çš„æˆå‘˜</p><p>æ–¹æ³•ç›¸å½“äºè‡ªå®šä¹‰å‡½æ•°</p><p><img src="/../../../../medias/blog_picture/C#/4.png"></p><p>ğŸ‘†å¤ç”¨ï¼Œå¦‚æœè¦æ›´æ”¹3.14159ä¸º3.14æˆ–è€…Math.PIå¯ä»¥ç›´æ¥åœ¨GetCircleAreaå¤„æ”¹</p><p>å®ä¾‹æ–¹æ³•ğŸ‘‡</p><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">Calculator c = new Calculator();c.Add(2.0,3.0);class Calculator{    public double Add(double a,double b);}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é™æ€æ–¹æ³•</p><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">Calculator c = new Calculator();//c.Add(2.0,3.0);æ­¤æ—¶è¿™å¥è¯æ— ç”¨class Calculator{    public static double Add(double a,double b);}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="äº”-æ„é€ å™¨"><a href="#äº”-æ„é€ å™¨" class="headerlink" title="äº”.æ„é€ å™¨"></a>äº”.æ„é€ å™¨</h2><p><strong>ä¸å¸¦ä»¥0ä¸ºé»˜è®¤å‚æ•°çš„æ„é€ å™¨</strong></p><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">namespace ConstructExample{    class Program    {        static void Main(string[]args)        {            Student stu = new Student;            Console.WriteLine(stu.ID);            Console.WriteLine(stu.Name);        }    }    class Student    {        //ä¸å¸¦å‚æ•°çš„æ„é€ ä½“    public Student()        {            this.ID = 1;            this.Name = "No name";        }        //        public int ID;        public string Name;    }}//1//No Name<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>å¼ºåˆ¶ç¨‹åºå‘˜ç»™æ„é€ å™¨è®¾ç½®å‚æ•°</strong>ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹å¦‚æœä¸æƒ³è®¾ç½®å‚æ•°ä½†æ˜¯è¦è°ƒç”¨è¯¥æ–¹æ³•ï¼Œå°±éœ€è¦è‡ªå®šä¹‰ä¸€ä¸ªé»˜è®¤å‚æ•°ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤º</p><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">namespace ConstructExample{    class Program    {        static void Main(string[]args)        {            Student stu = new Student(1,"No name");//ä¸èƒ½å†å†™æˆnew Student();            Console.WriteLine(stu.ID);            Console.WriteLine(stu.Name);        }    }    class Student    {        //ä¸å¸¦å‚æ•°çš„æ„é€ ä½“    public Student(int initId,string initName)        {            this.ID = initId;            this.Name = initName;        }        //        public int ID;        public string Name;    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>æ„é€ å™¨å¿«æ·é”®ï¼šctor+tab*2</strong>ctor=Code snippet(å°ç‰‡æ®µ)</p><h4 id="é‡è½½"><a href="#é‡è½½" class="headerlink" title="é‡è½½"></a>é‡è½½</h4><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">class Calculator{    //â‘     public double Add(int a, int b)    {        return a + b;    }    //â‘¡    public int Add(int a, int b)    {        return a + b;    }    â‘¢    public double Add(int a, int b, int c)    {        return a + b + c;    } }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ğŸ‘†â‘ ä¸â‘¡ä¸èƒ½å…±å­˜ï¼Œé‡è½½ä¸æ–¹æ³•çš„ç±»å‹æ— å…³</p><p>â‘ å’Œâ‘¢ã€â‘¡å’Œâ‘¢å¯å…±å­˜</p><h2 id="è°ƒç”¨æ–¹æ³•å®é™…ä¸Šæ˜¯å‹æ ˆçš„è¿‡ç¨‹"><a href="#è°ƒç”¨æ–¹æ³•å®é™…ä¸Šæ˜¯å‹æ ˆçš„è¿‡ç¨‹" class="headerlink" title="è°ƒç”¨æ–¹æ³•å®é™…ä¸Šæ˜¯å‹æ ˆçš„è¿‡ç¨‹"></a>è°ƒç”¨æ–¹æ³•å®é™…ä¸Šæ˜¯å‹æ ˆçš„è¿‡ç¨‹</h2>]]></content>
      
      
      <categories>
          
          <category> C# </category>
          
      </categories>
      
      
        <tags>
            
            <tag> é—²ç€æ²¡äº‹å¹² </tag>
            
            <tag> C# </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç±»å’Œå‘½åç©ºé—´</title>
      <link href="/2023/01/10/lei-he-ming-ming-kong-jian/"/>
      <url>/2023/01/10/lei-he-ming-ming-kong-jian/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€-ç±»"><a href="#ä¸€-ç±»" class="headerlink" title="ä¸€.ç±»"></a>ä¸€.ç±»</h2><p>æ˜¯å¯¹<code>ç°å®ä¸–ç•Œäº‹ç‰©</code>è¿›è¡Œ<strong>æŠ½è±¡</strong>æ‰€å¾—åˆ°çš„ç»“æœ</p><h4 id="1-ç±»å’Œå¯¹è±¡çš„å…³ç³»ğŸ‘‡"><a href="#1-ç±»å’Œå¯¹è±¡çš„å…³ç³»ğŸ‘‡" class="headerlink" title="1.ç±»å’Œå¯¹è±¡çš„å…³ç³»ğŸ‘‡"></a>1.ç±»å’Œå¯¹è±¡çš„å…³ç³»ğŸ‘‡</h4><ul><li><p><code>å¯¹è±¡</code>ä¹Ÿå«<code>å®ä¾‹</code>ï¼Œæ˜¯<code>ç±»</code>ç»è¿‡â€œå®ä¾‹åŒ–â€åå¾—åˆ°çš„å†…å­˜ä¸­æ˜¯å®ä½“</p><ul><li>e.g. â€œé£æœºâ€å’Œâ€œä¸€æ¶é£æœºâ€ï¼Œå‰è€…æ˜¯æ¦‚å¿µï¼Œåè€…æ˜¯å®ä½“</li><li>e.g. è“å›¾å’Œå»ºç­‘</li></ul></li><li><p><code>å®ä¾‹åŒ–</code>ï¼Œä½¿ç”¨<code>new</code>æ“ä½œç¬¦åˆ›å»ºç±»çš„å®ä¾‹</p><ul><li><pre><code class="c#">new + ç±»å();//å®ä¾‹åŒ–æ ¼å¼<pre class="line-numbers language-none"><code class="language-none">* ```c#  (new Form()).ShowDialog();//å®ä¾‹åŒ–ä¾‹å­<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></code></pre></li></ul></li><li><p>å¼•ç”¨å˜é‡ä¸å®ä¾‹çš„å…³ç³»</p><ul><li><pre><code class="c#"></code></pre></li></ul><p>  Form myForm;//å¼•ç”¨å˜é‡å°æœ‹å‹<br>  myForm = new Form();//å®ä¾‹åŒ– =å°æœ‹å‹ç‰µç€æ°”çƒ<br>  myForm.Text = â€œMy Form!â€;//æ ‡é¢˜æ–‡æœ¬<br>  myForm.ShowDialog();//æ˜¾ç¤ºè¡¨å•</p><pre><code>* å¼•ç”¨å˜é‡ä¸å®ä¾‹çš„å…³ç³»å¯ä»¥è§†ä½œå°æœ‹å‹å’Œæ°”çƒçš„å…³ç³»</code></pre></li></ul><h4 id="2-ç±»çš„ä¸‰å¤§æˆå‘˜"><a href="#2-ç±»çš„ä¸‰å¤§æˆå‘˜" class="headerlink" title="2.ç±»çš„ä¸‰å¤§æˆå‘˜"></a>2.ç±»çš„ä¸‰å¤§æˆå‘˜</h4><ul><li><strong>å±æ€§Property</strong><ul><li>å­˜å‚¨æ•°æ®ï¼Œç»„åˆèµ·æ¥è¡¨ç¤ºç±»æˆ–å¯¹è±¡å½“å‰çš„çŠ¶æ€</li><li>e.g. èº«é«˜å¾ˆé«˜ï¼Œè´¢å¯Œå……è£•ï¼Œé•¿ç›¸ä¸é”™ï¼Œç»„åˆä¸ºé«˜å¯Œå¸…</li></ul></li><li><strong>æ–¹æ³•Method</strong><ul><li>è¡¨ç¤ºç±»æˆ–å¯¹è±¡â€œèƒ½åšä»€ä¹ˆâ€</li></ul></li><li><strong>äº‹ä»¶Event</strong></li></ul><h3 id="3-é™æ€æˆå‘˜ä¸å®ä¾‹æˆå‘˜"><a href="#3-é™æ€æˆå‘˜ä¸å®ä¾‹æˆå‘˜" class="headerlink" title="3.é™æ€æˆå‘˜ä¸å®ä¾‹æˆå‘˜"></a>3.é™æ€æˆå‘˜ä¸å®ä¾‹æˆå‘˜</h3><ul><li><strong>é™æ€Static</strong>æˆå‘˜è¡¨ç¤ºå®ƒæ˜¯<code>ç±»çš„æˆå‘˜</code></li><li><strong>å®ä¾‹</strong>æˆå‘˜è¡¨ç¤ºå®ƒæ˜¯<code>å¯¹è±¡çš„æˆå‘˜</code></li><li><strong>ç»‘å®šBing</strong>æŒ‡çš„æ˜¯ç¼–è¯‘å™¨å¦‚ä½•æŠŠä¸€ä¸ªæˆå‘˜ä¸ç±»æˆ–å¯¹è±¡å…³è”èµ·æ¥<ul><li>**.**æˆå‘˜è®¿é—®æ“ä½œç¬¦</li></ul></li></ul><h2 id="äºŒ-åç§°ç©ºé—´"><a href="#äºŒ-åç§°ç©ºé—´" class="headerlink" title="äºŒ.åç§°ç©ºé—´"></a>äºŒ.åç§°ç©ºé—´</h2><p>æŠŠç±»ç”¨è‰¯å¥½çš„ç»“æ„ç»„åˆåœ¨ä¸€èµ·ï¼Œä»¥æ ‘å½¢ç»“æ„ç»„ç»‡ç±»</p><p><strong>åŒ…ï¼šæŸå¸‚â†’ç±»åº“ï¼šå›¾ä¹¦é¦†â†’åç§°ç©ºé—´ï¼šä¹¦æ¶â†’ç±»ï¼šä¹¦â†’æ–¹æ³•ï¼šç›®å½•</strong></p><h2 id="ä¸‰-ç±»åº“"><a href="#ä¸‰-ç±»åº“" class="headerlink" title="ä¸‰.ç±»åº“"></a>ä¸‰.ç±»åº“</h2><p>ç±»åº“çš„å¼•ç”¨</p><ul><li><p>DLLå¼•ç”¨(æ— æºä»£ç ï¼Œé»‘ç›’ç±»åº“)</p><ul><li><p>åœ¨<strong>è§£å†³æ–¹æ¡ˆ</strong>ä¸­çš„<strong>ä¾èµ–é¡¹</strong>å³é”®<strong>æ·»åŠ é¡¹ç›®å¼•ç”¨</strong>ä¸­å¯ä»¥æ·»åŠ ä»¥<code>dll</code>ä¸ºåç¼€çš„æ–‡ä»¶ä½œä¸ºç±»åº“å¼•ç”¨</p></li><li><p>NuGet</p><ul><li>åªæœ‰DLLæ²¡æœ‰æºä»£ç å¾ˆå±é™©ï¼Œæ¯”å¦‚å¼•ç”¨äº†ä¸€ä¸ª<code>ç±»åº“</code>ï¼Œä½†æ˜¯è¿™ä¸ª<code>ç±»åº“</code>ä¸­ä¸€äº›ä»£ç è¿˜æœ‰ä¸€äº›<code>åº•å±‚çš„ä¸œè¥¿</code>æ²¡æœ‰å¼•ç”¨è¿›æ¥å¯¼è‡´æŠ¥é”™</li></ul></li></ul></li><li><p>é¡¹ç›®å¼•ç”¨(æœ‰æºä»£ç ï¼Œç™½ç›’ç±»åº“)</p><ul><li>åŒä¸Šï¼Œä½†æ˜¯æ˜¯åœ¨<code>ç¨‹åºé›†ä¸­</code></li></ul></li></ul><p><img src="/../../../../medias/blog_picture/C#/1.png"></p>]]></content>
      
      
      <categories>
          
          <category> C# </category>
          
      </categories>
      
      
        <tags>
            
            <tag> é—²ç€æ²¡äº‹å¹² </tag>
            
            <tag> C# </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AT24C02</title>
      <link href="/2022/11/27/at24c02/"/>
      <url>/2022/11/27/at24c02/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-å­˜å‚¨å™¨ä»‹ç»"><a href="#ä¸€-å­˜å‚¨å™¨ä»‹ç»" class="headerlink" title="ä¸€.å­˜å‚¨å™¨ä»‹ç»"></a>ä¸€.å­˜å‚¨å™¨ä»‹ç»</h1><h2 id="1-æ˜“å¤±æ€§å­˜å‚¨å™¨-RAM"><a href="#1-æ˜“å¤±æ€§å­˜å‚¨å™¨-RAM" class="headerlink" title="1.æ˜“å¤±æ€§å­˜å‚¨å™¨/RAM"></a>1.æ˜“å¤±æ€§å­˜å‚¨å™¨/RAM</h2><p>å…¨ç§°ï¼šRamdomAccessMemory</p><p>ç™¾åº¦ç™¾ç§‘ï¼š<strong>å®ƒåœ¨ä»»ä½•æ—¶å€™éƒ½å¯ä»¥è¯»å†™</strong>ï¼ŒRAMé€šå¸¸æ˜¯ä½œä¸ºæ“ä½œç³»ç»Ÿæˆ–å…¶ä»–æ­£åœ¨è¿è¡Œç¨‹åºçš„ä¸´æ—¶å­˜å‚¨ä»‹è´¨(å¯ç§°ä½œç³»ç»Ÿå†…å­˜)ã€‚ä¸è¿‡ï¼Œ<strong>å½“ç”µæºå…³é—­æ—¶RAMä¸èƒ½ä¿ç•™æ•°æ®</strong>ï¼Œå¦‚æœéœ€è¦ä¿å­˜æ•°æ®ï¼Œå°±å¿…é¡»æŠŠå®ƒä»¬å†™å…¥åˆ°ä¸€ä¸ª<strong>é•¿æœŸçš„å­˜å‚¨å™¨</strong>(å¦‚ç¡¬ç›˜)ä¸­ã€‚</p><p>â‘ SRAM(é™æ€RAM) steady</p><ul><li>ç”¨ç”µè·¯å‚¨å­˜ï¼ŒCPUç”¨åˆ°ï¼Œé€Ÿåº¦æœ€å¿«ï¼Œå®¹é‡å°</li></ul><p>â‘¡DRAM(åŠ¨æ€RAM)</p><ul><li>ç”¨ç”µå®¹å……æ”¾ç”µçš„é«˜ä½ç”µå¹³æ¥å­˜å‚¨ï¼Œé€šå¸¸é…ä¸€ä¸ªæ‰«æç”µè·¯ï¼Œç»™å®ƒè¡¥ç”µ</li></ul><h2 id="2-éæ˜“å¤±æ€§å­˜å‚¨å™¨-ROM"><a href="#2-éæ˜“å¤±æ€§å­˜å‚¨å™¨-ROM" class="headerlink" title="2.éæ˜“å¤±æ€§å­˜å‚¨å™¨/ROM"></a>2.éæ˜“å¤±æ€§å­˜å‚¨å™¨/ROM</h2><p>å…¨ç§°ï¼šnon-volatile memory</p><p>ç™¾åº¦ç™¾ç§‘ï¼šæ˜¯æŒ‡å½“<strong>ç”µæµå…³æ‰å</strong>ï¼Œ<strong>æ‰€å­˜å‚¨çš„æ•°æ®ä¸ä¼šæ¶ˆå¤±</strong>çš„ç”µè„‘å­˜å‚¨å™¨ï¼Œç¼ºç‚¹æ˜¯å­˜å‚¨æ¯”è¾ƒæ…¢</p><p>â‘ Mask ROMï¼ˆæ©è†œROMï¼‰ï¼šåªè¯»ä¸å†™</p><p><img src="/../../../../medias/blog_picture/51/67.png"></p><p>â‘¡PROM(å¯ç¼–ç¨‹ROM)ï¼šåªèƒ½å†™ä¸€æ¬¡</p><p><img src="/../../../../medias/blog_picture/51/68.png"></p><ul><li>ç¼–ç¨‹æ—¶å·¦è¾¹ç»™é«˜ç”µå¹³ã€ä¸‹è¾¹ç»™0å¯ä»¥æŠŠè“è‰²çš„äºŒæç®¡<strong>å‡»ç©¿</strong>ï¼Œå®ç°å¯å†™ï¼Œæ‰€ä»¥ä¹Ÿå«<strong>çƒ§å½•ç¨‹åº</strong>å“ˆå“ˆ</li></ul><p>â‘¢EPROM(å¯æ“¦é™¤å¯ç¼–ç¨‹ROM)ï¼šå¯å†™</p><p>â‘£E2PROM(ç”µå¯æ“¦é™¤å¯ç¼–ç¨‹ROM)ï¼š5Vå‡ æ¯«ç§’å°±èƒ½æ“¦é™¤</p><p>â‘¤Flash(å†…å­˜)ï¼š</p><p>â‘¥ç¡¬ç›˜ã€è½¯ç›˜ã€å…‰ç›˜ç­‰ï¼šé€šè¿‡ç£ä»‹è´¨ä¼ é€’</p><h1 id="äºŒ-AT24C02ä»‹ç»"><a href="#äºŒ-AT24C02ä»‹ç»" class="headerlink" title="äºŒ.AT24C02ä»‹ç»"></a>äºŒ.AT24C02ä»‹ç»</h1><p><img src="/../../../../medias/blog_picture/51/69.png"></p><h1 id="ä¸‰-I2C"><a href="#ä¸‰-I2C" class="headerlink" title="ä¸‰.I2C"></a>ä¸‰.I2C</h1><p><img src="/../../../../medias/blog_picture/51/70.png"></p><h2 id="1-èµ·å§‹-ç»ˆæ­¢"><a href="#1-èµ·å§‹-ç»ˆæ­¢" class="headerlink" title="1.èµ·å§‹&amp;ç»ˆæ­¢"></a>1.èµ·å§‹&amp;ç»ˆæ­¢</h2><p><img src="/../../../../medias/blog_picture/51/71.png"></p><h2 id="2-å‘é€-æ¥å—å­—èŠ‚"><a href="#2-å‘é€-æ¥å—å­—èŠ‚" class="headerlink" title="2.å‘é€/æ¥å—å­—èŠ‚"></a>2.å‘é€/æ¥å—å­—èŠ‚</h2><p><img src="/../../../../medias/blog_picture/51/72.png"></p><p><img src="/../../../../medias/blog_picture/51/73.png"></p><p>ğŸ‘†æ³¨æ„ä¸»æœºå’Œä»æœºï¼Œåœ¨SDAä¸­ç´«è‰²æ˜¯ä»æœºï¼Œé»‘è‰²æ˜¯ä¸»æœº</p><p>åº”ç­”å¯ä»¥ä½œä¸ºç¬¬ä¹ä½</p><ul><li>ä¸»æœºé‡Šæ”¾äº†SDA**(ç»™SDAç½®1)**å˜æˆé«˜ç”µå¹³ï¼ŒæŠŠæ§åˆ¶æƒç»™ä»æœº</li><li>æ­¤æ—¶ä»æœºå¯ä»¥æ“æ§å‘1æˆ–å‘0</li><li>å½“SCLæ‹‰ä½ï¼Œä»æœºè‡ªåŠ¨å°†ä¸‹ä¸€ä½æ•°æ®æ”¾åˆ°æ€»çº¿ä¸Š</li></ul><h2 id="3-å‘é€-æ¥æ”¶åº”ç­”"><a href="#3-å‘é€-æ¥æ”¶åº”ç­”" class="headerlink" title="3.å‘é€/æ¥æ”¶åº”ç­”"></a>3.å‘é€/æ¥æ”¶åº”ç­”</h2><p><img src="/../../../../medias/blog_picture/51/74.png"></p><p>åº”ç­”å¯ä»¥ä½œä¸ºæ•°æ®çš„ç¬¬ä¹ä½</p><p>ç”¨æ¥åˆ¤æ–­ä»æœºæ˜¯å¦åº”ç­”æˆ–è€…ä¸»æœºæ˜¯å¦å‘é€åº”ç­”</p><p><img src="/../../../../medias/blog_picture/51/75.png"></p><p>å‘œå‘œå‘œå‘œå‘œå‘œå‘œå‘œå‘œå‘œ<strong>ä»1ï¼š15ï¼š21å¼€å§‹ï¼Œä»£ç ä¸èƒ½æ­£å¸¸è¿è¡Œ</strong>å‘œå‘œå‘œå‘œå‘œå‘œå‘œå‘œå‘œå‘œæ”¾å¼ƒäº†æ”¾å¼ƒäº†</p><h1 id="å››-å­¦åˆ°äº†å•¥"><a href="#å››-å­¦åˆ°äº†å•¥" class="headerlink" title="å››.å­¦åˆ°äº†å•¥"></a>å››.å­¦åˆ°äº†å•¥</h1><hr><p>æ„Ÿè§‰æ¯”è¾ƒæœ‰ç”¨çš„æ˜¯åœ¨å®šæ—¶å™¨é‡Œè°ƒç”¨å‡½æ•°ï¼ŒåŒæ—¶å¯¹ä¸åŒæ¨¡å—å‡½æ•°è®¡æ—¶</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">Timer0_Routine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> interrupt <span class="token number">1</span><span class="token punctuation">{</span><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> T0Count1<span class="token punctuation">,</span>T0Count2<span class="token punctuation">;</span>TL0 <span class="token operator">=</span> <span class="token number">0x18</span><span class="token punctuation">;</span><span class="token comment">//è®¾ç½®å®šæ—¶åˆå€¼</span>TH0 <span class="token operator">=</span> <span class="token number">0xFC</span><span class="token punctuation">;</span><span class="token comment">//è®¾ç½®å®šæ—¶åˆå€¼</span>T0Count1<span class="token operator">++</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>T0Count1<span class="token operator">&gt;=</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token comment">//20msè¿”å›ä¸€æ¬¡1æˆ–0</span><span class="token comment">//é€šè¿‡è®°å½•ä¸Šä¸€æ¬¡å’Œè¿™ä¸€æ¬¡çš„è¿”å›å€¼åˆ¤æ–­æ˜¯æŒ‰ä¸‹è¿˜æ˜¯æ¾å¼€</span><span class="token punctuation">{</span>T0Count1<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token function">Key_Loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è¿™æ—¶å€™Keyå‡½æ•°æ— ä¸­ç”Ÿæœ‰ï¼Œæœ‰äº†è‡ªå·±çš„ä¸­æ–­</span><span class="token punctuation">}</span>T0Count2<span class="token operator">++</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>T0Count2<span class="token operator">&gt;=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>T0Count2<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token function">Nixie_Loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>Key_Loop</strong>   <strong>Nixie_Loop</strong></p><p>åªéœ€è¦æ”¹å˜T0Count&gt;=xå°±å¯ä»¥æœ‰é’ˆå¯¹çš„è®¡æ—¶</p><p>è¿™ä¸ªloopå‡½æ•°ç›¸å½“äºç»•äº†ä¸€ä¸ªåœˆæŠŠå­å‡½æ•°è°ƒç”¨äº†ä¸€æ¬¡ï¼Œä½†æ˜¯èµ·ç èµ·åˆ°äº†è®¡æ—¶çš„ä½œç”¨</p>]]></content>
      
      
      
        <tags>
            
            <tag> 51å•ç‰‡æœº </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é˜Ÿåˆ—</title>
      <link href="/2022/11/22/dui-lie/"/>
      <url>/2022/11/22/dui-lie/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-æ¦‚å¿µ"><a href="#ä¸€-æ¦‚å¿µ" class="headerlink" title="ä¸€.æ¦‚å¿µ"></a>ä¸€.æ¦‚å¿µ</h1><h2 id="1-å‰front-årear"><a href="#1-å‰front-årear" class="headerlink" title="1.å‰front årear"></a>1.å‰front årear</h2><ul><li><p>å‡ºé˜Ÿï¼Œä»å¤´å‡º</p></li><li><p>å…¥é˜Ÿï¼Œä»å°¾å…¥</p></li></ul><h2 id="2-åˆ†ç±»"><a href="#2-åˆ†ç±»" class="headerlink" title="2.åˆ†ç±»"></a>2.åˆ†ç±»</h2><p>é“¾å¼é˜Ÿåˆ—ï¼Œé™æ€é˜Ÿåˆ—ï¼Œå¾ªç¯é˜Ÿåˆ—</p><ul><li>é“¾å¼é˜Ÿåˆ—â€“ç”¨é“¾è¡¨å®ç°</li><li>é™æ€é˜Ÿåˆ—â€“ç”¨æ•°ç»„å®ç°ï¼Œé€šå¸¸éƒ½å¿…é¡»æ˜¯å¾ªç¯é˜Ÿåˆ—</li></ul><h2 id="3-é—®é¢˜"><a href="#3-é—®é¢˜" class="headerlink" title="3.é—®é¢˜"></a>3.é—®é¢˜</h2><h3 id="â‘ é™æ€é˜Ÿåˆ—ä¸ºä»€ä¹ˆå¿…é¡»æ˜¯å¾ªç¯é˜Ÿåˆ—"><a href="#â‘ é™æ€é˜Ÿåˆ—ä¸ºä»€ä¹ˆå¿…é¡»æ˜¯å¾ªç¯é˜Ÿåˆ—" class="headerlink" title="â‘ é™æ€é˜Ÿåˆ—ä¸ºä»€ä¹ˆå¿…é¡»æ˜¯å¾ªç¯é˜Ÿåˆ—"></a>â‘ é™æ€é˜Ÿåˆ—ä¸ºä»€ä¹ˆ<strong>å¿…é¡»æ˜¯å¾ªç¯é˜Ÿåˆ—</strong></h3><p>râ†’râ†’</p><p>â€‹dd</p><p>â€‹cfâ†’c</p><p>â€‹b==&gt;  b</p><p>fâ†’   a a</p><p>ğŸ‘†aå’Œbå‡ºé˜Ÿä¹‹åï¼Œå¯¹äºæ•°ç»„aæ¥è¯´ï¼Œa[0]ã€a[1]è¿™ä¸¤ä¸ªç©ºé—´å°±è¢«æµªè´¹äº†ï¼Œå› ä¸ºfå’Œrä¸€ç›´åœ¨å¾€ä¸Šç§»åŠ¨ï¼Œæ‰€ä»¥ç›¸å½“äºa[0]ã€a[1]ä¸èƒ½å†ä½¿ç”¨äº†ã€‚ç”¨ä¼ ç»Ÿæ•°ç»„æ¥å®ç°é˜Ÿåˆ—ï¼Œæ— è®ºæ˜¯å…¥é˜Ÿè¿˜æ˜¯å‡ºé˜Ÿï¼Œå‚æ•°éƒ½åªèƒ½å¢ä¸èƒ½å‡</p><h3 id="â‘¡å¾ªç¯é˜Ÿåˆ—éœ€è¦å‡ ä¸ªå‚æ•°åŠå„ä¸ªå‚æ•°çš„å«ä¹‰"><a href="#â‘¡å¾ªç¯é˜Ÿåˆ—éœ€è¦å‡ ä¸ªå‚æ•°åŠå„ä¸ªå‚æ•°çš„å«ä¹‰" class="headerlink" title="â‘¡å¾ªç¯é˜Ÿåˆ—éœ€è¦å‡ ä¸ªå‚æ•°åŠå„ä¸ªå‚æ•°çš„å«ä¹‰"></a>â‘¡å¾ªç¯é˜Ÿåˆ—éœ€è¦<strong>å‡ ä¸ªå‚æ•°</strong>åŠå„ä¸ª<strong>å‚æ•°çš„å«ä¹‰</strong></h3><ul><li><p>éœ€è¦<strong>2ä¸ª</strong>å‚æ•°æ¥ç¡®å®š <strong>front</strong> <strong>rear</strong></p></li><li><p>2ä¸ªå‚æ•°åœ¨ä¸åŒåœºåˆæœ‰<strong>ä¸åŒçš„çš„å®šä¹‰</strong></p><ul><li><p>åœºåˆï¼š</p><blockquote><p> 1ï¼‰é˜Ÿåˆ—åˆå§‹åŒ–</p><p>â€‹frontå’Œrearçš„å€¼éƒ½æ˜¯<strong>é›¶</strong></p><p>2ï¼‰é˜Ÿåˆ—éç©º</p><p>â€‹frontä»£è¡¨çš„æ˜¯é˜Ÿåˆ—çš„<strong>ç¬¬ä¸€ä¸ªå…ƒç´ </strong></p><p>â€‹rearä»£è¡¨çš„æ˜¯é˜Ÿåˆ—çš„<strong>æœ€åä¸€ä¸ªæœ‰æ•ˆå…ƒç´ çš„ä¸‹ä¸€ä¸ª</strong></p><p>3ï¼‰é˜Ÿåˆ—ç©º</p><p>â€‹frontå’Œrearçš„<strong>å€¼ç›¸ç­‰</strong>ï¼Œä½†ä¸ä¸€å®šæ˜¯é›¶</p></blockquote></li></ul></li></ul><h3 id="â‘¢å¾ªç¯é˜Ÿåˆ—å‡ºã€å…¥é˜Ÿä¼ªç®—æ³•è®²è§£"><a href="#â‘¢å¾ªç¯é˜Ÿåˆ—å‡ºã€å…¥é˜Ÿä¼ªç®—æ³•è®²è§£" class="headerlink" title="â‘¢å¾ªç¯é˜Ÿåˆ—å‡ºã€å…¥é˜Ÿä¼ªç®—æ³•è®²è§£"></a>â‘¢å¾ªç¯é˜Ÿåˆ—<strong>å‡ºã€å…¥é˜Ÿä¼ªç®—æ³•</strong>è®²è§£</h3><h4 id="1-å…¥é˜Ÿ"><a href="#1-å…¥é˜Ÿ" class="headerlink" title="1.å…¥é˜Ÿ"></a>1.å…¥é˜Ÿ</h4><ul><li><p>å°†å€¼å­˜å…¥ræ‰€ä»£è¡¨çš„ä½ç½®</p></li><li><p>r=(r+1)%æ•°ç»„çš„é•¿åº¦</p></li></ul><h4 id="2-å‡ºé˜Ÿ"><a href="#2-å‡ºé˜Ÿ" class="headerlink" title="2.å‡ºé˜Ÿ"></a>2.å‡ºé˜Ÿ</h4><ul><li>f=(f+1)%æ•°ç»„çš„é•¿åº¦</li></ul><h3 id="â‘£å¦‚ä½•åˆ¤æ–­å¾ªç¯é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºã€å·²æ»¡"><a href="#â‘£å¦‚ä½•åˆ¤æ–­å¾ªç¯é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºã€å·²æ»¡" class="headerlink" title="â‘£å¦‚ä½•åˆ¤æ–­å¾ªç¯é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºã€å·²æ»¡"></a>â‘£å¦‚ä½•åˆ¤æ–­å¾ªç¯é˜Ÿåˆ—æ˜¯å¦ä¸º<strong>ç©ºã€å·²æ»¡</strong></h3><h4 id="1-ç©º"><a href="#1-ç©º" class="headerlink" title="1.ç©º"></a>1.ç©º</h4><ul><li>f=r</li></ul><h4 id="2-æ»¡"><a href="#2-æ»¡" class="headerlink" title="2.æ»¡"></a>2.æ»¡</h4><ul><li><p>â… å¤šå¢åŠ ä¸€ä¸ªæ ‡è¯†å‚æ•°(é€šå¸¸ä¸ç”¨è¿™ä¸ª)</p></li><li><p>â…¡å°‘ç”¨ä¸€ä¸ªå…ƒç´ ã€‚æœ¬æ¥å¯ä»¥æ”¾nä¸ªå…ƒç´ ï¼Œ<strong>å®šä¹‰n-1ä¸ªæ˜¯æ»¡çš„</strong>(é€šå¸¸ä½¿ç”¨è¿™ç§æ–¹å¼)</p><ul><li><p>å¦‚ä½•åˆ¤æ–­é˜Ÿåˆ—å·²æ»¡ï¼šrå’Œfçš„å€¼ç´§æŒ¨ç€ï¼Œåˆ™é˜Ÿåˆ—å·²æ»¡</p></li><li><pre><code class="c">if((r+1)%æ•°ç»„çš„é•¿åº¦==f)    //å·²æ»¡else    //ä¸æ»¡<pre class="line-numbers language-none"><code class="language-none"># äºŒ.ä»£ç ```c#include&lt;stdio.h&gt;#include&lt;stdbool.h&gt;#include&lt;malloc.h&gt;#include&lt;stdlib.h&gt;typedef struct Queue{int *pBase;int front;int rear;}QUEUE,*PQUEUE;void init(PQUEUE);//åˆå§‹åŒ– bool fullQueue(PQUEUE);//åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦æ»¡ bool enQueue(PQUEUE,int);//å…¥é˜Ÿ bool emptyQueue(PQUEUE);//åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºvoid traverse(PQUEUE);//éå†bool outQueue(PQUEUE,int*);//å‡ºé˜Ÿ int main(){//int val;int *pVal=(int*)malloc(sizeof(int)*4); QUEUE Q;init(&amp;Q);enQueue(&amp;Q,1);enQueue(&amp;Q,2);enQueue(&amp;Q,3);enQueue(&amp;Q,4);enQueue(&amp;Q,5);enQueue(&amp;Q,6);enQueue(&amp;Q,7);traverse(&amp;Q);if(outQueue(&amp;Q,pVal))printf("å‡ºé˜Ÿçš„æ•°å­—æ˜¯:%d\n",*pVal);//if (outQueue(&amp;Q,&amp;val))//printf("å‡ºé˜Ÿçš„æ•°å­—æ˜¯%d\n",val);elseprintf("å‡ºé˜Ÿå¤±è´¥ï¼\n"); traverse(&amp;Q);free(pVal);pVal=NULL;return 0;}void init(PQUEUE pQ){pQ-&gt;pBase=(int*)malloc(sizeof(int)*6);pQ-&gt;front=0;pQ-&gt;rear=0;}bool fullQueue(PQUEUE pQ){if((pQ-&gt;rear+1)%6==pQ-&gt;front)return true;elsereturn false;}bool enQueue(PQUEUE pQ,int val){if(fullQueue(pQ))return false;else{pQ-&gt;pBase[pQ-&gt;rear]=val;pQ-&gt;rear=(pQ-&gt;rear+1)%6;}}bool emptyQueue(PQUEUE pQ){if(pQ-&gt;rear==pQ-&gt;front)return true;elsereturn false;}void traverse(PQUEUE pQ){if(emptyQueue(pQ)){printf("é˜Ÿåˆ—ä¸ºç©º\n");exit(-1);}else{int i=pQ-&gt;front;while(pQ-&gt;rear!=i){printf("%d",pQ-&gt;pBase[i]); i=(i+1)%6;}printf("\n");}return;}bool outQueue(PQUEUE pQ,int *pVal){if(emptyQueue(pQ))return false;else{*pVal=pQ-&gt;pBase[pQ-&gt;front];pQ-&gt;front=(pQ-&gt;front+1)%6;return true;}}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></code></pre></li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> Cè¯­è¨€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Cè¯­è¨€ </tag>
            
            <tag> é˜Ÿåˆ— </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ ˆ</title>
      <link href="/2022/11/20/zhan/"/>
      <url>/2022/11/20/zhan/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-æ ˆå’Œå †"><a href="#ä¸€-æ ˆå’Œå †" class="headerlink" title="ä¸€.æ ˆå’Œå †"></a>ä¸€.æ ˆå’Œå †</h1><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">double</span> <span class="token operator">*</span>q<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>*q</strong>å°±æ˜¯<strong>æ ˆ</strong>é‡Œçš„ï¼Œ<strong>200</strong>æ˜¯å †é‡Œçš„</p><p>åŠ¨æ€åˆ†é…çš„éƒ½åœ¨å †é‡Œåˆ†é…ï¼Œç”±ç¨‹åºå‘˜æ‰‹åŠ¨åˆ†é…</p><p>é™æ€åˆ†é…çš„éƒ½åœ¨æ ˆé‡Œåˆ†é…ï¼Œç”±ç³»ç»Ÿè‡ªåŠ¨åˆ†é…</p><h2 id="æ ˆï¼š"><a href="#æ ˆï¼š" class="headerlink" title="æ ˆï¼š"></a>æ ˆï¼š</h2><p>1.å®šä¹‰ï¼š</p><ul><li>å®ç°â€œå…ˆè¿›åå‡ºâ€çš„å­˜å‚¨ç»“æ„</li></ul><p>2.åˆ†ç±»ï¼š</p><ul><li>é™æ€æ ˆ </li><li>åŠ¨æ€æ ˆï¼šå†…æ ¸å°±æ˜¯é“¾è¡¨</li></ul><p>3.ç®—æ³•</p><ul><li>å‡ºæ ˆ</li><li>å‹æ ˆ</li></ul><p>4.å˜é‡</p><ul><li>pTop</li><li>pBottom</li></ul><p><strong>æ ˆç©º</strong>ï¼špTop==pBottom</p><p>5.åº”ç”¨</p><ul><li>å‡½æ•°è°ƒç”¨</li><li>ä¸­æ–­</li><li>è¡¨è¾¾å¼æ±‚å€¼</li><li>å†…å­˜åˆ†é…</li><li>ç¼“å†²å¤„ç†</li><li>è¿·å®«</li></ul><h1 id="äºŒ-ä»£ç "><a href="#äºŒ-ä»£ç " class="headerlink" title="äºŒ.ä»£ç "></a>äºŒ.ä»£ç </h1><h2 id="1-ä¸¤ä¸ªç»“æ„ä½“çš„çš„å®šä¹‰"><a href="#1-ä¸¤ä¸ªç»“æ„ä½“çš„çš„å®šä¹‰" class="headerlink" title="1.ä¸¤ä¸ªç»“æ„ä½“çš„çš„å®šä¹‰"></a>1.ä¸¤ä¸ªç»“æ„ä½“çš„çš„å®šä¹‰</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">Node</span><span class="token punctuation">{</span><span class="token keyword">int</span> data<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">Node</span> <span class="token operator">*</span>pNext<span class="token punctuation">;</span><span class="token punctuation">}</span>NODE<span class="token punctuation">,</span><span class="token operator">*</span>PNODE<span class="token punctuation">;</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">Stack</span><span class="token punctuation">{</span>PNODE pTop<span class="token punctuation">;</span>PNODE pBottom<span class="token punctuation">;</span><span class="token punctuation">}</span>STACK<span class="token punctuation">,</span><span class="token operator">*</span>PSTACK<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ğŸ‘‰å¯¹äºStackçš„ç†è§£ï¼š</p><p>Stackè¿™ä¸ªç»“æ„ä½“é‡Œæœ‰ä¸¤ä¸ªæˆå‘˜â€”â€”<strong>åå­—å«pTopå’ŒpBottomã€ç±»å‹ä¸ºNODEæŒ‡é’ˆ</strong></p><h2 id="2-åˆå§‹åŒ–"><a href="#2-åˆå§‹åŒ–" class="headerlink" title="2.åˆå§‹åŒ–"></a>2.åˆå§‹åŒ–</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span>PSTACK pS<span class="token punctuation">)</span><span class="token comment">//ä¼ å‚ï¼šæ ˆçš„åœ°å€</span><span class="token punctuation">{</span>pS<span class="token operator">-&gt;</span>pTop<span class="token operator">=</span><span class="token punctuation">(</span>PNODE<span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>NODE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ç»™æ ˆé¡¶ç”³è¯·å†…å­˜ç©ºé—´</span><span class="token keyword">if</span><span class="token punctuation">(</span>pS<span class="token operator">-&gt;</span>pTop<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"å†…å­˜åˆ†é…å¤±è´¥ï¼\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>pS<span class="token operator">-&gt;</span>pBottom<span class="token operator">=</span>pS<span class="token operator">-&gt;</span>pTop<span class="token punctuation">;</span><span class="token comment">//æ­¤æ—¶pTå’ŒpBæŒ‡å‘åŒä¸€ä¸ªå†…å­˜</span>pS<span class="token operator">-&gt;</span>pTop<span class="token operator">-&gt;</span>pNext<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token comment">//è®©pTå’ŒpBæŒ‡å‘åŒä¸€ä¸ªèŠ‚ç‚¹ä¸”è¯¥èŠ‚ç‚¹çš„æŒ‡é’ˆåŸŸå­˜æ”¾çš„æ˜¯NULLï¼Œè¯¥èŠ‚ç‚¹ä½œä¸ºä¸€ä¸ªå¤´ç»“ç‚¹ã€‚</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-å‹æ ˆ"><a href="#3-å‹æ ˆ" class="headerlink" title="3.å‹æ ˆ"></a>3.å‹æ ˆ</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">push</span><span class="token punctuation">(</span>PSTACK pS<span class="token punctuation">,</span><span class="token keyword">int</span> val<span class="token punctuation">)</span><span class="token punctuation">{</span>PNODE pNew<span class="token operator">=</span><span class="token punctuation">(</span>PNODE<span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>NODE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä¸ºæ–°èŠ‚ç‚¹ç”³è¯·ç©ºé—´</span><span class="token keyword">if</span><span class="token punctuation">(</span>pNew<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"å†…å­˜åˆ†é…å¤±è´¥ï¼\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>pNew<span class="token operator">-&gt;</span>data<span class="token operator">=</span>val<span class="token punctuation">;</span>pNew<span class="token operator">-&gt;</span>pNext<span class="token operator">=</span>pS<span class="token operator">-&gt;</span>pTop<span class="token punctuation">;</span>pS<span class="token operator">-&gt;</span>pTop<span class="token operator">=</span>pNew<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-c" data-language="c"><code class="language-c">pNew<span class="token operator">-&gt;</span>pNext<span class="token operator">=</span>pS<span class="token operator">-&gt;</span>pTop<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ğŸ‘†ç†è§£ï¼š</p><p>ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œ**pNew-&gt;pNext=pS-&gt;pTop;<strong>å’Œ</strong>pNew-&gt;pNext=pS-&gt;pBottom;**éƒ½å¯ä»¥ <code>ç†è§£ä¸ºæ’å…¥çš„æ–°èŠ‚ç‚¹çš„æŒ‡é’ˆåŸŸå’ŒpTã€pBæ˜¯ä¸€æ ·çš„ï¼Œå³æŒ‡å‘ä¸€æ ·ï¼Œéƒ½æŒ‡å‘å¤´ç»“ç‚¹</code></p><p><strong>ä½†æ˜¯ä»ç¬¬äºŒä¸ªèŠ‚ç‚¹å¼€å§‹</strong>ï¼Œä»–çš„æŒ‡é’ˆåŸŸå­˜æ”¾çš„åº”è¯¥å¾—æ˜¯ä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„åœ°å€ï¼Œå¯¹åº”å›¾ä¸Šçš„å°±æ˜¯<code>å³è¾¹è“è‰²çš„ç®­å¤´åº”è¯¥==å·¦è¾¹è¢«è“è‰²xè¦†ç›–çš„çº¢è‰²ç®­å¤´</code>ï¼Œå³<strong>pNew-&gt;pNext=pS-&gt;pTop;</strong></p><h2 id="4-éå†"><a href="#4-éå†" class="headerlink" title="4.éå†"></a>4.éå†</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">traverse</span><span class="token punctuation">(</span>PSTACK pS<span class="token punctuation">)</span><span class="token punctuation">{</span>PNODE p<span class="token operator">=</span>pS<span class="token operator">-&gt;</span>pTop<span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>p<span class="token operator">!=</span>pS<span class="token operator">-&gt;</span>pBottom<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d "</span><span class="token punctuation">,</span>p<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> p<span class="token operator">=</span>p<span class="token operator">-&gt;</span>pNext<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="5-å‡ºæ ˆ"><a href="#5-å‡ºæ ˆ" class="headerlink" title="5.å‡ºæ ˆ"></a>5.å‡ºæ ˆ</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">pop</span><span class="token punctuation">(</span>PSTACK pS<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span>pS<span class="token operator">-&gt;</span>pTop<span class="token operator">==</span>pS<span class="token operator">-&gt;</span>pBottom<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"æ ˆä¸ºç©ºï¼\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>PNODE a<span class="token operator">=</span>pS<span class="token operator">-&gt;</span>pTop<span class="token punctuation">;</span>pS<span class="token operator">-&gt;</span>pTop<span class="token operator">=</span>pS<span class="token operator">-&gt;</span>pTop<span class="token operator">-&gt;</span>pNext<span class="token punctuation">;</span><span class="token function">free</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>a<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™ä¸ªåº”è¯¥ä¹Ÿå¾ˆå¥½ç†è§£ï¼šåˆ é™¤aæŒ‡å‘çš„èŠ‚ç‚¹ï¼ŒpTopè´Ÿè´£å¾€ä¸‹èµ°ï¼Œé˜²æ­¢å› ä¸ºåˆ æ‰ä¸Šé¢çš„èŠ‚ç‚¹è€Œä¸¢å¤±ä¸‹é¢çš„èŠ‚ç‚¹çš„åœ°å€</p><h2 id="6-æ¸…ç©º"><a href="#6-æ¸…ç©º" class="headerlink" title="6.æ¸…ç©º"></a>6.æ¸…ç©º</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span>PSTACK pS<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span>pS<span class="token operator">-&gt;</span>pTop<span class="token operator">==</span>pS<span class="token operator">-&gt;</span>pBottom<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"æ ˆä¸ºç©ºï¼\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>PNODE p<span class="token operator">=</span>pS<span class="token operator">-&gt;</span>pTop<span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>p<span class="token operator">!=</span>pS<span class="token operator">-&gt;</span>pBottom<span class="token punctuation">)</span><span class="token punctuation">{</span>pS<span class="token operator">-&gt;</span>pTop<span class="token operator">=</span>p<span class="token operator">-&gt;</span>pNext<span class="token punctuation">;</span><span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>p<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>p<span class="token operator">=</span>pS<span class="token operator">-&gt;</span>pTop<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¤§è‡´æ€è·¯å’Œå‡ºæ ˆç›¸ä¼¼ï¼Œå°±æ˜¯å¤šäº†ä¸ªå¾ªç¯ï¼Œå†è°ƒæ¢ä¸€ä¸‹è¯­å¥é¡ºåºå³å¯</p><h2 id="7-å®Œæ•´ä»£ç "><a href="#7-å®Œæ•´ä»£ç " class="headerlink" title="7.å®Œæ•´ä»£ç "></a>7.å®Œæ•´ä»£ç </h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;malloc.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdbool.h&gt;</span> </span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h&gt;</span></span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">Node</span><span class="token punctuation">{</span><span class="token keyword">int</span> data<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">Node</span> <span class="token operator">*</span>pNext<span class="token punctuation">;</span><span class="token punctuation">}</span>NODE<span class="token punctuation">,</span><span class="token operator">*</span>PNODE<span class="token punctuation">;</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">Stack</span><span class="token punctuation">{</span>PNODE pTop<span class="token punctuation">;</span>PNODE pBottom<span class="token punctuation">;</span><span class="token punctuation">}</span>STACK<span class="token punctuation">,</span><span class="token operator">*</span>PSTACK<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span>PSTACK<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">push</span><span class="token punctuation">(</span>PSTACK<span class="token punctuation">,</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">traverse</span><span class="token punctuation">(</span>PSTACK<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">pop</span><span class="token punctuation">(</span>PSTACK<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span>PSTACK<span class="token punctuation">)</span><span class="token punctuation">;</span>bool <span class="token function">empty</span><span class="token punctuation">(</span>PSTACK<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>STACK S<span class="token punctuation">;</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>S<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>S<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>S<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">traverse</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>S<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>S<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nå‡ºæ ˆåç»“æœä¸ºï¼›\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">traverse</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>S<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>S<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">traverse</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>S<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>S<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"æ¸…é™¤æˆåŠŸï¼\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">else</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"æ¸…é™¤å¤±è´¥ï¼\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span>PSTACK pS<span class="token punctuation">)</span><span class="token punctuation">{</span>pS<span class="token operator">-&gt;</span>pTop<span class="token operator">=</span><span class="token punctuation">(</span>PNODE<span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>NODE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>pS<span class="token operator">-&gt;</span>pTop<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"å†…å­˜åˆ†é…å¤±è´¥ï¼\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>pS<span class="token operator">-&gt;</span>pBottom<span class="token operator">=</span>pS<span class="token operator">-&gt;</span>pTop<span class="token punctuation">;</span>pS<span class="token operator">-&gt;</span>pTop<span class="token operator">-&gt;</span>pNext<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">push</span><span class="token punctuation">(</span>PSTACK pS<span class="token punctuation">,</span><span class="token keyword">int</span> val<span class="token punctuation">)</span><span class="token punctuation">{</span>PNODE pNew<span class="token operator">=</span><span class="token punctuation">(</span>PNODE<span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>NODE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>pNew<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"å†…å­˜åˆ†é…å¤±è´¥ï¼\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>pNew<span class="token operator">-&gt;</span>data<span class="token operator">=</span>val<span class="token punctuation">;</span>pNew<span class="token operator">-&gt;</span>pNext<span class="token operator">=</span>pS<span class="token operator">-&gt;</span>pTop<span class="token punctuation">;</span>pS<span class="token operator">-&gt;</span>pTop<span class="token operator">=</span>pNew<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">traverse</span><span class="token punctuation">(</span>PSTACK pS<span class="token punctuation">)</span><span class="token punctuation">{</span>PNODE p<span class="token operator">=</span>pS<span class="token operator">-&gt;</span>pTop<span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>p<span class="token operator">!=</span>pS<span class="token operator">-&gt;</span>pBottom<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d "</span><span class="token punctuation">,</span>p<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> p<span class="token operator">=</span>p<span class="token operator">-&gt;</span>pNext<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">pop</span><span class="token punctuation">(</span>PSTACK pS<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span>pS<span class="token operator">-&gt;</span>pTop<span class="token operator">==</span>pS<span class="token operator">-&gt;</span>pBottom<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"æ ˆä¸ºç©ºï¼\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>PNODE a<span class="token operator">=</span>pS<span class="token operator">-&gt;</span>pTop<span class="token punctuation">;</span>pS<span class="token operator">-&gt;</span>pTop<span class="token operator">=</span>pS<span class="token operator">-&gt;</span>pTop<span class="token operator">-&gt;</span>pNext<span class="token punctuation">;</span><span class="token function">free</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>a<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>bool <span class="token function">empty</span><span class="token punctuation">(</span>PSTACK pS<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span>pS<span class="token operator">-&gt;</span>pTop<span class="token operator">==</span>pS<span class="token operator">-&gt;</span>pBottom<span class="token punctuation">)</span><span class="token keyword">return</span> true<span class="token punctuation">;</span><span class="token keyword">else</span><span class="token keyword">return</span> false<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span>PSTACK pS<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span>pS<span class="token operator">-&gt;</span>pTop<span class="token operator">==</span>pS<span class="token operator">-&gt;</span>pBottom<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"æ ˆä¸ºç©ºï¼\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>PNODE p<span class="token operator">=</span>pS<span class="token operator">-&gt;</span>pTop<span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>p<span class="token operator">!=</span>pS<span class="token operator">-&gt;</span>pBottom<span class="token punctuation">)</span><span class="token punctuation">{</span>pS<span class="token operator">-&gt;</span>pTop<span class="token operator">=</span>p<span class="token operator">-&gt;</span>pNext<span class="token punctuation">;</span><span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>p<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>p<span class="token operator">=</span>pS<span class="token operator">-&gt;</span>pTop<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Cè¯­è¨€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Cè¯­è¨€ </tag>
            
            <tag> æ ˆ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é“¾è¡¨</title>
      <link href="/2022/11/18/lian-biao/"/>
      <url>/2022/11/18/lian-biao/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-typedef"><a href="#ä¸€-typedef" class="headerlink" title="ä¸€.typedef"></a>ä¸€.typedef</h1><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">Student</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> sid<span class="token punctuation">;</span>    <span class="token keyword">int</span> age<span class="token punctuation">;</span><span class="token punctuation">}</span>ST<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">Student</span> student<span class="token punctuation">;</span><span class="token comment">//&lt;==&gt;ST student;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">Student</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> sid<span class="token punctuation">;</span>    <span class="token keyword">int</span> age<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token operator">*</span>PST<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">Student</span> <span class="token operator">*</span>p<span class="token punctuation">;</span><span class="token comment">//&lt;==&gt;PST *p;</span><span class="token comment">//PST&lt;==&gt;struct Student *</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-C" data-language="C"><code class="language-C">typedef struct Student{    int sid;    int age;}*PST,ST;//æ•ˆæœæ˜¯ä¸Šé¢çš„æ•´åˆ<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="äºŒ-é“¾è¡¨"><a href="#äºŒ-é“¾è¡¨" class="headerlink" title="äºŒ.é“¾è¡¨"></a>äºŒ.é“¾è¡¨</h1><h2 id="1-å®šä¹‰"><a href="#1-å®šä¹‰" class="headerlink" title="1.å®šä¹‰"></a>1.å®šä¹‰</h2><ul><li>nä¸ªèŠ‚ç‚¹ç¦»æ•£åˆ†é…</li><li>æ‰¹æ¬¡é€šè¿‡æŒ‡é’ˆç›¸è¿</li><li>æ¯éš”èŠ‚ç‚¹åªæœ‰ä¸€ä¸ªå‰é©±èŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹åªæœ‰ä¸€ä¸ªåç»­èŠ‚ç‚¹</li><li>é¦–èŠ‚ç‚¹æ²¡æœ‰å‰é©±èŠ‚ç‚¹ï¼Œå°¾èŠ‚ç‚¹æ²¡æœ‰åç»­èŠ‚ç‚¹</li><li>[ç¦»æ•£å­˜å‚¨]</li></ul><h2 id="2-ä¸“ä¸šæœ¯è¯­"><a href="#2-ä¸“ä¸šæœ¯è¯­" class="headerlink" title="2.ä¸“ä¸šæœ¯è¯­"></a>2.ä¸“ä¸šæœ¯è¯­</h2><ul><li>é¦–èŠ‚ç‚¹ï¼šç¬¬ä¸€ä¸ªæœ‰æ•ˆçš„èŠ‚ç‚¹</li><li>å°¾èŠ‚ç‚¹ï¼šæœ€åä¸€ä¸ªæœ‰æ•ˆèŠ‚ç‚¹</li><li>å¤´ç»“ç‚¹ï¼šç¬¬ä¸€ä¸ªæœ‰æ•ˆèŠ‚ç‚¹ä¹‹å‰çš„èŠ‚ç‚¹<ul><li>æ²¡æœ‰å­˜æ”¾æœ‰æ•ˆæ•°æ®</li></ul></li><li>å¤´æŒ‡é’ˆï¼šæŒ‡å‘å¤´èŠ‚ç‚¹çš„æŒ‡é’ˆå˜é‡</li><li>å°¾æŒ‡é’ˆï¼šæŒ‡å‘å°¾èŠ‚ç‚¹çš„æŒ‡é’ˆå˜é‡</li></ul><h2 id="3-ç¡®å®šä¸€ä¸ªé“¾è¡¨éœ€è¦çš„å‚æ•°"><a href="#3-ç¡®å®šä¸€ä¸ªé“¾è¡¨éœ€è¦çš„å‚æ•°" class="headerlink" title="3.ç¡®å®šä¸€ä¸ªé“¾è¡¨éœ€è¦çš„å‚æ•°"></a>3.ç¡®å®šä¸€ä¸ªé“¾è¡¨éœ€è¦çš„å‚æ•°</h2><p><strong>åªéœ€è¦ä¸€ä¸ªå¤´æŒ‡é’ˆ</strong></p><p>ğŸ‘‰ä¸ºä»€ä¹ˆä¸ç”¨å¤´ç»“ç‚¹</p><ul><li><p>å› ä¸ºå¤´ç»“ç‚¹çš„æ•°æ®ç±»å‹å’Œåé¢æœ‰æ•°æ®åŸŸçš„èŠ‚ç‚¹çš„æ•°æ®ç±»å‹æ˜¯ä¸€æ ·çš„(è™½ç„¶å¤´ç»“ç‚¹æ²¡æœ‰æ•°æ®åŸŸï¼Œä½†æ˜¯ä»–ä¼šæœ‰åƒåœ¾å€¼ï¼Œä¼šå å†…å­˜)</p></li><li><p>å¤´æŒ‡é’ˆåªå å››ä¸ªå­—èŠ‚æ¥å­˜æ”¾å¤´ç»“ç‚¹çš„åœ°å€</p></li></ul><h2 id="4-èŠ‚ç‚¹"><a href="#4-èŠ‚ç‚¹" class="headerlink" title="4.èŠ‚ç‚¹"></a>4.èŠ‚ç‚¹</h2><ul><li>éƒ½è¦æœ‰ä¸€ä¸ªæŒ‡é’ˆåŸŸå’Œæ•°æ®åŸŸ</li><li>ç»“æ„ä½“çš„æŸä¸€ä¸ªæˆå‘˜æŒ‡å‘çš„æ˜¯è·Ÿå®ƒä¸€æ‘¸ä¸€æ ·çš„æ•°æ®ç±»å‹çš„æ•°æ®</li><li>è¦ä¸ºåˆ›å»ºçš„æ¯ä¸€ä¸ªèŠ‚ç‚¹ç”³è¯·ç©ºé—´</li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">Node</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> data<span class="token punctuation">;</span><span class="token comment">//æ•°æ®åŸŸ</span>    <span class="token keyword">struct</span> <span class="token class-name">Node</span> <span class="token operator">*</span>pNext<span class="token punctuation">;</span><span class="token comment">//æŒ‡é’ˆåŸŸ</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="5-åˆ†ç±»"><a href="#5-åˆ†ç±»" class="headerlink" title="5.åˆ†ç±»"></a>5.åˆ†ç±»</h2><ul><li>å•é“¾è¡¨</li><li>åŒé“¾è¡¨ï¼šæ¯ä¸ªèŠ‚ç‚¹æœ‰ä¸¤ä¸ªæŒ‡é’ˆåŸŸ</li><li>å¾ªç¯é“¾è¡¨ï¼šèƒ½é€šè¿‡ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹æ‰¾åˆ°å…¶ä»–èŠ‚ç‚¹</li><li>éå¾ªç¯é“¾è¡¨</li></ul><h1 id="ä¸‰-ä½œç”¨"><a href="#ä¸‰-ä½œç”¨" class="headerlink" title="ä¸‰.ä½œç”¨"></a>ä¸‰.ä½œç”¨</h1><h2 id="1-åˆ›å»º-åˆå§‹åŒ–"><a href="#1-åˆ›å»º-åˆå§‹åŒ–" class="headerlink" title="1.åˆ›å»º/åˆå§‹åŒ–"></a>1.åˆ›å»º/åˆå§‹åŒ–</h2><ul><li>éœ€è¦ç”¨åˆ°çš„å˜é‡ï¼šæœ€åˆåˆ›å»ºçš„é“¾è¡¨çš„é•¿åº¦<strong>len</strong>ã€æ¯ä¸ªç»“æ„ä½“æ•°æ®åŸŸçš„æ•°æ®<strong>val</strong>ã€å¤´èŠ‚ç‚¹<strong>pHead</strong>ã€å°¾èŠ‚ç‚¹<strong>pTail</strong></li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> len<span class="token punctuation">;</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>len<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>   <span class="token comment">//xxxxxxx</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-c" data-language="c"><code class="language-c">pNew<span class="token operator">-&gt;</span>data<span class="token operator">=</span>val<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>pTail=pHead<ul><li>å¯ä»¥ç†è§£ä¸ºç”¨å°¾æŒ‡é’ˆæ˜¯é’ˆçº¿ï¼ŒæŠŠåŸæœ‰é“¾è¡¨æœ€åä¸€ä¸ªèŠ‚ç‚¹å’Œæ–°åŠ å…¥çš„èŠ‚ç‚¹è¿æ¥èµ·æ¥</li></ul></li></ul><h2 id="2-æ’å…¥"><a href="#2-æ’å…¥" class="headerlink" title="2.æ’å…¥"></a>2.æ’å…¥</h2><ul><li><p>éœ€è¦ç”¨åˆ°çš„å‚æ•°ï¼šå¤´ç»“ç‚¹ï¼Œæ–°æ’å…¥çš„ç»“æ„ä½“çš„ä½ç½®ï¼Œæ–°æ’å…¥çš„ç»“æ„ä½“çš„æ•°æ®åŸŸä¸­çš„æ•°å€¼</p></li><li><p>éœ€è¦è€ƒè™‘çš„é—®é¢˜ï¼šè¦æ€ä¹ˆé€šè¿‡è¾“å…¥çš„<strong>pos</strong>æ‰¾åˆ°è¦<strong>æŒ‡å‘æ–°æ’å…¥ç»“æ„ä½“ä½ç½®çš„ç»“æ„ä½“æŒ‡é’ˆ</strong></p></li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c">PNODE p<span class="token operator">=</span>pHead<span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>p<span class="token operator">!=</span><span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> i<span class="token operator">&lt;</span>pos<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">//i&lt;p-1å°±æ˜¯è®©pæŒ‡å‘è¦æ’å…¥ä½ç½®çš„ä¸Šä¸€ä¸ªç»“æ„ä½“ </span><span class="token punctuation">{</span>p<span class="token operator">=</span>p<span class="token operator">-&gt;</span>pNext<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">/*æ¡ä»¶â‘ ï¼šç¡®ä¿æ˜¯åœ¨ä¸€ä¸ªä¸æ˜¯ç©ºçš„ç»“æ„ä½“åæ’å…¥çš„æ¡ä»¶â‘¡ï¼špè¦æŒ‡å‘å³å°†è¦æ’å…¥çš„ä½ç½®çš„å‰ä¸€ä¸ªç»“æ„ä½“*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬è¦é€šè¿‡éå†çš„æ–¹å¼æ‰¾åˆ°ç›®æ ‡ç»“æ„ä½“ï¼Œå‡è®¾æˆ‘ä»¬è¦æ’å…¥åˆ°pos=3</p><ul><li><strong>i&lt;pos=1</strong>è¿™é‡Œ i=0æ—¶ p=ç¬¬ä¸€ä¸ªæœ‰æ•ˆç»“æ„ä½“</li><li>i=1æ—¶ï¼Œp=ç¬¬äºŒä¸ªæœ‰æ•ˆç»“æ„ä½“</li><li>i=2ä¸ç¬¦åˆå¾ªç¯æ¡ä»¶</li><li>æ‰€ä»¥whileç»“æŸåï¼Œpå°±æ˜¯ç¬¬äºŒä¸ªæœ‰æ•ˆç»“æ„ä½“çš„æŒ‡é’ˆå˜é‡</li></ul><h2 id="3-åˆ é™¤"><a href="#3-åˆ é™¤" class="headerlink" title="3.åˆ é™¤"></a>3.åˆ é™¤</h2><ul><li><p>åˆ é™¤æ˜¯é€šè¿‡ä¿®æ”¹å‰ä¸€ä¸ªç»“æ„ä½“æŒ‡é’ˆçš„æŒ‡å‘æ¥åˆ é™¤çš„</p></li><li><p>æ‰€ä»¥åˆ é™¤çš„ä½ç½®çš„å‰ä¸€ä¸ªæŒ‡é’ˆçš„æŒ‡å‘ä¸èƒ½æ˜¯NULL</p></li><li><p>å¦‚æœè¦åˆ é™¤çš„å¯¹è±¡çš„ä¸‹ä¸€ä¸ªå·²ç»æ˜¯NULLäº†ï¼Œé‚£ä¹ˆå°±ä¸ä¼šç»§ç»­éå†ä¸‹å» </p></li><li><p><strong>vsæ’å…¥</strong>ï¼Œå¦‚æœè¦æ’å…¥çš„ä½ç½®æ˜¯æœ€åä¸€ä¸ªï¼Œå³p-&gt;</p></li></ul><h1 id="å››-å…¨éƒ¨ä»£ç "><a href="#å››-å…¨éƒ¨ä»£ç " class="headerlink" title="å››.å…¨éƒ¨ä»£ç "></a>å››.å…¨éƒ¨ä»£ç </h1><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;malloc.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdbool.h&gt;</span></span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">Node</span><span class="token punctuation">{</span><span class="token keyword">int</span> data<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">Node</span> <span class="token operator">*</span>pNext<span class="token punctuation">;</span><span class="token punctuation">}</span>NODE<span class="token punctuation">,</span><span class="token operator">*</span>PNODE<span class="token punctuation">;</span><span class="token comment">//å‡½æ•°å£°æ˜</span>PNODE <span class="token function">creatList</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">traverseList</span><span class="token punctuation">(</span>PNODE pHead<span class="token punctuation">)</span><span class="token punctuation">;</span>bool <span class="token function">isEmpty</span><span class="token punctuation">(</span>PNODE pHead<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">lengthList</span><span class="token punctuation">(</span>PNODE pHead<span class="token punctuation">)</span><span class="token punctuation">;</span>bool <span class="token function">insertList</span><span class="token punctuation">(</span>PNODE pHead<span class="token punctuation">,</span><span class="token keyword">int</span> pos<span class="token punctuation">,</span><span class="token keyword">int</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>bool <span class="token function">deleteList</span><span class="token punctuation">(</span>PNODE pHead<span class="token punctuation">,</span><span class="token keyword">int</span> pos<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>pVal<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">sortList</span><span class="token punctuation">(</span>PNODE pHead<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">lengthList</span><span class="token punctuation">(</span>PNODE pHead<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">int</span> val<span class="token punctuation">;</span>PNODE pHead<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>pHead<span class="token operator">=</span><span class="token function">creatList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//traverseList(pHead);</span><span class="token comment">/*if(isEmpty(pHead))printf("é“¾è¡¨ä¸ºç©ºï¼\n");elseprintf("é“¾è¡¨ä¸ç©ºï¼\n");return 0;*/</span><span class="token comment">/*int len=lengthList(pHead);printf("é•¿é“¾è¡¨çš„é•¿åº¦æ˜¯%d",len);*/</span><span class="token comment">//sortList(pHead);</span><span class="token comment">//traverseList(pHead);</span><span class="token comment">//insertList(pHead,4,23);</span><span class="token comment">//traverseList(pHead);</span><span class="token function">deleteList</span><span class="token punctuation">(</span>pHead<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">traverseList</span><span class="token punctuation">(</span>pHead<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span>PNODE <span class="token function">creatList</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">int</span> len<span class="token punctuation">;</span><span class="token keyword">int</span> i<span class="token punctuation">;</span><span class="token keyword">int</span> val<span class="token punctuation">;</span>PNODE pHead<span class="token operator">=</span><span class="token punctuation">(</span>PNODE<span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>NODE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>pHead<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"å†…å­˜åˆ†é…å¤±è´¥ï¼\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>PNODE pTail<span class="token operator">=</span>pHead<span class="token punctuation">;</span>pTail<span class="token operator">-&gt;</span>pNext<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"è¯·è¾“å…¥æ‚¨éœ€è¦ç”Ÿæˆçš„é“¾è¡¨èŠ‚ç‚¹çš„ä¸ªæ•°ï¼šlen="</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>len<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%è¯·è¾“å…¥ç¬¬%dä¸ªèŠ‚ç‚¹çš„å€¼"</span><span class="token punctuation">,</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>PNODE pNew<span class="token operator">=</span><span class="token punctuation">(</span>PNODE<span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>NODE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>pNew<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"å†…å­˜åˆ†é…å¤±è´¥ï¼\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>pNew<span class="token operator">-&gt;</span>data<span class="token operator">=</span>val<span class="token punctuation">;</span>pTail<span class="token operator">-&gt;</span>pNext<span class="token operator">=</span>pNew<span class="token punctuation">;</span>pNew<span class="token operator">-&gt;</span>pNext<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>pTail<span class="token operator">=</span>pNew<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">return</span> pHead<span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">void</span> <span class="token function">traverseList</span><span class="token punctuation">(</span>PNODE pHead<span class="token punctuation">)</span><span class="token punctuation">{</span>PNODE p<span class="token operator">=</span>pHead<span class="token operator">-&gt;</span>pNext<span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>p<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\t"</span><span class="token punctuation">,</span>p<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>p<span class="token operator">=</span>p<span class="token operator">-&gt;</span>pNext<span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>bool <span class="token function">isEmpty</span><span class="token punctuation">(</span>PNODE pHead<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token operator">==</span>pHead<span class="token operator">-&gt;</span>pNext<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> true<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token keyword">return</span> false<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">lengthList</span><span class="token punctuation">(</span>PNODE pHead<span class="token punctuation">)</span><span class="token punctuation">{</span>PNODE p<span class="token operator">=</span>pHead<span class="token operator">-&gt;</span>pNext<span class="token punctuation">;</span><span class="token keyword">int</span> len<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>p<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token operator">++</span>len<span class="token punctuation">;</span>p<span class="token operator">=</span>p<span class="token operator">-&gt;</span>pNext<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">return</span> len<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">sortList</span><span class="token punctuation">(</span>PNODE pHead<span class="token punctuation">)</span><span class="token punctuation">{</span>PNODE p<span class="token operator">=</span>pHead<span class="token operator">-&gt;</span>pNext<span class="token punctuation">;</span>PNODE q<span class="token punctuation">;</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">int</span> temp<span class="token punctuation">;</span><span class="token keyword">int</span> len<span class="token operator">=</span><span class="token function">lengthList</span><span class="token punctuation">(</span>pHead<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">for</span><span class="token punctuation">(</span>j<span class="token operator">=</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>q<span class="token operator">=</span>p<span class="token operator">-&gt;</span>pNext<span class="token punctuation">;</span>j<span class="token operator">&lt;</span>len<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>data <span class="token operator">&gt;</span> q<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>temp<span class="token operator">=</span>p<span class="token operator">-&gt;</span>data<span class="token punctuation">;</span>p<span class="token operator">-&gt;</span>data<span class="token operator">=</span>q<span class="token operator">-&gt;</span>data<span class="token punctuation">;</span>q<span class="token operator">-&gt;</span>data<span class="token operator">=</span>temp<span class="token punctuation">;</span><span class="token punctuation">}</span>q<span class="token operator">=</span>q<span class="token operator">-&gt;</span>pNext<span class="token punctuation">;</span><span class="token punctuation">}</span>p<span class="token operator">=</span>p<span class="token operator">-&gt;</span>pNext<span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">}</span>bool <span class="token function">insertList</span><span class="token punctuation">(</span>PNODE pHead<span class="token punctuation">,</span><span class="token keyword">int</span> pos<span class="token punctuation">,</span><span class="token keyword">int</span> val<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>PNODE p<span class="token operator">=</span>pHead<span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>p<span class="token operator">!=</span><span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> i<span class="token operator">&lt;</span>pos<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">//i&lt;p-1å°±æ˜¯è®©pæŒ‡å‘è¦æ’å…¥ä½ç½®çš„ä¸Šä¸€ä¸ªç»“æ„ä½“ </span><span class="token punctuation">{</span>p<span class="token operator">=</span>p<span class="token operator">-&gt;</span>pNext<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">&gt;</span>pos<span class="token operator">-</span><span class="token number">1</span><span class="token operator">||</span><span class="token constant">NULL</span><span class="token operator">==</span>p<span class="token punctuation">)</span><span class="token keyword">return</span> false<span class="token punctuation">;</span>PNODE pNew<span class="token operator">=</span><span class="token punctuation">(</span>PNODE<span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>NODE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>pNew<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"åˆ†é…å¤±è´¥ï¼\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> pNew<span class="token operator">-&gt;</span>data<span class="token operator">=</span>val<span class="token punctuation">;</span>PNODE q<span class="token operator">=</span>p<span class="token operator">-&gt;</span>pNext<span class="token punctuation">;</span>p<span class="token operator">-&gt;</span>pNext<span class="token operator">=</span>pNew<span class="token punctuation">;</span>pNew<span class="token operator">-&gt;</span>pNext<span class="token operator">=</span>q<span class="token punctuation">;</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">}</span> bool <span class="token function">deleteList</span><span class="token punctuation">(</span>PNODE pHead<span class="token punctuation">,</span><span class="token keyword">int</span> pos<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>pVal<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>PNODE p<span class="token operator">=</span>pHead<span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>pNext<span class="token operator">!=</span><span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> i<span class="token operator">&lt;</span>pos<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">//i&lt;p-1å°±æ˜¯è®©pæŒ‡å‘è¦åˆ é™¤ä½ç½®çš„ä¸Šä¸€ä¸ªç»“æ„ä½“ </span><span class="token punctuation">{</span>p<span class="token operator">=</span>p<span class="token operator">-&gt;</span>pNext<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">&gt;</span>pos<span class="token operator">-</span><span class="token number">1</span><span class="token operator">||</span><span class="token constant">NULL</span><span class="token operator">==</span>p<span class="token operator">-&gt;</span>pNext<span class="token punctuation">)</span><span class="token keyword">return</span> false<span class="token punctuation">;</span>PNODE pNew<span class="token operator">=</span><span class="token punctuation">(</span>PNODE<span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>NODE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>pNew<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"åˆ†é…å¤±è´¥ï¼\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> PNODE q<span class="token operator">=</span>p<span class="token operator">-&gt;</span>pNext<span class="token punctuation">;</span><span class="token operator">*</span>pVal<span class="token operator">=</span>q<span class="token operator">-&gt;</span>data<span class="token punctuation">;</span>p<span class="token operator">-&gt;</span>pNext<span class="token operator">=</span>p<span class="token operator">-&gt;</span>pNext<span class="token operator">-&gt;</span>pNext<span class="token punctuation">;</span>q<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Cè¯­è¨€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Cè¯­è¨€ </tag>
            
            <tag> é“¾è¡¨ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è¿ç»­å‚¨å­˜æ•°ç»„</title>
      <link href="/2022/11/13/lian-xu-chu-cun-shu-zu/"/>
      <url>/2022/11/13/lian-xu-chu-cun-shu-zu/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-æ•°ç»„"><a href="#ä¸€-æ•°ç»„" class="headerlink" title="ä¸€.æ•°ç»„"></a>ä¸€.æ•°ç»„</h1><ul><li>å­˜æ”¾ç±»å‹ç›¸åŒï¼Œå¤§å°ç›¸ç­‰çš„å…ƒç´ </li></ul><h1 id="äºŒ-ä»£ç éƒ¨åˆ†"><a href="#äºŒ-ä»£ç éƒ¨åˆ†" class="headerlink" title="äºŒ.ä»£ç éƒ¨åˆ†"></a>äºŒ.ä»£ç éƒ¨åˆ†</h1><h2 id="1-å¯¹äºä¼ å‚"><a href="#1-å¯¹äºä¼ å‚" class="headerlink" title="1.å¯¹äºä¼ å‚"></a>1.å¯¹äºä¼ å‚</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">struct</span> <span class="token class-name">Arr</span><span class="token punctuation">{</span><span class="token keyword">int</span> <span class="token operator">*</span>pBase<span class="token punctuation">;</span><span class="token comment">//å­˜å‚¨çš„æ˜¯æ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ çš„åœ°å€ </span><span class="token keyword">int</span> len<span class="token punctuation">;</span><span class="token comment">//æ•°ç»„æ‰€èƒ½å®¹çº³çš„æœ€å¤§å…ƒç´ çš„ä¸ªæ•° </span><span class="token keyword">int</span> cnt<span class="token punctuation">;</span><span class="token comment">//å½“å‰æ•°ç»„æœ‰æ•ˆå…ƒç´ çš„ä¸ªæ•° </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">initArr</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Arr</span> <span class="token operator">*</span>pArr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">struct</span> <span class="token class-name">Arr</span> arr<span class="token punctuation">;</span><span class="token function">initArr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åœ°å€åªç”¨ç¬¬ä¸€ä¸ªå­—èŠ‚çš„åœ°å€è¡¨ç¤ºï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚çš„åœ°å€å 4ä¸ªå­—èŠ‚ </span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span>arr<span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">initArr</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Arr</span> <span class="token operator">*</span>pArr<span class="token punctuation">)</span><span class="token comment">//æ­¤æ—¶æŒ‡å‘arrçš„ç¬¬ä¸€ä¸ªåœ°å€ï¼Œç°åœ¨pArrå­˜æ”¾çš„æ˜¯arrç¬¬ä¸€ä¸ªå­—èŠ‚çš„åœ°å€ </span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token operator">*</span>pArr<span class="token punctuation">)</span><span class="token punctuation">.</span>len<span class="token operator">=</span><span class="token number">99</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">initArr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/*å¯¹äºè¿™ä¸€è¡Œï¼Œå¦‚æœå†™çš„æ˜¯ğŸ‘‡initArr(arr);åœ¨å®šä¹‰å˜é‡æ—¶ä¼ å‚ä¼ çš„æ˜¯(struct Arr array)æ­¤æ—¶è¿”å›åˆ°ä¸»å‡½æ•°é‡Œçš„arrçš„lenæ˜¯åƒåœ¾å€¼ï¼Œå› ä¸ºæ˜¯é™æ€åˆ†é…å†…å­˜ï¼Œå½“è°ƒç”¨å®ŒinitArrä¹‹åä¼ å‚çš„å°±ä¸å­˜åœ¨äº†æ‰€ä»¥è¦ç”¨åˆ°"&amp;arr"ï¼Œå°†æŒ‡é’ˆçš„åœ°å€ä¼ ç»™initArrä¸­é‚£ä¹ˆåœ¨initArrå‡½æ•°é‡Œï¼Œ*pArrå°±æ˜¯arrè¿™æ ·åšçš„ä¼˜ç‚¹ï¼šå¯¹æ¯”ç”¨arrä¼ å‚(éœ€è¦ç”¨åˆ°12ä¸ªå­—èŠ‚)ï¼Œè¿™æ ·å­ä¼ å‚çœç©ºé—´(arrçš„ç¬¬ä¸€ä¸ªåœ°å€åªå 4ä¸ªå­—èŠ‚)*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-å¯¹ç»“æ„ä½“çš„ç†è§£"><a href="#2-å¯¹ç»“æ„ä½“çš„ç†è§£" class="headerlink" title="2.å¯¹ç»“æ„ä½“çš„ç†è§£"></a>2.å¯¹ç»“æ„ä½“çš„ç†è§£</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">Arr</span><span class="token punctuation">{</span><span class="token keyword">int</span> <span class="token operator">*</span>pBase<span class="token punctuation">;</span><span class="token comment">//å­˜å‚¨çš„æ˜¯æ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ çš„åœ°å€ </span><span class="token keyword">int</span> len<span class="token punctuation">;</span><span class="token comment">//æ•°ç»„æ‰€èƒ½å®¹çº³çš„æœ€å¤§å…ƒç´ çš„ä¸ªæ•° </span><span class="token keyword">int</span> cnt<span class="token punctuation">;</span><span class="token comment">//å½“å‰æ•°ç»„æœ‰æ•ˆå…ƒç´ çš„ä¸ªæ•° </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ğŸ‘‰å› ä¸ºæ•°ç»„åå°±æ˜¯æ•°ç»„é¦–åœ°å€å…ƒç´ ï¼Œæ‰€ä»¥åœ¨å®šä¹‰*<em>int <em>pBase</em></em> æ—¶ï¼ŒpBaseæ˜¯æŒ‡é’ˆå˜é‡ï¼Œä¹Ÿå°±æ˜¯åœ°å€ï¼ŒåŒæ—¶å®ƒæ˜¯ä¸€ä¸ªæ•°ç»„å</p><p>ğŸ‘‰å…¶å®ä¹Ÿå¯ä»¥ç†è§£ä¸ºï¼Œè¿™ä¸ªç»“æ„ä½“ï¼Œä¸»ä½“éƒ¨åˆ†æ˜¯pBaseï¼Œå…¶ä»–æˆå‘˜æ˜¯è¿™ä¸ªæ•°ç»„çš„ä¸€äº›å±æ€§çš„è¯´æ˜</p><p>ğŸ‘‰ä¸ºäº†æŠŠè¿™äº›å±æ€§å’Œæ•°ç»„ä¸»ä½“è”ç³»èµ·æ¥ï¼Œæäº†ä¸€ä¸ªç»“æ„ä½“æŠŠå®ƒä»¬æ”¾åœ¨ä¸€èµ·</p><h2 id="3-åˆå§‹åŒ–"><a href="#3-åˆå§‹åŒ–" class="headerlink" title="3.åˆå§‹åŒ–"></a>3.åˆå§‹åŒ–</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">initArr</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Arr</span> <span class="token operator">*</span>pArr<span class="token punctuation">,</span><span class="token keyword">int</span> length<span class="token punctuation">)</span><span class="token comment">//æ­¤æ—¶æŒ‡å‘arrçš„ç¬¬ä¸€ä¸ªåœ°å€ï¼Œç°åœ¨pArrå­˜æ”¾çš„æ˜¯arrç¬¬ä¸€ä¸ªå­—èŠ‚çš„åœ°å€ </span><span class="token punctuation">{</span>pArr<span class="token operator">-&gt;</span>pBase<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">*</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token operator">==</span>pArr<span class="token operator">-&gt;</span>pBase<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"åŠ¨æ€å†…å­˜åˆ†é…å¤±è´¥ï¼\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>pArr<span class="token operator">-&gt;</span>len<span class="token operator">=</span>length<span class="token punctuation">;</span>pArr<span class="token operator">-&gt;</span>cnt<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token comment">//å‘Šè¯‰ç¨‹åºè¿™ä¸ªå‡½æ•°ç»“æŸäº† </span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ğŸ‘‰pBaseæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå…ˆç»™ä»–åˆ†é…ç©ºé—´</p><ul><li>å¯¹pBaseå†…å­˜æ˜¯å¦åˆ†é…æˆåŠŸè¦åšä¸€ä¸ªåˆ¤å®š</li><li>åˆ¤å®šæˆåŠŸäº†å°±ç»™ä»–è¿™ä¸ªç»“æ„ä½“èµ‹å€¼</li></ul><h2 id="4-æ‰“å°"><a href="#4-æ‰“å°" class="headerlink" title="4.æ‰“å°"></a>4.æ‰“å°</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">showArr</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Arr</span> <span class="token operator">*</span>pArr<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>pArr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"æ•°ç»„ä¸ºç©ºï¼\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>pArr<span class="token operator">-&gt;</span>cnt<span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d "</span><span class="token punctuation">,</span>pArr<span class="token operator">-&gt;</span>pBase<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="5-åˆ¤æ–­æ•°ç»„é‡Œæ˜¯å¦æœ‰å…ƒç´ "><a href="#5-åˆ¤æ–­æ•°ç»„é‡Œæ˜¯å¦æœ‰å…ƒç´ " class="headerlink" title="5.åˆ¤æ–­æ•°ç»„é‡Œæ˜¯å¦æœ‰å…ƒç´ "></a>5.åˆ¤æ–­æ•°ç»„é‡Œæ˜¯å¦æœ‰å…ƒç´ </h2><pre class="line-numbers language-c" data-language="c"><code class="language-c">bool <span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Arr</span> <span class="token operator">*</span>pArr<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span>pArr<span class="token operator">-&gt;</span>cnt<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> true<span class="token punctuation">;</span><span class="token keyword">else</span><span class="token keyword">return</span> false<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="6-åˆ¤æ–­æ•°ç»„æ˜¯å¦æ˜¯æ»¡çš„"><a href="#6-åˆ¤æ–­æ•°ç»„æ˜¯å¦æ˜¯æ»¡çš„" class="headerlink" title="6.åˆ¤æ–­æ•°ç»„æ˜¯å¦æ˜¯æ»¡çš„"></a>6.åˆ¤æ–­æ•°ç»„æ˜¯å¦æ˜¯æ»¡çš„</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c">bool <span class="token function">isFull</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Arr</span> <span class="token operator">*</span>pArr<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span>pArr<span class="token operator">-&gt;</span>cnt<span class="token operator">==</span>pArr<span class="token operator">-&gt;</span>len<span class="token punctuation">)</span><span class="token keyword">return</span> true<span class="token punctuation">;</span><span class="token keyword">else</span><span class="token keyword">return</span> false<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="7-è¿½åŠ å…ƒç´ "><a href="#7-è¿½åŠ å…ƒç´ " class="headerlink" title="7.è¿½åŠ å…ƒç´ "></a>7.è¿½åŠ å…ƒç´ </h2><pre class="line-numbers language-c" data-language="c"><code class="language-c">bool <span class="token function">appendArr</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Arr</span> <span class="token operator">*</span>pArr<span class="token punctuation">,</span><span class="token keyword">int</span> val<span class="token punctuation">)</span><span class="token comment">//valæ˜¯è¦åŠ å…¥çš„å…ƒç´ </span><span class="token punctuation">{</span><span class="token comment">//æ»¡æ—¶è¿”å›falseï¼Œä¸åŠ </span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isFull</span><span class="token punctuation">(</span>pArr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">return</span> false<span class="token punctuation">;</span><span class="token comment">//ä¸æ»¡æ—¶è¿½åŠ </span>pArr<span class="token operator">-&gt;</span>pBase<span class="token punctuation">[</span>pArr<span class="token operator">-&gt;</span>cnt<span class="token punctuation">]</span><span class="token operator">=</span>val<span class="token punctuation">;</span> <span class="token punctuation">(</span>pArr<span class="token operator">-&gt;</span>cnt<span class="token punctuation">)</span><span class="token operator">++</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ğŸ‘‰cntçš„å€¼=æœ€åä¸€ä¸ªå…ƒç´ çš„ä¸‹æ ‡+1</p><p>ğŸ‘‰æœ€åè®°å¾—è¦ç»™æœ‰æ•ˆå€¼+1</p><h2 id="8-æ’å…¥å…ƒç´ "><a href="#8-æ’å…¥å…ƒç´ " class="headerlink" title="8.æ’å…¥å…ƒç´ "></a>8.æ’å…¥å…ƒç´ </h2><pre class="line-numbers language-c" data-language="c"><code class="language-c">bool <span class="token function">insertArr</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Arr</span> <span class="token operator">*</span>pArr<span class="token punctuation">,</span><span class="token keyword">int</span> pos<span class="token punctuation">,</span><span class="token keyword">int</span> val<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">int</span> i<span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isFull</span><span class="token punctuation">(</span>pArr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">return</span> false<span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>pos<span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">||</span>pos<span class="token operator">&gt;</span>pArr<span class="token operator">-&gt;</span>cnt<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">return</span> false<span class="token punctuation">;</span> <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span>pArr<span class="token operator">-&gt;</span>cnt<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&gt;=</span>pos<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token operator">--</span>i<span class="token punctuation">)</span><span class="token punctuation">{</span>pArr<span class="token operator">-&gt;</span>pBase<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>pArr<span class="token operator">-&gt;</span>pBase<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span>pArr<span class="token operator">-&gt;</span>pBase<span class="token punctuation">[</span>pos<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>val<span class="token punctuation">;</span><span class="token punctuation">(</span>pArr<span class="token operator">-&gt;</span>cnt<span class="token punctuation">)</span><span class="token operator">++</span><span class="token punctuation">;</span><span class="token keyword">return</span> true<span class="token punctuation">;</span><span class="token punctuation">}</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>æ»¡äº†ã€è¾“å…¥çš„ä½ç½®ä¸ç¬¦åˆæ•°ç»„ç°æœ‰çš„â†’è¿”å›é”™è¯¯ï¼Œåœ¨ä¸»ç¨‹åºé‡Œä¸æ‰§è¡Œ</li></ul><p>ğŸ‘‰å¯¹äºforé‡Œçš„</p><ul><li><strong>i=pArr-&gt;cnt-1</strong> iå¯¹åº”ç€ä¸‹æ ‡</li><li><strong>i=pos-1</strong> æ’å…¥æ—¶åªå˜åŠ¨è¦æ’å…¥ä½ç½®çš„è¯¥ä½ä¸Šå’Œè¯¥ä½åçš„å…ƒç´ </li><li><strong>â€“i</strong> è¿›è¡Œæ’å…¥çš„é€»è¾‘æ˜¯ï¼Œå…ˆå¯¹æœ€åä¸€ä½æ“ä½œï¼Œæœ€åä¸€ä½å…ˆå¾€åç§»åŠ¨ï¼Œç„¶åå‰é¢çš„å†å¾€åç§»åŠ¨ï¼Œæœ€åç©ºå‡ºä¸€ä¸ªä½ç½®ç»™è¦æ’å…¥çš„å…ƒç´ æ’å…¥</li></ul><p>ğŸ‘‰ç„¶å</p><ul><li><p>å‰ä¸€ä¸ªå…ƒç´ ç§»åŠ¨åˆ°åä¸€ä¸ªå…ƒç´ ä¸Š</p></li><li><p>æ”¾ç½®æ–°å…ƒç´ </p></li><li><p>æœ‰æ•ˆå€¼+1</p></li></ul><h2 id="9-åˆ é™¤å…ƒç´ "><a href="#9-åˆ é™¤å…ƒç´ " class="headerlink" title="9.åˆ é™¤å…ƒç´ "></a>9.åˆ é™¤å…ƒç´ </h2><pre class="line-numbers language-c" data-language="c"><code class="language-c">bool <span class="token function">deleteArr</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Arr</span> <span class="token operator">*</span>pArr<span class="token punctuation">,</span><span class="token keyword">int</span> pos<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>pVal<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>pArr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">return</span> false<span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>pos<span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">||</span>pos<span class="token operator">&gt;</span>pArr<span class="token operator">-&gt;</span>cnt<span class="token punctuation">)</span><span class="token keyword">return</span> false<span class="token punctuation">;</span><span class="token operator">*</span>pVal<span class="token operator">=</span>pArr<span class="token operator">-&gt;</span>pBase<span class="token punctuation">[</span>pos<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span>pos<span class="token punctuation">;</span>i<span class="token operator">&lt;</span>pArr<span class="token operator">-&gt;</span>cnt<span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">{</span>pArr<span class="token operator">-&gt;</span>pBase<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>pArr<span class="token operator">-&gt;</span>pBase<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span>pArr<span class="token operator">-&gt;</span>cnt<span class="token operator">--</span><span class="token punctuation">;</span><span class="token keyword">return</span> true<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>ç©ºçš„ã€è¾“å…¥ä¸ç¬¦åˆæ•°ç»„ç°æœ‰çš„â†’è¿”å›é”™è¯¯ï¼Œå†ä¸»ç¨‹åºä¸­ä¸æ‰§è¡Œ</li></ul><p>æ„Ÿè§‰è·Ÿæ’å…¥ä¸€ä¸ªæ„æ€â€¦.</p><h2 id="10-å…ƒç´ å€’ç½®"><a href="#10-å…ƒç´ å€’ç½®" class="headerlink" title="10.å…ƒç´ å€’ç½®"></a>10.å…ƒç´ å€’ç½®</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">inversionArr</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Arr</span> <span class="token operator">*</span>pArr<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">int</span> j<span class="token operator">=</span>pArr<span class="token operator">-&gt;</span>cnt<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">int</span> t<span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>i<span class="token operator">&lt;</span>j<span class="token punctuation">)</span><span class="token punctuation">{</span>t<span class="token operator">=</span>pArr<span class="token operator">-&gt;</span>pBase<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>pArr<span class="token operator">-&gt;</span>pBase<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>pArr<span class="token operator">-&gt;</span>pBase<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>pArr<span class="token operator">-&gt;</span>pBase<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">=</span>t<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">;</span>j<span class="token operator">--</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="11-å…ƒç´ æ’åº"><a href="#11-å…ƒç´ æ’åº" class="headerlink" title="11.å…ƒç´ æ’åº"></a>11.å…ƒç´ æ’åº</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">sortArr</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Arr</span><span class="token operator">*</span> pArr<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">int</span> i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>t<span class="token punctuation">;</span><span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>pArr<span class="token operator">-&gt;</span>cnt<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">for</span><span class="token punctuation">(</span>j<span class="token operator">=</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span>pArr<span class="token operator">-&gt;</span>cnt<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>t<span class="token operator">=</span>pArr<span class="token operator">-&gt;</span>pBase<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>pArr<span class="token operator">-&gt;</span>pBase<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>pArr<span class="token operator">-&gt;</span>pBase<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>pArr<span class="token operator">-&gt;</span>pBase<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">=</span>t<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Cè¯­è¨€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Cè¯­è¨€ </tag>
            
            <tag> æ•°ç»„ </tag>
            
            <tag> æŒ‡é’ˆ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DS1302æ—¶é’Ÿ</title>
      <link href="/2022/11/12/ds1302-shi-zhong/"/>
      <url>/2022/11/12/ds1302-shi-zhong/</url>
      
        <content type="html"><![CDATA[<p><strong>DS1302</strong></p><h1 id="ä¸€-å¼•è„šåˆ†è£…"><a href="#ä¸€-å¼•è„šåˆ†è£…" class="headerlink" title="ä¸€.å¼•è„šåˆ†è£…"></a>ä¸€.å¼•è„šåˆ†è£…</h1><p>1.DIPç›´æ’</p><p>2.SOè´´ç‰‡</p><p><img src="/../../../../medias/blog_picture/51/59.png"></p><p><img src="/../../../../medias/blog_picture/51/60.png"></p><p>å…¶ä¸­ï¼Œ<strong>CEä¸ºé«˜ç”µå¹³çš„æ—¶å€™ä¸‹é¢çš„å‘½ä»¤(ioå’ŒSCLK)æ‰æœ‰ç”¨ã€‚</strong>æ—¶é—´å­˜å‚¨åœ¨å®æ—¶æ—¶é’Ÿé‡Œï¼Œåœ¨å·¦è¾¹è¢«è®¿é—®å’Œè¯»å†™</p><h1 id="äºŒ-å†…éƒ¨å¯„å­˜å™¨"><a href="#äºŒ-å†…éƒ¨å¯„å­˜å™¨" class="headerlink" title="äºŒ.å†…éƒ¨å¯„å­˜å™¨"></a>äºŒ.å†…éƒ¨å¯„å­˜å™¨</h1><p><img src="/../../../../medias/blog_picture/51/61.png"></p><p>WPæ˜¯è¯»å†™ä¿æŠ¤</p><h1 id="ä¸‰-è€ƒè™‘çš„é—®é¢˜"><a href="#ä¸‰-è€ƒè™‘çš„é—®é¢˜" class="headerlink" title="ä¸‰.è€ƒè™‘çš„é—®é¢˜"></a>ä¸‰.è€ƒè™‘çš„é—®é¢˜</h1><p>åœ¨å“ª(xxå¯„å­˜å™¨) å†™å…¥ ä»€ä¹ˆ</p><p>åœ¨å“ª(xxå¯„å­˜å™¨) è¯»å‡º ä»€ä¹ˆ(1302èŠ¯ç‰‡è¿”å›çš„ï¼Œå•ç‰‡æœºéœ€è¦è¯»åˆ°)</p><p><img src="/../../../../medias/blog_picture/51/62.png"></p><p>ç¬¬å…­ä½ï¼šç»™1â€”â€”RAMï¼Œç»™0â€”â€”CK</p><p>6~1å®Œæˆâ€œåœ¨å“ªâ€çš„ä»»åŠ¡</p><p>ç¬¬é›¶ä½ï¼šå®Œæˆâ€œè¯»/å†™â€çš„ä»»åŠ¡ï¼Œç»™1â€”â€”è¯»ï¼Œç»™0â€”â€”å†™</p><p>åœ¨<strong>äºŒ</strong>çš„è¡¨ä¸­å·²ç»æŠŠâ€œè¯»/å†™â€çš„å‘½ä»¤åˆ—å‡ºæ¥äº†</p><h2 id="1-æ—¶åºå®šä¹‰"><a href="#1-æ—¶åºå®šä¹‰" class="headerlink" title="1.æ—¶åºå®šä¹‰"></a>1.æ—¶åºå®šä¹‰</h2><p><img src="/../../../../medias/blog_picture/51/63.png"></p><p>ä¸Šå‡æ²¿(ioå£çš„ç”µå¹³è¢«)å†™å…¥(/å‘æ—¶é’ŸèŠ¯ç‰‡å†™å…¥æ•°æ®)ï¼Œä¸‹é™æ²¿(DS1302æŠŠä»–çš„æ•°æ®)è¾“å‡º(æ—¶é’ŸèŠ¯ç‰‡å‘å•ç‰‡æœºå†™å…¥æ•°æ®)ï¼Œ<strong>æ‰€ä»¥ï¼Œåªæœ‰READä¸­çš„D0~D7æ˜¯èŠ¯ç‰‡å†™å…¥çš„</strong></p><p>å†™å…¥æ—¶ï¼Œå…ˆå†™å…¥æ•°æ®å†è¿›è¡Œä¸Šå‡æ²¿ã€‚</p><h2 id="2-æ¯ä¸ªæŒ‰é”®çš„åŠŸèƒ½"><a href="#2-æ¯ä¸ªæŒ‰é”®çš„åŠŸèƒ½" class="headerlink" title="2.æ¯ä¸ªæŒ‰é”®çš„åŠŸèƒ½"></a>2.æ¯ä¸ªæŒ‰é”®çš„åŠŸèƒ½</h2><ul><li>K1é€‰æ‹©æ¨¡å¼ MODE=1ğŸ‘‰è®¾ç½®æ—¶é—´ MODE=0ğŸ‘‰æ˜¾ç¤ºæµåŠ¨çš„æ—¶é—´</li><li>K2é€‰æ‹©è¦æ›´æ”¹çš„æ—¶é—´å€¼(å¹´æœˆæ—¥æ—¶åˆ†ç§’)</li><li>K3æ›´æ”¹æŸä¸ªæ—¶é—´å€¼ï¼Œ+</li><li>K4æ›´æ”¹æŸä¸ªæ—¶é—´å€¼ï¼Œ-</li></ul><h1 id="å››-ä»£ç "><a href="#å››-ä»£ç " class="headerlink" title="å››.ä»£ç "></a>å››.ä»£ç </h1><h2 id="DS1302-C"><a href="#DS1302-C" class="headerlink" title="DS1302.C"></a>DS1302.C</h2><p><strong>1.</strong></p><pre class="line-numbers language-C" data-language="C"><code class="language-C">void DS1302_WriteByte(unsigned char Command,Data)//å†™å…¥{unsigned char i;DS1302_CE=1;for(i=0;i&lt;8;i++){DS1302_IO=Command&amp;(0x01&lt;&lt;i);//1~7ä½ç›´æ¥æ¸…é›¶ï¼Œåªç•™ç¬¬0ä½DS1302_SCLK=1;DS1302_SCLK=0;}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯¹äºæ¯ä¸€ä½ï¼Œå…ˆå†™å…¥æ“ä½œæŒ‡ä»¤å†ç»™ä¸Šå‡æ²¿</p><p><strong>2.</strong></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">DS1302_ReadByte</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> Command<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> i<span class="token punctuation">,</span>Data<span class="token operator">=</span><span class="token number">0x00</span><span class="token punctuation">;</span>Command<span class="token operator">|=</span><span class="token number">0x01</span><span class="token punctuation">;</span><span class="token comment">//å°†æŒ‡ä»¤è½¬æ¢ä¸ºè¯»æŒ‡ä»¤</span>DS1302_CE<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//è¯»å‡º-æŒ‡ä»¤</span><span class="token punctuation">{</span>DS1302_IO<span class="token operator">=</span>Command<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token operator">&lt;&lt;</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>DS1302_SCLK<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>DS1302_SCLK<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//è¯»å‡º-æ•°æ®</span><span class="token punctuation">{</span>DS1302_SCLK<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//çœ‹æ—¶åºå›¾ï¼Œå…ˆå°‘ä¸€ä¸ªé«˜ç”µå¹³</span>DS1302_SCLK<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//æœ€åæ˜¯ä½ç”µå¹³</span><span class="token keyword">if</span><span class="token punctuation">(</span>DS1302_IO<span class="token punctuation">)</span><span class="token punctuation">{</span>Data<span class="token operator">|=</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token operator">&lt;&lt;</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>DS1302_CE<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>DS1302_IO<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//è¯»å–åå°†IOè®¾ç½®ä¸º0ï¼Œå¦åˆ™è¯»å‡ºçš„æ•°æ®ä¼šå‡ºé”™</span><span class="token keyword">return</span> Data<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…³äºä¸ºä»€ä¹ˆè¦return DataXï¼ŒğŸ‘‡æˆ‘çš„ç†è§£</p><ul><li>é¦–å…ˆåœ¨<strong>DS1302_WriteByte</strong>ä¸­å†™å…¥æ•°æ®ï¼Œæ˜¯å¤šå°‘ç§’(0~15)ï¼Œå°±è¾“å…¥0x xxï¼Œç„¶å16è¿›åˆ¶è½¬2è¿›åˆ¶</li><li>åœ¨<strong>DS1302_ReadByte</strong>ä¸­è¯»å–æ•°æ®ï¼Œå¯¹æ¯ä¸€ä½è¿›è¡Œåˆ¤æ–­</li><li>e.g. å†™å…¥æ—¶å†™å…¥äº†0x03â€”16è½¬2â€”&gt;0000 0100ï¼Œç„¶ååœ¨readå‡½æ•°é‡Œå¯¹æ¯ä¸€ä½è¿›è¡Œåˆ¤æ–­ï¼Œæ‰§è¡Œå®Œè¯»å‘½ä»¤å­—åï¼Œæ•°æ®ä¼ è¾“åˆ°IOå£ä¸Šï¼Œæ˜¯1çš„ï¼ŒDataå°±ç½®1ï¼Œå¦åˆ™ç½®0ï¼Œæ‰€ä»¥Dataå°±æ˜¯ä¸ªæ¥æ”¶æ•°æ®çš„ä¸­è½¬ç«™ç½¢äº†ã€‚</li><li>ç„¶åreturnä¹‹åï¼ŒLCDé‚£é‡Œçš„å®šä¹‰æ˜¯<strong>unsigned int Number</strong>åœ¨ä¼ å‚æ—¶ï¼Œå·²ç»è‡ªåŠ¨æŠŠ2è¿›åˆ¶è½¬æ¢ä¸º10è¿›åˆ¶äº†ï¼Œæ‰€ä»¥æ˜¾ç¤ºå‡ºæ¥çš„æ•°æ®å°±æ˜¯10è¿›åˆ¶çš„ã€‚</li></ul><p><strong>3.è‡ªåŠ¨æ¸…é›¶</strong></p><p>e.g.å¸Œæœ›è®©aè¶…è¿‡5ä¹‹åæ¸…é›¶ï¼Œä»0å¼€å§‹å†é€’å¢</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span><span class="token punctuation">(</span>a<span class="token operator">&gt;</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">{</span>a<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token operator">&lt;=</span><span class="token operator">=</span><span class="token operator">&gt;</span>a<span class="token operator">=</span><span class="token operator">%</span><span class="token number">6</span><span class="token punctuation">;</span><span class="token comment">//a=6%6=0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>4.</strong></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span><span class="token punctuation">(</span>DS1302_Time<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">1</span><span class="token operator">||</span>DS1302_Time<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">3</span><span class="token operator">||</span>DS1302_Time<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">5</span><span class="token operator">||</span>DS1302_Time<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">7</span><span class="token operator">||</span>DS1302_Time<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">8</span><span class="token operator">||</span>DS1302_Time<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">10</span><span class="token operator">||</span>DS1302_Time<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span>DS1302_Time<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>DS1302_Time<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">31</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span>DS1302_Time<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">{</span>DS1302_Time<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">//12-31è°ƒå›11-xxæ—¶ä¼šæ˜¾ç¤º11-31ï¼Œæ‰€ä»¥éœ€è¦åŠ ä¸Šè¿™å¥è¯</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…³äºä¸ºä»€ä¹ˆè¦åœ¨K4-è¿™é‡Œå¤åˆ¶ä¸€éƒ¨åˆ†K3+çš„ä»£ç </p><ul><li>ä»12-31è°ƒå›11æœˆä»½æ—¶ï¼Œä¼šæ˜¾ç¤ºä¸º11-31ï¼Œæ‰€ä»¥è¦åŠ ä¸Šé‚£éƒ¨åˆ†ä»£ç </li></ul><p><strong>5.</strong></p><p>æŸä¸ªæ—¶é—´å€¼è¢«é€‰ä¸­åè·³åŠ¨</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span><span class="token punctuation">(</span>TimeSetSelect<span class="token operator">==</span><span class="token number">0</span><span class="token operator">&amp;&amp;</span>TimeSetFlashFlag<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"  "</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span><span class="token function">LCD_ShowNum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>DS1302_Time<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>å®šæ—¶å™¨æ¯éš”500mså¯¹TimeSetFlashFlagç½®1æˆ–0ï¼Œå½“TSFFä¸º1ä¸”æ—¶é—´å€¼é€‰ä¸­çš„æ˜¯0â€“æ—¶ æ—¶ï¼Œåœ¨åŸæœ¬æ˜¾ç¤ºæ—¶çš„æ—¶é—´é‚£ä¸€å—åœ°æ–¹æ˜¾ç¤ºç©ºæ ¼ï¼›å¦‚æœä¸ç¬¦åˆifçš„æ¡ä»¶ï¼Œåˆ™æ˜¾ç¤ºæ—¶é—´ï¼Œæ‰€ä»¥TSFFåœ¨0å’Œ1è·³åŠ¨æ—¶ï¼Œå†³å®šäº†é¢‘é—ªçš„æ˜¾ç¤ºã€‚</p>]]></content>
      
      
      <categories>
          
          <category> 51å•ç‰‡æœº </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 51å•ç‰‡æœº </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LCD1602</title>
      <link href="/2022/10/30/lcd1602/"/>
      <url>/2022/10/30/lcd1602/</url>
      
        <content type="html"><![CDATA[<h1 id="LCD1602-16-2"><a href="#LCD1602-16-2" class="headerlink" title="LCD1602(16*2)"></a>LCD1602(16*2)</h1><h2 id="ä¸€-åŸç†éƒ¨åˆ†"><a href="#ä¸€-åŸç†éƒ¨åˆ†" class="headerlink" title="ä¸€.åŸç†éƒ¨åˆ†"></a>ä¸€.åŸç†éƒ¨åˆ†</h2><h3 id="1-å¼•è„š"><a href="#1-å¼•è„š" class="headerlink" title="1.å¼•è„š"></a>1.å¼•è„š</h3><p>æ˜¾ç¤ºå®¹é‡ï¼š16*2ä¸ªå­—ç¬¦</p><p><img src="/../../../../medias/blog_picture/51/76.png"></p><p>VO(å¯¹æ¯”åº¦)ï¼š<strong>å€¼å¤ªå°</strong>æ˜¾ç¤ºä¼šå¾ˆæµ…ï¼Œ<strong>çœ‹ä¸æ¸…</strong>ï¼Œ<strong>å€¼å¤ªå¤§</strong>æ¯ä¸ªåƒç´ éƒ½æ˜¾ç¤ºå‡ºæ¥ï¼Œ<strong>æ— æ³•è¾¨åˆ«</strong>å“ªäº›æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œ<strong>æˆ‘ä»¬ç”¨R1æ¥è°ƒèŠ‚</strong></p><p>D1~D7ï¼š<strong>å¹¶è¡Œä¼ é€æ¨¡å¼</strong>ï¼Œæœ€å¥½æ¥åœ¨<strong>ä¸€ç»„ioå£</strong>ä¸Šï¼ŒD0â€“P0_1ï¼ŒD7â€“P0_7(é«˜ä½å¯¹é«˜ä½ï¼Œä½ä½å¯¹ä½ä½)</p><p>RS(åœ¨å“ªå†™)&amp;RW(å†™ä»€ä¹ˆ)&amp;Eï¼šæ§åˆ¶å¼•è„šï¼Œæ§åˆ¶D1~D7</p><p>Eï¼šä¸Šå‡æ²¿çš„æ—¶å€™æŠŠæ•°æ®ä¼ åˆ°D1~D7ï¼Œä¸‹é™æ²¿çš„æ—¶å€™æ‰§è¡Œå‘½ä»¤</p><h3 id="2-å†…éƒ¨ç»“æ„"><a href="#2-å†…éƒ¨ç»“æ„" class="headerlink" title="2.å†…éƒ¨ç»“æ„"></a>2.å†…éƒ¨ç»“æ„</h3><p><img src="/../../../../medias/blog_picture/51/77.png"></p><p>C(character)G(generater)å­—ç¬¦ç”Ÿæˆ</p><p>CGRAMæ˜¯å¯å†™çš„ï¼Œæ˜¯è‡ªå®šä¹‰å­˜å‚¨æ•°æ®</p><p>CGROMä¸å¯å†™ï¼Œæ—©å·²è§„å®šï¼Œç›¸å½“äºå­—å…¸</p><p>å­—æ¨¡åº“å°±æ˜¯æ®µç è¡¨</p><p>D(data)D(display)æ•°æ®æ˜¾ç¤º</p><p>DDRAMï¼Œç”¨æˆ·å¯å†™ï¼Œå¯¹åº”åˆ°å±å¹•çš„è¯åªä¼šæ˜¾ç¤ºå‰16åˆ—(å‰16åˆ—æ˜ å°„åˆ°å±å¹•ä¸Š)ï¼Œä»ç¬¬17åˆ—å¼€å§‹å¯ä»¥å†™ï¼Œå› ä¸ºå±å¹•ä¸å¤Ÿå¤§æ‰€ä»¥æ˜¾ç¤ºä¸äº†(é—®é¢˜ä¸å¤§)</p><h3 id="3-æ®µç è¡¨"><a href="#3-æ®µç è¡¨" class="headerlink" title="3.æ®µç è¡¨"></a>3.æ®µç è¡¨</h3><p>æˆ‘ä»¬å…ˆè¦æœ‰ä¸€ä¸ªæ®µç è¡¨ï¼Œç„¶åæ‰¾ç´¢å¼•å¯¹åº”å±å¹•é‡Œçš„</p><p><img src="/../../../../medias/blog_picture/51/78.png"></p><p>å¯å†™çš„åªæœ‰å…«ä¸ªï¼Œåœ¨0001 0000-0001 0111</p><p>ä¸å¯å†™e.g.æ¯”å¦‚Aï¼Œå¯¹åº”0100 0001â€“è½¬16è¿›åˆ¶â€“&gt;0x41</p><h3 id="4-æ—¶åºå›¾"><a href="#4-æ—¶åºå›¾" class="headerlink" title="4.æ—¶åºå›¾"></a>4.æ—¶åºå›¾</h3><p><img src="/../../../../medias/blog_picture/51/79.png"></p><p><img src="/../../../../medias/blog_picture/51/80.png"></p><p>æœ€é«˜ä½ä¸º1ä½ç½®ä¸åŒå¯ä»¥åŒºåˆ†ä¸åŒçš„æŒ‡ä»¤</p><ul><li>ç‰¹åˆ«æ˜¯åœ¨DB7ç½®1ç»å¯¹æ˜¯è¦æ“ä½œDDRAM</li></ul><h3 id="5-è®¾ç½®å…‰æ ‡ä½ç½®DDRAM-æ•°æ®æ˜¾ç¤º"><a href="#5-è®¾ç½®å…‰æ ‡ä½ç½®DDRAM-æ•°æ®æ˜¾ç¤º" class="headerlink" title="5.è®¾ç½®å…‰æ ‡ä½ç½®DDRAM(æ•°æ®æ˜¾ç¤º)"></a>5.è®¾ç½®å…‰æ ‡ä½ç½®DDRAM(æ•°æ®æ˜¾ç¤º)</h3><p><img src="/../../../../medias/blog_picture/51/81.png"></p><p>ç¬¬ä¸€è¡Œï¼š<strong>1</strong>000 0000 â€“&gt;0x80</p><p>ç¬¬äºŒè¡Œï¼š<strong>1</strong>100 0000 â€“&gt;0xC0</p><p>ä¸¤ä¸²çš„ç¬¬ä¸€ä¸ª<strong>1</strong>éƒ½ä»£è¡¨è¦è¿›å…¥DDRAMè¿™ä¸ªæŒ‡ä»¤</p><p>å› ä¸ºç¬¬ä¸€è¡Œçš„åœ°å€æ˜¯00æ‰€ä»¥åæ¥000 0000ï¼Œç¬¬äºŒè¡Œçš„åœ°å€æ˜¯40æ‰€ä»¥åæ¥100(äºŒè½¬åå°±æ˜¯4) 0000</p><h2 id="äºŒ-ä»£ç éƒ¨åˆ†"><a href="#äºŒ-ä»£ç éƒ¨åˆ†" class="headerlink" title="äºŒ.ä»£ç éƒ¨åˆ†"></a>äºŒ.ä»£ç éƒ¨åˆ†</h2><h3 id="1-å­å‡½æ•°"><a href="#1-å­å‡½æ•°" class="headerlink" title="1.å­å‡½æ•°"></a>1.å­å‡½æ•°</h3><h4 id="â‘ LCD-WriteCommand"><a href="#â‘ LCD-WriteCommand" class="headerlink" title="â‘ LCD_WriteCommand"></a>â‘ LCD_WriteCommand</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">LCD_WriteCommand</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> Command<span class="token punctuation">)</span><span class="token punctuation">{</span>LCD_RS<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//0ä¸ºæŒ‡ä»¤</span>LCD_RW<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//0ä¸ºè¾“å…¥</span>LCD_DataPort<span class="token operator">=</span>Command<span class="token punctuation">;</span>LCD_E<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token function">LCD_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å»¶ç¼“å¿«é€Ÿä¸Šä¸‹æ‹‰</span>LCD_E<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token function">LCD_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å»¶ç¼“å¿«é€Ÿä¸Šä¸‹æ‹‰</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="â‘¡LCD-DataCommand"><a href="#â‘¡LCD-DataCommand" class="headerlink" title="â‘¡LCD_DataCommand"></a>â‘¡LCD_DataCommand</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> Data<span class="token punctuation">)</span><span class="token punctuation">{</span>LCD_RS<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//0ä¸ºæ•°æ®</span>LCD_RW<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//0ä¸ºè¾“å…¥</span>LCD_DataPort<span class="token operator">=</span>Data<span class="token punctuation">;</span>LCD_E<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token function">LCD_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å»¶ç¼“å¿«é€Ÿä¸Šä¸‹æ‹‰</span>LCD_E<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token function">LCD_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å»¶ç¼“å¿«é€Ÿä¸Šä¸‹æ‹‰</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="â‘¢LCD-Init"><a href="#â‘¢LCD-Init" class="headerlink" title="â‘¢LCD_Init"></a>â‘¢LCD_Init</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">LCD_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">LCD_WriteCommand</span><span class="token punctuation">(</span><span class="token number">0x38</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//å…«ä½æ•°æ®æ¥å£ï¼Œä¸¤è¡Œæ˜¾ç¤ºï¼Œ5x7ç‚¹é˜µå±</span><span class="token function">LCD_WriteCommand</span><span class="token punctuation">(</span><span class="token number">0x0C</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//æ˜¾ç¤ºå¼€ï¼Œå…‰æ ‡å…³ï¼Œé—ªçƒå…³</span><span class="token function">LCD_WriteCommand</span><span class="token punctuation">(</span><span class="token number">0x06</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//æ•°æ®è¯»å†™æ“ä½œåï¼Œå…‰æ ‡è‡ªåŠ¨åŠ ä¸€ï¼Œç”»é¢ä¸åŠ¨</span><span class="token function">LCD_WriteCommand</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//æ¸…å±</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="â‘£-LCD-ShowChar"><a href="#â‘£-LCD-ShowChar" class="headerlink" title="â‘£.LCD_ShowChar"></a>â‘£.LCD_ShowChar</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">LCD_WriteCommand</span><span class="token punctuation">(</span><span class="token number">0x80</span><span class="token operator">|</span>Column<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ğŸ‘†ç†è§£ï¼šColumnæ˜¯åˆ—ã€‚åˆ—-1å†å¹¶ä¸Š0x80æ‰è½¬æ¢ä¸ºå¯¹åº”çš„åœ°å€</p><ul><li>e.g. å½“é€‰æ‹©**(1,2)<strong>æ—¶ï¼Œç”±</strong>DDRAM**çš„è¡¨æ ¼æˆ‘ä»¬å¾—çŸ¥è¯¥ä½ç½®çš„åœ°å€æ˜¯01H</li><li>æ­¤æ—¶ä¼ å‚åˆ°Columnçš„æ˜¯2ï¼Œ2-1=1ï¼Œ1â€“10è¿›åˆ¶è½¬2è¿›åˆ¶â€“&gt;0001</li><li>1000 0000|0000 0001=1000 0001</li><li>æŠŠ<code>1</code> <code>000 0001</code>åˆ†æˆä¸¤ä¸ªæ¨¡å—</li><li><code>1</code>æ˜¯æŒ‡è¿›å…¥DDRAMæ¨¡å¼</li><li><code>000 0001</code>å¯¹åº”01Hï¼Œå†™å…¥åˆ°(1,2)ä½ä¸Š</li></ul>]]></content>
      
      
      <categories>
          
          <category> 51å•ç‰‡æœº </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 51å•ç‰‡æœº </tag>
            
            <tag> å¤§äº‘å±‹è€ƒæ ¸ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>èœ‚é¸£å™¨</title>
      <link href="/2022/10/18/feng-ming-qi/"/>
      <url>/2022/10/18/feng-ming-qi/</url>
      
        <content type="html"><![CDATA[<h1 id="èœ‚é¸£å™¨"><a href="#èœ‚é¸£å™¨" class="headerlink" title="èœ‚é¸£å™¨"></a>èœ‚é¸£å™¨</h1><p><img src="/../../../../medias/blog_picture/51/64.png"></p><p>æ— æºèœ‚é¸£å™¨ä¸èƒ½ä¸€ç›´é€šç”µæµï¼Œå®ƒå†…éƒ¨ç½®äº†çº¿åœˆï¼Œè¦ç»™ä»–äº¤æµéœ‡è¡</p><p><img src="/../../../../medias/blog_picture/51/65.png"></p><p>VCCé«˜ç”µå¹³ï¼Œåªæœ‰èœ‚é¸£å™¨æ¥å£å¤„ä¸º0æ‰èƒ½é©±åŠ¨ï¼›ç™½è‰²ä¸‰è§’æ˜¯éé—¨ï¼Œå·¦è¾¹ç»™1/0å³è¾¹å0/1</p><p><img src="/../../../../medias/blog_picture/51/66.png"></p><h2 id="ç»å…¸ä¸Šä»£ç "><a href="#ç»å…¸ä¸Šä»£ç " class="headerlink" title="ç»å…¸ä¸Šä»£ç "></a>ç»å…¸ä¸Šä»£ç </h2><h4 id="main-c"><a href="#main-c" class="headerlink" title="main.c"></a>main.c</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;REGX52.H&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Delay.h"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Key.h"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Nixie.h"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Buzzer.h"</span></span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> KeyNum<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>KeyNum<span class="token operator">=</span><span class="token function">Key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>KeyNum<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">Buzzer_Time</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Nixie</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>KeyNum<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="Key-c"><a href="#Key-c" class="headerlink" title="Key.c"></a>Key.c</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;REGX52.H&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Delay.h"</span></span><span class="token comment">/**  * @brief  è·å–ç‹¬ç«‹æŒ‰é”®é”®ç   * @param  æ—   * @retval æŒ‰ä¸‹æŒ‰é”®çš„é”®ç ï¼ŒèŒƒå›´ï¼š0~4ï¼Œæ— æŒ‰é”®æŒ‰ä¸‹æ—¶è¿”å›å€¼ä¸º0  */</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">Key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> KeyNumber<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>P3_1<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>P3_1<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>KeyNumber<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span>P3_0<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>P3_0<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>KeyNumber<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span>P3_2<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>P3_2<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>KeyNumber<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span>P3_3<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>P3_3<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>KeyNumber<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">return</span> KeyNumber<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="Nixie-c"><a href="#Nixie-c" class="headerlink" title="Nixie.c"></a>Nixie.c</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;REGX52.H&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Delay.h"</span><span class="token comment">//åŒ…å«Delayå¤´æ–‡ä»¶</span></span><span class="token comment">//æ•°ç ç®¡æ®µç è¡¨</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> NixieTable<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0x3F</span><span class="token punctuation">,</span><span class="token number">0x06</span><span class="token punctuation">,</span><span class="token number">0x5B</span><span class="token punctuation">,</span><span class="token number">0x4F</span><span class="token punctuation">,</span><span class="token number">0x66</span><span class="token punctuation">,</span><span class="token number">0x6D</span><span class="token punctuation">,</span><span class="token number">0x7D</span><span class="token punctuation">,</span><span class="token number">0x07</span><span class="token punctuation">,</span><span class="token number">0x7F</span><span class="token punctuation">,</span><span class="token number">0x6F</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//æ•°ç ç®¡æ˜¾ç¤ºå­å‡½æ•°</span><span class="token keyword">void</span> <span class="token function">Nixie</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> Location<span class="token punctuation">,</span>Number<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">switch</span><span class="token punctuation">(</span>Location<span class="token punctuation">)</span><span class="token comment">//ä½ç è¾“å‡º</span><span class="token punctuation">{</span><span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>P2_4<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>P2_3<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>P2_2<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>P2_4<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>P2_3<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>P2_2<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>P2_4<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>P2_3<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>P2_2<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>P2_4<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>P2_3<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>P2_2<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span>P2_4<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>P2_3<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>P2_2<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">case</span> <span class="token number">6</span><span class="token operator">:</span>P2_4<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>P2_3<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>P2_2<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">case</span> <span class="token number">7</span><span class="token operator">:</span>P2_4<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>P2_3<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>P2_2<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">case</span> <span class="token number">8</span><span class="token operator">:</span>P2_4<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>P2_3<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>P2_2<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">}</span>P0<span class="token operator">=</span>NixieTable<span class="token punctuation">[</span>Number<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//æ®µç è¾“å‡º</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="Buzzer-c"><a href="#Buzzer-c" class="headerlink" title="Buzzer.c"></a>Buzzer.c</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;REGX52.H&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Delay.h"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;INTRINS.H&gt;</span></span><span class="token comment">//èœ‚é¸£å™¨ç«¯å£ï¼š</span>sbit Buzzer<span class="token operator">=</span>P2<span class="token operator">^</span><span class="token number">5</span><span class="token punctuation">;</span><span class="token comment">/**  * @brief  èœ‚é¸£å™¨ç§æœ‰å»¶æ—¶å‡½æ•°ï¼Œå»¶æ—¶500ms  * @param  æ—   * @retval æ—   */</span><span class="token keyword">void</span> <span class="token function">Buzzer_Delay500us</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//@11.0592MHzï¼Œä¸“é—¨ä¸ºèœ‚é¸£å™¨å†™äº†ä¸€ä¸ª</span><span class="token punctuation">{</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> i<span class="token punctuation">;</span><span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>i <span class="token operator">=</span> <span class="token number">227</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">/**  * @brief  èœ‚é¸£å™¨å‘å£°  * @param  msï¼Œå‘å£°çš„æ—¶é•¿  * @retval æ—   */</span><span class="token keyword">void</span> <span class="token function">Buzzer_Time</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> ms<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//åŸæ¥çš„Delayæœ€å°æ˜¯1ms(åŠä¸ªå‘¨æœŸ)ï¼Œé‚£ä¹ˆ1ä¸ªå‘¨æœŸæ˜¯2msï¼Œèƒ½è¾¾åˆ°çš„èœ‚é¸£å™¨æœ€å¤§é¢‘ç‡æ˜¯1/2*0.1^3=500Hzï¼Œèœ‚é¸£å™¨æ ‡å‡†æç¤ºéŸ³æ˜¯1000Hz</span><span class="token comment">//æ ¹æ®f=1/Tï¼ŒDelay(æ¨¡å—ï¼Œä¸å»ºè®®ä¿®æ”¹)çš„åº”è¯¥è¦æ›´å°ï¼Œä½†æ˜¯1å·²ç»æ˜¯æœ€å°çš„</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span><span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>ms<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//ç”¨forå¾ªç¯æ˜¯ä¸ºäº†è®©èœ‚é¸£å™¨å“çš„ä¹…ä¸€ç‚¹</span>        <span class="token comment">//*2çš„åŸå› ï¼šç°åœ¨çš„msä»£è¡¨500usï¼Œä¸ä¹˜äºŒï¼Œå®ƒåªå“ms/2æ¯«ç§’ï¼Œä¹˜ä»¥äºŒæ‰æ˜¯å“msæ¯«ç§’</span><span class="token punctuation">{</span>Buzzer<span class="token operator">=</span><span class="token operator">!</span>Buzzer<span class="token punctuation">;</span><span class="token comment">//å‘å£°éœ€è¦ç¿»è½¬ä¸¤æ¬¡ioå£</span><span class="token function">Buzzer_Delay500us</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åŠä¸ªå‘¨æœŸ500usï¼Œä¸€ä¸ªå‘¨æœŸ1000usï¼Œé¢‘ç‡1000Hz=1/1000*0.1^6</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="Buzzer-h"><a href="#Buzzer-h" class="headerlink" title="Buzzer.h"></a>Buzzer.h</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__Buzzer_H__</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__Buzzer_H__</span></span>sbit Buzzer<span class="token operator">=</span>P2<span class="token operator">^</span><span class="token number">5</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">Buzzer_Time</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> ms<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="éŸ³ä¹"><a href="#éŸ³ä¹" class="headerlink" title="éŸ³ä¹"></a>éŸ³ä¹</h2><p>éŸ³ç¬¦â€“&gt;é¢‘ç‡(Hz)â€“&gt;å‘¨æœŸ(us)â€“&gt;å‘¨æœŸ/2(us)â€“&gt;å–æ•´â€“&gt;<strong>é‡è£…æ•°å€¼(ç”¨åˆ°å®šæ—¶å™¨)</strong></p><p><strong>å‘¨æœŸ</strong>=1/é¢‘ç‡</p><p><strong>å‘¨æœŸ/2</strong>ï¼šåŠä¸ªå‘¨æœŸç¿»è½¬ä¸€æ¬¡</p><p>å‘¨æœŸ/2-å°æ•°ç‚¹=<strong>å–æ•´</strong></p><p>65535-å–æ•´=<strong>é‡è£…æ•°å€¼</strong></p><h4 id="ç”¨å®šæ—¶å™¨æ“æ§é¢‘ç‡"><a href="#ç”¨å®šæ—¶å™¨æ“æ§é¢‘ç‡" class="headerlink" title="ç”¨å®šæ—¶å™¨æ“æ§é¢‘ç‡"></a>ç”¨å®šæ—¶å™¨æ“æ§é¢‘ç‡</h4><h4 id="main-c-1"><a href="#main-c-1" class="headerlink" title="main.c"></a>main.c</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;REGX52.H&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Delay.h"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Time0.h"</span></span>sbit Buzzer<span class="token operator">=</span>P2<span class="token operator">^</span><span class="token number">5</span><span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> FreqTable<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">63628</span><span class="token punctuation">,</span><span class="token number">63731</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//å­˜æ”¾æ¯ä¸ªéŸ³çš„é‡è½½æ•°å€¼</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> FreqSelect<span class="token punctuation">;</span><span class="token comment">//å¯¹äºæ•°ç»„FreqTableä¸­æ¯ä¸ªæ•°æ®å¯¹åº”çš„Index</span><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">Timer0Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>FreqSelect<span class="token operator">++</span><span class="token punctuation">;</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åœ¨ä¸­æ–­é‡Œæ¯ä¸ª500msè‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªéŸ³</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">Timer0_Routine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> interrupt <span class="token number">1</span><span class="token comment">//å®šæ—¶å™¨åˆå§‹åŒ–æ¯éš”1msè¿›è¡Œä¸€æ¬¡ï¼Œæ‰€ä»¥æ¯éš”1msä¸­æ–­ä¸€æ¬¡</span><span class="token punctuation">{</span>TL0 <span class="token operator">=</span> FreqTable<span class="token punctuation">[</span>FreqSelect<span class="token punctuation">]</span><span class="token operator">%</span><span class="token number">256</span><span class="token punctuation">;</span><span class="token comment">//è®¾ç½®å®šæ—¶åˆå€¼</span>TH0 <span class="token operator">=</span> FreqTable<span class="token punctuation">[</span>FreqSelect<span class="token punctuation">]</span><span class="token operator">/</span><span class="token number">256</span><span class="token punctuation">;</span><span class="token comment">//è®¾ç½®å®šæ—¶åˆå€¼</span><span class="token comment">//è·Ÿå­å‡½æ•°é‡Œçš„è®¾ç½®ä¸åŒåœ¨äºï¼Œä¹‹åçš„æº¢å‡ºéƒ½æ˜¯è¿™é‡Œç®¡ç†çš„ï¼Œå­å‡½æ•°é‚£åªç®¡ç†ä¸€æ¬¡</span>Buzzer<span class="token operator">=</span><span class="token operator">!</span>Buzzer<span class="token punctuation">;</span> <span class="token comment">//ç›´æ¥ç¿»è½¬ï¼Œä¸€ä¸ªå‘¨æœŸæ˜¯2*1ms(ç¿»è½¬ä¸¤æ¬¡æ‰æ˜¯ä¸€ä¸ªå‘¨æœŸ)ï¼Œé¢‘ç‡=1/2*1*0.1^3=500Hz</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="Timer0-c"><a href="#Timer0-c" class="headerlink" title="Timer0.c"></a>Timer0.c</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;REGX52.H&gt;</span></span><span class="token comment">/**  * @brief  å®šæ—¶å™¨0åˆå§‹åŒ–ï¼Œ1ms@11.0592MH  * @param  æ—   * @retval æ—   */</span><span class="token keyword">void</span> <span class="token function">Timer0Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token comment">//1æ¯«ç§’@11.0592MHz</span><span class="token punctuation">{</span>TMOD <span class="token operator">&amp;=</span> <span class="token number">0xF0</span><span class="token punctuation">;</span><span class="token comment">//è®¾ç½®å®šæ—¶å™¨æ¨¡å¼</span>TMOD <span class="token operator">|=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>TL0 <span class="token operator">=</span> <span class="token number">0x66</span><span class="token punctuation">;</span><span class="token comment">//è®¾ç½®å®šæ—¶åˆå€¼</span>TH0 <span class="token operator">=</span> <span class="token number">0xFC</span><span class="token punctuation">;</span><span class="token comment">//è®¾ç½®å®šæ—¶åˆå€¼</span><span class="token comment">//TH0å’ŒTL0æ— å…³ç´§è¦ï¼Œä»–ä»¬åªå†³å®šç¬¬ä¸€æ¬¡ä¸­æ–­æ—¶é—´ï¼Œå› ä¸ºæº¢å‡ºä¹‹åä»–ä»¬ä¸æ¸…é›¶ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥ä¸æ”¹ï¼Œåªæ”¹ä¸»å‡½æ•°é‡Œçš„</span>TF0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//æ¸…é™¤TF0æ ‡å¿—</span>TR0 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//å®šæ—¶å™¨0å¼€å§‹è®¡æ—¶</span>ET0<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>          <span class="token comment">//å…è®¸ä¸­æ–­</span>EA<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>PT0<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">/*å®šæ—¶å™¨ä¸­æ–­å‡½æ•°æ¨¡æ¿void Timer0_Routine() interrupt 1{static unsigned int T0Count;//ä¸ºäº†ä¸ä¸¢å¤±è¿™ä¸ªæ•°å­—TL0 = 0x66;//è®¾ç½®å®šæ—¶åˆå€¼TH0 = 0xFC;//è®¾ç½®å®šæ—¶åˆå€¼T0Count++;if(T0Count&gt;=1000){T0Count=0;}}*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 51å•ç‰‡æœº </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 51å•ç‰‡æœº </tag>
            
            <tag> å¤§äº‘å±‹è€ƒæ ¸ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Calculatorç®€æ˜“è®¡ç®—å™¨</title>
      <link href="/2022/10/13/jian-yi-ji-suan-qi/"/>
      <url>/2022/10/13/jian-yi-ji-suan-qi/</url>
      
        <content type="html"><![CDATA[<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;windows.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;math.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;string.h&gt;</span></span><span class="token keyword">int</span> o_top <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//ç¬¦å·æ ˆå¤´</span><span class="token keyword">int</span> num_top <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//æ•°å­—æ ˆå¤´ </span><span class="token keyword">char</span> o_s<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//ç¬¦å·æ ˆ </span><span class="token keyword">int</span> num_s<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//æ•°å­—æ ˆ </span><span class="token keyword">int</span> <span class="token function">jop</span><span class="token punctuation">(</span><span class="token keyword">char</span> o<span class="token punctuation">)</span><span class="token comment">//åˆ¤æ–­ç¬¦å·ç­‰çº§ judge_operator_priority</span><span class="token punctuation">{</span><span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">==</span> <span class="token char">'('</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">==</span> <span class="token char">'+'</span> <span class="token operator">||</span> o <span class="token operator">==</span> <span class="token char">'-'</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">==</span> <span class="token char">'*'</span> <span class="token operator">||</span> o <span class="token operator">==</span> <span class="token char">'/'</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">==</span> <span class="token char">'^'</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">4</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">//æ“ä½œç¬¦å‡ºæ ˆ </span><span class="token keyword">void</span> <span class="token function">o_push</span><span class="token punctuation">(</span><span class="token keyword">char</span> o<span class="token punctuation">)</span><span class="token punctuation">{</span>o_top<span class="token operator">++</span><span class="token punctuation">;</span>o_s<span class="token punctuation">[</span>o_top<span class="token punctuation">]</span> <span class="token operator">=</span> o<span class="token punctuation">;</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">//æ“ä½œæ•°å‡ºæ ˆ </span><span class="token keyword">void</span> <span class="token function">num_push</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span><span class="token punctuation">{</span>num_top<span class="token operator">++</span><span class="token punctuation">;</span>num_s<span class="token punctuation">[</span>num_top<span class="token punctuation">]</span> <span class="token operator">=</span> n<span class="token punctuation">;</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">//è‡ªå®šä¹‰ä¸¤å…ƒè¿ç®—</span><span class="token comment">//è¯´æ˜:operand1å…ˆè¿›åå‡ºï¼Œoperand2åè¿›å…ˆå‡ºï¼Œæ‰€ä»¥è¿ç®—çš„è¡¨è¾¾å¼åº”è¯¥ä¸º&lt;operand1&gt;&lt;oeprator&gt;&lt;operand2&gt; </span><span class="token keyword">int</span> <span class="token function">math</span><span class="token punctuation">(</span><span class="token keyword">int</span> n1<span class="token punctuation">,</span> <span class="token keyword">int</span> n2<span class="token punctuation">,</span> <span class="token keyword">char</span> o<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">==</span> <span class="token char">'+'</span><span class="token punctuation">)</span><span class="token keyword">return</span> n1 <span class="token operator">+</span> n2<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">==</span> <span class="token char">'-'</span><span class="token punctuation">)</span><span class="token keyword">return</span> n1 <span class="token operator">-</span> n2<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">==</span> <span class="token char">'*'</span><span class="token punctuation">)</span><span class="token keyword">return</span> n1 <span class="token operator">*</span> n2<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">==</span> <span class="token char">'/'</span> <span class="token operator">&amp;&amp;</span> n2 <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> n1 <span class="token operator">/</span> n2<span class="token punctuation">;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">==</span> <span class="token char">'/'</span> <span class="token operator">&amp;&amp;</span> n2 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"å‡ºé”™ï¼\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"pause"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">==</span> <span class="token char">'^'</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token function">pow</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"WBç‰ˆè®¡ç®—å™¨ç”±äºæŠ€æœ¯åŸå› ï¼Œä»…æ”¯æŒä»¥ä¸‹è¿ç®—....\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Sleep(1500);</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"1.å¸¦æ‹¬å·çš„+-*/è¿ç®—\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Sleep(1500);</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"2.è¿›åˆ¶è½¬æ¢è®¡ç®—\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Sleep(1500);</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ç°åœ¨ï¼Œè¯·ä½ è¾“å…¥â€œ1â€æˆ–â€œ2â€è¿›è¡Œè¿ç®—:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> choice<span class="token punctuation">;</span><span class="token function">scanf_s</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>choice<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/*å½“ç”¨æˆ·è¾“å…¥1æ—¶ï¼Œè¿›å…¥4+1è¿ç®—*/</span><span class="token comment">/*æµ…è°ˆè§„åˆ™ï¼š1.æ“ä½œç¬¦æ ˆæ ˆé¡¶ä¸ºç©º æˆ– æ ˆé¡¶æ“ä½œç¬¦ä¼˜å…ˆçº§&lt;å½“å‰æ“ä½œç¬¦ æ—¶ï¼Œå½“å‰æ“ä½œç¬¦å…¥æ ˆ2.æ ˆé¡¶æ“ä½œç¬¦ä¼˜å…ˆçº§&gt;ç›®å‰æ“ä½œç¬¦ ä¸” æ•°æ®æ ˆè‡³å°‘æœ‰2ä¸ªæ“ä½œæ•° ä¸” æ ˆé¡¶ä¸ä¸º( æ—¶ï¼Œæ ˆé¡¶æ“ä½œç¬¦å‡ºæ ˆ3.whlieå¾ªç¯æ¬¡æ•°æ˜¯&lt;è€Œä¸æ˜¯&lt;= çš„åŸå› :æœ€åå‡ºç°x1(ç”±è¿™ä¸ªwhileå¾ªç¯è®¡ç®—å¾—åˆ°çš„æ•°æ®)o x2(åŸè¡¨è¾¾å¼æœ€åçš„æ“ä½œæ•°)4.æ¯æ¬¡è¿ç®—å(è°ƒç”¨äº†mathå‡½æ•°å)ï¼Œå°†è¯¥æ¬¡è¿ç®—ç»“æœæ”¾å›æ ˆä¸­(è¡¥åˆ°æ ˆé¡¶ä¸‹é¢é‚£ä¸ª)ï¼Œç„¶åå†å£°æ˜æ ˆé¡¶è®¾å…¶ä¸º0ï¼Œè¿›è¡Œæ ˆé¡¶--ï¼Œä½¿æ ˆé¡¶å›åˆ°å«æœ‰æœ‰æ•ˆæ•°æ®é‚£*/</span><span class="token keyword">if</span> <span class="token punctuation">(</span>choice <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">char</span> str<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//è®°å½•ç®—å¼</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Please enter the equation(no space):\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token function">gets</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> size<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span> <span class="token punctuation">(</span>str<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'('</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">o_push</span><span class="token punctuation">(</span>str<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>str<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&gt;=</span> <span class="token char">'0'</span> <span class="token operator">&amp;&amp;</span> str<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token char">'9'</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">int</span> t <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span>str<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&gt;=</span> <span class="token char">'0'</span> <span class="token operator">&amp;&amp;</span> str<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token char">'9'</span> <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">)</span><span class="token punctuation">{</span>t <span class="token operator">=</span> t <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">+</span> <span class="token punctuation">(</span>str<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">48</span><span class="token punctuation">)</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">num_push</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">//+ -</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>str<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'+'</span> <span class="token operator">||</span> str<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'-'</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span> <span class="token punctuation">(</span>o_top <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">jop</span><span class="token punctuation">(</span>num_s<span class="token punctuation">[</span>o_top<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">o_push</span><span class="token punctuation">(</span>str<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">jop</span><span class="token punctuation">(</span>o_s<span class="token punctuation">[</span>o_top<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">||</span> <span class="token function">jop</span><span class="token punctuation">(</span>o_s<span class="token punctuation">[</span>o_top<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span> <span class="token operator">||</span> <span class="token function">jop</span><span class="token punctuation">(</span>o_s<span class="token punctuation">[</span>o_top<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span> <span class="token punctuation">(</span>o_top <span class="token operator">&gt;=</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> num_top <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token function">jop</span><span class="token punctuation">(</span>o_s<span class="token punctuation">[</span>o_top<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">int</span> n1 <span class="token operator">=</span> num_s<span class="token punctuation">[</span>num_top <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">int</span> n2 <span class="token operator">=</span> num_s<span class="token punctuation">[</span>num_top<span class="token punctuation">]</span><span class="token punctuation">;</span>num_s<span class="token punctuation">[</span>num_top <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">math</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> o_s<span class="token punctuation">[</span>o_top<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>num_s<span class="token punctuation">[</span>num_top<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>o_s<span class="token punctuation">[</span>o_top<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>num_top<span class="token operator">--</span><span class="token punctuation">;</span> o_top<span class="token operator">--</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">o_push</span><span class="token punctuation">(</span>str<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>i<span class="token operator">++</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">//* /</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>str<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'*'</span> <span class="token operator">||</span> str<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'/'</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span> <span class="token punctuation">(</span>o_top <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">jop</span><span class="token punctuation">(</span>o_s<span class="token punctuation">[</span>o_top<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">||</span> <span class="token function">jop</span><span class="token punctuation">(</span>o_s<span class="token punctuation">[</span>o_top<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">o_push</span><span class="token punctuation">(</span>str<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">jop</span><span class="token punctuation">(</span>o_s<span class="token punctuation">[</span>o_top<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">||</span> <span class="token function">jop</span><span class="token punctuation">(</span>o_s<span class="token punctuation">[</span>o_top<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span> <span class="token punctuation">(</span>o_top <span class="token operator">&gt;=</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> num_top <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token function">jop</span><span class="token punctuation">(</span>o_s<span class="token punctuation">[</span>o_top<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">int</span> n1 <span class="token operator">=</span> num_s<span class="token punctuation">[</span>num_top <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">int</span> n2 <span class="token operator">=</span> num_s<span class="token punctuation">[</span>num_top<span class="token punctuation">]</span><span class="token punctuation">;</span>num_s<span class="token punctuation">[</span>num_top <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">math</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> o_s<span class="token punctuation">[</span>o_top<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>num_s<span class="token punctuation">[</span>num_top<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>o_s<span class="token punctuation">[</span>o_top<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>num_top<span class="token operator">--</span><span class="token punctuation">;</span> o_top<span class="token operator">--</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">o_push</span><span class="token punctuation">(</span>str<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>i<span class="token operator">++</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">// ^ </span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>str<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'^'</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span> <span class="token punctuation">(</span>o_top <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">jop</span><span class="token punctuation">(</span>o_s<span class="token punctuation">[</span>o_top<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">||</span> <span class="token function">jop</span><span class="token punctuation">(</span>o_s<span class="token punctuation">[</span>o_top<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">||</span> <span class="token function">jop</span><span class="token punctuation">(</span>o_s<span class="token punctuation">[</span>o_top<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">o_push</span><span class="token punctuation">(</span>str<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">jop</span><span class="token punctuation">(</span>o_s<span class="token punctuation">[</span>o_top<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span> <span class="token punctuation">(</span>o_top <span class="token operator">&gt;=</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> num_top <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token function">jop</span><span class="token punctuation">(</span>o_s<span class="token punctuation">[</span>o_top<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">int</span> n1 <span class="token operator">=</span> num_s<span class="token punctuation">[</span>num_top <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">int</span> n2 <span class="token operator">=</span> num_s<span class="token punctuation">[</span>num_top<span class="token punctuation">]</span><span class="token punctuation">;</span>num_s<span class="token punctuation">[</span>num_top <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">math</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> o_s<span class="token punctuation">[</span>o_top<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>num_s<span class="token punctuation">[</span>num_top<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>o_s<span class="token punctuation">[</span>o_top<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>num_top<span class="token operator">--</span><span class="token punctuation">;</span> o_top<span class="token operator">--</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">o_push</span><span class="token punctuation">(</span>str<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>i<span class="token operator">++</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">// )</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>str<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">')'</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">do</span> <span class="token punctuation">{</span><span class="token keyword">int</span> n1 <span class="token operator">=</span> num_s<span class="token punctuation">[</span>num_top <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">int</span> n2 <span class="token operator">=</span> num_s<span class="token punctuation">[</span>num_top<span class="token punctuation">]</span><span class="token punctuation">;</span>num_s<span class="token punctuation">[</span>num_top <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">math</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> o_s<span class="token punctuation">[</span>o_top<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>num_s<span class="token punctuation">[</span>num_top<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>o_s<span class="token punctuation">[</span>o_top<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>num_top<span class="token operator">--</span><span class="token punctuation">;</span> o_top<span class="token operator">--</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">jop</span><span class="token punctuation">(</span>o_s<span class="token punctuation">[</span>o_top<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> o_top <span class="token operator">&gt;=</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> num_top <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>o_s<span class="token punctuation">[</span>o_top<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>o_top<span class="token operator">--</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">//æœ€ååªå‰©ä¸‹ä¸¤ä¸ªæ“ä½œæ•°å’Œä¸€ä¸ªæ“ä½œç¬¦ï¼Œç›´æ¥äºŒå…ƒè¿ç®— </span><span class="token keyword">while</span> <span class="token punctuation">(</span>o_top <span class="token operator">&gt;=</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> num_top <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">int</span> n1 <span class="token operator">=</span> num_s<span class="token punctuation">[</span>num_top <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">int</span> n2 <span class="token operator">=</span> num_s<span class="token punctuation">[</span>num_top<span class="token punctuation">]</span><span class="token punctuation">;</span>num_s<span class="token punctuation">[</span>num_top <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">math</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> o_s<span class="token punctuation">[</span>o_top<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>num_s<span class="token punctuation">[</span>num_top<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>o_s<span class="token punctuation">[</span>o_top<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>num_top<span class="token operator">--</span><span class="token punctuation">;</span> o_top<span class="token operator">--</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> num_s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">/*å½“ç”¨æˆ·è¾“å…¥2æ—¶ï¼Œè¿›è¡Œè¿›åˆ¶è½¬æ¢*/</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>choice <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">/**  nè¿›åˆ¶è½¬10è¿›åˆ¶*/</span><span class="token keyword">int</span> pr<span class="token punctuation">;</span><span class="token comment">//previous,å…ˆå‰çš„è¿›åˆ¶ </span><span class="token keyword">int</span> fn<span class="token punctuation">;</span><span class="token comment">//finalï¼Œæœ€åçš„è¿›åˆ¶</span><span class="token keyword">int</span> size<span class="token punctuation">;</span><span class="token comment">//ç”¨äºæµ‹é‡é•¿åº¦ </span><span class="token keyword">int</span> i<span class="token punctuation">;</span><span class="token keyword">int</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">char</span> ch<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"0"</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"å³å°†è¾“å…¥ä¸‰ä¸ªæ•°å­—ï¼Œè¾“å…¥æ¯ä¸ªæ•°å­—åï¼ŒæŒ‰å›è½¦è½¬è·³ä¸‹ä¸€ä¸ªè¾“å…¥å†…å®¹......\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"è¯·è¾“å…¥åŸè¿›åˆ¶ï¼š"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">scanf_s</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"è¯·è¾“å…¥åŸæ•°æ®ï¼š"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">scanf_s</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"è¯·è¾“å…¥æƒ³è¦è½¬æ¢æˆçš„æ•°æ®çš„è¿›åˆ¶ï¼š"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">scanf_s</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>size <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">int</span> temp1 <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span>pr<span class="token punctuation">,</span> size <span class="token operator">-</span> i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> temp2 <span class="token operator">=</span> ch<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">switch</span> <span class="token punctuation">(</span>ch<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">case</span> <span class="token char">'A'</span><span class="token operator">:</span>sum <span class="token operator">+=</span> <span class="token punctuation">(</span>temp2 <span class="token operator">-</span> <span class="token number">55</span><span class="token punctuation">)</span> <span class="token operator">*</span> temp1<span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">case</span> <span class="token char">'B'</span><span class="token operator">:</span>sum <span class="token operator">+=</span> <span class="token punctuation">(</span>temp2 <span class="token operator">-</span> <span class="token number">55</span><span class="token punctuation">)</span> <span class="token operator">*</span> temp1<span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">case</span> <span class="token char">'C'</span><span class="token operator">:</span>sum <span class="token operator">+=</span> <span class="token punctuation">(</span>temp2 <span class="token operator">-</span> <span class="token number">55</span><span class="token punctuation">)</span> <span class="token operator">*</span> temp1<span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">case</span> <span class="token char">'D'</span><span class="token operator">:</span>sum <span class="token operator">+=</span> <span class="token punctuation">(</span>temp2 <span class="token operator">-</span> <span class="token number">55</span><span class="token punctuation">)</span> <span class="token operator">*</span> temp1<span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">case</span> <span class="token char">'E'</span><span class="token operator">:</span>sum <span class="token operator">+=</span> <span class="token punctuation">(</span>temp2 <span class="token operator">-</span> <span class="token number">55</span><span class="token punctuation">)</span> <span class="token operator">*</span> temp1<span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">case</span> <span class="token char">'F'</span><span class="token operator">:</span>sum <span class="token operator">+=</span> <span class="token punctuation">(</span>temp2 <span class="token operator">-</span> <span class="token number">55</span><span class="token punctuation">)</span> <span class="token operator">*</span> temp1<span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">default</span><span class="token operator">:</span>sum <span class="token operator">+=</span> <span class="token punctuation">(</span>temp2 <span class="token operator">-</span> <span class="token number">48</span><span class="token punctuation">)</span> <span class="token operator">*</span> temp1<span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">/**10è¿›åˆ¶è½¬nè¿›åˆ¶*/</span><span class="token keyword">char</span> ans<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"0"</span><span class="token punctuation">;</span><span class="token comment">//ç­”æ¡ˆå­˜æ”¾ </span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span>sum <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">switch</span> <span class="token punctuation">(</span>sum <span class="token operator">%</span> fn<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">case</span> <span class="token number">10</span><span class="token operator">:</span>ans<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'A'</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">case</span> <span class="token number">11</span><span class="token operator">:</span>ans<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'B'</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">case</span> <span class="token number">12</span><span class="token operator">:</span>ans<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'C'</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">case</span> <span class="token number">13</span><span class="token operator">:</span>ans<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'D'</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">case</span> <span class="token number">14</span><span class="token operator">:</span>ans<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'E'</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">case</span> <span class="token number">15</span><span class="token operator">:</span>ans<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'F'</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">default</span><span class="token operator">:</span>ans<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>sum <span class="token operator">%</span> fn<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">48</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">}</span>j<span class="token operator">++</span><span class="token punctuation">;</span>sum <span class="token operator">/=</span> fn<span class="token punctuation">;</span><span class="token punctuation">}</span>j<span class="token operator">--</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> j <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%c"</span><span class="token punctuation">,</span> ans<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Cè¯­è¨€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å¤§äº‘å±‹è€ƒæ ¸ </tag>
            
            <tag> Cè¯­è¨€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç‚¹é˜µå±</title>
      <link href="/2022/10/12/dian-zhen-ping/"/>
      <url>/2022/10/12/dian-zhen-ping/</url>
      
        <content type="html"><![CDATA[<h1 id="ç‚¹é˜µå±"><a href="#ç‚¹é˜µå±" class="headerlink" title="ç‚¹é˜µå±"></a>ç‚¹é˜µå±</h1><p>è·Ÿæ•°ç ç®¡åŸç†æœ‰ä¸€äº›ç±»ä¼¼</p><p><img src="/../../../../medias/blog_picture/51/4.png" alt="æ˜¾ç¤ºåŸç†"></p><p><img src="/../../../../medias/blog_picture/51/5.png" alt="è¡Œä¸åˆ—çš„æ§åˆ¶å…³ç³»"></p><p>åœˆèµ·æ¥éƒ¨åˆ†ç”¨æ¥æ§åˆ¶<strong>è¡Œ</strong>æˆ–<strong>åˆ—</strong></p><p><img src="/../../../../medias/blog_picture/51/6.png" alt="å¼€å‘æ¿å¼•è„šå¯¹åº”å…³ç³»"></p><p>åˆ—ç›´æ¥ç»™P0èµ‹å€¼æ¥æ§åˆ¶</p><p>ä½†æ˜¯è¡Œè¦ç”¨åˆ°74HC595</p><p>æå‡ºï¼šè‹¥æ˜¯å•ç‰‡æœºä¸Šåªæœ‰è¿™ä¸ªLEDç‚¹é˜µå±ï¼Œå…¶ä»–éƒ½ä¸è¦ï¼Œå¯ä¸å¯ä»¥æŠŠD1-D7çš„æ¥åœ¨P1å£ä¸Š</p><p>å›ç­”ï¼šä¸è¡Œï¼Œå› ä¸ºå•ç‰‡æœºçš„IOå£æ˜¯å¼±ä¸Šæ‹‰ç‰¹æ€§</p><p>å¼±ä¸Šæ‹‰ï¼šè¾“å‡º**ä½ç”µå¹³(ç›´æ¥æ¥GND)<strong>æ—¶ç”µæµå¯ä»¥å¾ˆå¤§ï¼Œè¾“å‡º</strong>é«˜ç”µå¹³(ç›¸å½“äºæ¥äº†ä¸€ä¸ªç”µé˜»å†æ¥VCC)**æ—¶ç”µæµå¾ˆå°</p><p><img src="/../../../../medias/blog_picture/51/7.png" alt="IOå£">ç”¨åˆ°ä¸‰æç®¡ï¼Œæ¥IOå£å°±å¯ä»¥</p><p>IOå£ä½ç”µå¹³ï¼ŒVCCç›´æ¥é€šåˆ°4é‚£ï¼ŒIOèµ·æ§åˆ¶ä½œç”¨ï¼Œè‡ªå·±å¹²ä¸åŠ¨ä¸å¹²æ´»è€ŒæŒ‡ä½¿åˆ«äººå¹²æ´»</p><p>IOå£ç»™é«˜ç”µå¹³çš„æ—¶å€™å°±ä¼šæˆªæ­¢ï¼Œç›¸å½“äºæ²¡æœ‰æ¥</p><h2 id="IOå£æ‰©å±•"><a href="#IOå£æ‰©å±•" class="headerlink" title="IOå£æ‰©å±•"></a>IOå£æ‰©å±•</h2><h3 id="OE-output-enableè¾“å‡ºä½¿èƒ½"><a href="#OE-output-enableè¾“å‡ºä½¿èƒ½" class="headerlink" title="OE(output enableè¾“å‡ºä½¿èƒ½)"></a>OE(output enableè¾“å‡ºä½¿èƒ½)</h3><p><img src="/../../../../medias/blog_picture/51/8.png" alt="OE"></p><h3 id="å¯„å­˜å™¨æ—¶é’Ÿï¼ŒRCLK-register-clock"><a href="#å¯„å­˜å™¨æ—¶é’Ÿï¼ŒRCLK-register-clock" class="headerlink" title="å¯„å­˜å™¨æ—¶é’Ÿï¼ŒRCLK(register clock)"></a>å¯„å­˜å™¨æ—¶é’Ÿï¼ŒRCLK(register clock)</h3><p>ä¸Šæ–¹æœ‰â€”ï¼Œè¡¨ç¤ºå®ƒè¦æ¥ä½ç”µå¹³ï¼Œæ‰€ä»¥JOEé‚£è¦å’ŒGNDçŸ­æ¥ï¼Œæ‰èƒ½æœ‰è¾“å‡º</p><p><img src="/../../../../medias/blog_picture/51/9.png" alt="RCLK"></p><h3 id="SRCLRä¸²è¡Œæ¸…é›¶ç«¯"><a href="#SRCLRä¸²è¡Œæ¸…é›¶ç«¯" class="headerlink" title="SRCLRä¸²è¡Œæ¸…é›¶ç«¯"></a>SRCLRä¸²è¡Œæ¸…é›¶ç«¯</h3><p>æ¥äº†VCCä»£è¡¨å®ƒä¸æ¸…ç©º</p><p><img src="/../../../../medias/blog_picture/51/10.png" alt="SRCLR"></p><h3 id="SRCLKä¸²è¡Œæ—¶é’Ÿ"><a href="#SRCLKä¸²è¡Œæ—¶é’Ÿ" class="headerlink" title="SRCLKä¸²è¡Œæ—¶é’Ÿ"></a>SRCLKä¸²è¡Œæ—¶é’Ÿ</h3><p>ä¸Šå‡æ²¿æ˜¯PWMæ³¢çš„ä»ä½ç”µå¹³åˆ°é«˜ç”µå¹³çš„ä¸€ç¬é—´</p><p><img src="/../../../../medias/blog_picture/51/11.png" alt="SRCLK"></p><h3 id="SERä¸²è¡Œæ•°æ®"><a href="#SERä¸²è¡Œæ•°æ®" class="headerlink" title="SERä¸²è¡Œæ•°æ®"></a>SERä¸²è¡Œæ•°æ®</h3><p><img src="/../../../../medias/blog_picture/51/12.png" alt="SER"></p><p>ä¸»è¦ç”¨è¿™ä¸‰ä¸ªå¼•è„šæ§åˆ¶å…«ä¸ªè¾“å‡º</p><p><img src="/../../../../medias/blog_picture/51/13.png" alt="ä¸‰ä¸ªå¼•è„šæ§åˆ¶å…«ä¸ªè¾“å‡º"></p><h3 id="ä¸²è¡Œvså¹¶è¡Œ"><a href="#ä¸²è¡Œvså¹¶è¡Œ" class="headerlink" title="ä¸²è¡Œvså¹¶è¡Œ"></a>ä¸²è¡Œvså¹¶è¡Œ</h3><p><img src="/../../../../medias/blog_picture/51/14.png" alt="ä¸²è¡Œæ˜¯è¿™æ ·å­ä¸€ä¸ªä¸€ä¸ªå‡ºå»çš„"></p><p>å¹¶è¡Œæ˜¯ç”¨é‚£å…«ä¸ªè¾“å‡ºç«¯åŒæ—¶è¾“å‡º</p><h3 id="ä¸²è¡Œè¾“å…¥-å¹¶è¡Œè¾“å‡º"><a href="#ä¸²è¡Œè¾“å…¥-å¹¶è¡Œè¾“å‡º" class="headerlink" title="ä¸²è¡Œè¾“å…¥ å¹¶è¡Œè¾“å‡º"></a>ä¸²è¡Œè¾“å…¥ å¹¶è¡Œè¾“å‡º</h3><p>æ¯ä¸Šå‡æ²¿ç§»ä½ï¼Œä»SERè¿›çš„æ•°æ®å°±å‘ä¸‹æ²¿ç§»ä½ï¼ŒSERCLKé«˜ç”µå¹³çš„æ—¶å€™ç§»è¿›ï¼Œæ•°æ®ä¸€ä½ä¸€ä½åœ°å¾€å‰èµ°ï¼Œç­‰æœ‰äº†å…«ä½æ•°æ®ä¹‹ååŒæ—¶æ¬è¿‡å»è¾“å‡ºç¼“å­˜é‚£ï¼Œä¸²è¡Œé‚£é‡Œæ¯è¾“å…¥ä¸€ä½ï¼ŒSERæ¸…é›¶ï¼Œæ•°æ®ä¸‹ç§»</p><p><img src="/../../../../medias/blog_picture/51/15.png" alt="74HC595"></p><p>å½“å¯„å­˜å™¨æ»¡ä½åï¼Œç»™RCLKé«˜ç”µå¹³ï¼ŒæŠŠæ•°æ®æ¬è¿åˆ°è¾“å‡ºç¼“å­˜é‚£</p><h3 id="å¤šç‰‡çº§è”"><a href="#å¤šç‰‡çº§è”" class="headerlink" title="å¤šç‰‡çº§è”"></a>å¤šç‰‡çº§è”<img src="/../../../../medias/blog_picture/51/16.png" alt="å¤šç‰‡çº§è”"></h3><p>åœ¨å¯„å­˜å™¨çš„æ•°æ®ä¼ åˆ°QHâ€™ï¼Œç„¶åå¤šç‰‡çº§è”åˆ°ä¸‹ä¸€ä¸ªSERï¼Œå½“æ‰€æœ‰æ•°æ®å°±ä½äº†ï¼Œæ¥ä¸€ä¸ªä¸Šå‡æ²¿é”å­˜ï¼Œæ‰€æœ‰æ•°æ®éƒ½ç›¸åº”åœ°è¾“å‡ºï¼Œå®ç°äº†IOå£çš„æ‰©å±•ï¼Œä½†æ˜¯é€Ÿç‡ä¼šæœ‰æ‰€å‡æ…¢(æ—¶é—´æ¢æ—¶ç©º)</p><h2 id="sfrå’Œsbitå¯ä½å¯»å€-ä¸å¯ä½å¯»å€"><a href="#sfrå’Œsbitå¯ä½å¯»å€-ä¸å¯ä½å¯»å€" class="headerlink" title="sfrå’Œsbitå¯ä½å¯»å€/ä¸å¯ä½å¯»å€"></a>sfrå’Œsbitå¯ä½å¯»å€/ä¸å¯ä½å¯»å€</h2><p>sfrï¼šç‰¹æ®ŠåŠŸèƒ½å¯„å­˜å™¨å£°æ˜(å£°æ˜å¯„å­˜å™¨åœ°å€)ç›¸å½“äºæŠŠæŸä¸ªå…ƒä»¶çš„æ“ä½œåœ°å€èµ‹ç»™ä¸€ä¸ªè‡ªå®šä¹‰çš„å˜é‡åï¼ŒæŠŠç›¸åº”çš„åç§°å’Œåœ°å€ç»™å£°æ˜å‡ºæ¥ï¼Œæˆ‘ä»¬æ‰èƒ½æ“ä½œé‚£ä¸ªåç§°</p><p>sbitï¼šç‰¹æ®Šä½å£°æ˜(å£°æ˜åœ°å€çš„æŸä¸€ä½)</p><p><img src="/../../../../medias/blog_picture/51/17.png" alt="C51çš„sfrã€sbit"></p><p>å¯ä½å¯»å€å’Œä¸å¯ä½å¯»å€å°±ç±»æ¯”äºCè¯­è¨€çš„æ•°ç»„ï¼Œå¯ä½å¯»å€çš„å°±æ˜¯æ•°ç»„çš„é¦–åœ°å€ï¼Œä¸æ˜¯é¦–åœ°å€çš„å°±ä¸èƒ½ä½å¯»å€</p><h2 id="ä¸Šä»£ç -ç¬‘è„¸"><a href="#ä¸Šä»£ç -ç¬‘è„¸" class="headerlink" title="ä¸Šä»£ç (ç¬‘è„¸)"></a>ä¸Šä»£ç (ç¬‘è„¸)</h2><h3 id="main-c"><a href="#main-c" class="headerlink" title="main.c"></a>main.c</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;REGX52.H&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Delay.h"</span></span><span class="token comment">//ç»™IOå£æ”¹å</span>sbit RCK<span class="token operator">=</span>P3<span class="token operator">^</span><span class="token number">5</span><span class="token punctuation">;</span><span class="token comment">//RCLK,åº”è¯¥æ˜¯èµ‹å€¼çš„æ—¶å€™ç”¨_ï¼Œç»™åœ°å€çš„æ—¶å€™ç”¨^ï¼Œè¿™é‡Œæ˜¯è®©rclkç›´æ¥æ‰¾åˆ°p3_5çš„åœ°å€æ‰€ä»¥ç”¨^</span>sbit SCK<span class="token operator">=</span>P3<span class="token operator">^</span><span class="token number">6</span><span class="token punctuation">;</span><span class="token comment">//SRCLK</span>sbit SER<span class="token operator">=</span>P3<span class="token operator">^</span><span class="token number">4</span><span class="token punctuation">;</span><span class="token comment">//SER</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MATRIX_LED_PORT</span> <span class="token expression">P0</span><span class="token comment">//å¦‚æœä»¥åè‡ªå·±ç„Šæ¿å­ç©æ¥å£ä¸å¯¹ï¼Œç›´æ¥æ”¹ä¸Šé¢sbitï¼Œä¸ç”¨å†åœ¨ä¸‹é¢æ”¹äº†</span></span><span class="token comment">/**  * @brief  74HC595å†™å…¥ä¸€ä¸ªå­—èŠ‚  * @param  è¦å†™å…¥çš„å­—èŠ‚  * @retval æ—   */</span><span class="token keyword">void</span> <span class="token function">_74JHC595_WriteByte</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> Byte<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> i<span class="token punctuation">;</span><span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>SER<span class="token operator">=</span>Byte<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">0x80</span><span class="token operator">&gt;&gt;</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//0x80--&gt;1000 0000</span>SCK<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//ç»™é«˜ç”µå¹³å½¢æˆä¸Šå‡æ²¿ä¼ å…¥æ•°æ®</span>SCK<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//ç½®é›¶ä¸ºä¸‹ä¸€æ¬¡ä¼ å…¥åšå‡†å¤‡</span><span class="token punctuation">}</span>RCK<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//é«˜ç”µå¹³ï¼Œå½¢æˆä¸Šå‡æ²¿é”å­˜</span>RCK<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//ç½®é›¶</span><span class="token punctuation">}</span><span class="token comment">/*** @brief  LEDç‚¹é˜µå±æ˜¾ç¤ºä¸€åˆ—æ•°æ®* @param  Column è¦é€‰æ‹©çš„åˆ—ï¼ŒèŒƒå›´0~7ï¼Œ0åœ¨æœ€å·¦è¾¹* @param  Data é€‰æ‹©åˆ—æ˜¾ç¤ºçš„æ•°æ®ï¼Œé«˜ä½åœ¨ä¸Šï¼Œ1ä¸ºäº®ï¼Œ0ä¸ºç­* @retval æ—   */</span><span class="token keyword">void</span> <span class="token function">MatrixLED_ShowColumn</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> Cloumn<span class="token punctuation">,</span>Data<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">_74JHC595_WriteByte</span><span class="token punctuation">(</span>Data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ”¾æ•°æ®</span>MATRIX_LED_PORT<span class="token operator">=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">0x80</span><span class="token operator">&gt;&gt;</span>Cloumn<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä½é€‰ï¼›é€‰æ‹©åˆ—ï¼Œç„¶åæŠŠæ•°æ®0xAAä¼ åˆ°LEDåˆ—ä¸­ï¼›</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å»¶æ—¶</span>MATRIX_LED_PORT<span class="token operator">=</span><span class="token number">0xFF</span><span class="token punctuation">;</span><span class="token comment">//ä½æ¸…é›¶ï¼Œä¸‹ä¸€æ­¥æ˜¯æ®µé€‰ï¼Œè¿™æ ·ä¸‹æ¬¡æ®µé€‰å°±ä¸ä¼šä¸²ä½åˆ°ä¸Šä¸€ä¸ªä½é€‰äº†</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>SCK<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//å› ä¸ºä¸Šç”µé»˜è®¤é«˜ç”µå¹³,å…ˆç½®0ï¼Œæ‰èƒ½ç»™é«˜ç”µå¹³ï¼›éœ€è¦ä¸€ä¸ªä¸Šå‡æ²¿æ‰èƒ½ä¼ å…¥æ•°æ®</span>RCK<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//åˆå§‹åŒ–ä¸ºä½ç”µå¹³</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">MatrixLED_ShowColumn</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x3C</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MatrixLED_ShowColumn</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0x42</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MatrixLED_ShowColumn</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0xA9</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MatrixLED_ShowColumn</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">0x85</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MatrixLED_ShowColumn</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">0x85</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MatrixLED_ShowColumn</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">0xA9</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MatrixLED_ShowColumn</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">0x42</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MatrixLED_ShowColumn</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">0x3C</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="æŠ -ç†-è§£-å¼€æŠ ï¼ï¼ï¼"><a href="#æŠ -ç†-è§£-å¼€æŠ ï¼ï¼ï¼" class="headerlink" title="æŠ  ç† è§£      å¼€æŠ ï¼ï¼ï¼"></a>æŠ  ç† è§£      å¼€æŠ ï¼ï¼ï¼</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>SER<span class="token operator">=</span>Byte<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">0x80</span><span class="token operator">&gt;&gt;</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//0x80--&gt;1000 0000</span>SCK<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//ç»™é«˜ç”µå¹³å½¢æˆä¸Šå‡æ²¿ä¼ å…¥æ•°æ®</span>SCK<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//ç½®é›¶ä¸ºä¸‹ä¸€æ¬¡ä¼ å…¥åšå‡†å¤‡</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>SERæ˜¯ä¸€ä½è€ŒByteæ˜¯8ä½ï¼Œæ¶‰åŠåˆ°ä½å¯¹é½é—®é¢˜</p><p>ç†è§£ï¼šå‡å¦‚Byteæ˜¯0x55(0101 0101)</p><p>i=0(0x80&gt;&gt;i)=1000 0000</p><p>SER=<strong>0</strong>101 0101 &amp; <strong>1</strong>000 0000 =<strong>0</strong>000 0000â€”â€”-æ ¹æ®é<strong>0</strong>å³1ï¼ŒSERä¸º<strong>0</strong></p><p>i=1(0x80&gt;&gt;i)=0100 0000</p><p>SER=0<strong>1</strong>01 0101 &amp; 0<strong>1</strong>00 0000 =0<strong>1</strong>00 0000â€”â€”-æ ¹æ®é0å³<strong>1</strong>ï¼ŒSERä¸º<strong>1</strong></p><p>.</p><p>.</p><p>.</p><p>i=7(0x80&gt;&gt;i)=0000 0001</p><p>SER=0101 010<strong>1</strong> &amp; 0000 0001 =0000 0001â€”â€”-æ ¹æ®é0å³<strong>1</strong>ï¼ŒSERä¸º<strong>1</strong></p><p><img src="/../../../../medias/blog_picture/51/18.png" alt="æœ€åå˜æˆè¿™æ ·"></p><pre class="line-numbers language-c" data-language="c"><code class="language-c">SCK<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//ç»™é«˜ç”µå¹³å½¢æˆä¸Šå‡æ²¿ä¼ å…¥æ•°æ®</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/../../../../medias/blog_picture/51/19.png" alt="."></p><p>æ®µé€‰ ä½é€‰ <strong>å»¶æ—¶</strong> <strong>ä½æ¸…é›¶</strong> æ®µé€‰ ä½é€‰</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*** @brief  LEDç‚¹é˜µå±æ˜¾ç¤ºä¸€åˆ—æ•°æ®* @param  Column è¦é€‰æ‹©çš„åˆ—ï¼ŒèŒƒå›´0~7ï¼Œ0åœ¨æœ€å·¦è¾¹* @param  Data é€‰æ‹©åˆ—æ˜¾ç¤ºçš„æ•°æ®ï¼Œé«˜ä½åœ¨ä¸Šï¼Œ1ä¸ºäº®ï¼Œ0ä¸ºç­* @retval æ— */</span><span class="token keyword">void</span> <span class="token function">MatrixLED_ShowColumn</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> Cloumn<span class="token punctuation">,</span>Data<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">_74JHC595_WriteByte</span><span class="token punctuation">(</span>Data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ”¾æ•°æ®</span>MATRIX_LED_PORT<span class="token operator">=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">0x80</span><span class="token operator">&gt;&gt;</span>Cloumn<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä½é€‰ï¼›é€‰æ‹©åˆ—ï¼Œç„¶åæŠŠæ•°æ®0xAAä¼ åˆ°LEDåˆ—ä¸­ï¼›</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å»¶æ—¶</span>MATRIX_LED_PORT<span class="token operator">=</span><span class="token number">0xFF</span><span class="token punctuation">;</span><span class="token comment">//ä½æ¸…é›¶ï¼Œä¸‹ä¸€æ­¥æ˜¯æ®µé€‰ï¼Œè¿™æ ·ä¸‹æ¬¡æ®µé€‰å°±ä¸ä¼šä¸²ä½åˆ°ä¸Šä¸€ä¸ªä½é€‰äº†</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-c" data-language="c"><code class="language-c">MATRIX_LED_PORT<span class="token operator">=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">0x80</span><span class="token operator">&gt;&gt;</span>Cloumn<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è¿™é‡Œå–åæ˜¯ä¸ºäº†è®©1è¡¨ç¤ºäº®ï¼Œ0è¡¨ç¤ºç­ï¼ŒåŒæ—¶&gt;&gt;è¡¥ä½è¡¥çš„æ˜¯0</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="ä¸Šä»£ç -Hello-æ»šå±"><a href="#ä¸Šä»£ç -Hello-æ»šå±" class="headerlink" title="ä¸Šä»£ç (Hello!æ»šå±)"></a>ä¸Šä»£ç (Hello!æ»šå±)</h2><h3 id="main-c-1"><a href="#main-c-1" class="headerlink" title="main.c"></a>main.c</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;REGX52.H&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Delay.h"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"MatrixLED.h"</span></span><span class="token comment">//code æŠŠAnimationçš„æ•°æ®æ”¾åœ¨flashé‡Œ(å†…å­˜å¤§)ï¼ŒæŠŠrunçš„ç©ºé—´è…¾å‡ºæ¥åšå…¶ä»–äº‹æƒ…ï¼Œç¼ºç‚¹æ˜¯Animationçš„æ•°æ®ä¸èƒ½å†æ›´æ”¹äº†(åªèƒ½è¯»å–ä¸èƒ½å†™å…¥)</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> code Animation<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0x08</span><span class="token punctuation">,</span><span class="token number">0x08</span><span class="token punctuation">,</span><span class="token number">0x08</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x0E</span><span class="token punctuation">,</span><span class="token number">0x15</span><span class="token punctuation">,</span><span class="token number">0x15</span><span class="token punctuation">,</span><span class="token number">0x15</span><span class="token punctuation">,</span><span class="token number">0x08</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x7E</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0x02</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x7E</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0x02</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x0E</span><span class="token punctuation">,</span><span class="token number">0x11</span><span class="token punctuation">,</span><span class="token number">0x11</span><span class="token punctuation">,</span><span class="token number">0x0E</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x7D</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> i<span class="token punctuation">,</span>Offset<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>Count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//offsetåç§»é‡</span><span class="token function">MartrixLED_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">MatrixLED_ShowColumn</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>Animation<span class="token punctuation">[</span>i<span class="token operator">+</span>Offset<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>Count<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//ä¸èƒ½ç”¨Delay,ä¸ç„¶ä¼šå‡ºç°é—ªå±ç°è±¡</span><span class="token keyword">if</span><span class="token punctuation">(</span>Count<span class="token operator">&gt;</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">{</span>Count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>Offset<span class="token operator">++</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>Offset<span class="token operator">&gt;</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token comment">//å†™è¿™ä¸ªä¸ºäº†ä¸è®©Offsetæº¢å‡ºäº§ç”Ÿä¹±ç </span><span class="token punctuation">{</span>Offset<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">//ç›¸å½“äºæ‰«äº†10éåç§»å‘ä¸‹ä¸€å¸§</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>â‘ å…ˆè§£é‡Šä¸»å‡½æ•°çš„for</strong></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">MatrixLED_ShowColumn</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>Animation<span class="token punctuation">[</span>i<span class="token operator">+</span>Offset<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™ä¸ª<strong>MatrixLED_ShowColumn</strong>æ˜¯æ”¾æ•°æ®ï¼Œå®‰æ’æ¯ä¸€åˆ—çš„ï¼Œiè¡¨ç¤ºåˆ—ï¼ŒAnimation[]æ˜¯æ•°ç»„ï¼Œ<strong>i+Offset</strong>æ˜¯è¦æŠŠ<strong>ä¸€å¹•ä¸­çš„å…«åˆ—</strong>éƒ½æ‰“å‡ºæ¥</p><p><strong>â‘¡if</strong></p><pre class="line-numbers language-c" data-language="c"><code class="language-c">Count<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//ä¸èƒ½ç”¨Delay,ä¸ç„¶ä¼šå‡ºç°é—ªå±ç°è±¡</span><span class="token keyword">if</span><span class="token punctuation">(</span>Count<span class="token operator">&gt;</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">{</span>Count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>Offset<span class="token operator">++</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>Offset<span class="token operator">&gt;</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token comment">//å†™è¿™ä¸ªä¸ºäº†ä¸è®©Offsetæº¢å‡ºäº§ç”Ÿä¹±ç </span><span class="token punctuation">{</span>Offset<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç”¨Countæ¥è®¡æ—¶ï¼Œå½“Count&gt;10åï¼Œ<strong>Offset++ï¼Œå±å¹•ä¸­çš„ç”»é¢å¼€å§‹å¾€å³ç§»ï¼Œæ¯æ¬¡ç§»åŠ¨ä¸€åˆ—ï¼Œ</strong>Offset&gt;40ï¼Œè¿™ä¸ª40=<strong>8*6(å…¨éƒ¨)â€”8(ç¬¬ä¸€å¹•çš„ä¸éœ€è¦ç§»åŠ¨)</strong></p><p><strong>â‘¢æœ‰16ä¸ª0x00</strong></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">char</span> code Animation<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è®©**Hçš„å·¦è¾¹çš„|<strong>ä»æœ€åä¸€åˆ—å‡ºç°ï¼Œè®©</strong>!**ä»ç¬¬ä¸€åˆ—ç¦»å¼€</p><h3 id="MatrixLED-c-æ˜¯ä¸Šä¸€ä¸ªä¸»å‡½æ•°é‡Œæ‰’æ‹‰ä¸‹æ¥çš„"><a href="#MatrixLED-c-æ˜¯ä¸Šä¸€ä¸ªä¸»å‡½æ•°é‡Œæ‰’æ‹‰ä¸‹æ¥çš„" class="headerlink" title="MatrixLED.c(æ˜¯ä¸Šä¸€ä¸ªä¸»å‡½æ•°é‡Œæ‰’æ‹‰ä¸‹æ¥çš„)"></a>MatrixLED.c(æ˜¯ä¸Šä¸€ä¸ªä¸»å‡½æ•°é‡Œæ‰’æ‹‰ä¸‹æ¥çš„)</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;REGX52.H&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Delay.h"</span></span><span class="token comment">//ç»™IOå£æ”¹å</span>sbit RCK<span class="token operator">=</span>P3<span class="token operator">^</span><span class="token number">5</span><span class="token punctuation">;</span><span class="token comment">//RCLK,åº”è¯¥æ˜¯èµ‹å€¼çš„æ—¶å€™ç”¨_ï¼Œç»™åœ°å€çš„æ—¶å€™ç”¨^ï¼Œè¿™é‡Œæ˜¯è®©rclkç›´æ¥æ‰¾åˆ°p3_5çš„åœ°å€æ‰€ä»¥ç”¨^</span>sbit SCK<span class="token operator">=</span>P3<span class="token operator">^</span><span class="token number">6</span><span class="token punctuation">;</span><span class="token comment">//SRCLK</span>sbit SER<span class="token operator">=</span>P3<span class="token operator">^</span><span class="token number">4</span><span class="token punctuation">;</span><span class="token comment">//SER</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MATRIX_LED_PORT</span> <span class="token expression">P0</span><span class="token comment">//å¦‚æœä»¥åè‡ªå·±ç„Šæ¿å­ç©æ¥å£ä¸å¯¹ï¼Œç›´æ¥æ”¹ä¸Šé¢sbitï¼Œä¸ç”¨å†åœ¨ä¸‹é¢æ”¹äº†</span></span><span class="token comment">/**  * @brief  74HC595å†™å…¥ä¸€ä¸ªå­—èŠ‚  * @param  è¦å†™å…¥çš„å­—èŠ‚  * @retval æ—   */</span><span class="token keyword">void</span> <span class="token function">_74JHC595_WriteByte</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> Byte<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> i<span class="token punctuation">;</span><span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>SER<span class="token operator">=</span>Byte<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">0x80</span><span class="token operator">&gt;&gt;</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//0x80--&gt;1000 0000</span>SCK<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//ç»™é«˜ç”µå¹³å½¢æˆä¸Šå‡æ²¿ä¼ å…¥æ•°æ®</span>SCK<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//ç½®é›¶ä¸ºä¸‹ä¸€æ¬¡ä¼ å…¥åšå‡†å¤‡</span><span class="token punctuation">}</span>RCK<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//é«˜ç”µå¹³ï¼Œå½¢æˆä¸Šå‡æ²¿é”å­˜</span>RCK<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//ç½®é›¶</span><span class="token punctuation">}</span><span class="token comment">/**  * @brief  ç‚¹é˜µå±åˆå§‹åŒ–  * @param  æ—   * @retval æ—   */</span><span class="token keyword">void</span> <span class="token function">MartrixLED_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>SCK<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//å› ä¸ºä¸Šç”µé»˜è®¤é«˜ç”µå¹³,å…ˆç½®0ï¼Œæ‰èƒ½ç»™é«˜ç”µå¹³ï¼›éœ€è¦ä¸€ä¸ªä¸Šå‡æ²¿æ‰èƒ½ä¼ å…¥æ•°æ®</span>RCK<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//åˆå§‹åŒ–ä¸ºä½ç”µå¹³</span><span class="token punctuation">}</span><span class="token comment">/*** @brief  LEDç‚¹é˜µå±æ˜¾ç¤ºä¸€åˆ—æ•°æ®* @param  Column è¦é€‰æ‹©çš„åˆ—ï¼ŒèŒƒå›´0~7ï¼Œ0åœ¨æœ€å·¦è¾¹* @param  Data é€‰æ‹©åˆ—æ˜¾ç¤ºçš„æ•°æ®ï¼Œé«˜ä½åœ¨ä¸Šï¼Œ1ä¸ºäº®ï¼Œ0ä¸ºç­* @retval æ—   */</span><span class="token keyword">void</span> <span class="token function">MatrixLED_ShowColumn</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> Cloumn<span class="token punctuation">,</span>Data<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">_74JHC595_WriteByte</span><span class="token punctuation">(</span>Data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ”¾æ•°æ®</span>MATRIX_LED_PORT<span class="token operator">=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">0x80</span><span class="token operator">&gt;&gt;</span>Cloumn<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä½é€‰ï¼›é€‰æ‹©åˆ—ï¼Œç„¶åæŠŠæ•°æ®0xAAä¼ åˆ°åˆ—ä¸­ï¼›</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å»¶æ—¶</span>MATRIX_LED_PORT<span class="token operator">=</span><span class="token number">0xFF</span><span class="token punctuation">;</span><span class="token comment">//ä½æ¸…é›¶ï¼Œä¸‹ä¸€æ­¥æ˜¯æ®µé€‰ï¼Œè¿™æ ·ä¸‹æ¬¡æ®µé€‰å°±ä¸ä¼šä¸²ä½åˆ°ä¸Šä¸€ä¸ªä½é€‰äº†</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="MatrixLED-h"><a href="#MatrixLED-h" class="headerlink" title="MatrixLED.h"></a>MatrixLED.h</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__MATRIXLED_H__</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__MATRIXLED_H__</span></span><span class="token keyword">void</span> <span class="token function">MatrixLED_ShowColumn</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> Cloumn<span class="token punctuation">,</span>Data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">MartrixLED_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 51å•ç‰‡æœº </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 51å•ç‰‡æœº </tag>
            
            <tag> å¤§äº‘å±‹è€ƒæ ¸ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä¸²å£é€šä¿¡</title>
      <link href="/2022/10/11/chuan-kou-tong-xin/"/>
      <url>/2022/10/11/chuan-kou-tong-xin/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸²å£é€šä¿¡"><a href="#ä¸²å£é€šä¿¡" class="headerlink" title="ä¸²å£é€šä¿¡"></a>ä¸²å£é€šä¿¡</h1><p><img src="/../../../../medias/blog_picture/51/32.png" alt="ç¡¬ä»¶ç”µè·¯"></p><h3 id="ç”µå¹³æ ‡å‡†"><a href="#ç”µå¹³æ ‡å‡†" class="headerlink" title="ç”µå¹³æ ‡å‡†"></a>ç”µå¹³æ ‡å‡†</h3><p>TTLï¼š+5Vè¡¨ç¤º1ï¼Œ0Vè¡¨ç¤º0</p><p><img src="E:\Users\Wabby\AppData\Roaming\Typora\typora-user-images\1665028662515.png" alt="1665028662515"></p><p>å¼‚æ­¥ï¼šAå‘äº†1sçš„1å’Œ1sçš„0ï¼Œé‚£Bå°±å¯ä»¥è¿ç»­ä¸¤æ¬¡0.5så‘1å’Œä¸¤æ¬¡0.5sçš„0</p><p><img src="/../../../../medias/blog_picture/51/33.png"></p><p><img src="/../../../../medias/blog_picture/51/34.png" alt="ä¸²å£å‚æ•°åŠæ—¶åºå›¾"></p><h3 id="æ£€éªŒä½-9ä½"><a href="#æ£€éªŒä½-9ä½" class="headerlink" title="æ£€éªŒä½(9ä½)"></a>æ£€éªŒä½(9ä½)</h3><p>å¥‡æ ¡éªŒ</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//æ”¶ï¼š0000 0011 1</span><span class="token comment">//å‘ï¼š0000 0011 1</span><span class="token comment">//ä½†æ˜¯å¦‚æœæ˜¯0000 1010 1å°±ä¹Ÿä¼šè¡¥1ï¼Œæ’é”™ç‡ä¸é«˜</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//æ”¶ï¼š1110 0000 0</span><span class="token comment">//å‘ï¼š1100 0000 0</span><span class="token comment">//è¿™æ—¶å°±æ˜¯é”™è¯¯çš„ï¼Œè¯´æ˜æ•°æ®å‡ºäº†é—®é¢˜</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="/../../../../medias/blog_picture/51/35.png" alt="ä¸²å£æ¨¡å¼å›¾"></p><p>ä¸­é—´åœˆèµ·æ¥é‚£å—æ˜¯æ§åˆ¶æ³¢ç‰¹ç‡çš„</p><p>å‘é€å¯„å­˜å™¨ï¼š X=SBUF</p><p>æ¥æ”¶å¯„å­˜å™¨ï¼šSBUF=X</p><h2 id="é€šä¿¡åˆå®ç°"><a href="#é€šä¿¡åˆå®ç°" class="headerlink" title="é€šä¿¡åˆå®ç°"></a>é€šä¿¡åˆå®ç°</h2><p><strong>16ä½å®šæ—¶å™¨/è®¡æ—¶å™¨</strong>å’Œ<strong>8ä½è‡ªåŠ¨é‡è£…è½½</strong>çš„åŒºåˆ«</p><p>å°±æ˜¯åå…­ä½è®°çš„æ•°å¤šï¼Œä½†æ¯æ¬¡éƒ½éœ€è¦è‡ªå·±å†™çš„ä»£ç èµ‹åˆå€¼ï¼Œæµªè´¹æ—¶é—´ã€‚åŒå…«ä½å°±æ˜¯å°†åå…­ä½åˆ†å¼€ï¼Œä¸€ä¸ªè®¡æ•°ï¼Œå¦ä¸€ä¸ªå­˜æ”¾åˆå€¼ï¼Œæ¯æ¬¡è®¡æ•°å®ŒæˆåARä¼šè‡ªåŠ¨å°†å€¼èµ‹ç»™CNTï¼Œä¸ç”¨ä»£ç å¤„ç†ï¼Œæ¯”è¾ƒå¿«ï¼Œä½†åªæœ‰å…«ä½æ‰€ä»¥è®°çš„æ•°å°‘äº†ã€‚</p><h3 id="ä¸Šä»£ç "><a href="#ä¸Šä»£ç " class="headerlink" title="ä¸Šä»£ç "></a>ä¸Šä»£ç </h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;REGX52.H&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Delay.h"</span></span><span class="token keyword">void</span> <span class="token function">UART_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//4800bps@11.0592MHz</span><span class="token punctuation">{</span><span class="token comment">//ä¸²å£éƒ¨åˆ†</span>SCON <span class="token operator">=</span> <span class="token number">0x40</span><span class="token punctuation">;</span><span class="token comment">//8ä½æ•°æ®,å¯å˜æ³¢ç‰¹ç‡</span>PCON <span class="token operator">&amp;=</span> <span class="token number">0x7F</span><span class="token punctuation">;</span><span class="token comment">//å®šæ—¶å™¨1éƒ¨åˆ†ï¼ŒT1æ˜¯ä¸²å£ä¸“ç”¨çš„å®šæ—¶å™¨</span>TMOD <span class="token operator">&amp;=</span> <span class="token number">0x0F</span><span class="token punctuation">;</span><span class="token comment">//è®¾ç½®å®šæ—¶å™¨æ¨¡å¼</span>TMOD <span class="token operator">|=</span> <span class="token number">0x20</span><span class="token punctuation">;</span><span class="token comment">//è®¾ç½®å®šæ—¶å™¨æ¨¡å¼</span>TL1 <span class="token operator">=</span> <span class="token number">0xFA</span><span class="token punctuation">;</span><span class="token comment">//è®¾å®šå®šæ—¶åˆå€¼</span>TH1 <span class="token operator">=</span> <span class="token number">0xFA</span><span class="token punctuation">;</span><span class="token comment">//è®¾å®šå®šæ—¶å™¨é‡è£…å€¼</span>ET1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//ç¦æ­¢å®šæ—¶å™¨1ä¸­æ–­</span>TR1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//å¯åŠ¨å®šæ—¶å™¨1</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">UART_SendByte</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> Byte<span class="token punctuation">)</span><span class="token punctuation">{</span>SBUF<span class="token operator">=</span>Byte<span class="token punctuation">;</span><span class="token comment">//SBUFå†™å…¥,è¢«èµ‹å€¼</span><span class="token keyword">while</span><span class="token punctuation">(</span>TI<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æœ¬æ¥TI=0ï¼Œä½†æ˜¯åœ¨æ•°æ®ä¼ è¾“å®Œæˆä¹‹åä¸²å£ä¼šè‡ªåŠ¨å°†1èµ‹ç»™TI,å› æ­¤éœ€è¦è½¯ä»¶è¿›è¡Œå¤ä½ã€‚</span>TI<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//è½¯ä»¶å¤ä½</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">UART_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">UART_SendByte</span><span class="token punctuation">(</span><span class="token number">0x11</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="â‘ ä¸²å£éƒ¨åˆ†SCON-serial-control-PCON-power-control"><a href="#â‘ ä¸²å£éƒ¨åˆ†SCON-serial-control-PCON-power-control" class="headerlink" title="â‘ ä¸²å£éƒ¨åˆ†SCON(serial control)&amp;PCON(power control)"></a>â‘ ä¸²å£éƒ¨åˆ†SCON(serial control)&amp;PCON(power control)</h4><p><img src="/../../../../medias/blog_picture/51/36.png"></p><pre class="line-numbers language-c" data-language="c"><code class="language-c">SCON <span class="token operator">=</span> <span class="token number">0x40</span><span class="token punctuation">;</span><span class="token comment">//8ä½æ•°æ®,å¯å˜æ³¢ç‰¹ç‡</span>PCON <span class="token operator">&amp;=</span> <span class="token number">0x7F</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h5 id="SM0-SM1"><a href="#SM0-SM1" class="headerlink" title="SM0&amp;SM1"></a>SM0&amp;SM1</h5><p><img src="/../../../../medias/blog_picture/51/37.png"></p><p><img src="/../../../../medias/blog_picture/51/38.png"></p><p><strong>RENç»™0/1éƒ½å¯ä»¥</strong></p><p><img src="/../../../../medias/blog_picture/51/39.png"></p><p><img src="/../../../../medias/blog_picture/51/40.png"></p><p><strong>SM2ï¼ŒTB8ï¼ŒRB8è·Ÿæ¨¡å¼1æ— å…³ï¼Œç»™0</strong></p><p><img src="/../../../../medias/blog_picture/51/41.png"></p><p>å°±æ˜¯å‘é€ç»“æŸåï¼Œç¡¬ä»¶ç»™T1ç½®1ï¼Œè¡¨ç¤ºå‘é€å®Œäº†ï¼Œç„¶åè¯·æ±‚ä¸­æ–­çš„æ—¶å€™TI=0ï¼Œå¿…é¡»ç”¨è½¯ä»¶å¤ä½æ˜¯æŒ‡è¦äººä¸ºåœ¨è½¯ä»¶ä¸­ä½¿TI=1</p><p><strong>TI=0</strong> â€”å‘é€â€“å®Œæ¯•â€”-ç¡¬ä»¶â€“&gt; <strong>T1=1</strong> â€“è¯·æ±‚ä¸­æ–­â€“&gt; <strong>TI=1</strong> â€“ä¸»æœºå“åº”ä¸­æ–­â€”-è½¯ä»¶å¤ä½&gt; <strong>TI=0</strong></p><p>TIæœ€å¼€å§‹ä¸º0</p><p><img src="/../../../../medias/blog_picture/51/42.png"></p><p>å¯¹RIçš„ç†è§£å’ŒTIä¸€æ ·</p><p><strong>æ‰€ä»¥SCON=0100 0000 â€“&gt; 0x40</strong></p><h4 id="â‘¡PCONï¼Œç”¨æ³¢ç‰¹ç‡è®¡ç®—æå‡ºæ¥çš„"><a href="#â‘¡PCONï¼Œç”¨æ³¢ç‰¹ç‡è®¡ç®—æå‡ºæ¥çš„" class="headerlink" title="â‘¡PCONï¼Œç”¨æ³¢ç‰¹ç‡è®¡ç®—æå‡ºæ¥çš„"></a>â‘¡PCONï¼Œç”¨æ³¢ç‰¹ç‡è®¡ç®—æå‡ºæ¥çš„</h4><h3 id="å®šæ—¶å™¨éƒ¨åˆ†"><a href="#å®šæ—¶å™¨éƒ¨åˆ†" class="headerlink" title="å®šæ—¶å™¨éƒ¨åˆ†"></a>å®šæ—¶å™¨éƒ¨åˆ†</h3><p>è¦æ”¹ä¸ºå®šæ—¶å™¨1</p><p><img src="/../../../../medias/blog_picture/51/43.png"></p><p><img src="/../../../../medias/blog_picture/51/44.png"></p><pre class="line-numbers language-c" data-language="c"><code class="language-c">TMOD <span class="token operator">&amp;=</span> <span class="token number">0x0F</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span> <span class="token number">0000</span> <span class="token number">1111</span>TMOD <span class="token operator">|=</span> <span class="token number">0x20</span><span class="token punctuation">;</span>    <span class="token operator">|</span> <span class="token number">0010</span> <span class="token number">0000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="å°å°é—®é¢˜"><a href="#å°å°é—®é¢˜" class="headerlink" title="å°å°é—®é¢˜"></a>å°å°é—®é¢˜</h3><p>å½“æˆ‘æŠŠä¸‹é¢è¿™ä¸²</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">UART_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">UART_SendByte</span><span class="token punctuation">(</span><span class="token number">0x11</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ”¹æˆ</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">UART_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">UART_SendByte</span><span class="token punctuation">(</span><span class="token number">0x11</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å½“ä¸º0x11æ—¶æ­£å¸¸ä¸”ä¸æ–­è¾“å‡º11ï¼Œå½“ä¸º0x66æ—¶å¼‚å¸¸ä¸”ä¸æ–­è¾“å‡º96ï¼Œæ˜¯å› ä¸ºæ³¢ç‰¹ç‡çš„è¯¯å·®ï¼Œæ­¤æ—¶æˆ‘ä»¬è®©å®ƒç¿»æ…¢ç‚¹å°±å¯ä»¥æ­£å¸¸è¾“å‡ºäº†(è®©ä»–ç¨³å®šç‚¹)</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">UART_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">UART_SendByte</span><span class="token punctuation">(</span><span class="token number">0x11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è®©ä»–æ…¢æ…¢ç¿»</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/../../../../medias/blog_picture/51/45.png" alt="ä¸²å£å’Œä¸­æ–­ç³»ç»Ÿ"></p><p>æˆ‘ä»¬è¦å¯ç”¨ä¸²å£ä¸­æ–­ï¼Œè€Œä¸æ˜¯å®šæ—¶å™¨ä¸­æ–­ï¼Œå®šæ—¶å™¨ä¸­æ–­æ˜¯åˆ°ç‚¹äº†å°±ä¸­æ–­ï¼Œä¸²å£ä¸­æ–­æ˜¯æœ‰æ•°æ®è¿‡æ¥ä¸­æ–­ï¼Œæ‰€ä»¥è¦é…ç½®å®šæ—¶å™¨ä¸ä¸­æ–­å³ET1ç­‰äº0ï¼Œç„¶åå¼€å¯ä¸²å£ä¸­æ–­</p><h2 id="ä¸­æ–­æœåŠ¡å‡½æ•°"><a href="#ä¸­æ–­æœåŠ¡å‡½æ•°" class="headerlink" title="ä¸­æ–­æœåŠ¡å‡½æ•°"></a>ä¸­æ–­æœåŠ¡å‡½æ•°</h2><p>æ¨¡æ¿</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">UART_Rountine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> interrupt <span class="token number">4</span><span class="token comment">//ä¸­æ–­æœåŠ¡å­å‡½æ•°</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span>RI<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>RI<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¾‹å­</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">UART_Rountine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> interrupt <span class="token number">4</span><span class="token comment">//ä¸­æ–­æœåŠ¡å­å‡½æ•°</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span>RI<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">//åŒºåˆ†å‘é€å’Œæ¥æ”¶ï¼Œå‘é€å’Œæ¥æ”¶éƒ½ä¼šè§¦å‘ä¸­æ–­</span> <span class="token comment">//è€Œä¸”äºŒè€…å ç”¨åŒä¸€ä¸ªé€šé“ï¼Œå†™è¿™ä¸ªæ˜¯ä¸ºäº†åˆ¤æ–­ï¼Œç„¶åæŠŠå‘é€å’Œæ¥å—åˆ†å¼€</span><span class="token punctuation">{</span>P2<span class="token operator">=</span><span class="token operator">~</span>SBUF<span class="token punctuation">;</span><span class="token function">UART_SendByte</span><span class="token punctuation">(</span>SBUF<span class="token punctuation">)</span><span class="token punctuation">;</span>RI<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ç®—æ³¢ç‰¹ç‡"><a href="#ç®—æ³¢ç‰¹ç‡" class="headerlink" title="ç®—æ³¢ç‰¹ç‡"></a>ç®—æ³¢ç‰¹ç‡</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">TL1 <span class="token operator">=</span> <span class="token number">0xFA</span><span class="token punctuation">;</span><span class="token comment">//è®¾å®šå®šæ—¶åˆå€¼</span>TH1 <span class="token operator">=</span> <span class="token number">0xFA</span><span class="token punctuation">;</span><span class="token comment">//è®¾å®šå®šæ—¶å™¨é‡è£…å€¼</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>FAâ€“16è½¬10â€“&gt; 250</p><p>é‚£ä¹ˆä¸€ä¸ªTL1/TH1å¯¹åº”8byteï¼Œä¹Ÿå°±æ˜¯256ï¼Œå®šæ—¶å™¨æ¯éš”256-250=6Âµsæº¢å‡ºä¸€æ¬¡(æ¯è®¡6ä¸ªæ•°å°±æº¢å‡ºä¸€æ¬¡)ï¼Œ11.0529MHzæ™¶æŒ¯å¯¹åº”12Tæ¨¡å¼ä¸‹çš„0.924Âµsè®¡æ•°ä¸€æ¬¡</p><p>æº¢å‡ºçš„é¢‘ç‡=0.924/6=0.154MHz</p><p>0.154MHz/16=0.009625MHz</p><p>0.009625Ã—1000Ã—1000=9625ï¼Ÿ<strong>åº”è¯¥æ˜¯æ¥è¿‘4800çš„æ‰å¯¹</strong>â€¦â€¦â€¦upä¸»ç”¨çš„12MHzæ¥ç®—ï¼Œç®—åˆ°äº†4807</p>]]></content>
      
      
      <categories>
          
          <category> 51å•ç‰‡æœº </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 51å•ç‰‡æœº </tag>
            
            <tag> å¤§äº‘å±‹è€ƒæ ¸ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å®šæ—¶å™¨å’Œå®šæ—¶å™¨æ—¶é’Ÿ</title>
      <link href="/2022/10/10/ding-shi-qi-he-ding-shi-qi-shi-zhong/"/>
      <url>/2022/10/10/ding-shi-qi-he-ding-shi-qi-shi-zhong/</url>
      
        <content type="html"><![CDATA[<h1 id="å®šæ—¶å™¨"><a href="#å®šæ—¶å™¨" class="headerlink" title="å®šæ—¶å™¨"></a>å®šæ—¶å™¨</h1><p><img src="/../../../../medias/blog_picture/51/46.png" alt="å®šæ—¶å™¨æ¡†å›¾"></p><p><img src="/../../../../medias/blog_picture/51/47.png"></p><p>æŒ‰è§†é¢‘ä¸­çš„å»ç†è§£ï¼Œupä¸»çš„æ¿å­æ™¶æŒ¯ä¸º12MHzï¼Œå¦‚æœåˆ†é¢‘æ¥äº†Ã·12çš„çº¿è·¯ï¼Œé‚£ä¹ˆä¼ ç»™è®¡æ•°å™¨çš„å°±ä¼šæ˜¯1Âµsè®¡æ•°ä¸€æ¬¡(è®¡ç®—:<strong>1/(12MHz/12)=1/1*10^9s=1Âµs</strong>)</p><p>CTé€‰æ‹©å¼€å…³ï¼šé‚£é‡Œç»™<strong>1</strong>æ˜¯<strong>counterè®¡æ•°å™¨</strong>  ç»™<strong>0</strong>æ˜¯<strong>timerå®šæ—¶å™¨</strong></p><p>GATEé‚£é‡Œï¼šä¸‰è§’æ˜¯å¼‚é—¨(1â€“&gt;0  0â€”&gt;1)ï¼Œç¬¬äºŒä¸ªæ˜¯æˆ–é—¨(åªæœ‰00æƒ…å†µç»™0ï¼Œå…¶ä½™ç»™1)ï¼Œç¬¬ä¸‰ä¸ªæ˜¯ä¸é—¨<strong>è·ŸCçš„å¼‚æˆ–ä¸çš„ä¸æ„æ€å·®ä¸å¤š</strong></p><p><img src="/../../../../medias/blog_picture/51/48.png"></p><h2 id="å®æ“"><a href="#å®æ“" class="headerlink" title="å®æ“"></a>å®æ“</h2><h3 id="1-TMOD-TIME-MODE"><a href="#1-TMOD-TIME-MODE" class="headerlink" title="1.TMOD(TIME_MODE)"></a>1.TMOD(TIME_MODE)</h3><p><img src="/../../../../medias/blog_picture/51/49.png"></p><p>ç”±äºTMODä¸å¯å¯»å€ï¼Œæ‰€ä»¥è¦<strong>æ•´ä½“</strong>è¡¨ç¤º</p><p>(å¯¹äº**(ä¸)å¯å¯»å€<strong>çš„ç†è§£ï¼Œ</strong>å¯å¯»å€<strong>åƒä¹‹å‰çš„ç‚¹LEDç¯ï¼Œç›´æ¥P2=0x01&lt;==&gt;P2_1=1ç„¶åP2_2~8=0ï¼Œ</strong>ä¸å¯å¯»å€**å°±æ˜¯åªèƒ½ä¸€å¨åœ°è¡¨ç¤ºï¼Œå°±åƒP2=0x00è¿™æ ·)</p><p><strong>ç›®çš„</strong>ï¼šæˆ‘ä»¬è¦å®ç°<strong>å®šæ—¶å™¨0</strong>è¿è¡Œä¸”è¿›å…¥<strong>æ¨¡å¼1</strong></p><h4 id="â‘ M0-M1"><a href="#â‘ M0-M1" class="headerlink" title="â‘ M0&amp;M1"></a>â‘ M0&amp;M1</h4><p><img src="/../../../../medias/blog_picture/51/50.png"></p><p>æ‰€ä»¥<strong>M0â€“&gt;1</strong>ï¼Œ<strong>M1â€“&gt;0</strong></p><h4 id="â‘¡C-T"><a href="#â‘¡C-T" class="headerlink" title="â‘¡C/T"></a>â‘¡C/T</h4><p><img src="/../../../../medias/blog_picture/51/51.png"></p><p>å› ä¸ºæ˜¯å®šæ—¶å™¨ <strong>C/Tâ€“&gt;0</strong></p><h4 id="â‘¢GATE"><a href="#â‘¢GATE" class="headerlink" title="â‘¢GATE"></a>â‘¢GATE</h4><p><img src="/../../../../medias/blog_picture/51/52.png"></p><p>è¦è®©TR0å‚ä¸æ§åˆ¶ï¼Œæ‰€ä»¥<strong>GATEâ€“&gt;0</strong></p><p><strong>é™„GATEçš„è¿è¡Œæ¨¡å¼</strong></p><p><img src="/../../../../medias/blog_picture/51/53.png"></p><h4 id="å› æ­¤"><a href="#å› æ­¤" class="headerlink" title="å› æ­¤"></a>å› æ­¤</h4><pre class="line-numbers language-C" data-language="C"><code class="language-C">TMOD=0X01;//0000 0001<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="TMODçš„ä¼˜åŒ–"><a href="#TMODçš„ä¼˜åŒ–" class="headerlink" title="TMODçš„ä¼˜åŒ–"></a>TMODçš„ä¼˜åŒ–</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c">TMOD <span class="token operator">&amp;=</span> <span class="token number">0xF0</span><span class="token punctuation">;</span><span class="token comment">//è®¾ç½®å®šæ—¶å™¨æ¨¡å¼       0xF0--&gt;1111 0000</span>TMOD <span class="token operator">|=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>      <span class="token comment">//                    0x01--&gt;0000 0001</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ç”±äºTMODæ˜¯<strong>åŒæ—¶æ§åˆ¶å®šæ—¶å™¨0å’Œå®šæ—¶å™¨1</strong>ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨æ§åˆ¶å®šæ—¶å™¨0çš„æ—¶å€™ï¼Œ<strong>ä¸å½±å“åˆ°å¯èƒ½æ­£åœ¨å·¥ä½œçš„å®šæ—¶å™¨1</strong>ï¼Œäºæ˜¯ç”¨åˆ°äº†ä»¥ä¸‹æ“ä½œ</p><p>e.g.</p><p>åŸTMOD=1010 0011â€”æˆ‘ä»¬å¸Œæœ›æŠŠå®ƒè½¬æ¢ä¸ºâ€”&gt;1010 0001</p><p><strong>1stâ€”â€”-1010 0011 &amp; 1111 0000 =1010 0000</strong></p><p><strong>ç†è§£</strong>ï¼š<strong>n &amp; 1 <strong>æ—¶ï¼Œnä¸ºå‡ å°±è¿”å›å‡ (æ­¤æ—¶ä¸å½±å“å®šæ—¶å™¨1)ï¼›</strong>n &amp; 0 <strong>æ—¶ï¼Œå…¨ä¸º0(æœ‰ç‚¹</strong>åˆå§‹åŒ–</strong>å®šæ—¶å™¨0çš„æ„Ÿè§‰)</p><p><strong>2ndâ€”â€”1010 0000 | 0000 0001 =1010 0001</strong></p><p><strong>ç†è§£</strong>ï¼š<strong>n | 0 <strong>æ—¶ï¼Œnä¸ºå‡ å°±è¿”å›å‡ (è¿˜æ˜¯ä¸å½±å“å®šæ—¶å™¨1)ï¼›</strong>0 | n</strong> æ—¶ï¼Œnä¸ºå‡ ä¹Ÿè¿”å›å‡ (næ˜¯äººå·¥å†³å®šçš„ï¼Œè¿™æ—¶å¯ä»¥è‡ªè¡Œæ“æ§å®šæ—¶å™¨0äº†)</p><h3 id="2-TCON"><a href="#2-TCON" class="headerlink" title="2.TCON"></a>2.TCON</h3><p><img src="/../../../../medias/blog_picture/51/54.png"></p><h4 id="â‘ TR0"><a href="#â‘ TR0" class="headerlink" title="â‘ TR0"></a>â‘ TR0</h4><p><img src="/../../../../medias/blog_picture/51/55.png"></p><p><strong>çœæµ</strong>ï¼šGATE=0 &amp;&amp; TR0=1æ—¶å…è®¸T0è®¡æ•°ï¼Œå¼€å§‹å·¥ä½œ</p><pre class="line-numbers language-none"><code class="language-none">TR0=1;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="â‘¡TF0"><a href="#â‘¡TF0" class="headerlink" title="â‘¡TF0"></a>â‘¡TF0</h4><p><img src="/../../../../medias/blog_picture/51/56.png"></p><p><strong>çœæµ</strong>ï¼šTF0=1æ—¶å°±äº§ç”Ÿä¸­æ–­ï¼Œæ‰€ä»¥è¦=0ï¼Œé˜²æ­¢åˆšé…ç½®å¥½å°±äº§ç”Ÿä¸­æ–­</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">TF0<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="â‘¢TH0-TL0"><a href="#â‘¢TH0-TL0" class="headerlink" title="â‘¢TH0&amp;TL0"></a>â‘¢TH0&amp;TL0</h4><p><img src="/../../../../medias/blog_picture/51/57.png"></p><p>æ¥è‡ªå¼¹å¹•å¤§ä½¬ï¼šä¸¤ä¸ªå¯„å­˜å™¨TH0ã€TL0ä¸º<strong>äºŒè¿›åˆ¶å…«ä½</strong>(2^8)ï¼Œ<strong>å•ç‹¬</strong>å¯è®¡256æ¬¡ï¼Œ<strong>ä½å…«ä½è®¡æ»¡256æ¬¡åé«˜å…«ä½è¿›1</strong>ï¼Œæ‰€ä»¥<strong>é™¤ä»¥256</strong>å¯å¾—<strong>é«˜å…«ä½</strong>å¾—æ¬¡æ•°ï¼Œ<strong>å–ä½™</strong>å°±æ˜¯<strong>ä½å…«ä½</strong>çš„æ¬¡æ•°ï¼Œåˆå¹¶åœ¨ä¸€èµ·å°±æ˜¯æ‰€èµ‹çš„åˆå§‹å€¼</p><p>æ¥è‡ªUPä¸»ï¼š<strong>123</strong>è¦æ”¾åˆ°ä¸¤ä¸ª<strong>å®¹é‡</strong>ä¸º100çš„ç›’å­é‡Œï¼Œ<strong>é«˜ä½æ¬¡</strong>çš„ç›’å­å­˜å‚¨â€”<strong>123/100=1</strong>ï¼Œ<strong>ä½ä½æ¬¡</strong>çš„ç›’å­å­˜å‚¨â€”<strong>123%100=23</strong>ï¼Œ<strong>åˆå¹¶</strong>ä¹‹åå°±æ˜¯123(åˆå§‹å€¼)</p><p><strong>å¯¹åº”é¡¹ç›®ï¼Œå°±æ˜¯ä¸¤ä¸ªå®¹é‡ä¸º256çš„å°ç›’å­è¦å­˜å‚¨64535è¿™ä¸ªåºç„¶å¤§ç‰©</strong></p><pre class="line-numbers language-c" data-language="c"><code class="language-c">TH0<span class="token operator">=</span><span class="token number">64535</span><span class="token operator">/</span><span class="token number">256</span><span class="token punctuation">;</span><span class="token comment">//highï¼Œæ‹¿å‡ºé«˜å…«ä½</span>TL0<span class="token operator">=</span><span class="token number">64535</span><span class="token operator">%</span><span class="token number">256</span><span class="token punctuation">;</span><span class="token comment">//lowï¼Œæ‹¿å‡ºä½å…«ä½</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="â‘£ET0-EA-PT0"><a href="#â‘£ET0-EA-PT0" class="headerlink" title="â‘£ET0&amp;EA&amp;PT0"></a>â‘£ET0&amp;EA&amp;PT0</h4><p><img src="/../../../../medias/blog_picture/51/58.png"></p><p>æŠŠé€šé“æ‰“é€š</p><pre class="line-numbers language-C" data-language="C"><code class="language-C">ET0=1;EA=1;PT0=0;//è™½ç„¶é»˜è®¤PT0ä¸º0ï¼Œä½†è¿˜æ˜¯è¯´æ˜ä¸€ä¸‹æ¯”è¾ƒå¥½<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="3-Time0-c"><a href="#3-Time0-c" class="headerlink" title="3.Time0.c"></a>3.Time0.c</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;REGX52.H&gt;</span></span><span class="token comment">/**  * @brief  å®šæ—¶å™¨0åˆå§‹åŒ–ï¼Œ1ms@11.0592MH  * @param  æ—   * @retval æ—   */</span><span class="token keyword">void</span> <span class="token function">Timer0Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token comment">//1æ¯«ç§’@11.0592MHz</span><span class="token punctuation">{</span>TMOD <span class="token operator">&amp;=</span> <span class="token number">0xF0</span><span class="token punctuation">;</span><span class="token comment">//è®¾ç½®å®šæ—¶å™¨æ¨¡å¼       0xF0--&gt;1111 0000</span>TMOD <span class="token operator">|=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>     <span class="token comment">//                     0x0x--&gt;0000 0001</span>TL0 <span class="token operator">=</span> <span class="token number">0x66</span><span class="token punctuation">;</span><span class="token comment">//è®¾ç½®å®šæ—¶åˆå€¼</span>TH0 <span class="token operator">=</span> <span class="token number">0xFC</span><span class="token punctuation">;</span><span class="token comment">//è®¾ç½®å®šæ—¶åˆå€¼</span>    <span class="token comment">/**    64535/256=252    252--10è¿›åˆ¶è½¬16è¿›åˆ¶--&gt;FC        64535%256=23    23--10è¿›åˆ¶è½¬16è¿›åˆ¶--&gt;17    ä½†æ˜¯æˆ‘ä»¬è¿™ä¸ªæœ‰0.04%çš„åå·®ï¼Œæ‰€ä»¥...é—®é¢˜...åº”è¯¥ä¸å¤§å§...    */</span>TF0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//æ¸…é™¤TF0æ ‡å¿—</span>TR0 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//å®šæ—¶å™¨0å¼€å§‹è®¡æ—¶</span>ET0<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>          <span class="token comment">//å…è®¸ä¸­æ–­</span>EA<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>PT0<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">/*å®šæ—¶å™¨ä¸­æ–­å‡½æ•°æ¨¡æ¿void Timer0_Routine() interrupt 1{static unsigned int T0Count;//ä¸ºäº†ä¸ä¸¢å¤±è¿™ä¸ªæ•°å­—TL0 = 0x66;//è®¾ç½®å®šæ—¶åˆå€¼TH0 = 0xFC;//è®¾ç½®å®šæ—¶åˆå€¼T0Count++;if(T0Count&gt;=1000){//è¿™é‡Œè¦å†™å…·ä½“å®ç°ä»€ä¹ˆT0Count=0;}}*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯¹å®šæ—¶å™¨ä¸­æ–­å‡½æ•°æ¨¡æ¿çš„ç†è§£ï¼š</p><p>é¦–å…ˆï¼Œä¸­æ–­ç¨‹åºæœ¬èº«å¯è§†ä¸ºä¸€ä¸ªwhileå¾ªç¯ï¼Œä¼šä¸€ç›´æ‰§è¡Œè¿™ä¸ªå‡½æ•°</p><p>å…¶æ¬¡ï¼Œå¯¹äºç§’æ•°ï¼Œè¿™ä¸ªè®¡æ—¶å™¨(TH0 TL0)<strong>æœ€é«˜å¯è¾¾åˆ°65535Âµs</strong>ï¼Œæˆ‘ä»¬è®¾ç½®å®šæ—¶åˆå€¼æ—¶ï¼Œç”¨çš„æ˜¯64535ï¼Œå®ƒ<strong>è·ç¦»65535è¿˜æœ‰1000æ‰å³å°†æº¢å‡ºå½’é›¶</strong>ï¼Œæ‰€ä»¥æˆ‘ä»¬è®©è®¡æ—¶å™¨è®¡æ—¶1000Âµs(=1ms)ï¼Œ**æ¯è¿‡1msï¼ŒT0Count++**ï¼Œå½“å®ƒåŠ äº†1000æ¬¡ï¼Œæ­¤æ—¶å·²ç»è¿‡å»1000ms(=1s)</p><p>æœ€åï¼Œè¿›å…¥ifæ‰§è¡Œå…·ä½“å®ç°ï¼Œç„¶åæŠŠT0Countå½’é›¶ï¼Œè¿›å…¥ä¸‹ä¸€æ¬¡ä¸­æ–­ç¨‹åº(å¾ªç¯)</p><h3 id="4-æ–°å­¦ä¸¤ä¸ªå‡½æ•°"><a href="#4-æ–°å­¦ä¸¤ä¸ªå‡½æ•°" class="headerlink" title="4.æ–°å­¦ä¸¤ä¸ªå‡½æ•°"></a>4.æ–°å­¦ä¸¤ä¸ªå‡½æ•°</h3><p><strong>è¦ç”¨åˆ°#include&lt;INTRINS.H&gt;å¤´æ–‡ä»¶</strong></p><h4 id="crolå‡½æ•°-crorå‡½æ•°-å¤´å°¾éƒ½è¦"><a href="#crolå‡½æ•°-crorå‡½æ•°-å¤´å°¾éƒ½è¦" class="headerlink" title="crolå‡½æ•°&amp;crorå‡½æ•°(..å¤´å°¾éƒ½è¦_.."></a>crolå‡½æ•°&amp;crorå‡½æ•°(..å¤´å°¾éƒ½è¦_..</h4><p>å¾ªç¯ç§»ä½</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">char</span> a<span class="token operator">=</span><span class="token number">0x80</span><span class="token punctuation">;</span>a<span class="token operator">=</span><span class="token function">_crol_</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//aä¸º0x01ï¼Œå¾ªç¯å›å»å¼€å¤´äº†</span><span class="token comment">//å¦‚æœæ˜¯&lt;&lt;çš„è¯ï¼Œç§»åˆ°è¾¹ç•Œå°±æº¢å‡ºè¶Šç•Œ</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-æœ€ç»ˆå‘ˆç°"><a href="#5-æœ€ç»ˆå‘ˆç°" class="headerlink" title="5.æœ€ç»ˆå‘ˆç°"></a>5.æœ€ç»ˆå‘ˆç°</h3><h4 id="main-c"><a href="#main-c" class="headerlink" title="main.c"></a>main.c</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;REGX52.H&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Timer0.h"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Key.h"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;INTRINS.H&gt;</span></span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> KeyNum<span class="token punctuation">,</span>LEDMode<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>P2<span class="token operator">=</span><span class="token number">0xFE</span><span class="token punctuation">;</span><span class="token comment">//P2æ˜¯LEDæ¨¡å—å™¢ï¼Œä¸€ç«¯æ¥äº†VCCï¼Œé‚£ä¹ˆåªæœ‰ç»™P2_nèµ‹å€¼ä¸º0çš„æ—¶å€™æ‰äº®ï¼Œ0xFEè½¬äºŒè¿›åˆ¶ä¸º1111 1110</span><span class="token function">Timer0Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>KeyNum<span class="token operator">=</span><span class="token function">Key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>KeyNum<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span>KeyNum<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>LEDMode<span class="token operator">++</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>LEDMode<span class="token operator">&gt;=</span><span class="token number">2</span><span class="token punctuation">)</span>LEDMode<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">//å®šæ—¶å™¨å’Œä¸»ç¨‹åºçš„è€¦åˆæ€§æ¯”è¾ƒå¤§ï¼Œæ‰€ä»¥ç›´æ¥æ”¾åˆ°ä¸»å‡½æ•°ä½¿ç”¨</span><span class="token keyword">void</span> <span class="token function">Timer0_Routine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> interrupt <span class="token number">1</span><span class="token punctuation">{</span><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> T0Count<span class="token punctuation">;</span><span class="token comment">//ä¸ºäº†ä¸ä¸¢å¤±è¿™ä¸ªæ•°å­—</span>TL0 <span class="token operator">=</span> <span class="token number">0x66</span><span class="token punctuation">;</span><span class="token comment">//è®¾ç½®å®šæ—¶åˆå€¼</span>TH0 <span class="token operator">=</span> <span class="token number">0xFC</span><span class="token punctuation">;</span><span class="token comment">//è®¾ç½®å®šæ—¶åˆå€¼</span>T0Count<span class="token operator">++</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>T0Count<span class="token operator">&gt;=</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token comment">//0.5säº®ä¸€æ¬¡</span><span class="token punctuation">{</span>T0Count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>LEDMode<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>P2<span class="token operator">=</span><span class="token function">_crol_</span><span class="token punctuation">(</span>P2<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>LEDMode<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>P2<span class="token operator">=</span><span class="token function">_cror_</span><span class="token punctuation">(</span>P2<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é’ˆå¯¹<strong>æµæ°´</strong>æ•ˆæœï¼Œæˆ‘ä»¬æ·»åŠ äº†è¿™äº›</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span><span class="token punctuation">(</span>T0Count<span class="token operator">&gt;=</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">{</span>T0Count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>LEDMode<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>           P2<span class="token operator">=</span><span class="token function">_crol_</span><span class="token punctuation">(</span>P2<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¾€å·¦æµ</span><span class="token keyword">if</span><span class="token punctuation">(</span>LEDMode<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>P2<span class="token operator">=</span><span class="token function">_cror_</span><span class="token punctuation">(</span>P2<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¾€å³æµ</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é…åˆä¸»å‡½æ•°é£Ÿç”¨</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">char</span> KeyNum<span class="token punctuation">,</span>LEDMode<span class="token punctuation">;</span> <span class="token comment">//ä¸€å¼€å§‹åˆå§‹åŒ–äº†KeyNumå’ŒLEDModeï¼Œè¿™ä¸¤ä¸ªç©æ„åˆå§‹å€¼éƒ½ä¸º0</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>é‚£ä¹ˆï¼Œå½“å¼€å…³è¢«æŒ‰ä¸‹çš„æ—¶å€™ï¼Œ<strong>LEDMode==0</strong>ï¼Œå¼€å§‹å¾€å·¦æµï¼Œå¯¹åº”ä¸‹é¢è¿™å¥</p><pre class="line-numbers language-none"><code class="language-none">if(LEDMode==0)           P2=_crol_(P2,1);//å¾€å·¦æµ<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ç„¶åæ¥æ”¶KeyNumï¼Œå½“æˆ‘ä¸æŒ‰P3_1æ—¶ï¼ŒLEDModeå°±ä¸€ç›´ä¸º0ï¼Œä¸€ç›´å¾€å·¦æµ</p><p>æˆ‘æŒ‰ä¸‹P3_1æ—¶ï¼Œé…åˆKey.cé£Ÿç”¨ï¼Œæ­¤æ—¶<strong>è¿”å›KeyNumber=1</strong></p><h4 id="Key-c"><a href="#Key-c" class="headerlink" title="Key.c"></a>Key.c</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;REGX52.H&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Delay.h"</span></span><span class="token comment">/**  * @brief  è·å–ç‹¬ç«‹æŒ‰é”®é”®ç   * @param  æ—   * @retval æŒ‰ä¸‹æŒ‰é”®çš„é”®ç ï¼ŒèŒƒå›´ï¼š0~4ï¼Œæ— æŒ‰é”®æŒ‰ä¸‹æ—¶è¿”å›å€¼ä¸º0  */</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">Key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> KeyNumber<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>P3_1<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>P3_1<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>KeyNumber<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">//ä»‹é‡Œä»‹é‡Œï¼</span><span class="token keyword">if</span><span class="token punctuation">(</span>P3_0<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>P3_0<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>KeyNumber<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span>P3_2<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>P3_2<span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>KeyNumber<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span>P3_3<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>P3_3<span class="token operator">==</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>KeyNumber<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">return</span> KeyNumber<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>KeyNum==1</strong>åï¼Œæ‰§è¡Œ</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span><span class="token punctuation">(</span>KeyNum<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>LEDMode<span class="token operator">++</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>LEDMode<span class="token operator">&gt;=</span><span class="token number">2</span><span class="token punctuation">)</span>LEDMode<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™æ—¶å€™LEDMode++ï¼Œ<strong>LEDMode==1</strong></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span><span class="token punctuation">(</span>LEDMode<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>P2<span class="token operator">=</span><span class="token function">_cror_</span><span class="token punctuation">(</span>P2<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¾€å³æµ</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>å†æ¬¡æŒ‰ä¸‹P3_1æ—¶ï¼ŒLEDMode++ï¼Œ<strong>LEDMode==2</strong>ï¼Œç„¶åæ‰§è¡Œifè®©LEDModeå½’é›¶</p><h1 id="å®šæ—¶å™¨æ—¶é’Ÿ"><a href="#å®šæ—¶å™¨æ—¶é’Ÿ" class="headerlink" title="å®šæ—¶å™¨æ—¶é’Ÿ"></a>å®šæ—¶å™¨æ—¶é’Ÿ</h1><h3 id="main-c-1"><a href="#main-c-1" class="headerlink" title="main.c"></a>main.c</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;REGX52.H&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Delay.h"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"LCD1602.h"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Timer0.h"</span></span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> Sec<span class="token punctuation">,</span>Min<span class="token punctuation">,</span>Hour<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">LCD_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Timer0Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"Clock:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"  :  :"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">LCD_ShowNum</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>Hour<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">LCD_ShowNum</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span>Min<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">LCD_ShowNum</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span>Sec<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">Timer0_Routine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> interrupt <span class="token number">1</span><span class="token punctuation">{</span><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> T0Count<span class="token punctuation">;</span><span class="token comment">//ä¸ºäº†ä¸ä¸¢å¤±è¿™ä¸ªæ•°å­—</span>TL0 <span class="token operator">=</span> <span class="token number">0x66</span><span class="token punctuation">;</span><span class="token comment">//è®¾ç½®å®šæ—¶åˆå€¼</span>TH0 <span class="token operator">=</span> <span class="token number">0xFC</span><span class="token punctuation">;</span><span class="token comment">//è®¾ç½®å®šæ—¶åˆå€¼</span>T0Count<span class="token operator">++</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>T0Count<span class="token operator">&gt;=</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">{</span>T0Count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>Sec<span class="token operator">++</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>Sec<span class="token operator">&gt;=</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">{</span>Sec<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>Min<span class="token operator">++</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>Min<span class="token operator">&gt;=</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">{</span>Min <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>Hour<span class="token operator">++</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>Hour<span class="token operator">&gt;=</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">{</span>Hour<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™ä¸ªï¼Œä¸éš¾ç†è§£ï¼Œdddd</p>]]></content>
      
      
      <categories>
          
          <category> 51å•ç‰‡æœº </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 51å•ç‰‡æœº </tag>
            
            <tag> å¤§äº‘å±‹è€ƒæ ¸ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>çŸ©é˜µé”®ç›˜</title>
      <link href="/2022/10/10/ju-zhen-jian-pan/"/>
      <url>/2022/10/10/ju-zhen-jian-pan/</url>
      
        <content type="html"><![CDATA[<h1 id="6-1çŸ©é˜µé”®ç›˜"><a href="#6-1çŸ©é˜µé”®ç›˜" class="headerlink" title="6-1çŸ©é˜µé”®ç›˜"></a>6-1çŸ©é˜µé”®ç›˜</h1><p><img src="/../../../../medias/blog_picture/51/20.png" alt="çŸ©é˜µæŒ‰é”®"></p><p><img src="/../../../../medias/blog_picture/51/21.png" alt="èŠ¯ç‰‡å¼•è„š"></p><p>å‰å››æ ¹çº¿(P17~P14)åˆ¤æ–­è¡Œï¼Œç»™0ç›¸å½“äºæ¥åœ°**(ç”±ä¸Šé¢è¿™å¹…å›¾æˆ‘ä»¬çŸ¥é“P1çš„ä¸€ç«¯å·²ç»æ¥åœ¨äº†VCCï¼Œæ‰€ä»¥è¦è®©P1_xè¿è¡Œï¼Œè¦ç»™å®ƒä½ç”µå¹³ï¼Œå³0)**ï¼Œæ­¤æ—¶ioå£ä¸ºä½ç”µå¹³</p><p>åå››æ ¹(P13~P10)åˆ¤æ–­è¯¥è¡Œå¯¹åº”çš„æŸä¸€ä¸ªæŒ‰é”®</p><h2 id="ä¸‹é¢çš„ä»£ç ä¸»è¦æ˜¯å®ç°æ§åˆ¶çŸ©é˜µé”®ç›˜ï¼Œå¹¶æŠŠæŒ‰ä¸‹å»çš„é”®ä½å¯¹åº”çš„æ•°å­—åœ¨LCD1602ä¸Šæ˜¾ç¤ºå‡ºæ¥"><a href="#ä¸‹é¢çš„ä»£ç ä¸»è¦æ˜¯å®ç°æ§åˆ¶çŸ©é˜µé”®ç›˜ï¼Œå¹¶æŠŠæŒ‰ä¸‹å»çš„é”®ä½å¯¹åº”çš„æ•°å­—åœ¨LCD1602ä¸Šæ˜¾ç¤ºå‡ºæ¥" class="headerlink" title="ä¸‹é¢çš„ä»£ç ä¸»è¦æ˜¯å®ç°æ§åˆ¶çŸ©é˜µé”®ç›˜ï¼Œå¹¶æŠŠæŒ‰ä¸‹å»çš„é”®ä½å¯¹åº”çš„æ•°å­—åœ¨LCD1602ä¸Šæ˜¾ç¤ºå‡ºæ¥"></a>ä¸‹é¢çš„ä»£ç ä¸»è¦æ˜¯å®ç°æ§åˆ¶çŸ©é˜µé”®ç›˜ï¼Œå¹¶æŠŠæŒ‰ä¸‹å»çš„é”®ä½å¯¹åº”çš„æ•°å­—åœ¨LCD1602ä¸Šæ˜¾ç¤ºå‡ºæ¥</h2><p>ps:å¸¸è§çš„Delayå°±ä¸æ”¾å‡ºæ¥äº†ï¼Œæ‡‚å¾—éƒ½æ‡‚</p><p>matrixçŸ©é˜µ</p><h3 id="MatrixKey-h"><a href="#MatrixKey-h" class="headerlink" title="MatrixKey.h"></a>MatrixKey.h</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__MATRIXKEY_H__</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__MATRIXKEY_H__</span></span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">MatrixKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="MatrixKey-c"><a href="#MatrixKey-c" class="headerlink" title="MatrixKey.c"></a>MatrixKey.c</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;REGX52.H&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Delay.h"</span></span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">MatrixKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> KeyNumber<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>P1<span class="token operator">=</span><span class="token number">0xFF</span><span class="token punctuation">;</span><span class="token comment">//æœ‰ç‚¹ç›¸å½“äºåˆå§‹åŒ–</span>P1_3<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>P1_7<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>P1_7<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>KeyNumber<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span>P1_6<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>P1_6<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>KeyNumber<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span>P1_5<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>P1_5<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>KeyNumber<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span>P1_4<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>P1_4<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>KeyNumber<span class="token operator">=</span><span class="token number">13</span><span class="token punctuation">;</span><span class="token punctuation">}</span>P1<span class="token operator">=</span><span class="token number">0xFF</span><span class="token punctuation">;</span>P1_2<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>P1_7<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>P1_7<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>KeyNumber<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span>P1_6<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>P1_6<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>KeyNumber<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span>P1_5<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>P1_5<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>KeyNumber<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span>P1_4<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>P1_4<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>KeyNumber<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">;</span><span class="token punctuation">}</span>P1<span class="token operator">=</span><span class="token number">0xFF</span><span class="token punctuation">;</span>P1_1<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>P1_7<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>P1_7<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>KeyNumber<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span>P1_6<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>P1_6<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>KeyNumber<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span>P1_5<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>P1_5<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>KeyNumber<span class="token operator">=</span><span class="token number">11</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span>P1_4<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>P1_4<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>KeyNumber<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">;</span><span class="token punctuation">}</span>P1<span class="token operator">=</span><span class="token number">0xFF</span><span class="token punctuation">;</span>P1_0<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>P1_7<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>P1_7<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>KeyNumber<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span>P1_6<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>P1_6<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>KeyNumber<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span>P1_5<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>P1_5<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>KeyNumber<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span>P1_4<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>P1_4<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>KeyNumber<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">return</span> KeyNumber<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬å¯ä»¥å‘ç°è¿™ä¸ªå‡½æ•°ä»£ç æ˜¯ç”±<strong>å››ç»„æ¨¡æ¿ä¸€æ ·</strong>çš„å°ä»£ç ç»„æˆçš„ï¼Œä¸‹é¢å°†æ‹ä¸€ç»„å‡ºæ¥è§£é‡Š</p><p><img src="/../../../../medias/blog_picture/51/22.png" alt="çŸ©é˜µæŒ‰é”®"></p><pre class="line-numbers language-c" data-language="c"><code class="language-c">P1<span class="token operator">=</span><span class="token number">0xFF</span><span class="token punctuation">;</span><span class="token comment">//è®©æ‰€æœ‰çš„P1å£éƒ½ä¸º1ï¼Œå°±æ˜¯ä¸å¯¹ä»–ä»¬è¿›è¡Œæ“ä½œï¼Œè®©ä»–ä»¬å¤„äºstandbyçŠ¶æ€</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-c" data-language="c"><code class="language-c">P1_3<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//"å”¤é†’"åˆ—ï¼Œæˆ‘ä»¬å…ˆæ§åˆ¶P1_3,è®©ä»–ä¸º0ï¼Œå¤„äºè¿è¡ŒçŠ¶æ€--â‘ </span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//ç„¶åé€ä¸ªåˆ¤æ–­ç”¨æˆ·æŒ‰ä¸‹äº†å“ªä¸ªé”®ä½+æŒ‰é”®æ¶ˆæŠ–ï¼Œæ£€æµ‹æ¾æ‰‹ï¼Œèµ‹ç›¸åº”çš„å€¼ç»™KeyNumber</span><span class="token keyword">if</span><span class="token punctuation">(</span>P1_7<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>P1_7<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>KeyNumber<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">//--â‘¡</span><span class="token keyword">if</span><span class="token punctuation">(</span>P1_6<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>P1_6<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>KeyNumber<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">//--â‘¢</span><span class="token keyword">if</span><span class="token punctuation">(</span>P1_5<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>P1_5<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>KeyNumber<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">//--â‘£</span><span class="token keyword">if</span><span class="token punctuation">(</span>P1_4<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>P1_4<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>KeyNumber<span class="token operator">=</span><span class="token number">13</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">//--â‘¤</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="main-c"><a href="#main-c" class="headerlink" title="main.c"></a>main.c</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;REGX52.H&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Delay.h"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"LCD1602.h"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"MatrixKey.h"</span></span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> KeyNum<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">LCD_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                       <span class="token comment">//åˆå§‹åŒ–</span><span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"Martix:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//ä»ç¬¬ä¸€è¡Œç¬¬ä¸€åˆ—å¼€å§‹è¾“å…¥</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>KeyNum<span class="token operator">=</span><span class="token function">MatrixKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//æŠŠè¿”å›çš„KeyNumberèµ‹å€¼ç»™KeyNum</span><span class="token keyword">if</span><span class="token punctuation">(</span>KeyNum<span class="token punctuation">)</span>  <span class="token punctuation">{</span><span class="token function">LCD_ShowNum</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>KeyNum<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æˆ‘ä»¬è¦åœ¨è¿™å¥è¯ä¸­æ‰èƒ½è®©ç¯äº®èµ·æ¥ï¼Œå…³é”®åœ¨äºè®©KeyNumä¸º0çš„æ—¶å€™æ ¹æœ¬è¯»ä¸åˆ°è¿™å¥è¯</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>**å¯¹äºifçš„è§£é‡Š       iiiiiiimportant!!!!!!    **</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>KeyNum<span class="token operator">=</span><span class="token function">MatrixKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//æŠŠè¿”å›çš„KeyNumberèµ‹å€¼ç»™KeyNum</span>     <span class="token function">LCD_ShowNum</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>KeyNum<span class="token punctuation">.</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>â€‹å¦‚æœæ²¡æœ‰<strong>if</strong>ï¼Œå…ˆè¿›å…¥<strong>while(1)<strong>å¾ªç¯ä¸­ï¼Œé‚£ä¹ˆå½“ç”¨æˆ·</strong>æŒ‰ä¸‹S1</strong>çš„æ—¶å€™ï¼Œ<strong>Matrixå‡½æ•°</strong>è¿”å›<strong>KeyNumber</strong>çš„å€¼ç»™ä¸»å‡½æ•°çš„<strong>KeyNum</strong>ï¼Œæ­¤æ—¶<strong>KeyNumä¸º1</strong>ï¼ŒLCD1602<strong>è¿…é€Ÿåœ°æ˜¾ç¤ºâ€œ1â€</strong>(å¾ˆå¿«å•Šï¼è‚‰çœ¼æ ¹æœ¬çœ‹ä¸è§çš„é‚£ç§)ï¼Œéšå³<strong>è·³å‡ºæ­¤æ¬¡çš„while(1)å¾ªç¯å¹¶è¿›å…¥ä¸‹ä¸€æ¬¡while(1)å¾ªç¯</strong>ï¼Œå› ä¸ºä¸‹ä¸€åˆ»ç”¨æˆ·ä¸å¯èƒ½é€Ÿé€ŸæŒ‰ä¸‹æŸä¸ªé”®ä½ï¼Œæ‰€ä»¥è¿™æ—¶å€™<strong>Matrixå‡½æ•°</strong>ä¸­åˆå§‹åŒ–çš„é‚£å¥</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">char</span> KeyNumber<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å°±ä¼šç›´æ¥è¢«è¿”å›åˆ°ä¸»å‡½æ•°çš„<strong>KeyNum</strong>ä¸­ï¼Œå³<strong>KeyNumä¸º0</strong>ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬çœ‹åˆ°çš„ç°è±¡æ˜¯ï¼Œæ— è®ºæ€ä¹ˆæŒ‰éƒ½åªä¼šæ˜¾ç¤º0ï¼Œå…¶å®æœ‰æ˜¾ç¤ºè¿‡1çš„ï¼Œä½†æ˜¯å¤ªå¿«äº†ï¼Œçœ‹ä¸è§ã€‚</p><p>â€‹é‚£ä¹ˆï¼Œæˆ‘ä»¬åŠ äº†**if(KeyNum)**åï¼Œå½“é»˜è®¤ä¸º0çš„æ—¶å€™ï¼Œifåˆ¤æ–­ä¸ºå‡ï¼Œå°±ä¸ä¼šå‡ºç°0ï¼Œå› ä¸ºä¸º0çš„æ—¶å€™ï¼Œæ ¹æœ¬ä¸ä¼šè¿›å…¥åˆ°LCD_ShowNumä¸­æ‰§è¡Œï¼Œæ‰€ä»¥ä¸€ç›´æ˜¾ç¤ºçš„æ˜¯æŒ‰ä¸‹å»çš„é”®ä½çš„è¾£ä¸ªæ•°å­—ã€‚</p><h2 id="å¼ºè¿«ç—‡-ä¸“ä¸šæ³¨é‡Š"><a href="#å¼ºè¿«ç—‡-ä¸“ä¸šæ³¨é‡Š" class="headerlink" title="å¼ºè¿«ç—‡+ä¸“ä¸šæ³¨é‡Š"></a>å¼ºè¿«ç—‡+ä¸“ä¸šæ³¨é‡Š</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/**  * @brief  ç®€ä»‹  * @param  å‚æ•°1  * @param  å‚æ•°2  * @param  å‚æ•°n  * @retval è¿”å›å€¼  */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="6-2-çŸ©é˜µé”®ç›˜å¯†ç é”"><a href="#6-2-çŸ©é˜µé”®ç›˜å¯†ç é”" class="headerlink" title="6-2 çŸ©é˜µé”®ç›˜å¯†ç é”"></a>6-2 çŸ©é˜µé”®ç›˜å¯†ç é”</h1><p><strong>ä»¥ä¸‹ä»£ç æ˜¯åœ¨6-1çš„åŸºç¡€ä¸Šä¿®æ”¹çš„</strong>ï¼Œæ‰€ä»¥ä¸å†æ”¾å‡ºMatrixå‡½æ•°ï¼Œç›´æ¥ä¸Šmain.c</p><p>ps:æ³¨é‡Šä¸ä¼šæ”¹ä¸­æ–‡å“ˆå“ˆå“ˆæ‰“å‡ºæ¥å…¨æ˜¯â€?â€ï¼Œå› æ­¤ä»¥åçš„<strong>æ³¨é‡Š</strong>éƒ½æ˜¯<strong>å…¨(å¡‘æ–™/å·¥åœ°)è‹±åˆ¶</strong></p><h2 id="main-c-1"><a href="#main-c-1" class="headerlink" title="main.c"></a>main.c</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;REGX52.H&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Delay.h"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"LCD1602.h"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"MatrixKey.h"</span></span><span class="token comment">//åˆå§‹å®šä¹‰æœªèµ‹åˆå€¼æ—¶é»˜è®¤èµ‹å€¼ä¸º0</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> KeyNum<span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> Password<span class="token punctuation">,</span>Count<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">LCD_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"Password:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>KeyNum<span class="token operator">=</span><span class="token function">MatrixKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>KeyNum<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span>KeyNum<span class="token operator">&lt;=</span><span class="token number">10</span><span class="token punctuation">)</span>  <span class="token comment">//if S1~S10keys are pressed ,input password</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span>Count<span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment">//if the time of inout &lt; 4 </span><span class="token punctuation">{</span>Password<span class="token operator">*=</span><span class="token number">10</span><span class="token punctuation">;</span><span class="token comment">//password RL </span>Password<span class="token operator">+=</span>KeyNum<span class="token operator">%</span><span class="token number">10</span><span class="token punctuation">;</span><span class="token comment">//consider the situation of when user press s10 then output 0 ,and get one password</span>Count<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">//metering +1</span><span class="token punctuation">}</span><span class="token function">LCD_ShowNum</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>Password<span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//when finishe the enter,updata the display</span><span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span>KeyNum<span class="token operator">==</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token comment">//if press S11---&gt;confirm</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span>Password<span class="token operator">==</span><span class="token number">2345</span><span class="token punctuation">)</span>  <span class="token comment">//if the password == the correct password</span><span class="token punctuation">{</span><span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token string">"OK"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Password<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//the password zero clearing</span>Count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment">//metering zero clearing</span><span class="token function">LCD_ShowNum</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>Password<span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//updata the display0</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span><span class="token function">LCD_ShowSrting</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token string">"ERR"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Password<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//the password zero clearing</span>Count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment">//metering zero clearing</span><span class="token function">LCD_ShowNum</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>Password<span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//updata the display</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span>KeyNum<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token comment">//if press S12---&gt; cancel</span><span class="token punctuation">{</span>Password<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//the password zero clearing</span>Count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment">//metering zero clearing</span><span class="token function">LCD_ShowNum</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>Password<span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//updata the display</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬ä¸€èŠ‚ä¸€èŠ‚åœ°çœ‹ï¼Œä»¥ä¸‹ä»ç”¨æˆ·æŒ‰ä¸‹æŸä¸ªé”®ä½å¼€å§‹ï¼Œå³ä»**if(KeyNum)**å¼€å§‹å¾€ä¸‹çœ‹</p><h3 id="è¾“å…¥Password"><a href="#è¾“å…¥Password" class="headerlink" title="è¾“å…¥Password"></a>è¾“å…¥Password</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span><span class="token punctuation">(</span>KeyNum<span class="token operator">&lt;=</span><span class="token number">10</span><span class="token punctuation">)</span>  <span class="token comment">//if S1~S10keys are pressed ,input password</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span>Count<span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment">//if the time of inout &lt; 4 </span><span class="token punctuation">{</span>Password<span class="token operator">*=</span><span class="token number">10</span><span class="token punctuation">;</span><span class="token comment">//password RL </span>Password<span class="token operator">+=</span>KeyNum<span class="token operator">%</span><span class="token number">10</span><span class="token punctuation">;</span><span class="token comment">//consider the situation of when user press s10 then ouput 0 ,and get one password</span>Count<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">//metering +1</span><span class="token punctuation">}</span><span class="token function">LCD_ShowNum</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>Password<span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//updata the display</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œçš„è®¾å®šæ˜¯ï¼Œ<strong>æŒ‰ä¸‹S1~S10æ—¶</strong>ï¼Œå¯¹åº”1~0ï¼Œè¿™é‡Œç”¨åˆ°çš„å¾ˆå¦™çš„ä¸€æ‹›æ˜¯</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">Password<span class="token operator">*=</span><span class="token number">10</span><span class="token punctuation">;</span>Password<span class="token operator">+=</span>KeyNum<span class="token operator">%</span><span class="token number">10</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>Passwordè‡ªÃ—10ï¼Œåˆ™ç›¸å½“äº<strong>æ‰€æœ‰æ•°å­—å¾€å·¦ç§»åŠ¨ä¸€ä½</strong>ï¼Œ<strong>å¾…è¾“å…¥çš„æ•°å­—ç”±0å æ®</strong></p><p>å†è¾“å…¥çš„æ•°å­—<strong>ä¸€å®šæ˜¯ä»ä¸ªä½å¼€å§‹</strong>ï¼Œç„¶ååœ¨æŒ‰ä¸‹ä¸‹ä¸€ä¸ªæŒ‰é”®æ—¶ï¼Œå¾€å·¦ç§»åŠ¨ï¼Œå°±ï¼Œ<strong>å¾ˆå¦™å•Šï¼</strong></p><p>ç„¶åå†è®¾å®šåªèƒ½è¾“å…¥4æ¬¡ï¼Œå™¢å¯¹äº†ï¼Œæˆ‘ä»¬<strong>åœ¨ä¸€å¼€å§‹è®¾ç½®äº†å…¨å±€å˜é‡</strong></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> Password<span class="token punctuation">,</span>Count<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ‰€ä»¥Passwordå’ŒCount<strong>åˆå§‹å€¼éƒ½æ˜¯0</strong>ï¼Œå› æ­¤<strong>Count&lt;4</strong>å³<strong>è¾“å…¥å››æ¬¡</strong></p><h3 id="ç¡®è®¤é”®"><a href="#ç¡®è®¤é”®" class="headerlink" title="ç¡®è®¤é”®"></a>ç¡®è®¤é”®</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span><span class="token punctuation">(</span>KeyNum<span class="token operator">==</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token comment">//if press S11---&gt;confirm</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span>Password<span class="token operator">==</span><span class="token number">2345</span><span class="token punctuation">)</span>  <span class="token comment">//if the password == the correct password</span><span class="token punctuation">{</span><span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token string">"OK"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Password<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//the password zero clearing</span>Count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment">//metering zero clearing</span><span class="token function">LCD_ShowNum</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>Password<span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//updata the display</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span><span class="token function">LCD_ShowSrting</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token string">"ERR"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Password<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//the password zero clearing</span>Count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment">//metering zero clearing</span><span class="token function">LCD_ShowNum</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>Password<span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//updata the display</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é¦–å…ˆï¼Œæˆ‘ä»¬<strong>çº¦å®šäº†2345æ˜¯æ­£ç¡®å¯†ç </strong>ï¼Œå½“è¾“å…¥äº†2345æ—¶æŒ‰ä¸‹S11ä¼š<strong>å‡ºç°â€OKâ€</strong></p><p>ç„¶åï¼Œå°±æ˜¯è¾“å…¥å®Œæ¯•å<strong>ä¸€åˆ‡å½’é›¶</strong>ï¼Œå³è®©ç”¨æˆ·<strong>å†æ¬¡è¾“å…¥(æ— è®ºè¾“å…¥æ­£ç¡®ä¸å¦)</strong></p><pre class="line-numbers language-c" data-language="c"><code class="language-c">Password<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//the password zero clearing</span>Count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment">//metering zero clearing</span><span class="token function">LCD_ShowNum</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>Password<span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//updata the display</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>å…ˆè®©Passwordé‡ç½®ä¸º0</p><p>ç„¶åè®¡æ•°Countä¹Ÿä¸º0</p><p>ä¸€åˆ‡éƒ½å›åˆ°æœ€å¼€å§‹çš„æ ·å­ï¼Œå³å…¨å±€å˜é‡åˆå§‹åŒ–çš„æ ·å­</p><h3 id="å–æ¶ˆé”®"><a href="#å–æ¶ˆé”®" class="headerlink" title="å–æ¶ˆé”®"></a>å–æ¶ˆé”®</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span><span class="token punctuation">(</span>KeyNum<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token comment">//if press S12---&gt; cancel</span><span class="token punctuation">{</span>Password<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//the password zero clearing</span>Count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment">//metering zero clearing</span><span class="token function">LCD_ShowNum</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>Password<span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//updata the display</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ‰äº†ä¸Šé¢çš„è§£é‡Šï¼Œè¿™ä¸ªåº”è¯¥ä¸éš¾ç†è§£å§</p><h1 id="å…³äºLCD1602-c"><a href="#å…³äºLCD1602-c" class="headerlink" title="å…³äºLCD1602.c"></a>å…³äºLCD1602.c</h1><p><img src="/../../../../medias/blog_picture/51/23.png" alt="LCD1602å†…éƒ¨æ˜¾ç¤ºåœ°å€"></p><p><img src="/../../../../medias/blog_picture/51/24.png" alt="ä¸¾ä¾‹è¯´æ˜"></p>]]></content>
      
      
      <categories>
          
          <category> 51å•ç‰‡æœº </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 51å•ç‰‡æœº </tag>
            
            <tag> å¤§äº‘å±‹è€ƒæ ¸ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ¨¡å—åŒ–ç¼–ç¨‹</title>
      <link href="/2022/10/02/mo-kuai-hua-bian-cheng/"/>
      <url>/2022/10/02/mo-kuai-hua-bian-cheng/</url>
      
        <content type="html"><![CDATA[<h1 id="5-1æ¨¡å—åŒ–ç¼–ç¨‹"><a href="#5-1æ¨¡å—åŒ–ç¼–ç¨‹" class="headerlink" title="5-1æ¨¡å—åŒ–ç¼–ç¨‹"></a>5-1æ¨¡å—åŒ–ç¼–ç¨‹</h1><p><img src="/../../../../medias/blog_picture/51/1.png" alt="æ¨¡å—åŒ–ç¼–ç¨‹æ¡†å›¾"></p><p><img src="/../../../../medias/blog_picture/51/2.png" alt="æ¨¡å—åŒ–ç¼–ç¨‹æ³¨æ„äº‹é¡¹"></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Delay.h"</span></span><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Delayå‡½æ•°çš„å£°æ˜å°±åœ¨ç¬¬ä¸€è¡Œé‚£</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/../../../../medias/blog_picture/51/3.png" alt="Cé¢„ç¼–è¯‘"></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_DELAY_H_</span><span class="token comment">//å¦‚æœæ²¡æœ‰å®šä¹‰å°±æ‰§è¡Œç¼–è¯‘(ç¬¬ä¸€æ¬¡æ²¡æœ‰å®šä¹‰æ‰å‚ä¸ç¼–è¯‘å®šä¹‰)é˜²æ­¢å¤šæ¬¡ç¼–è¯‘</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_DELAY_H_</span></span><span class="token keyword">void</span> <span class="token function">Delay</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> xms<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="å®ä¾‹æ“ä½œ"><a href="#å®ä¾‹æ“ä½œ" class="headerlink" title="å®ä¾‹æ“ä½œ"></a>å®ä¾‹æ“ä½œ</h2><h3 id="main-c"><a href="#main-c" class="headerlink" title="main.c"></a>main.c</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;REGX52.H&gt;</span></span><span class="token comment">//è°ƒç”¨å‡½æ•°</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Delay.h"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Nixie.h"</span></span><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">Nixie</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Nixie</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Nixie</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Delay-c"><a href="#Delay-c" class="headerlink" title="Delay.c"></a>Delay.c</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">Delay</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> xms<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>xms<span class="token punctuation">)</span><span class="token punctuation">{</span>i <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>j <span class="token operator">=</span> <span class="token number">199</span><span class="token punctuation">;</span><span class="token keyword">do</span><span class="token punctuation">{</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>xms<span class="token operator">--</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Delay-h"><a href="#Delay-h" class="headerlink" title="Delay.h"></a>Delay.h</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__DELAY_H__</span><span class="token comment">//å¦‚æœæ²¡æœ‰å®šä¹‰è¿‡è¿™ä¸ªå‡½æ•°</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__DELAY_H__</span><span class="token comment">//åˆ™å¼€å§‹å®šä¹‰</span></span><span class="token keyword">void</span> <span class="token function">Delay</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> xms<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å£°æ˜</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Nixie-c"><a href="#Nixie-c" class="headerlink" title="Nixie.c"></a>Nixie.c</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;REGX52.H&gt;</span><span class="token comment">//å› ä¸ºåœ¨å£°æ˜æ—¶ç”¨åˆ°äº†P0 P2è¿™ç§æ²¡æœ‰è¢«è¯´æ˜çš„é‡ï¼Œæ‰€ä»¥è¦å¼•å…¥è¿™ä¸ªå¤´æ–‡ä»¶è¯´æ˜</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Delay.h"</span></span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> NixieTable<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0x3F</span><span class="token punctuation">,</span><span class="token number">0x06</span><span class="token punctuation">,</span><span class="token number">0x5B</span><span class="token punctuation">,</span><span class="token number">0x4F</span><span class="token punctuation">,</span><span class="token number">0x66</span><span class="token punctuation">,</span><span class="token number">0x6D</span><span class="token punctuation">,</span><span class="token number">0x7D</span><span class="token punctuation">,</span><span class="token number">0x07</span><span class="token punctuation">,</span><span class="token number">0x7F</span><span class="token punctuation">,</span><span class="token number">0x6F</span><span class="token punctuation">,</span><span class="token number">0x5E</span><span class="token punctuation">,</span><span class="token number">0x6E</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">Nixie</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> Location<span class="token punctuation">,</span>Number<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">switch</span><span class="token punctuation">(</span>Location<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>P2_4 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>P2_3 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> P2_2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">//111-8</span><span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>P2_4 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>P2_3 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> P2_2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">//110-7</span><span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>P2_4 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>P2_3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> P2_2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>P2_4 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>P2_3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> P2_2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span>P2_4 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>P2_3 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> P2_2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">case</span> <span class="token number">6</span><span class="token operator">:</span>P2_4 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>P2_3 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> P2_2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">case</span> <span class="token number">7</span><span class="token operator">:</span>P2_4 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>P2_3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> P2_2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">case</span> <span class="token number">8</span><span class="token operator">:</span>P2_4 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>P2_3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> P2_2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">}</span>P0<span class="token operator">=</span>NixieTable<span class="token punctuation">[</span>Number<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>P0 <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Nixie-h"><a href="#Nixie-h" class="headerlink" title="Nixie.h"></a>Nixie.h</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__NIXIE_H__</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__NIXIE_H__</span></span><span class="token keyword">void</span> <span class="token function">Nixie</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> Location<span class="token punctuation">,</span>Number<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 51å•ç‰‡æœº </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 51å•ç‰‡æœº </tag>
            
            <tag> å¤§äº‘å±‹è€ƒæ ¸ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æœ€åˆçš„ç¬”è®°</title>
      <link href="/2022/10/02/zui-chu-de-bi-ji/"/>
      <url>/2022/10/02/zui-chu-de-bi-ji/</url>
      
        <content type="html"><![CDATA[<h1 id="2-1ç‚¹äº®ä¸€ä¸ªLED"><a href="#2-1ç‚¹äº®ä¸€ä¸ªLED" class="headerlink" title="2-1ç‚¹äº®ä¸€ä¸ªLED"></a>2-1ç‚¹äº®ä¸€ä¸ªLED</h1><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;REGX52.H&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;INTRINS.H&gt;</span></span><span class="token keyword">void</span> <span class="token function">Delay500ms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//@11.0592MHz</span><span class="token punctuation">{</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">;</span><span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>i <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>j <span class="token operator">=</span> <span class="token number">129</span><span class="token punctuation">;</span>k <span class="token operator">=</span> <span class="token number">119</span><span class="token punctuation">;</span><span class="token keyword">do</span><span class="token punctuation">{</span><span class="token keyword">do</span><span class="token punctuation">{</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>P2 <span class="token operator">=</span> <span class="token number">0xFE</span><span class="token punctuation">;</span><span class="token comment">//å¯¹åº”1111 1110å³åªæœ‰D1äº®</span><span class="token function">Delay500ms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//äº®äº†åç­‰500ms</span>P2 <span class="token operator">=</span> <span class="token number">0xFF</span><span class="token punctuation">;</span><span class="token comment">//å¯¹åº” 1111 1111 å³éƒ½ä¸äº®</span><span class="token function">Delay500ms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä¸äº®åç­‰500ms</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/../../../../medias/blog_picture/51/25.png" alt="LEDæ¨¡å—"></p><p>è§£é‡Šï¼šä¸ºä»€ä¹ˆ1ä¸äº®0äº®ï¼Œæ˜¯å› ä¸ºLEDä¸€ç«¯æ¥äº†VCCé«˜ç”µå¹³ï¼Œåˆ™å¦ä¸€ç«¯åº”è¯¥ç»™ä½ç”µå¹³å³0ï¼Œæ‰æœ‰ç”µæµè¾“å‡º</p><h1 id="2-3æµæ°´ç¯"><a href="#2-3æµæ°´ç¯" class="headerlink" title="2-3æµæ°´ç¯"></a>2-3æµæ°´ç¯</h1><h2 id="â‘ "><a href="#â‘ " class="headerlink" title="â‘ "></a>â‘ </h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;REGX52.H&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;INTRINS.H&gt;</span></span><span class="token keyword">void</span> <span class="token function">Delay500ms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//@11.0592MHz</span><span class="token punctuation">{</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">;</span><span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>i <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>j <span class="token operator">=</span> <span class="token number">129</span><span class="token punctuation">;</span>k <span class="token operator">=</span> <span class="token number">119</span><span class="token punctuation">;</span><span class="token keyword">do</span><span class="token punctuation">{</span><span class="token keyword">do</span><span class="token punctuation">{</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>P2 <span class="token operator">=</span> <span class="token number">0xFE</span><span class="token punctuation">;</span><span class="token comment">//1111 1110</span><span class="token function">Delay500ms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>P2 <span class="token operator">=</span> <span class="token number">0xFD</span><span class="token punctuation">;</span><span class="token comment">//1111 1101</span><span class="token function">Delay500ms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>P2 <span class="token operator">=</span> <span class="token number">0xFB</span><span class="token punctuation">;</span><span class="token comment">//1111 1011</span><span class="token function">Delay500ms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>P2 <span class="token operator">=</span> <span class="token number">0xF7</span><span class="token punctuation">;</span><span class="token comment">//1111 0111</span><span class="token function">Delay500ms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>P2 <span class="token operator">=</span> <span class="token number">0xEF</span><span class="token punctuation">;</span><span class="token comment">//1110 1111</span><span class="token function">Delay500ms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>P2 <span class="token operator">=</span> <span class="token number">0xDF</span><span class="token punctuation">;</span><span class="token comment">//1101 1111</span><span class="token function">Delay500ms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>P2 <span class="token operator">=</span> <span class="token number">0xBF</span><span class="token punctuation">;</span><span class="token comment">//1011 1111</span><span class="token function">Delay500ms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>P2 <span class="token operator">=</span> <span class="token number">0x7F</span><span class="token punctuation">;</span><span class="token comment">//0111 1111</span><span class="token function">Delay500ms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="â‘¡"><a href="#â‘¡" class="headerlink" title="â‘¡"></a>â‘¡</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;REGX52.H&gt;</span></span><span class="token keyword">void</span> <span class="token function">Delay1ms</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> xms<span class="token punctuation">)</span><span class="token comment">//@11.0592MHz</span><span class="token punctuation">{</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span><span class="token comment">/**å¯¹whileå¾ªç¯çš„ç†è§£:è¿™ä¸ªDelay1msæ˜¯é’ˆå¯¹1msçš„ï¼Œå½“ä¸‹é¢ç¨‹åºéœ€è¦nä¸ª1msï¼Œå°±ä¼šå¾ªç¯næ¬¡1mså»¶æ—¶çš„ç¨‹åº*/</span><span class="token keyword">while</span><span class="token punctuation">(</span>xms<span class="token punctuation">)</span><span class="token punctuation">{</span>i <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>j <span class="token operator">=</span> <span class="token number">199</span><span class="token punctuation">;</span><span class="token keyword">do</span><span class="token punctuation">{</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>xms<span class="token operator">--</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">//ä¸Šé¢è‡ªå®šä¹‰å‡½æ•°</span><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>P2 <span class="token operator">=</span> <span class="token number">0xFE</span><span class="token punctuation">;</span><span class="token comment">//1111 1110</span><span class="token function">Delay1ms</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>P2 <span class="token operator">=</span> <span class="token number">0xFD</span><span class="token punctuation">;</span><span class="token comment">//1111 1101</span><span class="token function">Delay1ms</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>P2 <span class="token operator">=</span> <span class="token number">0xFB</span><span class="token punctuation">;</span><span class="token comment">//1111 1011</span><span class="token function">Delay1ms</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>P2 <span class="token operator">=</span> <span class="token number">0xF7</span><span class="token punctuation">;</span><span class="token comment">//1111 0111</span><span class="token function">Delay1ms</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>P2 <span class="token operator">=</span> <span class="token number">0xEF</span><span class="token punctuation">;</span><span class="token comment">//1110 1111</span><span class="token function">Delay1ms</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>P2 <span class="token operator">=</span> <span class="token number">0xDF</span><span class="token punctuation">;</span><span class="token comment">//1101 1111</span><span class="token function">Delay1ms</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>P2 <span class="token operator">=</span> <span class="token number">0xBF</span><span class="token punctuation">;</span><span class="token comment">//1011 1111</span><span class="token function">Delay1ms</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>P2 <span class="token operator">=</span> <span class="token number">0x7F</span><span class="token punctuation">;</span><span class="token comment">//0111 1111</span><span class="token function">Delay1ms</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="3-1ç‹¬ç«‹æŒ‰é”®æ§åˆ¶LEDç¯äº®ç­"><a href="#3-1ç‹¬ç«‹æŒ‰é”®æ§åˆ¶LEDç¯äº®ç­" class="headerlink" title="3-1ç‹¬ç«‹æŒ‰é”®æ§åˆ¶LEDç¯äº®ç­"></a>3-1ç‹¬ç«‹æŒ‰é”®æ§åˆ¶LEDç¯äº®ç­</h1><p><img src="/../../../../medias/blog_picture/51/26.png" alt="ç‹¬ç«‹æŒ‰é”®"></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;REGX52.H&gt;</span></span><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span>P3_1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//P_3å¯¹åº”ç¬¬ä¸€ä¸ªç‹¬ç«‹æŒ‰é”®ï¼Œè¡¨ç¤ºæŒ‰ä¸‹è¯¥æŒ‰é”®æ—¶ï¼Œæ‰§è¡Œä¸‹é¢è¯­å¥</span><span class="token punctuation">{</span>P2_0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>P2_0 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;REGX52.H&gt;</span></span><span class="token keyword">void</span> <span class="token function">Delay</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> xms<span class="token punctuation">)</span><span class="token comment">//@11.0592MHz</span><span class="token punctuation">{</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>xms<span class="token punctuation">)</span><span class="token punctuation">{</span>i <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>j <span class="token operator">=</span> <span class="token number">199</span><span class="token punctuation">;</span><span class="token keyword">do</span><span class="token punctuation">{</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>xms<span class="token operator">--</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span>P3_1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>P3_1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¦‚æœè¿˜æŒ‰ç€ï¼Œå°±ä¸æ‰§è¡Œä¸‹é¢çš„ï¼Œè¿›å…¥æ­»å¾ªç¯</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>P2_0 <span class="token operator">=</span> <span class="token operator">~</span>P2_0<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token number">3.3</span>ç‹¬ç«‹æŒ‰é”®æ§åˆ¶LEDæ˜¾ç¤ºäºŒè¿›åˆ¶â‘ <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;REGX52.H&gt;</span></span><span class="token keyword">void</span> <span class="token function">Delay</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> xms<span class="token punctuation">)</span><span class="token comment">//@11.0592MHz</span><span class="token punctuation">{</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>xms<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">{</span>i <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>j <span class="token operator">=</span> <span class="token number">199</span><span class="token punctuation">;</span><span class="token keyword">do</span><span class="token punctuation">{</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> LEDNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span>P3_1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>P3_1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//P2 1111 1111 (åˆå§‹åŒ–)</span>P2<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//P2æº¢å‡ºå˜ä¸º0000 0000</span>P2<span class="token operator">=</span><span class="token operator">~</span>P2<span class="token punctuation">;</span><span class="token comment">//å–å1111 1111</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>â‘¡<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;REGX52.H&gt;</span></span><span class="token keyword">void</span> <span class="token function">Delay</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> xms<span class="token punctuation">)</span><span class="token comment">//@11.0592MHz</span><span class="token punctuation">{</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>xms<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">{</span>i <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>j <span class="token operator">=</span> <span class="token number">199</span><span class="token punctuation">;</span><span class="token keyword">do</span><span class="token punctuation">{</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> LEDNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span>P3_1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>P3_1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>LEDNum<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//åˆå§‹æ—¶LEDNumä¸º0000 0000ï¼Ÿ</span>P2<span class="token operator">=</span><span class="token operator">~</span>LEDNum<span class="token punctuation">;</span><span class="token comment">//å–å</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯¹äº<strong>æŒ‰é”®æ¶ˆæŠ–ï¼Œæ£€æµ‹æ¾æ‰‹</strong>çš„ç†è§£ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span><span class="token punctuation">(</span>P3_1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//å¦‚æœæŒ‰äº†P3_1</span><span class="token punctuation">{</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å…ˆå»¶æ—¶20msï¼Œè·³è¿‡æŠ–åŠ¨é˜¶æ®µ(æ¶ˆæŠ–)</span><span class="token keyword">while</span><span class="token punctuation">(</span>P3_1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¦‚æœè¿˜æŒ‰ç€P3_1ï¼Œåˆ™è¿›å…¥whileçš„ç©ºå¾ªç¯ï¼Œæ²¡æœ‰ä»»ä½•æ‰§è¡Œä»»åŠ¡</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ¾å¼€æ‰‹åï¼Œè·³å‡ºwhileå¾ªç¯ï¼Œå†æ¬¡è¿›å…¥æŠ–åŠ¨é˜¶æ®µ(æ¶ˆæŠ–)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="3-4ç‹¬ç«‹æŒ‰é”®æ§åˆ¶LEDä½ç§»"><a href="#3-4ç‹¬ç«‹æŒ‰é”®æ§åˆ¶LEDä½ç§»" class="headerlink" title="3-4ç‹¬ç«‹æŒ‰é”®æ§åˆ¶LEDä½ç§»"></a>3-4ç‹¬ç«‹æŒ‰é”®æ§åˆ¶LEDä½ç§»</h1><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;REGX52.H&gt;</span></span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> LEDNum<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">Delay</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> xms<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>xms<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">{</span>i <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>j <span class="token operator">=</span> <span class="token number">199</span><span class="token punctuation">;</span><span class="token keyword">do</span><span class="token punctuation">{</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>P2 <span class="token operator">=</span> <span class="token operator">~</span><span class="token number">0x01</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span>P3_1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//æŠŠP2 =~0x01; æŒªè¿‡æ¥ä¹Ÿä¸€æ ·</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>P3_1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>LEDNum<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//å®ç°æ¯æ¬¡å³ç§»ï¼Œ++å‡ æ¬¡å°±å³ç§»å‡ ä¸‹</span><span class="token keyword">if</span><span class="token punctuation">(</span>LEDNum <span class="token operator">&gt;=</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">{</span>LEDNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span>P2 <span class="token operator">=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token operator">&lt;&lt;</span>LEDNum<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span>P3_0 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>P3_0 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>LEDNum <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//å³æ­¤æ—¶äº®çš„ç¯ä¸ºD1ï¼ŒP2ä¸º0000 0001ï¼Œå½“num=7åï¼Œ0x01&lt;&lt;LEDNum&lt;==&gt;0000 0001çš„1å¾€å·¦ç§»åŠ¨7ä½ï¼Œå³1000 0000ï¼Œäº®çš„æ˜¯D8ï¼Œå·¦ç§»æˆåŠŸ</span><span class="token punctuation">{</span>LEDNum <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>LEDNum<span class="token operator">--</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token comment">//å®ç°æ¯æ¬¡å·¦ç§»ï¼Œ++å‡ æ¬¡å°±å·¦ç§»å‡ ä¸‹</span><span class="token punctuation">}</span>P2 <span class="token operator">=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token operator">&lt;&lt;</span>LEDNum<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="4-1é™æ€æ•°ç ç®¡ä½ç§»"><a href="#4-1é™æ€æ•°ç ç®¡ä½ç§»" class="headerlink" title="4-1é™æ€æ•°ç ç®¡ä½ç§»"></a>4-1é™æ€æ•°ç ç®¡ä½ç§»</h1><p>å…±é˜´æï¼Œäº®çš„ä¸º1(å…±é˜´æâ€“é«˜ç”µå¹³)</p><p>1011 1110ä¸ºæ®µç (æ˜¾ç¤º6)</p><p>å…±é˜³æï¼Œäº®çš„ä¸º0(å…±é˜³æâ€“ä½ç”µå¹³)</p><p>æ®µç ä¸º0100 0001 </p><p>å…±é˜´æ:</p><p>å½“åªéœ€è¦äº®ç¬¬ä¸‰ä¸ªæ•°å­—æ—¶ï¼Œç¬¬124çš„å…±é˜´æå¤„è¿æ¥é«˜ç”µå¹³(ç»™1)ï¼Œè€Œç¬¬3çš„å…±é˜´æç»™0ï¼Œåˆ™åªæœ‰ç¬¬ä¸‰ä¸ªç¯ä¼šäº®ï¼Œè‡³äºæ€ä¹ˆäº®ï¼Œçœ‹ä¸Šé¢ä¸¤ä¸ªä¾‹å­</p><p>ps:å››ç»„A/B/Câ€¦.éƒ½æ¥åœ¨åŒä¸€ä¸ª1174211053é‚£é‡Œ(å…±ç”¨å¼•è„šï¼Œå››ä¸ªæ•°å­—åªèƒ½æ˜¯ä¸€æ ·çš„  )</p><p>74HC245ä¸ºåŒå‘æ•°æ®ç¼“å†²å™¨ï¼šVDDå’ŒGNDä¸ºç”µæºï¼ŒOEä¸ºèŠ¯ç‰‡ä½¿èƒ½ç«¯,A0ä¸B0å¯¹åº”â€¦.</p><p>DIRâ€“&gt;directionï¼Œæ•°æ®è¯»å–æ–¹å‘</p><p>å½“LEæ¥VCCæ—¶ï¼ŒA0ä¼ æ•°æ®ç»™B0</p><p>é«˜ç”µå¹³é©±åŠ¨èƒ½åŠ›å¼±ï¼Œä½ç”µå¹³é©±åŠ¨èƒ½åŠ›å¼ºï¼Œæ‰€ä»¥è¿™ä¸ªç¼“å†²å™¨å¯ä»¥å¢å¼ºä¿¡å·ï¼Œä½¿æ•°ç ç®¡æ›´äº®</p><p><strong>//ä»¥ä¸Šæ˜¯ä¹‹å‰æ²¡åœ¨typoraå†™çš„ç¬”è®°ï¼Œä¸å†åšè¿‡å¤šçš„è¡¥å……å’Œä¿®æ”¹</strong></p><h1 id="4-1é™æ€æ•°ç ç®¡ä½ç§»-1"><a href="#4-1é™æ€æ•°ç ç®¡ä½ç§»-1" class="headerlink" title="4-1é™æ€æ•°ç ç®¡ä½ç§»"></a>4-1é™æ€æ•°ç ç®¡ä½ç§»</h1><p><strong>ç›®çš„ï¼šå®ç°ç¬¬ä¸‰ä¸ªæ•°ç ç®¡äº®èµ·</strong></p><p><img src="/../../../../medias/blog_picture/51/27.png" alt="æ•°ç ç®¡"></p><p><strong>ç¬¬ä¸‰ä¸ªç¯</strong>å¯¹åº”çš„æ˜¯<strong>LED6</strong></p><p><img src="/../../../../medias/blog_picture/51/28.png" alt="138è¯‘ç å™¨"></p><p><strong>P2_4 P2_3 P2_2â€”â€“&gt;Y5â€”â€“&gt;LED6</strong></p><p>æ ¹æ®åè¿›åˆ¶è½¬äºŒè¿›åˆ¶ï¼ŒY5çš„5è½¬ä¸ºäºŒè¿›åˆ¶æ˜¯101ï¼Œåˆ™æœ‰</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">P2_4 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>P2_3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>P2_2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="/../../../../medias/blog_picture/51/29.png" alt="æ•°ç ç®¡"></p><p>æ­¤æ—¶è¦è®©LED6äº®èµ·6ï¼Œåˆ™acdefgä¸º1(å…±é˜´æ)<strong>å› ä¸ºä»–ä»¬åé¢æ¥åˆ°äº†GND(ä½ç”µå¹³)ï¼Œè¦ç»™ä»–é«˜ç”µå¹³å¯¹åº”)<strong>ï¼Œå¯¹åº”åˆ°P0å£åˆ™æ˜¯(è¦</strong>ä»ä¸‹å¾€ä¸Š</strong>è¯»ï¼Œå³ä»<strong>P0_7</strong>è¯»åˆ°<strong>P0_0</strong>)<strong>0111 1101</strong>äºŒè¿›åˆ¶è½¬åå…­è¿›åˆ¶ï¼Œåˆ™ä¸º0x7D</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;REGX52.H&gt;</span></span><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">//ä¸‹é¢çš„ä¸‰æ­¥æ“ä½œæ˜¯è®©P2æ¥å£å¯¹åº”åˆ°Y5ï¼Œâ€œ101â€æ˜¯å› ä¸º5(10è¿›åˆ¶)è½¬ä¸ºäºŒè¿›åˆ¶æ—¶å¯¹åº”çš„å€¼æ˜¯101</span>P2_4 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>P2_3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>P2_2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token comment">//P0è¿™çœ‹ä»£ç å‰é¢çš„è§£é‡Š</span>P0 <span class="token operator">=</span> <span class="token number">0x7D</span><span class="token punctuation">;</span><span class="token comment">//ä¸ºäº†è®©ç¬¬ä¸‰ä¸ªä½ç½®çš„ç¯äº®èµ·</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="ä½¿ç”¨æ•°ç»„å®ç°"><a href="#ä½¿ç”¨æ•°ç»„å®ç°" class="headerlink" title="ä½¿ç”¨æ•°ç»„å®ç°"></a>ä½¿ç”¨æ•°ç»„å®ç°</h2><p><code>å¯¹äºNumber</code></p><p><img src="/../../../../medias/blog_picture/51/30.png" alt="æ˜¾ç¤ºçš„å­—æ¯è½¬ä¸º2è¿›åˆ¶æ¨ç®—"></p><p><strong>é™æ€æ˜¾ç¤º(åªèƒ½æœ‰ä¸€ä¸ªæ•°å­—)</strong></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;REGX52.H&gt;</span></span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> NixieTable<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0x3F</span><span class="token punctuation">,</span><span class="token number">0x06</span><span class="token punctuation">,</span><span class="token number">0x5B</span><span class="token punctuation">,</span><span class="token number">0x4F</span><span class="token punctuation">,</span><span class="token number">0x66</span><span class="token punctuation">,</span><span class="token number">0x6D</span><span class="token punctuation">,</span><span class="token number">0x7D</span><span class="token punctuation">,</span><span class="token number">0x07</span><span class="token punctuation">,</span><span class="token number">0x7F</span><span class="token punctuation">,</span><span class="token number">0x6F</span><span class="token punctuation">,</span><span class="token number">0x5E</span><span class="token punctuation">,</span><span class="token number">0x6E</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//0~9--&gt;0~9 10-d 11-y</span><span class="token comment">//è‡ªå®šä¹‰å‡½æ•°</span><span class="token keyword">void</span> <span class="token function">Nixie</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> Location<span class="token punctuation">,</span>Number<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">switch</span><span class="token punctuation">(</span>Location<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//å•ç‰‡æœºä¸Šç¬¬ä¸€ä¸ªä½ç½®çš„ç¯å¯¹åº”çš„æ˜¯LED8</span>        <span class="token comment">//è¿™é‡Œç”¨138è¯‘ç å™¨å®ç°ï¼Œå–å€¼é¡ºåºCBA</span><span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>P2_4 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>P2_3 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> P2_2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">//111-8-ç¬¬ä¸€ç›ç¯</span><span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>P2_4 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>P2_3 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> P2_2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">//110-7-ç¬¬äºŒç›ç¯</span><span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>P2_4 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>P2_3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> P2_2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>P2_4 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>P2_3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> P2_2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span>P2_4 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>P2_3 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> P2_2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">case</span> <span class="token number">6</span><span class="token operator">:</span>P2_4 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>P2_3 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> P2_2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">case</span> <span class="token number">7</span><span class="token operator">:</span>P2_4 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>P2_3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> P2_2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">case</span> <span class="token number">8</span><span class="token operator">:</span>P2_4 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>P2_3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> P2_2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">}</span>P0<span class="token operator">=</span>NixieTable<span class="token punctuation">[</span>Number<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//åœ¨è¯¥ä½ç½®ä¸Šäº®èµ·çš„æ•°å­—</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">Nixie</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä½ç½®(ç¬¬å‡ ä¸ªæ•°ç ç®¡)ï¼Œæ•°å­—(å¦‚æœæ˜¯å­—æ¯çš„è¯ï¼Œé‚£å°±æ˜¯æ‰€è¦çš„å­—æ¯å¯¹åº”æ•°ç»„çš„ä½ç½®çš„ä½æ¬¡)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸‰ä½å¯¹åº”138è¯‘ç å™¨çš„ABCå£</p><p><img src="/../../../../medias/blog_picture/51/31.png" alt="138è¯‘ç å™¨"></p><p><strong>åŠ¨æ€æ˜¾ç¤º(å¤šä¸ªæ•°å­—ï¼Œéœ€è¦æ¶ˆå½±)</strong></p><p>æ¶ˆå½±</p><p>ä½é€‰ æ®µé€‰ ä½é€‰ æ®µé€‰**(è¿›è¡Œä¸‹ä¸€æ¬¡ä½é€‰æ—¶ï¼Œæ®µé€‰æ²¡æœ‰æ”¹å˜)**</p><p>æ”¹æˆï¼šä½é€‰ æ®µé€‰ <strong>æ¸…é›¶</strong> ä½é€‰ æ®µé€‰</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;REGX52.H&gt;</span></span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> NixieTable<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0x3F</span><span class="token punctuation">,</span><span class="token number">0x06</span><span class="token punctuation">,</span><span class="token number">0x5B</span><span class="token punctuation">,</span><span class="token number">0x4F</span><span class="token punctuation">,</span><span class="token number">0x66</span><span class="token punctuation">,</span><span class="token number">0x6D</span><span class="token punctuation">,</span><span class="token number">0x7D</span><span class="token punctuation">,</span><span class="token number">0x07</span><span class="token punctuation">,</span><span class="token number">0x7F</span><span class="token punctuation">,</span><span class="token number">0x6F</span><span class="token punctuation">,</span><span class="token number">0x5E</span><span class="token punctuation">,</span><span class="token number">0x6E</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//0~9--&gt;0~9 10-d 11-y</span><span class="token keyword">void</span> <span class="token function">Delay</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> xms<span class="token punctuation">)</span><span class="token comment">//@11.0592MHz</span><span class="token punctuation">{</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>xms<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">{</span>i <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>j <span class="token operator">=</span> <span class="token number">199</span><span class="token punctuation">;</span><span class="token keyword">do</span><span class="token punctuation">{</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">Nixie</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> Location<span class="token punctuation">,</span>Number<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">switch</span><span class="token punctuation">(</span>Location<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//1st light--&gt; LED8</span><span class="token comment">//8th light--&gt; LED1</span><span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>P2_4 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>P2_3 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> P2_2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>P2_4 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>P2_3 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> P2_2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>P2_4 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>P2_3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> P2_2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>P2_4 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>P2_3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> P2_2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span>P2_4 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>P2_3 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> P2_2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">case</span> <span class="token number">6</span><span class="token operator">:</span>P2_4 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>P2_3 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> P2_2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">case</span> <span class="token number">7</span><span class="token operator">:</span>P2_4 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>P2_3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> P2_2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">case</span> <span class="token number">8</span><span class="token operator">:</span>P2_4 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>P2_3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> P2_2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">}</span>P0<span class="token operator">=</span>NixieTable<span class="token punctuation">[</span>Number<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//æŠŠè¿™å¥è¯åˆ æ‰çš„è¯å°±æ²¡é‚£ä¹ˆäº®ï¼Œåº”è¯¥æ˜¯è®©ä¸€ä¸ªä½ç½®ä¸Šçš„æ•°æ®ç®¡äº®å®Œ1msåè¿…é€Ÿæ¸…é›¶ï¼Œç„¶åå†äº®ä¸‹ä¸€ä¸ªï¼Œä¸‰ä¸ªç®¡éƒ½äº®å®Œåªéœ€è¦3msï¼Œä¸”ä¸­é—´æœ‰æ¸…é›¶è¿‡ç¨‹ï¼Œæ‰€ä»¥è§†è§‰ä¸Šçœ‹åˆ°çš„æ—¶ä¸‰ç®¡ç¯åŒæ—¶äº®</span>P0 <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span><span class="token comment">//æ¸…é›¶è¿‡ç¨‹ï¼Œä¸è®©åˆ«çš„æ•°ç ç®¡çäº®</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">Nixie</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Nixie</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Nixie</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">Nixie</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">Nixie</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 51å•ç‰‡æœº </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 51å•ç‰‡æœº </tag>
            
            <tag> å¤§äº‘å±‹è€ƒæ ¸ </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
